var socket;//2020/10/30 nodejs 參數，若沒有使用則會在後面填寫為null，但不確定在function temporder中是否能夠正常作用？
var download;
var checknidinloop=null;//2022/5/30 強制檢查nidin帳單數量迴圈參數

//2021/2/24 nidin網路訂單使用的function
var Token="";
var User="";
var getclassarray="";
var getlistarray="";
var getthelistdata="";

var getlistarrayQ="";//2022/5/26 for quickclick
var getclassarrayQ="";//2022/5/26 for quickclick
function nidin_login(){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/nidin/Login.php',
		method:'post',
		async:false,
		data:{'dep':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
		dataType:'json',
		success:function(d){
			//console.log('Login');
			//console.log(d);
			if(d!=null&&d['status']==200){//2021/8/30 當nidin伺服器"維修"時，回傳null
				Token=d['token'];
				User=d['pos_id'];
				//console.log(Token);
				//console.log(User);
			}
			else{
				Token='';
				User='';
			}
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			Token='';
			User='';
			if(checknidinloop!=null){//有開啟強制檢查要停掉
				clearInterval(checknidinloop);
				checknidinloop=null;
			}
			else{
			}
			if($('.sysmeg #name1.syshint14').length>0){
				$('.sysmeg #name1.syshint14').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint14').length>0){
				$('.sysmeg #name2.syshint14').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_getclass(){
	var res=$.Deferred();
	if(Token==""&&User==""){
		nidin_login();
	}
	else{
	}
	$.ajax({
		url:'./lib/api/nidin/GetClass.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User},
		dataType:'json',
		success:function(d){
			//console.log('GetClass');
			//console.log(d);
			getclassarray=d;
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			getclassarray="";
			if(checknidinloop!=null){//有開啟強制檢查要停掉
				clearInterval(checknidinloop);
				checknidinloop=null;
			}
			else{
			}
			if($('.sysmeg #name1.syshint14').length>0){
				$('.sysmeg #name1.syshint14').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint14').length>0){
				$('.sysmeg #name2.syshint14').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_getlist(){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/nidin/GetList.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User},
		dataType:'json',
		success:function(d){
			//console.log('GetList');
			//console.log(d);
			getlistarray=d;
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			getlistarray="";
			if(checknidinloop!=null){//有開啟強制檢查要停掉
				clearInterval(checknidinloop);
				checknidinloop=null;
			}
			else{
			}
			if($('.sysmeg #name1.syshint14').length>0){
				$('.sysmeg #name1.syshint14').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint14').length>0){
				$('.sysmeg #name2.syshint14').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_writedata(){
	if(getlistarray!=null){
		$('.webbooking #nidin .listheader .headertable #ordercode').html(getlistarray['list'][0]['order_info']['order_sn']+'<input type="hidden" id="orderid" value="'+getlistarray['list'][0]['order_info']['order_id']+'">');
		$('.webbooking #nidin .listheader .headertable #memname').html(getlistarray['list'][0]['order_info']['order_name']);
		$('.webbooking #nidin .listheader .headertable #memtel').html(getlistarray['list'][0]['order_info']['order_phone']);
		$('.webbooking #nidin .listheader .headertable #salettlqty').html(getlistarray['list'][0]['order_info']['amount']);
		$('.webbooking #nidin .listheader .headertable #salettlamt').html(getlistarray['list'][0]['order_info']['paid_money']);
		if(getlistarray['list'][0]['order_info']['order_method']==2){
			$('.webbooking #nidin .listheader .headertable #listtype').html('(預約)');
		}
		else{
		}
		switch(getlistarray['list'][0]['order_info']['delivery_type']){
			case 1:
				$('.webbooking #nidin .listheader .headertable #listtype').append("自取");
				break;
			case 2:
				$('.webbooking #nidin .listheader .headertable #listtype').append("內用");
				break;
			case 3:
				$('.webbooking #nidin .listheader .headertable #listtype').append("外送");
				break;
			case 4:
				$('.webbooking #nidin .listheader .headertable #listtype').append("外帶");
				break;
			case 5:
				$('.webbooking #nidin .listheader .headertable #listtype').append("吧檯");
				break;
			default:
				$('.webbooking #nidin .listheader .headertable #listtype').append("未知");
				break;
		}
		switch(getlistarray['list'][0]['order_info']['shopper_payment_status']){
			case 11:
				$('.webbooking #nidin .listheader .headertable #paystate').html('尚未付款');
				break;
			case 12:
				$('.webbooking #nidin .listheader .headertable #paystate').html('付款處理中');
				break;
			case 13:
				$('.webbooking #nidin .listheader .headertable #paystate').html('已付款');
				break;
			case 21:
				$('.webbooking #nidin .listheader .headertable #paystate').html('退款處理中');
				break;
			case 22:
				$('.webbooking #nidin .listheader .headertable #paystate').html('已退款');
				break;
			default:
				break;
		}
		for(var i=0;i<getlistarray['list'][0]["order_payments"].length;i++){
			if(i!=0){
				$('.webbooking #nidin .listheader .headertable #paymethod').append(',');
			}
			else{
			}
			$('.webbooking #nidin .listheader .headertable #paymethod').append(getlistarray['list'][0]["order_payments"]['name']);
		}
		switch(getlistarray['list'][0]["order_info"]["shopper_payment_status"]){
			case 11:
				$('.webbooking #nidin .listheader .headertable #liststate').html('尚未付款');
				break;
			case 12:
				$('.webbooking #nidin .listheader .headertable #liststate').html('付款處理中');
				break;
			case 13:
				$('.webbooking #nidin .listheader .headertable #liststate').html('已付款');
				break;
			case 21:
				$('.webbooking #nidin .listheader .headertable #liststate').html('退款處理中');
				break;
			case 22:
				$('.webbooking #nidin .listheader .headertable #liststate').html('已退款');
				break;
			default:
				break;
		}
		$('.webbooking #nidin .listheader .headertable #discount').html((getlistarray['list'][0]["order_info"]["money"]-getlistarray['list'][0]["order_info"]["paid_money"]));
		if(getlistarray['list'][0]["order_info"]["delivery_reserv_time"]!=getlistarray['list'][0]["order_info"]["delivery_reserv_time_latest"]){
			$('.webbooking #nidin .listheader .headertable #receverdatetime').html(getlistarray['list'][0]["order_info"]["delivery_reserv_date"]+' '+getlistarray['list'][0]["order_info"]["delivery_reserv_time"].substr(0,5)+'～'+getlistarray['list'][0]["order_info"]["delivery_reserv_time_latest"].substr(0,5));
		}
		else{
			$('.webbooking #nidin .listheader .headertable #receverdatetime').html(getlistarray['list'][0]["order_info"]["delivery_reserv_date"]+' '+getlistarray['list'][0]["order_info"]["delivery_reserv_time"].substr(0,5));
		}
		$('.webbooking #nidin .listheader .headertable #senddatetime').html(getlistarray['list'][0]["order_info"]["order_date"]+' '+getlistarray['list'][0]["order_info"]["order_time"].substr(0,5));
		if(getlistarray['list'][0]["order_info"]['ein']!=''&&getlistarray['list'][0]["order_info"]['ein']!=null){//2021/11/2 統編
			$('.webbooking #nidin .listheader .headertable #carrier').html(getlistarray['list'][0]["order_info"]['ein']);
		}
		else if(typeof getlistarray['list'][0]["invoice_usage"]!=='undefined'&&getlistarray['list'][0]["invoice_usage"]["carrier_id1"]!=''&&getlistarray['list'][0]["invoice_usage"]["carrier_id1"]!=null){//2021/11/2 載具
			$('.webbooking #nidin .listheader .headertable #carrier').html(getlistarray['list'][0]["invoice_usage"]["carrier_id1"]);
		}
		else{
			$('.webbooking #nidin .listheader .headertable #carrier').html('');
		}
		$('.webbooking #nidin .listheader .headertable #memaddress').html(getlistarray['list'][0]["order_info"]["address"]);
		$('.webbooking #nidin .listheader .headertable #listremarks').html(getlistarray['list'][0]["order_info"]["shopper_remark"]);
		
		for(var i=0;i<getlistarray['list'][0]['myitemlist'].length;i++){
			$('.webbooking #nidin .itemlist .itemstable').append('<tr class="listitems"><td style="width:40px;">'+(parseInt(i)+1)+'</td><td style="width:calc((100% - 490px) * 2 / 3);">'+getlistarray['list'][0]['myitemlist'][i]['name']+'</td><td style="width:60px;">'+getlistarray['list'][0]['myitemlist'][i]['size']+'</td><td style="width:calc((100% - 490px) * 2 / 3);">'+getlistarray['list'][0]['myitemlist'][i]['taste']+'</td><td style="width:100px;text-align:right;">'+getlistarray['list'][0]['myitemlist'][i]['price']+'</td><td style="width:40px;text-align:right;">'+getlistarray['list'][0]['myitemlist'][i]['number']+'</td><td style="width:100px;text-align:right;">'+getlistarray['list'][0]['myitemlist'][i]['money']+'</td><td style="width:150px;">'+getlistarray['list'][0]['myitemlist'][i]['remark']+'</td></tr>');
			if(getlistarray['list'][0]['myitemlist'][i]['group']==='1'){
				for(var s=0;s<getlistarray['list'][0]['myitemlist'][i]['subitem'].length;s++){
					$('.webbooking #nidin .itemlist .itemstable').append('<tr class="listitems"><td style="width:40px;">－</td><td style="width:calc((100% - 490px) * 2 / 3);">'+getlistarray['list'][0]['myitemlist'][i]['subitem'][s]['name']+'</td><td style="width:60px;">'+getlistarray['list'][0]['myitemlist'][i]['subitem'][s]['size']+'</td><td style="width:calc((100% - 490px) * 2 / 3);">'+getlistarray['list'][0]['myitemlist'][i]['subitem'][s]['taste']+'</td><td style="width:100px;text-align:right;">'+getlistarray['list'][0]['myitemlist'][i]['subitem'][s]['price']+'</td><td style="width:40px;text-align:right;">'+getlistarray['list'][0]['myitemlist'][i]['subitem'][s]['number']+'</td><td style="width:100px;text-align:right;">'+getlistarray['list'][0]['myitemlist'][i]['subitem'][s]['money']+'</td><td style="width:150px;">'+getlistarray['list'][0]['myitemlist'][i]['subitem'][s]['remark']+'</td></tr>');
				}
			}
			else{
			}
		}

		//$('.remaining .remainingtable #remainingnumber').html(getclassarray['list'][1]['count']);
	}
	else{
	}
};
function webbooking_cleardata(idname){
	$('.webbooking #'+idname+' .listheader .printbox .printclientvalue').val('1');
	$('.webbooking #'+idname+' .listheader .printbox .printtagvalue').val('1');
	$('.webbooking #'+idname+' .listheader .printbox .printclient').html('列印明細');
	$('.webbooking #'+idname+' .listheader .printbox .printtag').html('列印貼紙');
	$('.webbooking #'+idname+' .listheader .headertable #ordercode').html('');
	$('.webbooking #'+idname+' .listheader .headertable #memname').html('');
	$('.webbooking #'+idname+' .listheader .headertable #memtel').html('');
	$('.webbooking #'+idname+' .listheader .headertable #salettlqty').html('0');
	$('.webbooking #'+idname+' .listheader .headertable #salettlamt').html('0');
	$('.webbooking #'+idname+' .listheader .headertable #listtype').html('');
	$('.webbooking #'+idname+' .listheader .headertable #paystate').html('');
	$('.webbooking #'+idname+' .listheader .headertable #paymethod').html('');
	$('.webbooking #'+idname+' .listheader .headertable #liststate').html('');
	$('.webbooking #'+idname+' .listheader .headertable #discount').html('0');
	$('.webbooking #'+idname+' .listheader .headertable #receverdatetime').html('');
	$('.webbooking #'+idname+' .listheader .headertable #senddatetime').html('');
	$('.webbooking #'+idname+' .listheader .headertable #carrier').html('');
	$('.webbooking #'+idname+' .listheader .headertable #memaddress').html('');
	$('.webbooking #'+idname+' .listheader .headertable #listremarks').html('');

	$('.webbooking #'+idname+' .itemlist .itemstable .listitems').remove();

	//$('.remaining .remainingtable #remainingnumber').html('0');
};
function nidin_getthelist(orderid){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/nidin/GetTheList.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User,'orderid':orderid},
		dataType:'json',
		success:function(d){
			//console.log('GetTheList');
			//console.log(d);
			getthelistdata=d;
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			getthelistdata="";
			if(checknidinloop!=null){//有開啟強制檢查要停掉
				clearInterval(checknidinloop);
				checknidinloop=null;
			}
			else{
			}
			if($('.sysmeg #name1.syshint14').length>0){
				$('.sysmeg #name1.syshint14').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint14').length>0){
				$('.sysmeg #name2.syshint14').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_accept(orderid,consecnumber,saleno,machine){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/nidin/Accept.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User,'orderid':orderid,'consecnumber':consecnumber,'machine':machine,'saleno':saleno},
		dataType:'json',
		success:function(d){
			//console.log('Accept');
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_cancel(bizdate,consecnumber){
	var res=$.Deferred();
	if(Token==""&&User==""){
		nidin_login();
	}
	else{
	}
	$.ajax({
		url:'./lib/api/nidin/Cancel.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User,'bizdate':bizdate,'consecnumber':consecnumber},
		dataType:'json',
		success:function(d){
			//console.log('Accept');
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_reject(orderid){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/nidin/Reject.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User,'orderid':orderid,'rejectcode':'101'},
		dataType:'json',
		success:function(d){
			//console.log('Reject');
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_void(bizdate,consecnumber){
	var res=$.Deferred();
	if(Token==""&&User==""){
		nidin_login();
	}
	else{
	}
	$.ajax({
		url:'./lib/api/nidin/Void.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User,'bizdate':bizdate,'consecnumber':consecnumber},
		dataType:'json',
		success:function(d){
			//console.log('Accept');
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_finish(bizdate,consecnumber,payment_status,payment_method){
	var res=$.Deferred();
	if(Token==""&&User==""){
		nidin_login();
	}
	else{
	}
	$.ajax({
		url:'./lib/api/nidin/Finish.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User,'bizdate':bizdate,'consecnumber':consecnumber,'payment_status':payment_status,'payment_method':payment_method},
		dataType:'json',
		success:function(d){
			//console.log('Accept');
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_logout(){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/nidin/Logout.php',
		method:'post',
		async:false,
		data:{'Token':Token,'User':User},
		dataType:'json',
		success:function(d){
			//console.log('Logout');
			//console.log(d);
			Token="";
			User="";
			getclassarray="";
			getlistarray="";
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			///console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function nidin_loop(){
	var res='';
	if(Token!=""&&User!=""){
		res=nidin_getclass();
		res.done(function(){
			if(getclassarray['token_need_replace']===undefined||getclassarray['token_need_replace']==1){//2022/1/24 不存在'token_need_replace'該欄位，表示取資料失敗，同樣要重複token過期流程//2021/8/24 token過期
				Token="";
				User="";
				nidin_loop();
			}
			else if(getclassarray!=""&&getclassarray['list'][1]['count']>0){
				$('.webbooking #nidin .listheader .disaccept').prop('class','accept');
				$('.webbooking #nidin .listheader .disreject').prop('class','reject');
				res=nidin_getlist();
				res.done(function(){
					if($('.webbooking #nidin .listheader .headertable #ordercode #orderid').length==0||getlistarray['list'][0]['order_info']['order_id']!=$('.webbooking #nidin .listheader .headertable #ordercode #orderid').val()){
						webbooking_cleardata('nidin');
						nidin_writedata();
					}
					else{
					}
				});
			}
			else{
				$('.webbooking #nidin .listheader .accept').prop('class','disaccept');
				$('.webbooking #nidin .listheader .reject').prop('class','disreject');
				webbooking_cleardata('nidin');
				if(webbooking.dialog('isOpen')){
					//setTimeout(function(){nidin_loop()},$('.order#order .initsetting #webordersec').val()*1000);
				}
				else{
				}
			}
		});
	}
	else{
		res=nidin_login();
		res.done(function(){
			//console.log(Token);
			if(Token!=""&&User!=""){//檢查是否成功登入
				res=nidin_getclass();
				res.done(function(){
					if(getclassarray!=""&&getclassarray['list'][1]['count']>0){
						$('.webbooking #nidin .listheader .disaccept').prop('class','accept');
						$('.webbooking #nidin .listheader .disreject').prop('class','reject');
						res=nidin_getlist();
						res.done(function(){
							if($('.webbooking #nidin .listheader .headertable #ordercode #orderid').length==0||getlistarray['list'][0]['order_info']['order_id']!=$('.webbooking #nidin .listheader .headertable #ordercode #orderid').val()){
								webbooking_cleardata('nidin');
								nidin_writedata();
							}
							else{
							}
						});
					}
					else{
						$('.webbooking #nidin .listheader .accept').prop('class','disaccept');
						$('.webbooking #nidin .listheader .reject').prop('class','disreject');
						webbooking_cleardata('nidin');
						if(webbooking.dialog('isOpen')){
							//setTimeout(function(){nidin_loop()},$('.order#order .initsetting #webordersec').val()*1000);
						}
						else{
						}
					}
				});
			}
			else{
			}
		});
	}
};
function nidin_listnumberloop(){
	var res='';
	if(Token!=""&&User!=""){
		res=nidin_getclass();
		res.done(function(){
			if(getclassarray['token_need_replace']===undefined||getclassarray['token_need_replace']==1){//2022/1/24 不存在'token_need_replace'該欄位，表示取資料失敗，同樣要重複token過期流程//2021/8/24 token過期
				Token="";
				User="";
				nidin_listnumberloop();
			}
			else{
				if(getclassarray!=""){
					$('.webbooking #nidin .remaining .remainingtable #remainingnumber').html(getclassarray['list'][1]['count']);
					if(getclassarray['list'][1]['count']<=0){
						if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
						}
						else{
							$('.order#order #content #list #funbox #player')[0].pause();
							$('.order#order #content #list #funbox #point').css({'background-color':'red','z-index':'0'});
						}
					}
					else{
					}
					if(webbooking.dialog('isOpen')){
						//setTimeout(function(){nidin_listnumberloop()},$('.order#order .initsetting #webordersec').val()*1000);
					}
					else{
					}
				}
				else{
					$('.webbooking #nidin .remaining .remainingtable #remainingnumber').html('');
					if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
					}
					else{
						$('.order#order #content #list #funbox #player')[0].pause();
						$('.order#order #content #list #funbox #point').css({'background-color':'red','z-index':'0'});
					}
				}
			}
		});
	}
	else{
		res=nidin_login();
		if(Token!=""&&User!=""){//檢查是否成功登入
			res.done(function(){
				if(Token!=""&&User!=""){
					res=nidin_getclass();
					res.done(function(){
						if(getclassarray!=""){
							$('.webbooking #nidin .remaining .remainingtable #remainingnumber').html(getclassarray['list'][1]['count']);
							if(getclassarray['list'][1]['count']<=0){
								if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
								}
								else{
									$('.order#order #content #list #funbox #player')[0].pause();
									$('.order#order #content #list #funbox #point').css({'background-color':'red','z-index':'0'});
								}
							}
							else{
							}
							if(webbooking.dialog('isOpen')){
								//setTimeout(function(){nidin_listnumberloop()},$('.order#order .initsetting #webordersec').val()*1000);
							}
							else{
							}
						}
						else{
							$('.webbooking #nidin .remaining .remainingtable #remainingnumber').html('');
							if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
							}
							else{
								$('.order#order #content #list #funbox #player')[0].pause();
								$('.order#order #content #list #funbox #point').css({'background-color':'red','z-index':'0'});
							}
						}
					});
				}
				else{//2022/5/30 無法連線nidin伺服器
					if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
					}
					else{
						$('.order#order #content #list #funbox #player')[0].pause();
						$('.order#order #content #list #funbox #point').css({'background-color':'red','z-index':'0'});
					}
				}
			});
		}
		else{
		}
	}
};

function quickclick_getlist(){
	var res=$.Deferred();
	$.ajax({
		url:'http://api.tableplus.com.tw/outposandorder/quickclick/GetList.php',
		method:'post',
		async:false,
		data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val()},
		dataType:'json',
		success:function(d){
			//console.log('GetList');
			//console.log(d);
			getlistarrayQ=d;
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function quickclick_getlistnumber(){
	var res=$.Deferred();
	$.ajax({
		url:'http://api.tableplus.com.tw/outposandorder/quickclick/GetListNumber.php',
		method:'post',
		async:false,
		data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val()},
		dataType:'json',
		success:function(d){
			//console.log('GetClass');
			//console.log(d);
			getclassarrayQ=d;
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});
	res.resolve();

	return res.promise();
};
function quickclick_writedata(){
	$('.webbooking #quickclick .listheader .headertable #ordercode').html(getlistarrayQ[0][0]['CLKCODE']+'<input type="hidden" id="orderid" value="'+getlistarrayQ[0][0]['CLKCODE']+'">');
	if(getlistarrayQ[0][0]['RELINVOICETIME']!=';;'&&getlistarrayQ[0][0]['RELINVOICETIME']!=null&&getlistarrayQ[0][0]['RELINVOICETIME']!=''){
		var userdata=getlistarrayQ[0][0]['RELINVOICETIME'].split(';');
		$('.webbooking #quickclick .listheader .headertable #memname').html(userdata[0]);
		$('.webbooking #quickclick .listheader .headertable #memtel').html(userdata[1]);
	}
	else{
		$('.webbooking #quickclick .listheader .headertable #memname').html('');
		$('.webbooking #quickclick .listheader .headertable #memtel').html('');
	}
	$('.webbooking #quickclick .listheader .headertable #salettlqty').html(getlistarrayQ[0][0]['SALESTTLQTY']);
	$('.webbooking #quickclick .listheader .headertable #salettlamt').html(getlistarrayQ[0][0]['SALESTTLAMT']);
	if(getlistarrayQ[0][0]['ordermethod']==2){
		$('.webbooking #quickclick .listheader .headertable #listtype').html('(預約)');
	}
	else{
	}
	switch(getlistarrayQ[0][0]['REMARKS']){
		case '1':
			$('.webbooking #quickclick .listheader .headertable #listtype').append("內用");
			break;
		case '2':
			$('.webbooking #quickclick .listheader .headertable #listtype').append("外帶");
			break;
		case '3':
			$('.webbooking #quickclick .listheader .headertable #listtype').append("外送");
			break;
		case '4':
			$('.webbooking #quickclick .listheader .headertable #listtype').append("自取");
			break;
		default:
			$('.webbooking #quickclick .listheader .headertable #listtype').append("未知");
			break;
	}
	switch(getlistarrayQ[0][0]['paystatus']){
		case 0:
			$('.webbooking #quickclick .listheader .headertable #paystate').html('尚未付款');
			break;
		case 1:
			$('.webbooking #quickclick .listheader .headertable #paystate').html('已付款');
			break;
		default:
			break;
	}
	$('.webbooking #quickclick .listheader .headertable #paymethod').html(getlistarrayQ[0][0]["paymethodname"]);
	switch(getlistarrayQ[0][0]["paystatus"]){
		case 0:
			$('.webbooking #quickclick .listheader .headertable #liststate').html('尚未付款');
			break;
		case 1:
			$('.webbooking #quickclick .listheader .headertable #liststate').html('已付款');
			break;
		default:
			break;
	}
	$('.webbooking #quickclick .listheader .headertable #discount').html((getlistarrayQ[0][0]["discount"]));
	$('.webbooking #quickclick .listheader .headertable #receverdatetime').html(getlistarrayQ[0][0]["receverdatetime"]);
	$('.webbooking #quickclick .listheader .headertable #senddatetime').html(getlistarrayQ[0][0]["CREATEDATETIME"].substr(0,4)+'/'+getlistarrayQ[0][0]["CREATEDATETIME"].substr(4,2)+'/'+getlistarrayQ[0][0]["CREATEDATETIME"].substr(6,2)+' '+getlistarrayQ[0][0]["CREATEDATETIME"].substr(8,2)+':'+getlistarrayQ[0][0]["CREATEDATETIME"].substr(10,2));
	$('.webbooking #quickclick .listheader .headertable #carrier').html('');
	$('.webbooking #quickclick .listheader .headertable #memaddress').html('');
	$('.webbooking #quickclick .listheader .headertable #listremarks').html(getlistarrayQ[0][0]["RELINVOICENUMBER"]);
	
	var itemindex=1;
	for(var i=0;i<getlistarrayQ[1].length;i=i+2){
		if(getlistarrayQ[1][i]['ITEMCODE']!='autodis'&&getlistarrayQ[1][i]['ITEMCODE']!='list'&&getlistarrayQ[1][i]['ITEMCODE']!='item'){
			itemindex=(parseInt(i)/2)+1;
			$('.webbooking #quickclick .itemlist .itemstable').append('<tr class="listitems"><td style="width:40px;">'+itemindex+'</td><td style="width:calc((100% - 490px) * 2 / 3);">'+getlistarrayQ[1][i]['ITEMNAME']+'</td><td style="width:60px;">'+getlistarrayQ[1][i]['UNITPRICELINK']+'</td><td style="width:calc((100% - 490px) * 2 / 3);">'+getlistarrayQ[1][i]['tastename']+'</td><td style="width:100px;text-align:right;">'+getlistarrayQ[1][i]['UNITPRICE']+'</td><td style="width:40px;text-align:right;">'+getlistarrayQ[1][i]['QTY']+'</td><td style="width:100px;text-align:right;">'+getlistarrayQ[1][i]['AMT']+'</td><td style="width:150px;"></td></tr>');
		}
		else{
		}
	}
};
function quickclick_loop(){
	var res="";
	res=quickclick_getlist();
	res.done(function(){
		if(getlistarrayQ.length>0&&getlistarrayQ[0]!=''){
			$('.webbooking #quickclick .listheader .disaccept').prop('class','accept');
			$('.webbooking #quickclick .listheader .disreject').prop('class','reject');
			if($('.webbooking #quickclick .listheader .headertable #ordercode #orderid').length==0||getlistarrayQ[0][0]['CLKCODE']!=$('.webbooking #quickclick .listheader .headertable #ordercode #orderid').val()){
				webbooking_cleardata('quickclick');
				quickclick_writedata();
			}
			else{
			}
		}
		else{
			$('.webbooking #quickclick .listheader .accept').prop('class','disaccept');
			$('.webbooking #quickclick .listheader .reject').prop('class','disreject');
			webbooking_cleardata('quickclick');
			if(webbooking.dialog('isOpen')){
				//setTimeout(function(){nidin_loop()},$('.order#order .initsetting #webordersec').val()*1000);
			}
			else{
			}
		}
	});
};
function quickclick_listnumberloop(){
	var res='';
	res=quickclick_getlistnumber();
	res.done(function(){
		if(getclassarrayQ!=""){
			$('.webbooking #quickclick .remaining .remainingtable #remainingnumber').html(getclassarrayQ[0]['count']);
			if(getclassarrayQ[0]['count']<=0){
				if($('.order#order .initsetting #quickclick').val()=='1'&&$('.order#order .initsetting #quickclicklisttype').val()=='1'){//2022/6/1 QuickClick訂單手動接單
					$('.order#order #content #list #funbox #player')[0].pause();
				}
				else{
				}
			}
			else{
			}
			if(webbooking.dialog('isOpen')){
				//setTimeout(function(){quickclick_getlistnumber()},$('.order#order .initsetting #webordersec').val()*1000);
			}
			else{
			}
		}
		else{
			$('.webbooking #quickclick .remaining .remainingtable #remainingnumber').html('');
			if($('.order#order .initsetting #quickclick').val()=='1'&&$('.order#order .initsetting #quickclicklisttype').val()=='1'){//2022/6/1 QuickClick訂單手動接單
				$('.order#order #content #list #funbox #player')[0].pause();
			}
			else{
			}
		}
	});
};
function quickclick_accept(orderid){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/quickclick/Accept.php',
		method:'post',
		async:false,
		data:{'orderid':orderid},
		dataType:'json',
		success:function(d){
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});

	res.resolve();

	return res.promise();
};
function quickclick_reject(orderid){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/quickclick/Deny.php',
		method:'post',
		async:false,
		data:{'orderid':orderid},
		dataType:'json',
		success:function(d){
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});

	res.resolve();

	return res.promise();
};
function quickclick_cancel(orderid){
	var res=$.Deferred();
	$.ajax({
		url:'./lib/api/quickclick/Cancel.php',
		method:'post',
		async:false,
		data:{'orderid':orderid},
		dataType:'json',
		success:function(d){
			//console.log(d);
		},
		error:function(XMLHttpRequest, textStatus, errorThrown){
			//console.log(textStatus);
			//console.log(errorThrown);
		}
	});

	res.resolve();

	return res.promise();
};
function getweblist(){//2022/5/25 合併nidin、quickclick揭露訂單至網路訂單
	
};

var prompt = function (message, style, time){
    style = (style === undefined) ? 'alert-success' : style;
    time = (time === undefined) ? 2000 : time;
    $('.nidinalertmessage').addClass('alert ' + style).html(message).show().delay(time).fadeOut();
};
var success_prompt = function(message, time){
    prompt(message, 'alert-success', time);
};
//2021/2/24

function roundfun(number,precision){
	return Math.round(Number(number) * Math.pow(10, Number((precision || 0)))) / Math.pow(10, Number((precision || 0)));
}
function ceilfun(number,precision){
	return Math.ceil(Math.ceil(Number(number) * Math.pow(10, Number((precision || 0)) + 1)) / 10) / Math.pow(10, Number((precision || 0)));
}
function floorfun(number,precision){
	return Math.floor(Math.floor(Number(number) * Math.pow(10, Number((precision || 0)) + 1)) / 10) / Math.pow(10, Number((precision || 0)));
}
function openCity(cityClass,cityName) {
	//console.log('1');
	$('.'+cityClass+' .w3-bar-item.w3-button').removeClass('focus');
	$('.'+cityClass+' #'+cityName+'button').addClass('focus');
	$('.'+cityClass+' .'+cityClass+'Item').css({'display':'none'});
	$('.'+cityClass+' #'+cityName).css({'display':'block'});
	//console.log('2');
}
function ClearWindow(tablenumber,listtype){
	//console.clear();
	/*banner*/
	//產品佔存之產品資訊
	$('.order#order .parameters #typeno').val('');
	$('.order#order .parameters #type').val('');
	$('.order#order .parameters #no').val('');
	$('.order#order .parameters #name').val('');
	$('.order#order .parameters #msize').val('');
	for(i=0;i<6;i++){
		$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('');
		$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
		$('.order#order .parameters input[id^="money"]:eq('+i+')').val('');
	}
	$('.order#order #menubox #itemfun #changetaste').prop('disabled',true);
	$('.order#order #menubox #itemfun .startchangetaste').val('0');
	$('.order#order .parameters #taste1').val('');
	$('.order#order .parameters #taste1name').val('');
	$('.order#order .parameters #taste2name').val('');
	$('.order#order .parameters #taste1money').val('');
	$('.order#order .parameters #background').val('');
	//帳單類別、連動桌號
	if($('.order#order #banner #type input[name="reservedatetime"]').length>0){
		$('.order#order #banner #type input[name="reservedatetime"]').val('');
	}
	else{
	}
	if($('.order#order .initsetting #orderlocation').val().length>0){
		$('.order#order #banner #type #button').prop('disabled',false);
		if(listtype==''){
			if($('.order#order .companydata #ispad').val()=='submachine'){
				if($('.order#order .initsetting #subordertype').val()=='1'){
					$('.order#order #banner #type .inside').prop('disabled',false);
					$('.order#order #banner #type .inside').trigger('click');
				}
				else if($('.order#order .initsetting #subordertype').val()=='2'){
					$('.order#order #banner #type .come').prop('disabled',false);
					$('.order#order #banner #type .come').trigger('click');
				}
				else if($('.order#order .initsetting #subordertype').val()=='3'){
					$('.order#order #banner #type .outside').prop('disabled',false);
					$('.order#order #banner #type .outside').trigger('click');
				}
				else if($('.order#order .initsetting #subordertype').val()=='4'){
					$('.order#order #banner #type .bysale').prop('disabled',false);
					$('.order#order #banner #type .bysale').trigger('click');
				}
				else{
				}
			}
			else{
				if($('.order#order .initsetting #ordertype').val()=='1'){
					$('.order#order #banner #type .inside').prop('disabled',false);
					$('.order#order #banner #type .inside').trigger('click');
				}
				else if($('.order#order .initsetting #ordertype').val()=='2'){
					$('.order#order #banner #type .come').prop('disabled',false);
					$('.order#order #banner #type .come').trigger('click');
				}
				else if($('.order#order .initsetting #ordertype').val()=='3'){
					$('.order#order #banner #type .outside').prop('disabled',false);
					$('.order#order #banner #type .outside').trigger('click');
				}
				else if($('.order#order .initsetting #ordertype').val()=='4'){
					$('.order#order #banner #type .bysale').prop('disabled',false);
					$('.order#order #banner #type .bysale').trigger('click');
				}
				else{
				}
			}
		}
		else{
			if(listtype=='1'){
				$('.order#order #banner #type .inside').prop('disabled',false);
				$('.order#order #banner #type .inside').trigger('click');
			}
			else if(listtype=='2'){
				$('.order#order #banner #type .come').prop('disabled',false);
				$('.order#order #banner #type .come').trigger('click');
			}
			else if(listtype=='3'){
				$('.order#order #banner #type .outside').prop('disabled',false);
				$('.order#order #banner #type .outside').trigger('click');
			}
			else if(listtype=='4'){
				$('.order#order #banner #type .bysale').prop('disabled',false);
				$('.order#order #banner #type .bysale').trigger('click');
			}
		}
	}
	else{
	}
	//帳單資訊(金額、總數、發票量)
	$('.order#order #detail #viewtotal').val('0');
	$('.order#order #detail #viewnumber').val('0');
	$('.order#order #banner #detail #salelisthint').val('');
	if($('.order#order .initsetting #useinv').val()=='1'){
		$.ajax({
			url:'./lib/js/getinvnumber.ajax.php',
			method:'post',
			astnc:false,
			data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
			dataType:'json',
			success:function(d){
				//console.log(d);
				$('.order#order #detail #invnum').val(d['remaining']);
				if(typeof d['zdn']!=="undefined"&&d['zdn']=='1'){//中鼎發票數量不足
					if(typeof $('.order#order .zdn')!=='undefined'&&typeof api_zdn_gettoken!=="undefined"&&typeof api_zdn_gettoken==="function"){
						var today = new Date();
						if((today.getMonth() + 1)%2==1){
							var mm = String(today.getMonth() + 2); //January is 0!
							if(mm.length<2){
								mm=String('0')+String(mm);
							}
							else{
							}
						}
						else{
							var mm = String(today.getMonth() + 1); //January is 0!
							if(mm.length<2){
								mm=String('0')+String(mm);
							}
							else{
							}
						}
						var yyyy = Number(today.getFullYear())-1911;

						var res='';
						res=api_zdn_gettoken($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #psw').val());//取得中鼎token
						res.done(function(res){
							res=JSON.parse(res);
							//console.log(res['token']);
							if(typeof res['token']){
								$('.order#order .zdn #token').val(res['token']);
								res='';
								res=api_zdn_showTrack($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),String(yyyy)+String(mm));
								res.done(function(res){
									res=JSON.parse(res);
									//console.log(res);
									var remaining=0;
									if(res['data'].length>0){
										for(var i=0;i<res['data'].length;i++){
											if(res['data'][i]['type']=='07'&&Number(res['data'][i]['used_booklet'])<Number(res['data'][i]['total_booklet'])){
												remaining=Number(remaining)+Number(res['data'][i]['total_booklet'])-Number(res['data'][i]['used_booklet']);
											}
											else{
											}
										}
										if(remaining>0){
											res='';
											res=api_zdn_getInv($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),remaining);//取得發票號(以"本"為單位；1本50張)
											res.done(function(res){
												res=JSON.parse(res);
												//console.log(res);
												if(res['success']==true){
													$.ajax({
														url:'./lib/js/create.invfile.php',
														method:'post',
														data:{'machine':$('.order#order .companydata #terminalnumber').val(),'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'data':res},
														dataType:'html',
														success:function(d){
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
											});
											//console.log(remaining);
										}
										else{
											//console.log('empty');
										}
									}
									else{
									}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'file':'zdninvlog','html':'api_zdn_gettoken get token fail','data':res},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
						});
					}
					else{
					}
				}
				else{
				}
			},
			error:function(e){
				//console.log(e);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'getinvnumber.ajax.php '+e},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
			}
		});
	}
	else{
	}
	if($('.order#order .initsetting #useoinv').val()=='1'){
		$.ajax({
			url:'./lib/js/getoinvnumber.ajax.php',
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'getoinvnumber.ajax.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				$('.order#order #detail #oinv').val(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	}
	else{
	}
	/*member tabs1*/
	//tempbox
	$('.order#order #tabs1 #tempbox input[name="target"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
	$('.order#order #tabs1 #tempbox input[name="type"]').val('');
	$('.order#order #tabs1 #tempbox input[name="no"]').val('');
	$('.order#order #tabs1 #tempbox input[name="personcount"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="needcharge"]').val('1');
	$('.order#order #tabs1 #tempbox input[name="dis1"]').val('');
	$('.order#order #tabs1 #tempbox input[name="dis2"]').val('');
	$('.order#order #tabs1 #tempbox input[name="dis3"]').val('');
	$('.order#order #tabs1 #tempbox input[name="dis4"]').val('');
	$('.order#order #tabs1 #tempbox input[name="name"]').val('');
	$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
	$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('');
	$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
	$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
	$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
	$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
	$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="money"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
	$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
	$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
	$('.order#order #tabs1 #tempbox input[name="number"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
	$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
	$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
	$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
	$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
	$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
	$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="background"]').val('');
	$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
	$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
	$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
	$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
	$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('1');
	$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('0');
	$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('0');
	$('.order#order #tabs1 #editview').val('');
	//membutton
	if($('.order#order .initsetting #openmember').val()=='1'){
		$.ajax({
			url:'./lib/js/getbuttonname.ajax.php',
			method:'post',
			async:false,
			data:{'name':'member'},
			dataType:'json',
			success:function(d){
				//console.log(d);
				$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]);
			},
			error:function(e){
				//console.log(e);
				$('.order#order #tabs1 #membutton div:eq(0)').html('會員');
			}
		});
		$('.order#order #tabs1 #membutton div:eq(1)').html('');
		$('.order#order #tabs1 #membutton div:eq(2)').html('');
		$('.order#order #tabs1 #membutton #memberpoint').val('0');
		$('.order#order #tabs1 #membutton #membermoney').val('0');
		$('.order#order #tabs1 #membutton #companynumber').val('');
		$('.yunlincoinsico').css({'display':'none'});//2022/9/27 隱藏yunlincoins icon
	}
	else{
	}
	//persons
	//if($('.order#order .initsetting #openpersoncount').val()=='1'){
		$('.order#order #tabs1 #persons').val('0');
		for(var i=1;i<=$('.setperson #view input[data-id="person"]').length;i++){
			$('.setperson #view input[name="persons'+i+'"]').val('0');
		}
	/*}
	else{
	}*/
	/*list*/
	//tabs4
	$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val('');
	$('.order#order #tabs4 form[data-id="listform"] input[name="memtel"]').val('');
	$('.order#order #tabs4 form[data-id="listform"] input[name="memaddno"]').val('');
	$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val('');
	$.ajax({
		url:'./lib/js/getnewbizdate.ajax.php',
		method:'post',
		data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
		dataType:'html',
		success:function(d){
			if(d.length>20||d.match('ERROR HINT: ')){
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'getnewbizdate.ajax.php '+d},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
			}
			else{
			}
			$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(d);
		},
		error:function(e){
			//console.log(e);
		}
	});
	if($('.order#order .initsetting #orderlocation').val().length>0){
		if(listtype==''){
			if($('.order#order .companydata #ispad').val()=='submachine'){
				if($('.order#order .initsetting #subordertype').val()=='1'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('1');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .inside #name1').html());
				}
				else if($('.order#order .initsetting #subordertype').val()=='2'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('2');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .come #name1').html());
				}
				else if($('.order#order .initsetting #subordertype').val()=='3'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('3');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .outside #name1').html());
				}
				else if($('.order#order .initsetting #subordertype').val()=='4'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('4');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .bysale #name1').html());
				}
				else{
				}
			}
			else{
				if($('.order#order .initsetting #ordertype').val()=='1'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('1');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .inside #name1').html());
				}
				else if($('.order#order .initsetting #ordertype').val()=='2'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('2');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .come #name1').html());
				}
				else if($('.order#order .initsetting #ordertype').val()=='3'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('3');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .outside #name1').html());
				}
				else if($('.order#order .initsetting #ordertype').val()=='4'){
					$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('4');
					$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .bysale #name1').html());
				}
				else{
				}
			}
		}
		else{
			if(listtype=='1'){
				$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('1');
				$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .inside #name1').html());
			}
			else if(listtype=='2'){
				$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('2');
				$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .come #name1').html());
			}
			else if(listtype=='3'){
				$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('3');
				$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .outside #name1').html());
			}
			else if(listtype=='4'){
				$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val('4');
				$('.order#order #tabs4 form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .bysale #name1').html());
			}
			else{
			}
		}
	}
	else{
	}
	$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val('0');
	$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val('');
	$('.order#order #tabs4 form[data-id="listform"] input[name="tempban"]').val('');
	$.ajax({
		url:'./lib/js/gettempdata.ajax.php',
		dataType:'html',
		success:function(d){
			var temp=d.split(',');
			$('.order#order #tabs4 form[data-id="listform"] input[name="tempbuytype"]').val(temp[0]);
			$('.order#order #tabs4 form[data-id="listform"] input[name="printclientlist"]').val(temp[1]);
		},
		error:function(e){
			//console.log(e);
		}
	});
	$('.order#order #tabs4 form[data-id="listform"] input[name="total"]').val('0');
	$('.order#order #tabs4 form[data-id="listform"] input[name="totalnumber"]').val('0');
	$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(tablenumber);
	$('.order#order #tabs4 form[data-id="listform"] input[name="person1"]').val('0');
	$('.order#order #tabs4 form[data-id="listform"] input[name="person2"]').val('0');
	$('.order#order #tabs4 form[data-id="listform"] input[name="person3"]').val('0');
	$('.order#order #tabs4 form[data-id="listform"] input[name="mancode"]').val('');
	$('.order#order #tabs4 form[data-id="listform"] input[name="manname"]').val('');
	$('.order#order #tabs4 form[data-id="listform"] .listcontent').html('');
	//tabs5
	$('.order#order #tabs5 form[data-id="listform"] input[name="tempban"]').val('');
	$('.order#order #tabs5 form[data-id="listform"] input[name="total"]').val('0');
	$('.order#order #tabs5 form[data-id="listform"] .listcontent').html('');
	//console.log('1');
	/*result*/
	$('.result #viewwindow #submit').prop('disabled',false);
	$.ajax({
		url:'./lib/js/check.booking.php',
		method:'post',
		async:false,
		data:{'machinetype':$('.order#order .companydata #terminalnumber').val()},
		dataType:'html',
		success:function(d){
			if(d=='success'){
				if($('.order#order #banner #detail #tw #point').css('background-color')=='red'){
				}
				else{
					$('.order#order #banner #detail #tw #point').css({'background-color':'red','z-index':'3'});
				}
			}
			else{
				$('.order#order #banner #detail #tw #point').css({'background-color':'','z-index':''});
			}
			//console.log(d);
		},
		error:function(e){
			//console.log(e);
		}
	});

	if($('.order#order .initsetting #pointtree').val()=='1'){
		$('.pointtreememdata #tel').html('');
		$('.pointtreememdata #name').html('');
		$('.pointtreememdata #ismem').html('');
		$('.pointtreememdata #sex').html('');
		$('.pointtreememdata #balance').html('');
	}
	else{
	}
}
function temporder(bizdate,consecnumber,machinetype,company,usercode,username){
	initlisttype();
	initsumbox();
	initparameters();
	inittempbox();
	initlists();
	initorder();
	//console.log(bizdate);
	//console.log(consecnumber);
	$.ajax({
		url:'./lib/js/temporder.banner.php',
		method:'post',
		data:{'bizdate':bizdate,'consecnumber':consecnumber},
		dataType:'json',
		success:function(d){
			//console.log(d);
			if(d[0]['REMARKS'].toString().match(/-/g)){
				var temp=d[0]['REMARKS'].toString().split("-");
				$('.order#order #banner #type input[name="reservedatetime"]').val(temp[1]);
				if(temp[0]=='1'){
					$('.order#order #banner #type').css({'margin-right':'1px'});
					$('.order#order #banner #type button.inside').prop('disabled',true);
					$('.order#order #banner #tablenumber').prop('style','float: left;width: calc(42% / 5 - 2px);height: 100%;margin: 0px 1px;');
					if($('.order#order .initsetting #tabnum').val()==1){
						$.ajax({
							url:'./lib/js/getinterfacename.ajax.php',
							method:'post',
							async:false,
							data:{'name':'tabnumtext'},
							dataType:'json',
							success:function(v){
								var tablehtml='<div style="width:100%;height:50%;text-align:center;">'+v[0]+'</div><div style="width:100%;height:50%;border:1px solid #898989;text-align:center;border-radius: 5px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;">';
								if(typeof d[0]['TABLENAME']!=="undefined"){
									tablehtml += $.trim(d[0]['TABLENAME']);
								}
								else{
									tablehtml += $.trim(d[0]['TABLENUMBER']);
								}
								tablehtml += '</div>';
								$('.order#order #banner #tablenumber').html(tablehtml);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					$('.order#order #banner #detail').css({'margin-left':'3px'});
					$('.order#order #banner #detail #viewtotal').val(d[0]['SALESTTLAMT']);
					$('.order#order #banner #detail #viewnumber').val(d[0]['SALESTTLQTY']);
					$('.order#order #banner #detail #salelisthint').val(d[0]['RELINVOICENUMBER']);
				}
				else{
					$('.order#order #banner #type').css({'margin-right':'calc(42% / 5)'});
					if(temp[0]=='2'){
						$('.order#order #banner #type button.come').prop('disabled',true);
					}
					else if(temp[0]=='3'){
						$('.order#order #banner #type button.outside').prop('disabled',true);
					}
					else{
						$('.order#order #banner #type button.bysale').prop('disabled',true);
					}
					$('.order#order #banner #tablenumber').prop('style','float: left;');
					$('.order#order #banner #tablenumber').html('');
					$('.order#order #banner #detail').css({'margin-left':'3px'});
					$('.order#order #banner #detail #viewtotal').val(d[0]['SALESTTLAMT']);
					$('.order#order #banner #detail #viewnumber').val(d[0]['SALESTTLQTY']);
					$('.order#order #banner #detail #salelisthint').val(d[0]['RELINVOICENUMBER']);
				}
			}
			else{
				if(d[0]['REMARKS']=='1'){
					$('.order#order #banner #type').css({'margin-right':'1px'});
					$('.order#order #banner #type button.inside').prop('disabled',true);
					$('.order#order #banner #tablenumber').prop('style','float: left;width: calc(42% / 5 - 2px);height: 100%;margin: 0px 1px;');
					if($('.order#order .initsetting #tabnum').val()==1){
						$.ajax({
							url:'./lib/js/getinterfacename.ajax.php',
							method:'post',
							async:false,
							data:{'name':'tabnumtext'},
							dataType:'json',
							success:function(v){
								var tablehtml='<div style="width:100%;height:50%;text-align:center;">'+v[0]+'</div><div style="width:100%;height:50%;border:1px solid #898989;text-align:center;border-radius: 5px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;">';
								if(typeof d[0]['TABLENAME']!=="undefined"){
									tablehtml += $.trim(d[0]['TABLENAME']);
								}
								else{
									tablehtml += $.trim(d[0]['TABLENUMBER']);
								}
								tablehtml += '</div>';
								$('.order#order #banner #tablenumber').html(tablehtml);
								//$('.order#order #banner #tablenumber').html('<div style="width:100%;height:50%;text-align:center;">'+v[0]+'</div><div class="tabnumbox" style="width:100%;height:50%;border:1px solid #898989;text-align:center;border-radius: 5px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;">'+$.trim(d[0]['TABLENUMBER'])+'</div>');
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					$('.order#order #banner #detail').css({'margin-left':'3px'});
					$('.order#order #banner #detail #viewtotal').val(d[0]['SALESTTLAMT']);
					$('.order#order #banner #detail #viewnumber').val(d[0]['SALESTTLQTY']);
					$('.order#order #banner #detail #salelisthint').val(d[0]['RELINVOICENUMBER']);
				}
				else{
					$('.order#order #banner #type').css({'margin-right':'calc(42% / 5)'});
					if(d[0]['REMARKS']=='2'){
						$('.order#order #banner #type button.come').prop('disabled',true);
					}
					else if(d[0]['REMARKS']=='3'){
						$('.order#order #banner #type button.outside').prop('disabled',true);
					}
					else{
						$('.order#order #banner #type button.bysale').prop('disabled',true);
					}
					$('.order#order #banner #tablenumber').prop('style','float: left;');
					$('.order#order #banner #tablenumber').html('');
					$('.order#order #banner #detail').css({'margin-left':'3px'});
					$('.order#order #banner #detail #viewtotal').val(d[0]['SALESTTLAMT']);
					$('.order#order #banner #detail #viewnumber').val(d[0]['SALESTTLQTY']);
					$('.order#order #banner #detail #salelisthint').val(d[0]['RELINVOICENUMBER']);
				}
			}
			$.ajax({
				url:'./lib/js/temporder.list.php',
				method:'post',
				async: false,
				data:{'machinetype':machinetype,'company':company,'bizdate':bizdate,'consecnumber':consecnumber,'usercode':usercode,'username':username},
				dataType:'html',
				success:function(d){
					$('.order#order #MemberBill #list #tabs4 form[data-id="listform"]').html(d);
					$('.setperson #view input[name="persons1"]').val($('.order#order #tabs4 form[data-id="listform"] input[name="person1"]').val());
					$('.setperson #view input[name="persons2"]').val($('.order#order #tabs4 form[data-id="listform"] input[name="person2"]').val());
					$('.setperson #view input[name="persons3"]').val($('.order#order #tabs4 form[data-id="listform"] input[name="person3"]').val());
					$('.setperson #buttons #submit').trigger('click');
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.order#order .initsetting #secview').val()=='1'){//2020/10/30 重新撈出帳單資訊並寫入客顯
				if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
					socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
					console.log('send message "listitemupdate" to secview');
				}
				else{
				}
			}
			else{
			}
			if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'&&$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val()!=''){
				$.ajax({
					url:'http://api.tableplus.com.tw/outposandorder/demopos/lib/js/gettempmemdata.ajax.php',
					method:'post',
					async: false,
					data:{'ajax':"",'company':company,'story':$('.order#order .companydata #story').val(),'memno':$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val()},
					dataType:'json',
					timeout:5000,
					success:function(d){
						//console.log(d);
						if(d.length>0){
							if(typeof d[0]['powername']!=='undefined'&&d[0]['powername']!=''){
								$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]['name']+'('+d[0]['powername']+')');
							}
							else{
								$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]['name']);
							}
							$('.order#order #tabs1 #membutton div:eq(1)').html(d[0]['tel']);
							$('.order#order #tabs1 #membutton div:eq(2)').html(d[0]['remark']);
							if(typeof d[0]['point']==="undefined"){
								$('.order#order #tabs1 #membutton #memberpoint').val('0');
								$('.memdata #point').html('0');
							}
							else{
								$('.order#order #tabs1 #membutton #memberpoint').val(d[0]['point']);
								$('.memdata #point').html(d[0]['point']);
							}
							if(typeof d[0]['money']==="undefined"){
								$('.order#order #tabs1 #membutton #membermoney').val('0');
								$('.memdata #money').html('0');
							}
							else{
								$('.order#order #tabs1 #membutton #membermoney').val(d[0]['money']);
								$('.memdata #money').html(d[0]['money']);
							}
							if(typeof d[0]['companynumber']==="undefined"){
								$('.order#order #tabs1 #membutton #companynumber').val('');
								$('.memdata #companynumber').html('');
							}
							else{
								$('.order#order #tabs1 #membutton #companynumber').val(d[0]['companynumber']);
								$('.memdata #companynumber').html(d[0]['companynumber']);
							}

							$('.memdata #name').html(d[0]['name']);
							$('.memdata #tel').html(d[0]['tel']);
							$('.memdata #memremark').html(d[0]['remark']);
							if(d[0]['address']==null){
								$('.memdata #address').html('');
							}
							else{
								//$('.memdata #address').html(d[0]['address']);
								if(d[0]['address'].match(/;*;/g)){
									var addlist=d[0]['address'].split(';*;');
									var addselect='<select id="addselect" style="width:100%;padding:5px;">';
									for(var i=0;i<addlist.length;i++){
										addselect += '<option value="'+(parseInt(i)+1)+'" ';
										if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').length>0&&$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val()!=''){
											if((parseInt(i)+1)!=$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val()){
											}
											else{
												addselect += 'selected';
											}
										}
										else{
											if(i!=0){
											}
											else{
												addselect += 'selected';
											}
										}
										addselect += '>'+addlist[i]+'</option>';
									}
									addselect += '</select>';
									$('.memdata #address').html(addselect);
								}
								else{
									var addselect='<select><option value="1" selected>'+d[0]['address']+'</option></select>';
									$('.memdata #address').html(addselect);
								}
							}
							
							if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').length>0&&$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').val()==''){
								$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').val(d[0]['tel']);
							}
							else{
							}

							//2021/9/27 更改為正確會員編號，不更正會導致結帳後的會員資訊為空白
							if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').length>0&&$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val()!=''){
								$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val(d[0]['memno']);
							}
							else{
							}

							if(d[0]['setting']==null){
								$('.memdata #setting').html('');
							}
							else{
								$('.memdata #setting').html(d[0]['setting']);
							}
						}
						else{
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'member'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]);
								},
								error:function(e){
									//console.log(e);
									$('.order#order #tabs1 #membutton div:eq(0)').html('會員');
								}
							});
							$('.order#order #tabs1 #membutton div:eq(1)').html('');
							$('.order#order #tabs1 #membutton div:eq(2)').html('');
							$('.order#order #tabs1 #membutton #memberpoint').val('0');
							$('.order#order #tabs1 #membutton #membermoney').val('0');
							$('.order#order #tabs1 #membutton #companynumber').val('');
							$('.memdata #name').html('');
							$('.memdata #tel').html('');
							$('.memdata #memremark').html('');
							$('.memdata #address').html('');
							$('.memdata #tel2').html('');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val()!=''){
				$.ajax({
					url:'./lib/js/gettempmemdata.ajax.php',
					method:'post',
					async: false,
					data:{'company':company,'story':$('.order#order .companydata #story').val(),'memno':$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val()},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(d.length>0){
							if(typeof d[0]['powername']!=='undefined'&&d[0]['powername']!=''){
								$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]['name']+'('+d[0]['powername']+')');
							}
							else{
								$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]['name']);
							}
							//$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]['name']);
							$('.order#order #tabs1 #membutton div:eq(1)').html(d[0]['tel']);
							$('.order#order #tabs1 #membutton div:eq(2)').html(d[0]['remark']);
							if(typeof d[0]['point']==="undefined"){
								$('.order#order #tabs1 #membutton #memberpoint').val('0');
							}
							else{
								$('.order#order #tabs1 #membutton #memberpoint').val(d[0]['point']);
							}
							if(typeof d[0]['money']==="undefined"){
								$('.order#order #tabs1 #membutton #membermoney').val('0');
							}
							else{
								$('.order#order #tabs1 #membutton #membermoney').val(d[0]['money']);
							}
							if(typeof d[0]['companynumber']==="undefined"||d[0]['companynumber']==null){
								$('.order#order #tabs1 #membutton #companynumber').val('');
							}
							else{
								$('.order#order #tabs1 #membutton #companynumber').val(d[0]['companynumber']);
							}
							$('.memdata #name').html(d[0]['name']);
							$('.memdata #tel').html(d[0]['tel']);
							$('.memdata #memremark').html(d[0]['remark']);
							if(d[0]['address']==null){
								$('.memdata #address').html('');
							}
							else{
								//$('.memdata #address').html(d[0]['address']);
								if(d[0]['address'].match(/;*;/g)){
									var addlist=d[0]['address'].split(';*;');
									var addselect='<select id="addselect" style="width:100%;padding:5px;">';
									for(var i=0;i<addlist.length;i++){
										addselect += '<option value="'+(parseInt(i)+1)+'" ';
										if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').length>0&&$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val()!=''){
											if((parseInt(i)+1)!=$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val()){
											}
											else{
												addselect += 'selected';
											}
										}
										else{
											if(i!=0){
											}
											else{
												addselect += 'selected';
											}
										}
										addselect += '>'+addlist[i]+'</option>';
									}
									addselect += '</select>';
									$('.memdata #address').html(addselect);
								}
								else{
									var addselect='<select><option value="1" selected>'+d[0]['address']+'</option></select>';
									$('.memdata #address').html(addselect);
								}
							}
							
							if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').length>0&&$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').val()==''){
								$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').val(d[0]['tel']);
							}
							else{
							}

							//2021/9/27 更改為正確會員編號，不更正會導致結帳後的會員資訊為空白
							if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').length>0&&$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val()!=''){
								$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val(d[0]['memno']);
							}
							else{
							}

							if(d[0]['setting']==null){
								$('.memdata #setting').html('');
							}
							else{
								$('.memdata #setting').html(d[0]['setting']);
							}
						}
						else{
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'member'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]);
								},
								error:function(e){
									//console.log(e);
									$('.order#order #tabs1 #membutton div:eq(0)').html('會員');
								}
							});
							$('.order#order #tabs1 #membutton div:eq(1)').html('');
							$('.order#order #tabs1 #membutton div:eq(2)').html('');
							$('.order#order #tabs1 #membutton #memberpoint').val('0');
							$('.order#order #tabs1 #membutton #membermoney').val('0');
							$('.order#order #tabs1 #membutton #companynumber').val('');
							$('.memdata #name').html('');
							$('.memdata #tel').html('');
							$('.memdata #memremark').html('');
							$('.memdata #address').html('');
							$('.memdata #tel2').html('');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
				$.ajax({
					url:'./lib/js/getbuttonname.ajax.php',
					method:'post',
					async:false,
					data:{'name':'member'},
					dataType:'json',
					success:function(d){
						//console.log(d);
						$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]);
					},
					error:function(e){
						//console.log(e);
						$('.order#order #tabs1 #membutton div:eq(0)').html('會員');
					}
				});
				$('.order#order #tabs1 #membutton div:eq(1)').html('');
				$('.order#order #tabs1 #membutton div:eq(2)').html('');
				$('.order#order #tabs1 #membutton #memberpoint').val('0');
				$('.order#order #tabs1 #membutton #membermoney').val('0');
				$('.order#order #tabs1 #membutton #companynumber').val('');
				$('.memdata #name').html('');
				$('.memdata #tel').html('');
				$('.memdata #memremark').html('');
				$('.memdata #address').html('');
				$('.memdata #tel2').html('');
			}
			$.ajax({//2020/4/20 計算未結單中，使用到的所有點數
				url:'./lib/js/temporder.point.php',
				method:'post',
				async:false,
				data:{'machinetype':machinetype,'company':company,'bizdate':bizdate,'consecnumber':consecnumber,'usercode':usercode,'username':username},
				dataType:'json',
				success:function(d){
					//console.log(d);
					$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val(parseInt($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val())+parseInt(d['memberpoint']));
					$('.memdata #point').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());
				},
				error:function(e){
					//console.log(e);
				}
			});
		},
		error:function(e){
			//console.log(e);
		}
	});
};
function initlisttype(){
	$('.order#order #banner #type').css({'margin-right':'15px'});
	$('.order#order #banner #type button').prop('disabled',false);
	$('.order#order #banner #tablenumber').prop('style','float:left;');
	$('.order#order #banner #tablenumber').html('');
	$('.order#order #banner #detail').css({'margin-left':'clac(47% - 478px)'});
};
function initsumbox(){
	$('.order#order #banner #detail #viewtotal').val('0');
	$('.order#order #banner #detail #viewnumber').val('0');
};
function initparameters(){
	$('.order#order .parameters #typeno').val('');
	$('.order#order .parameters #type').val('');
	$('.order#order .parameters #no').val('');
	$('.order#order .parameters #name').val('');
	$('.order#order .parameters #isgroup').val('');
	$('.order#order .parameters #childtype').val('');
	$('.order#order .parameters #msize').val('');
	$('.order#order .parameters input[id="mname1[]"]').val('');
	$('.order#order .parameters input[id="mname2[]"]').val('');
	$('.order#order .parameters input[id="money[]"]').val('');
	$('.order#order .parameters #taste1').val('');
	$('.order#order .parameters #taste1name').val('');
	$('.order#order .parameters #taste2name').val('');
	$('.order#order .parameters #taste1money').val('');
	$('.order#order .parameters #background').val('');
	$('.order#order .parameters #sale').val('');
	$('.order#order .parameters #salename').val('');
};
function inittempbox(){
	$('.order#order #MemberBill #tabs1 #tempbox input[name="target"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="typeno"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="type"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="no"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="name"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="name2"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="isgroup"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="childtype"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="mname1"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="mname2"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="insaleinv"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="unitprice"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="money"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="discount"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="discontent"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
	$('.order#order #MemberBill #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
	$('.order#order #MemberBill #tabs1 #tempbox input[name="number"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="subtotal"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="taste1"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="taste1name"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="taste1price"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="taste1number"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="taste1money"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="taste2"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="background"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="itemdis"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="listdis"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="bothdis"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="usemempoint"]').val('');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="getpointtype"]').val('1');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="initgetpoint"]').val('0');
	$('.order#order #MemberBill #tabs1 #tempbox input[name="getpoint"]').val('0');
	$('.order#order #MemberBill #tabs1 #editview').val('');
};
function initlists(){
	//$('.order#order #MemberBill #list #tabs4 form[data-id="listform"]').html('');
};
function initorder(){
	for(var i=0;i<6;i++){
		$('.order#order #menubox #itemfun .itemmname'+(i+1)+' div#name1').html('');
		$('.order#order #menubox #itemfun .itemmname'+(i+1)+' div#name2').html('');
		$('.order#order #menubox #itemfun .itemmname'+(i+1)).prop('disabled',true);
		$('.order#order #menubox #itemfun .itemmoney'+(i+1)).val('0');
	}
	for(i=0;i<10;i++){
		$('.order#order #menubox #itemfun #taste'+i+' div#name1').html('');
		$('.order#order #menubox #itemfun #taste'+i+' div#name2').html('');
		$('.order#order #menubox #itemfun #taste'+i).prop('disabled',true);
		$('.order#order #menubox #itemfun .tasteno'+i).val('');
		$('.order#order #menubox #itemfun .tasteprice'+i).val('');
		$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':''});
	}
};
function writesteplog(step,message){//2020/11/30 紀錄操作流程
	$.ajax({
		url:'./lib/js/write.steplog.ajax.php',
		method:'post',
		async:false,
		cache:false,
		data:{'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'step':step,'message':message},
		dataType:'html',
		success:function(d){
			//console.log(d);
		},
		error:function(e){
			//console.log(e);
		}
	});
}
var responce=true;
var tempparameter=1;
jQuery.fn.putCursorAtEnd = function() {
	return this.each(function() {
		var $el = $(this),el = this;
		if (!$el.is(":focus")) {
			$el.focus();
		}
		if (el.setSelectionRange) {
			  var len = $el.val().length * 2;
			  setTimeout(function() {
					el.setSelectionRange(len, len);
			  }, 1);
		
		} else {
			  $el.val($el.val());
		}
		this.scrollTop = 999999;
  });
};
function detectZoom (){
	var ratio = 0,
	screen = window.screen,
	ua = navigator.userAgent.toLowerCase();

	if (window.devicePixelRatio !== undefined) {
		ratio = window.devicePixelRatio;
	}
	else if (~ua.indexOf('msie')) {
		if (screen.deviceXDPI && screen.logicalXDPI) {
			ratio = screen.deviceXDPI / screen.logicalXDPI;
		}
	}
	else if (window.outerWidth !== undefined && window.innerWidth !== undefined) {
		ratio = window.outerWidth / window.innerWidth;
	}

	if (ratio){
		ratio = Math.round(ratio * 100);
	}

	return ratio;
};
$(function() {
	if(typeof FastClick!=="undefined"){
		FastClick.attach(document.body);
	}
	else{
	}
});
$(window).on('resize',function(){
	var isMobile = {
		Android: function() {
			return navigator.userAgent.match(/Android/i);
		},
		BlackBerry: function() {
			return navigator.userAgent.match(/BlackBerry/i);
		},
		iOS: function() {
			return navigator.userAgent.match(/iOS|iPhone|iPad|iPod|Macintosh/i);
		},
		Opera: function() {
			return navigator.userAgent.match(/Opera Mini/i);
		},
		Windows: function() {
			return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
		},
		any: function() {
			return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
		}
	};
	if((!isMobile.Android() && typeof isMobile.Android() != "undefined" && isMobile.Android() != 0)&&(!isMobile.iOS() && typeof isMobile.iOS() != "undefined" && isMobile.iOS() != 0)){
		isScale();
	}
	else{
	}
	
});
function isScale(){
	var rate = detectZoom();
	if(rate != 100){
		//如何让页面的缩放比例自动为100,'transform':'scale(1,1)'没有用，又无法自动条用键盘事件，目前只能提示让用户如果想使用100%的比例手动去触发按ctrl+0
		//console.log(1);
		alertmessage('目前畫面不是100%顯示，請按鍵盤ctrl+0恢復100%顯示標準，以防畫面顯示錯亂！');
	}
}
function closedisbut(){
	$('.result #funbox #listdisbutA').prop('disabled',true);
	$('.result #funbox #listdisbutB').prop('disabled',true);
	$('.result #funbox .listdisbut1').prop('disabled',true);
	$('.result #funbox .listdisbut2').prop('disabled',true);
	$('.result #funbox .listdisbut3').prop('disabled',true);
	$('.result #funbox .listdisbut4').prop('disabled',true);
	$('.result #funbox .listdisbut5').prop('disabled',true);
	$('.result #funbox .listdisbut6').prop('disabled',true);
	$('.result #funbox .chargebut').prop('disabled',true);
}
function opendisbut(){
	$('.result #funbox #listdisbutA').prop('disabled',false);
	$('.result #funbox #listdisbutB').prop('disabled',false);
	if($('.result #funbox .listdis1').val()!=''){
		$('.result #funbox .listdisbut1').prop('disabled',false);
	}
	else{
	}
	if($('.result #funbox .listdis2').val()!=''){
		$('.result #funbox .listdisbut2').prop('disabled',false);
	}
	else{
	}
	if($('.result #funbox .listdis3').val()!=''){
		$('.result #funbox .listdisbut3').prop('disabled',false);
	}
	else{
	}
	if($('.result #funbox .listdis4').val()!=''){
		$('.result #funbox .listdisbut4').prop('disabled',false);
	}
	else{
	}
	if($('.result #funbox .listdis5').val()!=''){
		$('.result #funbox .listdisbut5').prop('disabled',false);
	}
	else{
	}
	if($('.result #funbox .listdis6').val()!=''){
		$('.result #funbox .listdisbut6').prop('disabled',false);
	}
	else{
	}
	$('.result #funbox .chargebut').prop('disabled',false);
}
$(document).ready(function(){
	//2022/5/26 網路訂單內頁分頁，方便後續不同平台訂單合併
	booktype=$('.webbooking').tabs();

	//2021/12/13 POS端公告視窗
	$('.pospa .checkpa').click(function(){
		$.ajax({
			url:'./lib/js/check_notpaymoney_password.php',
			method:'post',
			async:false,
			cache:false,
			data:{'checkenterpassword':$('.pospa input[name="password"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.pospa input[name="password"]').val('');
				if(d=='success'){
					$('.pospa').css({'display':'none'});
				}
				else{
					if(d=='fail'){
						$('.pospa #checkres').html('密碼錯誤。');
					}
					else{
						$('.pospa #checkres').html('密碼已過期。');
					}
				}
			},
			error:function(e){
				//console.log(e);
				$('.pospa input[name="password"]').val('');
				$('.pospa #checkres').html('密碼錯誤。');
			}
		});
	});
	$('.pospa .exit').click(function(){
		if($('.order#order .initsetting #secview').val()=='1'){
			$.ajax({
				url:'../secview/cleartemp.ajax.php',
				method:'post',
				async: false,
				data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
				socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
				console.log('send message "clear" to secview');
			}
			else{
			}
		}
		else{
		}
		/*if($('.order#order .companydata #ispad').val()=='submachine'){//2018/2/7
			//var mywin=window.open('exit://','','width=1px,height=1px');
		}
		else{//2018/2/7
			if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()!='m1'){
				//var mywin=window.open('exit://','','width=1px,height=1px');
			}
			else{*/
			if($('.order#order .initsetting #posexitmode').length>0&&$('.order#order .initsetting #posexitmode').val()=='2'){
				var mywin=window.open('exit://','','width=1px,height=1px');
			}
			else{
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':$('.order#order .companydata #terminalnumber').val()+'-exit_'+$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			/*}
		}*/
	});
	$('.mobilepa .checkpa').click(function(){
		$.ajax({
			url:'./lib/js/check_mnotpaymoney_password.php',
			method:'post',
			async:false,
			cache:false,
			data:{'checkenterpassword':$('.mobilepa input[name="password"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.mobilepa input[name="password"]').val('');
				if(d=='success'){
					$('.mobilepa').css({'display':'none'});
				}
				else{
					if(d=='fail'){
						$('.mobilepa #checkres').html('密碼錯誤。');
					}
					else{
						$('.mobilepa #checkres').html('密碼已過期。');
					}
				}
			},
			error:function(e){
				//console.log(e);
				$('.mobilepa input[name="password"]').val('');
				$('.mobilepa #checkres').html('密碼錯誤。');
			}
		});
	});
	if($('input[name="usenodejs"]').length>0){//2020/10/29 nodejs - Push server
		if($('.order#order .initsetting #foodpanda').val()=='1'||$('.order#order .initsetting #openubereats').val()=='1'||$('.order#order .initsetting #quickclick').val()=='1'){
			download = io.connect('http://api.tableplus.com.tw:3700');
			if($('.order#order .initsetting #foodpanda').val()=='1'){
				download.emit('foodpandajoin',$('.order#order .companydata #story').val());
			}
			else{
			}
			if($('.order#order .initsetting #openubereats').val()=='1'){
				download.emit('ubereatsjoin',$('.order#order .companydata #story').val());
			}
			else{
			}
			if($('.order#order .initsetting #quickclick').val()=='1'){
				download.emit('quickclickjoin',$('.order#order .companydata #story').val());
			}
			else{
			}
			//download.emit('foodpandajoin',$('.order#order .companydata #story').val());
			download.on('foodpanda',function(msg){
				//console.log(msg);
				success_prompt('FoodPanda接單通知！');
				
			});
			download.on('deletefoodpanda',function(msg){
				//console.log(msg);
				success_prompt('FoodPanda作廢單通知！');
				
			});
			download.on('ubereats',function(msg){
				//console.log(msg);
				success_prompt('UberEats接單通知！');
				
			});
			download.on('quickclick',function(msg){
				//console.log(msg);
				if($('.order#order .initsetting #quickclick').val()=='1'&&$('.order#order .initsetting #quickclicklisttype').val()=='1'){//2022/6/1 QuickClick訂單手動接單
					success_prompt('QuickClick新訂單通知！');
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async:false,
						data:{'cmd':'beeper'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					quickclick_listnumberloop();
					if(parseInt($('.webbooking #quickclick .remaining .remainingtable #remainingnumber').html(),10)>0){
						$('.order#order #content #list #funbox #point').css({'background-color':'red','z-index':'3'});
					}
					else{
						$('.order#order #content #list #funbox #point').css({'background-color':'transparent','z-index':'0'});//2022/9/28 若訂單數為0，則不顯示紅點提示
					}
					//$('.order#order #content #list #funbox #player')[0].play();
					if(webbooking.dialog('isOpen')){
						if($('.webbooking #quickclick .listheader #ordercode').html()==''){
							quickclick_loop();
						}
						else{
						}
						//quickclick_listnumberloop();
					}
					else{
						//2022/9/28 若訂單數為0，則不播放提示音
						if(parseInt($('.webbooking #quickclick .remaining .remainingtable #remainingnumber').html(),10)>0){
							$('.order#order #content #list #funbox #player')[0].play();
						}
						else{
						}
					}
				}
				else{
					success_prompt('QuickClick接單通知！');
				}
			});
			download.on('ping',function(){
				//download.emit('rping','3goodnidin');
				//console.log('ping');
			});
			download.on('disconnect',function(){//2020/11/11 server離線
				//console.log('server disconnect');
				if($('.order#order .initsetting #foodpanda').val()=='1'){
					download.emit('foodpandajoin',$('.order#order .companydata #story').val());//重新登入
				}
				else{
				}
				if($('.order#order .initsetting #openubereats').val()=='1'){
					download.emit('ubereatsjoin',$('.order#order .companydata #story').val());//重新登入
				}
				else{
				}
				if($('.order#order .initsetting #quickclick').val()=='1'){
					download.emit('quickclickjoin',$('.order#order .companydata #story').val());//重新登入
				}
				else{
				}
				//download.emit('foodpandajoin',$('.order#order .companydata #story').val());//重新登入
			});
		}
		else{
		}
		socket = io.connect('http://'+$('.order#order .nodejssetting #nodejsip').val()+':'+$('.order#order .nodejssetting #nodejsport').val());
		//socket = io.connect('http://api.tableplus.com.tw:'+$('.order#order .nodejssetting #nodejsport').val());
		socket.emit('join',$('.order#order .companydata #terminalnumber').val());
		socket.on('joinsuccess',function(msg){
			//console.log(msg);
		});
		socket.on('disconnect',function(){//2020/11/11 server離線
			//console.log('server disconnect');
			socket.emit('join',$('.order#order .companydata #terminalnumber').val());//重新登入
		});
		socket.on('ding',function(){
			//console.log('ding');
			//2021/10/1 拉出來是為了確認收到通知的當下是否有訂單
			//$('.order#order #content #list #funbox #player')[0].play();
			if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
			}
			else{
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async:false,
					data:{'cmd':'beeper'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				$('.order#order #content #list #funbox #player')[0].play();
				nidin_listnumberloop();
				$('.order#order #content #list #funbox #point').css({'background-color':'red','z-index':'3'});
				//$('.order#order #content #list #funbox #player')[0].play();
				if(parseInt($('.webbooking #nidin .remaining .remainingtable #remainingnumber').html(),10)>0){
					success_prompt('新訂單通知');
				}
				else{
					success_prompt('退單通知');
				}
				if(webbooking.dialog('isOpen')){
					nidin_loop();
					//nidin_listnumberloop();
				}
				else{
				}
			}
		});
		socket.on('faceid',function(msg){
			$.ajax({
				url:'./lib/api/faceid/check.facedata.php',
				method:'post',
				async:false,
				data:{'machine':'m1','tag':msg},
				dataType:'json',
				success:function(d){
					//console.log(d);
					if(d['state']=='success'){
						if($('.order#order .initsetting #onlinemember').val()==='1'){//2021/3/22 網路會員
							$.ajax({
								url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php',
								method:'post',
								async:false,
								data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','memno':d['tel'],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online success) '+JSON.stringify(d)},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
									if($(window).width()==1920){
										var preitem=7;//???尚未確認
									}
									else if($(window).width()==1366){
										var preitem=8;
									}
									else if($(window).width()==1280){
										var preitem=9;
									}
									else if($(window).width()<=1280&&$(window).width()>1024){
										var preitem=9;
									}
									else{// if($(window).width()==1024)
										var preitem=10;
									}
									if(d=="查無資料庫。"){
										$.ajax({
											url:'./lib/js/getinterfacename.ajax.php',
											method:'post',
											async:false,
											data:{'name':'emptydatabase'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												$('.meminput #memslist #listbox #lists').html(d[0]);
											},
											error:function(e){
												//console.log(e);
												$('.meminput #memslist #listbox #lists').html('查無資料庫。');
											}
										});
										
										$('.meminput #memslist #listbox input[name="allitems"]').val('');
										$('.meminput #memslist #listbox input[name="page"]').val('');
										$('.meminput #memslist #listbox #allresult').html('');
									}
									else if(d.length==0){
										$.ajax({
											url:'./lib/js/getinterfacename.ajax.php',
											method:'post',
											async:false,
											data:{'name':'emptydata'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												$('.meminput #memslist #listbox #lists').html(d[0]);
											},
											error:function(e){
												//console.log(e);
												$('.meminput #memslist #listbox #lists').html('查無資料');
											}
										});
										$('.meminput #memslist #listbox input[name="allitems"]').val('');
										$('.meminput #memslist #listbox input[name="page"]').val('');
										$('.meminput #memslist #listbox #allresult').html('');
									}
									else{
										$('.meminput #memslist #listbox input[name="allitems"]').val(d.length);
										$('.meminput #memslist #listbox input[name="page"]').val('0');
										$('.meminput #memslist #listbox #allresult').html('');
										for(var i=0;i<d.length;i++){
											if(typeof d[i]['point']==="undefined"){
												var mempoint='0';
											}
											else{
												var mempoint=d[i]['point'];
											}
											if(typeof d[i]['money']==="undefined"){
												var memmoney='0';
											}
											else{
												var memmoney=d[i]['money'];
											}
											$('.meminput #memslist #listbox #allresult').append("<input type='hidden' id='"+i+"' value='"+d[i]['memno']+","+d[i]['tel']+","+d[i]['tel2']+","+d[i]['name']+","+d[i]['address']+","+d[i]['setting']+","+mempoint+","+memmoney+","+d[i]['powername']+"'>");
										}
										$('.meminput #memslist #listbox #lists').html('');
										if(parseInt(d.length%preitem)>0){
											if((parseInt(d.length/preitem)+1)==1){
												$('.meminput #memslist #fun #change').prop('disabled',true);
											}
											else{
												$('.meminput #memslist #fun #change').prop('disabled',false);
											}
										}
										else{
											if(parseInt(d.length/preitem)==1){
												$('.meminput #memslist #fun #change').prop('disabled',true);
											}
											else{
												$('.meminput #memslist #fun #change').prop('disabled',false);
											}
										}
										var maxitem=0;
										if(d.length>preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1)){
											maxitem=preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1);
										}
										else{
											maxitem=d.length;
										}
										for(var i=0;i<maxitem;i++){
											if(d[i]['address']==null){
												d[i]['address']='';
											}
											else{
											}
											if(d[i]['tel2']==null){
												d[i]['tel2']='';
											}
											else{
											}
											if(typeof d[i]['point']==="undefined"){
												var mempoint='0';
											}
											else{
												var mempoint=d[i]['point'];
											}
											if(typeof d[i]['money']==="undefined"){
												var memmoney='0';
											}
											else{
												var memmoney=d[i]['money'];
											}
											if(d[i]['address'].match(';php;')){
												var addressarray=d[i]['address'].split(';php;');
												d[i]['address']=addressarray[0];
											}
											else{
											}
											if(typeof d[i]['companynumber']==="undefined"||d[i]['companynumber']==null){
												var companynumber='';
											}
											else{
												var companynumber=d[i]['companynumber'];
											}
											if(typeof d[i]['remark']==="undefined"||d[i]['remark']==null){
												var remark='';
											}
											else{
												var remark=d[i]['remark'];
											}
											$('.meminput #memslist #listbox #lists').append('<div class="memitem" style="width:calc(100% - 10px);margin:10px 5px 0 5px;padding-bottom:5px;border-bottom:1px solid #898989;float:left;"><input type="hidden" name="memno" value="'+d[i]['memno']+'"><input type="hidden" name="address" value="'+d[i]['address']+'"><input type="hidden" name="tel2" value="'+d[i]['tel2']+'"><input type="hidden" name="point" value="'+mempoint+'"><input type="hidden" name="money" value="'+memmoney+'"><input type="hidden" name="powername" value="'+d[i]['powername']+'"><input type="hidden" name="companynumber" value="'+companynumber+'"><input type="hidden" name="remark" value="'+remark+'"><div style="width:calc(100% / 3);float:left;">'+d[i]['tel']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['name']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['setting']+'</div></div>');
										}
									}
									$('.meminput #memtel').val('');
								},
								error:function(e){
									//console.log(e);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online error) '+e},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
							});
						}
						else{//2021/3/22 本地會員
							$.ajax({
								url:'../memberapi/getmemdata.ajax.php',
								method:'post',
								async:false,
								data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','memno':d['tel'],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'../memberapi/getmemdata.ajax.php(offline success) '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
									if($(window).width()==1920){
										var preitem=7;//???尚未確認
									}
									else if($(window).width()==1366){
										var preitem=8;
									}
									else if($(window).width()==1280){
										var preitem=9;
									}
									else if($(window).width()<=1280&&$(window).width()>1024){
										var preitem=9;
									}
									else{// if($(window).width()==1024)
										var preitem=10;
									}
									if(d=="查無資料庫。"){
										$.ajax({
											url:'./lib/js/getinterfacename.ajax.php',
											method:'post',
											async:false,
											data:{'name':'emptydatabase'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												$('.meminput #memslist #listbox #lists').html(d[0]);
											},
											error:function(e){
												//console.log(e);
												$('.meminput #memslist #listbox #lists').html('查無資料庫。');
											}
										});
										
										$('.meminput #memslist #listbox input[name="allitems"]').val('');
										$('.meminput #memslist #listbox input[name="page"]').val('');
										$('.meminput #memslist #listbox #allresult').html('');
									}
									else if(d.length==0){
										$.ajax({
											url:'./lib/js/getinterfacename.ajax.php',
											method:'post',
											async:false,
											data:{'name':'emptydata'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												$('.meminput #memslist #listbox #lists').html(d[0]);
											},
											error:function(e){
												//console.log(e);
												$('.meminput #memslist #listbox #lists').html('查無資料');
											}
										});
										$('.meminput #memslist #listbox input[name="allitems"]').val('');
										$('.meminput #memslist #listbox input[name="page"]').val('');
										$('.meminput #memslist #listbox #allresult').html('');
									}
									else{
										$('.meminput #memslist #listbox input[name="allitems"]').val(d.length);
										$('.meminput #memslist #listbox input[name="page"]').val('0');
										$('.meminput #memslist #listbox #allresult').html('');
										for(var i=0;i<d.length;i++){
											if(typeof d[i]['point']==="undefined"){
												var mempoint='0';
											}
											else{
												var mempoint=d[i]['point'];
											}
											if(typeof d[i]['money']==="undefined"){
												var memmoney='0';
											}
											else{
												var memmoney=d[i]['money'];
											}
											$('.meminput #memslist #listbox #allresult').append("<input type='hidden' id='"+i+"' value='"+d[i]['memno']+","+d[i]['tel']+","+d[i]['tel2']+","+d[i]['name']+","+d[i]['address']+","+d[i]['setting']+","+mempoint+","+memmoney+","+d[i]['powername']+"'>");
										}
										$('.meminput #memslist #listbox #lists').html('');
										if(parseInt(d.length%preitem)>0){
											if((parseInt(d.length/preitem)+1)==1){
												$('.meminput #memslist #fun #change').prop('disabled',true);
											}
											else{
												$('.meminput #memslist #fun #change').prop('disabled',false);
											}
										}
										else{
											if(parseInt(d.length/preitem)==1){
												$('.meminput #memslist #fun #change').prop('disabled',true);
											}
											else{
												$('.meminput #memslist #fun #change').prop('disabled',false);
											}
										}
										var maxitem=0;
										if(d.length>preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1)){
											maxitem=preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1);
										}
										else{
											maxitem=d.length;
										}
										for(var i=0;i<maxitem;i++){
											if(d[i]['address']==null){
												d[i]['address']='';
											}
											else{
											}
											if(d[i]['tel2']==null){
												d[i]['tel2']='';
											}
											else{
											}
											if(typeof d[i]['point']==="undefined"){
												var mempoint='0';
											}
											else{
												var mempoint=d[i]['point'];
											}
											if(typeof d[i]['money']==="undefined"){
												var memmoney='0';
											}
											else{
												var memmoney=d[i]['money'];
											}
											if(d[i]['address'].match(';php;')){
												var addressarray=d[i]['address'].split(';php;');
												d[i]['address']=addressarray[0];
											}
											else{
											}
											if(typeof d[i]['companynumber']==="undefined"||d[i]['companynumber']==null){
												var companynumber='';
											}
											else{
												var companynumber=d[i]['companynumber'];
											}
											if(typeof d[i]['remark']==="undefined"||d[i]['remark']==null){
												var remark='';
											}
											else{
												var remark=d[i]['remark'];
											}
											$('.meminput #memslist #listbox #lists').append('<div class="memitem" style="width:calc(100% - 10px);margin:10px 5px 0 5px;padding-bottom:5px;border-bottom:1px solid #898989;float:left;"><input type="hidden" name="memno" value="'+d[i]['memno']+'"><input type="hidden" name="address" value="'+d[i]['address']+'"><input type="hidden" name="tel2" value="'+d[i]['tel2']+'"><input type="hidden" name="point" value="'+mempoint+'"><input type="hidden" name="money" value="'+memmoney+'"><input type="hidden" name="powername" value="'+d[i]['powername']+'"><input type="hidden" name="companynumber" value="'+companynumber+'"><input type="hidden" name="remark" value="'+remark+'"><div style="width:calc(100% / 3);float:left;">'+d[i]['tel']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['name']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['setting']+'</div></div>');
										}
									}
									$('.meminput #memtel').val('');
								},
								error:function(e){
									//console.log(e);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'../memberapi/getmemdata.ajax.php(offline error) '+e},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
							});
						}
						//console.log(d);
					}
					else{
						//alertmessage('請填入至少兩碼。');
						$('.alertmessage #text').html('請會員再次嘗試臉部識別或填入至少兩碼。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//alertmessage('請填入至少兩碼。');
					$('.alertmessage #text').html('請會員再次嘗試臉部識別或填入至少兩碼。'+e);
					alertmessage.dialog('open');
				}
			});
		});
	}
	else{
		socket=(function(){return;})();//2020/11/2 set typeof as undefined
	}
	/*$(document).on('touchstart','input[type="button"], button',function(){//2020/2/14平面按鈕互動
		$('input[type="button"]').css({'opacity':'1'});
		$('button').css({'opacity':'1'});
		if($(this).prop('disabled')==true){
		}
		else{
			$(this).css({'opacity':'0.5'});
			$(this).css({'box-shadow':'#00000080 2px 2px inset'});
		}
	});
	$(document).on('touchend',function(){//2020/2/14平面按鈕互動
		$('button').css({'opacity':'1'});
		$('input[type="button"]').css({'opacity':'1'});
		$('input[type="button"]').css({'box-shadow':''});
		$('button').css({'box-shadow':''});
	});
	$(document).on('mousedown','input[type="button"], button',function(){//2020/2/14平面按鈕互動
		$('button').css({'opacity':'1'});
		$('input[type="button"]').css({'opacity':'1'});
		if($(this).prop('disabled')==true){
		}
		else{
			$(this).css({'opacity':'0.5'});
			$(this).css({'box-shadow':'#00000080 2px 2px inset'});
		}
	});
	$(document).on('mouseup',function(){//2020/2/14平面按鈕互動
		$('button').css({'opacity':'1'});
		$('input[type="button"]').css({'opacity':'1'});
		$('input[type="button"]').css({'box-shadow':''});
		$('button').css({'box-shadow':''});
	});*/
	if($('.order#order .initsetting #intellapay').val()=='1'&&typeof api_easycard!=="undefined"&&typeof api_easycard==="function"&&$('.order#order .initsetting #easycard').val()=='1'){
		var res='';
		res=api_easycard('SignOn',$('.order#order .companydata #terminalnumber').val());
		res.done(function(res){
			//console.log(res);
			res=JSON.parse(res);
			//console.log(res);
			if(res=='errorinput'){
				//console.log('變數輸入錯誤');
			}
			else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第一次重試
				//res['Data']['Retry']++;
				//res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);
				res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);
				res.done(function(res){
					res=JSON.parse(res);
					//console.log(res);
					if(res=='errorinput'){
						//console.log('變數輸入錯誤');
					}
					else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第二次重試
						//res['Data']['Retry']++;
						//res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);
						res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);
						res.done(function(res){
							res=JSON.parse(res);
							//console.log(res);
							if(res=='errorinput'){
								//console.log('變數輸入錯誤');
							}
							else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第三次重試
								//res['Data']['Retry']++;
								//res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);
								res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);
								res.done(function(res){
									res=JSON.parse(res);
									//console.log(res);
									if(res=='errorinput'){
										//console.log('變數輸入錯誤');
									}
									else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第三次重試錯誤，不再重送
										//res['Data']['Retry']++;
										//res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);
									}
									else{
									}
								});
							}
							else{
							}
						});
					}
					else{
					}
				});
			}
			else{
				//alertmessage('1');
			}
		});
		//console.log('1');
	}
	else{
	}
	$('.result #viewwindow .sendviewwindow').css({'overflow-y':'auto','overflow-x':'hidden'});
	/*禁止縮放螢幕*/
	// chrome 浏览器直接加上下面这个样式就行了，但是ff不识别
	$('body').css('zoom', 'reset');
	$(document).keydown(function (event) {
		if ((event.ctrlKey === true || event.metaKey === true) && (event.which === 61 || event.which === 107 || event.which === 173 || event.which === 109 || event.which === 187  || event.which === 189)){
			event.preventDefault();
		}
	});

	$(window).bind('mousewheel DOMMouseScroll', function (event) {
		if (event.ctrlKey === true || event.metaKey) {
			event.preventDefault();
		}
	});
	/*桌控*/
	if($('.order#order .initsetting #controltable').val()=='1'){
		inittable=$('.control#control .inittable').dialog({
			autoOpen:true,
			width:$(window).width(),
			height:$(window).height(),
			title:'桌控畫面('+$('.control#control #usercode').val()+' '+$('.control#control #username').val()+'；營業日期:'+$('.control#control #bizdate').val()+'；目前班別:'+$('.control#control #zcounter').val()+'；'+$('.control#control #mactype').val().substr(0,1).toUpperCase()+'-'+$('.control#control #'+$('.control#control #mactype').val()+'name').val()+')',
			classes:{
				'ui-dialog-titlebar-close':'hidden'
			},
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false
		});
		changetable=$('.control#control .changetable').dialog({
			autoOpen:false,
			width:$(window).width(),
			height:$(window).height(),
			/*title:'換桌',*/
			resizable:false,
			modal:true,
			draggable:false,
			close:function(){
				$('.changetable #change').prop('disabled',true);
				$('.changetable #change #c1t').html('');
				$('.changetable #change #c2t').html('');
				$('.changetable #c1').val('empty');
				$('.changetable #c1consecnumber').val('');
				$('.changetable #c2').val('empty');
				$('.changetable .tablemap .chtable[id="notempty check"]').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
				$('.changetable .tablemap .chtable[id="notempty check"]').prop('id','notempty');
				$('.changetable .tablemap .chtable#check').css({'border':'','border-radius':'','background-color':'','color':''});
				$('.changetable .tablemap .chtable#check').prop('id','');
			}
		});
		combine=$('.control#control .combine').dialog({
			autoOpen:false,
			width:$(window).width(),
			height:$(window).height(),
			/*title:'合併結帳',*/
			resizable:false,
			modal:true,
			draggable:false,
			close:function(){
				$('.combine .chtable').prop('id','');
				$('.combine .chtable #checkbox').html('');
				$('.combine #sale').prop('disabled',true);
			}
		});
		tablecombine=$('.control#control .tablecombine').dialog({
			autoOpen:false,
			width:$(window).width(),
			height:$(window).height(),
			/*title:'併桌',*/
			resizable:false,
			modal:true,
			draggable:false,
			close:function(){
				$('.tablecombine .chtable').prop('id','');
				$('.tablecombine .chtable #checkbox').html('');
				$('.tablecombine #sale').prop('disabled',true);
			}
		});
		tablesplit=$('.control#control .tablesplit').dialog({
			autoOpen:false,
			width:$(window).width(),
			height:$(window).height(),
			/*title:'拆桌',*/
			resizable:false,
			modal:true,
			draggable:false,
			close:function(){
				$('.tablesplit .chtable').prop('id','');
				$('.tablesplit .chtable #checkbox').html('');
			}
		});
		tableclear=$('.control#control .tableclear').dialog({
			autoOpen:false,
			width:$(window).width(),
			height:$(window).height(),
			/*title:'拆桌',*/
			resizable:false,
			modal:true,
			draggable:false,
			close:function(){
				$('.tableclear .chtable').prop('id','');
				$('.tableclear .chtable #checkbox').html('');
			}
		});
		outsidelist=$('.control#control .outsidelist').dialog({
			autoOpen:false,
			width:500,
			height:$(window).height(),
			/*title:'外帶帳單',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		splittablelist=$('.control#control .splittablelist').dialog({
			autoOpen:false,
			width:500,
			height:$(window).height(),
			/*title:'拆桌帳單',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		conexitsys=$('.control#control .conexitsys').dialog({//系統訊息
			autoOpen:false,
			/*width:450,
			height:300,*/
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		if($(window).width()==1920){
			conexitsys.dialog('option','width',450);
			conexitsys.dialog('option','height',300);
		}
		else{//if($(window).width()==1366)
			conexitsys.dialog('option','width',(450));
			conexitsys.dialog('option','height',(220));
		}
		checkcombine=$('.control#control .checkcombine').dialog({
			autoOpen:false,
			/*width:450,
			height:300,*/
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		if($(window).width()==1920){
			checkcombine.dialog('option','width',450);
			checkcombine.dialog('option','height',400);
		}
		else{//if($(window).width()==1366)
			checkcombine.dialog('option','width',(450));
			checkcombine.dialog('option','height',(400));
		}
		checktablecombine=$('.control#control .checktablecombine').dialog({
			autoOpen:false,
			/*width:450,
			height:300,*/
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		if($(window).width()==1920){
			checktablecombine.dialog('option','width',450);
			checktablecombine.dialog('option','height',400);
		}
		else{//if($(window).width()==1366)
			checktablecombine.dialog('option','width',(450));
			checktablecombine.dialog('option','height',(400));
		}
		checktablesplit=$('.control#control .checktablesplit').dialog({
			autoOpen:false,
			/*width:450,
			height:300,*/
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		if($(window).width()==1920){
			checktablesplit.dialog('option','width',450);
			checktablesplit.dialog('option','height',400);
		}
		else{//if($(window).width()==1366)
			checktablesplit.dialog('option','width',(450));
			checktablesplit.dialog('option','height',(400));
		}
		checktableclear=$('.control#control .checktableclear').dialog({
			autoOpen:false,
			/*width:450,
			height:300,*/
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		if($(window).width()==1920){
			checktableclear.dialog('option','width',450);
			checktableclear.dialog('option','height',200);
		}
		else{//if($(window).width()==1366)
			checktableclear.dialog('option','width',(450));
			checktableclear.dialog('option','height',(200));
		}
		tablehint=$('.control#control .tablehint').dialog({
			autoOpen:false,
			width:450,
			height:500,
			/*title:'時段提示',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		funbox=$('.control#control .funbox').dialog({//功能區
			autoOpen:false,
			width:$(window).width(),
			height:500,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		/*consetchange=$('.control#control .consetchange').dialog({//設定找零金
			autoOpen:false,
			//width:1044,
			//height:966,
			//title:'設定找零金',
			position:{my:'right bottom',at:'right bottom',of:'body'},
			resizable:false,
			modal:true,
			draggable:false,
			close:function(){
				$.ajax({
					url:'./lib/js/setchange.php',
					method:'post',
					data:{'change':$('.consetchange input[name="view"]').val(),'usercode':$('.control#control #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.control#control #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.control#control #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(){
					}
				});
				$('.control#control #MemberBill #billfun #billfun1button').prop('disabled',false);
				$('.control#control #MemberBill #billfun #billfun1button').trigger('click');
				//$billfun.tabs('enable',0);
				//$billfun.tabs('option','active',[0]);
			}
		});
		if($(window).width()==1920){
			consetchange.dialog('option','width',1044);
			consetchange.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			consetchange.dialog('option','width',(1366*0.63-6.4-72.3));
			consetchange.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			consetchange.dialog('option','width',(1280*0.63-72.3));
			consetchange.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			consetchange.dialog('option','width',($(window).width()*0.63-72.3));
			consetchange.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			consetchange.dialog('option','width',1024);
			consetchange.dialog('option','height',(768*0.9-16));
		}*/
		$('.verpsw #cancel').click(function(){
			verpsw.dialog('close');
		});
		$('.inittable #funbox').click(function(){
			funbox.dialog('open');
		});
		$('.changetable #action').css({'margin-top':'1'});
		$('.inittable #changetable').click(function(){
			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control checkopen.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					if(d=='success'){
						//2020/10/22 可能轉由nodejs觸發，先註解
						/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
							url:'./letsreload.controltable.php',
							method:'post',
							async:false,
							//data:{},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});*/
						$('.inittable input[name="window"]').val('changetable');
						changetable.dialog('open');
					}
					else{
						//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
						$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		});
		$('.inittable #conexitsys').click(function(){
			//console.log('1');
			conexitsys.dialog('open');
		});
		$('.conexitsys .no').click(function(){
			conexitsys.dialog('close');
		});
		$('.conexitsys .yes').click(function(){
			/*if($('.control#control #mactype').val()=='submachine'){
				//var mywin=window.open('exit://','','width=1px,height=1px');
			}
			else{
				if($('.control#control #mactype').val()=='machine'&&$('.control#control #'+$('.control#control #mactype').val()+'name').val()!='m1'){
					//var mywin=window.open('exit://','','width=1px,height=1px');
				}
				else{*/
				if($('.order#order .initsetting #posexitmode').length>0&&$('.order#order .initsetting #posexitmode').val()=='2'){
					var mywin=window.open('exit://','','width=1px,height=1px');
				}
				else{
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':$('.order#order .companydata #terminalnumber').val()+'-exit_'+$('.order#order .companydata #terminalnumber').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'control create.cmdtxt.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				/*}
			}*/
		});
		$('.funbox #punch').click(function(){
			$('.order#order #MemberBill #billfun #citybox #billfun3 #punch').trigger('click');
		});
		$('.funbox #logout').click(function(){
			$('.order#order #billfun #billfun3 .logout').trigger('click');
		});
		$('.funbox #updatemenu').click(function(){
			$('.order#order #updatemenu').trigger('click');
		});
		$('.funbox #voidsale').click(function(){
			$('.order#order #billfun #billfun2 #salevoid').trigger('click');
		});
		$('.funbox #kvm').click(function(){
			$('.order#order #MemberBill #billfun #citybox #billfun2 #kvm').trigger('click');
		});
		$('.funbox #historypaper').click(function(){
			$('.order#order #MemberBill #billfun #citybox #billfun3 #historypaper').trigger('click');
		});
		$('.funbox #editpunch').click(function(){
			$('.order#order #MemberBill #billfun #citybox #billfun3 #editpunch').trigger('click');
		});
		$('.funbox #salelist').click(function(){
			$('.order#order #billfun #billfun2 #salelist').trigger('click');
		});
		$('.funbox #AE').click(function(){
			$('.order#order #billfun #billfun2 .outmoney').trigger('click');
		});
		$('.inittable .tablemap .table').click(function(){
			var index=$('.inittable .tablemap button').index(this);
			var tabnum=$(this).find('#tablenumber input[name="tabnum"]').val();
			if($('.inittable .tablemap button:eq('+index+')[name="split"]').length>0){
				$.ajax({
					url:'./getsplittablelist.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':tabnum},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(typeof d['lasttablenumber']==="undefined"){
							$('.splittablelist').html('<button id="splittablebut" value="'+$('.inittable button:eq('+index+')[name="split"] #tablenumber input[name="tabnum"]').val()+'">拆桌</button>');
						}
						else{
							$('.splittablelist').html('<button id="splittablebut" value="'+d['lasttablenumber']+'">拆桌</button>');
						}
						$.each(d,function(index,value){
							if(index=='time'||index=='lasttablenumber'){
								return false;
							}
							else{
								$('.splittablelist').append('<button><div id="tablenum">'+value['tablename']+'<input type="hidden" name="tablenumber" value="'+value['tablenumber']+'"><input type="hidden" name="state" value="'+value['state']+'"></div><div id="consecnumber">'+index+'</div><div id="bizdate">'+value['bizdate']+'</div></button>');
							}
						});
					},
					error:function(e){
						//console.log(e);
					}
				});
				splittablelist.dialog('open');
			}
			else{
				$.ajax({
					url:'./checktableini.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':tabnum,'submachine':$('.control#control #submachinename').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'type':'in'},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var tempd=d.split('-');
						if(tempd[0]=='lock'){
							var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
							if(res==true){
								$.ajax({
									url:'./mandchange.ajax.php',
									method:'post',
									async:false,
									data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':tabnum,'submachine':$('.control#control #submachinename').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'type':'in'},
									dataType:'html',
									success:function(d){
										if($('.inittable .tablemap button:eq('+index+') input[name="consecnumber"]').val().length>0&&$('.inittable .tablemap button:eq('+index+') input[name="bizdate"]').val().length>0){
											inittable.dialog('close');
											temporder($('.inittable button:eq('+index+') input[name="bizdate"]').val(),$('.inittable button:eq('+index+') input[name="consecnumber"]').val(),$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());

											//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&';
										}
										else{
											inittable.dialog('close');
											ClearWindow($('.inittable button:eq('+index+') input[name="tabnum"]').val(),'1');
											if(tabinput.dialog('isOpen')){
												tabinput.dialog('close');
											}
											else{
											}
											if($('#tablenumber .tabnumbox').length>0){
												$('#tablenumber .tabnumbox').html($('.inittable button:eq('+index+') input[name="tabnum"]').val());
											}
											else{
											}

											//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&username=<?php if(isset($_GET["username"]))echo $_GET["username"]; ?>&listtype=1&tabnum='+$('.control#control button:eq('+index+') input[name="tabnum"]').val();
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
						}
						else{
							if($('.inittable .tablemap button:eq('+index+') input[name="state"]').val()!='0'&&$('.inittable .tablemap button:eq('+index+') input[name="consecnumber"]').val().length>0&&$('.inittable .tablemap button:eq('+index+') input[name="bizdate"]').val().length>0){
								inittable.dialog('close');
								temporder($('.inittable button:eq('+index+') input[name="bizdate"]').val(),$('.inittable button:eq('+index+') input[name="consecnumber"]').val(),$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());

								//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&username=<?php if(isset($_GET["username"]))echo $_GET["username"]; ?>&listtype=1&tabnum&bizdate='+$('.control#control button:eq('+index+') input[name="bizdate"]').val()+'&consecnumber='+$('.control#control button:eq('+index+') input[name="consecnumber"]').val();
							}
							else{
								inittable.dialog('close');
								$.ajax({
									url:'./lib/js/get.combinetablenumber.php',
									method:'post',
									async:false,
									data:{'tablenumber':tabnum,'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
									dataType:'json',//2020/3/20 html >> json 原本只傳送桌號，因為桌號改為對應方式，需要多傳送桌號名稱
									success:function(d){
										console.log(d);
										ClearWindow(d[0],'1');
										if(tabinput.dialog('isOpen')){
											tabinput.dialog('close');
										}
										else{
										}
										if($('#tablenumber .tabnumbox').length>0){
											if(typeof d[1]!=="undefined"&&d[1]!=''){
												$('#tablenumber .tabnumbox').html(d[1]);
											}
											else{
												$('#tablenumber .tabnumbox').html(d[0]);
											}
										}
										else{
										}
									},
									error:function(e){
										//console.log(e);
									}
								});

								//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&username=<?php if(isset($_GET["username"]))echo $_GET["username"]; ?>&listtype=1&tabnum='+$('.control#control button:eq('+index+') input[name="tabnum"]').val();
							}
						}
					},
					error:function(e){
						//console.log(d);
					}
				});
			}
		});
		$(document).on('click','.funcmap .table',function(event){
			//oneEvent(event);
			var index=$('.inittable button').index(this);
			if($('.inittable button:eq('+index+') input[name="tabnum"]').val()=="outside"){
				$.ajax({
					url:'./getoutlist.ajax.php',
					method:'post',
					data:{'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
					dataType:'json',
					success:function(d){
						$.ajax({
							url:'./lib/js/getbuttonname.ajax.php',
							method:'post',
							async:false,
							data:{'name':'listtype2'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d[0]==''){
									$('.outsidelist').html('<button id="newlist">新增外帶單</button>');
								}
								else{
									$('.outsidelist').html('<button id="newlist">新增'+d[0]+'單</button>');
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
						$.each(d,function(index,value){
							if(index=='time'){
								return false;
							}
							else{
								$('.outsidelist').append('<button><div id="consecnumber">'+index+'</div><div id="bizdate">'+value+'</div></button>');
							}
						});
					},
					error:function(e){
						//console.log(e);
					}
				});
				outsidelist.dialog('open');
			}
			else{
			}
		});
		$(document).on('click','.outsidelist button',function(event){
			//oneEvent(event);
			var index=$('.outsidelist button').index(this);
			if($(this).prop('id')=='newlist'){
				outsidelist.dialog('close');
				inittable.dialog('close');
				ClearWindow('','2');

				//location.href='./order.php?'+$('.control#control #mactype').val()+'='+$('.control#control #'+$('.control#control #mactype').val()+'name').val()+'&usercode='+$('.control#control #usercode').val()+'&username='+$('.control#control #username').val()+'&listtype=2';
			}
			else{
				outsidelist.dialog('close');
				inittable.dialog('close');
				temporder($('.outsidelist button:eq('+index+') #bizdate').html(),$('.outsidelist button:eq('+index+') #consecnumber').html(),$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());
				
				//location.href='./order.php?'+$('.control#control #mactype').val()+'='+$('.control#control #'+$('.control#control #mactype').val()+'name').val()+'&usercode='+$('.control#control #usercode').val()+'&username='+$('.control#control #username').val()+'&listtype=2&bizdate='+$('.outsidelist button:eq('+index+') #bizdate').html()+'&consecnumber='+$('.outsidelist button:eq('+index+') #consecnumber').html();
			}
		});
		$(document).on('click','.splittablelist button',function(event){
			//oneEvent(event);
			if(tablesplit.dialog('isOpen')){
				if($(this).prop('id')=='splittablebut'){
					$.ajax({
						url:'./gettablelist.ajax.php',
						method:'post',
						data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tablenum':$(this).val()},
						dataType:'html',
						success:function(d){
							if(d=="目前點選之桌號已併桌，無法進行拆桌動作。"){
								$('.checktablesplit #text').html(d);
								$('.checktablesplit #sale').prop('disabled',true);
								checktablesplit.dialog('open');
							}
							else{
								$('.checktablesplit #text').html(d);
								$('.checktablesplit #sale').prop('disabled',false);
								checktablesplit.dialog('open');
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					var index=$(this).index('.splittablelist button');
					$.ajax({
						url:'./checktableini.ajax.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':$('.splittablelist button:eq('+index+') #tablenum input[name="tablenumber"]').val(),'submachine':$('.control#control #submachinename').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'type':'in'},
						dataType:'html',
						success:function(d){
							//console.log(d);
							var tempd=d.split('-');
							if(tempd[0]=='lock'){
								var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
								if(res==true){
									$.ajax({
										url:'./mandchange.ajax.php',
										method:'post',
										async:false,
										data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':tabnum,'submachine':$('.control#control #submachinename').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'type':'in'},
										dataType:'html',
										success:function(d){
											splittablelist.dialog('close');
											inittable.dialog('close');
											temporder($('.splittablelist button:eq('+index+') #bizdate').html(),$('.splittablelist button:eq('+index+') #consecnumber').html(),$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());
											
											//location.href='./order.php?'+$('.control#control #mactype').val()+'='+$('.control#control #'+$('.control#control #mactype').val()+'name').val()+'&usercode='+$('.control#control #usercode').val()+'&username='+$('.control#control #username').val()+'&listtype=1&bizdate='+$('.splittablelist button:eq('+index+') #bizdate').html()+'&consecnumber='+$('.splittablelist button:eq('+index+') #consecnumber').html()+'&tabnum='+$('.splittablelist button:eq('+index+') #tablenum').html();
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
							}
							else if(tempd[0]=='empty'){//結帳後不清桌控
								splittablelist.dialog('close');
								inittable.dialog('close');
								ClearWindow($('.splittablelist button:eq('+index+') #tablenum input[name="tablenumber"]').val(),'1');
								$('#tablenumber .tabnumbox').html($('.splittablelist button:eq('+index+') #tablenum input[name="tablenumber"]').val());
							}
							else{
								splittablelist.dialog('close');
								inittable.dialog('close');
								temporder($('.splittablelist button:eq('+index+') #bizdate').html(),$('.splittablelist button:eq('+index+') #consecnumber').html(),$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());
								
								//location.href='./order.php?'+$('.control#control #mactype').val()+'='+$('.control#control #'+$('.control#control #mactype').val()+'name').val()+'&usercode='+$('.control#control #usercode').val()+'&username='+$('.control#control #username').val()+'&listtype=1&bizdate='+$('.splittablelist button:eq('+index+') #bizdate').html()+'&consecnumber='+$('.splittablelist button:eq('+index+') #consecnumber').html()+'&tabnum='+$('.splittablelist button:eq('+index+') #tablenum').html();
							}
						},
						error:function(e){
							//console.log(d);
						}
					});
				}
			}
			else if(tableclear.dialog('isOpen')){
				$.ajax({
					url:'./gettableclear.ajax.php',
					method:'post',
					data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tablenum':$(this).find('input[name="tablenumber"]').val(),'state':$(this).find('input[name="state"]').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
					dataType:'html',
					success:function(d){
						$('.checktableclear #text').html(d);
						$('.checktableclear #sale').prop('disabled',false);
						checktableclear.dialog('open');
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
				if($(this).prop('id')=='splittablebut'){
					$.ajax({
						url:'./gettablelist.ajax.php',
						method:'post',
						data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tablenum':$(this).val()},
						dataType:'html',
						success:function(d){
							if(d=="目前點選之桌號已併桌，無法進行拆桌動作。"){
								$('.checktablesplit #text').html(d);
								$('.checktablesplit #sale').prop('disabled',true);
								checktablesplit.dialog('open');
							}
							else{
								$('.checktablesplit #text').html(d);
								$('.checktablesplit #sale').prop('disabled',false);
								checktablesplit.dialog('open');
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					var index=$(this).index('.splittablelist button');
					$.ajax({
						url:'./checktableini.ajax.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':$('.splittablelist button:eq('+index+') #tablenum input[name="tablenumber"]').val(),'submachine':$('.control#control #submachinename').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'type':'in'},
						dataType:'html',
						success:function(d){
							//console.log(d);
							var tempd=d.split('-');
							if(tempd[0]=='lock'){
								var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
								if(res==true){
									$.ajax({
										url:'./mandchange.ajax.php',
										method:'post',
										async:false,
										data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':tabnum,'submachine':$('.control#control #submachinename').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'type':'in'},
										dataType:'html',
										success:function(d){
											splittablelist.dialog('close');
											inittable.dialog('close');
											temporder($('.splittablelist button:eq('+index+') #bizdate').html(),$('.splittablelist button:eq('+index+') #consecnumber').html(),$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());
											
											//location.href='./order.php?'+$('.control#control #mactype').val()+'='+$('.control#control #'+$('.control#control #mactype').val()+'name').val()+'&usercode='+$('.control#control #usercode').val()+'&username='+$('.control#control #username').val()+'&listtype=1&bizdate='+$('.splittablelist button:eq('+index+') #bizdate').html()+'&consecnumber='+$('.splittablelist button:eq('+index+') #consecnumber').html()+'&tabnum='+$('.splittablelist button:eq('+index+') #tablenum').html();
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
							}
							else if(tempd[0]=='empty'){//結帳後不清桌控
								splittablelist.dialog('close');
								inittable.dialog('close');
								ClearWindow($('.splittablelist button:eq('+index+') #tablenum input[name="tablenumber"]').val(),'1');
								$('#tablenumber .tabnumbox').html($('.splittablelist button:eq('+index+') #tablenum input[name="tablenumber"]').val());
							}
							else{
								splittablelist.dialog('close');
								inittable.dialog('close');
								temporder($('.splittablelist button:eq('+index+') #bizdate').html(),$('.splittablelist button:eq('+index+') #consecnumber').html(),$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());
								
								//location.href='./order.php?'+$('.control#control #mactype').val()+'='+$('.control#control #'+$('.control#control #mactype').val()+'name').val()+'&usercode='+$('.control#control #usercode').val()+'&username='+$('.control#control #username').val()+'&listtype=1&bizdate='+$('.splittablelist button:eq('+index+') #bizdate').html()+'&consecnumber='+$('.splittablelist button:eq('+index+') #consecnumber').html()+'&tabnum='+$('.splittablelist button:eq('+index+') #tablenum').html();
							}
						},
						error:function(e){
							//console.log(d);
						}
					});
				}
			}
		});
		$('.changetable .tablemap .chtable').click(function(){
			//console.log($(this).find('#tablenumber input[name="tabnum"]').val());
			if($(this).find('#tablenumber input[name="consecnumber"]').val()==''){
				if($('.changetable #c2').val()=='empty'){
					$('.changetable #c2').val($(this).find('#tablenumber input[name="tabnum"]').val());
					$(this).prop('id','check');
					$(this).css({'border':'5px solid #898989','border-radius':'5px','background-color':'#00ff66','color':'#ffffff'});
					var temptable=$(this).find('#tablenumber').html().split('<input');
					$('.changetable #change #c2t').html(temptable[0]);
				}
				else{
					if($('.changetable #c2').val()==$(this).find('#tablenumber input[name="tabnum"]').val()){
						$('.changetable #c2').val('empty');
						$(this).prop('id','');
						$(this).css({'border':'','border-radius':'','background-color':'','color':''});
						$('.changetable #change #c2t').html('');
					}
					else{
					}
				}
			}
			else{
				if($('.changetable #c1').val()=='empty'){
					$('.changetable #c1').val($(this).find('#tablenumber input[name="tabnum"]').val());
					$('.changetable #c1consecnumber').val($(this).find('#tablenumber input[name="consecnumber"]').val());
					$(this).prop('id','notempty check');
					$(this).css({'border':'5px solid #898989','border-radius':'5px','background-color':'#00ffff','color':'#ffffff'});
					var temptable=$(this).find('#tablenumber').html().split('<input');
					$('.changetable #change #c1t').html(temptable[0]);
				}
				else{
					if($('.changetable #c1').val()==$(this).find('#tablenumber input[name="tabnum"]').val()){
						$('.changetable #c1').val('empty');
						$('.changetable #c1consecnumber').val('');
						$(this).prop('id','notempty');
						$(this).css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
						$('.changetable #change #c1t').html('');
					}
					else{
					}
				}
			}
			if($('.changetable #change #c1t').html()==''||$('.changetable #change #c2t').html()==''){
				$('.changetable #change').prop('disabled',true);
			}
			else{
				$('.changetable #change').prop('disabled',false);
			}
		});
		$('.changetable .funcmap #return').click(function(){
			$('.inittable input[name="window"]').val('inittable');
			changetable.dialog('close');
		});
		$('.changetable .funcmap #change').click(function(){
			if($('.control#control .chnagetable #c1').val()=='empty'||$('.control#control .chnagetable #c2').val()=='empty'){
			}
			else{
				$('.changetable .funcmap #change').prop('disabled',true);
				$.ajax({
					url:'./lib/js/changetable.ajax.php',
					method:'post',
					data:{'c1':$('.changetable #c1').val(),'c1consecnumber':$('.changetable #c1consecnumber').val(),'c2':$('.changetable #c2').val(),'c2consecnumber':$('.changetable #c2consecnumber').val(),'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'control changetable.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
						$('.inittable input[name="window"]').val('inittable');
						$('.changetable .funcmap #change').prop('disabled',false);
						changetable.dialog('close');
						//location.reload();
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			//2020/10/22 可能轉由nodejs觸發，先註解
			/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
				url:'./letsreload.controltable.php',
				method:'post',
				async:false,
				//data:{},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		});
		$('.funbox #open').click(function(){
			$('.funbox button').prop('disabled',true);
			$('.order#order #billfun #billfun2 .open').trigger('click');
		});
		$('.funbox #close').click(function(){
			$('.funbox button').prop('disabled',true);
			$('.order#order #billfun #billfun2 .close').trigger('click');
		});
		$('.inittable #cashdrawer').click(function(){
			$('.order#order #billfun1 button:eq(2)').trigger('click');
		});
		$('.inittable #combine').click(function(){
			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control checkopen.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					if(d=='success'){
						//2020/10/22 可能轉由nodejs觸發，先註解
						/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
							url:'./letsreload.controltable.php',
							method:'post',
							async:false,
							//data:{},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});*/
						$('.inittable input[name="window"]').val('combine');
						combine.dialog('open');
					}
					else{
						//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
						$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		});
		$('.inittable #tablecombine').click(function(){
			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control checkopen.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					if(d=='success'){
						//2020/10/22 可能轉由nodejs觸發，先註解
						/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
							url:'./letsreload.controltable.php',
							method:'post',
							async:false,
							//data:{},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});*/
						$('.inittable input[name="window"]').val('tablecombine');
						tablecombine.dialog('open');
					}
					else{
						//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
						$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		});
		$('.inittable #tablesplit').click(function(){
			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control checkopen.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					if(d=='success'){
						//2020/10/22 可能轉由nodejs觸發，先註解
						/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
							url:'./letsreload.controltable.php',
							method:'post',
							async:false,
							//data:{},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});*/
						$('.inittable input[name="window"]').val('tablesplit');
						tablesplit.dialog('open');
					}
					else{
						//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
						$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		});
		$('.inittable #tableclear').click(function(){
			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control checkopen.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					if(d=='success'){
						//2020/10/22 可能轉由nodejs觸發，先註解
						/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
							url:'./letsreload.controltable.php',
							method:'post',
							async:false,
							//data:{},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});*/
						$('.inittable input[name="window"]').val('tableclear');
						tableclear.dialog('open');
					}
					else{
						//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
						$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		});
		$('.funbox #tablehint').click(function(){
			$.ajax({
				url:'./gettimelist.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
				dataType:'html',
				success:function(d){
					$('.tablehint #timelist').html(d);
					tablehint.dialog('open');
				},
				errpr:function(e){
					//console.log(e);
				}
			});
			//console.log('1');
		});
		$('.tablehint #cancel').click(function(){
			$('.tablehint #tiemlist').html('');
			tablehint.dialog('close');
		});
		$(document).on('click','.combine .chtable#notempty',function(event){
			//oneEvent(event);
			$(this).prop('id','check');
			$(this).find('#checkbox').html('✔');
			$.ajax({
				url:'./lib/js/getcombinelist.ajax.php',
				method:'post',
				async:false,
				data:{'consecnumber':$(this).find('input[name="consecnumber"]').val(),'tablenumber':$(this).find('input[name="tabnum"]').val(),'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					if(d.match(/,/g)){
						var temp=d.split(/,/g);
						for(var i=0;i<temp.length;i++){
							$('.combine .tablemap #t:eq('+(Number(temp[i])-1)+') .chtable').prop('id','check');
							$('.combine .tablemap #t:eq('+(Number(temp[i])-1)+') .chtable').find('#checkbox').html('✔');
						}
					}
					else if(d==''){
					}
					else{
						//console.log($('.combine .tablemap #t:eq('+(Number(d)-1)+') .chtable #tablenumber input[name="tabnum"]').val());
						$('.combine .tablemap #t:eq('+(Number(d)-1)+') .chtable').prop('id','check');
						$('.combine .tablemap #t:eq('+(Number(d)-1)+') .chtable #checkbox').html('✔');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.combine #check').length>=2){
				$('.combine #sale').prop('disabled',false);
			}
			else{
				$('.combine #sale').prop('disabled',true);
			}
		});
		$(document).on('click','.tablecombine .chtable',function(event){
			//oneEvent(event);
			if($(this).prop('id')=='notempty'){
				if($('.tablecombine .chtable#check').length>0){
				}
				else{
					$(this).prop('id','check');
					$(this).find('#checkbox').html('✔');
					var chnum=Number($('.tablecombine #check').length)+Number($('.tablecombine #oncheck').length);
					if(Number(chnum)>=2){
						$('.tablecombine #sale').prop('disabled',false);
					}
					else{
						$('.tablecombine #sale').prop('disabled',true);
					}
				}
			}
			else if($(this).prop('id')=='check'){
				$(this).prop('id','notempty');
				$(this).find('#checkbox').html('');
				var chnum=Number($('.tablecombine #check').length)+Number($('.tablecombine #oncheck').length);
				if(Number(chnum)>=2){
					$('.tablecombine #sale').prop('disabled',false);
				}
				else{
					$('.tablecombine #sale').prop('disabled',true);
				}
			}
			else if($(this).prop('id')=='oncheck'){
				$(this).prop('id','');
				$(this).find('#checkbox').html('');
				var chnum=Number($('.tablecombine #check').length)+Number($('.tablecombine #oncheck').length);
				if(Number(chnum)>=2){
					$('.tablecombine #sale').prop('disabled',false);
				}
				else{
					$('.tablecombine #sale').prop('disabled',true);
				}
			}
			else if($(this).prop('id')==''){
				$(this).prop('id','oncheck');
				$(this).find('#checkbox').html('✔');
				var chnum=Number($('.tablecombine #check').length)+Number($('.tablecombine #oncheck').length);
				if(Number(chnum)>=2){
					$('.tablecombine #sale').prop('disabled',false);
				}
				else{
					$('.tablecombine #sale').prop('disabled',true);
				}
			}
			//console.log(chnum);
		});
		$(document).on('click','.tablesplit .chtable#notempty',function(event){
			//oneEvent(event);
			$.ajax({
				url:'./gettablelist.ajax.php',
				method:'post',
				data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tablenum':$(this).find('#tablenumber input[name="tabnum"]').val()},
				dataType:'html',
				success:function(d){
					if(d=="目前點選之桌號已併桌，無法進行拆桌動作。"){
						$('.checktablesplit #text').html(d);
						$('.checktablesplit #sale').prop('disabled',true);
						checktablesplit.dialog('open');
					}
					else{
						$('.checktablesplit #text').html(d);
						$('.checktablesplit #sale').prop('disabled',false);
						checktablesplit.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		});
		$(document).on('click','.tableclear .chtable#notempty',function(event){
			//oneEvent(event);
			var index=$('.tableclear .tablemap button').index(this);
			var tabnum=$(this).find('#tablenumber input[name="tabnum"]').val();
			if($('.tableclear .tablemap button:eq('+index+') input[name="split"]').length>0&&$('.tableclear .tablemap button:eq('+index+') input[name="split"]').val()>1){
				$.ajax({
					url:'./getsplittablelist.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tabnum':tabnum},
					dataType:'json',
					success:function(d){
						//console.log(d);
						$('.splittablelist').html('');
						$.each(d,function(index,value){
							if(index=='time'||index=='lasttablenumber'){
								return false;
							}
							else{
								$('.splittablelist').append('<button><div id="tablenum">'+value['tablename']+'<input type="hidden" name="tablenumber" value="'+value['tablenumber']+'"><input type="hidden" name="state" value="'+value['state']+'"></div><div id="consecnumber">'+index+'</div><div id="bizdate">'+value['bizdate']+'</div></button>');
							}
						});
					},
					error:function(e){
						//console.log(e);
					}
				});
				splittablelist.dialog('open');
			}
			else{
				$.ajax({
					url:'./gettableclear.ajax.php',
					method:'post',
					data:{'bizdate':$('.control#control #bizdate').val(),'zcounter':$('.control#control #zcounter').val(),'tablenum':$(this).find('#tablenumber input[name="tabnum"]').val(),'state':$(this).find('#tablenumber input[name="state"]').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
					dataType:'html',
					success:function(d){
						$('.checktableclear #text').html(d);
						$('.checktableclear #sale').prop('disabled',false);
						checktableclear.dialog('open');
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
		});
		$(document).on('click','.combine .chtable#check',function(event){
			//oneEvent(event);
			$(this).prop('id','notempty');
			$(this).find('#checkbox').html('');
			$.ajax({
				url:'./lib/js/getcombinelist.ajax.php',
				method:'post',
				async:false,
				data:{'consecnumber':$(this).find('input[name="consecnumber"]').val(),'tablenumber':$(this).find('input[name="tabnum"]').val(),'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					if(d.match(/,/g)){
						var temp=d.split(/,/g);
						for(var i=0;i<temp.length;i++){
							$('.combine .tablemap #t:eq('+(Number(temp[i])-1)+') .chtable').prop('id','notempty');
							$('.combine .tablemap #t:eq('+(Number(temp[i])-1)+') .chtable').find('#checkbox').html('');
						}
					}
					else if(d==''){
					}
					else{
						//console.log($('.combine .tablemap #t:eq('+(Number(d)-1)+') .chtable #tablenumber input[name="tabnum"]').val());
						$('.combine .tablemap #t:eq('+(Number(d)-1)+') .chtable').prop('id','notempty');
						$('.combine .tablemap #t:eq('+(Number(d)-1)+') .chtable #checkbox').html('');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.combine #check').length>=2){
				$('.combine #sale').prop('disabled',false);
			}
			else{
				$('.combine #sale').prop('disabled',true);
			}
		});
		$('.combine #sale').click(function(){
			var tt='';
			var tabname='';
			var tconsecnumber='';
			var tabnum=$('.combine #check:eq(0) #tablenumber input[name="tabnum"]').val();
			for(var i=0;i<$('.combine #check').length;i++){
				if(tt==''){
					var temp=$('.combine #check:eq('+i+') #tablenumber').html().split('<input');
					tabname=temp[0];
					tt=$('.combine #check:eq('+i+') #tablenumber input[name="tabnum"]').val();
					tconsecnumber=$('.combine #check:eq('+i+') #tablenumber input[name="consecnumber"]').val();
				}
				else{
					var temp=$('.combine #check:eq('+i+') #tablenumber').html().split('<input');
					tabname=tabname+','+temp[0];
					tt=tt+','+$('.combine #check:eq('+i+') #tablenumber input[name="tabnum"]').val();
					tconsecnumber=tconsecnumber+','+$('.combine #check:eq('+i+') #tablenumber input[name="consecnumber"]').val();
				}
			}
			$('.checkcombine #text').html('');
			$('.checkcombine #text').append('合併結帳之桌號：'+tabname);
			$('.checkcombine #text').append('<input type="hidden" name="consecnumbers" value="'+tconsecnumber+'">');
			$('.checkcombine #text').append('<input type="hidden" name="tabnum" value="'+tabnum+'">');
			$('.checkcombine #text').append('<input type="hidden" name="tabini" value="'+tt+'">');
			checkcombine.dialog('open');
		});
		$('.tablecombine #sale').click(function(){
			var tt='';
			var tabname='';
			if($('.tablecombine #check').length>0){
				var consecnumber=$('.tablecombine #check:eq(0) #tablenumber input[name="consecnumber"]').val();
			}
			else{
				var consecnumber='';
			}
			for(var i=0;i<$('.tablecombine .chtable').length;i++){
				if($('.tablecombine .chtable:eq('+i+')').prop('id')=='oncheck'||$('.tablecombine .chtable:eq('+i+')').prop('id')=='check'){
					if(tt==''){
						var temp=$('.tablecombine .chtable:eq('+i+') #tablenumber').html().split('<input');
						tabname=temp[0];
						tt=$('.tablecombine .chtable:eq('+i+') #tablenumber input[name="tabnum"]').val();
						tconsecnumber=$('.tablecombine .chtable:eq('+i+') #tablenumber input[name="consecnumber"]').val();
					}
					else{
						if($('.tablecombine .chtable:eq('+i+') #tablenumber input[name="consecnumber"]').val()!=''){
							var temp=$('.tablecombine .chtable:eq('+i+') #tablenumber').html().split('<input');
							tabname=temp[0]+','+tabname;
							tt=$('.tablecombine .chtable:eq('+i+') #tablenumber input[name="tabnum"]').val()+','+tt;
							tconsecnumber=$('.tablecombine .chtable:eq('+i+') #tablenumber input[name="consecnumber"]').val()+','+tconsecnumber;
						}
						else{
							var temp=$('.tablecombine .chtable:eq('+i+') #tablenumber').html().split('<input');
							tabname=tabname+','+temp[0];
							tt=tt+','+$('.tablecombine .chtable:eq('+i+') #tablenumber input[name="tabnum"]').val();
							tconsecnumber=tconsecnumber+','+$('.tablecombine .chtable:eq('+i+') #tablenumber input[name="consecnumber"]').val();
						}
					}
				}
				else{
				}
			}
			$('.checktablecombine #text').html('');
			$('.checktablecombine #text').append('欲併桌之桌號：'+tabname);
			$('.checktablecombine #text').append('<input type="hidden" name="consecnumbers" value="'+consecnumber+'">');
			$('.checktablecombine #text').append('<input type="hidden" name="tabnum" value="'+tt+'">');
			checktablecombine.dialog('open');
		});
		$('.checkcombine #cancel').click(function(){
			$('.checkcombine #text').html('');
			checkcombine.dialog('close');
		});
		$('.checktablecombine #cancel').click(function(){
			$('.checktablecombine #text').html('');
			checktablecombine.dialog('close');
		});
		$('.checktablesplit #cancel').click(function(){
			$('.checktablesplit #text').html('');
			$('.checktablesplit #sale').prop('disabled',false);
			checktablesplit.dialog('close');
		});
		$('.checktableclear #cancel').click(function(){
			$('.checktableclear #text').html('');
			$('.checktableclear #sale').prop('disabled',false);
			checktableclear.dialog('close');
		});
		$('.checkcombine #sale').click(function(){
			$('.checkcombine #sale').prop('disabled',true);
			$.ajax({
				url:'./combinelist.php',
				method:'post',
				async:false,
				data:{'usercode':$('.control#control #usercode').val(),'username':$('.control#control #username').val(),'consecnumbers':$('.checkcombine #text input[name="consecnumbers"]').val(),'tabnum':$('.checkcombine #text input[name="tabnum"]').val(),'tabini':$('.checkcombine #text input[name="tabini"]').val(),'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control combinelist.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					var t=d.split(',');
					checkcombine.dialog('close');
					$('.checkcombine #sale').prop('disabled',false);
					
					combine.dialog('close');
					$('.inittable input[name="window"]').val('inittable');
					inittable.dialog('close');
					temporder(t[0],t[1],$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());

					//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&username=<?php if(isset($_GET["username"]))echo $_GET["username"]; ?>&listtype=1&tabnum&bizdate='+t[0]+'&consecnumber='+t[1];
				},
				error:function(e){
					//console.log(e);
				}
			});
			//2020/10/22 可能轉由nodejs觸發，先註解
			/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
				url:'./letsreload.controltable.php',
				method:'post',
				async:false,
				//data:{},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		});
		$('.checktablecombine #sale').click(function(){
			$('.checktablecombine #sale').prop('disabled',true);
			var tablenumber=$('.checktablecombine #text input[name="tabnum"]').val();
			var consecnumber=$('.checktablecombine #text input[name="consecnumbers"]').val();
			$.ajax({
				url:'./combinetablelist.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'usercode':$('.control#control #usercode').val(),'username':$('.control#control #username').val(),'consecnumber':consecnumber,'tabnum':tablenumber},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control combinetablelist.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					var t=d.split(',');
					checktablecombine.dialog('close');
					$('.checktablecombine #sale').prop('disabled',false);
					
					tablecombine.dialog('close');
					$('.inittable input[name="window"]').val('inittable');
					inittable.dialog('close');
					$.ajax({
						url:'./lib/js/checktablesale.ajax.php',
						method:'post',
						async:false,
						data:{'consecnumber':consecnumber,'tablenumber':tablenumber,'machine':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							if(d=='exists'){
								temporder(t[0],t[1],$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());
							}
							else{//d=='empty'
								ClearWindow(tablenumber,'1');
								if(tabinput.dialog('isOpen')){
									tabinput.dialog('close');
								}
								else{
								}
								if($('#tablenumber .tabnumbox').length>0){
									$('#tablenumber .tabnumbox').html(tablenumber);
								}
								else{
								}
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					

					//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&username=<?php if(isset($_GET["username"]))echo $_GET["username"]; ?>&listtype=1&tabnum&bizdate='+t[0]+'&consecnumber='+t[1];
				},
				error:function(e){
					//console.log(e);
				}
			});
			//2020/10/22 可能轉由nodejs觸發，先註解
			/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
				url:'./letsreload.controltable.php',
				method:'post',
				async:false,
				//data:{},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		});
		$('.checktablesplit #sale').click(function(){
			$('.checktablesplit #sale').prop('disabled',true);//拆單－新增帳單
			$.ajax({
				url:'./splittable.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val(),'usercode':$('.control#control #usercode').val(),'username':$('.control#control #username').val(),'tabnum':$('.checktablesplit #text input[name="lastnum"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'control splittable.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					var t=d.split(',');
					checktablesplit.dialog('close');
					$('.checktablesplit #sale').prop('disabled',false);
					splittablelist.dialog('close');
					tablesplit.dialog('close');
					$('.inittable input[name="window"]').val('inittable');
					inittable.dialog('close');
					temporder(t[0],t[1],$('.control#control #'+$('.control#control #mactype').val()+'name').val(),$('.order#order .companydata #company').val(),$('.control#control #usercode').val(),$('.control#control #username').val());

					//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&username=<?php if(isset($_GET["username"]))echo $_GET["username"]; ?>&listtype=1&tabnum='+t[2]+'&bizdate='+t[0]+'&consecnumber='+t[1];
				},
				error:function(e){
					//console.log(e);
				}
			});
			//2020/10/22 可能轉由nodejs觸發，先註解
			/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
				url:'./letsreload.controltable.php',
				method:'post',
				async:false,
				//data:{},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		});
		$('.checktableclear #sale').click(function(){//清理桌面
			$('.checktablesplit #sale').prop('disabled',true);
			$.ajax({
				url:'./cleartable.php',
				method:'post',
				async:false,
				data:{'tabnum':$('.checktableclear #text input[name="lastnum"]').val(),'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'cleartable cleartable.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					checktableclear.dialog('close');
					$('.checktablesplit #sale').prop('disabled',false);
					if(splittablelist.dialog('isOpen')){
						splittablelist.dialog('close');
					}
					else{
					}

					//location.href='./order.php?<?php if(isset($_GET["submachine"]))echo "submachine=".$_GET["submachine"]."&";else if(isset($_GET["machine"]))echo "machine=".$_GET["machine"]."&";else; ?>usercode=<?php if(isset($_GET["usercode"]))echo $_GET["usercode"]; ?>&username=<?php if(isset($_GET["username"]))echo $_GET["username"]; ?>&listtype=1&tabnum='+t[2]+'&bizdate='+t[0]+'&consecnumber='+t[1];
				},
				error:function(e){
					//console.log(e);
				}
			});
			//2020/10/22 可能轉由nodejs觸發，先註解
			/*$.ajax({//2020/10/20 桌控異動，提示系統要刷新桌控
				url:'./letsreload.controltable.php',
				method:'post',
				async:false,
				//data:{},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		});
		$('.combine #return').click(function(){
			$('.inittable input[name="window"]').val('inittable');
			combine.dialog('close');
		});
		$('.tablecombine #return').click(function(){
			$('.inittable input[name="window"]').val('inittable');
			tablecombine.dialog('close');
		});
		$('.tablesplit #return').click(function(){
			$('.inittable input[name="window"]').val('inittable');
			tablesplit.dialog('close');
		});
		$('.tableclear #return').click(function(){
			$('.inittable input[name="window"]').val('inittable');
			tableclear.dialog('close');
		});
		$('.funbox #return').click(function(){
			funbox.dialog('close');
		});
		/*$('.consetchange .numbox').on('click','input',function(event){
			//oneEvent(event);
			var index=$('.consetchange .numbox input').index(this);
			if($('.consetchange input[name="view"]').val()==''&&$('.consetchange .numbox input:eq('+index+')').val()=='.'){
				$('.consetchange input[name="view"]').val('0.');
			}
			else if($('.consetchange input[name="view"]').val()=='0'){
				$('.consetchange input[name="view"]').val($('.consetchange .numbox input:eq('+index+')').val());
			}
			else{
				$('.consetchange input[name="view"]').val($('.consetchange input[name="view"]').val()+$('.consetchange .numbox input:eq('+index+')').val());
			}
		});
		$('.consetchange .numbox').on('click','button',function(event){
			//oneEvent(event);
			$('.consetchange input[name="view"]').val('0');
		});
		$('.consetchange').on('click','#settingchange',function(event){
			//oneEvent(event);
			consetchange.dialog('close');
		});*/
		$('.funbox #computemoney').click(function(){
			$('.order#order #content #billfun #billfun3 #computemoney').trigger('click');
		});
	}
	else{
	}
	/*點餐*/
	$.ajax({
		url:'./lib/js/check.booking.php',
		method:'post',
		async:false,
		data:{'machinetype':$('.order#order .companydata #terminalnumber').val()},
		dataType:'html',
		success:function(d){
			if(d=='success'){
				if($('.order#order #banner #detail #tw #point').css('background-color')=='red'){
				}
				else{
					$('.order#order #banner #detail #tw #point').css({'background-color':'red','z-index':'3'});
				}
			}
			else{
				$('.order#order #banner #detail #tw #point').css({'background-color':'','z-index':''});
			}
			//console.log(d);
		},
		error:function(e){
			//console.log(e);
		}
	});
	/**/
	function sleep(time){//依0.1秒為單位
		for(var i=0;i<time;){
			i=setTimeout(add(i),100);
		}
	}
	function add(temp){
		temp++;
	}
	var startsec=-1;

	if($('.order#order .initsetting #reporttime').length>0){//2020/4/22
		var reporttime=$('.order#order .initsetting #reporttime').val();
	}
	else{
		var reporttime=30;
	}
	setInterval(function(){
		if(responce==true){
			responce=false;
			var systemtime='';
			$.ajax({
				url:'./lib/js/gettime.ajax.php',
				dataType:'json',
				async:false,
				cache:false,
				success:function(d){
					if(startsec==-1){
						startsec=d[1];
					}
					else if($('.order#order .companydata #terminalnumber').val()=='m1'){
						//console.log(startsec%30);
						//console.log(d[1]%30);
						if(startsec%parseInt(reporttime)==d[1]%parseInt(reporttime)){
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':'report'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
					}
					else{
					}
					//console.log(d);
					$('.order#order #banner div[data-id="time"]').html(d[0]);
					systemtime=d[0].substr(-5)+':'+d[1];
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.order#order .initsetting #checkcontrol').val()=='1'&&$('.order#order .initsetting #controltable').val()=='1'&&tempparameter==1&&inittable.dialog('isOpen')&&!funbox.dialog('isOpen')){
				//2020/10/22 可能轉由nodejs觸發，先註解
				/*var checkcontroltable=0;
				if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
					$.ajax({
						url:'./checktype.controltable.ajax.php',
						//method:'post',
						async:false,
						cache:false,
						//data:{},
						dataType:'html',
						success:function(d){
							//console.log(d);
							if(d=='reload'){
								checkcontroltable=1;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{//定時檢查桌控畫面(舊版)*/
				var checkcontroltable=1;
				//}

				if(checkcontroltable==1){//2020/10/20/週二 需檢查桌控畫面
					var tablepage='';
					//console.log(typeof $('.'+$('.inittable input[name="window"]').val()+' .tablemap #butbox .focus').prop('id'));
					if(typeof $('.'+$('.inittable input[name="window"]').val()+' .tablemap #butbox .focus').prop('id')==="undefined"){//桌控不分樓層(區域)
					}
					else{//桌控有分樓層(區域)
						tablepage=$('.'+$('.inittable input[name="window"]').val()+' .tablemap #butbox .focus').prop('id');
					}
					//console.log(tablepage);
					$.ajax({
						url:'./comput.ajax.php',
						method:'post',
						data:{'tablepage':tablepage,'machinetype':$('.control#control #'+$('.control#control #mactype').val()+'name').val()},
						dataType:'json',
						async:false,
						success:function(d){
							$('.inittable input[data-id="remaining"]').val(d['remaining']);
							$('.inittable input[data-id="time"]').val(d['time']);
							//console.log(d);
							//console.log($('.inittable .table[id^="comput"]').length);
							if(tablepage!=''){
								var target=tablepage.substr(0,(tablepage.length-6));
								for(var i=0;i<$('.inittable #'+target+' .table[id^="comput"]').length;i++){
									if($('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val()!='outside'){
										var temptabnum=[$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];//2020/3/19 var temptabnum=$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber').html().split('<input'); >> var temptabnum=[$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];
										//console.log( d[$('.control#control #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val()]);
										if(typeof d[temptabnum[0]]!="undefined"){
											if(d[temptabnum[0]]['splitnum']!='1'){
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').prop('name','split');
											}
											else{
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').prop('name','');
											}
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').prop('id','comput notempty ');
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="state"]').val(d[temptabnum[0]]['state']);
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #createdatetime input[name="bizdate"]').val(d[temptabnum[0]]['bizdate']);
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #amt').html('<span>'+d[temptabnum[0]]['money']+'</span>');
											if(Number(d[temptabnum[0]]['persons'])>0){
												//console.log($('.control#control #'+target+' .table[id^="comput"]:eq('+i+') #persons').length);
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #persons').html(d[temptabnum[0]]['persons']+'位');
											}
											else{
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #persons').html('');
											}
											if($('.order#order .initsetting #hinttime').length>0&&parseInt(d[temptabnum[0]]['mins'])>parseInt($('.order#order .initsetting #hinttime').val())){
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').css({'background-color':''});
											}
											else if(parseInt(d[temptabnum[0]]['mins'])<=0){
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').css({'background-color':'#00d941'});
											}
											else if($('.order#order .initsetting #sechinttime').length>0&&parseInt(d[temptabnum[0]]['mins'])<=parseInt($('.order#order .initsetting #sechinttime').val())){
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').css({'background-color':'#e7f12c'});
											}
											else{
												$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').css({'background-color':'#73d7ec'});
											}
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #createdatetime #val').html(d[temptabnum[0]]['mins']);
											
											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!changetable.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.changetable #'+target+' .chtable:eq('+i+')[id="notempty check"]').length>0){
													//$('.combine #'+target+' .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.changetable #'+target+' .chtable:eq('+i+')').prop('id','notempty');
													$('.changetable #'+target+' .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.changetable #'+target+' .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.changetable #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}
											
											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!combine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.combine #'+target+' .chtable:eq('+i+')[id="check"]').length>0){
													//$('.combine #'+target+' .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.combine #'+target+' .chtable:eq('+i+')').prop('id','notempty');
													$('.combine #'+target+' .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.combine #'+target+' .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.combine #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablecombine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablecombine #'+target+' .chtable:eq('+i+')[id="check"]').length>0){
													//$('.combine #'+target+' .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.tablecombine #'+target+' .chtable:eq('+i+')').prop('id','notempty');
													$('.tablecombine #'+target+' .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.tablecombine #'+target+' .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.tablecombine #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablesplit.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablesplit #'+target+' .chtable:eq('+i+')[id="notempty check"]').length>0){
													//$('.combine #'+target+' .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.tablesplit #'+target+' .chtable:eq('+i+')').prop('id','notempty');
													$('.tablesplit #'+target+' .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.tablesplit #'+target+' .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.tablesplit #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tableclear.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if(d[temptabnum[0]]['splitnum']!='1'){
													$('.tableclear #'+target+' .chtable:eq('+i+')').prop('name','split');
												}
												else{
													$('.tableclear #'+target+' .chtable:eq('+i+')').prop('name','');
												}
												if($('.tableclear #'+target+' .chtable:eq('+i+')[id="notempty check"]').length>0){
													//$('.combine #'+target+' .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.tableclear #'+target+' .chtable:eq('+i+')').prop('id','notempty');
													$('.tableclear #'+target+' .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.tableclear #'+target+' .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.tableclear #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
												$('.tableclear #'+target+' .chtable:eq('+i+') input[name="state"]').val(d[temptabnum[0]]['state']);
												$('.tableclear #'+target+' .chtable:eq('+i+') input[name="split"]').val(d[temptabnum[0]]['splitnum']);
											}
										}
										else{
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').prop('id','comput');
											var temptabnum=[$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];//2020/3/19 var temptabnum=$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber').html().split('<input'); >> var temptabnum=[$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val(temptabnum[0]);
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="consecnumber"]').val('');
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #tablenumber input[name="state"]').val('0');
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #createdatetime input[name="bizdate"]').val('');
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #amt').html('');
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #persons').html('');
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+')').css({'background-color':''});
											$('.inittable #'+target+' .table[id^="comput"]:eq('+i+') #createdatetime #val').html('');

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!changetable.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.changetable #'+target+' .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable #'+target+' .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.changetable #'+target+' .chtable:eq('+i+')').prop('id','');
													$('.changetable #'+target+' .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.changetable #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!combine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.combine #'+target+' .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable #'+target+' .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.combine #'+target+' .chtable:eq('+i+')').prop('id','');
													$('.combine #'+target+' .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.combine #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablecombine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablecombine #'+target+' .chtable:eq('+i+')[id="oncheck"]').length>0){
													//$('.changetable #'+target+' .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.tablecombine #'+target+' .chtable:eq('+i+')').prop('id','');
													$('.tablecombine #'+target+' .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.tablecombine #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablesplit.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablesplit #'+target+' .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable #'+target+' .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.tablesplit #'+target+' .chtable:eq('+i+')').prop('id','');
													$('.tablesplit #'+target+' .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.tablesplit #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tableclear.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tableclear #'+target+' .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable #'+target+' .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.tableclear #'+target+' .chtable:eq('+i+')').prop('id','');
													$('.tableclear #'+target+' .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.tableclear #'+target+' .chtable:eq('+i+') input[name="consecnumber"]').val('');
												$('.tableclear #'+target+' .chtable:eq('+i+') input[name="state"]').val('');
												$('.tableclear #'+target+' .chtable:eq('+i+') input[name="split"]').val('');
											}
										}
									}
									else{
									}
								}
							}
							else{
								for(var i=0;i<$('.inittable .table[id^="comput"]').length;i++){
									if($('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val()!='outside'){
										var temptabnum=[$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];//2020/3/19 var temptabnum=$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber').html().split('<input'); >> var temptabnum=[$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];
										//console.log( d[$('.control#control .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val()]);
										if(typeof d[temptabnum[0]]!="undefined"){
											if(d[temptabnum[0]]['splitnum']!='1'){
												$('.inittable .table[id^="comput"]:eq('+i+')').prop('name','split');
											}
											else{
												$('.inittable .table[id^="comput"]:eq('+i+')').prop('name','');
											}
											$('.inittable .table[id^="comput"]:eq('+i+')').prop('id','comput notempty ');
											$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
											$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="state"]').val(d[temptabnum[0]]['state']);
											$('.inittable .table[id^="comput"]:eq('+i+') #createdatetime input[name="bizdate"]').val(d[temptabnum[0]]['bizdate']);
											$('.inittable .table[id^="comput"]:eq('+i+') #amt').html('<span>'+d[temptabnum[0]]['money']+'</span>');
											if(Number(d[temptabnum[0]]['persons'])>0){
												//console.log($('.control#control .table[id^="comput"]:eq('+i+') #persons').length);
												$('.inittable .table[id^="comput"]:eq('+i+') #persons').html(d[temptabnum[0]]['persons']+'位');
											}
											else{
												$('.inittable .table[id^="comput"]:eq('+i+') #persons').html('');
											}
											if($('.order#order .initsetting #hinttime').length>0&&parseInt(d[temptabnum[0]]['mins'])>parseInt($('.order#order .initsetting #hinttime').val())){
												$('.inittable .table[id^="comput"]:eq('+i+')').css({'background-color':''});
											}
											else if(parseInt(d[temptabnum[0]]['mins'])<=0){
												$('.inittable .table[id^="comput"]:eq('+i+')').css({'background-color':'#00d941'});
											}
											else if($('.order#order .initsetting #sechinttime').length>0&&parseInt(d[temptabnum[0]]['mins'])<=parseInt($('.order#order .initsetting #sechinttime').val())){
												$('.inittable .table[id^="comput"]:eq('+i+')').css({'background-color':'#e7f12c'});
											}
											else{
												$('.inittable .table[id^="comput"]:eq('+i+')').css({'background-color':'#73d7ec'});
											}
											$('.inittable .table[id^="comput"]:eq('+i+') #createdatetime #val').html(d[temptabnum[0]]['mins']);

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!changetable.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.changetable .chtable:eq('+i+')[id="notempty check"]').length>0){
													//$('.combine .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.changetable .chtable:eq('+i+')').prop('id','notempty');
													$('.changetable .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.changetable .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.changetable .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!combine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.combine .chtable:eq('+i+')[id="check"]').length>0){
													//$('.combine .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.combine .chtable:eq('+i+')').prop('id','notempty');
													$('.combine .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.combine .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.combine .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablecombine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablecombine .chtable:eq('+i+')[id="check"]').length>0){
													//$('.combine .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.tablecombine .chtable:eq('+i+')').prop('id','notempty');
													$('.tablecombine .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.tablecombine .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.tablecombine .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablesplit.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablesplit .chtable:eq('+i+')[id="notempty check"]').length>0){
													//$('.combine .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.tablesplit .chtable:eq('+i+')').prop('id','notempty');
													$('.tablesplit .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.tablesplit .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.tablesplit .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tableclear.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tableclear .chtable:eq('+i+')[id="notempty check"]').length>0){
													//$('.combine .chtable:eq('+i+')').prop('id','notempty');
												}
												else{
													$('.tableclear .chtable:eq('+i+')').prop('id','notempty');
													$('.tableclear .chtable:eq('+i+')').css({'border':'5px solid #898989','border-radius':'5px','background-color':'#ff0066','color':'#ffffff'});
												}
												$('.tableclear .chtable:eq('+i+') input[name="tabnum"]').val(d[temptabnum[0]]['inittablenum']);
												$('.tableclear .chtable:eq('+i+') input[name="consecnumber"]').val(d[temptabnum[0]]['consecnumber']);
												$('.tableclear .chtable:eq('+i+') input[name="state"]').val(d[temptabnum[0]]['state']);
												$('.tableclear .chtable:eq('+i+') input[name="split"]').val(d[temptabnum[0]]['splitnum']);
											}
										}
										else{
											$('.inittable .table[id^="comput"]:eq('+i+')').prop('id','comput');
											var temptabnum=[$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];//2020/3/19 var temptabnum=$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber').html().split('<input'); >> var temptabnum=[$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="inittable"]').val()];
											$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="tabnum"]').val(temptabnum[0]);
											$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="consecnumber"]').val('');
											$('.inittable .table[id^="comput"]:eq('+i+') #tablenumber input[name="state"]').val('0');
											$('.inittable .table[id^="comput"]:eq('+i+') #createdatetime input[name="bizdate"]').val('');
											$('.inittable .table[id^="comput"]:eq('+i+') #amt').html('');
											$('.inittable .table[id^="comput"]:eq('+i+') #persons').html('');
											$('.inittable .table[id^="comput"]:eq('+i+')').css({'background-color':''});
											$('.inittable .table[id^="comput"]:eq('+i+') #createdatetime #val').html('');

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!changetable.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.changetable .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.changetable .chtable:eq('+i+')').prop('id','');
													$('.changetable .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.changetable .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!combine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.combine .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.combine .chtable:eq('+i+')').prop('id','');
													$('.combine .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.combine .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablecombine.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablecombine .chtable:eq('+i+')[id="oncheck"]').length>0){
													//$('.changetable .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.tablecombine .chtable:eq('+i+')').prop('id','');
													$('.tablecombine .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.tablecombine .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tablesplit.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tablesplit .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.tablesplit .chtable:eq('+i+')').prop('id','');
													$('.tablesplit .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.tablesplit .chtable:eq('+i+') input[name="consecnumber"]').val('');
											}

											if($('.order#order .initsetting #checkcontroltable').length>0&&$('.order#order .initsetting #checkcontroltable').val()=='0'&&!tableclear.dialog('isOpen')){//2020/10/20/週二 不定時檢查桌控(測試階段)；期望提高桌控畫面效能
											}
											else{
												if($('.tableclear .chtable:eq('+i+')[id="check"]').length>0){
													//$('.changetable .chtable:eq('+i+')').prop('id','');
												}
												else{
													$('.tableclear .chtable:eq('+i+')').prop('id','');
													$('.tableclear .chtable:eq('+i+')').css({'border':'','border-radius':'','background-color':'','color':''});
												}
												$('.tableclear .chtable:eq('+i+') input[name="consecnumber"]').val('');
												$('.tableclear .chtable:eq('+i+') input[name="state"]').val('');
												$('.tableclear .chtable:eq('+i+') input[name="split"]').val('');
											}
										}
									}
									else{
									}
								}
							}
							if(d['outside']>0){
								$('.inittable .table #QTY').html('尚有'+d['outside']+'單');
							}
							else{
								$('.inittable .table #QTY').html('');
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					$('.inittable input[data-id="time"]').val(systemtime);
					//console.log(systemtime);
				}
			}
			else{
			}
			responce=true;
		}
		else{
		}
	},1000);
	//2020/10/20/週二 印象中該功能已不再使用....因此註解
	/*if($('.order#order .initsetting #weborder').length>0&&$('.order#order .initsetting #weborder').val()=='1'&&$('.order#order .companydata #terminalnumber').val()==$('.order#order .initsetting #webdownloadmachine').val()){
		if($('.order#order .initsetting #webordersec').length>0){
			var checksec=$('.order#order .initsetting #webordersec').val();
		}
		else{
			var checksec='300';
		}
		setInterval(function(){
			$.ajax({
				url:'http://api.tableplus.com.tw/outposandorder/demopos/lib/js/getweborder.ajax.php',
				method:'post',
				data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val()},
				dataType:'html',
				timeout:5000,
				success:function(d){
					//console.log(d);
					if(d=='empty'){
						$('.order#order #content #MemberBill #billfun #billfun1 #point').html('');
						//$('.order#order #billfun #butobx #time').val(d);
						$('.order#order #content #MemberBill #billfun #billfun1 #point').css({'background-color':'red','z-index':'0'});
					}
					else{
						$('.order#order #content #MemberBill #billfun #billfun1 #weborder').prop('disabled',false);
						if($('.order#order .initsetting #webding').val()=='1'){
							var player=$('.order#order #content #MemberBill #billfun #billfun1 #player')[0];
							player.play();
						}
						else{
						}
						$('.order#order #content #MemberBill #billfun #billfun1 #point').html(d);
						if($('.order#order #content #MemberBill #billfun #billfun1 #point').css('background-color')=='red'){
							//$('.order#order #banner #detail #tw #point').css({'background-color':'red','z-index':'3'});
						}
						else{
							$('.order#order #content #MemberBill #billfun #billfun1 #point').css({'background-color':'red','z-index':'3'});
						}
					}
					//console.log(d);
				},
				error:function(e,status){
					if(status==='timeout'){
						//console.log('timeout');
					}
					else{
						//console.log(e);
					}
				}
			});
		},parseInt(checksec)*1000);
	}
	else{
	}*/
	if($('.order#order .initsetting #secview').val()=='1'){
		$.ajax({
			url:'../secview/cleartemp.ajax.php',
			method:'post',
			async: false,
			data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
			socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
			console.log('send message "clear" to secview');
		}
		else{
		}
	}
	else{
	}
	if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="consecnumber"]').val().length>0&&$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="bizdate"]').val().length>0){
		temporder($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val());
	}
	else{
		
	}
	/*按鈕取號*/
	var a; 
	var button; 
	/**/
	if($('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val().length==0||$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val().length==0){
		//location.href='./index.php';
	}
	else{
	}
	//$list=$('.order#order #MemberBill #list').tabs();
	//$list.tabs('option','disabled',[1]);
	//$billfun=$('.order#order #MemberBill #billfun').tabs();
	webbooking=$('.webbooking').dialog({
		autoOpen:false,
		width:$(window).width(),
		height:$(window).height(),
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		close:function(){
			$('.order#order #content #list #funbox #webbooking').prop('disabled',false);
		}
	});
	
	var autoaccept=function(){
		nidin_loop();
		nidin_listnumberloop();
		//console.log('start autoaccept');
		if(getclassarray['list'][1]['count']!==undefined&&getclassarray['list'][1]['count']>0){//有新訂單
			//console.log('new list');
			setTimeout(function(){$('.webbooking #nidin .listheader .accept').trigger('click')},1000);
			//console.log('get new list');
			//console.log('end autoaccept1');
			//autoaccept();//2022/3/16 如在這執行，無法等到accept完成，會一直run。因此移至accept最後執行，確保在最後執行
		}
		else{
			//console.log('end autoaccept2');
			setTimeout(autoaccept,1000);
		}
	};
	if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
		autoaccept();
	}
	else if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #alwayscheck').length>0&&$('.nidin #alwayscheck').val()=='1'){//2022/1/20 強制查詢帳單數量
		checknidinloop=setInterval(nidin_listnumberloop,10000);
	}
	else if($('.nidin #usenidin').length>0){
		nidin_listnumberloop();
	}
	else{
	}
	checkdeletesale=$('.checkdeletesale').dialog({
		autoOpen:false,
		width:500,
		height:440,
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			$('.checkdeletesale').parents('div[role="dialog"]').find('button[title="Close"]').css({'display':'none'});
		}
	});
	waitstockload=$('.waitstockload').dialog({
		autoOpen:false,
		width:300,
		height:170,
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			$('.waitstockload').parents('div[role="dialog"]').find('button[title="Close"]').css({'display':'none'});
		}
	});
	emptyitemsvoidlist=$('.emptyitemsvoidlist').dialog({
		autoOpen:false,
		width:450,
		height:300,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	spend=$('.spend').dialog({//系統訊息
		autoOpen:false,
		/*width:450,
		height:300,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		spend.dialog('option','width',450);
		spend.dialog('option','height',600);
	}
	else if($(window).width()==1366){
		spend.dialog('option','width',450);
		spend.dialog('option','height',600);
	}
	else if($(window).width()==1280){
		spend.dialog('option','width',450);
		spend.dialog('option','height',600);
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		spend.dialog('option','width',450);
		spend.dialog('option','height',600);
	}
	else if($(window).width()==1024){
		spend.dialog('option','width',450);
		spend.dialog('option','height',600);
	}
	if($('.order#order .initsetting #pointtree').val()=='1'){
		pointtreememdata=$('.pointtreememdata').dialog({//集點樹會員資訊
			autoOpen:false,
			/*width:450,
			height:300,*/
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		if($(window).width()==1920){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()==1366){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()==1280){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()==1024){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
	}
	else{
	}
	if($('.order#order .initsetting #intellapay').val()=='1'){
		intellapay=$('.intellapaymethod').dialog({//"英特拉"電子支付付款方式
			autoOpen:false,
			width:450,
			height:500,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
		var intellaqrcodetime='';
		var checkintellasale='';
		checkintella=$('.checkintella').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.checkintella').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.checkintella #successsale').prop('disabled',true);
				$('.checkintella #cancelsale').prop('disabled',false);
				if($('.checkintella .qrhint #time').length>0){
					$('.checkintella .qrhint #time').html(($('.intella #qrcodetimeout').val()*60-1));
				}
				else{
					$('.checkintella .qrhint').html("QRcode逾時倒數...<span id='time'>"+($('.intella #qrcodetimeout').val()*60-1)+"</span>秒");
				}
				$('.checkintella .hintstring').html('');
				intellaqrcodetime=setInterval(function(){
					if($('.checkintella .qrhint #time').html()==0){
						$('.checkintella .qrhint').html('QRcode已逾時');
						$.ajax({
							url:'./lib/api/intella/delete.failqrcode.php',
							method:'post',
							async:false,
							data:{'machine':$('.order#order .companydata #terminalnumber').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						clearInterval(intellaqrcodetime);
						//clearInterval(checkintellasale);
						setTimeout(function(){
							$('.checkintella .qrhint').append('<button id="recreateqrcode" style="float:right;">再試一次</button>');
							$('.checkintella .hintstring #recheck').prop('disabled',false);
						},1000);
					}
					else{
						$('.checkintella .qrhint #time').html(parseInt($('.checkintella .qrhint #time').html())-1);
					}
				},1000);
				checkintellasale=setInterval(function(){
					$.ajax({
						url:'./lib/api/intella/checkintellasale.ajax.php',
						method:'post',
						async:false,
						data:{'intellaconsecnumber':$('.result #viewwindow input[name="intellaconsecnumber"]').val()},
						dataType:'json',
						success:function(d){
							console.log(JSON.parse(d));
							$.ajax({
								url:'./lib/api/intella/intella.log.php',
								method:'post',
								data:{'function':'checkintellasale','res':d,'intellaconsecnumber':$('.result #viewwindow input[name="intellaconsecnumber"]').val()}
							});
							d=JSON.parse(d);
							if(d['Header']['StatusCode']=='0000'&&typeof d['Data']['OrderStatus']!=='undefined'&&d['Data']['OrderStatus']=='1'){//交易成功
								$.ajax({
									url:'./lib/api/intella/delete.failqrcode.php',
									method:'post',
									async:false,
									data:{'machine':$('.order#order .companydata #terminalnumber').val()},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
								clearInterval(intellaqrcodetime);
								clearInterval(checkintellasale);
								$.ajax({
									url:'./lib/api/intella/check.paymethod.php',
									method:'post',
									async:false,
									data:{'method':d['Header']['Method']},
									dataType:'json',
									success:function(m){
										//console.log(d);
										$('.checkintella .hintstring').html(m['payname']+' '+d['Header']['StatusDesc']+'<input type="hidden" name="methodcode" value="'+d['Header']['Method']+'"><input type="hidden" name="payname" value="'+m['payname']+'"><input type="hidden" name="method" value="'+d['Header']['Method']+'">');
										$.ajax({
											url:'./lib/api/intella/intella.log.php',
											method:'post',
											data:{'function':'check.paymethod','res':m,'method':d['Header']['Method'],}
										});
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.checkintella #cancelsale').prop('disabled',true);
								$('.checkintella #successsale').prop('disabled',false);
							}
							else if(d['Header']['StatusCode']=='0000'){//以選取付款方式，但未結帳
								$.ajax({
									url:'./lib/api/intella/check.paymethod.php',
									method:'post',
									async:false,
									data:{'method':d['Header']['Method']},
									dataType:'json',
									success:function(m){
										//console.log(d);
										$('.checkintella .hintstring').html('付款方式：'+m['payname']+'<br>未付款<input type="hidden" name="methodcode" value="'+d['Header']['Method']+'"><input type="hidden" name="payname" value="'+m['payname']+'"><input type="hidden" name="method" value="'+d['Header']['Method']+'"><button id="recheck" style="float:right;" disabled>檢查交易狀態</button>');
										$.ajax({
											url:'./lib/api/intella/intella.log.php',
											method:'post',
											data:{'function':'check.paymethod','res':m,'method':d['Header']['Method'],}
										});
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								$('.checkintella .hintstring').html(d['Header']['StatusDesc']+'<button id="recheck" style="float:right;">檢查交易狀態</button>');
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				},1000);
			},
			close:function(){
				clearInterval(intellaqrcodetime);
				clearInterval(checkintellasale);
			}
		});
		checkintellauser=$('.checkintellauser').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.checkintellauser').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.checkintellauser .paras input[name="methodcode"]').val('');
				$('.checkintellauser .paras input[name="money"]').val('');
				$('.checkintellauser .inputdiv').css({'display':'block'});
				$('.checkintellauser .inputdiv input[name="authcode"]').val('');
				$('.checkintellauser .loaddiv').html("檢查交易<span id='dot'>...</span>");
				$('.checkintellauser .loaddiv').css({'display':'none'});
				
				$('.checkintellauser #successsale').prop('disabled',true);
				$('.checkintellauser #retry').prop('disabled',true);
				$('.checkintellauser #cancelsale').prop('disabled',false);
				/*intellaqrcodetime=setInterval(function(){
					if($('.checkintella .qrhint #time').html()==0){
						$('.checkintella .qrhint').html('QRcode已逾時');
						$.ajax({
							url:'./lib/api/intella/delete.failqrcode.php',
							method:'post',
							async:false,
							data:{'machine':$('.order#order .companydata #terminalnumber').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						clearInterval(intellaqrcodetime);
						//clearInterval(checkintellasale);
						setTimeout(function(){
							$('.checkintella .qrhint').append('<button id="recreateqrcode" style="float:right;">再試一次</button>');
							$('.checkintella .hintstring #recheck').prop('disabled',false);
						},1000);
					}
					else{
						$('.checkintella .qrhint #time').html(parseInt($('.checkintella .qrhint #time').html())-1);
					}
				},1000);*/
				/*checkintellasale=setInterval(function(){
					$.ajax({
						url:'./lib/api/intella/checkintellasale.ajax.php',
						method:'post',
						async:false,
						data:{'intellaconsecnumber':$('.result #viewwindow input[name="intellaconsecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(JSON.parse(d));
							d=JSON.parse(d);
							if(d['Header']['StatusCode']=='0000'&&typeof d['Data']['OrderStatus']!=='undefined'&&d['Data']['OrderStatus']=='1'){//交易成功
								$.ajax({
									url:'./lib/api/intella/delete.failqrcode.php',
									method:'post',
									async:false,
									data:{'machine':$('.order#order .companydata #terminalnumber').val()},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
								clearInterval(intellaqrcodetime);
								clearInterval(checkintellasale);
								$.ajax({
									url:'./lib/api/intella/check.paymethod.php',
									method:'post',
									async:false,
									data:{'method':d['Header']['Method']},
									dataType:'json',
									success:function(m){
										//console.log(d);
										$('.checkintella .hintstring').html(m['payname']+' '+d['Header']['StatusDesc']+'<input type="hidden" name="methodcode" value="'+d['Header']['Method']+'"><input type="hidden" name="payname" value="'+m['payname']+'"><input type="hidden" name="method" value="'+d['Header']['Method']+'">');
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.checkintella #cancelsale').prop('disabled',true);
								$('.checkintella #successsale').prop('disabled',false);
							}
							else if(d['Header']['StatusCode']=='0000'){//以選取付款方式，但未結帳
								$.ajax({
									url:'./lib/api/intella/check.paymethod.php',
									method:'post',
									async:false,
									data:{'method':d['Header']['Method']},
									dataType:'json',
									success:function(m){
										//console.log(d);
										$('.checkintella .hintstring').html('付款方式：'+m['payname']+'<br>未付款<input type="hidden" name="methodcode" value="'+d['Header']['Method']+'"><input type="hidden" name="payname" value="'+m['payname']+'"><input type="hidden" name="method" value="'+d['Header']['Method']+'"><button id="recheck" style="float:right;" disabled>檢查交易狀態</button>');
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								$('.checkintella .hintstring').html(d['Header']['StatusDesc']+'<button id="recheck" style="float:right;">檢查交易狀態</button>');
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				},1000);*/
			},
			close:function(){
				/*clearInterval(intellaqrcodetime);
				clearInterval(checkintellasale);*/
			}
		});
		var dotloading='';
		checkeasycard=$('.checkeasycard').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.checkeasycard .qrhint').css({'visibility':'visible'});
				$('.checkeasycard #retry').css({'display':'none'});
				$('.checkeasycard #retry #time').html('');
				$('.checkeasycard').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.checkeasycard #successsale').prop('disabled',true);
				$('.checkeasycard #cancelsale').css({'display':'none'});
				$('.checkeasycard .hintstring').html('');
				dotloading=setInterval(function(){
					if($('.checkeasycard .qrhint #loading').length>0){
						if($('.checkeasycard .qrhint #loading').html().length==3){
							$('.checkeasycard .qrhint #loading').html('.');
						}
						else if($('.checkeasycard .qrhint #loading').html().length==2){
							$('.checkeasycard .qrhint #loading').html('...');
						}
						else{
							$('.checkeasycard .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
			},
			close:function(){
			}
		});
		voidintella=$('.voidintella').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidintella .qrhint').css({'visibility':'visible'});
				$('.voidintella #retry').css({'display':'none'});
				$('.voidintella #retry #time').html('');
				$('.voidintella').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidintella #successsale').prop('disabled',true);
				$('.voidintella #cancelsale').css({'display':'none'});
				$('.voidintella .hintstring').html('');
				dotloading=setInterval(function(){
					if($('.voidintella .qrhint #loading').length>0){
						if($('.voidintella .qrhint #loading').html().length==3){
							$('.voidintella .qrhint #loading').html('.');
						}
						else if($('.voidintella .qrhint #loading').html().length==2){
							$('.voidintella .qrhint #loading').html('...');
						}
						else{
							$('.voidintella .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
			},
			close:function(){
			}
		});
		voidsalewithintellapay=$('.voidsalewithintellapay').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidsalewithintellapay .qrhint').css({'visibility':'visible'});
				$('.voidsalewithintellapay #retry').css({'display':'none'});
				$('.voidsalewithintellapay #retry #time').html('');
				$('.voidsalewithintellapay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidsalewithintellapay #successsale').prop('disabled',true);
				$('.voidsalewithintellapay #cancelsale').css({'display':'none'});
				$('.voidsalewithintellapay .hintstring').html('');
				dotloading=setInterval(function(){
					if($('.voidsalewithintellapay .qrhint #loading').length>0){
						if($('.voidsalewithintellapay .qrhint #loading').html().length==3){
							$('.voidsalewithintellapay .qrhint #loading').html('.');
						}
						else if($('.voidsalewithintellapay .qrhint #loading').html().length==2){
							$('.voidsalewithintellapay .qrhint #loading').html('...');
						}
						else{
							$('.voidsalewithintellapay .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
				if($('.voidsalewithintellapay input[name="paycode"]').val()=='31800'||$('.voidsalewithintellapay input[name="paycode"]').val()=='32100'||$('.voidsalewithintellapay input[name="paycode"]').val()=='32800'){//悠遊卡退款(獨立；因為需要使用到悠遊卡卡機，所以機制不同)//2021/8/10 增加一卡通32100、愛金卡(icash)32800
					$('.voidsalewithintellapay .qrhint').html("<span id='retry' style='display:none;'>自動重試<span id='time'></span> </span>偵測卡片<span id='loading'>...</span>");
					var res='';
					res=api_easycard('Refund',$('.order#order .companydata #terminalnumber').val(),$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(),$('.voidsalewithintellapay input[name="money"]').val());
					res.done(function(res){
						if(typeof res==='object'){
						}
						else{
							res=JSON.parse(res);
						}
						if(res=='errorinput'){
							//console.log('變數輸入錯誤');
						}
						else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
							/*if(typeof res['Data']['Retry']!=='undefined'){
								//res['Data']['Retry']++;
							}
							else{
								res['Data']['Retry']=1;
							}*/
							$('.voidsalewithintellapay #retry').css({'display':'block'});
							$('.voidsalewithintellapay #retry #time').html(res['Data']['Retry']);
							
							res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(),$('.voidsalewithintellapay input[name="money"]').val(),res);//第一次重試
							res.done(function(res){
								if(typeof res==='object'){
								}
								else{
									res=JSON.parse(res);
								}

								if(res=='errorinput'){
									//console.log('變數輸入錯誤');
								}
								else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
									/*if(typeof res['Data']['Retry']!=='undefined'){
										//res['Data']['Retry']++;
									}
									else{
										res['Data']['Retry']=1;
									}*/
									$('.voidsalewithintellapay #retry').css({'display':'block'});
									$('.voidsalewithintellapay #retry #time').html(res['Data']['Retry']);
									
									res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(),$('.voidsalewithintellapay input[name="money"]').val(),res);//第二次重試
									res.done(function(res){
										if(typeof res==='object'){
										}
										else{
											res=JSON.parse(res);
										}

										if(res=='errorinput'){
											//console.log('變數輸入錯誤');
										}
										else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
											/*if(typeof res['Data']['Retry']!=='undefined'){
												//res['Data']['Retry']++;
											}
											else{
												res['Data']['Retry']=1;
											}*/
											$('.voidsalewithintellapay #retry').css({'display':'block'});
											$('.voidsalewithintellapay #retry #time').html(res['Data']['Retry']);
											
											res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(),$('.voidsalewithintellapay input[name="money"]').val(),res);//第三次重試
											res.done(function(res){
												if(typeof res==='object'){
												}
												else{
													res=JSON.parse(res);
												}

												if(res=='errorinput'){
													//console.log('變數輸入錯誤');
												}
												else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第三次重試錯誤，不再重試
													/*if(typeof res['Data']['Retry']!=='undefined'){
														//res['Data']['Retry']++;
													}
													else{
														res['Data']['Retry']=1;
													}*/

													//$('.checkeasycard #retry').css({'display':'block'});
													//$('.checkeasycard #retry #time').html(res['Data']['Retry']);
													$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
													$('.voidsalewithintellapay .hintstring').html('重試三次失敗。(easy card)');
													$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
													clearInterval(dotloading);

													//console.log('retry '+JSON.stringify(res));
													/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
														$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
													}
													else{
													}*/
												}
												else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
													//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
													$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
													$('.voidsalewithintellapay .hintstring').html('退款成功。(3)');
													$('.voidsalewithintellapay #successsale').prop('disabled',false);
													clearInterval(dotloading);
													$.ajax({
														url:'./lib/api/intella/easycard_saleticket_api.php',
														method:'post',
														data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
														dataType:'html',
														success:function(d){
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
													//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
													$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
													$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'(3)');
													$('.voidsalewithintellapay #successsale').prop('disabled',false);
													clearInterval(dotloading);
												}
												else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
													//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
													$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
													$('.voidsalewithintellapay .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
													//$('.voidsalewithintellapay #successsale').prop('disabled',false);
													$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
													clearInterval(dotloading);
												}
												else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
													//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
													$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
													$('.voidsalewithintellapay .hintstring').html('連線逾時，請重試一次。');
													//$('.voidsalewithintellapay #successsale').prop('disabled',false);
													$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
													clearInterval(dotloading);
												}
												else{//其餘意外狀況
													//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
													$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
													$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'(3)');
													//$('.voidsalewithintellapay #successsale').prop('disabled',false);
													$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
													clearInterval(dotloading);
												}
											});
											//console.log('retry '+JSON.stringify(res));
											/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
												$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
											}
											else{
											}*/
										}
										else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
											$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
											$('.voidsalewithintellapay .hintstring').html('退款成功。(2)');
											$('.voidsalewithintellapay #successsale').prop('disabled',false);
											clearInterval(dotloading);
											$.ajax({
												url:'./lib/api/intella/easycard_saleticket_api.php',
												method:'post',
												data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
											$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
											$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'(2)');
											$('.voidsalewithintellapay #successsale').prop('disabled',false);
											clearInterval(dotloading);
										}
										else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
											$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
											$('.voidsalewithintellapay .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
											//$('.voidsalewithintellapay #successsale').prop('disabled',false);
											$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
											clearInterval(dotloading);
										}
										else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
											$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
											$('.voidsalewithintellapay .hintstring').html('連線逾時，請重試一次。');
											//$('.voidsalewithintellapay #successsale').prop('disabled',false);
											$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
											clearInterval(dotloading);
										}
										else{//其餘意外狀況
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
											$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
											$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'(2)');
											//$('.voidsalewithintellapay #successsale').prop('disabled',false);
											$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
											clearInterval(dotloading);
										}
									});
									//console.log('retry '+JSON.stringify(res));
									/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
										$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
									}
									else{
									}*/
								}
								else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
									$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
									$('.voidsalewithintellapay .hintstring').html('退款成功。(1)');
									$('.voidsalewithintellapay #successsale').prop('disabled',false);
									clearInterval(dotloading);
									$.ajax({
										url:'./lib/api/intella/easycard_saleticket_api.php',
										method:'post',
										data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
									$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
									$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'(1)');
									$('.voidsalewithintellapay #successsale').prop('disabled',false);
									clearInterval(dotloading);
								}
								else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
									$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
									$('.voidsalewithintellapay .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
									//$('.voidsalewithintellapay #successsale').prop('disabled',false);
									$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
									clearInterval(dotloading);
								}
								else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
									$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
									$('.voidsalewithintellapay .hintstring').html('連線逾時，請重試一次。');
									//$('.voidsalewithintellapay #successsale').prop('disabled',false);
									$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
									clearInterval(dotloading);
								}
								else{//其餘意外狀況
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
									$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
									$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'(1)');
									//$('.voidsalewithintellapay #successsale').prop('disabled',false);
									$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
									clearInterval(dotloading);
								}
							});

							//console.log('retry '+JSON.stringify(res));
							/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
								$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
							}
							else{
							}*/
						}
						else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html('退款成功。');
							$('.voidsalewithintellapay #successsale').prop('disabled',false);
							clearInterval(dotloading);
							$.ajax({
								url:'./lib/api/intella/easycard_saleticket_api.php',
								method:'post',
								data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']);
							$('.voidsalewithintellapay #successsale').prop('disabled',false);
							clearInterval(dotloading);
						}
						else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
							//$('.voidsalewithintellapay #successsale').prop('disabled',false);
							$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
							clearInterval(dotloading);
						}
						else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html('連線逾時，請重試一次。');
							//$('.voidsalewithintellapay #successsale').prop('disabled',false);
							$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
							clearInterval(dotloading);
						}
						else{//其餘意外狀況
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']);
							//$('.voidsalewithintellapay #successsale').prop('disabled',false);
							$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
							clearInterval(dotloading);
						}
					});
				}
				else{//其餘英特拉付款方式
					$('.voidsalewithintellapay .qrhint').html("退款連線中<span id='loading'>...</span>");
					var res='';
					res=api_void_intellaother($('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(),$('.voidsalewithintellapay input[name="money"]').val(),$('.order#order .companydata #story').val(),$('.order#order #tabs4 input[name="usercode"]').val(),$('.order#order .companydata #terminalnumber').val());
					res.done(function(res){
						res=JSON.parse(res);
						if(res['Header']['StatusCode']=='0000'){//退款成功
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']);
							$('.voidsalewithintellapay #successsale').prop('disabled',false);
							clearInterval(dotloading);
						}
						else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='7112'){//已全額退費
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']);
							$('.voidsalewithintellapay #successsale').prop('disabled',false);
							clearInterval(dotloading);
						}
						else{
							$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
							$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'<button id="retryvoid" style="float:right;">再試一次</button>');
							$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
							clearInterval(dotloading);
						}
					});
				}
			},
			close:function(){
				$('.voidsalewithintellapay input[name="type"]').val('');//修改帳單>>editlist、作廢帳單>>void、依發票作廢帳單>>voidbyinv
				$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val('');//英特拉付款帳單編號
				$('.voidsalewithintellapay input[name="paycode"]').val('');//英特拉付款代號
				$('.voidsalewithintellapay input[name="money"]').val('');//英特拉付款金額
			}
		});
	}
	else{
	}
	if(($('.order#order .initsetting #intellapay').val()=='1'&&$('.order#order .initsetting #easycard').val()=='1')||($('.order#order .initsetting #nccc').val()=='1'&&$('.order#order .initsetting #nccceasycard').val()=='1')){
		intellabalancequery=$('.intellabalancequery').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.intellabalancequery .qrhint').css({'visibility':'visible'});
				$('.intellabalancequery #retry').css({'display':'none'});
				$('.intellabalancequery #retry #time').html('');
				$('.intellabalancequery').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.intellabalancequery #successsale').prop('disabled',true);
				$('.intellabalancequery #cancelsale').css({'display':'none'});
				$('.intellabalancequery .hintstring').html('');
				dotloading=setInterval(function(){
					if($('.intellabalancequery .qrhint #loading').length>0){
						if($('.intellabalancequery .qrhint #loading').html().length==3){
							$('.intellabalancequery .qrhint #loading').html('.');
						}
						else if($('.intellabalancequery .qrhint #loading').html().length==2){
							$('.intellabalancequery .qrhint #loading').html('...');
						}
						else{
							$('.intellabalancequery .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
			},
			close:function(){
			}
		});
	}
	else{
	}
	checknccc=$('.checknccc').dialog({
		autoOpen:false,
		width:450,
		height:300,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			$('.checknccc .qrhint').css({'visibility':'visible'});
			//$('.checknccc #retry').css({'display':'none'});
			//$('.checknccc #retry #time').html('');
			$('.checknccc').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
			$('.checknccc #successsale').prop('disabled',true);
			$('.checknccc #successsale').css({'display':'block'});
			$('.checknccc #checksale').css({'display':'none'});
			$('.checknccc #cancelsale').css({'display':'none'});
			$('.checknccc .hintstring').html('');
			dotloading=setInterval(function(){
				if($('.checknccc .qrhint #loading').length>0){
					if($('.checknccc .qrhint #loading').html().length==3){
						$('.checknccc .qrhint #loading').html('.');
					}
					else if($('.checknccc .qrhint #loading').html().length==2){
						$('.checknccc .qrhint #loading').html('...');
					}
					else{
						$('.checknccc .qrhint #loading').html('..');
					}
				}
				else{
				}
			},500);
		},
		close:function(){
		}
	});
	voidnccc=$('.voidnccc').dialog({
		autoOpen:false,
		width:450,
		height:300,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			$('.voidnccc .qrhint').css({'visibility':'visible'});
			$('.voidnccc').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
			$('.voidnccc #successsale').prop('disabled',true);
			$('.voidnccc #successsale').css({'display':'block'});
			$('.voidnccc #checksale').css({'display':'none'});
			$('.voidnccc #cancelsale').css({'display':'none'});
			$('.voidnccc .hintstring').html('');
			dotloading=setInterval(function(){
				if($('.voidnccc .qrhint #loading').length>0){
					if($('.voidnccc .qrhint #loading').html().length==3){
						$('.voidnccc .qrhint #loading').html('.');
					}
					else if($('.voidnccc .qrhint #loading').html().length==2){
						$('.voidnccc .qrhint #loading').html('...');
					}
					else{
						$('.voidnccc .qrhint #loading').html('..');
					}
				}
				else{
				}
			},500);
		},
		close:function(){
		}
	});
	voidsalewithnccc=$('.voidsalewithnccc').dialog({
		autoOpen:false,
		width:450,
		height:300,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			$('.voidsalewithnccc .qrhint').css({'visibility':'visible'});
			//$('.voidsalewithnccc #retry').css({'display':'none'});
			//$('.voidsalewithnccc #retry #time').html('');
			$('.voidsalewithnccc').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
			$('.voidsalewithnccc #successsale').prop('disabled',true);
			$('.voidsalewithnccc #successsale').css({'display':'block'});
			$('.voidsalewithnccc #checksale').css({'display':'none'});
			$('.voidsalewithnccc #cancelsale').css({'display':'none'});
			$('.voidsalewithnccc .hintstring').html('');
			$('.voidsalewithnccc .qrhint').html("退款處理中<span id='loading'>...</span>");
			dotloading=setInterval(function(){
				if($('.voidsalewithnccc .qrhint #loading').length>0){
					if($('.voidsalewithnccc .qrhint #loading').html().length==3){
						$('.voidsalewithnccc .qrhint #loading').html('.');
					}
					else if($('.voidsalewithnccc .qrhint #loading').html().length==2){
						$('.voidsalewithnccc .qrhint #loading').html('...');
					}
					else{
						$('.voidsalewithnccc .qrhint #loading').html('..');
					}
				}
				else{
				}
			},500);
			var ncccdate='';
			$.ajax({
				url:'./lib/api/nccc/create.in.php',
				method:'post',
				async:false,
				data:{'type':'02','asm':$('.voidsalewithnccc input[name="asm"]').val(),'money':$('.voidsalewithnccc input[name="money"]').val()},
				dataType:'json',
				success:function(d){
					//console.log(d);
					ncccdate=d['date'];
					$('.voidsalewithnccc input[name="date"]').val(d['date']);
					//$('.checknccc input[name="methodcode"]').val(d['consecnumber']);
				},
				error:function(e){
					//console.log(e);
				}
			});
			var res='';
			res=nccc_iscomplete(ncccdate);
			res.done(function(res){
				if(res['data']=='交易成功'){//成功
					$('.voidsalewithnccc #successsale').prop('disabled',false);
					$('.voidsalewithnccc .hintstring').html(res['data']);
				}
				else if(typeof res['statusText']!=='undefined'){//等待逾時
					$('.voidsalewithnccc #successsale').css({'display':'none'});
					$('.voidsalewithnccc #checksale').css({'display':'block'});
					$('.voidsalewithnccc #cancelsale').css({'display':'block'});
					$('.voidsalewithnccc .hintstring').html(res['statusText']);
				}
				else{//失敗
					$('.voidsalewithnccc #cancelsale').css({'display':'block'});
					$('.voidsalewithnccc .hintstring').html(res['data']);
				}
				$('.voidsalewithnccc .qrhint').css({'visibility':'hidden'});
				clearInterval(dotloading);
			});
		},
		close:function(){
			$('.voidsalewithnccc input[name="type"]').val('');//修改帳單>>editlist、作廢帳單>>void、依發票作廢帳單>>voidbyinv
			$('.voidsalewithnccc input[name="asm"]').val('');//刷卡紀錄是否符合優惠活動
			$('.voidsalewithnccc input[name="money"]').val('');//刷卡金額
		}
	});
	chosetype=$('.chosetype').dialog({
		autoOpen:false,
		width:300,
		height:200,
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			//$('.chosetype').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
		},
		close:function(){
		}
	});
	if($('.order#order .initsetting #itri').val()=='1'){
		itritext=$('.itritext').dialog({//"英特拉"電子支付付款方式
			autoOpen:false,
			width:450,
			height:240,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false
		});
	}
	else{
	}
	var rfidloading='';
	checkrfid=$('.checkrfid').dialog({
		autoOpen:false,
		width:450,
		height:300,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			rfidloading=setInterval(function(){
				if($('.checkrfid .qrhint #loading').length>0){
					if($('.checkrfid .qrhint #loading').html().length==3){
						$('.checkrfid .qrhint #loading').html('.');
					}
					else if($('.checkrfid .qrhint #loading').html().length==2){
						$('.checkrfid .qrhint #loading').html('...');
					}
					else{
						$('.checkrfid .qrhint #loading').html('..');
					}
				}
				else{
				}
			},500);
		},
		close:function(){
			clearInterval(rfidloading);
		}
	});
	var stop=0;//2020/5/20 rfid單卡讀取使用參數，用於停止讀取的tag
	rfidlist=$('.rfidlist').dialog({
		autoOpen:false,
		width:500,
		height:$(window).height(),
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			stop=0;
			$('.rfidlist .readnumber').val('');
			$('.rfidlist .listno').val('');
			$('.rfidlist .list').html('');
			$('.rfidlist .retry').prop('disabled',false);
			$('.rfidlist .send').prop('disabled',true);
		},
		close:function(){
			stop=1;
			$('.rfidlist .readnumber').val('');
			$('.rfidlist .listno').val('');
			$('.rfidlist .list').html('');
		}
	});
	dblock=$('.dblock').dialog({//系統訊息
		autoOpen:false,
		/*width:450,
		height:300,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		dblock.dialog('option','width',450);
		dblock.dialog('option','height',300);
	}
	else if($(window).width()==1366){
		dblock.dialog('option','width',(450));
		dblock.dialog('option','height',(220));
	}
	else if($(window).width()==1280){
		dblock.dialog('option','width',450);
		dblock.dialog('option','height',220);
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		dblock.dialog('option','width',450);
		dblock.dialog('option','height',220);
	}
	else if($(window).width()==1024){
		dblock.dialog('option','width',450);
		dblock.dialog('option','height',220);
	}
	sysmeg=$('.sysmeg').dialog({//系統訊息
		autoOpen:false,
		/*width:450,
		height:300,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.sysmeg div[id^="name"]').css({'display':'none'});
			$('.sysmeg button div[id^="name"]').css({'display':''});
			$('.sysmeg #list').html('');
		}
	});
	if($(window).width()==1920){
		sysmeg.dialog('option','width',450);
		sysmeg.dialog('option','height',300);
	}
	else if($(window).width()==1366){
		sysmeg.dialog('option','width',(450));
		sysmeg.dialog('option','height',(220));
	}
	else if($(window).width()==1280){
		sysmeg.dialog('option','width',450);
		sysmeg.dialog('option','height',220);
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		sysmeg.dialog('option','width',450);
		sysmeg.dialog('option','height',220);
	}
	else if($(window).width()==1024){
		sysmeg.dialog('option','width',450);
		sysmeg.dialog('option','height',220);
	}
	alertmessage=$('.alertmessage').dialog({//系統訊息
		autoOpen:false,
		width:450,
		/*height:150,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.alertmessage #text').html('');
		}
	});
	sysmeg4=$('.sysmeg4').dialog({//系統訊息
		autoOpen:false,
		/*width:450,
		height:300,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		classes:{
			'ui-dialog-titlebar-close':'hidden'
		}
	});
	if($(window).width()==1920){
		sysmeg4.dialog('option','width',450);
		sysmeg4.dialog('option','height',300);
	}
	else if($(window).width()==1366){
		sysmeg4.dialog('option','width',(450));
		sysmeg4.dialog('option','height',(220));
	}
	else if($(window).width()==1280){
		sysmeg4.dialog('option','width',450);
		sysmeg4.dialog('option','height',220);
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		sysmeg4.dialog('option','width',450);
		sysmeg4.dialog('option','height',220);
	}
	else if($(window).width()==1024){
		sysmeg4.dialog('option','width',450);
		sysmeg4.dialog('option','height',220);
	}
	sysmeg5=$('.sysmeg5').dialog({//系統訊息
		autoOpen:false,
		/*width:450,
		height:300,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		sysmeg5.dialog('option','width',450);
		sysmeg5.dialog('option','height',300);
	}
	else if($(window).width()==1366){
		sysmeg5.dialog('option','width',(450));
		sysmeg5.dialog('option','height',(220));
	}
	else if($(window).width()==1280){
		sysmeg5.dialog('option','width',450);
		sysmeg5.dialog('option','height',220);
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		sysmeg5.dialog('option','width',450);
		sysmeg5.dialog('option','height',220);
	}
	else if($(window).width()==1024){
		sysmeg5.dialog('option','width',450);
		sysmeg5.dialog('option','height',220);
	}
	exitsys=$('.exitsys').dialog({//系統訊息
		autoOpen:false,
		/*width:450,
		height:300,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		exitsys.dialog('option','width',450);
		exitsys.dialog('option','height',300);
	}
	else if($(window).width()==1366){
		exitsys.dialog('option','width',450);
		exitsys.dialog('option','height',220);
	}
	else if($(window).width()==1280){
		exitsys.dialog('option','width',450);
		exitsys.dialog('option','height',220);
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		exitsys.dialog('option','width',450);
		exitsys.dialog('option','height',220);
	}
	else if($(window).width()==1024){
		exitsys.dialog('option','width',450);
		exitsys.dialog('option','height',220);
	}
	setperson=$('.setperson').dialog({//人數設定
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'人數設定',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		setperson.dialog('option','width',1044);
		setperson.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		setperson.dialog('option','width',(1366*0.63-6.4-72.3));
		setperson.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		setperson.dialog('option','width',(1280*0.63-72.3));
		setperson.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		setperson.dialog('option','width',($(window).width()*0.63-72.3));
		setperson.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		setperson.dialog('option','width',1024);
		setperson.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		setperson.dialog('option','width',$(window).width());
		setperson.dialog('option','height',$(window).height());
	}
	/*taste1=$('.order#order .taste1').dialog({//備註
		autoOpen:false,
		width:1044,
		height:966,
		title:'商品備註',
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});*/
	taste2=$('.taste2').dialog({//備註與加料
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'商品備註與加料',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		taste2.dialog('option','width',1044);
		taste2.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		taste2.dialog('option','width',(1366*0.63-6.4-72.3));
		taste2.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		taste2.dialog('option','width',(1280*0.63-72.3));
		taste2.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		taste2.dialog('option','width',($(window).width()*0.63-72.3));
		taste2.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		taste2.dialog('option','width',1024);
		taste2.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		taste2.dialog('option','width',$(window).width());
		taste2.dialog('option','height',$(window).height());
	}
	result=$('.result').dialog({//結帳畫面
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'結帳',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			$('.result').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
			$('.result .sendviewwindow input[name="creditcard"]').val('');
			if($('.result .sendviewwindow input[name="sendtype"]').val()=='buytemp'){
			}
			else{
				resultopencheck();
			}
			$('.result #funbox .intellapay').prop('disabled',false);
		}
	});
	function resultopencheck(){
		$.ajax({
			url:'./lib/js/resultopencheck.ajax.php',
			async:false,
			dataType:'json',
			success:function(d){
				//console.log(d);
				if($('.order#order .initsetting #orderdis').val()=='1'){
					$('.result #funbox #listdisbutA').prop('disabled',false);
				}
				else{
					$('.result #funbox #listdisbutA').prop('disabled',true);
				}
				if($('.order#order .initsetting #orderdisnum').val()=='1'){
					$('.result #funbox #listdisbutB').prop('disabled',false);
				}
				else{
					$('.result #funbox #listdisbutB').prop('disabled',true);
				}
				for(var i=1;i<=6;i++){
					if(d['disbut'+i]=='1'&&Number(d['disnum'+i])>=0){
						$('.result #funbox .listdisbut'+i).prop('disabled',false);
					}
					else{
						$('.result #funbox .listdisbut'+i).prop('disabled',true);
					}
				}
				$('.result #funbox .invbut').prop('disabled',false);
				$('.result #funbox .chargebut').prop('disabled',false);
				$('.result #funbox .receiptbut #name1').html('不列印收據章');//2019/11/28
				$('.result #funbox #receipt').val('0');
			},
			error:function(e){
				//console.log(e);
			}
		});
	};
	if($(window).width()==1920){
		//result.dialog('option','width',1044);
		result.dialog('option','width',1920);
		result.dialog('option','height',1080);
	}
	else if($(window).width()==1366){
		//result.dialog('option','width',(1366*0.63-6.4-72.3));
		result.dialog('option','width',1366);
		result.dialog('option','height',768);
	}
	else if($(window).width()==1280){
		//result.dialog('option','width',(1280*0.63-72.3));
		result.dialog('option','width',1280);
		result.dialog('option','height',$(window).height());
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		//result.dialog('option','width',($(window).width()*0.63-72.3));
		result.dialog('option','width',$(window).width());
		result.dialog('option','height',$(window).height());
	}
	else if($(window).width()==1024){
		//result.dialog('option','width',1024);
		result.dialog('option','width',1024);
		result.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		result.dialog('option','width',$(window).width());
		result.dialog('option','height',$(window).height());
	}
	itemdis=$('.itemdis').dialog({//單品促銷畫面
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'單品促銷',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		itemdis.dialog('option','width',1044);
		itemdis.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		itemdis.dialog('option','width',1024);
		itemdis.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		itemdis.dialog('option','width',1024);
		itemdis.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		itemdis.dialog('option','width',$(window).width());
		itemdis.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		itemdis.dialog('option','width',1024);
		itemdis.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		itemdis.dialog('option','width',$(window).width());
		itemdis.dialog('option','height',$(window).height());
	}
	change=$('.changehint').dialog({//找零提示視窗
		autoOpen:false,
		/*width:450,
		height:300,*/
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			logouttime=$('.order#order .initsetting #changeclose').val();
			$('.changehint #timehint #time').html($('.order#order .initsetting #changeclose').val());
			tim1=setInterval(function(){timer1()},1000);//啟動倒數
		},
		close:function(){
			if($('.order#order .initsetting #secview').val()=='1'){
				$.ajax({
					url:'../secview/cleartemp.ajax.php',
					method:'post',
					async: false,
					data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'changehint cleartemp.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
					socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
					console.log('send message "clear" to secview');
				}
				else{
				}
			}
			else{
			}
			if($('.result .sendviewwindow input[name="sendtype"]').val()=='tempquicksale'){
				clearInterval(tim1);
				ClearWindow('','');
			}
			else if($('.order#order .initsetting #controltable').val()=='1'){
				/*if($('.order#order .companydata #submachine').length>0){
					location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				}
				else{
					if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
						location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					}
					else{
						location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					}
				}*/
				//result.dialog('close');
				inittable.dialog('open');
				ClearWindow('','');
				
			}
			else{
				if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val().length>0){
					//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					clearInterval(tim1);
					ClearWindow('','');
				}
				else{
					//location.href='./order.php';
					clearInterval(tim1);
					ClearWindow('','');
				}
			}
		}
	});
	if($(window).width()==1920){
		change.dialog('option','width',450);
		change.dialog('option','height',400);
	}
	else if($(window).width()==1366){
		change.dialog('option','width',450);
		change.dialog('option','height',400);
	}
	else if($(window).width()==1280){
		change.dialog('option','width',450);
		change.dialog('option','height',400);
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		change.dialog('option','width',450);
		change.dialog('option','height',400);
	}
	else if($(window).width()==1024){
		change.dialog('option','width',450);
		change.dialog('option','height',400);
	}
	setchange=$('.setchange').dialog({//設定找零金
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'設定找零金',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$.ajax({
				url:'./lib/js/setchange.php',
				method:'post',
				data:{'change':$('.setchange input[name="view"]').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(){
				}
			});
			$('.order#order #MemberBill #billfun #billfun1button').prop('disabled',false);
			$('.order#order #MemberBill #billfun #billfun1button').trigger('click');
			//$billfun.tabs('enable',0);
			//$billfun.tabs('option','active',[0]);
		}
	});
	if($(window).width()==1920){
		setchange.dialog('option','width',1044);
		setchange.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		setchange.dialog('option','width',(1366*0.63-6.4-72.3));
		setchange.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		setchange.dialog('option','width',(1280*0.63-72.3));
		setchange.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		setchange.dialog('option','width',($(window).width()*0.63-72.3));
		setchange.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		setchange.dialog('option','width',1024);
		setchange.dialog('option','height',(768*0.9-16));
	}
	else{//詭異規格
		setchange.dialog('option','width',$(window).width());
		setchange.dialog('option','height',$(window).height());
	}
	oinv=$('.oinv').dialog({//設定發票
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'設定發票',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		oinv.dialog('option','width',1044);
		oinv.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		oinv.dialog('option','width',(1366*0.63-6.4-72.3));
		oinv.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		oinv.dialog('option','width',(1280*0.63-72.3));
		oinv.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		oinv.dialog('option','width',($(window).width()*0.63-72.3));
		oinv.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		oinv.dialog('option','width',1024);
		oinv.dialog('option','height',(768*0.9-16));
	}
	else{//詭異規格
		oinv.dialog('option','width',$(window).width());
		oinv.dialog('option','height',$(window).height());
	}
	cancelinv=$('.cancelinv').dialog({//作廢發票
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'設定發票',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		cancelinv.dialog('option','width',1044);
		cancelinv.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		cancelinv.dialog('option','width',(1366*0.63-6.4-72.3));
		cancelinv.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		cancelinv.dialog('option','width',(1280*0.63-72.3));
		cancelinv.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		cancelinv.dialog('option','width',($(window).width()*0.63-72.3));
		cancelinv.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		cancelinv.dialog('option','width',1024);
		cancelinv.dialog('option','height',(768*0.9-16));
	}
	salelist=$('.salelist').dialog({//瀏覽帳單
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'設定發票',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		salelist.dialog('option','width',1044);
		salelist.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		salelist.dialog('option','width',1360);
		salelist.dialog('option','height',768);
	}
	else if($(window).width()==1280){
		salelist.dialog('option','width',1280);
		salelist.dialog('option','height',$(window).height());
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		salelist.dialog('option','width',$(window).width());
		salelist.dialog('option','height',$(window).height());
	}
	else if($(window).width()==1024){
		salelist.dialog('option','width',1024);
		salelist.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		salelist.dialog('option','width',$(window).width());
		salelist.dialog('option','height',$(window).height());
	}
	salevoid=$('.salevoid').dialog({//作廢帳單
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'設定發票',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		salevoid.dialog('option','width',1044);
		salevoid.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		salevoid.dialog('option','width',1360);
		salevoid.dialog('option','height',768);
	}
	else if($(window).width()==1280){
		salevoid.dialog('option','width',1280);
		salevoid.dialog('option','height',$(window).height());
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		salevoid.dialog('option','width',$(window).width());
		salevoid.dialog('option','height',$(window).height());
	}
	else if($(window).width()==1024){
		salevoid.dialog('option','width',1024);
		salevoid.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		salevoid.dialog('option','width',$(window).width());
		salevoid.dialog('option','height',$(window).height());
	}
	salevoidbyinv=$('.salevoidbyinv').dialog({//依發票作廢
		autoOpen:false,
		width:500,
		height:600,
		/*title:'設定發票',*/
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			$('.salevoidbyinv input[name="inv"]').val('');
			$('.salevoidbyinv #checkcontent').html('');
			$('.salevoidbyinv #check').prop('disabled',true);
		}
	});
	viewtemp=$('.viewtemp').dialog({//未結帳單
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'設定發票',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){//2021/9/15 開啟畫面也要重製畫面
			$('.viewtemp #salelist #salecontent .listitems').prop('id','');
			$('.viewtemp #listno').html('');
			$('.viewtemp #list #listcontent').html('');
			$('.viewtemp #date').html('');
			$('.viewtemp #credate').val('');
			$('.viewtemp #credatetime').val('');
			$('.viewtemp #membername').html('');
			$('.viewtemp #membertel').html('');
			$('.viewtemp #otherfun button#plus').prop('disabled',true);
			$('.viewtemp #otherfun button#sale').prop('disabled',true);
			$('.viewtemp #otherfun button#openinv').prop('disabled',true);
			$('.viewtemp #viewvoid').prop('disabled',true);
			$('.viewtemp #fun button#forall').prop('disabled',true);
			$('.viewtemp #fun button#list').prop('disabled',true);
			$('.viewtemp #fun button#tag').prop('disabled',true);
			$('.viewtemp #fun button#kitchen').prop('disabled',true);
			$('.viewtemp #fun button#changecheck').prop('disabled',true);
			$('.viewtemp #fun button#editoutman').prop('disabled',true);
		},
		close:function(){
			$('.viewtemp #salelist #salecontent .listitems').prop('id','');
			$('.viewtemp #listno').html('');
			$('.viewtemp #list #listcontent').html('');
			$('.viewtemp #date').html('');
			$('.viewtemp #credate').val('');
			$('.viewtemp #credatetime').val('');
			$('.viewtemp #membername').html('');
			$('.viewtemp #membertel').html('');
			$('.viewtemp #otherfun button#plus').prop('disabled',true);
			$('.viewtemp #otherfun button#sale').prop('disabled',true);
			$('.viewtemp #otherfun button#openinv').prop('disabled',true);
			$('.viewtemp #viewvoid').prop('disabled',true);
			$('.viewtemp #fun button#forall').prop('disabled',true);
			$('.viewtemp #fun button#list').prop('disabled',true);
			$('.viewtemp #fun button#tag').prop('disabled',true);
			$('.viewtemp #fun button#kitchen').prop('disabled',true);
			$('.viewtemp #fun button#changecheck').prop('disabled',true);
			$('.viewtemp #fun button#editoutman').prop('disabled',true);
		}
	});
	if($(window).width()==1920){
		viewtemp.dialog('option','width',1044);
		viewtemp.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		viewtemp.dialog('option','width',1360);
		viewtemp.dialog('option','height',768);
	}
	else if($(window).width()==1280){
		viewtemp.dialog('option','width',1280);
		viewtemp.dialog('option','height',$(window).height());
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		viewtemp.dialog('option','width',$(window).width());
		viewtemp.dialog('option','height',$(window).height());
	}
	else if($(window).width()==1024){
		viewtemp.dialog('option','width',1024);
		viewtemp.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		viewtemp.dialog('option','width',$(window).width());
		viewtemp.dialog('option','height',$(window).height());
	}
	keybord=$('.keybord').dialog({//數字鍵盤
		autoOpen:false,
		width:500,
		height:700,
		/*title:'數字鍵盤',*/
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			/*if(typeof $('.keybord input[name="type"]')!="undefined"&&$('.keybord input[name="type"]').val()=='creditcard'){//2022/4/6 強制關閉，不紀錄信用卡後4碼，資料庫欄位轉移給nccc串接編號，以利後續刷退使用
				$('.keybord input[name="num"]').val('');
				$('.keybord input[name="num"]').prop('max','9999');
				$('.keybord #add').prop('disabled',true);
				$('.keybord #diff').prop('disabled',true);
			}
			else{*/
				$.ajax({
					url:'./lib/js/getnow.ajax.php',
					dataType:'html',
					success:function(d){
						//console.log(d);
						$('.keybord input[name="num"]').prop('max','999');
						$('.keybord input[name="num"]').val(d);
						$('.keybord input[name="num"]').trigger('focus');
					},
					error:function(e){
						//console.log(e);
					}
				});
			//}
		},
		close:function(){
			$('.keybord #add').prop('disabled',false);
			$('.keybord #diff').prop('disabled',false);
			$('.keybord input[name="type"]').val('bord');
			$('.keybord input[name="num"]').val('');
		}
	});
	if($(window).height()<700){
		keybord.dialog('option','height',$(window).height());
	}
	else{
	}
	punch=$('.punch').dialog({//員工打卡
		autoOpen:false,
		width:500,
		height:$(window).height(),
		/*title:'員工打卡',*/
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.punch input[name="num"]').val('');
		}
	});
	editoutman=$('.editoutman').dialog({//調整外送員
		autoOpen:false,
		width:500,
		height:$(window).height(),
		/*title:'調整外送員',*/
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.editoutman input[name="manname"]').val('');
			$('.editoutman input[name="mancode"]').val('');
		}
	});
	kvm=$('.order#order .kvm').dialog({
		autoOpen:false,
		//width:1024,
		//height:700,
		//title:'打卡紀錄',
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.kvm #salelist #salecontent').html('');
			$('.kvm #listno').html('');
			$('.kvm #date').html('');
			$('.kvm #credate').html('');
			$('.kvm #list #listcontent').html('');
			$('.kvm #delete').prop('disabled',true);
			//$('.punch input[name="num"]').val('');
		}
	});
	if($(window).width()==1920){
		kvm.dialog('option','width',1920);
		kvm.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		kvm.dialog('option','width',1366);
		kvm.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		kvm.dialog('option','width',1280);
		kvm.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		kvm.dialog('option','width',$(window).width());
		kvm.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		kvm.dialog('option','width',1024);
		kvm.dialog('option','height',(768*0.9-16));
	}
	else{//詭異規格
		kvm.dialog('option','width',$(window).width());
		kvm.dialog('option','height',$(window).height());
	}
	editpunch=$('.order#order .editpunch').dialog({
		autoOpen:false,
		width:$(window).width(),
		height:$(window).height(),
		/*title:'打卡紀錄',*/
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			var d=new Date();
			$(".editpunch #startpunch").datepicker('setDate',d.getFullYear()+"-"+('0'+(Number(d.getMonth())+1)).substr(-2)+"-"+d.getDate());
			$(".editpunch #endpunch").datepicker('setDate',d.getFullYear()+"-"+('0'+(Number(d.getMonth())+1)).substr(-2)+"-"+d.getDate());
			$('.editpunch #searchresult').html('');
			$('.editpunch #editperson').val('');
			$('.editpunch #editperno').val('');
			$('.editpunch #initeditTYPE').val('');
			$('.editpunch #initeditDATE').val('');
			$('.editpunch #initeditTIME').val('');
			$('.editpunch #initeditH').val('');
			$('.editpunch #initeditI').val('');

			$(".editpunch #editDATE").datepicker('setDate','');
			$('.editpunch #editDATE').prop('disabled',true);
			$('.editpunch #editH option').prop('selected',false);
			$('.editpunch #editH option:eq(0)').prop('selected',true);
			$('.editpunch #editH').prop('disabled',true);
			$('.editpunch #editI option').prop('selected',false);
			$('.editpunch #editI option:eq(0)').prop('selected',true);
			$('.editpunch #editI').prop('disabled',true);
			
			$('.editpunch #cancel').prop('disabled',true);
			$('.editpunch #save').prop('disabled',true);
			$('.editpunch #printpunch').prop('disabled',true);
		}
	});
	memdeposit=$('.order#order .memdeposit').dialog({
		autoOpen:false,
		width:550,
		height:450,
		/*title:'儲值',*/
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	paywindow=$('.paywindow').dialog({//其他付款方式
		autoOpen:false,
		width:500,
		height:$(window).height(),
		/*title:'其他付款方式',*/
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.paywindow button').prop('disabled',false);
		}
	});
	tabinput=$('.tabinput').dialog({//內用桌號
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'設定發票',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		tabinput.dialog('option','width',1044);
		tabinput.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		tabinput.dialog('option','width',(1366*0.63-6.4-72.3));
		tabinput.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		tabinput.dialog('option','width',(1280*0.63-72.3));
		tabinput.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		tabinput.dialog('option','width',($(window).width()*0.63-72.3));
		tabinput.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		tabinput.dialog('option','width',1024);
		tabinput.dialog('option','height',(768*0.9-16));
	}
	else{//詭異規格
		tabinput.dialog('option','width',$(window).width());
		tabinput.dialog('option','height',$(window).height());
	}
	openmoney=$('.openmoney').dialog({//開放金額初始價格
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'開放金額初始價格',*/
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		openmoney.dialog('option','width',1044);
		openmoney.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		openmoney.dialog('option','width',(1366*0.63-6.4-72.3));
		openmoney.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		openmoney.dialog('option','width',(1280*0.63-72.3));
		openmoney.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		openmoney.dialog('option','width',($(window).width()*0.63-72.3));
		openmoney.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		openmoney.dialog('option','width',1024);
		openmoney.dialog('option','height',(768*0.9-16));
	}
	else{//詭異規格
		openmoney.dialog('option','width',$(window).width());
		openmoney.dialog('option','height',$(window).height());
	}
	meminput=$('.meminput').dialog({//會員輸入視窗
		autoOpen:false,
		/*width:1044,
		height:966,*/
		/*title:'會員輸入視窗',*/
		position:{my:'right top',at:'right top',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			if($('.initsetting #faceidmember').length>0&&$('.initsetting #faceidmember').val()=='1'){//會員臉部ID
				scheme = window.location.protocol;
				domain = window.location.host + "/outposandorder/demopos/lib/api/faceid/identify_v2_response.php";

				app_url = "nfa://x-callback-url/identify?scheme="+scheme+"&domain="+domain+"&type=multiple";
				window.open(app_url);
				setTimeout(function() {
					window.close();
				}, 100);
			}
			else{
			}
		},
		close:function(){
			$('.meminput #memtel').val('');
		}
	});
	if($(window).width()==1920){
		meminput.dialog('option','width',1044);
		meminput.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		meminput.dialog('option','width',(1366*0.7));
		meminput.dialog('option','height',(768*0.9-16));
	}
	else if($(window).width()==1280){
		meminput.dialog('option','width',(1280*0.7));
		meminput.dialog('option','height',(800*0.9-16));
	}
	else if($(window).width()<=1280&&$(window).width()>1024){
		meminput.dialog('option','width',($(window).width()*0.7));
		meminput.dialog('option','height',($(window).height()*0.9-16));
	}
	else if($(window).width()==1024){
		meminput.dialog('option','width',1024);
		meminput.dialog('option','height',$(window).height());
	}
	else if($(window).width()<1024){
		meminput.dialog('option','width',$(window).width());
		meminput.dialog('option','height',$(window).height());
	}
	else{//詭異規格
		meminput.dialog('option','width',$(window).width());
		meminput.dialog('option','height',$(window).height());
	}
	cremem=$('.cremem').dialog({
		autoOpen:false,
		width:550,
		height:500,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			$('.cremem input[name="tel"]').val($('.meminput #memtel').val());
		}
	});
	memdata=$('.memdata').dialog({//瀏覽會員資料
		autoOpen:false,
		width:550,
		height:768,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	getpaypw=$('.getpaypw').dialog({//2020/8/24 輸入交易密碼
		autoOpen:false,
		width:550,
		height:190,
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$.ajax({
				url:'./lib/api/mempaypw/deletepw.secview.php',
				method:'post',
				async:false,
				data:{'machine':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			$('.getpaypw input[name="paypw"]').val('');
			$('.getpaypw .paymethoddata input[name="class"]').val('');
			$('.getpaypw .paymethoddata input[name="dbname"]').val('');
			$('.getpaypw .paymethoddata input[name="should"]').val('');
			$('.getpaypw .paymethoddata input[name="fromdb"]').val('');
			$('.getpaypw .paymethoddata input[name="pay"]').val('');
			$('.getpaypw .paymethoddata input[name="location"]').val('');
			$('.getpaypw .paymethoddata input[name="name"]').val('');
			$('.getpaypw .paymethoddata input[name="inv"]').val('');
			$('.getpaypw .paymethoddata input[name="price"]').val('');
			$('.getpaypw .paymethoddata input[name="type"]').val('');
		}
	});
	editpaypw=$('.editpaypw').dialog({//2020/8/21 修改交易密碼
		autoOpen:false,
		width:550,
		height:280,
		resizable:false,
		modal:true,
		draggable:false
	});
	/*editmem=$('.editmem').dialog({//2020/8/21 進入按鈕修改為修改交易密碼
		autoOpen:false,
		width:550,
		height:500,
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.editmem input[name="name"]').val('');
			$('.editmem input[name="tel"]').val('');
			$('.editmem input[name="address"]').val('');
			$('.editmem input[name="setting"]').val('');
		}
	});*/
	paymembermoney=$('.paymembermoney').dialog({//會員儲值金
		autoOpen:false,
		width:800,
		height:600,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	membermoneylist=$('.membermoneylist').dialog({//會員儲值紀錄
		autoOpen:false,
		width:550,
		height:600,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	checkdeletemommoney=$('.checkdeletemommoney').dialog({//會員儲值紀錄
		autoOpen:false,
		width:550,
		height:200,
		/*title:'系統訊息',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	outmoney=$('#outmoney').dialog({
		autoOpen:false,
		width:800,
		height:$(window).height(),
		/*title:'支出費用',*/
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			getzcounter('#outmoney','#picbizdate');
			get_outmoney_list($("#outmoney #picbizdate").val(),$('.order#order .companydata #terminalnumber').val());
			get_subtotal();
		},
		close:function(){
			$("#outmoney #picbizdate").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
			$('#outmoney select[name="zcounter"]').html('');
			$('#outmoney #moneytype').val('');
			$('#outmoney input[name="moneytype"]').val('');
			$('#outmoney input[name="moneysubtype"]').val('');
			$('#outmoney input[name="money"]').val('0');
			$('#outmoney textarea[name="remarks"]').val('');
		}
	});
	selecttype=$('.selecttype').dialog({
		autoOpen:false,
		width:$(window).width()*0.9,
		height:178,
		/*title:'選擇類別',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	setmoney=$('.setmoney').dialog({
		autoOpen:false,
		width:600,
		height:$(window).height()*7/10,
		/*title:'金額',*/
		position:{my:'top left',at:'top left',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	editpay=$('.editpay').dialog({//修改付款
		autoOpen:false,
		width:800,
		height:610,
		/*title:'修改付款',*/
		position:{my:'center center',at:'center center',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.editpay #viewwindow #cancel').trigger('click');
			$('.editpay input[name="num"]').val('');
		}
	});
	temptoinv=$('.temptoinv').dialog({//暫結視窗(開立發票選擇)
		autoOpen:false,
		width:450,
		height:220,
		/*title:'暫結視窗(開立發票選擇)',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	historypaper=$('.historypaper').dialog({
		autoOpen:false,
		width:$(window).width()/2,
		/*height:300,*/
		/*title:'列印報表',*/
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			$(".historypaper #papbizdateS").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
			$(".historypaper #papbizdateE").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
			if($('.historypaper #papbizdateS').val()==$('.historypaper #papbizdateE').val()){
				getzcounter('.historypaper','#papbizdateS');
				$('.historypaper select[name="zcounter"]').prop('disabled',false);
			}
			else{
				$('.historypaper select[name="zcounter"]').prop('disabled',true);
				$('.historypaper select[name="zcounter"]').html('<option value="allday">整個營業日</option>');
			}
		},
		close:function(){
			$(".historypaper #papbizdateS").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
			$(".historypaper #papbizdateE").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
		}
	});
	viewpaper=$('.viewpaper').dialog({
		autoOpen:false,
		width:$(window).width()-40,
		height:$(window).height()-40,
		/*title:'列印報表',*/
		position:{my:'top left',at:'top 20px left 20px',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			if($('.historypaper #papbizdateS').val()==$('.historypaper #papbizdateE').val()){
				getzcounter('.historypaper','#papbizdateS');
				$('.historypaper select[name="zcounter"]').prop('disabled',false);
			}
			else{
				$('.historypaper select[name="zcounter"]').prop('disabled',true);
				$('.historypaper select[name="zcounter"]').html('<option value="allday">整個營業日</option>');
			}
			if($('.historypaper select[name="paperlist"] option:selected').val()=='paper5'){
				$('.historypaper select[name="zcounter"]').prop('disabled',true);
			}
			else{
				//$('.historypaper select[name="zcounter"]').prop('disabled',true);
			}
		},
		close:function(){
			$(".historypaper #papbizdateS").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
			$(".historypaper #papbizdateE").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
		}
	});
	salelisthint=$('.salelisthint').dialog({
		autoOpen:false,
		width:$(window).width()/2,
		height:$(window).height(),
		/*title:'列印報表',*/
		position:{my:'top left',at:'top left',of:'body'},
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			$('.salelisthint textarea[name="hintstring"]').scrollTop($('.salelisthint textarea[name="hintstring"]')[0].scrollHeight);
		}
	});
	/*$('.order#order .inittable #outmoney').click(function(){
		outmoney.dialog('open');
		if($('#outmoney #moneytype').val()==''){
			selecttype.dialog('open');
		}
		else{
		}
	});*/
	$("#outmoney #picbizdate").datepicker();
	$("#outmoney #picbizdate").on("click", function () {
		$(this).datepicker("show");
	});
	$("#outmoney #picbizdate").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
	$("#outmoney #picbizdate").datepicker( "option", "dateFormat", "yy-mm-dd" );
	$('#outmoney #picbizdate').change(function(){
		getzcounter('#outmoney','#picbizdate');
		get_outmoney_list($("#outmoney #picbizdate").val(),$('.order#order .companydata #terminalnumber').val());
		get_subtotal();
	});
	function get_outmoney_list(bizdate,machine){
		$.ajax({
			url:'./lib/js/get.outmoney.list.php',
			method:'post',
			async:false,
			data:{'bizdate':bizdate,'machine':machine},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('#outmoney #salelist #salecontent').html(d);
			},
			error:function(e){
				console.log(e);
			}
		});
	}
	function get_subtotal(){
		$('#outmoney .out').html($('#outmoney #salelist #salecontent input[data-name="out"]').val());
		$('#outmoney .in').html($('#outmoney #salelist #salecontent input[data-name="in"]').val());
	}
	$(".historypaper #papbizdateS").datepicker();
	$(".historypaper #papbizdateS").on("click", function () {
		$(this).datepicker("show");
	});
	$(".historypaper #papbizdateS").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
	$(".historypaper #papbizdateS").datepicker( "option", "dateFormat", "yy-mm-dd" );
	$(".historypaper #papbizdateE").datepicker();
	$(".historypaper #papbizdateE").on("click", function () {
		$(this).datepicker("show");
	});
	$(".historypaper #papbizdateE").datepicker('setDate',$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(0,4)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(4,2)+"-"+$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val().substr(6,2));
	$(".historypaper #papbizdateE").datepicker( "option", "dateFormat", "yy-mm-dd" );
	$('.historypaper #papbizdateS').change(function(){
		if($('.historypaper #papbizdateS').val()==$('.historypaper #papbizdateE').val()){
			getzcounter('.historypaper','#papbizdateS');
			$('.historypaper select[name="zcounter"]').prop('disabled',false);
		}
		else{
			$('.historypaper select[name="zcounter"]').prop('disabled',true);
			$('.historypaper select[name="zcounter"]').html('<option value="allday">'+$('.historypaper select[name="zcounter"] option:eq(0)').html()+'</option>');
		}
	});
	$('.historypaper #papbizdateE').change(function(){
		if($('.historypaper #papbizdateS').val()==$('.historypaper #papbizdateE').val()){
			getzcounter('.historypaper','#papbizdateE');
			$('.historypaper select[name="zcounter"]').prop('disabled',false);
		}
		else{
			$('.historypaper select[name="zcounter"]').prop('disabled',true);
			$('.historypaper select[name="zcounter"]').html('<option value="allday">'+$('.historypaper select[name="zcounter"] option:eq(0)').html()+'</option>');
		}
	});
	var d=new Date();
	$(".editpunch #startpunch").datepicker();
	$(".editpunch #startpunch").on("click", function () {
		$(this).datepicker("show");
	});
	$(".editpunch #startpunch").datepicker('setDate',d.getFullYear()+"-"+('0'+(Number(d.getMonth())+1)).substr(-2)+"-"+d.getDate());
	$(".editpunch #startpunch").datepicker( "option", "dateFormat", "yy-mm-dd" );
	$(".editpunch #endpunch").datepicker();
	$(".editpunch #endpunch").on("click", function () {
		$(this).datepicker("show");
	});
	$(".editpunch #endpunch").datepicker('setDate',d.getFullYear()+"-"+('0'+(Number(d.getMonth())+1)).substr(-2)+"-"+d.getDate());
	$(".editpunch #endpunch").datepicker( "option", "dateFormat", "yy-mm-dd" );
	$(".editpunch #editDATE").datepicker();
	$(".editpunch #editDATE").on("click", function () {
		$(this).datepicker("show");
	});
	function getzcounter(type,input){
		$.ajax({
			url:'./getzcounter.ajax.php',
			method:'post',
			async:false,
			data:{'bizdate':$(type+' '+input).val(),'type':type},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$(type+' select[name="zcounter"]').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	}
	$('#outmoney').on('click','#moneytype',function(event){
		//oneEvent(event);
		selecttype.dialog('open');
	});
	$('.selecttype').on('click','#buttype',function(event){
		//oneEvent(event);
		var index=$('.selecttype #buttype').index(this);
		$('#outmoney #moneytype').val($(this).find('div').html());
		$('#outmoney input[name="moneytype"]').val($(this).find('#typevalue').val());
		selecttype.dialog('close');
		if(Number($('#outmoney input[name="money"]').val())<=0){
			setmoney.dialog('open');
		}
		else{
		}
	});
	$('#outmoney').on('click','input[name="money"]',function(event){
		//oneEvent(event);
		if(Number($('#outmoney input[name="money"]').val())<=0){
			$('.setmoney input[name="viewnumber"]').val('0');
		}
		else{
			$('.setmoney input[name="viewnumber"]').val($('#outmoney input[name="money"]').val());
		}
		setmoney.dialog('open');
	});
	$('.setmoney').on('click','#numbut',function(event){
		//oneEvent(event);
		if(Number($('.setmoney input[name="viewnumber"]').val())<=0){
			$('.setmoney input[name="viewnumber"]').val($(this).find('div').html());
		}
		else{
			$('.setmoney input[name="viewnumber"]').val($('.setmoney input[name="viewnumber"]').val()+$(this).find('div').html());
		}
	});
	$('.setmoney').on('click','#reset',function(event){
		//oneEvent(event);
		$('.setmoney input[name="viewnumber"]').val('0');
	});
	$('.setmoney').on('click','#send',function(event){
		//oneEvent(event);
		$('#outmoney input[name="money"]').val($('.setmoney input[name="viewnumber"]').val());
		$('.setmoney input[name="viewnumber"]').val('');
		setmoney.dialog('close');
	});
	$('#outmoney').on('click','#send',function(event){
		//oneEvent(event);
		if($('#outmoney #picbizdate').val()==''||$('#outmoney select[name="zcounter"] option:selected').length==0||$('#outmoney input[name="moneytype"]').val()==''){
			//alertmessage('請填寫營業日期、班別與選擇一樣科目。');
			$('.alertmessage #text').html('請填寫營業日期、班別與選擇一樣科目。');
			alertmessage.dialog('open');
		}
		else{
			$.ajax({
				url:'./write.AE.php',
				method:'post',
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'type':$('#outmoney input[name="aetype"]:checked').val(),'bizdate':$('#outmoney #picbizdate').val(),'zcounter':$('#outmoney select[name="zcounter"] option:selected').val(),'moneytype':$('#outmoney input[name="moneytype"]').val(),'moneytypename':$('#outmoney #moneytype').val(),'subtype':$('#outmoney input[name="moneysubtype"]').val(),'money':$('#outmoney input[name="money"]').val(),'radius':$('#outmoney input[name="radius"]:checked').val(),'remarks':$('#outmoney textarea[name="remarks"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'write.AE.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':'report'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					//console.log(d);
					//alertmessage('其他收/支費用輸入成功');
					$('.alertmessage #text').html('其他收/支費用輸入成功');
					alertmessage.dialog('open');
					outmoney.dialog('close');
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
	});
	$('#outmoney').on('click','#cancel',function(event){
		//oneEvent(event);
		$('#outmoney #moneytype').val('');
		$('#outmoney input[name="moneytype"]').val('');
		$('#outmoney input[name="moneysubtype"]').val('');
		$('#outmoney input[name="money"]').val('0');
		$('#outmoney textarea[name="remarks"]').val('');
		outmoney.dialog('close');
	});
	reason=$('.order#order #reason').dialog({//刪除已出單產品之原因
		autoOpen:false,
		width:980,
		height:500,
		/*title:'刪除原因',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	reasoninput=$('.order#order #reasoninput').dialog({//刪除已出單產品之原因(手key)
		autoOpen:false,
		width:980,
		height:200,
		/*title:'刪除原因',*/
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('#reasoninput #cancel').prop('disabled',true);
			$('#reasoninput #send').prop('disabled',true);
			$('#reasoninput input[name="reason"]').prop('disabled',true);
			reasoninput.dialog('close');
			$('#reason button').prop('disabled',false);
			$('#reasoninput #cancel').prop('disabled',false);
			$('#reasoninput #send').prop('disabled',false);
			$('#reasoninput input[name="reason"]').prop('disabled',false);
			$('#reasoninput input[name="reason"]').val('');
		}
	});
	verpsw=$('.verpsw').dialog({//補印發票之驗證密碼視窗
		autoOpen:false,
		width:500,
		height:500,
		/*title:'驗證密碼',*/
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.verpsw input[name="type"]').val('');
			$('.verpsw input[name="verpsw"]').val('');
			$('.verpsw #buttons .input:eq(0)').val('7');
			$('.verpsw #buttons .input:eq(1)').val('8');
			$('.verpsw #buttons .input:eq(2)').val('9');
			$('.verpsw #buttons .input:eq(3)').val('4');
			$('.verpsw #buttons .input:eq(4)').val('5');
			$('.verpsw #buttons .input:eq(5)').val('6');
			$('.verpsw #buttons .input:eq(6)').val('1');
			$('.verpsw #buttons .input:eq(7)').val('2');
			$('.verpsw #buttons .input:eq(8)').val('3');
			$('.verpsw #buttons .input:eq(9)').val('0');
			$('.verpsw #buttons .input:eq(10)').val('');
			$('.verpsw #buttons .input:eq(11)').val('');
			$('.verpsw #buttons .input:eq(0)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(1)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(2)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(3)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(4)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(5)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(6)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(7)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(8)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(9)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(10)').prop('disabled',true);
			$('.verpsw #buttons .input:eq(11)').prop('disabled',true);
			$('.verpsw #buttons .pre').prop('disabled',true);
			$('.verpsw #buttons .next').prop('disabled',true);
		}
	});
	container=$('.container').dialog({//手機條碼輸入視窗
		autoOpen:false,
		width:500,
		height:200,
		position:{my: 'center', at: 'top', of: window},
		/*title:'輸入載具',*/
		resizable:false,
		modal:true,
		draggable:false,
		closeOnEscape:false,
		open:function(){
			$('.container').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
		}
	});
	container2=$('.container2').dialog({//自然人憑證輸入視窗
		autoOpen:false,
		width:500,
		height:200,
		/*title:'輸入載具',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	donatewin=$('.donatewin').dialog({//愛心碼輸入視窗
		autoOpen:false,
		width:500,
		height:200,
		/*title:'輸入載具',*/
		resizable:false,
		modal:true,
		draggable:false
	});
	computemoney=$('.computemoney').dialog({//計算錢櫃金額
		autoOpen:false,
		width:700,
		height:600,
		position:{my: 'center', at: 'center', of: 'body'},
		/*title:'計算錢櫃金額',*/
		resizable:false,
		modal:true,
		draggable:false,
		close:function(){
			$('.computemoney input[type="number"]').val('0');
		}
	});
	if($('.order#order .initsetting #directlinepay').val()=='1'){
		readlinecode=$('.readlinecode').dialog({//2022/4/27 直接linepay付款串接
			autoOpen:false,
			width:500,
			height:200,
			position:{my: 'center', at: 'center', of: 'body'},
			/*title:'直接linepay付款串接',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.readlinecode').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
			},
			close:function(){
				$('.readlinecode #buttonhtml').html('');
				$('.readlinecode .qrhint').html('');
				$('.readlinecode .hintstring').html('');
				$('.readlinecode #successsale').prop('disabled',true);
				$('.readlinecode #cancelsale').prop('disabled',false);
				$('.readlinecode input[name="orderid"]').val('');
				$('.readlinecode input[name="money"]').val('');
				$('.readlinecode input[name="price"]').val('');
				$('.readlinecode input[name="inv"]').val('');
				$('.readlinecode input[name="saverowname"]').val('');
				$('.readlinecode input[name="type"]').val('');
				$('.readlinecode input[name="linecode"]').val('');
				$('.readlinecode input[name="linecode"]').attr('type','text');
			}
		});
		voidlinepay=$('.voidlinepay').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidlinepay .qrhint').css({'visibility':'visible'});
				$('.voidlinepay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidlinepay #successsale').prop('disabled',true);
				$('.voidlinepay #cancelsale').css({'display':'none'});
				$('.voidlinepay .hintstring').html('');
				dotloading=setInterval(function(){
					if($('.voidlinepay .qrhint #loading').length>0){
						if($('.voidlinepay .qrhint #loading').html().length==3){
							$('.voidlinepay .qrhint #loading').html('.');
						}
						else if($('.voidlinepay .qrhint #loading').html().length==2){
							$('.voidlinepay .qrhint #loading').html('...');
						}
						else{
							$('.voidlinepay .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
			},
			close:function(){
			}
		});
		voidsalewithlinepay=$('.voidsalewithlinepay').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidsalewithlinepay .qrhint').css({'visibility':'visible'});
				//$('.voidsalewithlinepay #retry').css({'display':'none'});
				//$('.voidsalewithlinepay #retry #time').html('');
				$('.voidsalewithlinepay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidsalewithlinepay #successsale').prop('disabled',true);
				$('.voidsalewithlinepay #cancelsale').css({'display':'none'});
				$('.voidsalewithlinepay .hintstring').html('');
				$('.voidsalewithlinepay .qrhint').html("退款處理中<span id='loading'>...</span>");
				dotloading=setInterval(function(){
					if($('.voidsalewithlinepay .qrhint #loading').length>0){
						if($('.voidsalewithlinepay .qrhint #loading').html().length==3){
							$('.voidsalewithlinepay .qrhint #loading').html('.');
						}
						else if($('.voidsalewithlinepay .qrhint #loading').html().length==2){
							$('.voidsalewithlinepay .qrhint #loading').html('...');
						}
						else{
							$('.voidsalewithlinepay .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
				var res='';
				res=directlinepay_refund($('.order#order .companydata #company').val(),$('.order#order .companydata #story').val(),$('.order#order .directlinepay #url').val(),$('.order#order .directlinepay #channelid').val(),$('.order#order .directlinepay #channelsecret').val(),$('.voidsalewithlinepay input[name="saleno"]').val());
				res.done(function(res){
					if(typeof res['returnCode']!=='undefined'&&(res['returnCode']=='0000'||res['returnCode']=='1165')){//2022/5/9 code=1165(交易已進行退款)；因此做為成功交易//成功
						$('.voidsalewithlinepay #successsale').prop('disabled',false);
						$('.voidsalewithlinepay .hintstring').html(res['returnMessageC']);
					}
					else if(typeof res['statusText']!=='undefined'){//等待逾時
						$('.voidsalewithlinepay #cancelsale').css({'display':'block'});
						$('.voidsalewithlinepay .hintstring').html(res['statusText']);
					}
					else{//失敗
						$('.voidsalewithlinepay #cancelsale').css({'display':'block'});
						$('.voidsalewithlinepay .hintstring').html(res['returnMessageC']);
					}
					$('.voidsalewithlinepay .qrhint').css({'visibility':'hidden'});
					clearInterval(dotloading);
				});
			},
			close:function(){
				$('.voidsalewithlinepay input[name="type"]').val('');//修改帳單>>editlist、作廢帳單>>void、依發票作廢帳單>>voidbyinv
				$('.voidsalewithlinepay input[name="saleno"]').val('');//刷卡紀錄是否符合優惠活動
				$('.voidsalewithlinepay input[name="money"]').val('');//刷卡金額
			}
		});
	}
	else{
	}
	if($('.order#order .initsetting #jkos').val()=='1'){
		readjkoscode=$('.readjkoscode').dialog({//2022/10/6 街口付款串接
			autoOpen:false,
			width:500,
			height:250,
			position:{my: 'center', at: 'center', of: 'body'},
			/*title:'街口付款串接',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.readjkoscode').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.readjkoscode input[name="jkoscode"]').attr('type','text');
				$('.readjkoscode input[name="jkoscode"]').val('');
			},
			close:function(){
				$('.readjkoscode #buttonhtml').html('');
				$('.readjkoscode .payTitle').html('');
				$('.readjkoscode .payqrhint').html('');
				$('.readjkoscode .payhintstring').html('');
				$('.readjkoscode .cancelTitle').html('');
				$('.readjkoscode .cancelTitle').css({'display':'none'});
				$('.readjkoscode .cancelqrhint').html('');
				$('.readjkoscode .cancelqrhint').css({'display':'none'});
				$('.readjkoscode .cancelhintstring').html('');
				$('.readjkoscode .cancelhintstring').css({'display':'none'});
				$('.readjkoscode #successsale').prop('disabled',true);
				$('.readjkoscode #successsale').css({'display':'block'});
				$('.readjkoscode #checksale').prop('disabled',true);
				$('.readjkoscode #checksale').css({'display':'none'});
				$('.readjkoscode #cancelsale').prop('disabled',true);
				$('.readjkoscode #cancelsale').css({'display':'none'});
				$('.readjkoscode #closejkos').prop('disabled',false);
				$('.readjkoscode input[name="orderid"]').val('');//2022/10/19 POS端交易號，取消使用，需紀錄資料庫
				$('.readjkoscode input[name="tradeno"]').val('');//2022/10/19 街口端交易號，退款使用，需紀錄資料庫
				$('.readjkoscode input[name="money"]').val('');
				$('.readjkoscode input[name="price"]').val('');
				$('.readjkoscode input[name="carrier"]').val('');
				$('.readjkoscode input[name="tradeno"]').val('');
				$('.readjkoscode input[name="inv"]').val('');
				$('.readjkoscode input[name="saverowname"]').val('');
				$('.readjkoscode input[name="type"]').val('');
				$('.readjkoscode input[name="linecode"]').val('');
				$('.readjkoscode input[name="linecode"]').attr('type','text');
			}
		});
		voidjkospay=$('.voidjkospay').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidjkospay .qrhint').css({'visibility':'visible'});
				$('.voidjkospay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidjkospay input[name="orderid"]').val('');
				$('.voidjkospay #successsale').prop('disabled',true);
				$('.voidjkospay #successsale').css({'display':'block'});
				$('.voidjkospay #checksale').prop('disabled',true);
				$('.voidjkospay #checksale').css({'display':'none'});
				$('.voidjkospay #cancelsale').css({'display':'none'});
				$('.voidjkospay .hintstring').html('');
				dotloading=setInterval(function(){
					if($('.voidjkospay .qrhint #loading').length>0){
						if($('.voidjkospay .qrhint #loading').html().length==3){
							$('.voidjkospay .qrhint #loading').html('.');
						}
						else if($('.voidjkospay .qrhint #loading').html().length==2){
							$('.voidjkospay .qrhint #loading').html('...');
						}
						else{
							$('.voidjkospay .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
			},
			close:function(){
			}
		});
		voidsalewithjkospay=$('.voidsalewithjkospay').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidsalewithjkospay .qrhint').css({'visibility':'visible'});
				//$('.voidsalewithjkospay #retry').css({'display':'none'});
				//$('.voidsalewithjkospay #retry #time').html('');
				$('.voidsalewithjkospay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidsalewithjkospay #successsale').prop('disabled',true);
				$('.voidsalewithjkospay #cancelsale').css({'display':'none'});
				$('.voidsalewithjkospay .hintstring').html('');
				$('.voidsalewithjkospay .qrhint').html("退款處理中<span id='loading'>...</span>");
				dotloading=setInterval(function(){
					if($('.voidsalewithjkospay .qrhint #loading').length>0){
						if($('.voidsalewithjkospay .qrhint #loading').html().length==3){
							$('.voidsalewithjkospay .qrhint #loading').html('.');
						}
						else if($('.voidsalewithjkospay .qrhint #loading').html().length==2){
							$('.voidsalewithjkospay .qrhint #loading').html('...');
						}
						else{
							$('.voidsalewithjkospay .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
				var res='';
				res=jkos_Refund($('.order#order .jkos #url').val(),$('.order#order .jkos #systemname').val(),$('.order#order .jkos #merchantkey').val(),$('.order#order .jkos #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),$('.voidsalewithjkospay input[name="saleno"]').val(),$('.voidsalewithjkospay input[name="tradeno"]').val(),$('.voidsalewithjkospay input[name="money"]').val());
				res.done(function(res){
					if(typeof res['StatusCode']!=='undefined'&&(res['StatusCode']=='000'||res['StatusCode']=='925'||res['StatusCode']=='922')){//2022/5/9 code=925(交易重複退款、已在街口端退款)、code=922(退款總金額已超過原付款交易金額[含多次退款])；因此做為成功交易//成功交易
						$('.voidsalewithjkospay #successsale').prop('disabled',false);
						$('.voidsalewithjkospay .hintstring').html(res['StatusDesc']);
					}
					else if(typeof res['statusText']!=='undefined'){//等待逾時
						//2022/10/20 預計至少查詢一次，才可關閉視窗重新退款
						$('.voidsalewithjkospay #successsale').css({'display':'none'});
						$('.voidsalewithjkospay #checksale').prop('disabled',false);
						$('.voidsalewithjkospay #checksale').css({'display':'block'});
						$('.voidsalewithjkospay .hintstring').html(res['statusText']);
					}
					else{//失敗
						$('.voidsalewithjkospay #cancelsale').css({'display':'block'});
						$('.voidsalewithjkospay .hintstring').html(res['StatusDesc']);
					}
					$('.voidsalewithjkospay .qrhint').css({'visibility':'hidden'});
					clearInterval(dotloading);
				});
			},
			close:function(){
				$('.voidsalewithjkospay input[name="type"]').val('');//修改帳單>>editlist、作廢帳單>>void、依發票作廢帳單>>voidbyinv
				$('.voidsalewithjkospay input[name="saleno"]').val('');//POS端交易序號
				$('.voidsalewithjkospay input[name="tradeno"]').val('');//街口端交易序號
				$('.voidsalewithjkospay input[name="money"]').val('');//支付金額
			}
		});
	}
	else{
	}
	if($('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28
		readpxpaypluscode=$('.readpxpaypluscode').dialog({//2022/10/6 全支付串接
			autoOpen:false,
			width:500,
			height:250,
			position:{my: 'center', at: 'center', of: 'body'},
			/*title:'全支付串接',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.readpxpaypluscode').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.readpxpaypluscode input[name="pxpaypluscode"]').attr('type','text');
				$('.readpxpaypluscode input[name="pxpaypluscode"]').val('');
			},
			close:function(){
				$('.readpxpaypluscode #buttonhtml').html('');
				$('.readpxpaypluscode .payTitle').html('');
				$('.readpxpaypluscode .payqrhint').html('');
				$('.readpxpaypluscode .payhintstring').html('');
				$('.readpxpaypluscode .cancelTitle').html('');
				$('.readpxpaypluscode .cancelTitle').css({'display':'none'});
				$('.readpxpaypluscode .cancelqrhint').html('');
				$('.readpxpaypluscode .cancelqrhint').css({'display':'none'});
				$('.readpxpaypluscode .cancelhintstring').html('');
				$('.readpxpaypluscode .cancelhintstring').css({'display':'none'});
				$('.readpxpaypluscode #successsale').prop('disabled',true);
				$('.readpxpaypluscode #successsale').css({'display':'block'});
				$('.readpxpaypluscode #checksale').prop('disabled',true);
				$('.readpxpaypluscode #checksale').css({'display':'none'});
				$('.readpxpaypluscode #cancelsale').prop('disabled',true);
				$('.readpxpaypluscode #cancelsale').css({'display':'none'});
				$('.readpxpaypluscode #closepxpayplus').prop('disabled',false);
				$('.readpxpaypluscode input[name="orderid"]').val('');//2022/10/19 POS端交易號，取消使用，需紀錄資料庫
				$('.readpxpaypluscode input[name="tradeno"]').val('');//2022/10/19 全支付交易號，退款使用，需紀錄資料庫
				$('.readpxpaypluscode input[name="money"]').val('');
				$('.readpxpaypluscode input[name="price"]').val('');
				$('.readpxpaypluscode input[name="carrier"]').val('');
				$('.readpxpaypluscode input[name="tradeno"]').val('');
				$('.readpxpaypluscode input[name="inv"]').val('');
				$('.readpxpaypluscode input[name="saverowname"]').val('');
				$('.readpxpaypluscode input[name="type"]').val('');
				$('.readpxpaypluscode input[name="linecode"]').val('');
				$('.readpxpaypluscode input[name="linecode"]').attr('type','text');
			}
		});
		voidpxpaypluspay=$('.voidpxpaypluspay').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidpxpaypluspay .qrhint').css({'visibility':'visible'});
				$('.voidpxpaypluspay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidpxpaypluspay input[name="orderid"]').val('');
				$('.voidpxpaypluspay #successsale').prop('disabled',true);
				$('.voidpxpaypluspay #successsale').css({'display':'block'});
				$('.voidpxpaypluspay #checksale').prop('disabled',true);
				$('.voidpxpaypluspay #checksale').css({'display':'none'});
				$('.voidpxpaypluspay #cancelsale').css({'display':'none'});
				$('.voidpxpaypluspay .hintstring').html('');
				dotloading=setInterval(function(){
					if($('.voidpxpaypluspay .qrhint #loading').length>0){
						if($('.voidpxpaypluspay .qrhint #loading').html().length==3){
							$('.voidpxpaypluspay .qrhint #loading').html('.');
						}
						else if($('.voidpxpaypluspay .qrhint #loading').html().length==2){
							$('.voidpxpaypluspay .qrhint #loading').html('...');
						}
						else{
							$('.voidpxpaypluspay .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
			},
			close:function(){
			}
		});
		voidsalewithpxpaypluspay=$('.voidsalewithpxpaypluspay').dialog({
			autoOpen:false,
			width:450,
			height:300,
			/*title:'系統訊息',*/
			resizable:false,
			modal:true,
			draggable:false,
			closeOnEscape:false,
			open:function(){
				$('.voidsalewithpxpaypluspay .qrhint').css({'visibility':'visible'});
				//$('.voidsalewithpxpaypluspay #retry').css({'display':'none'});
				//$('.voidsalewithpxpaypluspay #retry #time').html('');
				$('.voidsalewithpxpaypluspay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidsalewithpxpaypluspay #successsale').prop('disabled',true);
				$('.voidsalewithpxpaypluspay #cancelsale').css({'display':'none'});
				$('.voidsalewithpxpaypluspay .hintstring').html('');
				$('.voidsalewithpxpaypluspay .qrhint').html("退款處理中<span id='loading'>...</span>");
				dotloading=setInterval(function(){
					if($('.voidsalewithpxpaypluspay .qrhint #loading').length>0){
						if($('.voidsalewithpxpaypluspay .qrhint #loading').html().length==3){
							$('.voidsalewithpxpaypluspay .qrhint #loading').html('.');
						}
						else if($('.voidsalewithpxpaypluspay .qrhint #loading').html().length==2){
							$('.voidsalewithpxpaypluspay .qrhint #loading').html('...');
						}
						else{
							$('.voidsalewithpxpaypluspay .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
				var res='';
				var datetime=new Date();
				var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
				$('.voidsalewithpxpaypluspay input[name="orderid"]').val(orderid);
				res=pxpayplus_Refund($('.order#order .pxpayplus #url').val(),$('.order#order .pxpayplus #merchantcode').val(),$('.order#order .pxpayplus #secrectkey').val(),$('.order#order .companydata #story').val(),$('.order#order .pxpayplus #pxstorecode').val(),$('.order#order .companydata #storyname').val(),orderid,$('.voidsalewithpxpaypluspay input[name="saleno"]').val(),$('.voidsalewithpxpaypluspay input[name="tradeno"]').val(),$('.voidsalewithpxpaypluspay input[name="money"]').val(),$('.order#order .pxpayplus #item_json').val());
				res.done(function(res){
					if(typeof res['status_code']!=='undefined'&&(res['status_code']=='0000'||res['status_code']=='PT0006')){//2022/11/7 視為已退款成功(已退款金額超出付款金額上限)//成功交易
						$('.voidsalewithpxpaypluspay #successsale').prop('disabled',false);
						$('.voidsalewithpxpaypluspay .hintstring').html(res['status_message']);
					}
					else if(typeof res['statusText']!=='undefined'){//等待逾時
						//2022/10/20 預計至少查詢一次，才可關閉視窗重新退款
						$('.voidsalewithpxpaypluspay #successsale').css({'display':'none'});
						$('.voidsalewithpxpaypluspay #checksale').prop('disabled',false);
						$('.voidsalewithpxpaypluspay #checksale').css({'display':'block'});
						$('.voidsalewithpxpaypluspay .hintstring').html(res['statusText']);
					}
					else{//失敗
						$('.voidsalewithpxpaypluspay #cancelsale').css({'display':'block'});
						$('.voidsalewithpxpaypluspay .hintstring').html(res['status_message']);
					}
					$('.voidsalewithpxpaypluspay .qrhint').css({'visibility':'hidden'});
					clearInterval(dotloading);
				});
			},
			close:function(){
				$('.voidsalewithpxpaypluspay input[name="type"]').val('');//修改帳單>>editlist、作廢帳單>>void、依發票作廢帳單>>voidbyinv
				$('.voidsalewithpxpaypluspay input[name="saleno"]').val('');//POS端交易序號
				$('.voidsalewithpxpaypluspay input[name="tradeno"]').val('');//全支付交易序號
				$('.voidsalewithpxpaypluspay input[name="money"]').val('');//支付金額
			}
		});
	}
	else{
	}
	$(document).resize(function(){
		if($(window).width()==1920){
			spend.dialog('option','width',450);
			spend.dialog('option','height',480);
		}
		else if($(window).width()==1366){
			spend.dialog('option','width',450);
			spend.dialog('option','height',480);
		}
		else if($(window).width()==1280){
			spend.dialog('option','width',450);
			spend.dialog('option','height',480);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			spend.dialog('option','width',450);
			spend.dialog('option','height',480);
		}
		else if($(window).width()==1024){
			spend.dialog('option','width',450);
			spend.dialog('option','height',480);
		}

		if($(window).width()==1920){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()==1366){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()==1280){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}
		else if($(window).width()==1024){
			pointtreememdata.dialog('option','width',450);
			pointtreememdata.dialog('option','height',300);
		}

		if($(window).width()==1920){
			dblock.dialog('option','width',450);
			dblock.dialog('option','height',300);
		}
		else if($(window).width()==1366){
			dblock.dialog('option','width',(450));
			dblock.dialog('option','height',(220));
		}
		else if($(window).width()==1280){
			dblock.dialog('option','width',450);
			dblock.dialog('option','height',220);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			dblock.dialog('option','width',450);
			dblock.dialog('option','height',220);
		}
		else if($(window).width()==1024){
			dblock.dialog('option','width',450);
			dblock.dialog('option','height',220);
		}

		if($(window).width()==1920){
			sysmeg.dialog('option','width',450);
			sysmeg.dialog('option','height',300);
		}
		else if($(window).width()==1366){
			sysmeg.dialog('option','width',(450));
			sysmeg.dialog('option','height',(220));
		}
		else if($(window).width()==1280){
			sysmeg.dialog('option','width',450);
			sysmeg.dialog('option','height',220);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			sysmeg.dialog('option','width',450);
			sysmeg.dialog('option','height',220);
		}
		else if($(window).width()==1024){
			sysmeg.dialog('option','width',450);
			sysmeg.dialog('option','height',220);
		}

		if($(window).width()==1920){
			sysmeg4.dialog('option','width',450);
			sysmeg4.dialog('option','height',300);
		}
		else if($(window).width()==1366){
			sysmeg4.dialog('option','width',(450));
			sysmeg4.dialog('option','height',(220));
		}
		else if($(window).width()==1280){
			sysmeg4.dialog('option','width',450);
			sysmeg4.dialog('option','height',220);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			sysmeg4.dialog('option','width',450);
			sysmeg4.dialog('option','height',220);
		}
		else if($(window).width()==1024){
			sysmeg4.dialog('option','width',450);
			sysmeg4.dialog('option','height',220);
		}

		if($(window).width()==1920){
			sysmeg5.dialog('option','width',450);
			sysmeg5.dialog('option','height',300);
		}
		else if($(window).width()==1366){
			sysmeg5.dialog('option','width',(450));
			sysmeg5.dialog('option','height',(220));
		}
		else if($(window).width()==1280){
			sysmeg5.dialog('option','width',450);
			sysmeg5.dialog('option','height',220);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			sysmeg5.dialog('option','width',450);
			sysmeg5.dialog('option','height',220);
		}
		else if($(window).width()==1024){
			sysmeg5.dialog('option','width',450);
			sysmeg5.dialog('option','height',220);
		}

		if($(window).width()==1920){
			exitsys.dialog('option','width',450);
			exitsys.dialog('option','height',300);
		}
		else if($(window).width()==1366){
			exitsys.dialog('option','width',450);
			exitsys.dialog('option','height',220);
		}
		else if($(window).width()==1280){
			exitsys.dialog('option','width',450);
			exitsys.dialog('option','height',220);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			exitsys.dialog('option','width',450);
			exitsys.dialog('option','height',220);
		}
		else if($(window).width()==1024){
			exitsys.dialog('option','width',450);
			exitsys.dialog('option','height',220);
		}

		if($(window).width()==1920){
			setperson.dialog('option','width',1044);
			setperson.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			setperson.dialog('option','width',(1366*0.63-6.4-72.3));
			setperson.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			setperson.dialog('option','width',(1280*0.63-72.3));
			setperson.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			setperson.dialog('option','width',($(window).width()*0.63-72.3));
			setperson.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			setperson.dialog('option','width',1024);
			setperson.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			setperson.dialog('option','width',$(window).width());
			setperson.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			taste2.dialog('option','width',1044);
			taste2.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			taste2.dialog('option','width',(1366*0.63-6.4-72.3));
			taste2.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			taste2.dialog('option','width',(1280*0.63-72.3));
			taste2.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			taste2.dialog('option','width',($(window).width()*0.63-72.3));
			taste2.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			taste2.dialog('option','width',1024);
			taste2.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			taste2.dialog('option','width',$(window).width());
			taste2.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			result.dialog('option','width',1920);
			result.dialog('option','height',1080);
		}
		else if($(window).width()==1366){
			result.dialog('option','width',1366);
			result.dialog('option','height',768);
		}
		else if($(window).width()==1280){
			result.dialog('option','width',1280);
			result.dialog('option','height',$(window).height());
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			result.dialog('option','width',$(window).width());
			result.dialog('option','height',$(window).height());
		}
		else if($(window).width()==1024){
			result.dialog('option','width',1024);
			result.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			result.dialog('option','width',$(window).width());
			result.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			itemdis.dialog('option','width',1044);
			itemdis.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			itemdis.dialog('option','width',1024);
			itemdis.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			itemdis.dialog('option','width',1024);
			itemdis.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			itemdis.dialog('option','width',1024);
			itemdis.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()==1024){
			itemdis.dialog('option','width',1024);
			itemdis.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			itemdis.dialog('option','width',$(window).width());
			itemdis.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			change.dialog('option','width',450);
			change.dialog('option','height',400);
		}
		else if($(window).width()==1366){
			change.dialog('option','width',450);
			change.dialog('option','height',400);
		}
		else if($(window).width()==1280){
			change.dialog('option','width',450);
			change.dialog('option','height',400);
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			change.dialog('option','width',450);
			change.dialog('option','height',400);
		}
		else if($(window).width()==1024){
			change.dialog('option','width',450);
			change.dialog('option','height',400);
		}

		if($(window).width()==1920){
			setchange.dialog('option','width',1044);
			setchange.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			setchange.dialog('option','width',(1366*0.63-6.4-72.3));
			setchange.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			setchange.dialog('option','width',(1280*0.63-72.3));
			setchange.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			setchange.dialog('option','width',($(window).width()*0.63-72.3));
			setchange.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			setchange.dialog('option','width',1024);
			setchange.dialog('option','height',(768*0.9-16));
		}
		else{//詭異規格
			setchange.dialog('option','width',$(window).width());
			setchange.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			oinv.dialog('option','width',1044);
			oinv.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			oinv.dialog('option','width',(1366*0.63-6.4-72.3));
			oinv.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			oinv.dialog('option','width',(1280*0.63-72.3));
			oinv.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			oinv.dialog('option','width',($(window).width()*0.63-72.3));
			oinv.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			oinv.dialog('option','width',1024);
			oinv.dialog('option','height',(768*0.9-16));
		}
		else{//詭異規格
			oinv.dialog('option','width',$(window).width());
			oinv.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			cancelinv.dialog('option','width',1044);
			cancelinv.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			cancelinv.dialog('option','width',(1366*0.63-6.4-72.3));
			cancelinv.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			cancelinv.dialog('option','width',(1280*0.63-72.3));
			cancelinv.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			cancelinv.dialog('option','width',($(window).width()*0.63-72.3));
			cancelinv.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			cancelinv.dialog('option','width',1024);
			cancelinv.dialog('option','height',(768*0.9-16));
		}

		if($(window).width()==1920){
			salelist.dialog('option','width',1044);
			salelist.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			salelist.dialog('option','width',1360);
			salelist.dialog('option','height',768);
		}
		else if($(window).width()==1280){
			salelist.dialog('option','width',1280);
			salelist.dialog('option','height',$(window).height());
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			salelist.dialog('option','width',$(window).width());
			salelist.dialog('option','height',$(window).height());
		}
		else if($(window).width()==1024){
			salelist.dialog('option','width',1024);
			salelist.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			salelist.dialog('option','width',$(window).width());
			salelist.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			salevoid.dialog('option','width',1044);
			salevoid.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			salevoid.dialog('option','width',1360);
			salevoid.dialog('option','height',768);
		}
		else if($(window).width()==1280){
			salevoid.dialog('option','width',1280);
			salevoid.dialog('option','height',$(window).height());
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			salevoid.dialog('option','width',$(window).width());
			salevoid.dialog('option','height',$(window).height());
		}
		else if($(window).width()==1024){
			salevoid.dialog('option','width',1024);
			salevoid.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			salevoid.dialog('option','width',$(window).width());
			salevoid.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			viewtemp.dialog('option','width',1044);
			viewtemp.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			viewtemp.dialog('option','width',1360);
			viewtemp.dialog('option','height',768);
		}
		else if($(window).width()==1280){
			viewtemp.dialog('option','width',1280);
			viewtemp.dialog('option','height',$(window).height());
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			viewtemp.dialog('option','width',$(window).width());
			viewtemp.dialog('option','height',$(window).height());
		}
		else if($(window).width()==1024){
			viewtemp.dialog('option','width',1024);
			viewtemp.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			viewtemp.dialog('option','width',$(window).width());
			viewtemp.dialog('option','height',$(window).height());
		}
		
		if($(window).width()==1920){
			tabinput.dialog('option','width',1044);
			tabinput.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			tabinput.dialog('option','width',(1366*0.63-6.4-72.3));
			tabinput.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			tabinput.dialog('option','width',(1280*0.63-72.3));
			tabinput.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			tabinput.dialog('option','width',($(window).width()*0.63-72.3));
			tabinput.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			tabinput.dialog('option','width',1024);
			tabinput.dialog('option','height',(768*0.9-16));
		}
		else{//詭異規格
			tabinput.dialog('option','width',$(window).width());
			tabinput.dialog('option','height',$(window).height());
		}
		
		if($(window).width()==1920){
			openmoney.dialog('option','width',1044);
			openmoney.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			openmoney.dialog('option','width',(1366*0.63-6.4-72.3));
			openmoney.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			openmoney.dialog('option','width',(1280*0.63-72.3));
			openmoney.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			openmoney.dialog('option','width',($(window).width()*0.63-72.3));
			openmoney.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			openmoney.dialog('option','width',1024);
			openmoney.dialog('option','height',(768*0.9-16));
		}
		else{//詭異規格
			openmoney.dialog('option','width',$(window).width());
			openmoney.dialog('option','height',$(window).height());
		}

		if($(window).width()==1920){
			meminput.dialog('option','width',1044);
			meminput.dialog('option','height',966);
		}
		else if($(window).width()==1366){
			meminput.dialog('option','width',(1366*0.63-6.4-72.3));
			meminput.dialog('option','height',(768*0.9-16));
		}
		else if($(window).width()==1280){
			meminput.dialog('option','width',(1280*0.63-72.3));
			meminput.dialog('option','height',(800*0.9-16));
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			meminput.dialog('option','width',($(window).width()*0.63-72.3));
			meminput.dialog('option','height',($(window).height()*0.9-16));
		}
		else if($(window).width()==1024){
			meminput.dialog('option','width',1024);
			meminput.dialog('option','height',$(window).height());
		}
		else{//詭異規格
			meminput.dialog('option','width',$(window).width());
			meminput.dialog('option','height',$(window).height());
		}
	});
	var logouttime=$('.order#order .initsetting #changeclose').val();
	var tim1;
	if($('.order#order .companydata #isopen').val()=='1'){
		$('.order#order #MemberBill #billfun #billfun1button').prop('disabled',true);
		$('.order#order #MemberBill #billfun #billfun2button').trigger('click');
		//$billfun.tabs('option','disabled',[0]);
		//$billfun.tabs('option','active',[1]);
	}
	else{
	}
	function timer1(){//待機逾時後，跳轉至待機畫面
		logouttime--;
		$('.changehint #timehint #time').html(logouttime);
			if(logouttime==0){
				/*if($('.order#order .initsetting #controltable').val()=='1'){
					if($('.order#order .companydata #submachine').length>0){
						location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					}
					else{
						if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
							location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
						}
						else{
							location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
						}
					}
				}
				else{
					//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					change.dialog('close');
					if(viewtemp.dialog('isOpen')){
						viewtemp.dialog('close');
						$('.order#order #list #funbox #view').trigger('click');
					}
					else{
					}
				}*/
				change.dialog('close');
				if(viewtemp.dialog('isOpen')){
					viewtemp.dialog('close');
					$('.order#order #banner #detail #tw #view').trigger('click');
				}
				else{
				}
			}
	}
	/*groupset=$('.order#order .groupset').dialog({
		autoOpen:false,
		title:'套餐選項',
		position:{my:'right bottom',at:'right bottom',of:'body'},
		resizable:false,
		modal:true,
		draggable:false
	});
	if($(window).width()==1920){
		groupset.dialog('option','width',1044);
		groupset.dialog('option','height',966);
	}
	else if($(window).width()==1366){
		groupset.dialog('option','width',(1366*0.55-6.4));
		groupset.dialog('option','height',(768*0.9));
	}*/
	$('.order#order #banner #detail').on('click','.viewtotal',function(event){
		//oneEvent(event);
		//$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val();
		var total=0;
		var dis=0;
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		$.each($('.order#order #tabs4 form[data-id="listform"] .label'),function(index,value){
			total=Number(total)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
			dis=Number(dis)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
		});
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			total=roundfun(total,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			total=ceilfun(total,precision);
		}
		else{//無條件捨去
			total=floorfun(total,precision);
		}
		//console.log(total);
		$('.spend #initspend').html(total);
		$('.spend #disspend').html(dis);
		if($('.order#order .initsetting #comfloor').val()=='1'){
			if(Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())>Number($('.spend #spend').html())){
				$('.spend #difffloor').html(Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(total));
			}
			else{
				$('.spend #difffloor').html('0');
			}
		}
		else{
			if(Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())>Number($('.order#order #banner #detail .viewtotal').val())){
				$('.spend #difffloor').html(Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number($('.order#order #banner #detail .viewtotal').val()));
			}
			else{
				$('.spend #difffloor').html('0');
			}
		}
		$('.spend #spend').html($('.order#order #banner #detail .viewtotal').val());
		if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'){
			if(Number($('.spend #difffloor').html())>0){
				$('.spend #charge').html((Number($('.spend #spend').html())+Number($('.spend #difffloor').html()))*Number($('.order#order .initsetting #chargenumber').val())/100);
			}
			else{
				if($('.order#order .initsetting #chargeeq').val()=='1'){
					$('.spend #charge').html(Number(total)*Number($('.order#order .initsetting #chargenumber').val())/100);
				}
				else{
					$('.spend #charge').html((Number(total)-Number(dis))*Number($('.order#order .initsetting #chargenumber').val())/100);
				}
			}
			/*設定檔內可設定使用何種進位*/
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.spend #charge').html( roundfun($('.spend #charge').html(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.spend #charge').html( ceilfun($('.spend #charge').html(),precision));
			}
			else{//無條件捨去
				$('.spend #charge').html( floorfun($('.spend #charge').html(),precision));
			}
		}
		else{
			$('.spend #charge').html('0');
		}
		$.ajax({
			url:'./lib/js/getnowcounter.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				var temp=d.split(';');
				$('.spend #nowbizdate').html(temp[0]);
				$('.spend #nowzcounter').html(temp[1]);
				$('.computemoney #sendbox input[name="bizdate"]').val(temp[0]);
				$('.computemoney #sendbox input[name="zcounter"]').val(temp[1]);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$('.spend #tempsum').html(Number($('.spend #charge').html())+Number($('.spend #spend').html())+Number($('.spend #difffloor').html()));
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.spend #tempsum').html( roundfun($('.spend #tempsum').html(),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.spend #tempsum').html( ceilfun($('.spend #tempsum').html(),precision));
		}
		else{//無條件捨去
			$('.spend #tempsum').html( floorfun($('.spend #tempsum').html(),precision));
		}

		//2022/8/4 ubereats串接 檢查狀態
		/*if($('.initsetting #openubereats').val()=='1'){//開啟串接
			$.ajax({
				url:'./lib/api/ubereats/check_storeid.php',
				method:'post',
				async:false,
				dataType:'html',
				success:function(d){
					//console.log(d);
					if(d=='yes'){
						$('.spend ')
					}
					else{
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
		}*/

		spend.dialog('open');
	});
	$('.spend').on('click','.closesysmeg',function(event){
		//oneEvent(event);
		spend.dialog('close');
	});
	$(document).on('keypress',document,function(event){
		$('.order#order #banner #tw input[name="psw"]').val($('.order#order #banner #tw input[name="psw"]').val()+(event.which-48));
	});
	$('.order#order #MemberBill #tabs1').on('click','#persons',function(event){
		//oneEvent(event);
		setperson.dialog('open');
	});
	$('.setperson #buttons').on('click','.input',function(event){
		//oneEvent(event);
		if($('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val()=='0'){
			$('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val($(this).val());
		}
		else{
			$('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val($('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val()+$(this).val());
		}
	});
	$('.setperson #buttons').on('click','#back',function(event){
		//oneEvent(event);
		if($('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val().length==1){
			$('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val('0');
		}
		else{
			$('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val($('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val().substr(0,($('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val().length-1)));
		}
	});
	$('.setperson #buttons').on('click','#ac',function(event){
		//oneEvent(event);
		$('.setperson #view input[name="'+$('.setperson #buttons input[name="tag"]').val()+'"]').val('0');
	});
	$('.setperson #view').on('click','input[data-id="person"]',function(event){
		//oneEvent(event);
		$('.setperson #view input[data-id="person"]').css({'background-color':'#fbf4ec'});
		$(this).css({'background-color':'#ffffff'});
		$('.setperson #buttons input[name="tag"]').val($(this).prop('name'));
	});
	$('.setperson #buttons').on('click','#submit',function(event){
		//oneEvent(event);
		var ttlperson=0;
		var flooramt=0;
		if($('.setperson #view input[name="persons1"]').length>0){
			ttlperson=parseInt(ttlperson)+parseInt($('.setperson #view input[name="persons1"]').val());
			$('.order#order #tabs4 form[data-id="listform"] input[name="person1"]').val($('.setperson #view input[name="persons1"]').val());
			flooramt=Number(flooramt)+Number(parseInt($('.setperson #view input[name="persons1"]').val())*Number($('.setperson #view input[name="personfloor1"]').val()));
		}
		else{
		}
		if($('.setperson #view input[name="persons2"]').length>0){
			ttlperson=parseInt(ttlperson)+parseInt($('.setperson #view input[name="persons2"]').val());
			$('.order#order #tabs4 form[data-id="listform"] input[name="person2"]').val($('.setperson #view input[name="persons2"]').val());
			flooramt=Number(flooramt)+Number(parseInt($('.setperson #view input[name="persons2"]').val())*Number($('.setperson #view input[name="personfloor2"]').val()));
		}
		else{
		}
		if($('.setperson #view input[name="persons3"]').length>0){
			ttlperson=parseInt(ttlperson)+parseInt($('.setperson #view input[name="persons3"]').val());
			$('.order#order #tabs4 form[data-id="listform"] input[name="person3"]').val($('.setperson #view input[name="persons3"]').val());
			flooramt=Number(flooramt)+Number(parseInt($('.setperson #view input[name="persons3"]').val())*Number($('.setperson #view input[name="personfloor3"]').val()));
		}
		else{
		}
		$('.order#order #MemberBill #tabs1 #persons').val(ttlperson);
		$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val(flooramt);
		setperson.dialog('close');
	});
	$('.setperson #buttons').on('click','#cancel',function(event){
		//oneEvent(event);
		/*$('.setperson #view input[data-id="person"]').css({'background-color':'#fbf4ec'});
		$(this).css({'background-color':'#ffffff'});
		$('.setperson #buttons input[name="tag"]').val($(this).prop('name'));*/
		/*回復原始輸入之人數*/
		setperson.dialog('close');
	});
	$('.order#order #MemberBill #list #funbox').on('keypress','.quickorder',function(event){
		if(event.which==13){
			if($('.order#order .initsetting #quickorderbarlength').val()!='0'&&$('.order#order .initsetting #quickorderlength').val()!=0&&(($('.order#order #MemberBill #list #funbox .quickorder').val().length==13&&($('.order#order #MemberBill #list #funbox .quickorder').val().substr(0,1)=='2'||$('.order#order #MemberBill #list #funbox .quickorder').val().substr(0,2)=='02'))||($('.order#order #MemberBill #list #funbox .quickorder').val().length==12&&$('.order#order #MemberBill #list #funbox .quickorder').val().substr(0,1)=='2'))){
				var inumber=$('.order#order #MemberBill #list #funbox .quickorder').val().substr($('.order#order .initsetting #quickorderstart').val(),$('.order#order .initsetting #quickorderlength').val());
				var money=parseInt($('.order#order #MemberBill #list #funbox .quickorder').val().substr($('.order#order .initsetting #quickmoneystart').val(),$('.order#order .initsetting #quickmoneylength').val()));
			}
			else{
				var inumber=$('.order#order #MemberBill #list #funbox .quickorder').val();
			}
			if($('.order#order #MemberBill #list #funbox .quickorder').val()){
				$.ajax({
					url:'./lib/js/checklimit.ajax.php',
					method:'post',
					data:{'inumber':inumber,'machinetype':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					async:false,
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'checklimit.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(d=='fail'){
							//console.log('數量已滿。');
						}
						else if(d=='error'){
							//console.log('輸入錯誤。');
						}
						else if(d.length>16){
							//console.log(d);
						}
						else{
							//console.log(d);
							limit=d.split('*');
							var num=limit[3];
							if(Number(limit[2])>0){
								if(limit[0]=='2'){
									if($('.order#order #tabs4 .listcontent div[class^="label"]').length>0){
										for(var i=0;i<$('.order#order #tabs4 .listcontent div[class^="label"] input[name="no[]"]').length;i++){
											if(Number($('.order#order #tabs4 .listcontent div[class^="label"]:eq('+i+') input[name="no[]"]').val())==Number(limit[1])){
												num++;
											}
											else{
											}
										}
									}
									else{
									}
									if(num>=limit[2]){
										//console.log('overflow');
									}
									else{
										$('.order#order #tabs4 .listcontent .label').prop('class','label');
										$('.order#order #tabs4 .listcontent .label input[data-id="checkbox[]"]').prop('checked',false);
										getdata('',limit[1],'quickcode','','');
										if(typeof money==="undefined"){
										}
										else{
											$('.openmoney #view #money').val(money);
											if(openmoney.dialog('isOpen')){
												$('.openmoney #buttons #submit').trigger('click');
											}
											else{
											}
										}
									}
								}
								else if(limit[0]=='3'){
									if($('.order#order #tabs4 .listcontent div[class^="label"]').length>0){
										for(var i=0;i<$('.order#order #tabs4 .listcontent div[class^="label"] input[name="no[]"]').length;i++){
											if(Number($('.order#order #tabs4 .listcontent div[class^="label"]:eq('+i+') input[name="no[]"]').val())==Number(limit[1])){
												return;
											}
											else{
											}
										}
										$('.order#order #tabs4 .listcontent .label').prop('class','label');
										$('.order#order #tabs4 .listcontent .label input[data-id="checkbox[]"]').prop('checked',false);
										getdata('',limit[1],'quickcode','','');
										if(typeof money==="undefined"){
										}
										else{
											$('.openmoney #view #money').val(money);
											if(openmoney.dialog('isOpen')){
												$('.openmoney #buttons #submit').trigger('click');
											}
											else{
											}
										}
									}
									else{
										$('.order#order #tabs4 .listcontent .label').prop('class','label');
										$('.order#order #tabs4 .listcontent .label input[data-id="checkbox[]"]').prop('checked',false);
										getdata('',limit[1],'quickcode','','');
										if(typeof money==="undefined"){
										}
										else{
											$('.openmoney #view #money').val(money);
											if(openmoney.dialog('isOpen')){
												$('.openmoney #buttons #submit').trigger('click');
											}
											else{
											}
										}
									}
								}
							}
							else{
								$('.order#order #tabs4 .listcontent .label').prop('class','label');
								$('.order#order #tabs4 .listcontent .label input[data-id="checkbox[]"]').prop('checked',false);
								getdata('',limit[1],'quickcode','','');
								if(typeof money==="undefined"){
								}
								else{
									$('.openmoney #view #money').val(money);
									if(openmoney.dialog('isOpen')){
										$('.openmoney #buttons #submit').trigger('click');
									}
									else{
									}
								}
							}
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
			}
			$('.order#order #MemberBill #list #funbox .quickorder').val('');
		}
		else{
		}
	});
	function changetagtarget(){
		if($('.order#order #MemberBill #list #tabs5button').prop('disabled')){
			return 'tabs4';
		}
		else{
			return 'tabs5';
		}
	};
	$('.order#order #banner #type').on('click','.inside',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇帳單類別','內用');
		//oneEvent(event);
		$('.order#order #banner #type #button').prop('disabled',false);
		$('.order#order #banner #type .inside').prop('disabled',true);
		//$('.order#order #detail #typetitle').html('內用');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="listtype"]').val('1');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .inside #name1').html());
		if($('.order#order #banner #type input[name="initabnum"]').val()=='1'){
			$('.order#order #banner #type').css({'margin-right':'1px'});
			$('.order#order #banner #detail').css({'margin-left':'0px','margin-right':'0px'});
			$('.order#order #banner #tablenumber').css({'width':'calc(42% / 5 - 2px)','height':'100%','margin':'0'});
			$.ajax({
				url:'./lib/js/getinterfacename.ajax.php',
				method:'post',
				async:false,
				data:{'name':'tabnumtext'},
				dataType:'json',
				success:function(d){
					$('.order#order #banner #tablenumber').html('<div style="width:100%;height:50%;text-align:center;">'+d[0]+'</div><div class="tabnumbox" style="width:100%;height:50%;border:1px solid #898989;text-align:center;border-radius: 5px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;"></div>');
				},
				error:function(e){
					//console.log(e);
				}
			});
			$('.tabinput #view #tabnum').html($('.order#order #banner #tablenumber .tabnumbox').html());
			if($('.order#order .initsetting #controltable').val()=='0'){
				tabinput.dialog('open');
			}
			else{
			}
		}
		else{
		}
	});
	$('.order#order #banner #type').on('click','.come',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇帳單類別','外帶');
		//oneEvent(event);
		$('.order#order #banner #type #button').prop('disabled',false);
		$('.order#order #banner #type .come').prop('disabled',true);
		//$('.order#order #detail #typetitle').html('來店');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="listtype"]').val('2');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .come #name1').html());
		if($('.order#order #banner #type input[name="initabnum"]').val()=='1'){
			$('.order#order #banner #type').css({'margin-right':'15px)'});
			$('.order#order #banner #detail').css({'margin-left':'calc(45% / 5 - 20px)'});
			$('.order#order #banner #tablenumber').css({'width':'','height':'','margin':''});
			$('.order#order #banner #tablenumber').html('');
			$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="tablenumber"]').val('');
		}
		else{
		}
	});
	$('.order#order #banner #type').on('click','.outside',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇帳單類別','外送');
		//oneEvent(event);
		$('.order#order #banner #type #button').prop('disabled',false);
		$('.order#order #banner #type .outside').prop('disabled',true);
		//$('.order#order #detail #typetitle').html('外送');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="listtype"]').val('3');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .outside #name1').html());
		if($('.order#order #banner #type input[name="initabnum"]').val()=='1'){
			$('.order#order #banner #type').css({'margin-right':'15px)'});
			$('.order#order #banner #detail').css({'margin-left':'calc(45% / 5 - 20px)'});
			$('.order#order #banner #tablenumber').css({'width':'','height':'','margin':''});
			$('.order#order #banner #tablenumber').html('');
			$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="tablenumber"]').val('');
		}
		else{
		}
	});
	$('.order#order #banner #type').on('click','.bysale',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇帳單類別','自取');
		//oneEvent(event);
		$('.order#order #banner #type #button').prop('disabled',false);
		$('.order#order #banner #type .bysale').prop('disabled',true);
		//$('.order#order #detail #typetitle').html('自取');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="listtype"]').val('4');
		$('.order#order #MemberBill #list #tabs4 .listcontentbox form[data-id="listform"] input[name="typename"]').val($('.order#order #banner #type .bysale #name1').html());
		if($('.order#order #banner #type input[name="initabnum"]').val()=='1'){
			$('.order#order #banner #type').css({'margin-right':'15px)'});
			$('.order#order #banner #detail').css({'margin-left':'calc(45% / 5 - 20px)'});
			$('.order#order #banner #tablenumber').css({'width':'','height':'','margin':''});
			$('.order#order #banner #tablenumber').html('');
			$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="tablenumber"]').val('');
		}
		else{
		}
	});
	$('.order#order #teamviewer').click(function(){
		$.ajax({
			url:'./lib/js/create.cmdtxt.php',
			method:'post',
			async: false,
			data:{'cmd':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'-teamview_'+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		/*var mywin=window.open('posteamviewer://','','width=1px,height=1px');
		$('.order#order #banner #tw').css({'display':''});
		$('.order#order #banner #tw input[name="psw"]').val('');*/
	});
	$('.order#order #updatemenu').click(function(){
		$('.order#order #updatemenu').prop('disabled',true);
		$.ajax({
			url:'./lib/js/create.cmdtxt.php',
			method:'post',
			async: false,
			data:{'cmd':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'-update_'+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$('.order#order #updatemenu').prop('disabled',false);
	});
	$('.order#order #menubox #itemtype').on('click','.typebut',function(event){//點選類別按鈕，撈出該分類中所有產品
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇品項類別',$(this).val());
		//oneEvent(event);
		var index=$('.order#order #menubox #itemtype .typebut').index(this);
		$('.order#order #menubox #itemtype .typebut').removeClass('focus');
		$('.order#order #menubox #itemtype .typebut:eq('+index+')').addClass('focus');
		if($('.order#order #menubox #itemtype .type:eq('+index+') .front').length>0){
			$.ajax({
				url:'./lib/js/getitems.ajax.php',
				method:'post',
				data:{'company':$('.order#order .companydata #company').val(),'itemtype':$('.order#order #menubox #itemtype .front:eq('+index+')').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'json',
				success:function(items){
					var col=$('.order#order .initsetting #menucol').val(),row=$('.order#order .initsetting #menurow').val();
					$('.order#order #menubox #items').html('');
					var number=0;
					//console.log(items);
					if($('.order#order .initsetting #menutype').val()==3){
						var ttlnumber=col*row-1;
					}
					else{
						var ttlnumber=col*row;
					}
					$.each(items,function(index,value){
						if(index!='page'){
							if((number+1)==ttlnumber&&((Object.keys(items).length-1)>ttlnumber&&typeof items['page']!=='undefined')){//$('.order#order .initsetting #menutype').val()!=3&&
								var temp=items[number][2].split(';');
								var tt="<div class='itemnext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

								tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
								$.ajax({
									url:'./lib/js/getbuttonname.ajax.php',
									method:'post',
									async:false,
									data:{'name':'changepage'},
									dataType:'json',
									success:function(d){
										//console.log(d);
										tt=tt+d[0];
									},
									error:function(e){
										//console.log(e);
										tt=tt+"換頁";
									}
								});
								tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button><input type='hidden' name='typeno' value='"+value[0]+"'><input type='hidden' name='row' value='"+row+"'><input type='hidden' name='col' value='"+col+"'></div>";
								$('.order#order #menubox #items').append(tt);
							}
							else if(number<ttlnumber){
								var temp=value[2].split(';');
								if($.trim(temp[0])!=''||$.trim(temp[3])!=''){
									var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

									if(value[4]=='null');
									else tt=tt+" style='background-color:"+value[4]+";'";

									tt=tt+"><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
									if(value[9]=='1'){
										tt=tt+"font-weight:bold;";
									}
									else{
									}
									tt=tt+"'>"+temp[0]+"</div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
									if(value[10]=='1'){
										tt=tt+"font-wright:bold;";
									}
									else{
									}
									tt=tt+"'>"+value[3]+"</div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
								}
								else{
									var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

									if(value[4]=='null');
									else tt=tt+" style='background-color:"+value[4]+";'";

									tt=tt+" disabled><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
									if(value[9]=='1'){
										tt=tt+"font-weight:bold;";
									}
									else{
									}
									tt=tt+"'></div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
									if(value[10]=='1'){
										tt=tt+"font-wright:bold;";
									}
									else{
									}
									tt=tt+"'></div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
								}
								$('.order#order #menubox #items').append(tt);
							}
							else{
								return false;
							}
							number++;
						}
						else{
							//continue;
						}
					});
					if(number>=ttlnumber){
					}
					else{
						for(var i=number;i<ttlnumber;i++){
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty' disabled><div id='name1'></div><div id='name2'></div></button></div>");
						}
					}
					if($('.order#order .initsetting #menutype').val()==3){
						$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty'><img src='./lib/return.png' style='width:100%;height:100%;' /><div id='name1'></div><div id='name2'></div></button></div>");
						$('.order#order #menubox #itemtype').css({'display':'none'});
						$('.order#order #menubox #items').css({'display':''});
					}
					else{
					}
					/*for(var i=0;i<items[0];i++){
						for(var j=0;j<items[1];j++){
							if(((i*items[0]+j)*2+2)<items.length){
								$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='"+items[(i*items[0]+j)*2+2]+"'><input type='hidden' name='no' value='"+items[(i*items[0]+j)*2+3]+"'></div>");
							}
							else{
								$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='' disabled></div>");
							}
						}
					}*/
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
		}
		if(typeof $('.order#order #content #funbox .quickorder').val()==="undefined"){
		}
		else{
			$('.order#order #content #funbox .quickorder').focus();
		}
	});
	$('.order#order #menubox #itemtype').on('click','.typenext',function(event){//點選類別換頁按鈕後，撈出未顯示的類別資料
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('品項類別換頁',$(this).find('.typebut #name2').html());
		//oneEvent(event);
		//var index=$('.order#order #menubox #itemtype .typebut').index(this);
		//$('.order#order #menubox #itemtype .typebut').removeClass('focus');
		//$('.order#order #menubox #itemtype .typebut:eq('+index+')').addClass('focus');
		if(typeof $('.order#order #menubox #itemtype .type:eq('+($('.order#order #menubox #itemtype .type').length-1)+') .front')==="undefined"){
			var lastno='999';
		}
		else{
			var lastno=$('.order#order #menubox #itemtype .type:eq('+($('.order#order #menubox #itemtype .type').length-1)+') .front').val();
		}
		//console.log(lastno);
		$.ajax({
			url:'./lib/js/gettypes.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'next':lastno,'row':$('.order#order .initsetting #menutyperow').val(),'col':$('.order#order .initsetting #menutypecol').val()},
			dataType:'json',
			success:function(items){
				var col=$('.order#order .initsetting #menutypecol').val(),row=$('.order#order .initsetting #menutyperow').val();
				$('.order#order #menubox #itemtype').html('');
				var number=0;
				//console.log(items);
				/*if($('.order#order .initsetting #menutype').val()==3){
					var ttlnumber=col*row-1;
				}
				else{*/
					var ttlnumber=col*row;
				//}
				$.each(items,function(index,value){
					if(index!='page'){
						console.log(number);
						console.log(Object.keys(items).length-1);
						console.log('ttlnumber:'+ttlnumber);
						if((number+1)==ttlnumber&&((Object.keys(items).length-1)>=ttlnumber)){
							//var temp=items[number][2].split(';');
							var tt="<div class='typenext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

							tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'changepage'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									tt=tt+d[0];
								},
								error:function(e){
									//console.log(e);
									tt=tt+"換頁";
								}
							});
							tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button></div>";
							$('.order#order #menubox #itemtype').append(tt);
						}
						else if(number<ttlnumber){
							//var temp=value[2].split(';');
							//if($.trim(temp[0])!=''||$.trim(temp[3])!=''){
								var tt="<div class='type' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button class='typebut' value='"+(value['name1']+value['name2'])+"'";

								if(value['bgcolor']=='null');
								else tt=tt+" style='background-color:"+value['bgcolor']+";'";

								tt=tt+"><div id='name1' style='float:left;width:100%;font-size:"+value['size1']+"px;color:"+value['color1']+";";
								if(value['bold1']=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'>"+value['name1']+"</div><div id='name2' style='float:left;width:100%;font-size:"+value['size2']+"px;color:"+value['color2']+";";
								if(value['bold2']=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'>"+value['name2']+"</div></button><input type='hidden' class='front' value='"+value['typeno']+"'></div>";
							/*}
							else{
								var tt="<div class='type' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

								if(value[4]=='null');
								else tt=tt+" style='background-color:"+value[4]+";'";

								tt=tt+" disabled><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
								if(value[9]=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'></div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
								if(value[10]=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'></div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
							}*/
							$('.order#order #menubox #itemtype').append(tt);
						}
						else{
							return false;
						}
						number++;
					}
					else{
						//continue;
					}
				});
				if(number>=ttlnumber){
				}
				else{
					for(var i=number;i<ttlnumber;i++){
						if((i+1)==ttlnumber){
							/*if($('.order#order .initsetting #menutype').val()==3){
								$('.order#order #menubox #itemtype').append("<div class='type' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty' disabled><div id='name1'></div><div id='name2'></div></button></div>");
							}
							else{*/
								//var temp=items[number][2].split(';');
								var tt="<div class='typenext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

								tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
								$.ajax({
									url:'./lib/js/getbuttonname.ajax.php',
									method:'post',
									async:false,
									data:{'name':'changepage'},
									dataType:'json',
									success:function(d){
										//console.log(d);
										tt=tt+d[0];
									},
									error:function(e){
										//console.log(e);
										tt=tt+"換頁";
									}
								});
								tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button></div>";
								$('.order#order #menubox #itemtype').append(tt);
							//}
						}
						else{
							$('.order#order #menubox #itemtype').append("<div class='type' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty' disabled><div id='name1'></div><div id='name2'></div></button></div>");
						}
					}
				}
				if($('.order#order .initsetting #menutype').val()==3){
					$('.order#order #menubox #itemtype').css({'display':''});
					$('.order#order #menubox #items').css({'display':'none'});
				}
				else{
				}
				/*for(var i=0;i<items[0];i++){
					for(var j=0;j<items[1];j++){
						if(((i*items[0]+j)*2+2)<items.length){
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='"+items[(i*items[0]+j)*2+2]+"'><input type='hidden' name='no' value='"+items[(i*items[0]+j)*2+3]+"'></div>");
						}
						else{
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='' disabled></div>");
						}
					}
				}*/
			},
			error:function(e){
				//console.log(e);
			}
		});
		if(typeof $('.order#order #content #funbox .quickorder').val()==="undefined"){
		}
		else{
			$('.order#order #content #funbox .quickorder').focus();
		}
	});
	$('.order#order #menubox #items').on('click','.item',function(event){//點選產品按鈕後，撈出該產品資料
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇品項',$(this).find('button').val());
		//oneEvent(event);
		var itemindex=$(this).index('.order#order #menubox #items .item');
		$(this).prop('disabled',true);//2020/6/3 防止連點造成一個套餐中出現兩個套餐名稱
		var tabs=changetagtarget();
		if($('.order#order .initsetting #menutype').val()==3&&((($(this).index('.order#order #menubox #items .item')==($('.order#order .initsetting #menucol').val()*$('.order#order .initsetting #menurow').val()-1)||($('.order#order #menubox #items .itemnext').length>0&&$(this).index('.order#order #menubox #items .item')==($('.order#order .initsetting #menucol').val()*$('.order#order .initsetting #menurow').val()-2)))&&tabs=='tabs4')||($(this).index('.order#order #menubox #items .item')==($('.order#order .initsetting #groupchildcol').val()*$('.order#order .initsetting #groupchildrow').val()-1)&&tabs=='tabs5'))){
			$('.order#order #menubox #itemtype').css({'display':''});
			$('.order#order #menubox #items').css({'display':'none'});
		}
		else{
			$('.order#order #tabs1 #tempbox input[name="target"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
			$('.order#order #tabs1 #tempbox input[name="type"]').val('');
			$('.order#order #tabs1 #tempbox input[name="no"]').val('');
			$('.order#order #tabs1 #tempbox input[name="personcount"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="needcharge"]').val('1');
			$('.order#order #tabs1 #tempbox input[name="dis1"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dis2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dis3"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dis4"]').val('');
			$('.order#order #tabs1 #tempbox input[name="name"]').val('');
			$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('');
			$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
			$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
			$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
			$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="money"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
			$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
			$('.order#order #tabs1 #tempbox input[name="number"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="background"]').val('');
			$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
			$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
			$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
			$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
			$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('1');
			$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('0');
			$('.order#order #tabs1 #editview').val('');
			$('.order#order #tabs4 .listcontent .label').prop('class','label');
			$('.order#order #tabs4 .listcontent .label input[data-id="checkbox[]"]').prop('checked',false);
			//2021/6/21 
			$('.order#order #tabs5 .listcontent .label').prop('class','label');
			$('.order#order #tabs5 .listcontent .label input[data-id="checkbox[]"]').prop('checked',false);
			getdata($('.order#order #menubox #items .item:eq('+$('.order#order #menubox #items .item').index(this)+') input[name="typeno"]').val(),$('.order#order #menubox #items .item:eq('+$('.order#order #menubox #items .item').index(this)+') input[name="no"]').val(),'new','','');
		}
		if(typeof $('.order#order #content #funbox .quickorder').val()==="undefined"){
		}
		else{
			$('.order#order #content #funbox .quickorder').focus();
		}
		$('.order#order #content #menubox .itemfun12').prop('disabled',false);
		setTimeout(function(){$('.order#order #menubox #items .item:eq('+itemindex+')').prop('disabled',false)},100);//2020/6/3 利用時間差，防止連點造成一個套餐中出現兩個套餐名稱
	});
	$('.order#order #menubox #items').on('click','.itemnext',function(event){//點選產品換頁按鈕後，撈出未顯示的產品資料
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('品項換頁',$(this).find('button #name2').html());
		//oneEvent(event);
		//var index=$('.order#order #menubox #itemtype .typebut').index(this);
		//$('.order#order #menubox #itemtype .typebut').removeClass('focus');
		//$('.order#order #menubox #itemtype .typebut:eq('+index+')').addClass('focus');
		if(typeof $('.order#order #menubox #items .item:eq('+($('.order#order #menubox #items .item').length-1)+') input[name="no"]')==='undefined'){
			var lastno='';
		}
		else{
			if($('.order#order .initsetting #menutype').val()==3){
				var lastno=$('.order#order #menubox #items .item:eq('+($('.order#order #menubox #items .item').length-2)+') input[name="no"]').val();
			}
			else{
				var lastno=$('.order#order #menubox #items .item:eq('+($('.order#order #menubox #items .item').length-1)+') input[name="no"]').val();
			}
		}
		//console.log(lastno);
		var itemtype=$(this).find('input[name="typeno"]').val();
		$.ajax({
			url:'./lib/js/getitems.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'itemtype':itemtype,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'next':lastno},
			dataType:'json',
			success:function(items){
				var col=$('.order#order #menubox #items .itemnext input[name="col"]').val(),row=$('.order#order #menubox #items .itemnext input[name="row"]').val();
				$('.order#order #menubox #items').html('');
				var number=0;
				//console.log(items);
				if($('.order#order .initsetting #menutype').val()==3){
					var ttlnumber=col*row-1;
				}
				else{
					var ttlnumber=col*row;
				}
				$.each(items,function(index,value){
					if(index!='page'){
						if((number+1)==ttlnumber&&((Object.keys(items).length-1)>ttlnumber||typeof items['page']!=='undefined')){
							var temp=items[number][2].split(';');
							var tt="<div class='itemnext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

							tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'changepage'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									tt=tt+d[0];
								},
								error:function(e){
									//console.log(e);
									tt=tt+"換頁";
								}
							});
							tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button><input type='hidden' name='typeno' value='";
							if($('.order#order .initsetting #menutype').val()==1){
								tt=tt+"allitems";
							}
							else{
								tt=tt+items[number-1][0];
							}
							tt=tt+"'><input type='hidden' name='row' value='"+row+"'><input type='hidden' name='col' value='"+col+"'></div>";
							$('.order#order #menubox #items').append(tt);
						}
						else if(number<ttlnumber){
							var temp=value[2].split(';');
							if($.trim(temp[0])!=''||$.trim(temp[3])!=''){
								var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

								if(value[4]=='null');
								else tt=tt+" style='background-color:"+value[4]+";'";

								tt=tt+"><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
								if(value[9]=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'>"+temp[0]+"</div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
								if(value[10]=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'>"+value[3]+"</div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
							}
							else{
								var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

								if(value[4]=='null');
								else tt=tt+" style='background-color:"+value[4]+";'";

								tt=tt+" disabled><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
								if(value[9]=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'></div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
								if(value[10]=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'></div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
							}
							$('.order#order #menubox #items').append(tt);
						}
						else{
							return false;
						}
						number++;
					}
					else{
						//continue;
					}
				});
				if(number>=ttlnumber){
				}
				else{
					for(var i=number;i<ttlnumber;i++){
						if((i+1)==ttlnumber){
							var temp=items[number-1][2].split(';');
							var tt="<div class='itemnext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

							tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'changepage'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									tt=tt+d[0];
								},
								error:function(e){
									//console.log(e);
									tt=tt+"換頁";
								}
							});
							tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button><input type='hidden' name='typeno' value='";
							if($('.order#order .initsetting #menutype').val()==1){
								tt=tt+"allitems";
							}
							else{
								tt=tt+items[number-1][0];
							}
							tt=tt+"'><input type='hidden' name='row' value='"+row+"'><input type='hidden' name='col' value='"+col+"'></div>";
							$('.order#order #menubox #items').append(tt);
						}
						else{
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty' disabled><div id='name1'></div><div id='name2'></div></button></div>");
						}
					}
				}
				if($('.order#order .initsetting #menutype').val()==3){
					$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty'><img src='./lib/return.png' style='width:100%;height:100%;' /><div id='name1'></div><div id='name2'></div></button></div>");
					$('.order#order #menubox #itemtype').css({'display':'none'});
					$('.order#order #menubox #items').css({'display':''});
				}
				else{
				}
				/*for(var i=0;i<items[0];i++){
					for(var j=0;j<items[1];j++){
						if(((i*items[0]+j)*2+2)<items.length){
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='"+items[(i*items[0]+j)*2+2]+"'><input type='hidden' name='no' value='"+items[(i*items[0]+j)*2+3]+"'></div>");
						}
						else{
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='' disabled></div>");
						}
					}
				}*/
			},
			error:function(e){
				//console.log(e);
			}
		});
		if(typeof $('.order#order #content #funbox .quickorder').val()==="undefined"){
		}
		else{
			$('.order#order #content #funbox .quickorder').focus();
		}
	});
	$('.order#order #menubox #items').on('click','.gitemnext',function(event){//點選套餐產品換頁按鈕後，撈出未顯示的產品資料
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('套餐品項換頁',$(this).find('button #name2').html());
		//oneEvent(event);
		//var index=$('.order#order #menubox #itemtype .typebut').index(this);
		//$('.order#order #menubox #itemtype .typebut').removeClass('focus');
		//$('.order#order #menubox #itemtype .typebut:eq('+index+')').addClass('focus');
		if(typeof $('.order#order #menubox #items .item:eq('+($('.order#order #menubox #items .item').length-1)+') input[name="no"]')==='undefined'){
			var lastno='';
		}
		else{
			var lastno=$('.order#order #menubox #items .item:eq('+($('.order#order #menubox #items .item').length-1)+') input[name="no"]').val();
		}
		var itemtype=$(this).find('input[name="typeno"]').val();
		//console.log(itemtype);
		$.ajax({
			url:'./lib/js/getitems.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'itemtype':itemtype,'group':'','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'next':lastno},
			dataType:'json',
			success:function(items){
				var col=$('.order#order #menubox #items .gitemnext input[name="col"]').val(),row=$('.order#order #menubox #items .gitemnext input[name="row"]').val();
				$('.order#order #menubox #items').html('');
				var number=0;
				//console.log(items);
				if($('.order#order .initsetting #menutype').val()==3){
					var ttlnumber=col*row-1;
				}
				else{
					var ttlnumber=col*row;
				}
				$.each(items,function(index,value){
					if(index!='page'){
						if((number+1)==ttlnumber&&((Object.keys(items).length-1)>ttlnumber||typeof items['page']!=='undefined')){
							var temp=items[number][2].split(';');
							var tt="<div class='gitemnext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

							tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'changepage'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									tt=tt+d[0];
								},
								error:function(e){
									//console.log(e);
									tt=tt+"換頁";
								}
							});
							tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button><input type='hidden' name='typeno' value='"+itemtype+"'><input type='hidden' name='row' value='"+row+"'><input type='hidden' name='col' value='"+col+"'></div>";
							$('.order#order #menubox #items').append(tt);
						}
						else if(number<ttlnumber){
							var temp=value[2].split(';');
							if($.trim(temp[0])!=''||$.trim(temp[3])!=''){
								var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

								if(value[4]=='null');
								else tt=tt+" style='background-color:"+value[4]+";'";

								tt=tt+"><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
								if(value[9]=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'>"+temp[0]+"</div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
								if(value[10]=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'>"+value[3]+"</div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
							}
							else{
								var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

								if(value[4]=='null');
								else tt=tt+" style='background-color:"+value[4]+";'";

								tt=tt+" disabled><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
								if(value[9]=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'></div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
								if(value[10]=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'></div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
							}
							$('.order#order #menubox #items').append(tt);
						}
						else{
							return false;
						}
						number++;
					}
					else{
						//continue;
					}
				});
				if(number>=ttlnumber){
				}
				else{
					for(var i=number;i<ttlnumber;i++){
						if((i+1)==ttlnumber){
							var temp=items[number-1][2].split(';');
							var tt="<div class='gitemnext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

							tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'changepage'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									tt=tt+d[0];
								},
								error:function(e){
									//console.log(e);
									tt=tt+"換頁";
								}
							});
							tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button><input type='hidden' name='typeno' value='"+itemtype+"'><input type='hidden' name='row' value='"+row+"'><input type='hidden' name='col' value='"+col+"'></div>";
							$('.order#order #menubox #items').append(tt);
						}
						else{
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty' disabled><div id='name1'></div><div id='name2'></div></button></div>");
						}
					}
				}
				if($('.order#order .initsetting #menutype').val()==3){
					$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty'><img src='./lib/return.png' style='width:100%;height:100%;' /><div id='name1'></div><div id='name2'></div></button></div>");
					$('.order#order #menubox #itemtype').css({'display':'none'});
					$('.order#order #menubox #items').css({'display':''});
				}
				else{
				}
				/*for(var i=0;i<items[0];i++){
					for(var j=0;j<items[1];j++){
						if(((i*items[0]+j)*2+2)<items.length){
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='"+items[(i*items[0]+j)*2+2]+"'><input type='hidden' name='no' value='"+items[(i*items[0]+j)*2+3]+"'></div>");
						}
						else{
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+items[1]+");height:calc(100% / "+items[0]+");'><input type='button' value='' disabled></div>");
						}
					}
				}*/
			},
			error:function(e){
				//console.log(e);
			}
		});
		if(typeof $('.order#order #content #funbox .quickorder').val()==="undefined"){
		}
		else{
			$('.order#order #content #funbox .quickorder').focus();
		}
	});
	$('.order#order #menubox #itemtype').on('click','.childtype',function(event){//點選套餐選項類別後，撈出該類別選項
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇套餐品項類別',$(this).val());
		//oneEvent(event);
		var tindex=$('.order#order #menubox #itemtype .childtype').index(this);
		$('.order#order #menubox #itemtype .childtype').removeClass('focus');
		$('.order#order #menubox #itemtype .childtype:eq('+tindex+')').addClass('focus');
		//console.log($('.order#order .companydata #company').val());
		$.ajax({
			url:'./lib/js/getitems.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'itemtype':$('.order#order #menubox #itemtype .items:eq('+tindex+')').val(),'group':'','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'json',
			success:function(items){
				var col=$('.order#order .initsetting #groupchildcol').val(),row=$('.order#order .initsetting #groupchildrow').val();
				$('.order#order #menubox #items').html('');
				var number=0;
				//console.log(items);
				if($('.order#order .initsetting #menutype').val()==3){
					var ttlnumber=col*row-1;
				}
				else{
					var ttlnumber=col*row;
				}
				$.each(items,function(index,value){
					if(index!='page'){
						if((number+1)==ttlnumber&&((Object.keys(items).length-1)>ttlnumber||typeof items['page']!=='undefined')){
							var temp=items[number][2].split(';');
							var tt="<div class='gitemnext' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);color:#000000;background-color: #FCD7A3;'><button value='換頁'";

							tt=tt+"><div id='name1' style='float:left;width:100%;font-size:150%;font-weight:bold;'>";
							$.ajax({
								url:'./lib/js/getbuttonname.ajax.php',
								method:'post',
								async:false,
								data:{'name':'changepage'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									tt=tt+d[0];
								},
								error:function(e){
									//console.log(e);
									tt=tt+"換頁";
								}
							});
							tt=tt+"</div><div id='name2' style='float:left;width:100%;font-weight:bold;'>"+items['page']+"</div></button><input type='hidden' name='typeno' value='"+$('.order#order #menubox #itemtype .items:eq('+tindex+')').val()+"'><input type='hidden' name='row' value='"+row+"'><input type='hidden' name='col' value='"+col+"'></div>";
							$('.order#order #menubox #items').append(tt);
						}
						else if(number<ttlnumber){
							var temp=value[2].split(';');
							if($.trim(temp[0])!=''||$.trim(temp[3])!=''){
								var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

								if(value[4]=='null');
								else tt=tt+" style='background-color:"+value[4]+";'";

								tt=tt+"><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
								if(value[9]=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'>"+temp[0]+"</div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
								if(value[10]=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'>"+value[3]+"</div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
							}
							else{
								var tt="<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='"+(temp[0]+value[3])+"'";

								if(value[4]=='null');
								else tt=tt+" style='background-color:"+value[4]+";'";

								tt=tt+" disabled><div id='name1' style='float:left;width:100%;font-size:"+value[5]+"px;color:"+value[7]+";";
								if(value[9]=='1'){
									tt=tt+"font-weight:bold;";
								}
								else{
								}
								tt=tt+"'></div><div id='name2' style='float:left;width:100%;font-size:"+value[6]+"px;color:"+value[8]+";";
								if(value[10]=='1'){
									tt=tt+"font-wright:bold;";
								}
								else{
								}
								tt=tt+"'></div></button><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>";
							}
							$('.order#order #menubox #items').append(tt);
						}
						else{
							return false;
						}
						number++;
					}
					else{
					}
				});
				if(number>=ttlnumber){
				}
				else{
					for(var i=number;i<ttlnumber;i++){
						$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty' disabled><div id='name1'></div><div id='name2'></div></button></div>");
					}
				}
				if($('.order#order .initsetting #menutype').val()==3){
					$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button value='' id='empty'><img src='./lib/return.png' style='width:100%;height:100%;' /><div id='name1'></div><div id='name2'></div></button></div>");
					$('.order#order #menubox #itemtype').css({'display':'none'});
					$('.order#order #menubox #items').css({'display':''});
				}
				else{
				}
				/*var col=$('.order#order .initsetting #groupchildcol').val(),row=$('.order#order .initsetting #groupchildrow').val();
				$('.order#order #menubox #items').html('');
				var number=0;
				$.each(items,function(index,value){
					if(number<col*row){
						$('.order#order #menubox #items').append("<div class='childitem' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><input type='button' value='"+value[2]+"'><input type='hidden' name='no' value='"+value[1]+"'><input type='hidden' name='typeno' value='"+value[0]+"'></div>");
					}
					else{
						return false;
					}
					number++;
				});
				if(number>=col*row){
				}
				else{
					for(var i=number;i<col*row;i++){
						$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><input type='button' value='' disabled></div>");
					}
				}*/
			},
			error:function(e){
				//console.log(e);
			}
		});
		if(typeof $('.order#order #content #funbox .quickorder').val()==="undefined"){
		}
		else{
			$('.order#order #content #funbox .quickorder').focus();
		}
	});
	/*$('.order#order #menubox #items').on('click','.childitem',function(){//點選套餐選項按鈕後，撈出該產品資料
		$('.order#order #tabs5 .listcontent .label').prop('class','label');
		$('.order#order #tabs5 .listcontent .label input[id="checkbox[]"]').prop('checked',false);
		getdata($('.order#order #menubox #items .childitem:eq('+$('.order#order #menubox #items .childitem').index(this)+') input[name="typeno"]').val(),$('.order#order #menubox #items .childitem:eq('+$('.order#order #menubox #items .childitem').index(this)+') input[name="no"]').val(),'new','g','');
	});*/
	function getdata(itemtype,itemno,type,group,ordercon){
		$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',true);

		var tabs=changetagtarget();
		if(tabs=='tabs4'){
			$.ajax({
				url:'./lib/js/getdata.ajax.php',
				method:'post',
				async:false,
				data:{'company':$('.order#order .companydata #company').val(),'itemtype':itemtype,'no':itemno,'dep':group},
				dataType:'json',
				success:function(data){
					//console.log(data);
					var i=0;
					$('.order#order .parameters #typeno').val(data[0]['fronttype']);
					$('.order#order .parameters #type').val(data[0]['depname']);
					$('.order#order .parameters #no').val(data[0]['number']);
					$('.order#order .parameters #name').val(data[0]['name']);
					$('.order#order .parameters #msize').val(data[0]['mnumber']);
					for(i=0;i<6;i++){
						//if(i<data[0]['mnumber']){
							//console.log(data[0]['mname'+(i+1)+'1']);
							if(data[0]['money'+(i+1)]==""){
								$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('');
								$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
								$('.order#order .parameters input[id^="money"]:eq('+i+')').val('');
								$('.order#order .parameters input[id="getpointtype[]"]:eq('+i+')').val('');
								$('.order#order .parameters input[id="getpoint[]"]:eq('+i+')').val('');
							}
							else{
								if(data[0]['mname'+(i+1)+'1']==''){
									if((Number(data[0]['money'+(i+1)])+Number(data[0]['dis']))<=0){
										$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('0');
									}
									else{
										$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val((Number(data[0]['money'+(i+1)])+Number(data[0]['dis'])));
									}
								}
								else{
									$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val(data[0]['mname'+(i+1)+'1']);
									$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val(data[0]['mname'+(i+1)+'2']);
								}
								$('.order#order .parameters input[id="money[]"]:eq('+i+')').val((Number(data[0]['money'+(i+1)])+Number(data[0]['dis'])));
								$('.order#order .parameters input[id="getpointtype[]"]:eq('+i+')').val(data[0]['getpointtype'+(i+1)]);
								$('.order#order .parameters input[id="getpoint[]"]:eq('+i+')').val(data[0]['getpoint'+(i+1)]);
							}
						/*}
						else{
							$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('');
							$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
							$('.order#order .parameters input[id^="money"]:eq('+i+')').val('');
						}*/
					}
					$('.order#order .parameters #taste1').val(data[0]['taste']);
					$('.order#order .parameters #taste1name').val(data[0]['tastename1']);
					$('.order#order .parameters #taste2name').val(data[0]['tastename2']);
					$('.order#order .parameters #taste1money').val(data[0]['tastemoney']);
					$('.order#order .parameters #tastegroup').val(data[0]['tastegroup']);
					$('.order#order .parameters #background').val(data[0]['background']);
					$('.order#order #menubox #itemfun .startchangetaste').val('0');
					$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
					
					$('.order#order #numbox input[type="button"]:eq(0)').val('number');
					$('.order#order #numbox button:eq(1) #name').html('$');
					
					if(type=='old'){
						//console.log('1');
						if(data[0]['openmoney']==1&&$('.order#order #tabs4 form[data-id="listform"] .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') input[name="templistitem[]"]').length==0){
							$('.order#order #numbox button:eq(1)').prop('disabled',false);
							$('.order#order #numbox button:eq(1)').css({'color':'#000000'});
							$('.openmoney #view #money').val($('.order#order #content #tempbox input[name="unitprice"]').val());
							//openmoney.dialog('open');
						}
						else{
							$('.order#order #numbox button:eq(1)').prop('disabled',true);
							$('.order#order #numbox button:eq(1)').css({'color':'#a8a8a8'});
						}

						if(data[0]['itemdis']=='1'){
							$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',false);
						}
						else{
							$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',true);
						}
					}
					else{
						$('.order#order #tabs1 #tempbox input[name="target"]').val($('.order#order #'+tabs+' .listcontent .label').length);//2020/10/15/週四
						//console.log($('.order#order #tabs1 #tempbox input[name="target"]').val());
						//console.log($('.order#order #tabs4 form[data-id="listform"] .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') input[name="templistitem[]"]').length);
						//console.log($('.order#order #tabs4 form[data-id="listform"] .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') input[name="templistitem[]"]').length==0);
						if(data[0]['openmoney']==1&&$('.order#order #tabs4 form[data-id="listform"] .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') input[name="templistitem[]"]').length==0){
							//console.log('2');
							$('.order#order #numbox button:eq(1)').prop('disabled',false);
							$('.order#order #numbox button:eq(1)').css({'color':'#000000'});
							$('.openmoney #view #money').val($('.order#order .parameters input[id="money[]"]:eq(0)').val());
							openmoney.dialog('open');
						}
						else{
							//console.log('3');
							$('.order#order #numbox button:eq(1)').prop('disabled',true);
							$('.order#order #numbox button:eq(1)').css({'color':'#a8a8a8'});
						}
						if(data[0]['personcount']=='0'){
						}
						else{
							if($('.setperson #view input[name="persons'+data[0]['personcount']+'"]').length>0){
								$('.setperson #view input[name="persons'+data[0]['personcount']+'"]').val(parseInt($('.setperson #view input[name="persons'+data[0]['personcount']+'"]').val())+1);
								$('.setperson #buttons #submit').trigger('click');
							}
							else{
							}
						}
						//$('.order#order #tabs1 #tempbox input[name="target"]').val($('.order#order #'+tabs+' .listcontent .label').length);//2020/10/15/週四
						if($('.order#order #'+tabs+' .listcontent input[name="linenumber[]"]').length==0){
							$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(1);
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(parseInt($('.order#order #'+tabs+' .listcontent input[name="linenumber[]"]:eq('+($('.order#order #'+tabs+' .listcontent input[name="linenumber[]"]').length-1)+')').val())+2);
						}
						$('.order#order #tabs1 #tempbox input[name="typeno"]').val(data[0]['fronttype']);
						$('.order#order #tabs1 #tempbox input[name="type"]').val(data[0]['depname']);
						$('.order#order #tabs1 #tempbox input[name="no"]').val(data[0]['inumber']);
						$('.order#order #tabs1 #tempbox input[name="personcount"]').val(data[0]['personcount']);
						$('.order#order #tabs1 #tempbox input[name="needcharge"]').val(data[0]['charge']);
						$('.order#order #tabs1 #tempbox input[name="dis1"]').val(data[0]['dis1']);
						$('.order#order #tabs1 #tempbox input[name="dis2"]').val(data[0]['dis2']);
						$('.order#order #tabs1 #tempbox input[name="dis3"]').val(data[0]['dis3']);
						$('.order#order #tabs1 #tempbox input[name="dis4"]').val(data[0]['dis4']);
						$('.order#order #tabs1 #tempbox input[name="name"]').val(data[0]['name']);
						$('.order#order #tabs1 #tempbox input[name="name2"]').val(data[0]['name2']);
						if(ordercon==''){
							$('.order#order #tabs1 #tempbox input[name="isgroup"]').val(data[0]['isgroup']);
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="isgroup"]').val(ordercon);
						}
						$('.order#order #tabs1 #tempbox input[name="childtype"]').val(data[0]['childtype']);
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val(data[0]['mname11']);
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val(data[0]['mname12']);
						$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val(data[0]['insaleinv']);
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val((Number(data[0]['money1'])+Number(data[0]['dis'])));
						$('.order#order #tabs1 #tempbox input[name="money"]').val((Number(data[0]['money1'])+Number(data[0]['dis'])));
						$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
						$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
						$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
						$('.order#order #tabs1 #tempbox input[name="number"]').val(1);
						$('.order#order #tabs1 #tempbox input[name="subtotal"]').val((Number(data[0]['money1'])+Number(data[0]['dis'])));
						$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="tastegroup"]').val('');
						$('.order#order #tabs1 #tempbox input[name="background"]').val('');
						$('.order#order #tabs1 #tempbox input[name="itemdis"]').val(data[0]['itemdis']);
						$('.order#order #tabs1 #tempbox input[name="listdis"]').val(data[0]['listdis']);
						$('.order#order #tabs1 #tempbox input[name="bothdis"]').val(data[0]['bothdis']);
						$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val(data[0]['usemempoint']);
						$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val(data[0]['getpointtype1']);
						$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val(data[0]['getpoint1']);
						$('.order#order #tabs1 #tempbox input[name="getpoint"]').val(data[0]['getpoint1']);
						data[0]['terminalnumber']=$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val();
						data[0]['consecnumber']=$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val();
						data[0]['listtype']=$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val();
						data[0]['machinetype']=$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]');
						if(data[0]['itemdis']=='1'){//作用在套餐名稱的餐品上
							$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',false);
						}
						else{
							$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',true);
						}
						/*$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');*/
						if($('.order#order #tabs1 #tempbox input[name="isgroup"]').val()!=0&&$('.order#order #tabs1 #tempbox input[name="isgroup"]').val()!='－'){
							if($('.order#order #tabs1 #tempbox input[name="childtype"]').val().length>0){
								$.ajax({
									url:'./lib/js/getchildtype.ajax.php',
									method:'post',
									data:{'company':$('.order#order .companydata #company').val(),'childtype':$('.order#order #tabs1 #tempbox input[name="childtype"]').val()},
									dataType:'json',
									success:function(value){
										$('.order#order #MemberBill #list #tabs4button').prop('disabled',true);
										$('.order#order #MemberBill #list #tabs5button').prop('disabled',false);
										$('.order#order #MemberBill #list #tabs5button').trigger('click');
										/*$list.tabs('option','disabled',[0]);
										$list.tabs('option','enabled',[1]);
										$list.tabs('option','active',1);*/
										$('.order#order #billfun #billfun1 button:eq(3)').prop('disabled',true);
										$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
										$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',true);
										$('.order#order #billfun #billfun1 button:eq(6)').prop('disabled',true);

										$('.order#order #billfun #billfun2 button:eq(0)').prop('disabled',true);
										$('.order#order #billfun #billfun2 button:eq(1)').prop('disabled',true);
										//$('.order#order #billfun #billfun2 button:eq(2)').prop('disabled',true);
										$('.order#order #billfun #billfun2 button:eq(3)').prop('disabled',true);
										$('.order#order #billfun #billfun2 button:eq(4)').prop('disabled',true);

										//2021/6/18 移動至結帳區功能頁中
										$('.order#order #billfun #billfun1 button:eq(5)').val('套餐確認');
										//$('.order#order #billfun #billfun2 button:eq(5)').val('套餐確認');
										$.ajax({
											url:'./lib/js/getbuttonname.ajax.php',
											method:'post',
											data:{'type':'sendset'},
											dataType:'json',
											success:function(d){
												$('.order#order #billfun #billfun1 button:eq(5) div#name1').html(d['button1']);
												$('.order#order #billfun #billfun1 button:eq(5) div#name2').html(d['button2']);
												//$('.order#order #billfun #billfun2 button:eq(5) div#name1').html(d['button1']);
												//$('.order#order #billfun #billfun2 button:eq(5) div#name2').html(d['button2']);
											},
											error:function(e){
												//console.log(e);
											}
										});
										$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',false);
										//$('.order#order #billfun #billfun2 button:eq(5)').prop('disabled',false);

										$('.order#order #billfun #billfun2 button:eq(6)').prop('disabled',true);
										$('.order#order #billfun #billfun2 button:eq(7)').prop('disabled',true);
										//2021/6/18 移動至結帳區功能頁中，所以常用功能頁不用開啟
										$('.order#order #billfun #billfun2button').prop('disabled',true);
										$('.order#order #billfun #billfun3button').prop('disabled',true);
										//2021/6/18 移動至結帳區功能頁中
										$('.order#order #MemberBill #billfun #billfun1button').trigger('click');
										//$('.order#order #MemberBill #billfun #billfun2button').trigger('click');

										tabs=changetagtarget();

										if(data[0]['itemdis']=='1'){//作用在套餐名稱的餐品上
											$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',false);
										}
										else{
											$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',true);
										}

										$('.order#order #tabs1 #tempbox input[name="target"]').val($('.order#order #'+tabs+' .listcontent .label').length);

										/*$('.order#order #MemberBill #billfun #billfun1 input[type="button"]').prop('disabled',true);
										$('.order#order #MemberBill #billfun #billfun1 input[type="button"]').css({'color':'#a8a8a8'});
										$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(2)').prop('disabled',false);
										$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(2)').css({'color':'#ffffff'});
										$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(4)').prop('disabled',false);
										$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(4)').css({'color':'#ffffff'});
										$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(10)').prop('disabled',false);
										$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(10)').css({'color':'#000000'});*/

										//console.log(value);
										if(Object.keys(value).length>0){
											var maxtyperow=$('.order#order .initsetting #groupchildtyperow').val();
											var maxtypecol=$('.order#order .initsetting #groupchildtypecol').val();
											var maxrow=$('.order#order .initsetting #groupchildrow').val();
											var maxcol=$('.order#order .initsetting #groupchildcol').val();
											$('.order#order #menubox #itemtype').html('');
											$('.order#order #menubox #items').html('');
											var i=0;
											//console.log(value);
											$.each(value,function(key,v){
												if(key!='other'){
												}
												else{
													$.each(v,function(key,val){
														if(i<(maxtyperow*maxtypecol)){
															$('.order#order #menubox #itemtype').append('<div class="type" style="width:calc(100% / '+maxtypecol+' - 2px);height:calc(100% / '+maxtyperow+' - 2px);overflow:hidden;"><button class="childtype" value="'+val['front']+'"><div id="name1">'+val['front']+'</div><input type="hidden" class="number" value="'+val['number']+'"><input type="hidden" class="required" value="'+val['required']+'"></button><input type="hidden" class="childfronttype" value="'+val['no']+'"><input type="hidden" class="items" value="'+val['items']+'"></div>');
															i++;
														}
														else{
															return;
														}
													});
												}
											});
											/*for(var i=0;i<value.length;i++){
												if(i<(maxtyperow*maxtypecol-1)){
													$('.order#order #menubox #itemtype').append('<div class="type" style="width:calc(100% / '+maxtypecol+' - 2px);height:calc(100% / '+maxtyperow+' - 2px);overflow:hidden;"><button class="childtype" value="'+value[i]['name1']+'"><div id="name1">'+value[i]['name1']+'</div></button><input type="hidden" class="childfronttype" value="'+value[i]['front']+'"></div>');
												}
												else{
													break;
												}
											}*/
											if(i<(maxtyperow*maxtypecol)){
												for(;i<(maxtyperow*maxtypecol);i++){
													$('.order#order #menubox #itemtype').append('<div class="type" style="width:calc(100% / '+maxtypecol+' - 2px);height:calc(100% / '+maxtyperow+' - 2px);overflow:hidden;"><input type="button" class="childtype" value="" disabled><input type="hidden" class="childfronttype" value=""></div>');
												}
											}
											else{
											}
											for(var i=0;i<(maxrow*maxcol);i++){
												$('.order#order #menubox #items').append('<div class="item" style="width:calc(100% / '+maxcol+' - 2px);height:calc(100% / '+maxrow+' - 2px);overflow:hidden;"><input type="button" value="" disabled></div>');
											}
											$('.order#order #tabs1 #editview').trigger('change');
											updateview();
											if($('.order#order .initsetting #menutype').val()==3){
												$('.order#order #menubox #itemtype').css({'display':''});
												$('.order#order #menubox #items').css({'display':'none'});
											}
											else{
											}
										}
										else{
											//console.log('套餐類別未設定');
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log('套餐類別未設定');
							}
						}
						else{
							$('.order#order #tabs1 #editview').trigger('change');
							updateview();
							sumsubtotal();
							if($('.order#order #tabs1 #tempbox input[name="childtype"]').val()==''){
							}
							else{
								var temp=$('.order#order #tabs1 #tempbox input[name="childtype"]').val().split(',');
								for(var i=0;i<temp.length;i++){
									var tt=temp[i].split('-');
									getdata(tt[0],tt[1],'new','','－');
								}
								
							}
						}
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
			/*$.ajax({
				url:'../secview/writeitem.ajax.php',
				method:'post',
				data:{'company':$('.order#order .companydata #company').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'itemtype':itemtype,'no':itemno,'dep':group},
				async: false
				dataType:'json',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		}
		else{
			var temp=0;
			for(var i=1;i<$('.order#order #'+tabs+' form[data-id="listform"] .label').length;i++){
				if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="order[]"]').val()=='－'){
				}
				else{
					if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="typeno[]"]').val()!=itemtype){
					}
					else{
						temp=Number(temp)+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val());
					}
				}
			}
			$.ajax({
				url:'./lib/js/getchilddata.ajax.php',
				method:'post',
				async:false,
				data:{'company':$('.order#order .companydata #company').val(),'childtype':itemtype,'no':itemno,'dep':group},
				dataType:'json',
				success:function(data){
					//console.log(data);
					var i=0;
					$('.order#order .parameters #typeno').val(data['itemdep']);
					$('.order#order .parameters #type').val(data['depname']);
					$('.order#order .parameters #no').val(data['number']);
					$('.order#order .parameters #name').val(data['name']);
					$('.order#order .parameters #msize').val(data['mnumber']);
					for(i=0;i<6;i++){
						//if(i<data[0]['mnumber']){
							//console.log(data[0]['mname'+(i+1)+'1']);
							if(data['money'+(i+1)]==""){
								$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('');
								$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
								$('.order#order .parameters input[id^="money"]:eq('+i+')').val('');
								$('.order#order .parameters input[id="getpointtype[]"]:eq('+i+')').val('');
								$('.order#order .parameters input[id="getpoint[]"]:eq('+i+')').val('');
							}
							else{
								if(data['mname'+(i+1)+'1']==''){
									if((Number(data['money'+(i+1)])+Number(data['dis']))<=0){
										$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('0');
									}
									else{
										$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val(Number(data['money'+(i+1)]));//(Number(data['money'+(i+1)])+Number(data['dis']))
									}
								}
								else{
									$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val(data['mname'+(i+1)+'1']);
									$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val(data['mname'+(i+1)+'2']);
								}
								/*if((Number(data['money'+(i+1)]))<=0){
									$('.order#order .parameters input[id="money[]"]:eq('+i+')').val(0);
								}
								else{*/
									$('.order#order .parameters input[id="money[]"]:eq('+i+')').val((Number(data['money'+(i+1)])));
								//}
								$('.order#order .parameters input[id="getpointtype[]"]:eq('+i+')').val(data['getpointtype'+(i+1)]);
								$('.order#order .parameters input[id="getpoint[]"]:eq('+i+')').val(data['getpoint'+(i+1)]);
							}
						/*}
						else{
							$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('');
							$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
							$('.order#order .parameters input[id^="money"]:eq('+i+')').val('');
						}*/
					}
					/*for(i=0;i<6;i++){
						if(i<data['mnumber']){
							if(data['mname'+i+'1']==''){
								if((Number(data['money'+(i+1)])+Number(data['dis']))<=0){
									$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('0');
									$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
								}
								else{
									//$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val((Number(data['money'+(i+1)])+Number(data['dis']))+'');
									$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val((Number(data['money'+(i+1)]))+'');
									$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
								}
							}
							else{
								$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val(data['mname'+(i+1)+'1']);
								$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val(data['mname'+(i+1)+'2']);
							}
							//if((Number(data['money'+(i+1)])+Number(data['dis']))<=0){
							if((Number(data['money'+(i+1)]))<=0){
								$('.order#order .parameters input[id^="money"]:eq('+i+')').val(0);
							}
							else{
								//$('.order#order .parameters input[id^="money"]:eq('+i+')').val((Number(data[0]['money'+(i+1)])+Number(data[0]['dis'])));
								$('.order#order .parameters input[id^="money"]:eq('+i+')').val((Number(data['money'+(i+1)])));
							}
						}
						else{
							$('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val('');
							$('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val('');
							$('.order#order .parameters input[id^="money"]:eq('+i+')').val('');
						}
					}*/
					$('.order#order .parameters #taste1').val(data['taste']);
					$('.order#order .parameters #taste1name').val(data['tastename1']);
					$('.order#order .parameters #taste2name').val(data['tastename2']);
					$('.order#order .parameters #taste1money').val(data['tastemoney']);
					$('.order#order .parameters #tastegroup').val(data['tastegroup']);
					$('.order#order .parameters #background').val(data['background']);
					$('.order#order #menubox #itemfun .startchangetaste').val('0');
					$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
					
					if(type=='old'){
					}
					else{
						if(Number(temp)>=Number($('.order#order #itemtype .childtype.focus .number').val())){
							$('.order#order #tabs1 #tempbox input[name="target"]').val('');
							$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('');
							$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
							$('.order#order #tabs1 #tempbox input[name="type"]').val('');
							$('.order#order #tabs1 #tempbox input[name="no"]').val('');
							$('.order#order #tabs1 #tempbox input[name="personcount"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="needcharge"]').val('1');
							$('.order#order #tabs1 #tempbox input[name="dis1"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dis2"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dis3"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dis4"]').val('');
							$('.order#order #tabs1 #tempbox input[name="name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
							$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
							$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
							$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
							$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
							$('.order#order #tabs1 #tempbox input[name="money"]').val('');
							$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
							$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
							$('.order#order #tabs1 #tempbox input[name="number"]').val('');
							$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="tastegroup"]').val('');
							$('.order#order #tabs1 #tempbox input[name="background"]').val('');
							$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
							$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
							$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
							$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
							$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('');
							$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('');
							$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('');
							$('.order#order #tabs1 #editview').val('');
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="target"]').val($('.order#order #'+tabs+' .listcontent .label').length);
							if($('.order#order #'+tabs+' .listcontent input[name="linenumber[]"]').length==0){
								$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(1);
							}
							else{
								$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(parseInt($('.order#order #'+tabs+' .listcontent input[name="linenumber[]"]:eq('+($('.order#order #'+tabs+' .listcontent input[name="linenumber[]"]').length-1)+')').val())+2);
							}
							$('.order#order #tabs1 #tempbox input[name="typeno"]').val(data['itemdep']);
							$('.order#order #tabs1 #tempbox input[name="type"]').val(data['depname']);
							$('.order#order #tabs1 #tempbox input[name="no"]').val(data['number']);
							$('.order#order #tabs1 #tempbox input[name="personcount"]').val(data['personcount']);
							$('.order#order #tabs1 #tempbox input[name="needcharge"]').val(data['charge']);
							$('.order#order #tabs1 #tempbox input[name="dis1"]').val(data['dis1']);
							$('.order#order #tabs1 #tempbox input[name="dis2"]').val(data['dis2']);
							$('.order#order #tabs1 #tempbox input[name="dis3"]').val(data['dis3']);
							$('.order#order #tabs1 #tempbox input[name="dis4"]').val(data['dis4']);
							$('.order#order #tabs1 #tempbox input[name="name"]').val(data['name']);
							$('.order#order #tabs1 #tempbox input[name="name2"]').val(data['name2']);
							$('.order#order #tabs1 #tempbox input[name="isgroup"]').val(data['isgroup']);
							$('.order#order #tabs1 #tempbox input[name="childtype"]').val(data['childtype']);
							$('.order#order #tabs1 #tempbox input[name="mname1"]').val(data['mname11']);
							$('.order#order #tabs1 #tempbox input[name="mname2"]').val(data['mname12']);
							$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val(data['insaleinv']);
							//$('.order#order #tabs1 #tempbox input[name="unitprice"]').val((Number(data['money1'])+Number(data['dis'])));
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val((Number(data['money1'])));
							//$('.order#order #tabs1 #tempbox input[name="money"]').val((Number(data[0]['money1'])+Number(data[0]['dis'])));
							$('.order#order #tabs1 #tempbox input[name="money"]').val((Number(data['money1'])));
							$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
							$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
							$('.order#order #tabs1 #tempbox input[name="number"]').val(1);
							///$('.order#order #tabs1 #tempbox input[name="subtotal"]').val((Number(data['money1'])+Number(data[0]['dis'])));
							$('.order#order #tabs1 #tempbox input[name="subtotal"]').val((Number(data['money1'])));
							$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="tastegroup"]').val('');
							$('.order#order #tabs1 #tempbox input[name="background"]').val('');
							$('.order#order #tabs1 #tempbox input[name="itemdis"]').val(data['itemdis']);
							$('.order#order #tabs1 #tempbox input[name="listdis"]').val(data['listdis']);
							$('.order#order #tabs1 #tempbox input[name="bothdis"]').val(data['bothdis']);
							$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val(data['usemempoint']);
							$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val(data['getpointtype1']);
							$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val(data['getpoint1']);
							$('.order#order #tabs1 #tempbox input[name="getpoint"]').val(data['getpoint1']);
							$('.order#order #tabs1 #editview').trigger('change');
							updateview();
							//sumsubtotal();
						}
					}
					if(data['itemdis']=='1'){
						$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',false);
					}
					else{
						$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',true);
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		if(type=='old'){//判斷是否為加點品項
		}
		else{
			$.ajax({
				url:'./lib/js/change.button4.php',
				method:'post',
				data:{'type':'a'},
				dataType:'json',
				success:function(d){
					//console.log(d);
					if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
						$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
					}
					else{
					}
					if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
						$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[1]);
					}
					else{
					}
					if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
						$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
					}
					else{
					}
					$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
	};
	function sumsubtotal(type,checknumber){
		if(typeof type==='undefined'){
			type='';
		}
		else{
		}
		if(typeof checknumber==='undefined'){
			checknumber='1';//2020/8/13 套用於套餐檢查數量
		}
		else{
		}
		var tabs=changetagtarget();
		var viewtotal=0;
		var viewnumber=0;
		for(var i=0;i<$('.order#order #tabs4 form[data-id="listform"] .label').length;i++){
			viewtotal=Number(viewtotal)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val());
			viewnumber=Number(viewnumber)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val());
		}
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			viewtotal=roundfun(viewtotal,precision);
			viewnumber=roundfun(viewnumber,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			viewtotal=ceilfun(viewtotal,precision);
			viewnumber=ceilfun(viewnumber,precision);
		}
		else{//無條件捨去
			viewtotal=floorfun(viewtotal,precision);
			viewnumber=floorfun(viewnumber,precision);
		}
		$('.order#order #tabs4 form[data-id="listform"] input[name="total"]').val(viewtotal);
		$('.order#order #tabs4 form[data-id="listform"] input[name="totalnumber"]').val(viewnumber);
		$('.order#order #banner #detail #viewtotal').val(viewtotal);
		$('.order#order #banner #detail #viewnumber').val(viewnumber);
		if(type==''&&$('.order#order .initsetting #secview').val()=='1'){
			if(checknumber=='1'){
			}
			else{
				for(var i=0;i<(checknumber-1);i++){
					if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+')').length>0){
						$.ajax({
							url:'../secview/writeitem.ajax.php',
							method:'post',
							data:{'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="linenumber[]"]').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'company':$('.order#order .companydata #company').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'itemtype':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="typeno[]"]').val(),'no':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="no[]"]').val(),'dep':'','number':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="number[]"]').val(),'mname':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="mname1[]"]').val(),'money1':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="unitprice[]"]').val(),'taste':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="taste1[]"]').val(),'tastenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="taste1number[]"]').val(),'tastemoney':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="taste1money[]"]').val(),'subtotal':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+(parseInt($('.order#order #tabs4 form[data-id="listform"] .label').length)-parseInt(checknumber)+parseInt(i))+') input[name="subtotal[]"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
							async: false,
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'writeitem.ajax.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
				}
			}
			$.ajax({
				url:'../secview/writeitem.ajax.php',
				method:'post',
				data:{'linenumber':$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'company':$('.order#order .companydata #company').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'itemtype':$('.order#order #tabs1 #tempbox input[name="typeno"]').val(),'no':$('.order#order #tabs1 #tempbox input[name="no"]').val(),'dep':'','number':$('.order#order #tabs1 #tempbox input[name="number"]').val(),'mname':$('.order#order #tabs1 #tempbox input[name="mname1"]').val(),'money1':$('.order#order #tabs1 #tempbox input[name="unitprice"]').val(),'taste':$('.order#order #tabs1 #tempbox input[name="taste1"]').val(),'tastenumber':$('.order#order #tabs1 #tempbox input[name="taste1number"]').val(),'tastemoney':$('.order#order #tabs1 #tempbox input[name="taste1money"]').val(),'subtotal':$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
				async: false,
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'writeitem.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
				socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
				console.log('send message "listitemupdate" to secview');
			}
			else{
			}
		}
		else if(type=='quickorder'){//2020/4/24 過濾RFID讀取，讀取後直接寫入客顯tempDB
		}
		else{
		}
	};
	$('.order#order #numbox').on('click','input',function(event){//點選中間數字鍵
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('調整品項數量',$(this).val());
		//oneEvent(event);
		var tabs=changetagtarget();
		var disindex=$('.result #funbox button[class^="listdisbut"]').index(this);
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		if($.trim($('.order#order #tabs1 #tempbox input[name="name"]').val()).length<=0){
		}
		else{
			if(tabs=='tabs4'){
				diff();
				var index=$('.order#order #numbox input').index(this);
				if(index==1){
					if($('.order#order #numbox input[type="button"]:eq(0)').val()=='number'){
						if($('.order#order #numbox input[name="type"]').val()=='new'){
							$('.order#order #numbox input[name="type"]').val('old');
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val()+$('.order#order #numbox input:eq('+index+')').val());
						}
					}
					else{
						if(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())==0){
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #numbox input:eq('+index+')').val());
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+Number($('.order#order #numbox input:eq('+index+')').val()));
						}
						$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())+Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()));
					}
				}
				else if(index<10){
					if($('.order#order #numbox input[type="button"]:eq(0)').val()=='number'){
						if($('.order#order #numbox input[name="type"]').val()=='new'){
							$('.order#order #numbox input[name="type"]').val('old');
							if(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())<=1){
								$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #numbox input:eq('+index+')').val());
							}
							else{
								$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val().toString()+$('.order#order #numbox input:eq('+index+')').val().toString());
							}
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val().toString()+$('.order#order #numbox input:eq('+index+')').val().toString());
						}
						/*if(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())==1){
							$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #numbox input:eq('+index+')').val());
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val()+Number($('.order#order #numbox input:eq('+index+')').val()));
						}*/
					}
					else{
						if(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())==0){
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #numbox input:eq('+index+')').val());
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+Number($('.order#order #numbox input:eq('+index+')').val()));
						}
						$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())+Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()));
					}
				}
				else if(index==10){
					if($('.order#order #numbox input[type="button"]:eq(0)').val()=='number'){
						if($('.order#order #numbox input[name="type"]').val()=='new'){
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val()+Number($('.order#order #numbox input:eq('+index+')').val()));
						}
						//$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val()+Number($('.order#order #numbox input:eq('+index+')').val()));
					}
					else{
						if(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())==0){
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+Number($('.order#order #numbox input:eq('+index+')').val()));
						}
						$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())+Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()));
					}
				}
				else if(index==11){
					if($('.order#order #numbox input[type="button"]:eq(0)').val()=='number'){
						if($('.order#order #numbox input[name="type"]').val()=='new'){
							$('.order#order #numbox input[name="type"]').val('old');
						}
						else{
						}
						$('.order#order #tabs1 #tempbox input[name="number"]').val(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())+1);
					}
					else{
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+1);
						$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())+Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()));
					}
				}
				else if(index==12){
					if($('.order#order #numbox input[type="button"]:eq(0)').val()=='number'){
						if($('.order#order #numbox input[name="type"]').val()=='new'){
							$('.order#order #numbox input[name="type"]').val('old');
						}
						else{
						}
						if((Number($('.order#order #tabs1 #tempbox input[name="number"]').val())-1)>1){
							$('.order#order #tabs1 #tempbox input[name="number"]').val(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())-1);
						}
						else{
							$('.order#order #numbox input[name="type"]').val('new');
							$('.order#order #tabs1 #tempbox input[name="number"]').val(1);
						}
					}
					else{
						if((Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())-1)>=0){
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())-1);
						}
						else{
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val(0);
						}
						$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())+Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()));
					}
				}
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.order#order #tabs1 #tempbox input[name="money"]').val( roundfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.order#order #tabs1 #tempbox input[name="money"]').val( ceilfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
				}
				else{//無條件捨去
					$('.order#order #tabs1 #tempbox input[name="money"]').val( floorfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
				}
				$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())*Number($('.order#order #tabs1 #tempbox input[name="money"]').val()));
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.order#order #tabs1 #tempbox input[name="subtotal"]').val( roundfun($('.order#order #tabs1 #tempbox input[name="subtotal"]').val(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.order#order #tabs1 #tempbox input[name="subtotal"]').val( ceilfun($('.order#order #tabs1 #tempbox input[name="subtotal"]').val(),precision));
				}
				else{//無條件捨去
					$('.order#order #tabs1 #tempbox input[name="subtotal"]').val( floorfun($('.order#order #tabs1 #tempbox input[name="subtotal"]').val(),precision));
				}
				
				//2020/4/24 計算該品項贈與點數
				$('.order#order #tabs1 #tempbox input[name="getpoint"]').val(Number($('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));

				returnitemdissingle();//2020/4/20 針對目前選取品項，還原單品促銷

				$('.order#order #editview').trigger('change');
				sumsubtotal();
			}
			else{
				//套餐設定時，先設定單一套餐後，再到外層(tabs4)設定數量，因此在內層(tabs5)不用設定數量
			}
		}
	});
	$('.order#order #numbox').on('click','button',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('調整品項數量/金額',$(this).val());
		//oneEvent(event);
		var tabs=changetagtarget();
		if($.trim($('.order#order #tabs1 #tempbox input[name="name"]').val()).length<=0){
		}
		else{
			if(tabs=='tabs4'){
				diff();

				var index=$('.order#order #numbox button').index(this);
				if(index==0){
					if($('.order#order #numbox input:eq(0)').val()=='number'){
						$('.order#order #numbox input[name="type"]').val('new');
						$('.order#order #tabs1 #tempbox input[name="number"]').val(1);
					}
					else{
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val(0);
						$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())+Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val()));
					}
				}
				else{
					/*if($('.order#order #numbox input[type="button"]:eq(0)').val()=='number'){
						$('.order#order #numbox input:eq(0)').val('money');
						$('.order#order #numbox button:eq(1) #name').html('確認金額');
					}
					else{
						$('.order#order #numbox input:eq(0)').val('number');
						$('.order#order #numbox button:eq(1) #name').html('$');
					}*/
					$('.openmoney #view #money').val($('.order#order #tabs1 #tempbox input[name="unitprice"]').val());
					openmoney.dialog('open');
				}

				//2020/4/24 計算該品項贈與點數
				$('.order#order #tabs1 #tempbox input[name="getpoint"]').val(Number($('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));

				$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())*Number($('.order#order #tabs1 #tempbox input[name="money"]').val()));
				$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
				$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
				$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
				$('.order#order #editview').trigger('change');
				sumsubtotal();
			}
			else{
				//套餐設定時，先設定單一套餐後，再到外層(tabs4)設定數量，因此在內層(tabs5)不用設定數量
			}
		}
	});
	$('.order#order #menubox #itemfun').on('click','button[class^="itemmname"]',function(event){//點選產品價格
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇品項價格',$(this).find('#name1').html());
		//oneEvent(event);
		if($.trim($('.order#order #tabs1 #tempbox input[name="name"]').val()).length<=0){
		}
		else{
			if(typeof $('.order#order #menubox #itemfun button[class^="itemmname"]').index(this)!=='undefined'&&Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))<6){
				if($('.order#order #menubox #itemfun .itemmname'+(Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))+1)+' div#name1').html()==''&&$('.order#order #menubox #itemfun .itemmoney'+(Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))+1)).val()==''){
				}
				else{
					diff();

					returnitemdissingle();//2020/4/20 針對目前選取品項，還原單品促銷

					$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #menubox #itemfun .itemmname'+(Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))+1)+' div#name1').html());
					$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #menubox #itemfun .itemmname'+(Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))+1)+' div#name2').html());
					$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #menubox #itemfun .itemmoney'+(Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))+1)).val());
					$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val($('.order#order #menubox #itemfun .getpointtype'+(Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))+1)).val());
					$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val($('.order#order #menubox #itemfun .getpoint'+(Number($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this))+1)).val());

					//2020/4/24 計算該品項贈與點數
					$('.order#order #tabs1 #tempbox input[name="getpoint"]').val(Number($('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
				}
			}
			else{
			}
			/*switch($('.order#order #menubox #itemfun button[class^="itemmname"]').index(this)){
				case 0://第一項價格
					if($('.order#order #menubox #itemfun .itemmname1 div#name1').html()==''&&$('.order#order #menubox #itemfun .itemmoney1').val()==''){
					}
					else{
						diff();
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #menubox #itemfun .itemmname1 div#name1').html());
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #menubox #itemfun .itemmname1 div#name2').html());
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #menubox #itemfun .itemmoney1').val());
					}
					break;
				case 1://第二項價格
					if($('.order#order #menubox #itemfun .itemmname2 div#name1').html()==''&&$('.order#order #menubox #itemfun .itemmoney2').val()==''){
					}
					else{
						diff();
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #menubox #itemfun .itemmname2 div#name1').html());
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #menubox #itemfun .itemmname2 div#name2').html());
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #menubox #itemfun .itemmoney2').val());
					}
					break;
				case 2://第三項價格
					if($('.order#order #menubox #itemfun .itemmname3 div#name1').html()==''&&$('.order#order #menubox #itemfun .itemmoney3').val()==''){
					}
					else{
						diff();
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #menubox #itemfun .itemmname3 div#name1').html());
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #menubox #itemfun .itemmname3 div#name2').html());
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #menubox #itemfun .itemmoney3').val());
					}
					break;
				case 3://第四項價格
					if($('.order#order #menubox #itemfun .itemmname4 div#name1').html()==''&&$('.order#order #menubox #itemfun .itemmoney4').val()==''){
					}
					else{
						diff();
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #menubox #itemfun .itemmname4 div#name1').html());
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #menubox #itemfun .itemmname4 div#name2').html());
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #menubox #itemfun .itemmoney4').val());
					}
					break;
				case 4://第五項價格
					if($('.order#order #menubox #itemfun .itemmname5 div#name1').html()==''&&$('.order#order #menubox #itemfun .itemmoney5').val()==''){
					}
					else{
						diff();
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #menubox #itemfun .itemmname5 div#name1').html());
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #menubox #itemfun .itemmname5 div#name2').html());
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #menubox #itemfun .itemmoney5').val());
					}
					break;
				case 5://第六項價格
					if($('.order#order #menubox #itemfun .itemmname6 div#name1').html()==''&&$('.order#order #menubox #itemfun .itemmoney6').val()==''){
					}
					else{
						diff();
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #menubox #itemfun .itemmname6 div#name1').html());
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #menubox #itemfun .itemmname6 div#name2').html());
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #menubox #itemfun .itemmoney6').val());
					}
					break;
				default:
					break;
			}*/
			$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val()));
			var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
			/*設定檔內可設定使用何種進位*/
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.order#order #tabs1 #tempbox input[name="money"]').val( roundfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.order#order #tabs1 #tempbox input[name="money"]').val( ceilfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
			}
			else{//無條件捨去
				$('.order#order #tabs1 #tempbox input[name="money"]').val( floorfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
			}
			$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())*Number($('.order#order #tabs1 #tempbox input[name="money"]').val())-Number($('.order#order #tabs1 #tempbox input[name="discount"]').val()));
			$('.order#order #editview').trigger('change');
			updateview();
			sumsubtotal();
		}
	});
	$('.order#order #menubox #itemfun').on('click','button[id^="taste"]',function(event){//點選產品前十項備註與加料
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇/取消品項備註',$(this).find('#name1').html());
		//oneEvent(event);
		if($.trim($('.order#order #tabs1 #tempbox input[name="name"]').val()).length<=0){//當前狀態是否有點選產品
		}
		else{
			var temptaste=[],temptaste1=[];
			var tempname1=[];
			var tempprice=[];
			var tempnumber=[];
			//var tempcolor=[];
			var tasteindex=$('.order#order #menubox #itemfun button[id^="taste"]').index(this);
			if($('.order#order #menubox #itemfun .tasteno'+tasteindex).val()==''&&$('.order#order #menubox #itemfun .tasteprice'+tasteindex).val()==''){//點選的備註與加料按鈕是否有資訊
			}
			else{
				if($('.order#order #tabs1 #tempbox input[name="taste1"]').val().length>0){
					temptaste=$('.order#order #tabs1 #tempbox input[name="taste1"]').val().split(',');
					temptaste1=$('.order#order #tabs1 #tempbox input[name="taste1"]').val().split(',');
					tempname1=$('.order#order #tabs1 #tempbox input[name="taste1name"]').val().split(',');
					tempprice=$('.order#order #tabs1 #tempbox input[name="taste1price"]').val().split(',');
					tempnumber=$('.order#order #tabs1 #tempbox input[name="taste1number"]').val().split(',');
					//tempcolor=$('.order#order #tabs1 #tempbox input[name="background"]').val().split(',');
				}
				else{
				}
				if($.inArray($('.order#order #menubox #itemfun .tasteno'+tasteindex).val(),temptaste)>=0){
					var deleteindex=$.inArray($('.order#order #menubox #itemfun .tasteno'+tasteindex).val(),temptaste);
					temptaste.splice(deleteindex,1);
					temptaste1.splice(deleteindex,1);
					tempname1.splice(deleteindex,1);
					tempprice.splice(deleteindex,1);
					tempnumber.splice(deleteindex,1);
					//tempcolor.splice(deleteindex,1);
					$('.order#order #tabs1 #tempbox input[name="taste1money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())-Number($('.order#order #menubox #itemfun .tasteprice'+tasteindex).val()));
					/*if(tempprice[$.inArray($('.order#order #menubox #itemfun .tasteno'+tasteindex).val(),temptaste)]=='0'){
					}
					else{
						tempnumber[$.inArray($('.order#order #menubox #itemfun .tasteno'+tasteindex).val(),temptaste)]=Number(tempnumber[$.inArray($('.order#order #menubox #itemfun .tasteno'+tasteindex).val(),temptaste)])+1;
					}*/
				}
				else{
					temptaste.push($('.order#order #menubox #itemfun .tasteno'+tasteindex).val().toString());
					temptaste1.push($('.order#order #menubox #itemfun .tasteno'+tasteindex).val().toString());
					if($('.order#order #menubox #itemfun #taste'+tasteindex+' div#name2').html().length==0){
						tempname1.push($('.order#order #menubox #itemfun #taste'+tasteindex+' div#name1').html());
					}
					else{
						tempname1.push($('.order#order #menubox #itemfun #taste'+tasteindex+' div#name1').html()+' /'+$('.order#order #menubox #itemfun #taste'+tasteindex+' div#name2').html());
					}
					tempprice.push($('.order#order #menubox #itemfun .tasteprice'+tasteindex).val());
					tempnumber.push('1');
					//tempcolor.push($('.order#order #menubox #itemfun #background'+tasteindex).val());
					$('.order#order #tabs1 #tempbox input[name="taste1money"]').val(Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())+Number($('.order#order #menubox #itemfun .tasteprice'+tasteindex).val()));
				}
			}
			if(temptaste.length>0&&$('.order#order .initsetting #tastegroup').val()=='1'){
				$.ajax({
					url:'./lib/js/check.tastegroup.php',
					method:'post',
					async:false,
					data:{'taste':temptaste,'taste1':temptaste1,'name':tempname1,'price':tempprice,'number':tempnumber,/*'color':tempcolor,*/'money':$('.order#order #tabs1 #tempbox input[name="taste1money"]').val()},
					dataType:'json',
					success:function(d){
						temptaste=d['taste'];
						temptaste1=d['taste1'];
						tempname1=d['name'];
						tempprice=d['price'];
						tempnumber=d['number'];
						$('.order#order #tabs1 #tempbox input[name="taste1money"]').val(d['money']);
						//console.log(d);
						//console.log(d['taste']);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
			}
			var tasteno='',tastename1='',tastename3='',tasteprice='',tastenumber=''/*,tastecolor=''*/;
			var sorttemp=quicksort(temptaste1);
			diff();

			$.each(sorttemp,function(index,value){
				if(tasteno.length>0){
					tasteno=tasteno+','+value;

					tastename1=tastename1+','+tempname1[$.inArray(value,temptaste)];
					tastename3=tastename3+'<br>&nbsp;&nbsp;&nbsp;&nbsp;+'+tempname1[$.inArray(value,temptaste)];

					tasteprice=tasteprice+','+tempprice[$.inArray(value,temptaste)];
					tastenumber=tastenumber+','+tempnumber[$.inArray(value,temptaste)];

				}
				else{
					tasteno=tasteno+value;

					tastename1=tastename1+tempname1[$.inArray(value,temptaste)];
					tastename3=tastename3+tempname1[$.inArray(value,temptaste)];

					tasteprice=tasteprice+tempprice[$.inArray(value,temptaste)];
					tastenumber=tastenumber+tempnumber[$.inArray(value,temptaste)];

				}
			});
				
			$('.order#order #tabs1 #tempbox input[name="taste1"]').val(tasteno);
			$('.order#order #tabs1 #tempbox input[name="taste1name"]').val(tastename1);
			$('.order#order #tabs1 #tempbox input[name="taste2"]').val(tastename3);
			$('.order#order #tabs1 #tempbox input[name="taste1price"]').val(tasteprice);
			$('.order#order #tabs1 #tempbox input[name="taste1number"]').val(tastenumber);
			//$('.order#order #tabs1 #tempbox input[name="background"]').val(tastecolor);
			//console.log($('.order#order #tabs1 #tempbox input[name="taste1money"]').val());
			/*if(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val())<=0){
				$('.order#order #tabs1 #tempbox input[name="money"]').val(0);
			}
			else{*/
				$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val()));
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				/*設定檔內可設定使用何種進位*/
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.order#order #tabs1 #tempbox input[name="money"]').val( roundfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.order#order #tabs1 #tempbox input[name="money"]').val( ceilfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
				}
				else{//無條件捨去
					$('.order#order #tabs1 #tempbox input[name="money"]').val( floorfun($('.order#order #tabs1 #tempbox input[name="money"]').val(),precision));
				}
			//}
			$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(Number($('.order#order #tabs1 #tempbox input[name="money"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val())-Number($('.order#order #tabs1 #tempbox input[name="discount"]').val()));
			$('.order#order #editview').trigger('change');
			updateview();
			
			/*if(tabs=='tabs5'){
			}
			else{*/
				sumsubtotal();
			//}
		}
	});
	function returnitemdissingle(){//2020/4/20 針對目前選取品項，還原單品促銷
		$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
		$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
		
		if($('.order#order #tabs1 #tempbox input[name="dispoint"]').val()!='0'){
			$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val(parseInt($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val())+parseInt($('.order#order #tabs1 #tempbox input[name="dispoint"]').val())-(parseInt($('.order#order #tabs1 #tempbox input[name="dispointtime"]').val())*parseInt($('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val())));//2020/4/20
			$('.memdata #point').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());//2020/4/20
		}
		else{
		}

		$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
		$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
	}
	function returnitemdisall(){//2020/4/20 針對該單上所有已點品項，還原單品促銷
		for(var i=0;i<$('.order#order #list #tabs4 .listcontentbox .listcontent .label').length;i++){
			if($('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="dispoint[]"]').val()!='0'){
				$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val(parseInt($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val())+parseInt($('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="dispoint[]"]').val())-(parseInt($('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="dispointtime[]"]').val())*parseInt($('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="initgetpoint[]"]').val())));//2020/4/20
				$('.memdata #point').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());//2020/4/20
			}
			else{
			}

			$('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="discount[]"]').val('0');
			$('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="discontent[]"]').val('');
			$('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="dispoint[]"]').val('0');
			$('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="dispointtime[]"]').val('0');

			$('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="subtotal[]"]').val(Number($('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="money[]"]').val())*Number($('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="number[]"]').val()));

			$('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') #subtotal').html($('.order#order #list #tabs4 .listcontentbox .listcontent .label:eq('+i+') input[name="subtotal[]"]').val());
		}

		sumsubtotal();
	}
	function diff(){//變更前回復狀態
		var index=$('.order#order #tabs1 #tempbox input[name="target"]').val();
		var tabs=changetagtarget();
		if(index>=0){
			if(tabs=='tabs4'){
				if($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="order[]"]').val()=='－'){
					var index2=index;
					var index3=(index-1);
					while($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
						
						//2020/4/24 還原單位點數
						$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="getpoint[]"]').val($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="initgetpoint[]"]').val());

						$('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index2+')').val('0');
						$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index2+')').val('0');

						$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #number').html('0');
						$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #subtotal').html('0');
						index2++;
					}
					while($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="order[]"]').val()=='－'){

						//2020/4/24 還原單位點數
						$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="getpoint[]"]').val($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="initgetpoint[]"]').val());

						$('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index3+')').val('0');
						$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index3+')').val('0');

						$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #number').html('0');
						$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #subtotal').html('0');
						index3--;
					}

					//2020/4/24 還原單位點數
					$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="getpoint[]"]').val($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="initgetpoint[]"]').val());

					$('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index3+')').val(Number($('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index3+')').val())-Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
					$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index3+')').val(Number($('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index3+')').val())-(Number($('.order#order #'+tabs+' .listcontent input[name^="money"]:eq('+index3+')').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val())));

					$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #number').html($('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index3+')').val());
					$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #subtotal').html($('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index3+')').val());
					//console.log('未加入人頭數量回復');
				}
				else if($('.order#order #'+tabs+' .listcontent .label:eq('+(Number(index)+1)+') input[name="order[]"]').val()=='－'){
					var index2=Number(index)+1;

					//2020/4/24 還原單位點數
					$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="getpoint[]"]').val($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="initgetpoint[]"]').val());

					$('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index+')').val('0');
					$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index+')').val('0');

					$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #number').html('0');
					$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #subtotal').html('0');
					while($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
						//2020/4/24 還原單位點數
						$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="getpoint[]"]').val($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="initgetpoint[]"]').val());

						$('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index2+')').val('0');
						$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index2+')').val('0');

						$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #number').html('0');
						$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #subtotal').html('0');
						index2++;
					}
					//console.log('未加入人頭數量回復');
				}
				else{
					//2020/4/24 還原單位點數
					$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="getpoint[]"]').val($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="initgetpoint[]"]').val());

					$('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index+')').val('0');
					$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index+')').val('0');

					$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #number').html('0');
					$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #subtotal').html('0');

					if($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' .listcontent input[name^="personcount"]:eq('+index+')').val()+'"]').length>0){
						$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' .listcontent input[name^="personcount"]:eq('+index+')').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' .listcontent input[name^="personcount"]:eq('+index+')').val()+'"]').val())-parseInt($('.order#order #tabs1 #tempbox input[name="number"]').val()));
					}
					else{
					}
				}
			}
			else{
				$('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index+')').val(Number($('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index+')').val())-Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
				$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index+')').val(Number($('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index+')').val())-(Number($('.order#order #'+tabs+' .listcontent input[name^="money"]:eq('+index+')').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val())));

				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #number').html($('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index+')').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #subtotal').html($('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index+')').val());

				if($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' .listcontent input[name^="personcount"]:eq('+index+')').val()+'"]').length>0){
					$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' .listcontent input[name^="personcount"]:eq('+index+')').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' .listcontent input[name^="personcount"]:eq('+index+')').val()+'"]').val())-parseInt($('.order#order #tabs1 #tempbox input[name="number"]').val()));
				}
				else{
				}
			}
		}
		else{
		}
	};
	$('.order#order #tabs1').on('change','#editview',function(){//變更後增加
		var tabs=changetagtarget();
		if($('.order#order #'+tabs+' .listcontent .label').length==0){
			if($('.order#order #tabs1 #tempbox input[name="isgroup"]').val()=='－'){
				$('.order#order #'+tabs+' .listcontent').append("<div class='label focus' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs1 #tempbox input[name="linenumber"]').val()+"'><input type='hidden' name='order[]' value='－'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs1 #tempbox input[name="typeno"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs1 #tempbox input[name="type"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs1 #tempbox input[name="no"]').val()+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs1 #tempbox input[name="needcharge"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='dis1[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis1"]').val()+"'><input type='hidden' name='dis2[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis2"]').val()+"'><input type='hidden' name='dis3[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis3"]').val()+"'><input type='hidden' name='dis4[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis4"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"'><input type='hidden' name='isgroup[]' value='0'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="childtype"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtiime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><input type='hidden' name='itemdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="itemdis"]').val()+"'><input type='hidden' name='listdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="listdis"]').val()+"'><input type='hidden' name='bothdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="bothdis"]').val()+"'><input type='hidden' name='usemempoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val()+"'><input type='hidden' name='getpointtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val()+"'><input type='hidden' name='initgetpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val()+"'><input type='hidden' name='getpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpoint"]').val()+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>1</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"("+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+")</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="money"]').val()+$('.result .unit').val()+"</div></div>");
			}
			else{
				$('.order#order #'+tabs+' .listcontent').append("<div class='label focus' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs1 #tempbox input[name="linenumber"]').val()+"'><input type='hidden' name='order[]' value='1'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs1 #tempbox input[name="typeno"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs1 #tempbox input[name="type"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs1 #tempbox input[name="no"]').val()+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs1 #tempbox input[name="needcharge"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='dis1[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis1"]').val()+"'><input type='hidden' name='dis2[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis2"]').val()+"'><input type='hidden' name='dis3[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis3"]').val()+"'><input type='hidden' name='dis4[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis4"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"'><input type='hidden' name='isgroup[]' value='"+$('.order#order #tabs1 #tempbox input[name="isgroup"]').val()+"'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="childtype"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><input type='hidden' name='itemdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="itemdis"]').val()+"'><input type='hidden' name='listdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="listdis"]').val()+"'><input type='hidden' name='bothdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="bothdis"]').val()+"'><input type='hidden' name='usemempoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val()+"'><input type='hidden' name='getpointtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val()+"'><input type='hidden' name='initgetpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val()+"'><input type='hidden' name='getpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpoint"]').val()+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>1</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"("+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+")</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="money"]').val()+$('.result .unit').val()+"</div></div>");
			}
			//$('.order#order #'+tabs+' .listcontent').append("<div class='label' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs1 #tempbox input[name="linenumber"]').val()+"'><input type='hidden' name='order[]' value='1'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs1 #tempbox input[name="typeno"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs1 #tempbox input[name="type"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs1 #tempbox input[name="no"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"'><input type='hidden' name='isgroup[]' value='"+$('.order#order #tabs1 #tempbox input[name="isgroup"]').val()+"'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="childtype"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><div style='width:3%;padding:3px 0;'><input type='checkbox' id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>1</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"("+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+")</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="money"]').val()+$('.result .unit').val()+"</div></div>");
			$('.order#order #numbox input[name="type"]').val('new');
			if($('.order#order #tabs1 #tempbox input[name="isgroup"]').val()!='0'){
				var tempchitype=$('.order#order #tabs1 #tempbox input[name="childtype"]').val().split(',');
				linenumber=$('.order#order #tabs1 #tempbox input[name="linenumber"]').val();
				$.each(tempchitype,function(i,v){
					linenumber=Number(linenumber)+2;
					var tempv=v.split('-');
					if(tempv.length==2&&tempv[1]!=''){
						$.ajax({
							url:'./lib/js/getdetail.child.php',
							method:'post',
							async: false,
							data:{'company':$('.order#order .companydata #company').val(),'type':tempv[0],'item':tempv[1]},
							dataType:'json',
							success:function(d){
								if(d["mname11"]==''){
									var mname='';
								}
								else{
									var mname='('+d["mname11"]+')';
								}
								if(typeof  d['insaleinv'] != "undefined"){
								}
								else{
									d['insaleinv']='1';
								}
								$('.order#order #'+tabs+' .listcontent').append("<div class='label' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+linenumber+"'><input type='hidden' name='order[]' value='－'><input type='hidden' name='typeno[]' value='"+tempv[0]+"'><input type='hidden' name='type[]' value=''><input type='hidden' name='no[]' value='"+tempv[1]+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs1 #tempbox input[name="needcharge"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='dis1[]' value='"+d["dis1"]+"'><input type='hidden' name='dis2[]' value='"+d["dis2"]+"'><input type='hidden' name='dis3[]' value='"+d["dis3"]+"'><input type='hidden' name='dis4[]' value='"+d["dis4"]+"'><input type='hidden' name='name[]' value='"+d['name1']+"'><input type='hidden' name='name2[]' value='"+d['name2']+"'><input type='hidden' name='isgroup[]' value='"+d['isgroup']+"'><input type='hidden' name='childtype[]' value=''><input type='hidden' name='mname1[]' value='"+d['mname11']+"'><input type='hidden' name='mname2[]' value='"+d['mname12']+"'><input type='hidden' name='insaleinv[]' value='"+d["insaleinv"]+"'><input type='hidden' name='unitprice[]' value='"+d['money1']+"'><input type='hidden' name='money[]' value='"+d['money1']+"'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='"+d['money1']+"'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><input type='hidden' name='itemdis[]' value='"+d['itemdis']+"'><input type='hidden' name='listdis[]' value='"+d['listdis']+"'><input type='hidden' name='bothdis[]' value='"+d['bothdis']+"'><input type='hidden' name='usemempoint[]' value='"+d['usemempoint']+"'><input type='hidden' name='getpointtype[]' value='"+d['getpointtype1']+"'><input type='hidden' name='initgetpoint[]' value='"+d['getpoint1']+"'><input type='hidden' name='getpoint[]' value='"+d['getpoint1']+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>"+($('.order#order #'+tabs+' .listcontent .label').length+1)+"</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+d['name1']+d['name2']+mname+"</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+d['money1']+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+d['money1']+$('.result .unit').val()+"</div></div>");
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
				});
			}
			else{
			}
			$('.order#order #'+tabs+' .listcontentbox').scrollTop($('.order#order #'+tabs+' .listcontent').height());
		}
		else if($('.order#order #tabs1 #tempbox input[name="target"]').val()==$('.order#order #'+tabs+' .listcontent .label').length){
			var targetindex=$('.order#order #'+tabs+' .listcontent .label').length;
			ordernumber=Number(targetindex)+1;
			var nametemp=$('.order#order #tabs1 #tempbox input[name="name"]').val().split(';');
			var nametemp2=$('.order#order #tabs1 #tempbox input[name="name2"]').val().split(';');
			if($('.order#order #tabs1 #tempbox input[name="isgroup"]').val()=='－'){
				$('.order#order #'+tabs+' .listcontent').append("<div class='label focus' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs1 #tempbox input[name="linenumber"]').val()+"'><input type='hidden' name='order[]' value='－'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs1 #tempbox input[name="typeno"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs1 #tempbox input[name="type"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs1 #tempbox input[name="no"]').val()+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs1 #tempbox input[name="needcharge"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='dis1[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis1"]').val()+"'><input type='hidden' name='dis2[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis2"]').val()+"'><input type='hidden' name='dis3[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis3"]').val()+"'><input type='hidden' name='dis4[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis4"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"'><input type='hidden' name='isgroup[]' value='0'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="childtype"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><input type='hidden' name='itemdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="itemdis"]').val()+"'><input type='hidden' name='listdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="listdis"]').val()+"'><input type='hidden' name='bothdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="bothdis"]').val()+"'><input type='hidden' name='usemempoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val()+"'><input type='hidden' name='getpointtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val()+"'><input type='hidden' name='initgetpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val()+"'><input type='hidden' name='getpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpoint"]').val()+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>"+ordernumber+"</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+nametemp[0]+nametemp2[0]+"("+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+")</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="money"]').val()+$('.result .unit').val()+"</div></div>");
			}
			else{
				$('.order#order #'+tabs+' .listcontent').append("<div class='label focus' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs1 #tempbox input[name="linenumber"]').val()+"'><input type='hidden' name='order[]' value='"+ordernumber+"'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs1 #tempbox input[name="typeno"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs1 #tempbox input[name="type"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs1 #tempbox input[name="no"]').val()+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs1 #tempbox input[name="needcharge"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='dis1[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis1"]').val()+"'><input type='hidden' name='dis2[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis2"]').val()+"'><input type='hidden' name='dis3[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis3"]').val()+"'><input type='hidden' name='dis4[]' value='"+$('.order#order #tabs1 #tempbox input[name="dis4"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"'><input type='hidden' name='isgroup[]' value='"+$('.order#order #tabs1 #tempbox input[name="isgroup"]').val()+"'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="childtype"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><input type='hidden' name='itemdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="itemdis"]').val()+"'><input type='hidden' name='listdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="listdis"]').val()+"'><input type='hidden' name='bothdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="bothdis"]').val()+"'><input type='hidden' name='usemempoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val()+"'><input type='hidden' name='getpointtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val()+"'><input type='hidden' name='initgetpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val()+"'><input type='hidden' name='getpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpoint"]').val()+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>"+ordernumber+"</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+nametemp[0]+nametemp2[0]+"("+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+")</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="money"]').val()+$('.result .unit').val()+"</div></div>");
			}
			//$('.order#order #'+tabs+' .listcontent').append("<div class='label focus check' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs1 #tempbox input[name="linenumber"]').val()+"'><input type='hidden' name='order[]' value='"+ordernumber+"'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs1 #tempbox input[name="typeno"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs1 #tempbox input[name="type"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs1 #tempbox input[name="no"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs1 #tempbox input[name="name"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs1 #tempbox input[name="name2"]').val()+"'><input type='hidden' name='isgroup[]' value='"+$('.order#order #tabs1 #tempbox input[name="isgroup"]').val()+"'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="childtype"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs1 #tempbox input[name="money"]').val()+"'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><div style='width:3%;padding:3px 0;'><input type='checkbox' id='checkbox[]' checked></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>"+ordernumber+"</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+nametemp[0]+nametemp2[0]+"("+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+")</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="unitprice"]').val()+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+$('.order#order #tabs1 #tempbox input[name="money"]').val()+$('.result .unit').val()+"</div></div>");
			$('.order#order #numbox input[name="type"]').val('new');
			if(nametemp.length>1){
				var subname=nametemp[1].split('/');
				var subname2=nametemp2[1].split('/');
				for(var i=0;i<subname.length;i++){
					$('.order#order #'+tabs+' .listcontent').append("<div class='label' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='order[]' value='－'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs1 #tempbox input[name="typeno"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs1 #tempbox input[name="type"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs1 #tempbox input[name="no"]').val()+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs1 #tempbox input[name="needcharge"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+"'><input type='hidden' name='name[]' value='"+subname[i]+"'><input type='hidden' name='name2[]' value='"+subname2[i]+"'><input type='hidden' name='isgroup[]' value='2'><input type='hidden' name='childtype[]' value=''><input type='hidden' name='mname1[]' value=''><input type='hidden' name='mname2[]' value=''><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val()+"'><input type='hidden' name='unitprice[]' value='0'><input type='hidden' name='money[]' value='0'><input type='hidden' name='discount[]' value='0'><input type='hidden' name='discontent[]' value=''><input type='hidden' name='dispoint[]' value='0'><input type='hidden' name='dispointtime[]' value='0'><input type='hidden' name='number[]' value='1'><input type='hidden' name='subtotal[]' value='0'><input type='hidden' name='taste1[]' value=''><input type='hidden' name='taste1name[]' value=''><input type='hidden' name='taste1price[]' value=''><input type='hidden' name='taste1number[]' value=''><input type='hidden' name='taste1money[]' value='0'><input type='hidden' name='itemdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="itemdis"]').val()+"'><input type='hidden' name='listdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="listdis"]').val()+"'><input type='hidden' name='bothdis[]' value='"+$('.order#order #tabs1 #tempbox input[name="bothdis"]').val()+"'><input type='hidden' name='usemempoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val()+"'><input type='hidden' name='getpointtype[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val()+"'><input type='hidden' name='initgetpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val()+"'><input type='hidden' name='getpoint[]' value='"+$('.order#order #tabs1 #tempbox input[name="getpoint"]').val()+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>－</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+subname[i]+subname2[i]+"</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.result .frontunit').val()+"0"+$('.result .unit').val()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>1</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.result .frontunit').val()+"0"+$('.result .unit').val()+"</div></div>");
				}
			}
			else{
			}
			$('.order#order #'+tabs+' .listcontentbox').scrollTop($('.order#order #'+tabs+' .listcontent').height());
		}
		else{
			var index=$('.order#order #tabs1 #tempbox input[name="target"]').val();
			if(index>=0){
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="mname1[]"]').val($('.order#order #tabs1 #tempbox input[name="mname1"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="mname2[]"]').val($('.order#order #tabs1 #tempbox input[name="mname2"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="unitprice[]"]').val($('.order#order #tabs1 #tempbox input[name="unitprice"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="money[]"]').val($('.order#order #tabs1 #tempbox input[name="money"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="discount[]"]').val($('.order#order #tabs1 #tempbox input[name="discount"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="discontent[]"]').val($('.order#order #tabs1 #tempbox input[name="discontent"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="dispoint[]"]').val($('.order#order #tabs1 #tempbox input[name="dispoint"]').val());//2020/4/14 單品優惠使用點數
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="dispointtime[]"]').val($('.order#order #tabs1 #tempbox input[name="dispointtime"]').val());//2020/4/14 單品優惠使用在幾項產品上
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="getpointtype[]"]').val($('.order#order #tabs1 #tempbox input[name="getpointtype"]').val());//2020/4/20 給點規則會與價格名稱浮動
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="initgetpoint[]"]').val($('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val());//2020/4/20 單位點數會與價格名稱浮動
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="getpoint[]"]').val($('.order#order #tabs1 #tempbox input[name="getpoint"]').val());//2020/4/20 總給點數量會與價格名稱浮動
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="number[]"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val($('.order#order #tabs1 #tempbox input[name="subtotal"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="taste1[]"]').val($('.order#order #tabs1 #tempbox input[name="taste1"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="taste1name[]"]').val($('.order#order #tabs1 #tempbox input[name="taste1name"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="taste2name[]"]').val($('.order#order #tabs1 #tempbox input[name="taste2name"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="taste1price[]"]').val($('.order#order #tabs1 #tempbox input[name="taste1price"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="taste1number[]"]').val($('.order#order #tabs1 #tempbox input[name="taste1number"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="taste1money[]"]').val($('.order#order #tabs1 #tempbox input[name="taste1money"]').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="background[]"]').val($('.order#order #tabs1 #tempbox input[name="background"]').val());

				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #unitprice').html($('.result .frontunit').val()+$('.order#order #'+tabs+' .listcontent input[name^="unitprice"]:eq('+index+')').val()+$('.result .unit').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #number').html($('.order#order #'+tabs+' .listcontent input[name^="number"]:eq('+index+')').val());
				$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #subtotal').html($('.result .frontunit').val()+$('.order#order #'+tabs+' .listcontent input[name^="subtotal"]:eq('+index+')').val()+$('.result .unit').val());
				if(tabs=='tabs4'){
					if($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="order[]"]').val()=='－'){
						var index2=Number(index)+1;
						var index3=index-1;
						while($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="number[]"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val());
							
							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val((Number($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="money[]"]').val())-Number($('.order#order #'+tabs+' .listcontent .label:eq('+index2+')  input[name="discount[]"]').val()))*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
							var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
							/*設定檔內可設定使用何種進位*/
							if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
								$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val( roundfun($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val(),precision));
							}
							else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
								$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val( ceilfun($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val(),precision));
							}
							else{//無條件捨去
								$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val( floorfun($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val(),precision));
							}

							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #number').html($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="number[]"]').val());
							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #subtotal').html($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val());
							index2++;
						}
						while($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="order[]"]').val()=='－'){
							$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="number[]"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val());
							$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val((Number($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="money[]"]').val())-Number($('.order#order #'+tabs+' .listcontent .label:eq('+index3+')  input[name="discount[]"]').val()))*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
							var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
							/*設定檔內可設定使用何種進位*/
							if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
								$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val( roundfun($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val(),precision));
							}
							else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
								$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val( ceilfun($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val(),precision));
							}
							else{//無條件捨去
								$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val( floorfun($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val(),precision));
							}
							$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #number').html($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="number[]"]').val());
							$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #subtotal').html($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val());
							index3--;
						}
						$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="number[]"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val());
						$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val((Number($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="money[]"]').val())-Number($('.order#order #'+tabs+' .listcontent .label:eq('+index3+')  input[name="discount[]"]').val()))*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
						var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
						/*設定檔內可設定使用何種進位*/
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val( roundfun($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val(),precision));
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val( ceilfun($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val(),precision));
						}
						else{//無條件捨去
							$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val( floorfun($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val(),precision));
						}
						$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #number').html($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="number[]"]').val());
						$('.order#order #'+tabs+' .listcontent .label:eq('+index3+') #subtotal').html($('.order#order #'+tabs+' .listcontent .label:eq('+index3+') input[name="subtotal[]"]').val());
					}
					else if($('.order#order #'+tabs+' .listcontent .label:eq('+(Number(index)+1)+') input[name="order[]"]').val()=='－'){
						//console.log('here');
						var index2=Number(index)+1;
						$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="number[]"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val());
						$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val((Number($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="money[]"]').val())-Number($('.order#order #'+tabs+' .listcontent .label:eq('+index+')  input[name="discount[]"]').val()))*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
						var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
						/*設定檔內可設定使用何種進位*/
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val( roundfun($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val(),precision));
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val( ceilfun($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val(),precision));
						}
						else{//無條件捨去
							$('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val( floorfun($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val(),precision));
						}
						$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #number').html($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="number[]"]').val());
						$('.order#order #'+tabs+' .listcontent .label:eq('+index+') #subtotal').html($('.order#order #'+tabs+' .listcontent .label:eq('+index+') input[name="subtotal[]"]').val());
						while($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="number[]"]').val($('.order#order #tabs1 #tempbox input[name="number"]').val());
							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val((Number($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="money[]"]').val())-Number($('.order#order #'+tabs+' .listcontent .label:eq('+index2+')  input[name="discount[]"]').val()))*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
							var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
							/*設定檔內可設定使用何種進位*/
							if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
								$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val( roundfun($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val(),precision));
							}
							else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
								$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val( ceilfun($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val(),precision));
							}
							else{//無條件捨去
								$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val( floorfun($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val(),precision));
							}
							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #number').html($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="number[]"]').val());
							$('.order#order #'+tabs+' .listcontent .label:eq('+index2+') #subtotal').html($('.order#order #'+tabs+' .listcontent .label:eq('+index2+') input[name="subtotal[]"]').val());
							index2++;
						}
					}
					else{
					}
				}
				else{
				}
				if($('.order#order #tabs1 #tempbox input[name="personcount"]').length>0){
					if($('.setperson #view input[name="persons'+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+'"]').length>0){
						$('.setperson #view input[name="persons'+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #tabs1 #tempbox input[name="personcount"]').val()+'"]').val())+parseInt($('.order#order #tabs1 #tempbox input[name="number"]').val()));
						$('.setperson #buttons #submit').trigger('click');
					}
					else{
					}
				}
				else{
				}
			}
			else{
			}
			//$('.order#order #'+tabs+' .listcontentbox').scrollTop($('.order#order #'+tabs+' .listcontent').height());
		}
	});
	function updateview(){//更新目前點餐狀況
		var tabs=changetagtarget();
		var temp=$('.order#order #tabs1 #tempbox input[name="name"]').val().split(';');
		var temp2=$('.order#order #tabs1 #tempbox input[name="name2"]').val().split(';');
		var tobottom=0;
		if(temp2[0].length==0){
			var s=temp[0];
		}
		else{
			var s=temp[0]+' /'+temp2[0];
		}
		if($('.order#order #tabs1 #tempbox input[name="mname2"]').val()==''){
			var t1=$('.order#order #tabs1 #tempbox input[name="mname1"]').val();
			if($('.order#order #tabs1 #tempbox input[name="mname1"]').val()==''){
				var t3='';
			}
			else{
				var t3='('+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+')';
			}
		}
		else{
			var t1=$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+' /'+$('.order#order #tabs1 #tempbox input[name="mname2"]').val();
			if($('.order#order #tabs1 #tempbox input[name="mname1"]').val()==''){
				var t3='('+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+')';
			}
			else{
				var t3='('+$('.order#order #tabs1 #tempbox input[name="mname1"]').val()+' /'+$('.order#order #tabs1 #tempbox input[name="mname2"]').val()+')';
			}

		}
		if($.trim(t1).length>0&&$.trim($('.order#order #tabs1 #tempbox input[name="taste1name"]').val()).length>0){
			t1=t1+','+$('.order#order #tabs1 #tempbox input[name="taste1name"]').val();
		}
		else{
			//t1=t1+$('.order#order #tabs1 #tempbox input[name="taste1name"]').val()+'/'+$('.order#order #tabs1 #tempbox input[name="taste2name"]').val();
		}
		if($.trim($('.order#order #tabs1 #tempbox input[name="taste1name"]').val()).length>0){
			t3=t3+'<br>&nbsp;&nbsp;&nbsp;&nbsp;+'+$('.order#order #tabs1 #tempbox input[name="taste2"]').val();
		}
		else{
		}
		if($.trim(t1).length>0){
			t1='('+t1+')';
		}
		else{
		}
		$('.order#order #tabs1 #editview').val(s+t1);
		if($('.order#order #'+tabs+' .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') div:eq(1)').html()==''){
			$('.order#order #'+tabs+' .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') #view').html('+'+$('.order#order #tabs1 #editview').val());
		}
		else{
			//$('.order#order #'+tabs+' .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') #view').html($('.order#order #tabs1 #editview').val());
			$('.order#order #'+tabs+' .listcontent .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') #view').html(s+t3);
		}
		//console.log($('.order#order #tabs4 .focus').index('#tabs4 .label'));
		if(parseInt($('.order#order #'+tabs+' .focus').index('#'+tabs+' .label'))+1==$('.order#order #'+tabs+' .label').length){
			$('.order#order #'+tabs+' .listcontentbox').scrollTop($('.order#order #'+tabs+' .listcontent').height());
		}
		else{
		}
		/*$.ajax({
			url:'../secview/writeitem.ajax.php',
			method:'post',
			data:{'target':$('.order#order #tabs1 #tempbox input[name="target"]').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'company':$('.order#order .companydata #company').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'itemtype':$('.order#order #tabs1 #tempbox input[name="typeno"]').val(),'no':$('.order#order #tabs1 #tempbox input[name="no"]').val(),'dep':'','number':$('.order#order #tabs1 #tempbox input[name="number"]').val(),'mname':$('.order#order #tabs1 #tempbox input[name="mname1"]').val(),'money1':$('.order#order #tabs1 #tempbox input[name="unitprice"]').val(),'taste':$('.order#order #tabs1 #tempbox input[name="taste1"]').val(),'tastenumber':$('.order#order #tabs1 #tempbox input[name="taste1number"]').val(),'tastemoney':$('.order#order #tabs1 #tempbox input[name="taste1money"]').val(),'subtotal':$('.order#order #tabs1 #tempbox input[name="subtotal"]').val()},
			async: false,
			dataType:'json',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});*/
	}
	$('.order#order #menubox #itemfun').on('click','.itemfun12',function(event){//備註與加料按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽其他備註與加料選項',$(this).val());
		//oneEvent(event);
		var temp1=$('.order#order .parameters #taste1').val().split('－');
		temp1=temp1[0].split(';');
		var page=Number($('.order#order .initsetting #tastecol').val())*Number($('.order#order .initsetting #tasterow').val());
		
		if($('.order#order .parameters #taste1').val().length>0&&temp1[0]=='1'){
			var i=0;
			var temp1=$('.order#order .parameters #taste1').val().split('－');
			var temp2=[$('.order#order .parameters #taste1name').val()];
			var temp3=$('.order#order .parameters #taste1money').val().split('*');
			var temp4=[$('.order#order .parameters #taste2name').val()];
			var temp5=$('.order#order .parameters #background').val().split('－');
			var temp11=temp1[0].split(';');
			var temp22=temp2[0].split(';');
			var temp33=temp3[0].split(';');
			var temp44=temp4[0].split(';');
			var temp55=temp5[0].split(';');
			var tastearray=temp11[1].split(',');
			var tastenamearray=temp22[1].split(',');
			var tastemoneyarray=temp33[1].split(',');
			var tastenamearray2=temp44[1].split(',');
			var tastebackground=temp55[1].split(',');
			$('.taste2 #pre').prop('disabled',true);
			if(tastearray.length>Number(page)){
				$('.taste2 #next').prop('disabled',false);
			}
			else{
				$('.taste2 #next').prop('disabled',true);
			}
			$('.taste2 .tasteparameters').html('<input type="hidden" name="page" value="0">');
			$('.taste2 button[id^="tastebut"] div#name1').html('');
			$('.taste2 button[id^="tastebut"] div#name2').html('');
			$('.taste2 button[id^="tasteno"]').val('');
			$('.taste2 button[id^="tastemoney"]').val('');
			$('.taste2 button[id^="tastebut"]').prop('disabled',true);
			$('.taste2 button[id^="tastebut"]').css({'background-color':'transparent'});
			for(var i=0;i<tastearray.length;i++){
				if($('.taste2 .tasteparameters input[id="taste[]"]:eq('+i+')').length>0){
					$('.taste2 .tasteparameters input[id^="taste"]:eq('+i+')').val(tastearray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					$('.taste2 .tasteparameters input[id^="tastename"]:eq('+i+')').val(tastenamearray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					$('.taste2 .tasteparameters input[id^="tastename2"]:eq('+i+')').val(tastenamearray2[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					if(tastemoneyarray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]==''){
						$('.taste2 .tasteparameters input[id^="tastemoney"]:eq('+i+')').val('0');
					}
					else{
						$('.taste2 .tasteparameters input[id^="tastemoney"]:eq('+i+')').val(tastemoneyarray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					}
					$('.taste2 .tasteparameters input[id^="background"]:eq('+i+')').val(tastebackground[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
				}
				else{
					$('.taste2 .tasteparameters').append('<input type="hidden" id="taste[]" value="'+tastearray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]+'">');
					$('.taste2 .tasteparameters').append('<input type="hidden" id="tastename[]" value="'+tastenamearray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]+'">');
					$('.taste2 .tasteparameters').append('<input type="hidden" id="tastename2[]" value="'+tastenamearray2[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]+'">');
					if(tastemoneyarray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]==''){
						$('.taste2 .tasteparameters').append('<input type="hidden" id="tastemoney[]" value="0">');
					}
					else{
						$('.taste2 .tasteparameters').append('<input type="hidden" id="tastemoney[]" value="'+tastemoneyarray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]+'">');
					}
					$('.taste2 .tasteparameters').append('<input type="hidden" id="background[]" value="'+tastebackground[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]+'">');
				}
				
				if(i<((parseInt($('.taste2 .tasteparameters input[name="page"]').val()+1)*Number(page)))){
					$('.taste2 #tastebut'+i+' div#name1').html(tastenamearray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					$('.taste2 #tastebut'+i+' div#name2').html(tastenamearray2[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					$('.taste2 #tasteno'+i).val(tastearray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					if(tastemoneyarray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]==''){
						$('.taste2 #tastemoney'+i).val('0');
					}
					else{
						$('.taste2 #tastemoney'+i).val(tastemoneyarray[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]);
					}
					$('.taste2 #tastebut'+i).prop('disabled',false);
					$('.taste2 #tastebut'+i).css({'background-color':tastebackground[$('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i]});
				}
				else{
				}
			}
			/*for(;i<Number(page);i++){
				$('.taste2 #tastebut'+i).prop('disabled',true);
			}*/
			$('.taste2 #tastecontent').html('');
			if($.trim($('.order#order #tabs1 #tempbox input[name="taste1"]').val()).length>0){
				var tasteno=$('.order#order #tabs1 #tempbox input[name="taste1"]').val().split(',');
				var tastename=$('.order#order #tabs1 #tempbox input[name="taste1name"]').val().split(',');
				var tasteprice=$('.order#order #tabs1 #tempbox input[name="taste1price"]').val().split(',');
				var tastenumber=$('.order#order #tabs1 #tempbox input[name="taste1number"]').val().split(',');
				var tastecolor=$('.order#order #tabs1 #tempbox input[name="background"]').val().split(',');
				var newstr='';
				for(var i=0;i<tasteno.length;i++){
					if(tasteno[i]!='99999'){//2022/11/7 非自定義備註
						newstr='<div class="label" style="width:100%;padding:0;margin:0;overflow:hidden;"><div style="width:13%;height:40px;float:left;text-align:center;"><input type="checkbox" name="tastecheck[]" style="width:20px;height:20px;"></div><div style="width:34%;float:left;">';
						$.ajax({
							url:'./lib/js/get.tastedata.php',
							method:'post',
							async:false,
							data:{'company':$('.order#order .companydata #company').val(),'tasteno':tasteno[i]},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(typeof d['selecttype']!=='undefined'){
									newstr=newstr+'<input type="hidden" class="selecttype" value="'+d['selecttype']+'">';
								}
								else{
									newstr=newstr+'<input type="hidden" class="selecttype" value="1">';
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
						if(Number(tastenumber[i])>1){
							newstr=newstr+tastename[i].substr(0,(Number(tastename[i].length)-1-Number(tastenumber[i].length)))+'<input type="hidden" class="name" value="'+tastename[i].substr(0,(Number(tastename[i].length)-1-Number(tastenumber[i].length)))+'"><input type="hidden" class="no" value="'+tasteno[i]+'">';
						}
						else{
							newstr=newstr+tastename[i]+'<input type="hidden" class="name" value="'+tastename[i]+'"><input type="hidden" class="no" value="'+tasteno[i]+'">';
						}
						newstr=newstr+'</div><div style="width:17%;float:left;text-align:center;" id="unitprice">'+tasteprice[i]+'</div><div style="width:17%;float:left;text-align:center;" id="number">'+tastenumber[i]+'</div><div style="width:19%;float:left;text-align:center;" id="subtotal">'+(Number(tasteprice[i])*Number(tastenumber[i]))+'</div></div>';
						$('.taste2 #tastecontent').append(newstr);
					}
					else{
						newstr='<div class="label" style="width:100%;padding:0;margin:0;overflow:hidden;"><div style="width:13%;height:40px;float:left;text-align:center;"><input type="checkbox" name="tastecheck[]" style="width:20px;height:20px;"></div><div style="width:34%;float:left;">';
						newstr=newstr+'<input type="hidden" class="selecttype" value="0">';
						newstr=newstr+tastename[i]+'<input type="hidden" class="name" value="'+tastename[i]+'"><input type="hidden" class="no" value="'+tasteno[i]+'">';
						newstr=newstr+'</div><div style="width:17%;float:left;text-align:center;" id="unitprice">0</div><div style="width:17%;float:left;text-align:center;" id="number">1</div><div style="width:19%;float:left;text-align:center;" id="subtotal">0</div></div>';
						$('.taste2 #tastecontent').append(newstr);
					}
				}
			}
			else{
			}
			$('.taste2 input[name="othertaste"]').val('');
			taste2.dialog('open');
		}
		else{
			if($('.sysmeg #name1.syshint1').length>0){
				$('.sysmeg #name1.syshint1').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint1').length>0){
				$('.sysmeg #name2.syshint1').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
		}
	});
	$('.taste2 .sendothertaste').click(function(){//填入手打備註
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('填入手打備註',$('.taste2 input[name="othertaste"]').val().trim());
		if($('.taste2 input[name="othertaste"]').val().trim().length>0){
			if($.trim($('.taste2 #tastecontent').html()).length>0){
				var findkey=$.inArray('99999',$('.taste2 #tastecontent .no').map(function(){return $(this).val();}).get());
				if(findkey>=0){
					if(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())==0){
						$('.taste2 #tastecontent #number:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())+1);
						$('.taste2 #tastecontent #subtotal:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())*Number($('.taste2 #tastemoney'+$('.taste2 button[id^="tastebut"]').index(this)).val()));
					}
					else if(Number($('.taste2 #tastecontent #unitprice:eq('+findkey+')').html())>0){
						$('.taste2 #tastecontent #number:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())+1);
						$('.taste2 #tastecontent #subtotal:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())*Number($('.taste2 #tastemoney'+$('.taste2 button[id^="tastebut"]').index(this)).val()));
					}
					else{
						$('.taste2 #tastecontent .name:eq('+findkey+')').parent('div').html($('.taste2 input[name="othertaste"]').val()+'<input type="hidden" class="name" value="'+$('.taste2 input[name="othertaste"]').val()+'"><input type="hidden" class="no" value="99999">');
					}
				}
				else{
					var tt="<div class='label' style='width:100%;min-height:27px;padding:0;margin:0;overflow:hidden;'><div style='width:13%;height:27px;float:left;text-align:center;'><input type='checkbox' name='tastecheck[]' style='width:20px;height:20px;'></div><div style='width:34%;float:left;'><input type='hidden' class='selecttype' value='0'>"+$('.taste2 input[name="othertaste"]').val().trim()+"<input type='hidden' class='name' value='"+$('.taste2 input[name="othertaste"]').val().trim()+"'><input type='hidden' class='no' value='99999'></div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='unitprice'>0</div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='number'>1</div><div style='width:19%;height:100%;min-height:27px;float:left;text-align:center;' id='subtotal'>0</div></div>";
					$('.taste2 #tastecontent').append(tt);
				}
			}
			else{
				var tt="<div class='label' style='width:100%;min-height:27px;padding:0;margin:0;overflow:hidden;'><div style='width:13%;height:27px;float:left;text-align:center;'><input type='checkbox' name='tastecheck[]' style='width:20px;height:20px;'></div><div style='width:34%;float:left;'><input type='hidden' class='selecttype' value='0'>"+$('.taste2 input[name="othertaste"]').val().trim()+"<input type='hidden' class='name' value='"+$('.taste2 input[name="othertaste"]').val().trim()+"'><input type='hidden' class='no' value='99999'>"+"</div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='unitprice'>0</div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='number'>1</div><div style='width:19%;height:100%;min-height:27px;float:left;text-align:center;' id='subtotal'>0</div></div>";
				$('.taste2 #tastecontent').html(tt);
			}
		}
		else{
		}
		$('.taste2 input[name="othertaste"]').val('');
	});
	$('.taste2').on('click','button[id^="tastebut"]',function(event){//點選加料選項
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇備註或加料選項',$(this).find('#name1').html());
		//oneEvent(event);
		if($.trim($('.taste2 #tastecontent').html()).length>0){
			var findkey=$.inArray($('.taste2 #tasteno'+$('.taste2 button[id^="tastebut"]').index(this)).val(),$('.taste2 #tastecontent .no').map(function(){return $(this).val();}).get());
			if(findkey>=0){
				var index=$('.taste2 button[id^="tastebut"]').index(this);
				$.ajax({
					url:'./lib/js/get.tastedata.php',
					method:'post',
					async:false,
					data:{'company':$('.order#order .companydata #company').val(),'tasteno':$('.taste2 #tasteno'+index).val()},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(typeof d['selecttype']==='undefined'||d['selecttype']=='1'){
							if(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())==0){
								$('.taste2 #tastecontent #number:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())+1);
								$('.taste2 #tastecontent #subtotal:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())*Number($('.taste2 #tastemoney'+index).val()));
							}
							else{
								$('.taste2 #tastecontent #number:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())+1);
								$('.taste2 #tastecontent #subtotal:eq('+findkey+')').html(Number($('.taste2 #tastecontent #number:eq('+findkey+')').html())*Number($('.taste2 #tastemoney'+index).val()));
							}
						}
						else{
							//tt=tt+'<input type="hidden" class="selecttype" value="0">';
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
				var tt="<div class='label' style='width:100%;min-height:27px;padding:0;margin:0;overflow:hidden;'><div style='width:13%;height:27px;float:left;text-align:center;'><input type='checkbox' name='tastecheck[]' style='width:20px;height:20px;'></div><div style='width:34%;float:left;'>";
				$.ajax({
					url:'./lib/js/get.tastedata.php',
					method:'post',
					async:false,
					data:{'company':$('.order#order .companydata #company').val(),'tasteno':$('.taste2 #tasteno'+$('.taste2 button[id^="tastebut"]').index(this)).val()},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(typeof d['selecttype']!=='undefined'){
							tt=tt+'<input type="hidden" class="selecttype" value="'+d['selecttype']+'">';
						}
						else{
							tt=tt+'<input type="hidden" class="selecttype" value="1">';
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				tt=tt+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name1').html()+'<br>'+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name2').html()+"<input type='hidden' class='name' value='"+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name1').html();
				if($('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name2').html().length>0)tt=tt+'/'+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name2').html();
				tt=tt+"'><input type='hidden' class='no' value='"+$('.taste2 #tasteno'+$('.taste2 button[id^="tastebut"]').index(this)).val()+"'>"+"</div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='unitprice'>"+$('.taste2 #tastemoney'+$('.taste2 button[id^="tastebut"]').index(this)).val()+"</div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='number'>1</div><div style='width:19%;height:100%;min-height:27px;float:left;text-align:center;' id='subtotal'>"+$('.taste2 #tastemoney'+$('.taste2 button[id^="tastebut"]').index(this)).val()+"</div></div>";
				$('.taste2 #tastecontent').append(tt);
			}
		}
		else{
			var tt="<div class='label' style='width:100%;min-height:27px;padding:0;margin:0;overflow:hidden;'><div style='width:13%;height:27px;float:left;text-align:center;'><input type='checkbox' name='tastecheck[]' style='width:20px;height:20px;'></div><div style='width:34%;float:left;'>";
			$.ajax({
				url:'./lib/js/get.tastedata.php',
				method:'post',
				async:false,
				data:{'company':$('.order#order .companydata #company').val(),'tasteno':$('.taste2 #tasteno'+$('.taste2 button[id^="tastebut"]').index(this)).val()},
				dataType:'json',
				success:function(d){
					//console.log(d['selecttype']);
					if(typeof d['selecttype']!=='undefined'){
						tt=tt+'<input type="hidden" class="selecttype" value="'+d['selecttype']+'">';
					}
					else{
						tt=tt+'<input type="hidden" class="selecttype" value="1">';
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
			tt=tt+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name1').html()+'<br>'+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name2').html()+"<input type='hidden' class='name' value='"+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name1').html();
			if($('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name2').html().length>0)tt=tt+'/'+$('.taste2 #tastebut'+$('.taste2 button[id^="tastebut"]').index(this)+' div#name2').html();
			tt=tt+"'><input type='hidden' class='no' value='"+$('.taste2 #tasteno'+$('.taste2 button[id^="tastebut"]').index(this)).val()+"'>"+"</div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='unitprice'>"+$('.taste2 #tastemoney'+$('.taste2 button[id^="tastebut"]').index(this)).val()+"</div><div style='width:17%;height:100%;min-height:27px;float:left;text-align:center;' id='number'>1</div><div style='width:19%;height:100%;min-height:27px;float:left;text-align:center;' id='subtotal'>"+$('.taste2 #tastemoney'+$('.taste2 button[id^="tastebut"]').index(this)).val()+"</div></div>";
			$('.taste2 #tastecontent').html(tt);
		}
	});
	$('.taste2 #tastecontentbox').on('click','.label',function(event){//加料清單中，模擬label tag
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇加料與備註清單','click');
		//oneEvent(event);
		var index=$('.taste2 #tastecontentbox .label').index(this);
		$('.taste2 #tastecontentbox .label').removeClass('check');
		$('.taste2 #tastecontentbox .label:eq('+index+')').addClass('check');
		if($('.taste2 #tastecontentbox .label:eq('+index+') input[name^="tastecheck"]').prop('checked')){
			$('.taste2 #tastecontentbox .label:eq('+index+') input[name^="tastecheck"]').prop('checked',false);
		}
		else{
			$('.taste2 #tastecontentbox .label:eq('+index+') input[name^="tastecheck"]').prop('checked',true);
		}
	});
	$('.taste2').on('click','#tastefun1',function(event){//遞增備註與加料選項的數量
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('增加加料與備註數量',$(this).val());
		//oneEvent(event);
		if($('.taste2 #tastecontent .check .selecttype').val()=='1'){
			if(Number($('.taste2 #tastecontent .check #number').html())==0){
				$('.taste2 #tastecontent .check #number').html(Number($('.taste2 #tastecontent .check #number').html())+1);
				$('.taste2 #tastecontent .check #subtotal').html(Number($('.taste2 #tastecontent .check #subtotal').html())+Number($('.taste2 #tastecontent .check #unitprice').html()));
			}
			else{
				$('.taste2 #tastecontent .check #number').html(Number($('.taste2 #tastecontent .check #number').html())+1);
				$('.taste2 #tastecontent .check #subtotal').html(Number($('.taste2 #tastecontent .check #subtotal').html())+Number($('.taste2 #tastecontent .check #unitprice').html()));
			}
		}
		else{
		}
	});
	$('.taste2').on('click','#tastefun2',function(event){//遞減備註與加料選項的數量
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('減少加料與備註數量',$(this).val());
		//oneEvent(event);
		if((Number($('.taste2 #tastecontent .check #number').html())-1)>=0){
			$('.taste2 #tastecontent .check #number').html(Number($('.taste2 #tastecontent .check #number').html())-1);
			$('.taste2 #tastecontent .check #subtotal').html(Number($('.taste2 #tastecontent .check #subtotal').html())-Number($('.taste2 #tastecontent .check #unitprice').html()));
		}
		else{
			//$('.taste2 #tastecontent .check #number').html(0);
			//$('.taste2 #tastecontent .check #subtotal').html(0);
		}
		if(Number($('.taste2 #tastecontent .check #number').html())==0){
			$('.taste2 #tastecontent .check').remove();
		}
		else{
		}
	});
	$('.taste2').on('click','#pre',function(event){//遞減備註與加料的頁數
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('加料與備註換頁',$(this).find('#name1').html());
		//oneEvent(event);
		var page=Number($('.order#order .initsetting #tastecol').val())*Number($('.order#order .initsetting #tasterow').val());
		var i=0;

		$('.taste2 .tasteparameters input[name="page"]').val((parseInt($('.taste2 .tasteparameters input[name="page"]').val())-1));
		
		$('.taste2 #next').prop('disabled',false);
		if(parseInt($('.taste2 .tasteparameters input[name="page"]').val())==0){
			$('.taste2 #pre').prop('disabled',true);
		}
		else{
			$('.taste2 #pre').prop('disabled',false);
		}
		for(i=0;i<parseInt(page);i++){
			if(($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)<$('.taste2 .tasteparameters input[id="taste[]"]').length){
				$('.taste2 #tastebut'+i+' div#name1').html($('.taste2 .tasteparameters input[id="tastename[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tastebut'+i+' div#name2').html($('.taste2 .tasteparameters input[id="tastename2[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tasteno'+i).val($('.taste2 .tasteparameters input[id="taste[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tastemoney'+i).val($('.taste2 .tasteparameters input[id="tastemoney[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tastebut'+i).prop('disabled',false);
				$('.taste2 #tastebut'+i).css({'background-color':$('.taste2 .tasteparameters input[id="background[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val()});
			}
			else{
				break;
			}
		}
		for(;i<parseInt(page);i++){
			$('.taste2 #tastebut'+i+' div#name1').html('');
			$('.taste2 #tastebut'+i+' div#name2').html('');
			$('.taste2 #tasteno'+i).val('');
			$('.taste2 #tastemoney'+i).val('0');
			$('.taste2 #tastebut'+i).prop('disabled',true);
			$('.taste2 #tastebut'+i).css({'background-color':'transparent'});
		}
	});
	$('.taste2').on('click','#next',function(event){//遞增備註與加料的頁數
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('加料與備註換頁',$(this).find('#name1').html());
		//oneEvent(event);
		var page=Number($('.order#order .initsetting #tastecol').val())*Number($('.order#order .initsetting #tasterow').val());
		var i=0;
		
		$('.taste2 .tasteparameters input[name="page"]').val((parseInt($('.taste2 .tasteparameters input[name="page"]').val())+1));
		
		$('.taste2 #pre').prop('disabled',false);
		if(((parseInt($('.taste2 .tasteparameters input[name="page"]').val())+1)*parseInt(page))>=$('.taste2 .tasteparameters input[id="taste[]"]').length){
			$('.taste2 #next').prop('disabled',true);
		}
		else{
			$('.taste2 #next').prop('disabled',false);
		}

		for(i=0;i<parseInt(page);i++){
			if(($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)<$('.taste2 .tasteparameters input[id="taste[]"]').length){
				$('.taste2 #tastebut'+i+' div#name1').html($('.taste2 .tasteparameters input[id="tastename[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tastebut'+i+' div#name2').html($('.taste2 .tasteparameters input[id="tastename2[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tasteno'+i).val($('.taste2 .tasteparameters input[id="taste[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tastemoney'+i).val($('.taste2 .tasteparameters input[id="tastemoney[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val());
				$('.taste2 #tastebut'+i).prop('disabled',false);
				$('.taste2 #tastebut'+i).css({'background-color':$('.taste2 .tasteparameters input[id="background[]"]:eq('+($('.taste2 .tasteparameters input[name="page"]').val()*Number(page)+i)+')').val()});
			}
			else{
				break;
			}
		}
		for(;i<parseInt(page);i++){
			$('.taste2 #tastebut'+i+' div#name1').html('');
			$('.taste2 #tastebut'+i+' div#name2').html('');
			$('.taste2 #tasteno'+i).val('');
			$('.taste2 #tastemoney'+i).val('0');
			$('.taste2 #tastebut'+i).prop('disabled',true);
			$('.taste2 #tastebut'+i).css({'background-color':'transparent'});
		}
	});
	$('.taste2').on('click','#tastefun5',function(event){//刪除已點的備註或加料選項
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('刪除加料與備註','delete');
		//oneEvent(event);
		$('.taste2 #tastecontent input[name^="tastecheck"]:checked').parents('.label').remove();
	});
	$('.taste2').on('click','#tastefun6',function(event){//確認以點的備註與加料
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('確認加料與備註','submit');
		//oneEvent(event);
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		tastediff();
		var numberarray=$('.taste2 #tastecontent .label #number').map(function(){return $(this).html();}).get();
		var pricearray=$('.taste2 #tastecontent .label #unitprice').map(function(){return $(this).html();}).get();
		var tempnoarray=$('.taste2 #tastecontent .label .no').map(function(){return $.strPad($(this).val(),4);}).get();
		var tempnumberarray=$('.taste2 #tastecontent .label #number').map(function(){return $(this).html();}).get();
		if(tempnoarray.length>0&&$('.order#order .initsetting #tastegroup').val()=='1'){
			var tempmoney;
			$.ajax({
				url:'./lib/js/check.tastegroup.php',
				method:'post',
				async:false,
				data:{'taste':tempnoarray,'number':numberarray,'price':pricearray},
				dataType:'json',
				success:function(d){
					//noarray=d['taste'];
					tempnoarray=d['taste'];
					tempnumberarray=d['number'];
					tempmoney=d['money'][0];
					//console.log(noarray);
					//console.log(d['taste'].length);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
		}
		var tempsortarray=[];
		$.each(tempnoarray,function(index,value){
			tempsortarray[index]=value;
		});
		var sortarray=quicksort(tempsortarray);
		var noarray=$('.taste2 #tastecontent .label .no').map(function(){return $.strPad($(this).val(),4);}).get();
		//console.log(noarray);

		var tasteno='',tastename='',tastename2='',tasteprice='',tastenumber='',tastemoney=0,tastecolor='';
		$.each(sortarray,function(index,value){
			if($.trim(tasteno).length>0){
				//console.log(noarray);
				//console.log(value);
				if(Number(tempnumberarray[$.inArray(value,tempnoarray)])>1){
					tasteno=tasteno+','+Number(value);
					tastename=tastename+','+$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val()+'*'+tempnumberarray[$.inArray(value,tempnoarray)];
					tastename2=tastename2+'<br>&nbsp;&nbsp;&nbsp;&nbsp;+'+$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val()+'*'+tempnumberarray[$.inArray(value,tempnoarray)];
					tasteprice=tasteprice+','+$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') #unitprice').html();
					tastenumber=tastenumber+','+tempnumberarray[$.inArray(value,tempnoarray)];
				}
				else if(Number(tempnumberarray[$.inArray(value,tempnoarray)])==1){
					tasteno=tasteno+','+Number(value);
					tastename=tastename+','+$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val();
					tastename2=tastename2+'<br>&nbsp;&nbsp;&nbsp;&nbsp;+'+$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val();
					tasteprice=tasteprice+','+$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') #unitprice').html();
					tastenumber=tastenumber+','+tempnumberarray[$.inArray(value,tempnoarray)];
				}
				else{
					//console.log('1');
				}
			}
			else{
				if(Number(tempnumberarray[$.inArray(value,tempnoarray)])>1){
					tasteno=Number(value);
					tastename=$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val()+'*'+tempnumberarray[$.inArray(value,tempnoarray)];
					tastename2=$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val()+'*'+tempnumberarray[$.inArray(value,tempnoarray)];
					tasteprice=$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') #unitprice').html();
					tastenumber=tempnumberarray[$.inArray(value,tempnoarray)];
				}
				else if(Number(tempnumberarray[$.inArray(value,tempnoarray)])==1){
					tasteno=Number(value);
					tastename=$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val();
					tastename2=$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') .name').val();
					tasteprice=$('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') #unitprice').html();
					tastenumber=tempnumberarray[$.inArray(value,tempnoarray)];
				}
				else{
					//console.log('2');
				}
			}
			if(typeof tempmoney!=="undefined"){
				tastemoney=tempmoney;
			}
			else{
				tastemoney=Number(tastemoney)+Number($('.taste2 #tastecontent .label:eq('+$.inArray(value,noarray)+') #subtotal').html());
			}
		});
		taste2.dialog('close');
		diff();
		$('.order#order #tabs1 #tempbox input[name="taste1"]').val(tasteno);
		$('.order#order #tabs1 #tempbox input[name="taste1name"]').val(tastename);
		$('.order#order #tabs1 #tempbox input[name="taste1price"]').val(tasteprice);
		$('.order#order #tabs1 #tempbox input[name="taste1number"]').val(tastenumber);
		$('.order#order #tabs1 #tempbox input[name="taste1money"]').val(tastemoney);
		$('.order#order #tabs1 #tempbox input[name="taste2"]').val(tastename2);
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.order#order #tabs1 #tempbox input[name="money"]').val(roundfun(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+Number(tastemoney),precision));
			$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(roundfun(Number($('.order#order #tabs1 #tempbox input[name="money"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val())-Number($('.order#order #tabs1 #tempbox input[name="discount"]').val()),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.order#order #tabs1 #tempbox input[name="money"]').val(ceilfun(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+Number(tastemoney),precision));
			$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(ceilfun(Number($('.order#order #tabs1 #tempbox input[name="money"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val())-Number($('.order#order #tabs1 #tempbox input[name="discount"]').val()),precision));
		}
		else{//無條件捨去
			$('.itemdis #viewwindow #subtotal').html( floorfun($('.itemdis #viewwindow #subtotal').html(),precision));
			$('.order#order #tabs1 #tempbox input[name="money"]').val(floorfun(Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+Number(tastemoney),precision));
			$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(floorfun(Number($('.order#order #tabs1 #tempbox input[name="money"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val())-Number($('.order#order #tabs1 #tempbox input[name="discount"]').val()),precision));
		}
		$('.order#order #editview').trigger('change');
		updateview();
		sumsubtotal();
	});
	function tastediff(){//先行清空備註與加料的資料，方便更新備註與加料
		if($('.order#order #tabs1 #tempbox input[name="taste1money"]').val().length>1){
			$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.order#order #tabs1 #tempbox input[name="money"]').val())-Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val()));
		}
		else{
		}
		$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(Number($('.order#order #tabs1 #tempbox input[name="money"]').val())*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));
	}
	function quicksort(origArray) {//快速排序
		if (origArray.length <= 1) { 
			return origArray;
		}
		else {

			var left = [];
			var right = [];
			var newArray = [];
			var pivot = origArray.pop();
			var length = origArray.length;

			for (var i = 0; i < length; i++) {
				if ((9999-Number(origArray[i])) >= (9999-Number(pivot))) {
					left.push(origArray[i]);
				} else {
					right.push(origArray[i]);
				}
			}

			return newArray.concat(quicksort(left), pivot, quicksort(right));
		}
	}
	$.strPad = function(i,l,s) {//自動補0
		var o = i.toString();
		if (!s) { s = '0'; }
		while (o.length < l) {
			o = s + o;
		}
		return o;
	};
	$('.sysmeg .closesysmeg').click(function(){
		sysmeg.dialog('close');
	});
	/*使點餐清單中的title與content不會因為scroll bar而跑位*/
	/*if($('.order#order .listcontent').height()>$('.order#order .listcontentbox').height()){
		$('.order#order .listtitle').css({'width':'calc(100% - 15px)','padding-right':'15px'});
	}
	else{
		$('.order#order .listtitle').css({'width':'calc(100% - 5px)','padding-right':'5px'});
	}
	$('.order#order .listcontent').resize(function(){
		//console.log($('.order#order .listcontent').height()>$('.order#order .listcontentbox').height());
		//console.log($('.order#order .listcontent').height());
		//console.log($('.order#order .listcontentbox').height());
		if($('.order#order .listcontent').height()>$('.order#order .listcontentbox').height()){
			$('.order#order .listtitle').css({'width':'calc(100% - 15px)','padding-right':'15px'});
		}
		else{
			$('.order#order .listtitle').css({'width':'calc(100% - 5px)','padding-right':'5px'});
		}
	});*/
	/******************************************************/
	/*使加料清單中的title與content不會因為scroll bar而跑位*/
	if($('.order#order #tastecontent').height()>$('.order#order #tastecontentbox').height()){
		$('.order#order #tastetitle').css({'width':'calc(100% - 10px)','padding-right':'10px'});
	}
	else{
		$('.order#order #tastetitle').css({'width':'100%','padding-right':'0'});
	}
	$('.order#order #tastecontent').resize(function(){
		if($('.order#order #tastecontent').height()>$('.order#order #tastecontentbox').height()){
			$('.order#order #tastetitle').css({'width':'calc(100% - 10px)','padding-right':'10px'});
		}
		else{
			$('.order#order #tastetitle').css({'width':'100%','padding-right':'0'});
		}
	});
	/******************************************************/
	$('.order#order #tabs4').on('click','.listcontent .label',function(){//點餐清單中，模擬label tag
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('點選產品清單','click');
		//oneEvent(event);
		//console.log('1');
		var index=$('.order#order #tabs4 .listcontent .label').index(this);
		if($('.order#order #tabs4 .listcontent .label:eq('+index+')').prop('class')=='label focus'){
			$('.order#order #tabs4 .listcontent .label').removeClass( "focus" );
			$('.order#order #tabs4 .listcontent .label:eq('+index+')').addClass( "focus" );
			if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="order[]"]').val()=='－'){
				//console.log('11');
				var index2=index;
				var index3=(index-1);
				while($('.order#order #tabs4 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "check" );
					$('.order#order #tabs4 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',true);
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "focus" );
					index2++;
				}
				while($('.order#order #tabs4 .listcontent .label:eq('+index3+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "check" );
					$('.order#order #tabs4 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',true);
					$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "focus" );
					index3--;
				}
				$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "focus" );
				$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "check" );
				$('.order#order #tabs4 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',true);
			}
			else if($('.order#order #tabs4 .listcontent .label:eq('+(Number(index)+1)+') input[name="order[]"]').val()=='－'){
				//console.log('12');
				var index2=Number(index)+1;
				$('.order#order #tabs4 .listcontent .label:eq('+index+')').addClass( "check" );
				$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				while($('.order#order #tabs4 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "check" );
					$('.order#order #tabs4 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',true);
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "focus" );
					index2++;
				}
			}
			else{
				//console.log('13');
				$('.order#order #tabs4 .listcontent .label:eq('+index+')').addClass( "check" );
				$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				/*if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val()=='sys'){//猜測當初用來分辨是否為低銷溢收品項，但因為將低銷溢收轉至結帳畫面，因此無須判斷
				}
				else{*/
					getdata($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val(),$('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="no"]').val(),'old','','');
				//}
				/*if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked')){
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				}
				else{
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				}*/
			}
		}
		else if($('.order#order #tabs4 .listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.order#order #tabs4 .listcontent .label:eq('+index+')').prop('class')=='label focus check'){
			$('.order#order #tabs4 .listcontent .label').removeClass( "focus" );
			$('.order#order #tabs4 .listcontent .label:eq('+index+')').addClass( "focus" );
			if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="order[]"]').val()=='－'){
				var index2=index;
				var index3=(index-1);
				while($('.order#order #tabs4 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').removeClass( "check" );
					$('.order#order #tabs4 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',false);
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "focus" );
					index2++;
				}
				while($('.order#order #tabs4 .listcontent .label:eq('+index3+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index3+')').removeClass( "check" );
					$('.order#order #tabs4 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',false);
					$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "focus" );
					index3--;
				}
				$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "focus" );
				$('.order#order #tabs4 .listcontent .label:eq('+index3+')').removeClass( "check" );
				$('.order#order #tabs4 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',false);
			}
			else if($('.order#order #tabs4 .listcontent .label:eq('+(Number(index)+1)+') input[name="order[]"]').val()=='－'){
				var index2=Number(index)+1;
				$('.order#order #tabs4 .listcontent .label:eq('+index+')').removeClass( "check" );
				$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				while($('.order#order #tabs4 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').removeClass( "check" );
					$('.order#order #tabs4 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',false);
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "focus" );
					index2++;
				}
			}
			else{
				$('.order#order #tabs4 .listcontent .label:eq('+index+')').removeClass( "check" );
				$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				/*if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val()=='sys'){//猜測當初用來分辨是否為低銷溢收品項，但因為將低銷溢收轉至結帳畫面，因此無須判斷
				}
				else{*/
					getdata($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val(),$('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="no"]').val(),'old','','');
				//}
				/*if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked')){
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				}
				else{
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				}*/
			}
		}
		else{
			$('.order#order #tabs4 .listcontent .label').removeClass( "focus" );
			$('.order#order #tabs4 .listcontent .label:eq('+index+')').addClass( "focus" );
			if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="order[]"]').val()=='－'){
				$('.order#order #tabs1 #tempbox input[name="target"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('');
				$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
				$('.order#order #tabs1 #tempbox input[name="type"]').val('');
				$('.order#order #tabs1 #tempbox input[name="no"]').val('');
				$('.order#order #tabs1 #tempbox input[name="name"]').val('');
				$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
				$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
				$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
				$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
				$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
				$('.order#order #tabs1 #tempbox input[name="money"]').val('');
				$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
				$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
				$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
				$('.order#order #tabs1 #tempbox input[name="number"]').val('');
				$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
				$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
				$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
				$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
				$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
				$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('1');
				$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('0');
				$('.order#order #tabs1 #editview').val('');
				$('.order#order .parameters #typeno').val('');
				$('.order#order .parameters #type').val('');
				$('.order#order .parameters #no').val('');
				$('.order#order .parameters #name').val('');
				$('.order#order .parameters #msize').val('');
				$('.order#order .parameters input[id^="mname"]').val('');
				$('.order#order .parameters input[id^="money"]').val('');
				$('.order#order .parameters #taste1').val('');
				$('.order#order .parameters #taste1name').val('');
				$('.order#order .parameters #taste1money').val('');
				$('.order#order #menubox #itemfun .startchangetaste').val('0');
				$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
				var index2=index;
				var index3=(index-1);
				while($('.order#order #tabs4 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "focus" );
					index2++;
				}
				while($('.order#order #tabs4 .listcontent .label:eq('+index3+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "focus" );
					index3--;
				}
				$('.order#order #tabs4 .listcontent .label:eq('+index3+')').addClass( "focus" );
			}
			else if($('.order#order #tabs4 .listcontent .label:eq('+(Number(index)+1)+') input[name="order[]"]').val()=='－'){
				$('.order#order #tabs1 #tempbox input[name="target"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('');
				$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
				$('.order#order #tabs1 #tempbox input[name="type"]').val('');
				$('.order#order #tabs1 #tempbox input[name="no"]').val('');
				$('.order#order #tabs1 #tempbox input[name="name"]').val('');
				$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
				$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
				$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
				$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
				$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
				$('.order#order #tabs1 #tempbox input[name="money"]').val('');
				$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
				$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
				$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
				$('.order#order #tabs1 #tempbox input[name="number"]').val('');
				$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
				$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
				$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
				$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
				$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
				$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
				$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('1');
				$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('0');
				$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('0');
				$('.order#order #tabs1 #editview').val('');
				$('.order#order .parameters #typeno').val('');
				$('.order#order .parameters #type').val('');
				$('.order#order .parameters #no').val('');
				$('.order#order .parameters #name').val('');
				$('.order#order .parameters #msize').val('');
				$('.order#order .parameters input[id^="mname"]').val('');
				$('.order#order .parameters input[id^="money"]').val('');
				$('.order#order .parameters #taste1').val('');
				$('.order#order .parameters #taste1name').val('');
				$('.order#order .parameters #taste1money').val('');
				$('.order#order #menubox #itemfun .startchangetaste').val('0');
				$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
				//console.log('12');
				var index2=Number(index)+1;
				$('.order#order #tabs4 .listcontent .label:eq('+index+')').addClass( "check" );
				while($('.order#order #tabs4 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs4 .listcontent .label:eq('+index2+')').addClass( "focus" );
					index2++;
				}
			}
			else{
				/*if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val()=='sys'){//猜測當初用來分辨是否為低銷溢收品項，但因為將低銷溢收轉至結帳畫面，因此無須判斷
				}
				else{*/
					getdata($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val(),$('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="no"]').val(),'old','','');
				//}
			}
		}
		
		$('.order#order #tabs1 #tempbox input[name="target"]').val(index);
		$('.order#order #tabs1 #tempbox input[name="linenumber"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="linenumber"]').val());
		$('.order#order #tabs1 #tempbox input[name="typeno"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val());
		$('.order#order #tabs1 #tempbox input[name="type"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="type"]').val());
		$('.order#order #tabs1 #tempbox input[name="no"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="no"]').val());
		$('.order#order #tabs1 #tempbox input[name="personcount"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="personcount"]').val());
		$('.order#order #tabs1 #tempbox input[name="needcharge"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="needcharge"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis1"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="dis1"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis2"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="dis2"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis3"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="dis3"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis4"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="dis4"]').val());
		$('.order#order #tabs1 #tempbox input[name="name"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="name"]').val());
		$('.order#order #tabs1 #tempbox input[name="name2"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="name2"]').val());
		$('.order#order #tabs1 #tempbox input[name="isgroup"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="isgroup"]').val());
		$('.order#order #tabs1 #tempbox input[name="childtype"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="childtype"]').val());
		$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="mname1[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="mname2[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="insaleinv[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="unitprice"]').val());
		$('.order#order #tabs1 #tempbox input[name="money"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="money"]').val());
		$('.order#order #tabs1 #tempbox input[name="discount"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="discount"]').val());
		$('.order#order #tabs1 #tempbox input[name="discontent"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="discontent"]').val());
		$('.order#order #tabs1 #tempbox input[name="dispoint"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="dispoint"]').val());//2020/4/14 單品優惠使用點數
		$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="dispointtime"]').val());//2020/4/14 單品優惠使用在幾項產品上
		$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="number"]').val());
		$('.order#order #tabs1 #tempbox input[name="subtotal"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="subtotal"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="taste1"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1name"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="taste1name"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1price"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="taste1price"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1number"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="taste1number"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1money"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="taste1money"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste2"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="taste1name"]').val().replace(/,/g,'<br>&nbsp;&nbsp;&nbsp;&nbsp;+'));
		$('.order#order #tabs1 #tempbox input[name="background"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="background"]').val());
		$('.order#order #tabs1 #tempbox input[name="itemdis"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="itemdis"]').val());
		$('.order#order #tabs1 #tempbox input[name="listdis"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="listdis"]').val());
		$('.order#order #tabs1 #tempbox input[name="bothdis"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="bothdis"]').val());
		$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="usemempoint"]').val());
		$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="getpointtype[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="initgetpoint[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="getpoint"]').val($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="getpoint[]"]').val());
		if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name="templistitem[]"]').length>0){
			$('.order#order #content #numbox input').prop('disabled',true);
			$('.order#order #content #numbox button').prop('disabled',true);
			$('.order#order #content #menubox #itemfun table button[class^="itemmname"]').prop('disabled',true);
		}
		else{
			$('.order#order #content #numbox input').prop('disabled',false);
			$('.order#order #content #numbox button').prop('disabled',false);
			for(var i=1;i<=6;i++){
				if($('.order#order #content #menubox #itemfun table .itemmoney'+i).val()=='0'){
					$('.order#order #content #menubox #itemfun table .itemmname'+i).prop('disabled',true);
				}
				else{
					$('.order#order #content #menubox #itemfun table .itemmname'+i).prop('disabled',false);
				}
			}
			$('.order#order #content #menubox #itemfun .itemfun12').prop('disabled',false);
		}
		$('.order#order #numbox input[name="type"]').val('new');
		getdata($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="typeno"]').val(),$('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="no"]').val(),'old','','');
		updateview();
		if(($('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked')&&!$('.order#order #tabs4 .listcontent .label:eq('+index+')').hasClass('check'))||(!$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked')&&$('.order#order #tabs4 .listcontent .label:eq('+index+')').hasClass('check'))){
			$('.order#order #tabs4 .listcontent .label:eq('+index+')').trigger('click');
		}
		else{
		}

		if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[name^="itemdis"]').val()=='1'){
			$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',false);
		}
		else{
			$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',true);
		}
	});
	$('.order#order #tabs5').on('click','.listcontent .label',function(event){//套餐選項清單中，模擬label tag
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('點選套餐品項清單','click');
		//oneEvent(event);
		var index=$('.order#order #tabs5 .listcontent .label').index(this);
		
		//$('.order#order #tabs5 .listcontent .label').removeClass( "focus" );
		if($('.order#order #tabs5 .listcontent .label:eq('+index+')').prop('class')=='label focus'){
			/*if($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name="order[]"]').val()=='－'){
				var index2=index;
				var index3=(index-1);
				while($('.order#order #tabs5 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs5 .listcontent .label:eq('+index2+')').addClass( "check" );
					$('.order#order #tabs5 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',true);
					index2++;
				}
				while($('.order#order #tabs5 .listcontent .label:eq('+index3+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs5 .listcontent .label:eq('+index3+')').addClass( "check" );
					$('.order#order #tabs5 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',true);
					index3--;
				}
				$('.order#order #tabs5 .listcontent .label:eq('+index3+')').addClass( "check" );
				$('.order#order #tabs5 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',true);
			}
			else if($('.order#order #tabs5 .listcontent .label:eq('+(Number(index)+1)+') input[name="order[]"]').val()=='－'){
				var index2=Number(index)+1;
				$('.order#order #tabs5 .listcontent .label:eq('+index+')').addClass( "check" );
				$('.order#order #tabs5 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				while($('.order#order #tabs5 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs5 .listcontent .label:eq('+index2+')').addClass( "check" );
					$('.order#order #tabs5 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',true);
					index2++;
				}
			}
			else{*/
				$('.order#order #tabs5 .listcontent .label:eq('+index+')').addClass( "check" );
				$('.order#order #tabs5 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				/*if($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="typeno"]').val()=='sys'){//猜測當初用來分辨是否為低銷溢收品項，但因為將低銷溢收轉至結帳畫面，因此無須判斷
				}
				else{*/
					getdata($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="typeno"]').val(),$('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="no"]').val(),'old','','');
				//}
				/*if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked')){
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				}
				else{
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				}*/
			//}
		}
		else if($('.order#order #tabs5 .listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.order#order #tabs5 .listcontent .label:eq('+index+')').prop('class')=='label focus check'){
			/*if($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name="order[]"]').val()=='－'){
				var index2=index;
				var index3=(index-1);
				while($('.order#order #tabs5 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs5 .listcontent .label:eq('+index2+')').removeClass( "check" );
					$('.order#order #tabs5 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',false);
					index2++;
				}
				while($('.order#order #tabs5 .listcontent .label:eq('+index3+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs5 .listcontent .label:eq('+index3+')').removeClass( "check" );
					$('.order#order #tabs5 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',false);
					index3--;
				}
				$('.order#order #tabs5 .listcontent .label:eq('+index3+')').removeClass( "check" );
				$('.order#order #tabs5 .listcontent .label:eq('+index3+') input[type="checkbox"]').prop('checked',false);
			}
			else if($('.order#order #tabs5 .listcontent .label:eq('+(Number(index)+1)+') input[name="order[]"]').val()=='－'){
				var index2=Number(index)+1;
				$('.order#order #tabs5 .listcontent .label:eq('+index+')').removeClass( "check" );
				$('.order#order #tabs5 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				while($('.order#order #tabs5 .listcontent .label:eq('+index2+') input[name="order[]"]').val()=='－'){
					$('.order#order #tabs5 .listcontent .label:eq('+index2+')').removeClass( "check" );
					$('.order#order #tabs5 .listcontent .label:eq('+index2+') input[type="checkbox"]').prop('checked',false);
					index2++;
				}
			}
			else{*/
				$('.order#order #tabs5 .listcontent .label:eq('+index+')').removeClass( "check" );
				$('.order#order #tabs5 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				/*if($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="typeno"]').val()=='sys'){//猜測當初用來分辨是否為低銷溢收品項，但因為將低銷溢收轉至結帳畫面，因此無須判斷
				}
				else{*/
					getdata($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="typeno"]').val(),$('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="no"]').val(),'old','','');
				//}
				/*if($('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked')){
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
				}
				else{
					$('.order#order #tabs4 .listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
				}*/
			//}
		}
		else{
			$('.order#order #tabs5 .listcontent .label').removeClass( "focus" );
			$('.order#order #tabs5 .listcontent .label:eq('+index+')').addClass( "focus" );
		}
		$('.order#order #tabs1 #tempbox input[name="target"]').val($('.order#order #tabs5 .listcontent .label').index(this));
		$('.order#order #tabs1 #tempbox input[name="linenumber"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="linenumber"]').val());
		$('.order#order #tabs1 #tempbox input[name="typeno"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="typeno"]').val());
		$('.order#order #tabs1 #tempbox input[name="type"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="type"]').val());
		$('.order#order #tabs1 #tempbox input[name="no"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="no"]').val());
		$('.order#order #tabs1 #tempbox input[name="personcount"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="personcount"]').val());
		$('.order#order #tabs1 #tempbox input[name="needcharge"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="needcharge"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis1"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="dis1"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis2"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="dis2"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis3"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="dis3"]').val());
		$('.order#order #tabs1 #tempbox input[name="dis4"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="dis4"]').val());
		$('.order#order #tabs1 #tempbox input[name="name"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="name"]').val());
		$('.order#order #tabs1 #tempbox input[name="name2"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="name2"]').val());
		$('.order#order #tabs1 #tempbox input[name="isgroup"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="isgroup"]').val());
		$('.order#order #tabs1 #tempbox input[name="childtype"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="childtype"]').val());
		$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="mname1"]').val());
		$('.order#order #tabs1 #tempbox input[name="mname2"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="mname2"]').val());
		$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name="insaleinv[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="unitprice"]').val());
		$('.order#order #tabs1 #tempbox input[name="money"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="money"]').val());
		$('.order#order #tabs1 #tempbox input[name="discount"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="discount"]').val());
		$('.order#order #tabs1 #tempbox input[name="discontent"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="discontent"]').val());
		$('.order#order #tabs1 #tempbox input[name="dispoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="dispoint"]').val());//2020/4/14 單品優惠使用點數
		$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="dispointtime"]').val());//2020/4/14 單品優惠使用在幾項產品上
		$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="number"]').val());
		$('.order#order #tabs1 #tempbox input[name="subtotal"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="subtotal"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="taste1"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1name"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="taste1name"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1price"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="taste1price"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1number"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="taste1number"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste1money"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="taste1money"]').val());
		$('.order#order #tabs1 #tempbox input[name="taste2"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="taste1name"]').val().replace(/,/g,'<br>&nbsp;&nbsp;&nbsp;&nbsp;+'));
		$('.order#order #tabs1 #tempbox input[name="background"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="background"]').val());
		$('.order#order #tabs1 #tempbox input[name="itemdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="itemdis"]').val());
		$('.order#order #tabs1 #tempbox input[name="listdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="listdis"]').val());
		$('.order#order #tabs1 #tempbox input[name="bothdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="bothdis"]').val());
		$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="usemempoint"]').val());
		$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name="getpointtype[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name="initgetpoint[]"]').val());
		$('.order#order #tabs1 #tempbox input[name="getpoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name="getpoint[]"]').val());
		getdata($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="typeno"]').val(),$('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="no"]').val(),'old','g','');
		updateview();

		if($('.order#order #tabs5 .listcontent .label:eq('+index+') input[name^="itemdis"]').val()=='1'){
			$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',false);
		}
		else{
			$('.order#order #billfun #billfun1 button:eq(0)').prop('disabled',true);
		}
	});
	$('.order#order #menubox #itemfun').on('click','.itemfun',function(event){//將產品資訊中的價格與前十項的備註與加料填入按鈕中
		//oneEvent(event);
		for(var i=0;i<6;i++){
			if($('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val()!=""){
				$('.order#order #menubox #itemfun .itemmname'+(i+1)+' div#name1').html($('.order#order .parameters input[id="mname1[]"]:eq('+i+')').val());
				$('.order#order #menubox #itemfun .itemmname'+(i+1)+' div#name2').html($('.order#order .parameters input[id="mname2[]"]:eq('+i+')').val());
				$('.order#order #menubox #itemfun .itemmname'+(i+1)).prop('disabled',false);
				$('.order#order #menubox #itemfun .itemmoney'+(i+1)).val($('.order#order .parameters input[id="money[]"]:eq('+i+')').val());
				$('.order#order #menubox #itemfun .getpointtype'+(i+1)).val($('.order#order .parameters input[id="getpointtype[]"]:eq('+i+')').val());
				$('.order#order #menubox #itemfun .getpoint'+(i+1)).val($('.order#order .parameters input[id="getpoint[]"]:eq('+i+')').val());
			}
			else{
				$('.order#order #menubox #itemfun .itemmname'+(i+1)+' div#name1').html('');
				$('.order#order #menubox #itemfun .itemmname'+(i+1)+' div#name2').html('');
				$('.order#order #menubox #itemfun .itemmname'+(i+1)).prop('disabled',true);
				$('.order#order #menubox #itemfun .itemmoney'+(i+1)).val('0');
				$('.order#order #menubox #itemfun .getpointtype'+(i+1)).val('0');
				$('.order#order #menubox #itemfun .getpoint'+(i+1)).val('0');
			}
		}
		var tabs=changetagtarget();
		var temp1=[];
		var temp2=[];
		var temp3=[];
		var temp4=[];
		var tasteset1=$('.order#order .parameters #taste1').val().split('－');
		var tasteset2=[$('.order#order .parameters #taste1name').val()];
		var tasteset3=[$('.order#order .parameters #taste2name').val()];
		var tasteset4=$('.order#order .parameters #taste1money').val().split('*');
		var tasteset5=$('.order#order .parameters #background').val().split('－');
		var tastearray1=[];
		var tastearray2=[];
		var tastearray3=[];
		var tastearray4=[];
		var tastearray5=[];
		for(var i=0;i<tasteset1.length;i++){
			var t1=tasteset1[i].split(';');
			var t2=tasteset2[i].split(';');
			var t3=tasteset3[i].split(';');
			var t4=tasteset4[i].split(';');
			var t5=tasteset5[i].split(';');
			tastearray1.push(t1[0],t1[1]);
			tastearray2.push(t2[0],t2[1]);
			tastearray3.push(t3[0],t3[1]);
			tastearray4.push(t4[0],t4[1]);
			tastearray5.push(t5[0],t5[1]);
		}
		if(tastearray1[0]=='1'&&$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') input[name="order[]"]').val()!='－'){
			if(tastearray1[1].length>0){
				temp1=tastearray1[1].split(',');
				temp2=tastearray2[1].split(',');
				temp3=tastearray3[1].split(',');
				temp4=tastearray4[1].split(',');
				temp5=tastearray5[1].split(',');
			}
			else{
			}
			for(i=0;i<10;i++){
				if((Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)<temp1.length){
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').html(temp2[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun #taste'+i+' div#name2').html(temp3[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun #taste'+i).prop('disabled',false);
					$('.order#order #menubox #itemfun .tasteno'+i).val(temp1[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun .tasteprice'+i).val(temp4[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':temp5[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]});
				}
				else{
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').html('');
					$('.order#order #menubox #itemfun #taste'+i+' div#name2').html('');
					$('.order#order #menubox #itemfun #taste'+i).prop('disabled',true);
					$('.order#order #menubox #itemfun .tasteno'+i).val('');
					$('.order#order #menubox #itemfun .tasteprice'+i).val('');
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':''});
				}
			}
		}
		else if(tastearray1[0]=='1'&&$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+') input[name="order[]"]').val()=='－'){
			if(tastearray1[1].length>0){
				temp1=tastearray1[1].split(',');
				temp2=tastearray2[1].split(',');
				temp3=tastearray3[1].split(',');
				temp4=tastearray4[1].split(',');
				temp5=tastearray5[1].split(',');
			}
			else{
			}
			for(i=0;i<10;i++){
				if((Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)<temp1.length){
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').html(temp2[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun #taste'+i+' div#name2').html(temp3[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun #taste'+i).prop('disabled',false);
					$('.order#order #menubox #itemfun .tasteno'+i).val(temp1[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun .tasteprice'+i).val(temp4[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]);
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':temp5[(Number(i)+Number($('.order#order #menubox #itemfun .startchangetaste').val())*10)]});
				}
				else{
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').html('');
					$('.order#order #menubox #itemfun #taste'+i+' div#name2').html('');
					$('.order#order #menubox #itemfun #taste'+i).prop('disabled',true);
					$('.order#order #menubox #itemfun .tasteno'+i).val('');
					$('.order#order #menubox #itemfun .tasteprice'+i).val('');
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':''});
				}
			}
			/*var targetindex=$('.order#order #tabs1 #tempbox input[name="target"]').val();
			var i=0;
			while($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(Number($('.order#order #tabs1 #tempbox input[name="target"]').val())-i)+') input[name="order[]"]').val()=='－'){
				//console.log($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(Number($('.order#order #tabs1 #tempbox input[name="target"]').val())-i)+') input[name="order[]"]').val());
				i++;
			}
			i++;
			if($.inArray(i.toString(),tastearray1)>=0){
				if(tastearray1[$.inArray(i.toString(),tastearray1)+1].length>0){
					temp1=tastearray1[$.inArray(i.toString(),tastearray1)+1].split(',');
					temp2=tastearray2[$.inArray(i.toString(),tastearray1)+1].split(',');
					temp3=tastearray3[$.inArray(i.toString(),tastearray1)+1].split(',');
					temp4=tastearray4[$.inArray(i.toString(),tastearray1)+1].split(',');
					temp5=tastearray5[$.inArray(i.toString(),tastearray1)+1].split(',');
				}
				else{
				}
				for(i=0;i<10;i++){
					if(i<temp1.length){
						$('.order#order #menubox #itemfun #taste'+i+' div#name1').html(temp2[i]);
						$('.order#order #menubox #itemfun #taste'+i+' div#name2').html(temp3[i]);
						$('.order#order #menubox #itemfun #taste'+i).prop('disabled',false);
						$('.order#order #menubox #itemfun .tasteno'+i).val(temp1[i]);
						$('.order#order #menubox #itemfun .tasteprice'+i).val(temp4[i]);
						$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':temp5[i]});
					}
					else{
						$('.order#order #menubox #itemfun #taste'+i+' div#name1').html('');
						$('.order#order #menubox #itemfun #taste'+i+' div#name2').html('');
						$('.order#order #menubox #itemfun #taste'+i).prop('disabled',true);
						$('.order#order #menubox #itemfun .tasteno'+i).val('');
						$('.order#order #menubox #itemfun .tasteprice'+i).val('');
						$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':''});
					}
				}
			}
			else{
				for(i=0;i<10;i++){
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').html('');
					$('.order#order #menubox #itemfun #taste'+i+' div#name2').html('');
					$('.order#order #menubox #itemfun #taste'+i).prop('disabled',true);
					$('.order#order #menubox #itemfun .tasteno'+i).val('');
					$('.order#order #menubox #itemfun .tasteprice'+i).val('');
					$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':''});
				}
			}*/
		}
		else{
			for(i=0;i<10;i++){
				$('.order#order #menubox #itemfun #taste'+i+' div#name1').html('');
				$('.order#order #menubox #itemfun #taste'+i+' div#name2').html('');
				$('.order#order #menubox #itemfun #taste'+i).prop('disabled',true);
				$('.order#order #menubox #itemfun .tasteno'+i).val('');
				$('.order#order #menubox #itemfun .tasteprice'+i).val('');
				$('.order#order #menubox #itemfun #taste'+i+' div#name1').parent('button').css({'background-color':''});
			}
		}
		//console.log('tabs:'+tabs);
		//console.log('target:'+$('.order#order #tabs1 #tempbox input[name="target"]').val());
		//console.log('length:'+$('.order#order #'+tabs+' .listcontentbox .listcontent div[class^="label"]:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+')').find('input[name="templistitem[]"]').length);
		//console.log('no:'+$('.order#order #tabs1 #tempbox input[name="no"]').val());
		if($('.order#order #'+tabs+' .listcontentbox .listcontent div[class^="label"]:eq('+$('.order#order #tabs1 #tempbox input[name="target"]').val()+')').find('input[name="templistitem[]"]').length>0&&$('.order#order #tabs1 #tempbox input[name="no"]').val()!=''){
			//console.log('2');
			$('.order#order #content #numbox input').prop('disabled',true);
			$('.order#order #content #numbox button').prop('disabled',true);
			$('.order#order #content #menubox #itemfun table button').prop('disabled',true);
		}
		else{
			//console.log('1');
			$('.order#order #content #numbox input').prop('disabled',false);
			$('.order#order #content #numbox button').prop('disabled',false);
			//$('.order#order #content #menubox #itemfun table button').prop('disabled',false);
			for(var item=0;item<6;item++){
				if($('.order#order .parameters input[id="mname1[]"]:eq('+item+')').val()!=""){
					$('.order#order #menubox #itemfun .itemmname'+(item+1)).prop('disabled',false);
				}
				else{
					$('.order#order #menubox #itemfun .itemmname'+(item+1)).prop('disabled',true);

				}
			}
		}
		if(temp1.length<=10){
			$('.order#order #menubox #itemfun #changetaste').prop('disabled',true);
		}
		else{
			$('.order#order #menubox #itemfun #changetaste').prop('disabled',false);
		}
	});
	$('.order#order #list #funbox').on('click','#all',function(event){//全選點餐明細
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('全選點餐品項','check all');
		//oneEvent(event);
		var tabs=changetagtarget();
		$('.order#order #'+tabs+' form[data-id="listform"] .label').addClass('check');
		$('.order#order #'+tabs+' form[data-id="listform"] .label input[data-id="checkbox[]"]').prop('checked',true);
	});
	$('.order#order #list #funbox').on('click','#cancel',function(event){//取消勾選之點餐明細
		
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('取消勾選品項','uncheck all');
		//oneEvent(event);
		var tabs=changetagtarget();
		$('.order#order #'+tabs+' form[data-id="listform"] .label').removeClass('check');
		$('.order#order #'+tabs+' form[data-id="listform"] .label').removeClass('focus');
		$('.order#order #'+tabs+' form[data-id="listform"] .label input[data-id="checkbox[]"]').prop('checked',false);
	});
	$('.dblock .resend').click(function(){
		dblock.dialog('close');
		$('.order#order #billfun1 button:eq(4)').prop('disabled',false);
	});
	$('.order#order #billfun1').on('click','button',function(event){//功能區1功能按鈕
		//oneEvent(event);
		var tabs=changetagtarget();
		switch($('.order#order #billfun1 button').index(this)){
			case 0://'促銷'按鈕
				if($('.order#order .initsetting #steplog').val()=='1')writesteplog('單品促銷功能按鈕',$(this).val());
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)

				//初始化畫面
				$('.itemdis #viewwindow .name1').html('');
				if($('.itemdis #viewwindow .name2').length>0){
					$('.itemdis #viewwindow .name2').html('');
				}
				else{
				}
				$('.itemdis #viewwindow #unitprice').html('0');
				//$('.itemdis #viewwindow #taste').html('');
				$('.itemdis #viewwindow #tastemoney').html('0');
				$('.itemdis #viewwindow #number').html('0');
				$('.itemdis #viewwindow #subtotal').html('0');
				$('.itemdis #viewwindow #dis1').html('0');
				$('.itemdis #viewwindow #dis2').html('0');
				$('.itemdis #viewwindow #initpoint').html('0');
				$('.itemdis #viewwindow #memberpoint').html('0');
				$('.itemdis #viewwindow #total').html('0');
				//初始化畫面
				
				//2020/4/14
				if($('.order#order #tabs1 #tempbox input[name="getpointtype"]').val()=='1'&&$('.order#order #tabs1 #membutton #tel').html()!=''){//固定點數且有輸入會員
					$('.itemdis #funbox #memberpoint').css({'display':'inline-block'});
				}
				else{
					$('.itemdis #funbox #memberpoint').css({'display':'none'});
				}

				if($('.order#order #tabs1 #tempbox input[name="no"]').val().length<=0){
				}
				else{
					$('.itemdis #viewwindow .name1').html($('.order#order #tabs1 #tempbox input[name="name"]').val());
					if($('.itemdis #viewwindow .name2').length>0){
						$('.itemdis #viewwindow .name2').html($('.order#order #tabs1 #tempbox input[name="name2"]').val());
					}
					else{
					}
					$('.itemdis #viewwindow #unitprice').html($('.order#order #tabs1 #tempbox input[name="unitprice"]').val());//原單價
					//$('.itemdis #viewwindow #taste').html($('.order#order #tabs1 #tempbox input[name="taste1name"]').val());
					$('.itemdis #viewwindow #tastemoney').html($('.order#order #tabs1 #tempbox input[name="taste1money"]').val());//加料金額
					$('.itemdis #viewwindow #number').html($('.order#order #tabs1 #tempbox input[name="number"]').val());//數量
					$('.itemdis #viewwindow #subtotal').html((Number($('.order#order #tabs1 #tempbox input[name="unitprice"]').val())+Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val()))*Number($('.order#order #tabs1 #tempbox input[name="number"]').val()));//小計
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						$('.itemdis #viewwindow #subtotal').html( roundfun($('.itemdis #viewwindow #subtotal').html(),precision));
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						$('.itemdis #viewwindow #subtotal').html( ceilfun($('.itemdis #viewwindow #subtotal').html(),precision));
					}
					else{//無條件捨去
						$('.itemdis #viewwindow #subtotal').html( floorfun($('.itemdis #viewwindow #subtotal').html(),precision));
					}
					$('.itemdis #viewwindow #dis2').html($('.order#order #tabs1 #tempbox input[name="discount"]').val());//單品優惠
					$('.itemdis #viewwindow #disbut').val($('.order#order #tabs1 #tempbox input[name="discontent"]').val());//單品優惠方式
					if($('.order#order #MemberBill #tabs1 #membutton #memberpoint').length>0){//2020/4/17 紀錄目前會員擁有的會員點數
						$('.itemdis #viewwindow #initpoint').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());
					}
					else{
						$('.itemdis #viewwindow #initpoint').html('0');
					}
					if($('.order#order #tabs1 #tempbox input[name="dispoint"]').val()=='0'){
						$('.itemdis #viewwindow #memberpoint').html('0');//2020/4/14 單品優惠使用點數
					}
					else{
						$('.itemdis #viewwindow #memberpoint').html(parseInt($('.order#order #tabs1 #tempbox input[name="dispoint"]').val())-(parseInt($('.order#order #tabs1 #tempbox input[name="dispointtime"]').val())*parseInt($('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val())));//2020/4/14 單品優惠使用點數
					}
					$('.itemdis #viewwindow input[name="dispointtime"]').html($('.order#order #tabs1 #tempbox input[name="dispointtime"]').val());//2020/4/14 單品優惠使用在幾項產品上
					$('.itemdis #viewwindow #total').html($('.order#order #tabs1 #tempbox input[name="subtotal"]').val());//總計
					itemdis.dialog('open');
				}
				break;
			case 1://'刪除'按鈕
				if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳區功能按鈕',$(this).val());
				if($('.order#order #'+tabs+' form[data-id="listform"] .focus').length==0&&$('.order#order #'+tabs+' form[data-id="listform"] .label.check').length==0){
				}
				else{
					if(tabs=='tabs5'&&($('.order#order #'+tabs+' form[data-id="listform"] .label:eq(0) input[data-id="checkbox[]"]').prop('checked')||($('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.focus'))==0))){
						var r=confirm("您確認要取消套餐嗎？");
						if(r==true){
							if($('.order#order .initsetting #opentemp').val()=='1'){
								$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
							}
							else{
								$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
							}
							//2021/6/18 移動至結帳區功能頁中
							$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',true);
							//$('.order#order #billfun #billfun2 button:eq(5)').prop('disabled',true);
							/*$('.order#order #billfun #billfun2 button:eq(5)').val('套餐修改');
							$.ajax({
								url:'./lib/js/getsetname.ajax.php',
								method:'post',
								data:{'type':'set'},
								dataType:'json',
								success:function(d){
									$('.order#order #billfun #billfun2 button:eq(5) div#name1').html(d['button1']);
									$('.order#order #billfun #billfun2 button:eq(5) div#name2').html(d['button2']);
								},
								error:function(e){
									//console.log(e);
								}
							});*/
							if($('.order#order .companydata #ispad').val()=='submachine'){
								$('.order#order #billfun #billfun1 button:eq(3)').prop('disabled',true);
							}
							else{
								$('.order#order #billfun #billfun1 button:eq(3)').prop('disabled',false);
							}
							if($('.order#order .initsetting #openfloor').val()=='1'||$('.order#order .companydata #ispad').val()=='submachine'||$('.order#order .initsetting #salecash').val()=='0'){
								$('.order#order #billfun #billfun1 button:eq(6)').prop('disabled',true);
							}
							else{
								$('.order#order #billfun #billfun1 button:eq(6)').prop('disabled',false);
							}
							$('.order#order #'+tabs+' form[data-id="listform"] .listcontent').html('');
							$('.order#order #MemberBill #list #tabs4button').prop('disabled',false);
							$('.order#order #MemberBill #list #tabs5button').prop('disabled',true);
							$('.order#order #MemberBill #list #tabs4button').trigger('click');
							initmenu($('.order#order .initsetting #menutyperow').val(),$('.order#order .initsetting #menutypecol').val(),$('.order#order .initsetting #menurow').val(),$('.order#order .initsetting #menucol').val());
							$('.order#order #tabs1 #tempbox input[name="target"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
							$('.order#order #tabs1 #tempbox input[name="type"]').val('');
							$('.order#order #tabs1 #tempbox input[name="no"]').val('');
							$('.order#order #tabs1 #tempbox input[name="personcount"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="needcharge"]').val('1');
							$('.order#order #tabs1 #tempbox input[name="dis1"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dis2"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dis3"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dis4"]').val('');
							$('.order#order #tabs1 #tempbox input[name="name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
							$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('');
							$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
							$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
							$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
							$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
							$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="money"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
							$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
							$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
							$('.order#order #tabs1 #tempbox input[name="number"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
							$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="background"]').val('');
							$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
							$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
							$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
							$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
							$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('1');
							$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('0');
							$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('0');
							$('.order#order #tabs1 #editview').val('');
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]').prop('disabled',false);
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]').css({'color':'#ffffff'});
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(2)').prop('disabled',false);
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(2)').css({'color':'#ffffff'});
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(4)').prop('disabled',true);
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(4)').css({'color':'#a8a8a8'});
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(7)').prop('disabled',true);
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(7)').css({'color':'#a8a8a8'});
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(8)').prop('disabled',true);
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(8)').css({'color':'#a8a8a8'});
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(10)').prop('disabled',false);
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(10)').css({'color':'#000000'});
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(11)').prop('disabled',false);
							$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(11)').css({'color':'#000000'});
							if($('.order#order .initsetting #opentemp').val()=='1'){
								$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
							}
							else{
								$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
							}
							//2021/6/18 移動至結帳區功能頁中
							$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',true);
							//$('.order#order #billfun #billfun2 button:eq(5)').prop('disabled',true);
							$('.order#order #tabs1 #editview').val('');
							$('.order#order .parameters #typeno').val('');
							$('.order#order .parameters #type').val('');
							$('.order#order .parameters #no').val('');
							$('.order#order .parameters #name').val('');
							$('.order#order .parameters #msize').val('');
							$('.order#order .parameters input[id^="mname"]').val('');
							$('.order#order .parameters input[id^="money"]').val('');
							$('.order#order .parameters #taste1').val('');
							$('.order#order .parameters #taste1name').val('');
							$('.order#order .parameters #taste1money').val('');
							$('.order#order #menubox #itemfun .startchangetaste').val('0');
							$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
							$('.order#order #billfun #billfun1 button:eq(1)').prop('disabled',false);
							//2021/2/24 將原先功能與按鈕移除，換至外部網路訂單接口按鈕
							/*if($('.order#order .initsetting #weborder').val()=='1'){
								$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',false);
							}
							else{
								$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',true);
							}*/
							if($('.order#order .companydata #ispad').val()=='submachine'){
								//$('.order#order #billfun #billfun2 button:eq(3)').prop('disabled',true);
							}
							else{
								$.ajax({
									url:'./lib/js/checkopen.ajax.php',
									method:'post',
									async:false,
									data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
									data:'html',
									success:function(d){
										if(d=='error'){
											$('.order#order #billfun #billfun2 button:eq(0)').prop('disabled',false);
											$('.order#order #billfun #billfun2 button:eq(1)').prop('disabled',true);
										}
										else{
											$('.order#order #billfun #billfun2 button:eq(0)').prop('disabled',true);
											$('.order#order #billfun #billfun2 button:eq(1)').prop('disabled',false);
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.order#order #billfun #billfun2 button:eq(3)').prop('disabled',false);
							}
							$('.order#order #billfun #billfun2 button:eq(4)').prop('disabled',false);
							$('.order#order #billfun #billfun2 button:eq(6)').prop('disabled',false);
							if($('.order#order .companydata #ismobile').length>0&&$('.order#order .companydata #ismobile').val()=='1'){
								$('.order#order #billfun #billfun2 button:eq(7)').prop('disabled',true);
							}
							else{
								$('.order#order #billfun #billfun2 button:eq(7)').prop('disabled',false);
							}
							//2021/6/18 移動至結帳區功能頁中，所以確認後要再開啟常用功能頁
							$('.order#order #billfun #billfun2button').prop('disabled',false);
							$('.order#order #billfun #billfun3button').prop('disabled',false);
							$('.order#order #billfun #billfun1button').trigger('click');
							if($('.order#order .initsetting #menutype').val()==3){
								$('.order#order #menubox #itemtype').css({'display':''});
								$('.order#order #menubox #items').css({'display':'none'});
							}
							else{
							}
							if($('.order#order #tabs4 form[data-id="listform"] .label').length>0){
								$('.order#order #tabs4 form[data-id="listform"] .label:eq('+($('.order#order #tabs4 form[data-id="listform"] .label').length-1)+')').trigger('click');
							}
							else{
							}
						}
						else{
							$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[data-id="checkbox[]"]').prop('checked',false);
						}
					}
					else if(($('.order#order #'+tabs+' form[data-id="listform"] .label.check').length==0&&$('.order#order #'+tabs+' form[data-id="listform"] .label.focus input[name="templistitem[]"]').length>0)||$('.order#order #'+tabs+' form[data-id="listform"] .label.check input[name="templistitem[]"]').length>0){
						if($('.order#order .initsetting #printedvoid').val()=='1'){//2020/9/9 刪除已出單品項0>>不用驗證1>>需要驗證
							$('.verpsw input[name="type"]').val('printedvoid');
							verpsw.dialog('open');
						}
						else{
							reason.dialog('open');
						}
					}
					else{
						var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
						$('.order#order #tabs1 #tempbox input[name="target"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('');
						$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
						$('.order#order #tabs1 #tempbox input[name="type"]').val('');
						$('.order#order #tabs1 #tempbox input[name="no"]').val('');
						$('.order#order #tabs1 #tempbox input[name="personcount"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="needcharge"]').val('1');
						$('.order#order #tabs1 #tempbox input[name="dis1"]').val('');
						$('.order#order #tabs1 #tempbox input[name="dis2"]').val('');
						$('.order#order #tabs1 #tempbox input[name="dis3"]').val('');
						$('.order#order #tabs1 #tempbox input[name="dis4"]').val('');
						$('.order#order #tabs1 #tempbox input[name="name"]').val('');
						$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
						$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
						$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
						$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
						$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
						$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
						$('.order#order #tabs1 #tempbox input[name="money"]').val('');
						$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
						$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
						$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
						$('.order#order #tabs1 #tempbox input[name="number"]').val('');
						$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
						$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
						$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
						$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
						$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
						$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
						$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('1');
						$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('0');
						$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('0');
						$('.order#order #tabs1 #editview').val('');
						$('.order#order .parameters #typeno').val('');
						$('.order#order .parameters #type').val('');
						$('.order#order .parameters #no').val('');
						$('.order#order .parameters #name').val('');
						$('.order#order .parameters #msize').val('');
						$('.order#order .parameters input[id^="mname"]').val('');
						$('.order#order .parameters input[id^="money"]').val('');
						$('.order#order .parameters #taste1').val('');
						$('.order#order .parameters #taste1name').val('');
						$('.order#order .parameters #taste1money').val('');
						$('.order#order #menubox #itemfun .startchangetaste').val('0');
						$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
						if($('.order#order #'+tabs+' form[data-id="listform"] .label.check').length>0){
							var deltarget='check';
						}
						else{
							var deltarget='focus';
						}
						if(deltarget=='check'){
							var minticket=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.check'));
							var ticketlength=parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label').length)-1;
							while($('.order#order #'+tabs+' form[data-id="listform"] .label.check').length>0){
								var i=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.check'));
								if(tabs=='tabs4'){
									$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
									$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
										$('.order#order #banner #detail #viewtotal').val( roundfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( roundfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
										$('.order#order #banner #detail #viewtotal').val( ceilfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( ceilfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else{//無條件捨去
										$('.order#order #banner #detail #viewtotal').val( floorfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( floorfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
									$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

									$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									$('.setperson #buttons #submit').trigger('click');
									//
									//添加刪除理由
									//
									//2021/11/17
									/*if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').length>0){
										$('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())+parseInt($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
										$('.setperson #buttons #submit').trigger('click');
									}
									else{
									}*/
									if($('.order#order .initsetting #secview').val()=='1'){
										$.ajax({
											url:'../secview/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
												//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
										if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
											socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
											console.log('send message "listitemupdate" to secview');
										}
										else{
										}
									}
									else{
									}

									$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val(parseInt($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val())+parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispoint[]"]').val())-(parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispointtime[]"]').val())*parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="initgetpoint[]"]').val())));//2020/4/20 返還使用的點數
									$('.memdata #point').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());//2020/4/20 返還使用的點數

									if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
										//ajax傳送data還缺少'刪除理由'的變數//
										$.ajax({
											url:'./lib/js/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
									}
								}
								else if(tabs=='tabs5'&&$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="order[]"]').val()!='－'){//2021/6/21 選擇套餐選項的畫面中，跟隨商品不能刪除
									//$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
									//$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									/*if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
										$('.order#order #banner #detail #viewtotal').val( roundfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( roundfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
										$('.order#order #banner #detail #viewtotal').val( ceilfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( ceilfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else{//無條件捨去
										$('.order#order #banner #detail #viewtotal').val( floorfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( floorfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}*/
									//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
									//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

									//$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									//$('.setperson #buttons #submit').trigger('click');
									//
									//添加刪除理由
									//
									/*if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').length>0){
										$('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())+parseInt($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
										$('.setperson #buttons #submit').trigger('click');
									}
									else{
									}*/
									if($('.order#order .initsetting #secview').val()=='1'){
										$.ajax({
											url:'../secview/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
												//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
										if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
											socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
											console.log('send message "listitemupdate" to secview');
										}
										else{
										}
									}
									else{
									}

									//$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val(parseInt($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val())+parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispoint[]"]').val())-(parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispointtime[]"]').val())*parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="initgetpoint[]"]').val())));//2020/4/20 返還使用的點數
									//$('.memdata #point').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());//2020/4/20 返還使用的點數

									/*if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
										//ajax傳送data還缺少'刪除理由'的變數//
										$.ajax({
											url:'./lib/js/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{*/
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
									/*}*/
								}
								else{
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').removeClass( "check" );
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').removeClass( "focus" );
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[type="checkbox"]').prop('checked',false);
								}
							}
							if($('.order#order #'+tabs+' form[data-id="listform"] .label').length>0){
								if(minticket==0){
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq(0)').trigger('click');
								}
								else{
									if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+minticket+') input[name="order[]"]').val()=='－'){
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+minticket+')').trigger('click');
									}
									else{
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(parseInt(minticket)-1)+')').trigger('click');
									}
								}
							}
							else{
							}
						}
						else{
							var minticket=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.focus'));
							//console.log(minticket);
							var ticketlength=parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label').length)-1;
							//console.log(ticketlength);
							while($('.order#order #'+tabs+' form[data-id="listform"] .label.focus').length>0){
								var i=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.focus'));
								if(tabs=='tabs4'){
									$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
									$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
										$('.order#order #banner #detail #viewtotal').val( roundfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( roundfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
										$('.order#order #banner #detail #viewtotal').val( ceilfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( ceilfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else{//無條件捨去
										$('.order#order #banner #detail #viewtotal').val( floorfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( floorfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
									$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

									$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									$('.setperson #buttons #submit').trigger('click');
									//
									//添加刪除理由
									//
									//2021/11/17
									/*if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').length>0){
										$('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())+parseInt($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
										$('.setperson #buttons #submit').trigger('click');
									}
									else{
									}*/
									if($('.order#order .initsetting #secview').val()=='1'){
										$.ajax({
											url:'../secview/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
												//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
										if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
											socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
											console.log('send message "listitemupdate" to secview');
										}
										else{
										}
									}
									else{
									}

									$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val(parseInt($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val())+parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispoint[]"]').val())-(parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispointtime[]"]').val())*parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="initgetpoint[]"]').val())));//2020/4/20 返還使用的點數
									$('.memdata #point').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());//2020/4/20 返還使用的點數

									if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
										//ajax傳送data還缺少'刪除理由'的變數//
										$.ajax({
											url:'./lib/js/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
									}
								}
								else if(tabs=='tabs5'&&$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="order[]"]').val()!='－'){//2021/6/21 選擇套餐選項的畫面中，跟隨商品不能刪除
									//$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
									//$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									/*if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
										$('.order#order #banner #detail #viewtotal').val( roundfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( roundfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
										$('.order#order #banner #detail #viewtotal').val( ceilfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( ceilfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}
									else{//無條件捨去
										$('.order#order #banner #detail #viewtotal').val( floorfun($('.order#order #banner #detail #viewtotal').val(),precision));
										$('.order#order #banner #detail #viewnumber').val( floorfun($('.order#order #banner #detail #viewnumber').val(),precision));
									}*/
									//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
									//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

									//$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									//$('.setperson #buttons #submit').trigger('click');
									//
									//添加刪除理由
									//
									/*if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').length>0){
										$('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())+parseInt($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
										$('.setperson #buttons #submit').trigger('click');
									}
									else{
									}*/
									if($('.order#order .initsetting #secview').val()=='1'){
										$.ajax({
											url:'../secview/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
												//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
										if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
											socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
											console.log('send message "listitemupdate" to secview');
										}
										else{
										}
									}
									else{
									}

									//$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val(parseInt($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val())+parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispoint[]"]').val())-(parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="dispointtime[]"]').val())*parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="initgetpoint[]"]').val())));//2020/4/20 返還使用的點數
									//$('.memdata #point').html($('.order#order #MemberBill #tabs1 #membutton #memberpoint').val());//2020/4/20 返還使用的點數

									/*if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
										//ajax傳送data還缺少'刪除理由'的變數//
										$.ajax({
											url:'./lib/js/voiditem.ajax.php',
											method:'post',
											async: false,
											data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'voiditem.ajax.php '+d},
														dataType:'html',
														success:function(d){
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{*/
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
									/*}*/
								}
								else{
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').removeClass( "focus" );
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[type="checkbox"]').prop('checked',false);
								}
							}
							if($('.order#order #'+tabs+' form[data-id="listform"] .label').length>0){
								if(minticket==0){
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq(0)').trigger('click');
								}
								else{
									if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+minticket+') input[name="order[]"]').val()=='－'){
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+minticket+')').trigger('click');
									}
									else{
										$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(parseInt(minticket)-1)+')').trigger('click');
									}
								}
							}
							else{
							}
						}
						/*for(var i=($('.order#order #'+tabs+' form[data-id="listform"] .label').length-1);i>=0;i--){
							if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked')){
								$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
								$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
								$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
								$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

								$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
								$('.setperson #buttons #submit').trigger('click');
								//
								//添加刪除理由
								//
								if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').length>0){
									$('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())+parseInt($('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
									$('.setperson #buttons #submit').trigger('click');
								}
								else{
								}
								if($('.order#order .initsetting #secview').val()=='1'){
									$.ajax({
										url:'../secview/voiditem.ajax.php',
										method:'post',
										async: false,
										data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val()},
										dataType:'html',
										success:function(d){
											if(d.length>20||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'voiditem.ajax.php '+d},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
											else{
											}
											//console.log(d);
											//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
									//ajax傳送data還缺少'刪除理由'的變數//
									$.ajax({
										url:'./lib/js/voiditem.ajax.php',
										method:'post',
										async: false,
										data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val()},
										dataType:'html',
										success:function(d){
											if(d.length>20||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'voiditem.ajax.php '+d},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
											else{
											}
											$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
								}
							}
							else{
							}
						}*/
						$('.order#order #numbox input[type="button"]:eq(14)').prop('disabled',true);
						$('.order#order #numbox input[type="button"]:eq(14)').css({'color':'#a8a8a8'});
						if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="templistitem[]"]').length!=$('.order#order #MemberBill #tabs4 form[data-id="listform"] .label').length){
						}
						else{
							if($('.order#order .initsetting #controltable').val()==1){
								$.ajax({
									url:'./lib/js/change.button4.php',
									method:'post',
									data:{'type':'b'},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
											$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
										}
										else{
										}
										if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
											$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[0]);
										}
										else{
										}
										if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
											$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
										}
										else{
										}
										$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
						}
					}
				}
				break;
			case 2://'開錢櫃'按鈕
				if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳區功能按鈕',$(this).val());
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'-cashdrawer_'+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						api_sendmessage_posdvr('cashdrawer');
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success cashdrawer','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//2017/12/29var mywin=window.open('cashdrawer://','','width=1px,height=1px');
				//2017/12/29mywin.document.title='cashdrawer';
				break;
			case 3://'結帳'按鈕
				if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳區功能按鈕',$(this).val());
				$.ajax({
					url:'./lib/js/checkopen.ajax.php',
					method:'post',
					async:false,
					data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'checkopen.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
						if(d=='success'){
							if($('.order#order #'+tabs+' .listcontent .label').length<=0){
							}
							else{
								var precision=$('.order#order .initsetting #accuracy').val();//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
								$('.result input[name="sendtype"]').val('result');
								if($('.order#order .initsetting #openpay').val()=='1'){
									$('.result .numbox .otherpay').prop('disabled',false);
									$('.result .numbox .otherfunction').prop('disabled',false);
								}
								else{
									$('.result .numbox .otherpay').prop('disabled',true);
									$('.result .numbox .otherfunction').prop('disabled',true);
								}
								if($('.order#order .initsetting #cashbut').val()=='1'){
									$('.result .numbox .cashbut').prop('disabled',false);
								}
								else{
									$('.result .numbox .cashbut').prop('disabled',true);
								}
								$('.result .numbox .moneybut').prop('disabled',false);
								$('.result #funbox #loopbut #name1').html($('.order#order .initsetting #listprintname1').val());
								$('.result #funbox #loopbut #name2').html($('.order#order .initsetting #listprintname2').val());
								$('.result #viewwindow .sendviewwindow input[name="looptype"]').val($('.order#order .initsetting #looptype').val());
								if($('.order#order .initsetting #openchar').val()=='0'){
									$('.result #funbox .chargebut').prop('disabled',true);
									$('.result #funbox .chargebut #name1').html('不收服務費');
									$('.result #funbox #charno').html($('.order#order .initsetting #charge').val());
								}
								else{
									$('.result #funbox .chargebut').prop('disabled',false);
									if($('.order#order .initsetting #charge').val()=='1'&&$('.order#order #content #tabs4 .listcontentbox input[name="listtype"]').val()=='1'){
										$('.result #funbox .chargebut #name1').html('收服務費');
										$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
									}
									else{
										$('.result #funbox .chargebut #name1').html('不收服務費');
										$('.result #funbox #charno').val('0');
									}
								}
								$('.result #funbox .receiptbut #name1').html('不列印收據章');
								$('.result #funbox #receipt').val('0');
								//$('.result .numbox .ban #name1').html('輸入統編');
								$('.result input[name="view"]').val('');
								$('.result input[name="view"]').css({'background-color':'#FFFFFF'});
								$('.result #viewwindow input[name="tempban"]').css({'background-color':'#EFEBDE'});
								$('.result #viewwindow input[name="tempban"]').prop('readonly',true);
								$('.result #viewwindow input[name="tempban"]').val($('.order#order #tabs1 #membutton #companynumber').val());
								$.ajax({
									url:'../secview/writeban.ajax.php',
									method:'post',
									data:{'tempban':'','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()}
								});
								$('.result #viewwindow input[name="tempcontainer"]').css({'background-color':'#EFEBDE'});
								$('.result #viewwindow input[name="tempcontainer"]').prop('readonly',true);
								$('.result #viewwindow input[name="tempcontainer"]').val('');
								if($('.result #viewwindow input[name="treetel"]').length>0&&$('.result #viewwindow input[name="treetel"]').val()!=''){
									$('.result #viewwindow input[name="treetel"]').css({'background-color':'#EFEBDE'});
									$('.result #viewwindow input[name="treetel"]').prop('readonly',true);
									$('.result #viewwindow input[name="treetel"]').val('');
									$('.result #funbox .pointtree #name2').html('');
									$('.result #funbox .pointtree #name3').html('');
									$.ajax({
										url:'../secview/writepoint.ajax.php',
										method:'post',
										data:{'tel':'','point':'0','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()}
									});
								}
								else{
								}
								$('.result .target').val('view');
								if($('.result .caninilistdis').length>0&&$('.result .canlistdis').length>0&&$('.result .cannotlistdis').length>0){//分別計算能否帳單優惠的產品總金額；計算允許使用會員點數的產品總金額//2020/4/20 計算單品促銷所使用的點數總量
									$('.result .caninilistdis').val('0');
									$('.result .canlistdis').val('0');
									$('.result .cannotlistdis').val('0');
									$('.result .canusemempoint').val('0');
									$('.result .usepoint').val('0');
									if($('.order#order .initsetting #pxpayplus').val()=='1'){//2022/11/7 若有開啟全支付串接，需額外產生產品明細json備用
										var pxpayplus_itemjson=[];
									}
									else{
									}
									for(var i=0;i<$('.order#order #tabs4 .listcontent .label').length;i++){
										$('.result .caninilistdis').val(parseFloat($('.result .caninilistdis').val())+parseFloat($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val())+parseFloat($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="discount[]"]').val()));
										if($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="listdis[]"]').val()=='1'){
											if(parseFloat($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="discount[]"]').val())>0){//具有單品促銷

												if($('.order#order #tabs1 #membutton #tel').html().length>0){//2020/4/20 有輸入會員才需要計算使用的點數
													if($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="dispoint[]"]').val()!=0){//有使用單品促銷－點數兌換
														$('.result .usepoint').val(parseInt($('.result .usepoint').val())+parseInt(parseInt($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="dispoint[]"]').val())-(parseInt($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="dispointtime[]"]').val())*parseInt($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="initgetpoint[]"]').val()))));
													}
													else{
													}
												}
												else{
												}

												if($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="bothdis[]"]').val()=='1'){//允許同時使用單品促銷與帳單折扣(讓)
													$('.result .canlistdis').val(parseFloat($('.result .canlistdis').val())+parseFloat($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val()));
												}
												else{
													continue;
												}
											}
											else{
												$('.result .canlistdis').val(parseFloat($('.result .canlistdis').val())+parseFloat($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val()));
											}
										}
										else{
											$('.result .cannotlistdis').val(parseFloat($('.result .cannotlistdis').val())+parseFloat($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val()));
										}
										if($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="usemempoint[]"]').val()=='1'&&$('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="getpointtype[]"]').val()=='2'){//2020/4/20 品項中多一個屬性，紀錄該品項的集點方式；固定點數、金額點數。本欄位是只計算金額點數
											$('.result .canusemempoint').val(parseFloat($('.result .canusemempoint').val())+parseFloat($('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val()));
										}
										else{
										}
										if($('.order#order .initsetting #pxpayplus').val()=='1'){//2022/11/7 若有開啟全支付串接，需額外產生產品明細json備用
											pxpayplus_itemjson.push({"name":$('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="name[]"]').val(),"amount":$('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val(),"qty":$('.order#order #tabs4 .listcontent .label:eq('+i+') input[name="number[]"]').val()});
										}
										else{
										}
									}
									if($('.order#order .initsetting #pxpayplus').val()=='1'){//2022/11/7 若有開啟全支付串接，需額外產生產品明細json備用
										$('.order#order .pxpayplus #item_json').val(JSON.stringify(pxpayplus_itemjson));
									}
									else{
									}
								}
								else{
								}
								$('.result #viewwindow #total').html('0');
								$('.result #viewwindow #temptotal').val('0');
								$('.result #viewwindow #itemdis').html('0');
								$('.result #viewwindow #tempdis').val('0');
								$('.result #viewwindow #memberdis').html('0');
								$('.result #viewwindow #listdis1').html('0');
								$('.result #viewwindow #listdis2').html('0');
								$('.result #viewwindow #charge').html('0');
								$('.result #viewwindow #coupon1').html('0');
								$('.result #viewwindow #coupon2').html('0');
								$('.result #viewwindow #should').html('0');
								$('.result #viewwindow #ininv').html('0');
								$('.result #viewwindow input[name="ininv"]').val('0');
								$('.result #viewwindow #freeinv').html('0');
								$('.result #viewwindow input[name="freeinv"]').val('0');
								$('.result #viewwindow #cashcomm').html('0');
								$('.result #viewwindow #already').html('0');
								$('.result #viewwindow #cashmoney').html('0');
								$('.result #viewwindow #cash').html('0');
								$('.result #viewwindow #other').html('0');
								$('.result #viewwindow #otherfix').html('0');
								$('.result #viewwindow #change').html('0');
								if(($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0')||($('.order#order #banner #detail #oinv').length>0&&$('.order#order #banner #detail #oinv').val()=='ERROR')){
									var con=confirm('目前發票數量不足，是否繼續結帳？');
									if(con==true){
										$('.result #funbox .invbut').prop('disabled',true);
										$('.result #funbox .invbut #name1').html('不開立發票');
										$('.result #funbox .invno').val('0');
										if($('.order#order .initsetting #comfloor').val()=='1'){
											var total=0;
											$.each($('.order#order #'+tabs+' form[data-id="listform"] .label'),function(index,value){
												total=Number(total)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
											});
											if(Number(total)<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
												$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(total)));
											}
											else{
												$('.result #viewwindow input[name="floorspan"]').val('0');
											}
										}
										else{
											if(Number($('.order#order #banner #detail #viewtotal').val())<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
												$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number($('.order#order #banner #detail #viewtotal').val())));
											}
											else{
												$('.result #viewwindow input[name="floorspan"]').val('0');
											}
										}
										if(Number($('.result #viewwindow input[name="floorspan"]').val())>0){
											var t=confirm('不足低銷，將以低消計算('+$('.result .frontunit').val()+$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val()+$('.result .unit').val()+')');
											if(t==true){
												/*var total=0;
												var dis=0;
												$.each($('.order#order #'+tabs+' form[data-id="listform"] .label'),function(index,value){
													total=Number(total)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
													dis=Number(dis)+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
												});*/
												$('.result #viewwindow #total').html($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
												$('.result #viewwindow #itemdis').html('0');
												if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
													$.ajax({
														url:'./lib/js/compdis.ajax.php',
														method:'post',
														async: false,
														data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
														dataType:'html',
														success:function(d){
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'compdis.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															var temp=d.split(';');
															if($.isNumeric(temp[0])){
																$('.result #viewwindow #autodis').html(temp[0]);
																$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
																$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
															}
															else{
																$('.result #viewwindow #autodis').html('0');
																$('.result #viewwindow input[name="autodiscontent"]').val('');
																$('.result #viewwindow input[name="autodispremoney"]').val('0');
															}
															//console.log(d);
														},
														error:function(e){
															//console.log(e)
														}
													});
												}
												else{
													$('.result #viewwindow #autodis').html('0');
													$('.result #viewwindow input[name="autodiscontent"]').val('');
													$('.result #viewwindow input[name="autodispremoney"]').val('0');
												}
												//$('.result #viewwindow #memberdis').html((Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html()))*%+NUMBER);//設定檔內設定
												$('.result #viewwindow #memberdis').html(0);
												if($('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()==''){
												}
												else{
													if($('.order#order .initsetting #member').val()=='1'){
														if($('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
															$.ajax({
																url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php',
																method:'post',
																async: false,
																data:{'type':'online','company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
																dataType:'json',
																success:function(d){
																	if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online success)'},
																			dataType:'html',
																			success:function(d){/*console.log(d);*/},
																			error:function(e){/*console.log(e);*/}
																		});
																	}
																	else{
																	}
																	var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
																	if(typeof d[0]['type']==="undefined"||d[0]['type']=='1'){
																		var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d[0]['discount']))/100;
																		//$('.result #viewwindow #memberdis').html();
																		/*設定檔內可設定使用何種進位*/
																		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																			temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																			$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																		}
																		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																			$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																		}
																		else{//無條件捨去
																			$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																		}
																		//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
																	}
																	else{
																		var memshould=$('.result #viewwindow #should').html();
																		var memtimes=0;
																		$('.result #viewwindow #memberdis').html('0');
																		while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																			$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																			memshould=Number(memshould)-Number(d[0]['needbuy']);
																			memtimes++;
																		}
																		//console.log($('.result #viewwindow #memberdis').html());
																		//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
																	}
																},
																error:function(e){
																	//console.log(e);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online error) '+e},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
															});
														}
														else{//本地會員
															$.ajax({
																url:'./lib/js/getmemdis.ajax.php',
																method:'post',
																async: false,
																data:{'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
																dataType:'json',
																success:function(d){
																	if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'getmemdis.ajax.php'},
																			dataType:'html',
																			success:function(d){/*console.log(d);*/},
																			error:function(e){/*console.log(e);*/}
																		});
																	}
																	else{
																	}
																	var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
																	if(typeof d[0]['type']==="undefined"||d[0]['type']=='1'){
																		var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d))/100;
																		//$('.result #viewwindow #memberdis').html();
																		/*設定檔內可設定使用何種進位*/
																		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																			temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																			$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																		}
																		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																			$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																		}
																		else{//無條件捨去
																			$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																		}
																		//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
																	}
																	else{
																		var memshould=$('.result #viewwindow #should').html();
																		var memtimes=0;
																		$('.result #viewwindow #memberdis').html('0');
																		while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																			$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																			memshould=Number(memshould)-Number(d[0]['needbuy']);
																			memtimes++;
																		}
																		//console.log($('.result #viewwindow #memberdis').html());
																		//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
																	}
																},
																error:function(e){
																	//console.log(e);
																}
															});
														}
													}
													else{
													}
												}
												/*設定檔內設定*/
												if($('.order#order .initsetting #openchar').val()=='1'&&$('.result #funbox #charno').val()=='1'){//開啟服務費
													if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
														$('.result #viewwindow #charge').html(Number($('.result #viewwindow #total').html())*(Number($('.order#order .initsetting #chargenumber').val())/100));
													}
													else{//依照折扣後價格
														$('.result #viewwindow #charge').html((Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
														//console.log($('.result #viewwindow #charge').html());
													}
													var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
													/*設定檔內可設定使用何種進位*/
													if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
														$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
													}
													else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
														$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
													}
													else{//無條件捨去
														$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
													}
													$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
												}
												else{//關閉服務費
												}
												$('.result #viewwindow #should').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html())+Number($('.result #viewwindow #charge').html())-Number($('.result #viewwindow #coupon1').html())-Number($('.result #viewwindow #coupon2').html())-Number($('.result #viewwindow #autodis').html()));
												$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
												var precision=$('.order#order .initsetting #accuracy').val();//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
												/*設定檔內可設定使用何種進位*/
												if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
													$('.result #viewwindow #should').html( roundfun($('.result #viewwindow #should').html(),precision));
													$('.result #viewwindow #listtotal').html( roundfun($('.result #viewwindow #listtotal').html(),precision));
												}
												else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
													$('.result #viewwindow #should').html( ceilfun($('.result #viewwindow #should').html(),precision));
													$('.result #viewwindow #listtotal').html( ceilfun($('.result #viewwindow #listtotal').html(),precision));
												}
												else{//無條件捨去
													$('.result #viewwindow #should').html( floorfun($('.result #viewwindow #should').html(),precision));
													$('.result #viewwindow #listtotal').html( floorfun($('.result #viewwindow #listtotal').html(),precision));
												}
												$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val($('.result #viewwindow #should').html());
												for(var i=0;i<$('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]').length;i++){
													//console.log($('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]:eq('+i+')').val());
													if($('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]:eq('+i+')').val()=='0'){
														$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val(Number($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val())-Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
													}
													else{
														$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
														$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());
													}
												}
												$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number(+Number($('.result #viewwindow #charge').html())));
												if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
													$('.result #viewwindow #ininv').html( roundfun($('.result #viewwindow #ininv').html(),precision));
												}
												else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
													$('.result #viewwindow #ininv').html( ceilfun($('.result #viewwindow #ininv').html(),precision));
												}
												else{//無條件捨去
													$('.result #viewwindow #ininv').html( floorfun($('.result #viewwindow #ininv').html(),precision));
												}
												$('.result #viewwindow #freeinv').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()));
												$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());

												if((Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()))>=0){
												}
												else{//免稅金額小於總折扣金額，不足額於應稅金額彌補
													$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.result #viewwindow #freeinv').html()));
													$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());

													$('.result #viewwindow #freeinv').html('0');
													$('.result #viewwindow input[name="freeinv"]').val('0');
												}

												$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
												$('.result #paywindow #paycontent').html('');
												$('.result #viewwindow #already').html('0');
												$('.result #viewwindow #cashmoney').html('0');
												$('.result #viewwindow #cash').html('0');
												$('.result #viewwindow #other').html('0');
												$('.result #viewwindow #otherfix').html('0');
												$('.result #viewwindow input[name="already"]').val('0');
												$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
												result.dialog('open');
											}
											else{
											}
										}
										else{
											var total=0;
											var dis=0;
											var temptotal=0;//加總需計算服務費之產品總金額
											var tempdis=0;//加總需計算服務費之產品總折扣
											$.each($('.order#order #'+tabs+' form[data-id="listform"] .label'),function(index,value){
												total=Number(total)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
												dis=Number(dis)+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
												if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="needcharge[]"]').val()=='1'){
													temptotal=Number(temptotal)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
													tempdis=Number(tempdis)+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
												}
												else{
												}
											});
											$('.result #viewwindow #total').html(total);
											$('.result #viewwindow #temptotal').val(temptotal);
											$('.result #viewwindow #itemdis').html(dis);
											$('.result #viewwindow #tempdis').val(tempdis);
											if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
												$.ajax({
													url:'./lib/js/compdis.ajax.php',
													method:'post',
													async: false,
													data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
													dataType:'html',
													success:function(d){
														if(d.length>20||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'compdis.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														var temp=d.split(';');
														if($.isNumeric(temp[0])){
															$('.result #viewwindow #autodis').html(temp[0]);
															$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
															$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
														}
														else{
															$('.result #viewwindow #autodis').html('0');
															$('.result #viewwindow input[name="autodiscontent"]').val('');
															$('.result #viewwindow input[name="autodispremoney"]').val('0');
														}
														//console.log(d);
													},
													error:function(e){
														//console.log(e)
													}
												});
											}
											else{
												$('.result #viewwindow #autodis').html('0');
												$('.result #viewwindow input[name="autodiscontent"]').val('');
												$('.result #viewwindow input[name="autodispremoney"]').val('0');
											}
											//$('.result #viewwindow #memberdis').html((Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html()))*%+NUMBER);//設定檔內設定
											$('.result #viewwindow #memberdis').html(0);
											if($('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()==''){
											}
											else{
												if($('.order#order .initsetting #member').val()=='1'){
													if($('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php',
															method:'post',
															async: false,
															data:{'type':'online','company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
															dataType:'json',
															success:function(d){
																if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online success) '+JSON.stringify(d)},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
																var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
																if(typeof d[0]['type']==="undefined"||d[0]['type']=='1'){
																	//console.log('1');
																	var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d[0]['discount']))/100;
																	//$('.result #viewwindow #memberdis').html();
																	/*設定檔內可設定使用何種進位*/
																	if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																		temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																		$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																	}
																	else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																		$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																	}
																	else{//無條件捨去
																		$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																	}
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
																}
																else{
																	//console.log('2');
																	var memshould=$('.result #viewwindow #should').html();
																	var memtimes=0;
																	$('.result #viewwindow #memberdis').html('0');
																	while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																		$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																		memshould=Number(memshould)-Number(d[0]['needbuy']);
																		memtimes++;
																	}
																	//console.log($('.result #viewwindow #memberdis').html());
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
																}
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online error) '+e},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
														});
													}
													else{
														$.ajax({
															url:'./lib/js/getmemdis.ajax.php',
															method:'post',
															async: false,
															data:{'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
															dataType:'json',
															success:function(d){
																if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'getmemdis.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
																var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
																if(typeof d[0]['type']==="undefined"||d[0]['type']=='1'){
																	var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d))/100;
																	//$('.result #viewwindow #memberdis').html();
																	/*設定檔內可設定使用何種進位*/
																	if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																		temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																		$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																	}
																	else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																		$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																	}
																	else{//無條件捨去
																		$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																	}
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
																}
																else{
																	var memshould=$('.result #viewwindow #should').html();
																	var memtimes=0;
																	$('.result #viewwindow #memberdis').html('0');
																	while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																		$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																		memshould=Number(memshould)-Number(d[0]['needbuy']);
																		memtimes++;
																	}
																	//console.log($('.result #viewwindow #memberdis').html());
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
												}
												else{
												}
											}
											/*設定檔內設定*/
											if($('.order#order .initsetting #openchar').val()=='1'&&$('.result #funbox #charno').val()=='1'){//開啟服務費
												if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
													$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())+Number($('.result #viewwindow input[name="floorspan"]').val()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
												}
												else{//依照折扣後價格
													$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())+Number($('.result #viewwindow input[name="floorspan"]').val())-Number($('.result #viewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
												}
												var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
												/*設定檔內可設定使用何種進位*/
												if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
													$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
												}
												else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
													$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
												}
												else{//無條件捨去
													$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
												}
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
											}
											else{//關閉服務費
											}
											$('.result #viewwindow #should').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html())+Number($('.result #viewwindow #charge').html())-Number($('.result #viewwindow #coupon1').html())-Number($('.result #viewwindow #coupon2').html())-Number($('.result #viewwindow #autodis').html()));
											$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
											var precision=$('.order#order .initsetting #accuracy').val();//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
											/*設定檔內可設定使用何種進位*/
											if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
												$('.result #viewwindow #should').html( roundfun($('.result #viewwindow #should').html(),precision));
												$('.result #viewwindow #listtotal').html( roundfun($('.result #viewwindow #listtotal').html(),precision));
											}
											else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
												$('.result #viewwindow #should').html( ceilfun($('.result #viewwindow #should').html(),precision));
												$('.result #viewwindow #listtotal').html( ceilfun($('.result #viewwindow #listtotal').html(),precision));
											}
											else{//無條件捨去
												$('.result #viewwindow #should').html( floorfun($('.result #viewwindow #should').html(),precision));
												$('.result #viewwindow #listtotal').html( floorfun($('.result #viewwindow #listtotal').html(),precision));
											}
											$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val($('.result #viewwindow #should').html());
											for(var i=0;i<$('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]').length;i++){
												//console.log($('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]:eq('+i+')').val());
												if($('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]:eq('+i+')').val()=='0'){
													$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val(Number($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val())-Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
												}
												else{
													$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
													$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());
												}
												//console.log($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val());
											}
											$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number(+Number($('.result #viewwindow #charge').html())));
											if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
												$('.result #viewwindow #ininv').html( roundfun($('.result #viewwindow #ininv').html(),precision));
											}
											else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
												$('.result #viewwindow #ininv').html( ceilfun($('.result #viewwindow #ininv').html(),precision));
											}
											else{//無條件捨去
												$('.result #viewwindow #ininv').html( floorfun($('.result #viewwindow #ininv').html(),precision));
											}
											$('.result #viewwindow #freeinv').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()));
											$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
											if((Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()))>=0){
											}
											else{//免稅金額小於總折扣金額，不足額於應稅金額彌補
												$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.result #viewwindow #freeinv').html()));
												$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());

												$('.result #viewwindow #freeinv').html('0');
												$('.result #viewwindow input[name="freeinv"]').val('0');
											}

											$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
											$('.result #paywindow #paycontent').html('');
											$('.result #viewwindow #already').html('0');
											$('.result #viewwindow #cashmoney').html('0');
											$('.result #viewwindow #cash').html('0');
											$('.result #viewwindow #other').html('0');
											$('.result #viewwindow #otherfix').html('0');
											$('.result #viewwindow input[name="already"]').val('0');
											$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
											result.dialog('open');
										}
									}
									else{
									}
								}
								else{
									$('.result .numbox .ban').prop('disabled',false);
									$('.result .numbox .carrier').prop('disabled',false);
									$('.result .numbox .carrier2').prop('disabled',false);
									$('.result .numbox .donate').prop('disabled',false);
									$('.result #funbox .invbut').prop('disabled',false);
									$('.result #funbox .invbut #name1').html('開立發票');
									$('.result #funbox .invno').val('1');
									if($('.order#order .initsetting #comfloor').val()=='1'){
										var total=0;
										$.each($('.order#order #'+tabs+' form[data-id="listform"] .label'),function(index,value){
											total=Number(total)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
										});
										if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
											total=roundfun(total,precision);
										}
										else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
											total=ceilfun(total,precision);
										}
										else{//無條件捨去
											total=floorfun(total,precision);
										}
										if(Number(total)<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
											$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(total)));
										}
										else{
											$('.result #viewwindow input[name="floorspan"]').val('0');
										}
										if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
											$('.result #viewwindow input[name="floorspan"]').val(roundfun($('.result #viewwindow input[name="floorspan"]').val(),precision));
										}
										else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
											$('.result #viewwindow input[name="floorspan"]').val(ceilfun($('.result #viewwindow input[name="floorspan"]').val(),precision));
										}
										else{//無條件捨去
											$('.result #viewwindow input[name="floorspan"]').val(floorfun($('.result #viewwindow input[name="floorspan"]').val(),precision));
										}
									}
									else{
										if(Number($('.order#order #banner #detail #viewtotal').val())<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
											$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number($('.order#order #banner #detail #viewtotal').val())));
										}
										else{
											$('.result #viewwindow input[name="floorspan"]').val('0');
										}
										if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
											$('.result #viewwindow input[name="floorspan"]').val(roundfun($('.result #viewwindow input[name="floorspan"]').val(),precision));
										}
										else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
											$('.result #viewwindow input[name="floorspan"]').val(ceilfun($('.result #viewwindow input[name="floorspan"]').val(),precision));
										}
										else{//無條件捨去
											$('.result #viewwindow input[name="floorspan"]').val(floorfun($('.result #viewwindow input[name="floorspan"]').val(),precision));
										}
									}
									if(Number($('.result #viewwindow input[name="floorspan"]').val())>0){
										var t=confirm('不足低銷，將以低消計算('+$('.result .frontunit').val()+$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val()+$('.result .unit').val()+')');
										if(t==true){
											/*var total=0;
											var dis=0;
											$.each($('.order#order #'+tabs+' form[data-id="listform"] .label'),function(index,value){
												total=Number(total)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
												dis=Number(dis)+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
											});*/
											$('.result #viewwindow #total').html($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
											$('.result #viewwindow #temptotal').val($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
											$('.result #viewwindow #itemdis').html('0');
											$('.result #viewwindow #tempdis').val('0');
											if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
												$.ajax({
													url:'./lib/js/compdis.ajax.php',
													method:'post',
													async: false,
													data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
													dataType:'html',
													success:function(d){
														if(d.length>20||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'compdis.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														var temp=d.split(';');
														if($.isNumeric(temp[0])){
															$('.result #viewwindow #autodis').html(temp[0]);
															$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
															$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
														}
														else{
															$('.result #viewwindow #autodis').html('0');
															$('.result #viewwindow input[name="autodiscontent"]').val('');
															$('.result #viewwindow input[name="autodispremoney"]').val('0');
														}
														//console.log(d);
													},
													error:function(e){
														//console.log(e)
													}
												});
											}
											else{
												$('.result #viewwindow #autodis').html('0');
												$('.result #viewwindow input[name="autodiscontent"]').val('');
												$('.result #viewwindow input[name="autodispremoney"]').val('0');
											}
											//$('.result #viewwindow #memberdis').html((Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html()))*%+NUMBER);//設定檔內設定
											$('.result #viewwindow #memberdis').html(0);
											if($('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()==''){
											}
											else{
												if($('.order#order .initsetting #member').val()=='1'){
													if($('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php',
															method:'post',
															async: false,
															data:{'type':'online','company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
															dataType:'json',
															success:function(d){
																if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online success) '+JSON.stringify(d)},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
																var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
																if(typeof d[0]['type']==="undefined"||d[0]['type']=='1'){
																	var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d[0]['discount']))/100;
																	//$('.result #viewwindow #memberdis').html();
																	/*設定檔內可設定使用何種進位*/
																	if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																		temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																		$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																	}
																	else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																		$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																	}
																	else{//無條件捨去
																		$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																	}
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
																}
																else{
																	var memshould=$('.result #viewwindow #should').html();
																	var memtimes=0;
																	$('.result #viewwindow #memberdis').html('0');
																	while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																		$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																		memshould=Number(memshould)-Number(d[0]['needbuy']);
																		memtimes++;
																	}
																	//console.log($('.result #viewwindow #memberdis').html());
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
																}
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online error) '+e},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
														});
													}
													else{
														$.ajax({
															url:'./lib/js/getmemdis.ajax.php',
															method:'post',
															async: false,
															data:{'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
															dataType:'json',
															success:function(d){
																if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'getmemdis.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
																var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
																if(typeof d[0]['type']==="undefined"||d[0]['type']=='1'){
																	var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d))/100;
																	//$('.result #viewwindow #memberdis').html();
																	/*設定檔內可設定使用何種進位*/
																	if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																		temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																		$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																	}
																	else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																		$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																	}
																	else{//無條件捨去
																		$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																	}
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
																}
																else{
																	var memshould=$('.result #viewwindow #should').html();
																	var memtimes=0;
																	$('.result #viewwindow #memberdis').html('0');
																	while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																		$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																		memshould=Number(memshould)-Number(d[0]['needbuy']);
																		memtimes++;
																	}
																	//console.log($('.result #viewwindow #memberdis').html());
																	//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
												}
												else{
												}
											}
											/*設定檔內設定*/
											if($('.order#order .initsetting #openchar').val()=='1'&&$('.result #funbox #charno').val()=='1'){//開啟服務費
												if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
													$('.result #viewwindow #charge').html(Number($('.result #viewwindow #temptotal').val())*(Number($('.order#order .initsetting #chargenumber').val())/100));
												}
												else{//依照折扣後價格
													$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
													//console.log($('.result #viewwindow #charge').html());
												}
												var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
												/*設定檔內可設定使用何種進位*/
												if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
													$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
												}
												else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
													$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
												}
												else{//無條件捨去
													$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
												}
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
											}
											else{//關閉服務費
											}
											$('.result #viewwindow #should').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html())+Number($('.result #viewwindow #charge').html())-Number($('.result #viewwindow #coupon1').html())-Number($('.result #viewwindow #coupon2').html())-Number($('.result #viewwindow #autodis').html()));
											$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
											var precision=$('.order#order .initsetting #accuracy').val();//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
											/*設定檔內可設定使用何種進位*/
											if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
												$('.result #viewwindow #should').html( roundfun($('.result #viewwindow #should').html(),precision));
												$('.result #viewwindow #listtotal').html( roundfun($('.result #viewwindow #listtotal').html(),precision));
											}
											else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
												$('.result #viewwindow #should').html( ceilfun($('.result #viewwindow #should').html(),precision));
												$('.result #viewwindow #listtotal').html( ceilfun($('.result #viewwindow #listtotal').html(),precision));
											}
											else{//無條件捨去
												$('.result #viewwindow #should').html( floorfun($('.result #viewwindow #should').html(),precision));
												$('.result #viewwindow #listtotal').html( floorfun($('.result #viewwindow #listtotal').html(),precision));
											}
											$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val($('.result #viewwindow #should').html());
											for(var i=0;i<$('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]').length;i++){
												if($('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]:eq('+i+')').val()=='0'){
													$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val(Number($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val())-Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
												}
												else{
													$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
													$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());
												}
											}
											$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number(+Number($('.result #viewwindow #charge').html())));
											if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
												$('.result #viewwindow #ininv').html( roundfun($('.result #viewwindow #ininv').html(),precision));
											}
											else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
												$('.result #viewwindow #ininv').html( ceilfun($('.result #viewwindow #ininv').html(),precision));
											}
											else{//無條件捨去
												$('.result #viewwindow #ininv').html( floorfun($('.result #viewwindow #ininv').html(),precision));
											}
											$('.result #viewwindow #freeinv').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()));
											$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
											if((Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()))>=0){
											}
											else{//免稅金額小於總折扣金額，不足額於應稅金額彌補
												$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.result #viewwindow #freeinv').html()));
												$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());

												$('.result #viewwindow #freeinv').html('0');
												$('.result #viewwindow input[name="freeinv"]').val('0');
											}

											$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
											$('.result #paywindow #paycontent').html('');
											$('.result #viewwindow #already').html('0');
											$('.result #viewwindow #cashmoney').html('0');
											$('.result #viewwindow #cash').html('0');
											$('.result #viewwindow #other').html('0');
											$('.result #viewwindow #otherfix').html('0');
											$('.result #viewwindow input[name="already"]').val('0');
											$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
											result.dialog('open');
										}
										else{
										}
									}
									else{
										var total=0;
										var dis=0;
										var temptotal=0;
										var tempdis=0;
										$.each($('.order#order #'+tabs+' form[data-id="listform"] .label'),function(index,value){
											total=Number(total)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
											dis=Number(dis)+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
											if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="needcharge[]"]').val()=='1'){
												temptotal=Number(temptotal)+(Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
												tempdis=Number(tempdis)+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
											}
											else{
											}
										});
										if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
											total=roundfun(total,precision);
										}
										else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
											total=ceilfun(total,precision);
										}
										else{//無條件捨去
											total=floorfun(total,precision);
										}
										$('.result #viewwindow #total').html(total);
										$('.result #viewwindow #temptotal').val(temptotal);
										$('.result #viewwindow #itemdis').html(dis);
										$('.result #viewwindow #tempdis').val(tempdis);
										if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
											$.ajax({
												url:'./lib/js/compdis.ajax.php',
												method:'post',
												async: false,
												data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
												dataType:'html',
												success:function(d){
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'compdis.ajax.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
													}
													var temp=d.split(';');
													if($.isNumeric(temp[0])){
														$('.result #viewwindow #autodis').html(temp[0]);
														$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
														$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
													}
													else{
														$('.result #viewwindow #autodis').html('0');
														$('.result #viewwindow input[name="autodiscontent"]').val('');
														$('.result #viewwindow input[name="autodispremoney"]').val('0');
													}
													//console.log(d);
												},
												error:function(e){
													//console.log(e)
												}
											});
										}
										else{
											$('.result #viewwindow #autodis').html('0');
											$('.result #viewwindow input[name="autodiscontent"]').val('');
											$('.result #viewwindow input[name="autodispremoney"]').val('0');
										}
										//$('.result #viewwindow #memberdis').html((Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html()))*%+NUMBER);//設定檔內設定
										$('.result #viewwindow #memberdis').html(0);
										/*設定檔內設定*/
										if($('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()==''){
										}
										else{
											if($('.order#order .initsetting #member').val()=='1'){
												if($('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php',
														method:'post',
														async: false,
														data:{'type':'online','company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
														dataType:'json',
														success:function(d){
															if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online success) '+JSON.stringify(d)},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
															if(typeof d[0]['discount']!=="undefined"){
																var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d[0]['discount']))/100;
																//$('.result #viewwindow #memberdis').html();
																/*設定檔內可設定使用何種進位*/
																if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																	temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																	$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																}
																else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																	$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																}
																else{//無條件捨去
																	$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																}
																//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
																//console.log($('.result #viewwindow #memberdis').html());
															}
															else{
																var memshould=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()));
																var memtimes=0;
																$('.result #viewwindow #memberdis').html('0');
																while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																	$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																	memshould=Number(memshould)-Number(d[0]['needbuy']);
																	memtimes++;
																}
																//console.log($('.result #viewwindow #memberdis').html());
																//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
															}
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdis.ajax.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
													$.ajax({
														url:'./lib/js/getmemdis.ajax.php',
														method:'post',
														async: false,
														data:{'memno':$('.order#order #tabs4 form[data-id="listform"] input[name="memno"]').val()},
														dataType:'json',
														success:function(d){
															if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'getmemdis.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
															if(typeof d[0]['type']==="undefined"||d[0]['type']=='1'){
																var temp=(Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val()))*(100-Number(d))/100;
																//$('.result #viewwindow #memberdis').html();
																/*設定檔內可設定使用何種進位*/
																if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
																	temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
																	$('.result #viewwindow #memberdis').html(roundfun(temp ,precision));
																}
																else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
																	$('.result #viewwindow #memberdis').html(floorfun(temp ,precision));
																}
																else{//無條件捨去
																	$('.result #viewwindow #memberdis').html(ceilfun(temp ,precision));
																}
																//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #listdis1').html()));
															}
															else{
																var memshould=$('.result #viewwindow #should').html();
																var memtimes=0;
																$('.result #viewwindow #memberdis').html('0');
																while(Number(memshould)>=Number(d[0]['needbuy'])&&(d[0]['times']=='-1'||Number(memtimes)<Number(d[0]['times']))){
																	$('.result #viewwindow #memberdis').html(Number($('.result #viewwindow #memberdis').html())+Number(d[0]['cangift']));
																	memshould=Number(memshould)-Number(d[0]['needbuy']);
																	memtimes++;
																}
																//console.log($('.result #viewwindow #memberdis').html());
																//$('.result #viewwindow #should').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #memberdis').html()));
															}
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
											}
											else{
											}
										}
										if($('.order#order .initsetting #openchar').val()=='1'&&$('.result #funbox #charno').val()=='1'){//開啟服務費
											if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
												$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())+Number($('.result #viewwindow input[name="floorspan"]').val()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
											}
											else{//依照折扣後價格
												$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())+Number($('.result #viewwindow input[name="floorspan"]').val())-Number($('.result #viewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
											}
											var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
											/*設定檔內可設定使用何種進位*/
											if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
												$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
											}
											else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
												$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
											}
											else{//無條件捨去
												$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
											}
											$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
										}
										else{//關閉服務費
										}
										$('.result #viewwindow #should').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html())+Number($('.result #viewwindow #charge').html())-Number($('.result #viewwindow #coupon1').html())-Number($('.result #viewwindow #coupon2').html())-Number($('.result #viewwindow #autodis').html()));
										$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
										var precision=$('.order#order .initsetting #accuracy').val();//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
										/*設定檔內可設定使用何種進位*/
										if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
											$('.result #viewwindow #should').html( roundfun($('.result #viewwindow #should').html(),precision));
											$('.result #viewwindow #listtotal').html( roundfun($('.result #viewwindow #listtotal').html(),precision));
										}
										else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
											$('.result #viewwindow #should').html( ceilfun($('.result #viewwindow #should').html(),precision));
											$('.result #viewwindow #listtotal').html( ceilfun($('.result #viewwindow #listtotal').html(),precision));
										}
										else{//無條件捨去
											$('.result #viewwindow #should').html( floorfun($('.result #viewwindow #should').html(),precision));
											$('.result #viewwindow #listtotal').html( floorfun($('.result #viewwindow #listtotal').html(),precision));
										}
										$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val($('.result #viewwindow #should').html());
										for(var i=0;i<$('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]').length;i++){
											if($('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]:eq('+i+')').val()=='0'){
												$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val(Number($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val())-Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
											}
											else{
												$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
												$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());
											}
										}
										$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number(+Number($('.result #viewwindow #charge').html())));
										if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
											$('.result #viewwindow #ininv').html( roundfun($('.result #viewwindow #ininv').html(),precision));
										}
										else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
											$('.result #viewwindow #ininv').html( ceilfun($('.result #viewwindow #ininv').html(),precision));
										}
										else{//無條件捨去
											$('.result #viewwindow #ininv').html( floorfun($('.result #viewwindow #ininv').html(),precision));
										}
										$('.result #viewwindow #freeinv').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()));
										$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
										if((Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()))>=0){
										}
										else{//免稅金額小於總折扣金額，不足額於應稅金額彌補
											$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.result #viewwindow #freeinv').html()));
											$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());

											$('.result #viewwindow #freeinv').html('0');
											$('.result #viewwindow input[name="freeinv"]').val('0');
										}

										$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
										$('.result #paywindow #paycontent').html('');
										$('.result #viewwindow #already').html('0');
										$('.result #viewwindow #cashmoney').html('0');
										$('.result #viewwindow #cash').html('0');
										$('.result #viewwindow #other').html('0');
										$('.result #viewwindow #otherfix').html('0');
										$('.result #viewwindow input[name="already"]').val('0');
										$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
										result.dialog('open');
									}
								}
								if($('.order#order .initsetting #pointtree').val()=='1'&&$('.order#order #content #member #membutton #tel').html()!=''){//集點樹－將點餐畫面中的會員電話，自動帶入查詢集點樹會員
									$('.result input[name="view"]').val($('.order#order #content #member #membutton div:eq(1)').html());
									$('.result #funbox .pointtree').click();
								}
								else{
								}
							}
							if($('.order#order .initsetting #linklist').val()=='1'){
								$.ajax({
									url:'./lib/js/getlinklist.ajax.php',
									method:'post',
									async:false,
									data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d.length>0){
											if($('.sysmeg #name1.syshint9').length>0){
												$('.sysmeg #name1.syshint9').css({'display':''});
											}
											else{
											}
											if($('.sysmeg #name2.syshint9').length>0){
												$('.sysmeg #name2.syshint9').css({'display':''});
											}
											else{
											}
											for(var i=0;i<d.length;i++){
												if($('.sysmeg #list').html()==''){
													$('.sysmeg #list').append(d[i]['saleno']);
												}
												else{
													$('.sysmeg #list').append(','+d[i]['saleno']);
												}
											}
											sysmeg.dialog('open');
											$('sysmeg').parent('.ui-dialog').css({'border':'1px solid #898989'});
										}
										else{
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
						}
						else{
							//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
							$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
							alertmessage.dialog('open');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				break;
			case 4://'暫結出單'按鈕
				if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳區功能按鈕',$(this).val());
				$.ajax({
					url:'./lib/js/checkopen.ajax.php',
					method:'post',
					async:false,
					data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temp checkopen.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
						if(d=='success'){
							$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val($('.order#order #banner #detail .viewtotal').val());
							for(var i=0;i<$('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]').length;i++){
								if($('.order#order #tabs4 form[data-id="listform"] input[name="insaleinv[]"]:eq('+i+')').val()=='0'){
									$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val(Number($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val())-Number($('.order#order #tabs4 form[data-id="listform"] input[name="money[]"]:eq('+i+')').val()));
								}
								else{
									$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.order#order #tabs4 form[data-id="listform"] input[name="subtotal[]"]:eq('+i+')').val()));
									$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());
								}
							}
							$('.result #viewwindow #freeinv').html(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()));
							$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
							if((Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #ininv').html()))>=0){
							}
							else{//免稅金額小於總折扣金額，不足額於應稅金額彌補
								$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())+Number($('.result #viewwindow #freeinv').html()));
								$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());

								$('.result #viewwindow #freeinv').html('0');
								$('.result #viewwindow input[name="freeinv"]').val('0');
							}

							//console.log($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val());
							if($('.order#order #MemberBill #tabs4 form[data-id="listform"] .label').length==0){
								if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()!=''){
									emptyitemsvoidlist.dialog('open');
								}
								else{
									var nowbizdate=$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val();
									$.ajax({
										url:'./lib/js/create.voidtempdb.php',
										method:'post',
										async: false,
										data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
										dataType:'html',
										success:function(d){
											if(d.length>20||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'temp create.voidtempdb.php '+d},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else{
											}
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
									if($('.order#order .initsetting #secview').val()=='1'){
										$.ajax({
											url:'../secview/cleartemp.ajax.php',
											method:'post',
											async: false,
											data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'temp cleartemp.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
											socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
											console.log('send message "clear" to secview');
										}
										else{
										}
									}
									else{
									}
									$.ajax({
										url:'./lib/js/create.cmdtxt.php',
										method:'post',
										async: false,
										data:{'cmd':nowbizdate.substr(0,6)+'-change'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
									if($('.order#order .initsetting #controltable').val()=='1'){
										$.ajax({
											url:'./lib/js/changetabini.ajax.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'tabnum':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});

										inittable.dialog('open');
										ClearWindow('','');
									}
									else{
										ClearWindow('','');
									}
									$('.order#order #billfun1 button:eq(4)').prop('disabled',false);
									if($('.order#order .initsetting #controltable').val()=='1'){
										var buttype='b';
									}
									else{
										var buttype='a';
									}
									$.ajax({
										url:'./lib/js/change.button4.php',
										method:'post',
										data:{'type':buttype},
										dataType:'json',
										success:function(d){
											if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
												$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
											}
											else{
											}
											if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
												$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[1]);
											}
											else{
											}
											if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
												if(buttype=='a'){
													$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
												}
												else{
													$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
												}
											}
											else{
											}
											$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
							}
							/*else if($('.order#order #billfun1 button:eq(4)').val()=='回到桌控'){
								//alertmessage('1');
								if($('.order#order .companydata #submachine').length>0){
									location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
								}
								else{
									location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
								}
							}*/
							else{
								if(($('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()==3||$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()==4)&&$('.order#order .initsetting #reserve').val()==1){//預約單(for外送、自取)
									var total=0,subtotal=0,qty=0,temptotal=0,tempdis=0;
									$.each($('.order#order #tabs4 form[data-id="listform"] .label'),function(index,value){
										total=Number(total)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
										subtotal=Number(subtotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="subtotal[]"]').val()));
										qty=Number(qty)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="qty[]"]').val()));
										if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="needcharge[]"]').val()=='1'){
											temptotal=Number(temptotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
											tempdis=Number(tempdis)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
										}
										else{
										}
									});
									if($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').length>0&&Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val())==''){
										if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'&&$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()==1){
											if($('.order#order .initsetting #chargeeq').val()=='2'){//服務費以折扣後之價格計算
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val((Number(temptotal)-Number(tempdis))*Number($('.order#order .initsetting #chargenumber').val())/100);
											}
											else{//服務費以原價格計算
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(Number(temptotal)*Number($('.order#order .initsetting #chargenumber').val())/100);
											}
											var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
											//設定檔內可設定使用何種進位
											if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( roundfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
											}
											else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( ceilfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
											}
											else{//無條件捨去
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( floorfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
											}
										}
										else{
										}
									}
									else{
									}
									var autodis=0;
									if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
										$.ajax({
											url:'./lib/js/compdis.ajax.php',
											method:'post',
											async: false,
											data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'temp compdis.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
												var temp=d.split(';');
												autodis=temp[0];
											},
											error:function(e){
												//console.log(e)
											}
										});
									}
									else{
									}
									var d=new Date(),newd=new Date();
									newd.setDate(newd.getDate()+28);
									var thtml="<div class='div' style='width:100%;height:100%;float:left;'><table style='width:100%;height:calc(75% - 1px);margin:0 1px 1px 1px;'><tr><td>金額</td><td>"+(Number(subtotal)-Number(autodis)+Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val()))+"</td></tr><tr><td>日期</td><td>";
									thtml=thtml+"<select class='needsclick' style='width:150px;' name='date'><option value='0' ";
									if($('.order#order #banner #type input[name="reservedatetime"]').length>0&&$.trim($('.order#order #banner #type input[name="reservedatetime"]').val()).length>0){
										var temp=$('.order#order #banner #type input[name="reservedatetime"]').val().toString().split(";");
										var seltag=temp[1];
										var selyy=temp[0].substr(0,4),selmm=temp[0].substr(4,2),seldd=temp[0].substr(6,2),selhour=temp[0].substr(8,2),selmin=temp[0].substr(10,2);
									}
									else{
										var seltag='',selyy='',selmm='',seldd='',selhour='',selmin='';
										thtml=thtml+"selected";
									}
									thtml=thtml+">選擇日期</option>";
									var tempd=new Date(d);
									var wd=tempd.getDay();
									var dd=tempd.getDate();
									if(dd.toString().length<2){
										dd="0"+dd;
									}
									else{
									}
									var mm=tempd.getMonth()+1;
									if(mm.toString().length<2){
										mm="0"+mm;
									}
									else{
									}
									var yy=tempd.getFullYear();
									var newdd=newd.getDate();
									if(newdd.toString().length<2){
										newdd="0"+newdd;
									}
									else{
									}
									var newmm=newd.getMonth()+1;
									if(newmm.toString().length<2){
										newmm="0"+newmm;
									}
									else{
									}
									var newyy=newd.getFullYear();
									var newdatetime=(newyy+'/'+newmm+'/'+newdd);
									do{
										thtml=thtml+"<option value='"+yy+mm+dd+"' ";
										if((yy+mm+dd)==(selyy+selmm+seldd)){
											thtml=thtml+"selected";
										}
										else{
										}
										thtml=thtml+">"+mm+'/'+dd;
										if(wd==0){
											thtml=thtml+'(日)';
										}
										else if(wd==1){
											thtml=thtml+'(一)';
										}
										else if(wd==2){
											thtml=thtml+'(二)';
										}
										else if(wd==3){
											thtml=thtml+'(三)';
										}
										else if(wd==4){
											thtml=thtml+'(四)';
										}
										else if(wd==5){
											thtml=thtml+'(五)';
										}
										else{
											thtml=thtml+'(六)';
										}
										thtml=thtml+"</option>";
										tempd.setDate(tempd.getDate()+1);
										yy=tempd.getFullYear();
										mm=tempd.getMonth()+1;
										if(mm.toString().length<2){
											mm="0"+mm;
										}
										else{
										}
										dd=tempd.getDate();
										if(dd.toString().length<2){
											dd="0"+dd;
										}
										else{
										}
										wd=tempd.getDay();
									}while((yy+'/'+mm+'/'+dd)!=newdatetime);
									thtml=thtml+"</select>";
									thtml=thtml+"</td></tr><tr><td>時間</td><td><select class='needsclick' style='width: 80px;' name='hour'>";
									for(var hour=8;hour<25;hour++){
										thtml=thtml+"<option value='";
										if(hour.toString().length<2){
											thtml=thtml+"0"+hour.toString()+"' ";
											if(("0"+hour.toString())==selhour.toString()){
												thtml=thtml+"selected";
											}
											else{
											}
											thtml=thtml+">0"+hour.toString();
										}
										else{
											if(hour==24){
												hour="00";
											}
											else{
											}
											thtml=thtml+hour.toString()+"' ";
											if(hour.toString()==selhour.toString()){
												thtml=thtml+"selected";
											}
											else{
											}
											thtml=thtml+">"+hour.toString();
											if(hour=="00"){
												hour=24;
											}
											else{
											}
										}
										thtml=thtml+"</option>";
									}
									thtml=thtml+"</select>：<select class='needsclick' style='width: 80px;' name='min'>";
									for(var min=0;min<12;min++){
										thtml=thtml+"<option value='";
										if((min*5).toString().length<2){
											thtml=thtml+"0"+(min*5).toString()+"' ";
											if(("0"+(min*5).toString())==selmin.toString()){
												thtml=thtml+"selected";
											}
											else{
											}
											thtml=thtml+">"+"0"+(min*5).toString();
										}
										else{
											thtml=thtml+(min*5).toString()+"' ";
											if((min*5).toString()==selmin.toString()){
												thtml=thtml+"selected";
											}
											else{
											}
											thtml=thtml+">"+(min*5).toString();
										}
										thtml=thtml+"</option>";
									}
									thtml=thtml+"</select></td></tr><tr><td>外送人員</td><td><input type='text' name='outman' style='padding:0 5px;' value='"+$('.order#order #listtabbox #tabs4 form[data-id="listform"] input[name="manname"]').val()+"'></td></tr><tr><td>貼紙</td><td><label><input type='checkbox' style='zoom:1.5;' name='printtag' ";
									if(seltag==''||seltag=='0'){
									}
									else{
										thtml=thtml+"checked";
									}
									thtml=thtml+">出貼紙</label></td></tr><tr><td>收據章</td><td><label><input type='checkbox' style='zoom:1.5;' name='receipt' value='1'>列印收據章</label></td></tr></table><button id='reserve' style='height:calc(25% - 1px);margin:1px 1px 0 1px;' value='開立預約單'>開立預約單</button><button id='continue' style='height:calc(25% - 1px);margin:1px 1px 0 1px;' value='暫結出單'>暫結出單</button><button id='cancel' style='height:calc(25% - 1px);margin:1px 1px 0 1px;' value='取消'>取消</button></div><div class='outmandiv' style='width:50%;height:100%;float:left;display:none;'><input type='text' id='mancode' style='width:calc(100% - 2px);height:calc(100% / 6 - 2px);margin:1px;padding:0 5px;' value='"+$('.order#order #listtabbox #tabs4 form[data-id="listform"] input[name="mancode"]').val()+"'><button id='number' value='7'>7</button><button id='number' value='8'>8</button><button id='number' value='9'>9</button><button id='number' value='4'>4</button><button id='number' value='5'>5</button><button id='number' value='6'>6</button><button id='number' value='1'>1</button> <button id='number' value='2'>2</button><button id='number' value='3'>3</button><button id='number' value='0'>0</button><button id='number' value='' disabled></button><button id='number' value='' disabled></button><button id='clear' style='width:calc(100% / 3 - 2px);height:calc(100% / 6 - 2px);background-color: #c6d3e3;float:left;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;margin:1px;'>清空</button><button id='back' style='width:calc(100% / 3 - 2px);height:calc(100% / 6 - 2px);background-color: #c6d3e3;float:left;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;margin:1px;'>倒退</button><button id='return' style='width:calc(100% / 3 - 2px);height:calc(100% / 6 - 2px);background-color: #c6d3e3;float:left;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;margin:1px;'>返回</button></div>";
									$('.temptoinv').html(thtml);
									temptoinv.dialog('option','height',500);
									//temptoinv.dialog('option','width',900);
									temptoinv.dialog('open');
								}
								else if(($('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()==2&&($('.order#order .initsetting #controltable').val()=='1'||$('.order#order .initsetting #tabnum').val()=='1'))&&$('.order#order .initsetting #linklist').val()==1){//外帶對應內用(for外送、自取)
									$.ajax({
										url:'./lib/js/getalltablelist.ajax.php',
										method:'post',
										async:false,
										data:{'machinetype':$('.order#order .companydata #terminalnumber').val(),'linklist':$('.order#order #tabs4 form[data-id="listform"] input[name="linklist"]').val()},
										dataType:'html',
										success:function(d){
											//console.log(d);
											$('.temptoinv').html(d);
											temptoinv.dialog('option','height',245);
											temptoinv.dialog('open');
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
									if($('.order#order .initsetting #secview').val()=='1'){
										$.ajax({
											url:'../secview/cleartemp.ajax.php',
											method:'post',
											async: false,
											data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'temp cleartemp.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
											socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
											console.log('send message "clear" to secview');
										}
										else{
										}
									}
									else{
									}
									var total=0;
									var subtotal=0;
									var qty=0;
									var temptotal=0;
									var tempdis=0;
									$.each($('.order#order #tabs4 form[data-id="listform"] .label'),function(index,value){
										total=Number(total)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
										subtotal=Number(subtotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="subtotal[]"]').val()));
										qty=Number(qty)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="qty[]"]').val()));
										if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="needcharge[]"]').val()=='1'){
											temptotal=Number(temptotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
											tempdis=Number(tempdis)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
										}
										else{
										}
									});
									if($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').length>0&&Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val())==''){
										if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'&&$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()==1){
											if($('.order#order .initsetting #chargeeq').val()=='2'){//服務費以折扣後之價格計算
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val((Number(temptotal)-Number(tempdis))*Number($('.order#order .initsetting #chargenumber').val())/100);
											}
											else{//服務費以原價格計算
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(Number(temptotal)*Number($('.order#order .initsetting #chargenumber').val())/100);
											}
											var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
											/*設定檔內可設定使用何種進位*/
											if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( roundfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
											}
											else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( ceilfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
											}
											else{//無條件捨去
												$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( floorfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
											}
										}
										else{
										}
									}
									else{
									}
									var consecnumber='';
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var posdvrfile='';
									}
									else{
									}
									$('.order#order #billfun1 button:eq(4)').prop('disabled',true);
									//var dbrequery='';
									$.ajax({
										url:'./lib/js/create.tempdb.php',
										method:'post',
										async: false,
										data:$('#tabs4 form[data-id="listform"]').serialize()+'&salelisthint='+$('.order#order #banner #detail #salelisthint').val(),
										dataType:'html',
										success:function(d){
											if(d.length>40||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'temp create.tempdb.php '+d},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else{
											}//database is locked
											//dbrequery=d;
											/*if(dbrequery.match(/database is locked/g)){
												//產生db locked
											}
											else{*/
												var tempd=d.split('-');
												consecnumber=tempd[1];
												if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
													$('.order#order #tabs4 form[data-id="listform"] input[name="saleno"]').val(tempd[0]);
													$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(tempd[1]);
												}
												else{
												}
												if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
													posdvrfile=tempd[2];
												}
												else{
												}
											//}
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
									/*if(dbrequery.match(/database is locked/g)){
										//產生db locked
										dblock.dialog('open');
									}
									else{*/
										/*錢都錄借接*/
										//console.log(posdvrfile);
										if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
											/*start tag*/
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'start posdvr-sendmessage','file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){console.log(e);}
											});
											if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
												var res=api_sendmessage_posdvr(posdvrfile);
												//console.log(res);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'success '+posdvrfile,'file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else{
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'error sendmessage is not function','file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											/*end tag*/
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'end posdvr-sendmessage','file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
										}
										if($('.order#order .initsetting #ticketlisttype').val().match($('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val())&&($('.order#order .initsetting #ticket').val()=='1'||$('.order#order .initsetting #ticket').val()=='3')){//出"兌換卷"
											$.ajax({
												url:'./lib/js/create.ticket.php',
												method:'post',
												async:false,
												data:$('#tabs4 form[data-id="listform"]').serialize(),
												dataType:'html',
												success:function(d){
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'temp create.ticket.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
													}
													consecnumber=d;
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
											$.ajax({
												url:'./lib/js/compdis.ajax.php',
												method:'post',
												async: false,
												data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'temp compdis.ajax.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
													}
													var temp=d.split(';');
													if($.isNumeric(temp[0])){
														$.ajax({
															url:'./lib/js/wttempdis.ajax.php',
															method:'post',
															async: false,
															data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':consecnumber,'autodis':temp[0],'autodiscontent':temp[1],'autodispermoney':temp[2]},
															dataType:'html',
															success:function(d){
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'temp wttempdis.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
														//$('.result #viewwindow #autodis').html(temp[0]);
														//$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
														//$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
													}
													else{
														//console.log('fail');
													}
													//console.log(d);
												},
												error:function(e){
													//console.log(e)
												}
											});
										}
										else{
										}
										if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
										}
										else{
											$.ajax({
												url:'./lib/js/create.voidlist.php',
												method:'post',
												async: false,
												data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
												dataType:'html',
												success:function(d){
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'temp create.voidlist.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
													}
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										$.ajax({
											url:'./lib/js/create.list.php',
											method:'post',
											async: false,
											data:$('#tabs4 form[data-id="listform"]').serialize()+'&salelisthint='+$('.order#order #banner #detail #salelisthint').val(),
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'temp create.list.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
										}
										else{
											$.ajax({
												url:'./lib/js/create.voidkitchen.php',
												method:'post',
												async: false,
												data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'username':$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val()},
												dataType:'html',
												success:function(d){
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'temp create.voidkitchen.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
													}
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										$.ajax({
											url:'./lib/js/create.kitchen.php',
											method:'post',
											async: false,
											data:$('#tabs4 form[data-id="listform"]').serialize(),
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'temp create.kitchen.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
										$.ajax({
											url:'./lib/js/create.tag.php',
											method:'post',
											async: false,
											data:$('#tabs4 form[data-id="listform"]').serialize(),
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'temp create.tag.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
										}
										else{
											$.ajax({
												url:'./lib/js/create.voidtempdb.php',
												method:'post',
												async: false,
												data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
												dataType:'html',
												success:function(d){
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'temp create.voidtempdb.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
													}
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										/*$.ajax({
											url:'./lib/js/create.cmdtxt.php',
											method:'post',
											async: false,
											data:{'cmd':'report'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});*/
										if($('.order#order .initsetting #controltable').val()=='1'){
											/*if($('.order#order .companydata #submachine').length>0){
												location.href='./control.php?submachine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
											}
											else{
												if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
													location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
												}
												else{
													location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
												}
											}*/
											inittable.dialog('open');
											ClearWindow('','');
										}
										else{
											if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val().length>0){
												//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
												ClearWindow('','');
											}
											else{
												//location.href='./order.php';
												ClearWindow('','');
											}
										}
										$('.order#order #billfun1 button:eq(4)').prop('disabled',false);
										if($('.order#order .initsetting #controltable').val()=='1'){
											var buttype='b';
										}
										else{
											var buttype='a';
										}
										$.ajax({
											url:'./lib/js/change.button4.php',
											method:'post',
											data:{'type':buttype},
											dataType:'json',
											success:function(d){
												if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
													$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
												}
												else{
												}
												if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
													$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[1]);
												}
												else{
												}
												if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
													if(buttype=='a'){
														$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
													}
													else{
														$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
													}
												}
												else{
												}
												$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
											},
											error:function(e){
												//console.log(e);
											}
										});
									//}
								}
							}
						}
						else{
							//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
							$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
							alertmessage.dialog('open');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/check.booking.php',
					method:'post',
					async:false,
					data:{'machinetype':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d=='success'){
							if($('.order#order #banner #detail #tw #point').css('background-color')=='red'){
							}
							else{
								$('.order#order #banner #detail #tw #point').css({'background-color':'red','z-index':'3'});
							}
						}
						else{
							$('.order#order #banner #detail #tw #point').css({'background-color':'','z-index':''});
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				break;
			case 6://'現金結帳'按鈕
				if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳區功能按鈕',$(this).val());
				if($('.order#order #'+tabs+' .listcontent .label').length<=0){
				}
				else{
					if(($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0')||($('.order#order #banner #detail #oinv').length>0&&$('.order#order #banner #detail #oinv').val()=='ERROR')){
						//alertmessage('目前發票數量不足，若仍要結帳請使用結帳按鈕。');
						$('.alertmessage #text').html('目前發票數量不足，若仍要結帳請使用結帳按鈕。');
						alertmessage.dialog('open');
					}
					else{
						$('.order#order #billfun1 button:eq(3)').trigger('click');
						while(!result.dialog('isOpen')){
							//console.log('1');
							sleep(100);
						}
						$('.result .numbox .moneybut').trigger('click');
						while(parseFloat($('.result #viewwindow #notyet').html())>0){
							//console.log('2');
							sleep(100);
						}
						if($('.pointtreememdata').length>0&&pointtreememdata.dialog('isOpen')){
							pointtreememdata.dialog('close');
						}
						else{
						}
						if($('.result #viewwindow #checkfun #submit').prop('disabled')){
						}
						else{
							//console.log('submit');
							$('.result #viewwindow #checkfun #submit').trigger('click');
						}
					}
				}
				break;
			default:
				break;
		}
	});
	$('.order#order #billfun #billfun1').on('click','button:eq(5)',function(event){//2021/6/18 移動至結帳區功能頁中//'套餐確認'按鈕
	//$('.order#order #billfun #billfun2').on('click','button:eq(5)',function(event){//'套餐確認'按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('套餐確認','click');
		//oneEvent(event);
		var sum=0;
		var requiredhint='';
		var lackrequired=0;
		var deviation=0;
		$('.order#order #itemtype .type').each(function(){
			if($(this).find('.required').val()=='1'){//2021/6/18 必選類別
				deviation=parseInt($(this).find('.number').val())-parseInt($('.order#order #tabs5 .listcontent .label input[name="typeno[]"][value="'+$(this).find('.childfronttype').val()+'"]').length);//2021/6/18 已點選的該類別品項數量與類別必選數量的差值
				if(deviation>0){//2021/6/18 還有必選類別尚未選齊
					lackrequired=parseInt(lackrequired)+parseInt(deviation);//2021/6/18 計算還有多少必選品項還沒選擇
					if(requiredhint!=''){
						requiredhint += ',';
					}
					else{
					}
					requiredhint += $(this).find('.childtype').val();//2021/6/18 提示文字：尚未選齊的必選品項的類別
				}
				else{
				}
			}
			else{
			}

			/*if($(this).parents('button.childtype').find('.required').val()=='1'){
				sum+=Number($(this).val());
			}
			else{
			}*/
		});
		if(lackrequired>0){
		//if(($('.order#order #tabs5 .listcontent .label').length-$('.order#order #tabs5 .listcontent .label input[value="－"]').length)<=sum){
			//alertmessage('請確認已完成完整套餐。');
			$('.alertmessage #text').html(requiredhint+'<br>以上必選類別尚未完成。');
			//$('.alertmessage #text').html('請確認已完成完整套餐。');
			alertmessage.dialog('open');
		}
		else{
			var total=0;
			var qty=0;
			if($('.order#order #tabs4 .listcontent input[name="linenumber[]"]').length==0){
				var linenumber=1;
				//$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(1);
			}
			else{
				var linenumber=parseInt($('.order#order #tabs4 .listcontent input[name="linenumber[]"]:eq('+($('.order#order #tabs4 .listcontent input[name="linenumber[]"]').length-1)+')').val())+2;
				//$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(parseInt($('.order#order #tabs4 .listcontent input[name="linenumber[]"]:eq('+($('.order#order #tabs4 .listcontent input[name="linenumber[]"]').length-1)+')').val())+2);
			}
			for(var i=0;i<$('.order#order #tabs5 form[data-id="listform"] .label').length;i++){
				if(i>0){
					var targetindex=$('.order#order #tabs4 .listcontent .label').length;
					if(targetindex==0){
						ordernumber=1;
					}
					else{
						ordernumber=Number($('.order#order #tabs4 .listcontent .label:eq('+(targetindex-1)+') div:eq(1)').html())+1;
					}
					$('.order#order #tabs4 .listcontent').append("<div class='label focus' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="linenumber[]"]').val()+"'><input type='hidden' name='order[]' value='－'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="typeno[]"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="type[]"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="no[]"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="personcount[]"]').val()+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="needcharge[]"]').val()+"'><input type='hidden' name='dis1[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis1[]"]').val()+"'><input type='hidden' name='dis2[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis2[]"]').val()+"'><input type='hidden' name='dis3[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis3[]"]').val()+"'><input type='hidden' name='dis4[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis4[]"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="name[]"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="name2[]"]').val()+"'><input type='hidden' name='isgroup[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="isgroup[]"]').val()+"'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="childtype[]"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="mname1[]"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="mname2[]"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="insaleinv[]"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="unitprice[]"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="money[]"]').val()+"'><input type='hidden' name='discount[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="discount[]"]').val()+"'><input type='hidden' name='discontent[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="discontent[]"]').val()+"'><input type='hidden' name='dispoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dispoint[]"]').val()+"'><input type='hidden' name='dispointtime[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dispointtime[]"]').val()+"'><input type='hidden' name='number[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="number[]"]').val()+"'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val()+"'><input type='hidden' name='taste1[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1[]"]').val()+"'><input type='hidden' name='taste1name[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1name[]"]').val()+"'><input type='hidden' name='taste1price[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1price[]"]').val()+"'><input type='hidden' name='taste1number[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1number[]"]').val()+"'><input type='hidden' name='taste1money[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1money[]"]').val()+"'><input type='hidden' name='itemdis[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="itemdis[]"]').val()+"'><input type='hidden' name='listdis[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="listdis[]"]').val()+"'><input type='hidden' name='bothdis[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="bothdis[]"]').val()+"'><input type='hidden' name='usemempoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="usemempoint[]"]').val()+"'><input type='hidden' name='getpointtype[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpointtype[]"]').val()+"'><input type='hidden' name='initgetpoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="initgetpoint[]"]').val()+"'><input type='hidden' name='getpoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpoint[]"]').val()+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>"+ordernumber+"</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #view').html()+"</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #unitprice').html()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #number').html()+"</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #subtotal').html()+"</div></div>");
					linenumber+=2;
					$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(linenumber);
					$('.order#order #tabs1 #tempbox input[name="typeno"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="typeno[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="no"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="no[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="personcount"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="personcount[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="needcharge"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="needcharge[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis1"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis1[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis2"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis2[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis3"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis3[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis4"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis4[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="number[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="mname1[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="unitprice[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="taste1"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="taste1number"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1number[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="taste1money"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1money[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="subtotal"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="itemdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="itemdis[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="listdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="listdis[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="bothdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="bothdis[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="usemempoint[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpointtype[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="initgetpoint[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="getpoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpoint[]"]').val());
				}
				else{
					var targetindex=$('.order#order #tabs4 .listcontent .label').length;
					if(targetindex==0){
						ordernumber=1;
					}
					else{
						ordernumber=Number($('.order#order #tabs4 .listcontent .label:eq('+(targetindex-1)+') div:eq(1)').html())+1;
					}
					$('.order#order #tabs4 .listcontent').append("<div class='label focus' style='width:100%;border-top:1px solid #dfdfdf;'><input type='hidden' name='linenumber[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="linenumber[]"]').val()+"'><input type='hidden' name='order[]' value='"+ordernumber+"'><input type='hidden' name='typeno[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="typeno[]"]').val()+"'><input type='hidden' name='type[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="type[]"]').val()+"'><input type='hidden' name='no[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="no[]"]').val()+"'><input type='hidden' name='personcount[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="personcount[]"]').val()+"'><input type='hidden' name='needcharge[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="needcharge[]"]').val()+"'><input type='hidden' name='dis1[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis1[]"]').val()+"'><input type='hidden' name='dis2[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis2[]"]').val()+"'><input type='hidden' name='dis3[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis3[]"]').val()+"'><input type='hidden' name='dis4[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis4[]"]').val()+"'><input type='hidden' name='name[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="name[]"]').val()+"'><input type='hidden' name='name2[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="name2[]"]').val()+"'><input type='hidden' name='isgroup[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="isgroup[]"]').val()+"'><input type='hidden' name='childtype[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="childtype[]"]').val()+"'><input type='hidden' name='mname1[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="mname1[]"]').val()+"'><input type='hidden' name='mname2[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="mname2[]"]').val()+"'><input type='hidden' name='insaleinv[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="insaleinv[]"]').val()+"'><input type='hidden' name='unitprice[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="unitprice[]"]').val()+"'><input type='hidden' name='money[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="money[]"]').val()+"'><input type='hidden' name='discount[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="discount[]"]').val()+"'><input type='hidden' name='discontent[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="discontent[]"]').val()+"'><input type='hidden' name='dispoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dispoint[]"]').val()+"'><input type='hidden' name='dispointtime[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dispointtime[]"]').val()+"'><input type='hidden' name='number[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="number[]"]').val()+"'><input type='hidden' name='subtotal[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val()+"'><input type='hidden' name='taste1[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1[]"]').val()+"'><input type='hidden' name='taste1name[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1name[]"]').val()+"'><input type='hidden' name='taste1price[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1price[]"]').val()+"'><input type='hidden' name='taste1number[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1number[]"]').val()+"'><input type='hidden' name='taste1money[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1money[]"]').val()+"'><input type='hidden' name='itemdis[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="itemdis[]"]').val()+"'><input type='hidden' name='listdis[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="listdis[]"]').val()+"'><input type='hidden' name='bothdis[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="bothdis[]"]').val()+"'><input type='hidden' name='usemempoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="usemempoint[]"]').val()+"'><input type='hidden' name='getpointtype[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpointtype[]"]').val()+"'><input type='hidden' name='initgetpoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="initgetpoint[]"]').val()+"'><input type='hidden' name='getpoint[]' value='"+$('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpoint[]"]').val()+"'><div style='width:3%;padding:3px 0;'><input type='checkbox' data-id='checkbox[]'></div><div style='width:10%;padding:3px 0 3px 3px;-webkit-box-sizing: border-box;-moz-box-sizing: border-box;box-sizing: border-box;'>"+ordernumber+"</div><div style='width:calc(57%);padding:3px 0;' id='view'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #view').html()+"</div><div style='width:10%;text-align:right;padding:3px 0;' id='unitprice'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #unitprice').html()+"</div><div style='width:10%;text-align:center;padding:3px 0;' id='number'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #number').html()+"</div><div style='width:10%;text-align:right;padding:3px 0;' id='subtotal'>"+$('.order#order #tabs5 .listcontent .label:eq('+i+') #subtotal').html()+"</div></div>");
					$('.order#order #tabs1 #tempbox input[name="linenumber"]').val(linenumber);
					$('.order#order #tabs1 #tempbox input[name="typeno"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="typeno[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="no"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="no[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="personcount"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="personcount[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="needcharge"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="needcharge[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis1"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis1[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis2"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis2[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis3"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis3[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="dis4"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="dis4[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="number"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="number[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="mname1"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="mname1[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="unitprice[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="taste1"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="taste1number"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1number[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="taste1money"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="taste1money[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="subtotal"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="subtotal[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="itemdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="itemdis[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="listdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="listdis[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="bothdis"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="bothdis[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="usemempoint[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpointtype[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="initgetpoint[]"]').val());
					$('.order#order #tabs1 #tempbox input[name="getpoint"]').val($('.order#order #tabs5 .listcontent .label:eq('+i+') input[name="getpoint[]"]').val());
				}
			}
			sumsubtotal('',$('.order#order #tabs5 form[data-id="listform"] .label').length);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]').prop('disabled',false);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]').css({'color':'#ffffff'});
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(2)').prop('disabled',false);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(2)').css({'color':'#ffffff'});
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(4)').prop('disabled',true);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(4)').css({'color':'#a8a8a8'});
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(7)').prop('disabled',true);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(7)').css({'color':'#a8a8a8'});
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(8)').prop('disabled',true);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(8)').css({'color':'#a8a8a8'});
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(10)').prop('disabled',false);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(10)').css({'color':'#000000'});
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(11)').prop('disabled',false);
			$('.order#order #MemberBill #billfun #billfun1 input[type="button"]:eq(11)').css({'color':'#000000'});
			if($('.order#order .initsetting #opentemp').val()=='1'){
				$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
			}
			else{
				$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
			}
			$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',true);//2021/6/18 移動至結帳區功能頁中
			//$('.order#order #billfun #billfun2 button:eq(5)').prop('disabled',true);
			//$('.order#order #billfun #billfun2 button:eq(5)').val('套餐修改');
			$('.order#order #MemberBill #list #tabs4button').prop('disabled',false);
			$('.order#order #MemberBill #list #tabs5button').prop('disabled',true);
			$('.order#order #MemberBill #list #tabs4button').trigger('click');
			/*$.ajax({
				url:'./lib/js/getsetname.ajax.php',
				method:'post',
				data:{'type':'set'},
				dataType:'json',
				success:function(d){
					$('.order#order #billfun #billfun2 button:eq(5) div#name1').html(d['button1']);
					$('.order#order #billfun #billfun2 button:eq(5) div#name2').html(d['button2']);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
			if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()!='m1'||$('.order#order .initsetting #salecash').val()=='0'){
				$('.order#order #billfun #billfun1 button:eq(6)').prop('disabled',true);
			}
			else{
				$('.order#order #billfun #billfun1 button:eq(6)').prop('disabled',false);
			}
			if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()!='m1'){
				$('.order#order #billfun #billfun1 button:eq(3)').prop('disabled',true);
			}
			else{
				$('.order#order #billfun #billfun1 button:eq(3)').prop('disabled',false);
			}
			$('.order#order #tabs5 form[data-id="listform"] .listcontent').html('');
			initmenu($('.order#order .initsetting #menutyperow').val(),$('.order#order .initsetting #menutypecol').val(),$('.order#order .initsetting #menurow').val(),$('.order#order .initsetting #menucol').val());
			$('.order#order #tabs1 #tempbox input[name="target"]').val('');
			$('.order#order #tabs1 #tempbox input[name="linenumber"]').val('');
			$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
			$('.order#order #tabs1 #tempbox input[name="type"]').val('');
			$('.order#order #tabs1 #tempbox input[name="no"]').val('');
			$('.order#order #tabs1 #tempbox input[name="personcount"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="needcharge"]').val('1');
			$('.order#order #tabs1 #tempbox input[name="dis1"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dis2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dis3"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dis4"]').val('');
			$('.order#order #tabs1 #tempbox input[name="name"]').val('');
			$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
			$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
			$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
			$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
			$('.order#order #tabs1 #tempbox input[name="money"]').val('');
			$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
			$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
			$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
			$('.order#order #tabs1 #tempbox input[name="number"]').val('');
			$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
			$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
			$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
			$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
			$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
			$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
			$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('1');
			$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('0');
			$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('0');
			$('.order#order #tabs1 #editview').val('');
			$('.order#order .parameters #typeno').val('');
			$('.order#order .parameters #type').val('');
			$('.order#order .parameters #no').val('');
			$('.order#order .parameters #name').val('');
			$('.order#order .parameters #msize').val('');
			$('.order#order .parameters input[id^="mname"]').val('');
			$('.order#order .parameters input[id^="money"]').val('');
			$('.order#order .parameters #taste1').val('');
			$('.order#order .parameters #taste1name').val('');
			$('.order#order .parameters #taste1money').val('');
			$('.order#order #menubox #itemfun .startchangetaste').val('0');
			$('.order#order #menubox #itemfun .itemfun').trigger( "click" );

			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				data:'html',
				success:function(d){
					if(d=='error'){
					}
					else{
						$('.order#order #billfun #billfun1 button:eq(1)').prop('disabled',false);
						//2021/2/24 將原先功能與按鈕移除，換至外部網路訂單接口按鈕
						/*if($('.order#order .initsetting #weborder').val()=='1'){
							$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',false);
						}
						else{
							$('.order#order #billfun #billfun1 button:eq(5)').prop('disabled',true);
						}*/
					}
					if($('.order#order .companydata #ispad').val()=='submachine'){
						//$('.order#order #billfun #billfun2 button:eq(3)').prop('disabled',true);
					}
					else{
						if(d=='error'){
							$('.order#order #billfun #billfun2 button:eq(0)').prop('disabled',false);
							$('.order#order #billfun #billfun2 button:eq(1)').prop('disabled',true);
						}
						else{
							$('.order#order #billfun #billfun2 button:eq(0)').prop('disabled',true);
							$('.order#order #billfun #billfun2 button:eq(1)').prop('disabled',false);
						}
						//$('.order#order #billfun #billfun2 button:eq(2)').prop('disabled',false);
						$('.order#order #billfun #billfun2 button:eq(3)').prop('disabled',false);
					}
					if(d=='error'){
					}
					else{
						$('.order#order #billfun #billfun2 button:eq(4)').prop('disabled',false);
					}
					$('.order#order #billfun #billfun2 button:eq(6)').prop('disabled',false);
					if($('.order#order .companydata #ismobile').length>0&&$('.order#order .companydata #ismobile').val()=='1'){
						$('.order#order #billfun #billfun2 button:eq(7)').prop('disabled',true);
					}
					else{
						$('.order#order #billfun #billfun2 button:eq(7)').prop('disabled',false);
					}
					//2021/6/18 移動至結帳區功能頁中，所以確認後要再開啟常用功能頁
					$('.order#order #billfun #billfun2button').prop('disabled',false);
					$('.order#order #billfun #billfun3button').prop('disabled',false);
					//$('.order#order #billfun #billfun1button').trigger('click');
					
					//2021/6/18 移動至結帳區功能頁中，所以不用切換
					/*if(d=='error'){
						$('.order#order #billfun #billfun2button').trigger('click');
					}
					else{
						$('.order#order #billfun #billfun1button').trigger('click');
					}*/
				},
				error:function(e){
					//console.log(e);
				}
			});

			$('.order#order #tabs4 .listcontentbox').scrollTop($('.order#order #tabs4 .listcontent').height());
			if($('.order#order .initsetting #menutype').val()==3){
				$('.order#order #menubox #itemtype').css({'display':''});
				$('.order#order #menubox #items').css({'display':'none'});
			}
			else{
			}
		}
		if(typeof $('.order#order #content #funbox .quickorder').val()==="undefined"){
		}
		else{
			$('.order#order #content #funbox .quickorder').focus();
		}
	});
	$('.order#order #billfun #billfun3').on('click','.logout',function(event){//'切換人員'按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('切換人員',$(this).val());
		//oneEvent(event);
		if($('.order#order .initsetting #secview').val()=='1'){
			$.ajax({
				url:'../secview/cleartemp.ajax.php',
				method:'post',
				async: false,
				data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
				socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
				console.log('send message "clear" to secview');
			}
			else{
			}
		}
		else{
		}
		if($('.order#order .companydata #submachine').length>0){
			location.href='./?submachine='+$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="machinetype"]').val();
		}
		else{
			location.href='./?machine='+$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="machinetype"]').val();
		}
	});
	$('.funbox #printchange').click(function(){//'印表機轉單'按鈕
		$('.order#order #printchange').trigger('click');
	});
	$('.order#order #billfun #billfun3').on('click','#printchange',function(){//'印表機轉單'按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('開啟POS控制台',$(this).val());
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/create.cmdtxt.php',
			method:'post',
			async: false,
			data:{'cmd':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'-printchange_'+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	function initmenu(row,col,itemrow,itemcol){
		$.ajax({
			url:'./lib/js/initmenu.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val()},
			dataType:'json',
			success:function(menu){
				if($('.order#order .initsetting #menutype').val()=='1'){
					$('.order#order #menubox #items').html('');
					for(var i=0;i<itemrow*itemcol;i++){
						if(i<menu.length){
							var thtml="<div class='item' style='width:calc(100% / "+itemcol+" - 2px);height:calc(100% / "+itemrow+" - 2px);'><button value='"+menu[i]['name1']+"' style='background-color:"+menu[i]['bgcolor']+";'><div id='name1' style='float:left;width:100%;font-size:"+menu[i]['size1']+"px;color:"+menu[i]['color1']+";";
							if(menu[i]['bold1']=='1'){
								thtml=thtml+"font-weight:bold;";
							}
							else{
								thtml=thtml+"font-weight:normal;";
							}
							thtml=thtml+"'>"+menu[i]['name1']+"</div><div id='name2' style='float:left;width:100%;font-size:"+menu[i]['size2']+"px;color:"+menu[i]['color2']+";";
							if(menu[i]['bold2']=='1'){
								thtml=thtml+"font-weight:bold;";
							}
							else{
								thtml=thtml+"font-weight:normal;";
							}
							thtml=thtml+"'>"+menu[i]['name2']+"</div></button><input type='hidden' name='no' value='"+menu[i]['no']+"'><input type='hidden' name='typeno' value='"+menu[i]['typeno']+"'></div>";
							$('.order#order #menubox #items').append(thtml);
						}
						else{
							$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+itemcol+" - 2px);height:calc(100% / "+itemrow+" - 2px);'><input type='button' value='' disabled><input type='hidden' name='front'></div>");
						}
					}
				}
				else{
					$('.order#order #menubox #itemtype').html('<input type="hidden" class="typenext">');
					$('.order#order #menubox #itemtype .typenext').trigger('click');
					/*for(var i=0;i<row*col;i++){
						if(i<menu.length){
							var thtml="<div class='type' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><button class='typebut' value='"+menu[i]['name1']+"' style='background-color:"+menu[i]['bgcolor']+";'><div id='name1' style='float:left;width:100%;font-size:"+menu[i]['size1']+"px;color:"+menu[i]['color1']+";";
							if(menu[i]['bold1']=='1'){
								thtml=thtml+"font-weight:bold;";
							}
							else{
								thtml=thtml+"font-weight:normal;";
							}
							thtml=thtml+"'>"+menu[i]['name1']+"</div><div id='name2' style='float:left;width:100%;font-size:"+menu[i]['size2']+"px;color:"+menu[i]['color2']+";";
							if(menu[i]['bold2']=='1'){
								thtml=thtml+"font-weight:bold;";
							}
							else{
								thtml=thtml+"font-weight:normal;";
							}
							thtml=thtml+"'>"+menu[i]['name2']+"</div></button><input type='hidden' class='front' value='"+menu[i]['front']+"'></div>";
							$('.order#order #menubox #itemtype').append(thtml);
						}
						else{
							$('.order#order #menubox #itemtype').append("<div class='type' style='width:calc(100% / "+col+" - 2px);height:calc(100% / "+row+" - 2px);'><input type='button' value='' disabled><input type='hidden' name='front'></div>");
						}
					}*/
					$('.order#order #menubox #items').html('');
					for(var i=0;i<itemrow*itemcol;i++){
						$('.order#order #menubox #items').append("<div class='item' style='width:calc(100% / "+itemcol+" - 2px);height:calc(100% / "+itemrow+" - 2px);'><button value='' id='empty' disabled><div id='name1'></div><div id='name2'></div></button></div>");
					}
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	};
	$('.result .numbox').on('click','.ban',function(event){//'統編'按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面輸入統編',$(this).find('#name1').html());
		//oneEvent(event);
		if(typeof $('.result #viewwindow input[name="tempcontainer"]')==="undefined"||$('.result #viewwindow input[name="tempcontainer"]').val()==''){
			$('.result #viewwindow input[name="tempban"]').val($('.result input[name="view"]').val());
			if($('.order#order .initsetting #secview').val()=='1'){
				$.ajax({
					url:'../secview/writeban.ajax.php',
					method:'post',
					data:{'tempban':$('.result #viewwindow input[name="tempban"]').val(),'machinetype':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'ban writeban.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
					socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
					console.log('send message "listitemupdate" to secview');
				}
				else{
				}
			}
			else{
			}
		}
		else{
		}
		$('.result input[name="view"]').val('');
		$('.result #paywindow .paywaybox input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
	});
	/*$(document).on('click','.result #funbox .vehicle',function(){//'電子載具'按鈕
		if($('.result #funbox .vehicle').val()=='電子載具'){
			$('.result #funbox .vehicle').val('取消輸入載具');
			$('.result .target').val('vehicle');
			if($('.result #funbox .ban').val()=='取消輸入統編'){
				$('.result #funbox .ban').val('統編');
				$('.result #viewwindow input[name="ban"]').css({'background-color':'#EFEBDE'});
				$('.result #viewwindow input[name="ban"]').prop('readonly',true);
				//if($('.result #viewwindow input[name="ban"]').val().length>0){	
				//}
				//else{
				//	$('.result #viewwindow input[name="ban"]').val($('.result #viewwindow input[name="temp"]').val());
				//}/
				//$('.result #viewwindow input[name="temp"]').val($('.result #viewwindow input[name="'+$('.result .target').val()+'"]').val());
			}
			else{
				//$('.result #viewwindow input[name="temp"]').val($('.result #viewwindow input[name="'+$('.result .target').val()+'"]').val());
				$('.result input[name="view"]').css({'background-color':'#EFEBDE'});
			}
			$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').css({'background-color':'#FFFFFF'});
			$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').prop('readonly',false);
			$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').focus();
			$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').attr('placeholder','請掃描載具');
		}
		else{
			$('.result #funbox .vehicle').val('電子載具');
			$('.result input[name="view"]').css({'background-color':'#FFFFFF'});
			$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').css({'background-color':'#EFEBDE'});
			$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').prop('readonly',true);
			$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').attr('placeholder','');
			//if($('.result #viewwindow input[name="'+$('.result .target').val()+'"]').val().length>0){	
			//}
			//else{
			//	$('.result #viewwindow input[name="'+$('.result .target').val()+'"]').val($('.result #viewwindow input[name="temp"]').val());
			//}
			//$('.result #viewwindow input[name="temp"]').val('');
			$('.result .target').val('view');
		}
		$('.result #paywindow .payway input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
	});*/
	$('.result #funbox').on('click','#loopbut',function(event){//出單方式－切換循環按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面切換出單模式','loop');
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/chaloopbut.ajax.php',
			method:'post',
			data:{'looptype':$('.result #viewwindow .sendviewwindow input[name="looptype"]').val()},
			dataType:'json',
			success:function(value){
				$('.result #funbox #loopbut').html("<div id='name1'>"+value[0]+"</div><div id='name2'>"+value[1]+"</div>");
				$('.result #viewwindow .sendviewwindow input[name="looptype"]').val(value[2]);
			},
			error:function(e){
				//console.log(e);
			}
		});
		/*if($('.result #funbox input[name="looptype"]').val()=='4'){
			$('.result #funbox #loopbut').val('出單');
			$('.result #funbox input[name="looptype"]').val('1');
		}
		else{
			$('.result #funbox input[name="looptype"]').val(Number($('.result #funbox input[name="looptype"]').val())+1);
			switch($('.result #funbox input[name="looptype"]').val()){
				case '2':
					$('.result #funbox #loopbut').val('不出單');
					break;
				case '3':
					$('.result #funbox #loopbut').val('只出總單');
					break;
				case '4':
					$('.result #funbox #loopbut').val('只出標籤');
					break;
			}
		}*/
	});
	$('.result #funbox').on('click','.chargebut',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面切換服務費收取','switch');
		//oneEvent(event);
		if($('.result #funbox .chargebut #name1').html()=='不收服務費'){
			$('.result #funbox .chargebut #name1').html('收服務費');
			$('.result #funbox #charno').val('1');
			if($('.order#order .initsetting #openchar').val()=='1'){//開啟服務費
				if(Number($('.result #viewwindow #total').html())<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
					if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
						$('.result #viewwindow #charge').html(Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())*(Number($('.order#order .initsetting #chargenumber').val())/100));
					}
					else{//依照折扣後價格
						$('.result #viewwindow #charge').html((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
					}
				}
				else{
					if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
						$('.result #viewwindow #charge').html(Number($('.result #viewwindow .sendviewwindow #temptotal').val())*(Number($('.order#order .initsetting #chargenumber').val())/100));
					}
					else{//依照折扣後價格
						$('.result #viewwindow #charge').html((Number($('.result #viewwindow .sendviewwindow #temptotal').val())-Number($('.result #viewwindow .sendviewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
					}
				}
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				/*設定檔內可設定使用何種進位*/
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
				}
				else{//無條件捨去
					$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
				}
				$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
			}
			else{//關閉服務費
			}
		}
		else{
			$('.result #viewwindow #charge').html('0');
			$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val('0');
			$('.result #funbox .chargebut #name1').html('不收服務費');
			$('.result #funbox #charno').val('0');
			/*設定檔內設定*/
			/*if(){//有服務費
				if(){//依照折扣前價格
					$('.result #viewwindow #charge').html(Number(total)*_discount);
				}
				else{//依照折扣後價格
					$('.result #viewwindow #charge').html((Number(total)-Number(dis)-Number($('.result #viewwindow #listdis').html()))*_discount);
				}
			}
			else{//無服務費
			}*/
		}
		$('.result #paywindow #paycontent').html('');
		computershould();
		computerchange();
	});
	$('.result #funbox').on('click','.receiptbut',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面收據章列印','switch');
		//oneEvent(event);
		if($('.result #funbox #receipt').val()=='0'){
			$('.result #funbox .receiptbut #name1').html('列印收據章');//2019/11/28
			$('.result #funbox #receipt').val('1');
		}
		else{
			$('.result #funbox .receiptbut #name1').html('不列印收據章');//2019/11/28
			$('.result #funbox #receipt').val('0');
		}
	});
	$('.result #funbox').on('click','.invbut',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面發票開立','switch');
		//oneEvent(event);
		if($('.result #funbox .invbut #name1').html()=='不開立發票'){
			$('.result #funbox .invbut #name1').html('開立發票');
			$('.result #funbox .invno').val('1');
		}
		else{
			$('.result #funbox .invbut #name1').html('不開立發票');
			$('.result #funbox .invno').val('0');
		}
	});
	$('.result .numbox').on('click','input',function(event){//結帳畫面左方數字按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面數字輸入',$(this).val());
		//oneEvent(event);
		var index=$('.result .numbox input').index(this);
		if($('.result input[name="'+$('.result .target').val()+'"]').val()==''&&$('.result .numbox input:eq('+index+')').val()=='.'){
			$('.result input[name="'+$('.result .target').val()+'"]').val('0.');
		}
		else{
			if($('.result .target').val()=='ban'){
				if($('.result input[name="'+$('.result .target').val()+'"]').val().length>=8){
				}
				else{
					$('.result input[name="'+$('.result .target').val()+'"]').val($('.result input[name="'+$('.result .target').val()+'"]').val()+$('.result .numbox input:eq('+index+')').val());
				}
			}
			else{
				$('.result input[name="'+$('.result .target').val()+'"]').val($('.result input[name="'+$('.result .target').val()+'"]').val()+$('.result .numbox input:eq('+index+')').val());
			}
		}
		$('.result #paywindow .payway input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
	});

	$('.result .numbox').on('click','.clear',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面刪除付款方式','delete');
		//oneEvent(event);
		if($('.result #paywindow .paywaybox input[name="checkbox"]:checked').length>0||$('.result #paywindow .focus').length>0){//清除已勾選之結帳方式明細
			//console.log('1');
			for(var i=($('.result #paywindow .paywaybox').length-1);i>=0;i--){
				if($('.result #paywindow .paywaybox:eq('+i+') input[name="checkbox"]').prop('checked')){
					if($('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother#31800').length>0||$('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother#32100').length>0||$('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother#32800').length>0){//英特拉付款(悠遊卡);因為是獨立退款機制//2021/8/10 增加一卡通32100、愛金卡(icash)32800
						$('.voidintella .qrhint').html("<span id='retry' style='display:none;'>自動重試<span id='time'></span> </span>偵測卡片<span id='loading'>...</span>");
						voidintella.dialog('open');

						var res='';
						res=api_easycard('Refund',$('.order#order .companydata #terminalnumber').val(),$('.result #viewwindow input[name="intellaconsecnumber"]').val(),$('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother input[name="viewmoney"]').val());
						res.done(function(res){
							if(typeof res==='object'){
							}
							else{
								res=JSON.parse(res);
							}
							//console.log(res);
							if(res=='errorinput'){
								//console.log('變數輸入錯誤');
							}
							else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
								/*if(typeof res['Data']['Retry']!=='undefined'){
									//res['Data']['Retry']++;
								}
								else{
									res['Data']['Retry']=1;
								}*/
								$('.voidintella #retry').css({'display':'block'});
								$('.voidintella #retry #time').html(res['Data']['Retry']);
								
								res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),$('.result #viewwindow input[name="intellaconsecnumber"]').val(),$('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother input[name="viewmoney"]').val(),res);//第一次重試
								res.done(function(res){
									if(typeof res==='object'){
									}
									else{
										res=JSON.parse(res);
									}

									if(res=='errorinput'){
										//console.log('變數輸入錯誤');
									}
									else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
										/*if(typeof res['Data']['Retry']!=='undefined'){
											//res['Data']['Retry']++;
										}
										else{
											res['Data']['Retry']=1;
										}*/
										$('.voidintella #retry').css({'display':'block'});
										$('.voidintella #retry #time').html(res['Data']['Retry']);
										
										res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),$('.result #viewwindow input[name="intellaconsecnumber"]').val(),$('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother input[name="viewmoney"]').val(),res);//第二次重試
										res.done(function(res){
											if(typeof res==='object'){
											}
											else{
												res=JSON.parse(res);
											}

											if(res=='errorinput'){
												//console.log('變數輸入錯誤');
											}
											else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
												/*if(typeof res['Data']['Retry']!=='undefined'){
													//res['Data']['Retry']++;
												}
												else{
													res['Data']['Retry']=1;
												}*/
												$('.voidintella #retry').css({'display':'block'});
												$('.voidintella #retry #time').html(res['Data']['Retry']);
												
												res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),$('.result #viewwindow input[name="intellaconsecnumber"]').val(),$('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother input[name="viewmoney"]').val(),res);//第三次重試
												res.done(function(res){
													if(typeof res==='object'){
													}
													else{
														res=JSON.parse(res);
													}

													if(res=='errorinput'){
														//console.log('變數輸入錯誤');
													}
													else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第三次重試錯誤，不再重試
														/*if(typeof res['Data']['Retry']!=='undefined'){
															//res['Data']['Retry']++;
														}
														else{
															res['Data']['Retry']=1;
														}*/

														//$('.checkeasycard #retry').css({'display':'block'});
														//$('.checkeasycard #retry #time').html(res['Data']['Retry']);
														$('.voidintella .qrhint').css({'visibility':'hidden'});
														$('.voidintella .hintstring').html('重試三次失敗。(easy card)');
														$('.voidintella #cancelsale').css({'display':'block'});
														clearInterval(dotloading);

														//console.log('retry '+JSON.stringify(res));
														/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
															$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
														}
														else{
														}*/
													}
													else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
														$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
														$('.voidintella .qrhint').css({'visibility':'hidden'});
														$('.voidintella .hintstring').html('退款成功。(3)');
														$('.voidintella #successsale').prop('disabled',false);
														clearInterval(dotloading);
														$.ajax({
															url:'./lib/api/intella/easycard_saleticket_api.php',
															method:'post',
															data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
															dataType:'html',
															success:function(d){
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
														$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
														$('.voidintella .qrhint').css({'visibility':'hidden'});
														$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'(3)');
														$('.voidintella #successsale').prop('disabled',false);
														clearInterval(dotloading);
													}
													else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
														//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
														$('.voidintella .qrhint').css({'visibility':'hidden'});
														$('.voidintella .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
														//$('.voidintella #successsale').prop('disabled',false);
														$('.voidintella #cancelsale').css({'display':'block'});
														clearInterval(dotloading);
													}
													else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
														//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
														$('.voidintella .qrhint').css({'visibility':'hidden'});
														$('.voidintella .hintstring').html('連線逾時，請重試一次。');
														//$('.voidintella #successsale').prop('disabled',false);
														$('.voidintella #cancelsale').css({'display':'block'});
														clearInterval(dotloading);
													}
													else{//其餘意外狀況
														//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
														$('.voidintella .qrhint').css({'visibility':'hidden'});
														$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'(3)');
														//$('.voidintella #successsale').prop('disabled',false);
														$('.voidintella #cancelsale').css({'display':'block'});
														clearInterval(dotloading);
													}
												});
												//console.log('retry '+JSON.stringify(res));
												/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
													$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
												}
												else{
												}*/
											}
											else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
												$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
												$('.voidintella .qrhint').css({'visibility':'hidden'});
												$('.voidintella .hintstring').html('退款成功。(2)');
												$('.voidintella #successsale').prop('disabled',false);
												clearInterval(dotloading);
												$.ajax({
													url:'./lib/api/intella/easycard_saleticket_api.php',
													method:'post',
													data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
											else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
												$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
												$('.voidintella .qrhint').css({'visibility':'hidden'});
												$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'(2)');
												$('.voidintella #successsale').prop('disabled',false);
												clearInterval(dotloading);
											}
											else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
												//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
												$('.voidintella .qrhint').css({'visibility':'hidden'});
												$('.voidintella .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
												//$('.voidintella #successsale').prop('disabled',false);
												$('.voidintella #cancelsale').css({'display':'block'});
												clearInterval(dotloading);
											}
											else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
												//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
												$('.voidintella .qrhint').css({'visibility':'hidden'});
												$('.voidintella .hintstring').html('連線逾時，請重試一次。');
												//$('.voidintella #successsale').prop('disabled',false);
												$('.voidintella #cancelsale').css({'display':'block'});
												clearInterval(dotloading);
											}
											else{//其餘意外狀況
												//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
												$('.voidintella .qrhint').css({'visibility':'hidden'});
												$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'(2)');
												//$('.voidintella #successsale').prop('disabled',false);
												$('.voidintella #cancelsale').css({'display':'block'});
												clearInterval(dotloading);
											}
										});
										//console.log('retry '+JSON.stringify(res));
										/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
											$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
										}
										else{
										}*/
									}
									else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
										$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
										$('.voidintella .qrhint').css({'visibility':'hidden'});
										$('.voidintella .hintstring').html('退款成功。(1)');
										$('.voidintella #successsale').prop('disabled',false);
										clearInterval(dotloading);
										$.ajax({
											url:'./lib/api/intella/easycard_saleticket_api.php',
											method:'post',
											data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
										$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
										$('.voidintella .qrhint').css({'visibility':'hidden'});
										$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'(1)');
										$('.voidintella #successsale').prop('disabled',false);
										clearInterval(dotloading);
									}
									else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
										//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
										$('.voidintella .qrhint').css({'visibility':'hidden'});
										$('.voidintella .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
										//$('.voidintella #successsale').prop('disabled',false);
										$('.voidintella #cancelsale').css({'display':'block'});
										clearInterval(dotloading);
									}
									else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
										//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
										$('.voidintella .qrhint').css({'visibility':'hidden'});
										$('.voidintella .hintstring').html('連線逾時，請重試一次。');
										//$('.voidintella #successsale').prop('disabled',false);
										$('.voidintella #cancelsale').css({'display':'block'});
										clearInterval(dotloading);
									}
									else{//其餘意外狀況
										//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
										$('.voidintella .qrhint').css({'visibility':'hidden'});
										$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'(1)');
										//$('.voidintella #successsale').prop('disabled',false);
										$('.voidintella #cancelsale').css({'display':'block'});
										clearInterval(dotloading);
									}
								});

								//console.log('retry '+JSON.stringify(res));
								/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
									$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
								}
								else{
								}*/
							}
							else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
								$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
								$('.voidintella .qrhint').css({'visibility':'hidden'});
								$('.voidintella .hintstring').html('退款成功。');
								$('.voidintella #successsale').prop('disabled',false);
								clearInterval(dotloading);
								$.ajax({
									url:'./lib/api/intella/easycard_saleticket_api.php',
									method:'post',
									data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else if(typeof res['Data']['StatusCode']!=='undefined'&&res['Data']['StatusCode']=='7112'){//已全額退費
								$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
								$('.voidintella .qrhint').css({'visibility':'hidden'});
								$('.voidintella .hintstring').html(res['Header']['StatusDesc']);
								$('.voidintella #successsale').prop('disabled',false);
								clearInterval(dotloading);
							}
							else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
								//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
								$('.voidintella .qrhint').css({'visibility':'hidden'});
								$('.voidintella .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
								//$('.voidintella #successsale').prop('disabled',false);
								$('.voidintella #cancelsale').css({'display':'block'});
								clearInterval(dotloading);
							}
							else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
								//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
								$('.voidintella .qrhint').css({'visibility':'hidden'});
								$('.voidintella .hintstring').html('連線逾時，請重試一次。');
								//$('.voidintella #successsale').prop('disabled',false);
								$('.voidintella #cancelsale').css({'display':'block'});
								clearInterval(dotloading);
							}
							else{//其餘意外狀況
								//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
								$('.voidintella .qrhint').css({'visibility':'hidden'});
								$('.voidintella .hintstring').html(res['Header']['StatusDesc']);
								//$('.voidintella #successsale').prop('disabled',false);
								$('.voidintella #cancelsale').css({'display':'block'});
								clearInterval(dotloading);
							}
						});
					}
					else if($('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother').length>0){//英特拉付款(除悠遊卡以外;微信、支付寶、Pi、歐付寶、橘子支、愛貝錢包、Linepay、信用卡、Apple Pay);因為退款機制與悠遊卡不同
						if(voidintella.dialog('isOpen')){
							$('.voidintella .qrhint').css({'visibility':'visible'});
							$('.voidintella #retry').css({'display':'none'});
							$('.voidintella #retry #time').html('');
							$('.voidintella').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
							$('.voidintella #successsale').prop('disabled',true);
							$('.voidintella #cancelsale').css({'display':'none'});
							$('.voidintella .hintstring').html('');
							$('.voidintella .qrhint').html("退款連線中<span id='loading'>...</span>");
							dotloading=setInterval(function(){
								if($('.voidintella .qrhint #loading').length>0){
									if($('.voidintella .qrhint #loading').html().length==3){
										$('.voidintella .qrhint #loading').html('.');
									}
									else if($('.voidintella .qrhint #loading').html().length==2){
										$('.voidintella .qrhint #loading').html('...');
									}
									else{
										$('.voidintella .qrhint #loading').html('..');
									}
								}
								else{
								}
							},500);
						}
						else{
							$('.voidintella .qrhint').html("退款連線中<span id='loading'>...</span>");
							voidintella.dialog('open');
						}

						var res='';
						/***demo***
						if($('.result #viewwindow input[name="intellaconsecnumber"]').val()=='testconsecnumber'){
							$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.voidintella .qrhint').css({'visibility':'hidden'});
							$('.voidintella .hintstring').html('退款成功');
							$('.voidintella #successsale').prop('disabled',false);
							clearInterval(dotloading);
						}
						else{
						/***demo***/
							res=api_void_intellaother($('.result #viewwindow input[name="intellaconsecnumber"]').val(),$('.result #paywindow .paywaybox:eq('+i+') .payway .intellaother input[name="viewmoney"]').val(),$('.order#order .companydata #story').val(),$('.order#order #tabs4 input[name="usercode"]').val(),$('.order#order .companydata #terminalnumber').val());
							res.done(function(res){
								res=JSON.parse(res);
								if(res['Header']['StatusCode']=='0000'){//退款成功
									$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
									$('.voidintella .qrhint').css({'visibility':'hidden'});
									$('.voidintella .hintstring').html(res['Header']['StatusDesc']);
									$('.voidintella #successsale').prop('disabled',false);
									clearInterval(dotloading);
								}
								else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='7112'){//已全額退費
									$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
									$('.voidintella .qrhint').css({'visibility':'hidden'});
									$('.voidintella .hintstring').html(res['Header']['StatusDesc']);
									$('.voidintella #successsale').prop('disabled',false);
									clearInterval(dotloading);
								}
								else{
									$('.voidintella .qrhint').css({'visibility':'hidden'});
									$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'<button id="retryvoid" style="float:right;">再試一次</button>');
									$('.voidintella #cancelsale').css({'display':'block'});
									clearInterval(dotloading);
								}
							});
						/***demo***
						}
						/***demo***/
						
					}
					else if($('.order#order .initsetting #nccc').val()=='1'&&$('.result #paywindow .paywaybox:eq('+i+') .payway .paycash').length>0){//2022/4/12 串接聯合信用卡中心，使用並刷卡付款
						if(voidnccc.dialog('isOpen')){
							$('.voidnccc .qrhint').css({'visibility':'visible'});
							$('.voidnccc').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
							$('.voidnccc #successsale').prop('disabled',true);
							$('.voidnccc #cancelsale').css({'display':'none'});
							$('.voidnccc .hintstring').html('');
							$('.voidnccc .qrhint').html("退款連線中<span id='loading'>...</span>");
							dotloading=setInterval(function(){
								if($('.voidnccc .qrhint #loading').length>0){
									if($('.voidnccc .qrhint #loading').html().length==3){
										$('.voidnccc .qrhint #loading').html('.');
									}
									else if($('.voidnccc .qrhint #loading').html().length==2){
										$('.voidnccc .qrhint #loading').html('...');
									}
									else{
										$('.voidnccc .qrhint #loading').html('..');
									}
								}
								else{
								}
							},500);
						}
						else{
							$('.voidnccc .qrhint').html("退款連線中<span id='loading'>...</span>");
							voidnccc.dialog('open');
						}

						var res='';
						var ncccdate='';
						$.ajax({
							url:'./lib/api/nccc/create.in.php',
							method:'post',
							async:false,
							data:{'type':'02','asm':$('.result #viewwindow .sendviewwindow input[name="creditcard"]').val(),'money':$('.result #paywindow .paywaybox:eq('+i+') .payway .paycash').html()},
							dataType:'json',
							success:function(d){
								//console.log(d);
								ncccdate=d['date'];
								$('.voidnccc input[name="date"]').val(d['date']);
								//$('.checknccc input[name="methodcode"]').val(d['consecnumber']);
							},
							error:function(e){
								//console.log(e);
							}
						});
						res=nccc_iscomplete(ncccdate);
						res.done(function(res){
							if(res['data']=='交易成功'){//成功
								$('.voidnccc #successsale').prop('disabled',false);
								$('.voidnccc .hintstring').html(res['data']);
							}
							else if(typeof res['statusText']!=='undefined'){//等待逾時
								$('.voidnccc #successsale').css({'display':'none'});
								$('.voidnccc #checksale').css({'display':'block'});
								$('.voidnccc #cancelsale').css({'display':'block'});
								$('.voidnccc .hintstring').html(res['statusText']);
							}
							else{//失敗
								$('.voidnccc #cancelsale').css({'display':'block'});
								$('.voidnccc .hintstring').html(res['data']);
							}
							$('.voidnccc .qrhint').css({'visibility':'hidden'});
							clearInterval(dotloading);
						});
					}
					else if($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway input[name="directlinepay"]').length>0&&$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway input[name="directlinepay"]').val()=='1'&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/4 串接直接linepay付款，並使用linepay付款
						voidlinepay.dialog('open');

						var res='';
						var linepaydate='';
						res=directlinepay_refund($('.order#order .companydata #company').val(),$('.order#order .companydata #story').val(),$('.order#order .directlinepay #url').val(),$('.order#order .directlinepay #channelid').val(),$('.order#order .directlinepay #channelsecret').val(),$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="orderid"]').val());
						res.done(function(res){
							if(typeof res['returnCode']!=='undefined'&&(res['returnCode']=='0000'||res['returnCode']=='1165')){//2022/5/9 code=1165(交易已進行退款)；因此做為成功交易//成功交易
								$('.voidlinepay #successsale').prop('disabled',false);
								$('.voidlinepay .hintstring').html(res['returnMessageC']);
							}
							else if(typeof res['statusText']!=='undefined'){//等待逾時
								$('.voidlinepay #cancelsale').css({'display':'block'});
								$('.voidlinepay .hintstring').html(res['statusText']);
							}
							else{
								$('.voidlinepay #cancelsale').css({'display':'block'});
								$('.voidlinepay .hintstring').html(res['returnMessageC']);
							}
							$('.voidlinepay .qrhint').css({'visibility':'hidden'});
							clearInterval(dotloading);
						});
					}
					else if($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway input[name="jkos"]').length>0&&$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway input[name="jkos"]').val()=='1'&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款，並使用街口支付付款
						voidjkospay.dialog('open');

						var res='';
						var jkospaydate='';
						var datetime=new Date();
						var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
						$('.voidjkospay input[name="orderid"]').val(orderid);
						res=jkos_Refund($('.order#order .jkos #url').val(),$('.order#order .jkos #systemname').val(),$('.order#order .jkos #merchantkey').val(),$('.order#order .jkos #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),orderid,$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="tradeno"]').val(),$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
						res.done(function(res){
							if(typeof res['StatusCode']!=='undefined'&&(res['StatusCode']=='000'||res['StatusCode']=='925'||res['StatusCode']=='922')){//2022/5/9 code=925(交易重複退款、已在街口端退款)、code=922(退款總金額已超過原付款交易金額[含多次退款])；因此做為成功交易//成功交易
								$('.voidjkospay #successsale').prop('disabled',false);
								$('.voidjkospay .hintstring').html(res['StatusDesc']);
							}
							else if(typeof res['statusText']!=='undefined'){//等待逾時
								//2022/10/20 預計至少查詢一次，才可關閉視窗重新退款
								$('.voidjkospay #successsale').css({'display':'none'});
								$('.voidjkospay #checksale').prop('disabled',false);
								$('.voidjkospay #checksale').css({'display':'block'});
								$('.voidjkospay .hintstring').html(res['statusText']);
							}
							else{
								$('.voidjkospay #cancelsale').css({'display':'block'});
								$('.voidjkospay .hintstring').html(res['StatusDesc']);
							}
							$('.voidjkospay .qrhint').css({'visibility':'hidden'});

							if(typeof res['InvoiceVehicle']!=='undefined'&&res['InvoiceVehicle']!=''&&res['InvoiceVehicle']!=null&&res['InvoiceVehicle']==$('.result #viewwindow .sendviewwindow input[name="tempcontainer"]').val()){//2022/10/19 若有發票載具(依照文件來看，只有手機載具)，且與結帳畫面的載具相同則一併清空
								if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
									$('.result #viewwindow .sendviewwindow input[name="tempcontainer"]').val('');
								}
								else{
								}
							}
							else{
							}
							clearInterval(dotloading);
						});
					}
					else if($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway input[name="pxpayplus"]').length>0&&$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway input[name="pxpayplus"]').val()=='1'&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款，並使用全支付付款
						voidpxpaypluspay.dialog('open');

						var res='';
						var pxpaypluspaydate='';
						var datetime=new Date();
						var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
						$('.voidpxpaypluspay input[name="orderid"]').val(orderid);
						res=pxpayplus_Refund($('.order#order .pxpayplus #url').val(),$('.order#order .pxpayplus #merchantcode').val(),$('.order#order .pxpayplus #secrectkey').val(),$('.order#order .companydata #story').val(),$('.order#order .pxpayplus #pxstorecode').val(),$('.order#order .companydata #storyname').val(),orderid,$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="orderid"]').val(),$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="tradeno"]').val(),$('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val(),$('.order#order .pxpayplus #item_json').val());
						res.done(function(res){
							if(typeof res['status_code']!=='undefined'&&(res['status_code']=='0000'||res['status_code']=='PT0006')){//2022/11/7 視為已退款成功(已退款金額超出付款金額上限)//成功交易
								$('.voidpxpaypluspay #successsale').prop('disabled',false);
								$('.voidpxpaypluspay .hintstring').html(res['status_message']);
							}
							else if(typeof res['statusText']!=='undefined'){//等待逾時
								//2022/10/20 預計至少查詢一次，才可關閉視窗重新退款
								$('.voidpxpaypluspay #successsale').css({'display':'none'});
								$('.voidpxpaypluspay #checksale').prop('disabled',false);
								$('.voidpxpaypluspay #checksale').css({'display':'block'});
								$('.voidpxpaypluspay .hintstring').html(res['statusText']);
							}
							else{
								$('.voidpxpaypluspay #cancelsale').css({'display':'block'});
								$('.voidpxpaypluspay .hintstring').html(res['status_message']);
							}
							$('.voidpxpaypluspay .qrhint').css({'visibility':'hidden'});

							if(typeof res['invo_carrier']!=='undefined'&&res['invo_carrier']!=''&&res['invo_carrier']!=null&&res['invo_carrier']==$('.result #viewwindow .sendviewwindow input[name="tempcontainer"]').val()){//2022/10/19 若有發票載具(依照文件來看，只有手機載具)，且與結帳畫面的載具相同則一併清空
								if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
									$('.result #viewwindow .sendviewwindow input[name="tempcontainer"]').val('');
								}
								else{
								}
							}
							else{
							}
							clearInterval(dotloading);
						});
					}
					else{
						$('.result #paywindow .paywaybox:eq('+i+')').remove();
					}
				}
				else{
				}
			}
			computerchange();
		}
		else{
			$('.result input[name="'+$('.result .target').val()+'"]').val('');
		}

		if($('.result #paywindow .paywaybox').length==0){
			opendisbut();
		}
		else{
		}

		computerinvbypay();
	});
	$('.voidintella .hintstring').on('click','#retryvoid',function(){
		$('.result .numbox .clear').trigger('click');
	});
	$('.voidintella #successsale').click(function(){
		voidintella.dialog('close');
		$('.result #funbox .intellapay').prop('disabled',false);
		$('.result #paywindow .paywaybox .payway .intellaother').parent('div').parent('.payway').parent('.paywaybox').remove();

		if($('.result #paywindow .paywaybox').length==0){
			opendisbut();
		}
		else{
		}

		computerchange();
	});
	$('.voidintella #cancelsale').click(function(){
		voidintella.dialog('close');
		computerchange();
	});
	$('.voidsalewithintellapay .hintstring').on('click','#retryvoid',function(){
		$('.voidsalewithintellapay .qrhint').css({'visibility':'visible'});
		$('.voidsalewithintellapay #retry').css({'display':'none'});
		$('.voidsalewithintellapay #retry #time').html('');
		$('.voidsalewithintellapay').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
		$('.voidsalewithintellapay #successsale').prop('disabled',true);
		$('.voidsalewithintellapay #cancelsale').css({'display':'none'});
		$('.voidsalewithintellapay .hintstring').html('');
		$('.voidsalewithintellapay .qrhint').html("退款連線中<span id='loading'>...</span>");
		dotloading=setInterval(function(){
			if($('.voidsalewithintellapay .qrhint #loading').length>0){
				if($('.voidsalewithintellapay .qrhint #loading').html().length==3){
					$('.voidsalewithintellapay .qrhint #loading').html('.');
				}
				else if($('.voidsalewithintellapay .qrhint #loading').html().length==2){
					$('.voidsalewithintellapay .qrhint #loading').html('...');
				}
				else{
					$('.voidsalewithintellapay .qrhint #loading').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		res=api_void_intellaother($('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(),$('.voidsalewithintellapay input[name="money"]').val(),$('.order#order .companydata #story').val(),$('.order#order #tabs4 input[name="usercode"]').val(),$('.order#order .companydata #terminalnumber').val());
		res.done(function(res){
			res=JSON.parse(res);
			if(res['Header']['StatusCode']=='0000'){//退款成功
				//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
				$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
				$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']);
				$('.voidsalewithintellapay #successsale').prop('disabled',false);
				clearInterval(dotloading);
			}
			else{
				$('.voidsalewithintellapay .qrhint').css({'visibility':'hidden'});
				$('.voidsalewithintellapay .hintstring').html(res['Header']['StatusDesc']+'<button id="retryvoid" style="float:right;">再試一次</button>');
				$('.voidsalewithintellapay #cancelsale').css({'display':'block'});
				clearInterval(dotloading);
			}
		});
	});
	$('.voidsalewithintellapay #successsale').click(function(){//作廢帳單英特拉成功退款
		var type=$('.voidsalewithintellapay input[name="type"]').val();
		voidsalewithintellapay.dialog('close');
		//console.log('0');
		switch(type){
			case 'editlist'://修改帳單
				//console.log('1');
				var voidbizdate=$('.salelist #date').html();
				var voidconsecnumber=$('.salelist #listno input[name="consecnumber"]').val();
				var nowbizdate=$('.salelist #date').html();
				var listtype='';
				var tabnum='';
				var consecnumber='';
				if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
					//2020/5/25 貌似沒有幫助//檢查連線狀態
					/*if($('.order#order .initsetting #ourmempointmoney').val()=='1'&&$('.salelist #listno input[name="memno').val()!=''&&typeof api_point_money_checkserver!=="undefined"&&typeof api_point_money_checkserver==="function"){
						membercheck=api_point_money_checkserver($('.order#order .companydata #company').val(),$('.order#order .companydata #story').val());
						//console.log(membercheck);
						if(typeof membercheck[0]!=="undefined"&&typeof membercheck[0]['state']!=="undefined"&&membercheck[0]['state']=='success'){
						}
						else{
							$('.result #checkfun #submit').prop('disabled',false);
							if($('.sysmeg #name1.syshint8').length>0){
								$('.sysmeg #name1.syshint8').css({'display':''});
							}
							else{
							}
							if($('.sysmeg #name2.syshint8').length>0){
								$('.sysmeg #name2.syshint8').css({'display':''});
							}
							else{
							}
							$('.result #checkfun #submit').prop('disabled',false);
							sysmeg.dialog('open');
							return;
						}
					}
					else{
					}*/
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																},
																error:function(e){
																	//console.log(e);
																}
															});
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
													},
													error:function(e){
														//if(d.length>40||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														/*}
														else{
														}*/
														//console.log(e);
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(d.substr(0,7)=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'creditcard getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
										//console.log('e1');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
											//console.log('e2');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'void'://作廢帳單
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'creditcard deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							$('.salevoid #listno').html('');
							$('.salevoid #list #listcontent').html('');
							$('.salevoid #date').html('');
							$('.salevoid #credate').html('');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
						verpsw.dialog('close');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'voidbyinv'://依發票作廢帳單
				var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
					dataType:'html',
					success:function(d){
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													async:false,
													data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							verpsw.dialog('close');
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				salevoidbyinv.dialog('close');
				break;
			case 'viewvoid'://2021/9/14 暫結作廢
				var nowbizdate=$('.viewtemp #date').html();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/viewvoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						var tempres=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile=tempres[1];
						}
						else{
						}
						//console.log(d);
						if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
							if(tempres[0]=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	async:false,
																	data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															$('.viewtemp #salelist #salecontent .listitems').prop('id','');
															$('.viewtemp #listno').html('');
															$('.viewtemp #list #listcontent').html('');
															$('.viewtemp #date').html('');
															$('.viewtemp #credate').html('');
															$('.viewtemp #otherfun button#plus').prop('disabled',true);
															$('.viewtemp #otherfun button#openinv').prop('disabled',true);
															$('.viewtemp #viewvoid').prop('disabled',true);
															$('.viewtemp #fun button#forall').prop('disabled',true);
															$('.viewtemp #fun button#list').prop('disabled',true);
															$('.viewtemp #fun button#tag').prop('disabled',true);
															$('.viewtemp #fun button#kitchen').prop('disabled',true);
															$('.viewtemp #fun button#changecheck').prop('disabled',true);
															$('.viewtemp #fun button#editoutman').prop('disabled',true);
															$('.order#order #banner #detail #tw #view').trigger('click');
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
						}
						else{
							$('.viewtemp #salelist #salecontent .listitems').prop('id','');
							$('.viewtemp #listno').html('');
							$('.viewtemp #list #listcontent').html('');
							$('.viewtemp #date').html('');
							$('.viewtemp #credate').html('');
							$('.viewtemp #otherfun button#plus').prop('disabled',true);
							$('.viewtemp #otherfun button#openinv').prop('disabled',true);
							$('.viewtemp #viewvoid').prop('disabled',true);
							$('.viewtemp #fun button#forall').prop('disabled',true);
							$('.viewtemp #fun button#list').prop('disabled',true);
							$('.viewtemp #fun button#tag').prop('disabled',true);
							$('.viewtemp #fun button#kitchen').prop('disabled',true);
							$('.viewtemp #fun button#changecheck').prop('disabled',true);
							$('.viewtemp #fun button#editoutman').prop('disabled',true);
							$('.order#order #banner #detail #tw #view').trigger('click');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});									
				break;
			default:
				break;
		}
		//$('.result #funbox .intellapay').prop('disabled',false);
		//$('.result #paywindow .paywaybox .payway .intellaother').parent('div').parent('.payway').parent('.paywaybox').remove();
		//computerchange();
	});
	$('.voidsalewithintellapay #cancelsale').click(function(){//作廢帳單英特拉失敗退款
		voidsalewithintellapay.dialog('close');
		//computerchange();
	});
	$('.result #funbox').on('click','button[class^="listdisbut"]',function(event){//預設5個帳單折扣按鈕，可由設定檔定義
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面點選自定義折扣',$(this).find('#name1').html());
		//oneEvent(event);
		var disindex=$('.result #funbox button[class^="listdisbut"]').index(this);
		if($('.result #funbox .listdistype'+(Number(disindex)+1)).length>0&&$('.result #funbox .listdistype'+(Number(disindex)+1)).val()=='2'){//2022/3/17 折讓
			$('.result #viewwindow #listdis2').html($('.result #funbox .listdis'+(Number(disindex)+1)).val());
			var precision=parseInt($('.order#order .initsetting #accuracy').val())+2;//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
			/*設定檔內可設定使用何種進位*/
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.result #viewwindow #listdis2').html( roundfun($('.result #viewwindow #listdis2').html(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.result #viewwindow #listdis2').html( ceilfun($('.result #viewwindow #listdis2').html(),precision));
			}
			else{//無條件捨去
				$('.result #viewwindow #listdis2').html( floorfun($('.result #viewwindow #listdis2').html(),precision));
			}

			$('.result #paywindow #paycontent').html('');

			if($('.result #funbox #charno').val()=='1'){//開啟服務費
				if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
					$('.result #viewwindow #charge').html(Number($('.result #viewwindow #temptotal').val())*(Number($('.order#order .initsetting #chargenumber').val())/100));
				}
				else{//依照折扣後價格
					$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
					//console.log($('.result #viewwindow #charge').html());
				}
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				/*設定檔內可設定使用何種進位*/
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
				}
				else{//無條件捨去
					$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
				}
				$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
			}
			else{//關閉服務費
			}

			$.ajax({
				url:'../secview/writeitem.ajax.php',
				method:'post',
				data:{ 'linenumber':'listdis', 'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(), 'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(), 'company':$('.order#order .companydata #company').val(), 'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(), 'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(), 'itemtype':'listdis', 'no':'', 'dep':'', 'number':'', 'mname':'', 'money1':-($('.result #viewwindow #listdis1').html()+$('.result #viewwindow #listdis2').html()), 'taste':'', 'tastenumber':'', 'tastemoney':'', 'subtotal':'', 'machinename':$('.order#order .companydata #terminalnumber').val()},
				async: false,
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'writeitem.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});

			computershould();
			//2018/2/2$('.result #paywindow .paywaybox input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
		}
		else{
			$('.result #viewwindow #listdis1').html(discount(Number($('.result #funbox .listdis'+(Number(disindex)+1)).val())));
			var precision=parseInt($('.order#order .initsetting #accuracy').val())+2;//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
			/*設定檔內可設定使用何種進位*/
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.result #viewwindow #listdis1').html( roundfun($('.result #viewwindow #listdis1').html(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.result #viewwindow #listdis1').html( ceilfun($('.result #viewwindow #listdis1').html(),precision));
			}
			else{//無條件捨去
				$('.result #viewwindow #listdis1').html( floorfun($('.result #viewwindow #listdis1').html(),precision));
			}

			$('.result #paywindow #paycontent').html('');

			if($('.result #funbox #charno').val()=='1'){//開啟服務費
				if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
					$('.result #viewwindow #charge').html(Number($('.result #viewwindow #temptotal').val())*(Number($('.order#order .initsetting #chargenumber').val())/100));
				}
				else{//依照折扣後價格
					$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
					//console.log($('.result #viewwindow #charge').html());
				}
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				/*設定檔內可設定使用何種進位*/
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
				}
				else{//無條件捨去
					$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
				}
				$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
			}
			else{//關閉服務費
			}

			$.ajax({
				url:'../secview/writeitem.ajax.php',
				method:'post',
				data:{ 'linenumber':'listdis', 'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(), 'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(), 'company':$('.order#order .companydata #company').val(), 'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(), 'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(), 'itemtype':'listdis', 'no':'', 'dep':'', 'number':'', 'mname':'', 'money1':-($('.result #viewwindow #listdis1').html()+$('.result #viewwindow #listdis2').html()), 'taste':'', 'tastenumber':'', 'tastemoney':'', 'subtotal':'', 'machinename':$('.order#order .companydata #terminalnumber').val()},
				async: false,
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'writeitem.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});

			computershould();
			//2018/2/2$('.result #paywindow .paywaybox input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
		}
	});
	$('.result #funbox').on('click','#listdisbutA',function(event){//帳單折扣按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面帳單折扣',$(this).find('#name1').html());
		//oneEvent(event);
		var disindex=$('.result #funbox button[class^="listdisbut"]').index(this);
		if($('.result input[name="view"]').val().length>0){
			if(parseInt($('.result input[name="view"]').val())>100){
				$('.result #viewwindow #listdis1').html(discount(Number(100)));
			}
			else{
				$('.result #viewwindow #listdis1').html(discount(Number($('.result input[name="view"]').val())));
			}

			$.ajax({
				url:'../secview/writeitem.ajax.php',
				method:'post',
				data:{ 'linenumber':'listdis', 'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(), 'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(), 'company':$('.order#order .companydata #company').val(), 'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(), 'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(), 'itemtype':'listdis', 'no':'', 'dep':'', 'number':'', 'mname':'', 'money1':-($('.result #viewwindow #listdis1').html()+$('.result #viewwindow #listdis2').html()), 'taste':'', 'tastenumber':'', 'tastemoney':'', 'subtotal':'', 'machinename':$('.order#order .companydata #terminalnumber').val()},
				async: false,
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'writeitem.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});

			computershould('listdis1');
			$('.result input[name="view"]').val('');
			$('.result #paywindow #paycontent').html('');
			if($('.result #funbox #charno').val()=='1'){//開啟服務費
				if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
					$('.result #viewwindow #charge').html(Number($('.result #viewwindow #temptotal').val())*(Number($('.order#order .initsetting #chargenumber').val())/100));
				}
				else{//依照折扣後價格
					$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
					//console.log($('.result #viewwindow #charge').html());
				}
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				//設定檔內可設定使用何種進位
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
				}
				else{//無條件捨去
					$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
				}
				$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
			}
			else{//關閉服務費
			}
			computershould();
		}
		else{
			$('.result #paywindow .paywaybox input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
		}
		//2018/2/2$('.result #paywindow .payway input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
	});
	$('.result #funbox').on('click','#listdisbutB',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面帳單折讓',$(this).find('#name1').html());
		//oneEvent(event);
		if($('.result input[name="view"]').val().length>0){
			$('.result #viewwindow #listdis2').html($('.result input[name="view"]').val());
			$('.result input[name="view"]').val('');
			$('.result #paywindow #paycontent').html('');

			$.ajax({
				url:'../secview/writeitem.ajax.php',
				method:'post',
				data:{ 'linenumber':'listdis', 'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(), 'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(), 'company':$('.order#order .companydata #company').val(), 'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(), 'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(), 'itemtype':'listdis', 'no':'', 'dep':'', 'number':'', 'mname':'', 'money1':-($('.result #viewwindow #listdis1').html()+$('.result #viewwindow #listdis2').html()), 'taste':'', 'tastenumber':'', 'tastemoney':'', 'subtotal':'', 'machinename':$('.order#order .companydata #terminalnumber').val()},
				async: false,
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'writeitem.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});

			computershould('listdis2');
			/*if($('.order#order .initsetting #openchar').val()=='1'){//開啟服務費
				if($('.order#order .initsetting #chargeeq').val()=='1'){//依照折扣前價格
					$('.result #viewwindow #charge').html(Number($('.result #viewwindow #temptotal').val())*(Number($('.order#order .initsetting #chargenumber').val())/100));
				}
				else{//依照折扣後價格
					$('.result #viewwindow #charge').html((Number($('.result #viewwindow #temptotal').val())-Number($('.result #viewwindow #tempdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html()))*(Number($('.order#order .initsetting #chargenumber').val())/100));
					//console.log($('.result #viewwindow #charge').html());
				}
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				//設定檔內可設定使用何種進位
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.result #viewwindow #charge').html( roundfun($('.result #viewwindow #charge').html(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.result #viewwindow #charge').html( ceilfun($('.result #viewwindow #charge').html(),precision));
				}
				else{//無條件捨去
					$('.result #viewwindow #charge').html( floorfun($('.result #viewwindow #charge').html(),precision));
				}
				$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
			}
			else{//關閉服務費
			}*/
			//computershould();
		}
		else{
			$('.result #paywindow .paywaybox input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
		}
		//2018/2/2$('.result #paywindow .payway input[name="checkbox"]').prop('checked',false);//重設'付款方式'的勾選選項
	});
	function discount(disn){//計算帳單折扣金額，精準度可由設定檔設定
		var temp;
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		if($('.order#order .initsetting #accuracyseq').val()=='1'){//帳單折扣以照單品與會員折扣後之價格(設定檔內設定)
			if($('.order#order .initsetting #member').val()=='1'){//如有開啟會員折扣
				if($('.result .canlistdis').length>0){
					temp=Number((Number($('.result .canlistdis').val())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #autodis').html()))*(100-Number(disn)))/100;
				}
				else{
					temp=Number((Number($('.result #viewwindow #listtotal').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #autodis').html()))*(100-Number(disn)))/100;
				}
			}
			else{//若沒有則以帳單折扣以照原始價格
				if($('.result .canlistdis').length>0){
					temp=Number((Number($('.result .canlistdis').val()))*(100-Number(disn)))/100;
				}
				else{
					temp=Number((Number($('.result #viewwindow #listtotal').html()))*(100-Number(disn)))/100;
				}
			}
		}
		else{//帳單折扣以照原始價格
			if($('.result .caninilistdis').length>0){
				temp=Number((Number($('.result .caninilistdis').val())*(100-Number(disn))))/100;
			}
			else{
				temp=Number((Number($('.result #viewwindow #total').html())*(100-Number(disn))))/100;
			}
		}

		/*設定檔內可設定使用何種進位*/
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			//2021/4/15 扣掉一個單位來達到應負金額的五捨六入，
			temp=Number(temp)-Number(Math.pow(10,-(Number(precision)+1)));
			return roundfun(temp ,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			//return ceilfun(temp ,precision);
			//2021/4/15 調整達到應付金額得無條件進位
			return floorfun(temp ,precision);
		}
		else{//無條件捨去
			//return floorfun(temp ,precision);
			//2021/4/15 調整達到應付金額得無條件進位
			return ceilfun(temp ,precision);
		}
	};
	function computershould(idvalue){//計算應付金額
		var precision=$('.order#order .initsetting #accuracy').val();
		if(Number($('.result #viewwindow #total').html())<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
			var temp=Number(Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html())+Number($('.result #viewwindow #charge').html())-Number($('.result #viewwindow #coupon1').html())-Number($('.result #viewwindow #coupon2').html()));
		}
		else{
			var temp=Number(Number($('.result #viewwindow #listtotal').html())-Number($('.result #viewwindow #memberdis').html())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html())+Number($('.result #viewwindow #charge').html())-Number($('.result #viewwindow #coupon1').html())-Number($('.result #viewwindow #coupon2').html()));
		}

		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.result #viewwindow #should').html( roundfun(temp,precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.result #viewwindow #should').html( ceilfun(temp,precision));
		}
		else{//無條件捨去
			$('.result #viewwindow #should').html( floorfun(temp,precision));
		}
		
		if(Number($('.result #viewwindow #should').html())<=0){
			$('.result #viewwindow #'+idvalue).html(Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #'+idvalue).html()));
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.result #viewwindow #'+idvalue).html( roundfun($('.result #viewwindow #'+idvalue).html(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.result #viewwindow #'+idvalue).html( ceilfun($('.result #viewwindow #'+idvalue).html(),precision));
			}
			else{//無條件捨去
				$('.result #viewwindow #'+idvalue).html( floorfun($('.result #viewwindow #'+idvalue).html(),precision));
			}

			$.ajax({
				url:'../secview/writeitem.ajax.php',
				method:'post',
				data:{ 'linenumber':'listdis', 'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(), 'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(), 'company':$('.order#order .companydata #company').val(), 'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(), 'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(), 'itemtype':'listdis', 'no':'', 'dep':'', 'number':'', 'mname':'', 'money1':-($('.result #viewwindow #listdis1').html()+$('.result #viewwindow #listdis2').html()), 'taste':'', 'tastenumber':'', 'tastemoney':'', 'subtotal':'', 'machinename':$('.order#order .companydata #terminalnumber').val()},
				async: false,
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'writeitem.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});

			$('.result #viewwindow #should').html('0');
		}
		else{
		}
		computerinvbydis();
		computerchange();
	};
	function computerchange(){//計算找零金額
		var precision=$('.order#order .initsetting #accuracy').val();
		computeralready();
		/*if(Number($('.result #viewwindow #total').html())<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
			var temp=Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
		}
		else{*/
			var temp=Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html());//應收金額(應收+手續費)
		//}
		//計算未收金額
		if(temp-Number($('.result #viewwindow #already').html())<=0){
			$('.result #viewwindow #notyet').html('0');
		}
		else{
			$('.result #viewwindow #notyet').html(temp-Number($('.result #viewwindow #already').html()));
		}
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.result #viewwindow #notyet').html( roundfun($('.result #viewwindow #notyet').html(),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.result #viewwindow #notyet').html( ceilfun($('.result #viewwindow #notyet').html(),precision));
		}
		else{//無條件捨去
			$('.result #viewwindow #notyet').html( floorfun($('.result #viewwindow #notyet').html(),precision));
		}
		//計算找零金
		if(Number($('.result #viewwindow #otherfix').html())==0){//無不找零支付方式
			if(Number($('.result #viewwindow #already').html())-temp<=0){
				$('.result #viewwindow #change').html('0');
			}
			else{
				$('.result #viewwindow #change').html(Number($('.result #viewwindow #already').html())-temp);
			}
		}
		else{//有利用到不找零支付方式
			if(Number($('.result #viewwindow #otherfix').html())<=Number(temp)){//不找零支付方式所支付之金額不大於應收金額，因此還需要找零
				if(Number($('.result #viewwindow #already').html())-temp<=0){
					$('.result #viewwindow #change').html('0');
				}
				else{
					$('.result #viewwindow #change').html(Number($('.result #viewwindow #already').html())-temp);
				}
			}
			else{
				$('.result #viewwindow #change').html(Number($('.result #viewwindow #already').html())-Number($('.result #viewwindow #otherfix').html()));
			}
		}
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.result #viewwindow #change').html( roundfun($('.result #viewwindow #change').html(),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.result #viewwindow #change').html( ceilfun($('.result #viewwindow #change').html(),precision));
		}
		else{//無條件捨去
			$('.result #viewwindow #change').html( floorfun($('.result #viewwindow #change').html(),precision));
		}
	};
	function computeralready(){//計算已付金額
		var pay=0;
		var money=0;
		var cash=0;
		var commission=0;
		var other=0;
		var otherfix=0;
		var tempstring={};
		var otherstring='';
		var precision=$('.order#order .initsetting #accuracy').val();
		if($('.result #paywindow .paymoney').length>0){
			for(var i=0;i<$('.result #paywindow .paymoney').length;i++){//計算已付現金
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.result #paywindow .paymoney:eq('+i+')').html()),precision);
					money=roundfun(Number(money)+Number($('.result #paywindow .paymoney:eq('+i+')').html()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.result #paywindow .paymoney:eq('+i+')').html()),precision);
					money=ceilfun(Number(money)+Number($('.result #paywindow .paymoney:eq('+i+')').html()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.result #paywindow .paymoney:eq('+i+')').html()),precision);
					money=floorfun(Number(money)+Number($('.result #paywindow .paymoney:eq('+i+')').html()),precision);
				}
			}
		}
		else{
		}
		if($('.result #paywindow .paycash').length>0){
			for(var i=0;i<$('.result #paywindow .paycash').length;i++){//計算已付信用卡與信用卡手續費
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.result #paywindow .paycash:eq('+i+')').html()),precision);
					cash=roundfun(Number(cash)+Number($('.result #paywindow .paycash:eq('+i+')').html()),precision);
					commission=roundfun(Number(commission)+Number($('.result #paywindow .commission:eq('+i+')').val()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.result #paywindow .paycash:eq('+i+')').html()),precision);
					cash=ceilfun(Number(cash)+Number($('.result #paywindow .paycash:eq('+i+')').html()),precision);
					commission=ceilfun(Number(commission)+Number($('.result #paywindow .commission:eq('+i+')').val()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.result #paywindow .paycash:eq('+i+')').html()),precision);
					cash=floorfun(Number(cash)+Number($('.result #paywindow .paycash:eq('+i+')').html()),precision);
					commission=floorfun(Number(commission)+Number($('.result #paywindow .commission:eq('+i+')').val()),precision);
				}
			}
		}
		else{
		}
		if($('.result #paywindow .otherpay').length>0){
			for(var i=0;i<$('.result #paywindow .otherpay').length;i++){//計算已付其他付款
				if($('.result #paywindow .otherpay:eq('+i+') input[name="type"]').val()=='1'){
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=roundfun(Number(other)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=ceilfun(Number(other)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=floorfun(Number(other)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				}
				else{
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=roundfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=ceilfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=floorfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				}
				if(typeof tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]!=='undefined'){
					if(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')].match("=")){
						var ttempstringa=tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')].split("=");
						tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=Number(ttempstringa[1])+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val());
					}
					else{
						tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=Number(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')])+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val());
					}
					if(ttempstringa.length>=2){
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=Number(ttempstringa[0])+Number($('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val())+'='+roundfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=Number(ttempstringa[0])+Number($('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val())+'='+ceilfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
						}
						else{//無條件捨去
							tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=Number(ttempstringa[0])+Number($('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val())+'='+floorfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
						}
						
						////2022/5/3 將其他交易序號串接上來(通常不會進來這個流程，會將串接的付款限定只能使用一次)
						//for(var p=2;p<ttempstringa.length;p++){
						//	tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')] += '='+ttempstringa[p];
						//}
						//if($('.result #paywindow .otherpay:eq('+i+') input[name="orderid"]').length>0){//2022/5/3 其他付款串接電子支付對應的交易序號
						//	tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')] += '='+$('.result #paywindow .otherpay:eq('+i+') input[name="orderid"]').val();
						//}
						//else{
						//}
					}
					else{
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=$('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val()+'='+roundfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=$('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val()+'='+ceilfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
						}
						else{//無條件捨去
							tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=$('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val()+'='+floorfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
						}
					}
				}
				else{
					tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val());
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=$('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val()+'='+roundfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=$('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val()+'='+ceilfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
					}
					else{//無條件捨去
						tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')]=$('.result #paywindow .otherpay:eq('+i+') input[name="initview"]').val()+'='+floorfun(tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')],precision);
					}

					if($('.result #paywindow .otherpay:eq('+i+') input[name="orderid"]').length>0){//2022/10/19 包含街口POS端交易序號//2022/5/3 其他付款串接電子支付對應的交易序號(linepay)
						tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')] += '='+$('.result #paywindow .otherpay:eq('+i+') input[name="orderid"]').val();
					}
					else{
					}
					if($('.result #paywindow .otherpay:eq('+i+') input[name="tradeno"]').length>0){//2022/10/19 街口端交易序號
						tempstring[$('.result #paywindow .otherpay:eq('+i+')').attr('id')] += '='+$('.result #paywindow .otherpay:eq('+i+') input[name="tradeno"]').val();
					}
					else{
					}
				}
			}
		}
		else{
		}
		if($('.result #paywindow .intellaother').length>0){
			for(var i=0;i<$('.result #paywindow .intellaother').length;i++){//計算已付英特拉
				//if($('.result #paywindow .otherpay:eq('+i+') input[name="type"]').val()=='1'){
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=roundfun(Number(other)+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=ceilfun(Number(other)+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=floorfun(Number(other)+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				/*}
				else{
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=roundfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=ceilfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=floorfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				}*/
				if(typeof tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]!=='undefined'){
					if(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')].match("=")){
						var ttempstringa=tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')].split("=");
						tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=Number(ttempstringa[1])+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val());
					}
					else{
						tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=Number(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')])+Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val());
					}
					if(ttempstringa.length==2){
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=Number(ttempstringa[0])+roundfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=Number(ttempstringa[0])+ceilfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
						}
						else{//無條件捨去
							tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=Number(ttempstringa[0])+floorfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
						}
					}
					else{
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=roundfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=ceilfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
						}
						else{//無條件捨去
							tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=floorfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
						}
					}
				}
				else{
					tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=Number($('.result #paywindow .intellaother:eq('+i+') input[name="viewmoney"]').val());
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=roundfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=ceilfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
					}
					else{//無條件捨去
						tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')]=floorfun(tempstring['intellaother-'+$('.result #paywindow .intellaother:eq('+i+')').attr('id')],precision);
					}
				}
			}
		}
		else{
		}
		if($('.result #paywindow .nidinother').length>0){
			for(var i=0;i<$('.result #paywindow .nidinother').length;i++){//計算已付英特拉
				//if($('.result #paywindow .otherpay:eq('+i+') input[name="type"]').val()=='1'){
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=roundfun(Number(other)+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=ceilfun(Number(other)+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
						other=floorfun(Number(other)+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				/*}
				else{
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=roundfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=ceilfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
						otherfix=floorfun(Number(otherfix)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				}*/
				if(typeof tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]!=='undefined'){
					if(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')].match("=")){
						var ttempstringa=tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')].split("=");
						tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=Number(ttempstringa[1])+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val());
					}
					else{
						tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=Number(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')])+Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val());
					}
					if(ttempstringa.length==2){
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=Number(ttempstringa[0])+roundfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=Number(ttempstringa[0])+ceilfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
						}
						else{//無條件捨去
							tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=Number(ttempstringa[0])+floorfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
						}
					}
					else{
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=roundfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=ceilfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
						}
						else{//無條件捨去
							tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=floorfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
						}
					}
				}
				else{
					tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=Number($('.result #paywindow .nidinother:eq('+i+') input[name="viewmoney"]').val());
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=roundfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=ceilfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
					}
					else{//無條件捨去
						tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')]=floorfun(tempstring['nidinother-'+$('.result #paywindow .nidinother:eq('+i+')').attr('id')],precision);
					}
				}
			}
		}
		else{
		}
		//console.log(tempstring);
		$.each(tempstring,function(i,value){
			if(otherstring==''){
				otherstring=otherstring+i+':'+value;
			}
			else{
				otherstring=otherstring+','+i+':'+value;
			}
		});
		/*for(var i=1;i<=10;i++){
			if(typeof tempstring['TA'+i]!=='undefined'){
				if(otherstring==''){
					otherstring=otherstring+'TA'+i+':'+tempstring['TA'+i];
				}
				else{
					otherstring=otherstring+',TA'+i+':'+tempstring['TA'+i];
				}
			}
			else{
			}
		}*/
		if(typeof tempstring['NONTAX']!=='undefined'){
			if(otherstring==''){
				otherstring=otherstring+'NONTAX:'+tempstring['NONTAX'];
			}
			else{
				otherstring=otherstring+',NONTAX:'+tempstring['NONTAX'];
			}
		}
		else{
		}
		//console.log(otherstring);
		$('.result #viewwindow #cashcomm').html(commission);
		$('.result #viewwindow #already').html(pay);
		$('.result #viewwindow #cash').html(cash);
		$('.result #viewwindow #other').html(other);
		$('.result #viewwindow input[name="otherstring"]').val(otherstring);
		$('.result #viewwindow #otherfix').html(otherfix);
		if(Number(money)>=(Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #cash').html())-Number($('.result #viewwindow #other').html())-Number($('.result #viewwindow #otherfix').html()))){
			$('.result #viewwindow #cashmoney').html((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #cash').html())-Number($('.result #viewwindow #other').html())-Number($('.result #viewwindow #otherfix').html())));
			//$('.result #viewwindow #cashmoney').html('0');
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.result #viewwindow #cashmoney').html(roundfun($('.result #viewwindow #cashmoney').html(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.result #viewwindow #cashmoney').html(ceilfun($('.result #viewwindow #cashmoney').html(),precision));
			}
			else{//無條件捨去
				$('.result #viewwindow #cashmoney').html(floorfun($('.result #viewwindow #cashmoney').html(),precision));
			}
		}
		else{
			$('.result #viewwindow #cashmoney').html(money);
		}
		if(Number($('.result #viewwindow #cashmoney').html())<0){
			$('.result #viewwindow #cashmoney').html('0');
		}
		else{
		}
	};
	function computerinvbydis(){//計算應稅與免稅(for折扣/讓)//2020/2/5
		var precision=$('.order#order .initsetting #accuracy').val();

		//$('.result #viewwindow #ininv').html(Number($('.result #viewwindow input[name="ininv"]').val()));
		$('.result #viewwindow #freeinv').html(Number($('.result #viewwindow input[name="freeinv"]').val())-Number($('.result #viewwindow #listdis1').html())-Number($('.result #viewwindow #listdis2').html())-Number($('.result #viewwindow #coupon1').html())-Number($('.result #viewwindow #coupon2').html()));
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.result #viewwindow #freeinv').html( roundfun($('.result #viewwindow #freeinv').html(),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.result #viewwindow #freeinv').html( ceilfun($('.result #viewwindow #freeinv').html(),precision));
		}
		else{//無條件捨去
			$('.result #viewwindow #freeinv').html( floorfun($('.result #viewwindow #freeinv').html(),precision));
		}

		if(Number($('.result #viewwindow #freeinv').html())<0){
			$('.result #viewwindow #ininv').html(Number($('.result #viewwindow input[name="ininv"]').val())+Number($('.result #viewwindow #charge').html())+Number($('.result #viewwindow #freeinv').html()));
			$('.result #viewwindow #freeinv').html('0');
		}
		else{
			$('.result #viewwindow #ininv').html(Number($('.result #viewwindow input[name="ininv"]').val())+Number($('.result #viewwindow #charge').html()));
		}
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.result #viewwindow #ininv').html( roundfun($('.result #viewwindow #ininv').html(),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.result #viewwindow #ininv').html( ceilfun($('.result #viewwindow #ininv').html(),precision));
		}
		else{//無條件捨去
			$('.result #viewwindow #ininv').html( floorfun($('.result #viewwindow #ininv').html(),precision));
		}
		if(Number($('.result #viewwindow #ininv').html())<0){
			$('.result #viewwindow #ininv').html('0');
		}
		else{
		}
	}
	function computerinvbypay(){//計算應稅與免稅(for付款)(主要計算免稅部分)//2020/2/5
		var precision=$('.order#order .initsetting #accuracy').val();
		var pay=0;
		for(var i=0;i<$('.result #paywindow .otherpay').length;i++){//計算已付其他付款
			if(typeof $('.result #paywindow .otherpay:eq('+i+') input[name="inv"]')!=='undefined'&&$('.result #paywindow .otherpay:eq('+i+') input[name="inv"]').val()=='0'){//主要計算部分－免稅付款方式
				if($('.result #paywindow .otherpay:eq('+i+') input[name="type"]').val()=='1'){//找零
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				}
				else{//不找零
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						pay=roundfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						pay=ceilfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
					else{//無條件捨去
						pay=floorfun(Number(pay)+Number($('.result #paywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					}
				}
			}
			else{
			}
		}
		//console.log('ininv='+$('.result #viewwindow #ininv').html());
		//console.log('freeinv='+$('.result #viewwindow #freeinv').html());
		//console.log('pay='+pay);
		computerinvbydis();
		//console.log('ininv='+$('.result #viewwindow #ininv').html());
		//console.log('freeinv='+$('.result #viewwindow #freeinv').html());
		//console.log('pay='+pay);
		if(Number($('.result #viewwindow #freeinv').html())<Number(pay)){//免稅付款金額與免稅金額的差值由應稅金額彌補
			$('.result #viewwindow #ininv').html(Number($('.result #viewwindow #ininv').html())-Number(pay)+Number($('.result #viewwindow #freeinv').html()));
			$('.result #viewwindow #freeinv').html(pay);
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.result #viewwindow #ininv').html(roundfun(Number($('.result #viewwindow #ininv').html()),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.result #viewwindow #ininv').html(ceilfun(Number($('.result #viewwindow #ininv').html()),precision));
			}
			else{//無條件捨去
				$('.result #viewwindow #ininv').html(floorfun(Number($('.result #viewwindow #ininv').html()),precision));
			}

			if(Number($('.result #viewwindow #ininv').html())<0){//付款方式大於應收金額(hint使用不找零付款方式)
				$('.result #viewwindow #ininv').html('0');
			}
			else{
			}
		}
		else{
		}
	}
	$('.result .numbox').on('click','.moneybut',function(event){//結帳畫面'現金'結帳方式按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面付款方式',$(this).val());
		//oneEvent(event);
		var content='';
		if($('.result input[name="view"]').val().length>0){
			/*content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.result #funbox .moneybut #name1').html()+"</span>";
			if($('.result #funbox .moneybut #name2').length>0)content=content+"<span id='name2'>/"+$('.result #funbox .moneybut #name2').html()+"</span>";
			content=content+"</div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paymoney'>"+$('.result input[name="view"]').val()+"</span>"+$('.result .unit').val()+"</div></div></div>";
			$('.result #paywindow #paycontent').append(content);
			$('.result input[name="view"]').val('');*/
			
			if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))<=0){
				//console.log('1');
			}
			else{
				//console.log('2');
				content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.result .numbox .moneybut #name1').html()+"</span>";
				if($('.result .numbox .moneybut #name2').length>0)content=content+"<span id='name2'>/"+$('.result .numbox .moneybut #name2').html()+"</span>";
				content=content+"</div>";
				/*if(Number($('.result input[name="view"]').val())>=(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #already').html()))){
					content=content+"<div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paymoney'>"+(Number($('.result #viewwindow #should').html())-Number($('.result #viewwindow #already').html()))+"</span>"+$('.result .unit').val()+"</div></div></div>";
				}
				else{*/
					content=content+"<div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paymoney'>"+$('.result input[name="view"]').val()+"</span>"+$('.result .unit').val()+"</div></div></div>";
				//}

				$('.result #paywindow #paycontent').append(content);
			}
			$('.result input[name="view"]').val('');
			
		}
		else if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))>0){
			var precision=$('.order#order .initsetting #accuracy').val();
			content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.result .numbox .moneybut #name1').html()+"</span>";
			if($('.result .numbox .moneybut #name2').length>0)content=content+"<span id='name2'>/"+$('.result .numbox .moneybut #name2').html()+"</span>";
			content=content+"</div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paymoney'>";

			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				var temp=roundfun((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html())),precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				var temp=ceilfun((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html())),precision);
			}
			else{//無條件捨去
				var temp=floorfun((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html())),precision);
			}
			
			content=content+temp+"</span>"+$('.result .unit').val()+"</div></div></div>";
			$('.result #paywindow #paycontent').append(content);
		}
		else{
		}

		closedisbut();

		computerchange();
	});
	$('.result .numbox').on('click','.cashbut',function(event){//結帳畫面'信用卡'結帳方式按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面付款方式',$(this).val());
		//oneEvent(event);
		var content='';
		var inputmoney=0;
		var commission=0;
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)

		if($('.result input[name="view"]').val().length>0){
			if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))<=0){
			}
			else{
				if(Number($('.result input[name="view"]').val())>=(Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))){
					inputmoney=Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html());
				}
				else{
					inputmoney=$('.result input[name="view"]').val();
				}
			}
			$('.result input[name="view"]').val('');
		}
		else if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))>0){
			inputmoney=Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html());
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				inputmoney=roundfun(inputmoney,precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				inputmoney=ceilfun(inputmoney,precision);
			}
			else{//無條件捨去
				inputmoney=floorfun(inputmoney,precision);
			}
		}
		else{
		}

		commission=(Number(inputmoney)*$('.order#order .initsetting #cashcomm').val())/100;
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			commission= roundfun(commission,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			commission= ceilfun(commission,precision);
		}
		else{//無條件捨去
			commission= floorfun(commission,precision);
		}

		if(Number(inputmoney)==0){
			computerchange();
		}
		else if($('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
			if($('.result #paywindow #paycontent .payway span[data-id="apipay"]').length==0){//2022/5/6 未使用api串接的付款方式(英特拉電子支付、聯合信用卡中心刷卡、直接linepay付款)才能使用該付款方式
				if($('.order#order .initsetting #nccceasycard').val()=='0'){//2022/5/17 聯合信用卡中心卡機未開啟電子票證
					//開啟等待交易畫面
					$('.checknccc input[name="money"]').val(inputmoney);
					$('.checknccc input[name="commission"]').val(commission);
					checknccc.dialog('open');
					//產生刷卡機傳接資訊
					var ncccdate='';
					$.ajax({
						url:'./lib/api/nccc/create.in.php',
						method:'post',
						async:false,
						data:{'money':(parseInt(inputmoney)+parseInt(commission))},
						dataType:'json',
						success:function(d){
							//console.log(d);
							ncccdate=d['date'];
							$('.checknccc input[name="date"]').val(d['date']);
							//$('.checknccc input[name="methodcode"]').val(d['consecnumber']);
						},
						error:function(e){
							//console.log(e);
						}
					});
					//等待中.....交易完成(失敗)後，將訊息顯示於等待畫面中//完成：將交易方式寫入結帳畫面中；失敗：不寫入交易方式
					var res='';
					res=nccc_iscomplete(ncccdate);
					res.done(function(res){
						if(res['data']=='交易成功'){//成功
							$('.checknccc input[name="methodcode"]').val(res['code']);
							$('.checknccc #successsale').prop('disabled',false);
							$('.checknccc .hintstring').html(res['data']);
						}
						else if(typeof res['statusText']!=='undefined'){//等待逾時
							$('.checknccc #successsale').css({'display':'none'});
							$('.checknccc #checksale').css({'display':'block'});
							$('.checknccc #cancelsale').css({'display':'block'});
							$('.checknccc .hintstring').html(res['statusText']);
						}
						else{//失敗
							$('.checknccc #cancelsale').css({'display':'block'});
							$('.checknccc .hintstring').html(res['data']);
						}
						$('.checknccc .qrhint').css({'visibility':'hidden'});
						clearInterval(dotloading);
					});
				}
				else{
					chosetype.dialog('open');
				}
			}
			else{
			}
		}
		else{
			content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.result .numbox .cashbut #name1').html()+"</span>";
			if($('.result .numbox .cashbut #name2').length>0)content=content+"<span id='name2'>/"+$('.result .numbox .cashbut #name2').html()+"</span>";
			content=content+"</div>";
			content=content+"<div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paycash'>"+(Number(inputmoney)+Number(commission))+"</span>"+$('.result .unit').val()+"<input type='hidden' id='inputmoney' value='"+inputmoney+"'><input type='hidden' class='commission' value='"+commission+"'></div></div></div>";
			$('.result #paywindow #paycontent').append(content);
			
			closedisbut();

			computerchange();
		}
	});
	$('.chosetype .N').click(function(){//2022/5/17 聯合信用卡中心卡機有開啟電子票證的流程，選擇使用信用卡付款
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('聯合信用卡中心卡機選擇信用卡付款',$(this).val());

		chosetype.dialog('close');

		//oneEvent(event);
		var content='';
		var inputmoney=0;
		var commission=0;
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)

		if($('.result input[name="view"]').val().length>0){
			if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))<=0){
			}
			else{
				if(Number($('.result input[name="view"]').val())>=(Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))){
					inputmoney=Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html());
				}
				else{
					inputmoney=$('.result input[name="view"]').val();
				}
			}
			$('.result input[name="view"]').val('');
		}
		else if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))>0){
			inputmoney=Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html());
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				inputmoney=roundfun(inputmoney,precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				inputmoney=ceilfun(inputmoney,precision);
			}
			else{//無條件捨去
				inputmoney=floorfun(inputmoney,precision);
			}
		}
		else{
		}

		commission=(Number(inputmoney)*$('.order#order .initsetting #cashcomm').val())/100;
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			commission= roundfun(commission,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			commission= ceilfun(commission,precision);
		}
		else{//無條件捨去
			commission= floorfun(commission,precision);
		}

		//開啟等待交易畫面
		$('.checknccc input[name="money"]').val(inputmoney);
		$('.checknccc input[name="commission"]').val(commission);
		checknccc.dialog('open');
		//產生刷卡機傳接資訊
		var ncccdate='';
		$.ajax({
			url:'./lib/api/nccc/create.in.php',
			method:'post',
			async:false,
			data:{'money':(parseInt(inputmoney)+parseInt(commission))},
			dataType:'json',
			success:function(d){
				//console.log(d);
				ncccdate=d['date'];
				$('.checknccc input[name="date"]').val(d['date']);
				//$('.checknccc input[name="methodcode"]').val(d['consecnumber']);
			},
			error:function(e){
				//console.log(e);
			}
		});
		//等待中.....交易完成(失敗)後，將訊息顯示於等待畫面中//完成：將交易方式寫入結帳畫面中；失敗：不寫入交易方式
		var res='';
		res=nccc_iscomplete(ncccdate);
		res.done(function(res){
			if(res['data']=='交易成功'){//成功
				$('.checknccc input[name="methodcode"]').val(res['code']);
				$('.checknccc #successsale').prop('disabled',false);
				$('.checknccc .hintstring').html(res['data']);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.checknccc #successsale').css({'display':'none'});
				$('.checknccc #checksale').css({'display':'block'});
				$('.checknccc #cancelsale').css({'display':'block'});
				$('.checknccc .hintstring').html(res['statusText']);
			}
			else{//失敗
				$('.checknccc #cancelsale').css({'display':'block'});
				$('.checknccc .hintstring').html(res['data']);
			}
			$('.checknccc .qrhint').css({'visibility':'hidden'});
			clearInterval(dotloading);
		});
	});
	$('.chosetype .E').click(function(){//2022/5/17 聯合信用卡中心卡機有開啟電子票證的流程，選擇使用電子票證付款
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('聯合信用卡中心卡機選擇電子票證付款',$(this).val());

		chosetype.dialog('close');

		//oneEvent(event);
		var content='';
		var inputmoney=0;
		var commission=0;
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)

		if($('.result input[name="view"]').val().length>0){
			if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))<=0){
			}
			else{
				if(Number($('.result input[name="view"]').val())>=(Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))){
					inputmoney=Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html());
				}
				else{
					inputmoney=$('.result input[name="view"]').val();
				}
			}
			$('.result input[name="view"]').val('');
		}
		else if((Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html()))>0){
			inputmoney=Number($('.result #viewwindow #should').html())+Number($('.result #viewwindow #cashcomm').html())-Number($('.result #viewwindow #already').html());
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				inputmoney=roundfun(inputmoney,precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				inputmoney=ceilfun(inputmoney,precision);
			}
			else{//無條件捨去
				inputmoney=floorfun(inputmoney,precision);
			}
		}
		else{
		}

		commission=(Number(inputmoney)*$('.order#order .initsetting #cashcomm').val())/100;
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			commission= roundfun(commission,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			commission= ceilfun(commission,precision);
		}
		else{//無條件捨去
			commission= floorfun(commission,precision);
		}

		//開啟等待交易畫面
		$('.checknccc input[name="money"]').val(inputmoney);
		$('.checknccc input[name="commission"]').val(commission);
		checknccc.dialog('open');
		//產生刷卡機傳接資訊
		var ncccdate='';
		$.ajax({
			url:'./lib/api/nccc/create.in.php',
			method:'post',
			async:false,
			data:{'money':(parseInt(inputmoney)+parseInt(commission)),'cardtype':'E'},
			dataType:'json',
			success:function(d){
				//console.log(d);
				ncccdate=d['date'];
				$('.checknccc input[name="date"]').val(d['date']);
				//$('.checknccc input[name="methodcode"]').val(d['consecnumber']);
			},
			error:function(e){
				//console.log(e);
			}
		});
		//等待中.....交易完成(失敗)後，將訊息顯示於等待畫面中//完成：將交易方式寫入結帳畫面中；失敗：不寫入交易方式
		var res='';
		res=nccc_iscomplete(ncccdate);
		res.done(function(res){
			if(res['data']=='交易成功'){//成功
				$('.checknccc input[name="methodcode"]').val(res['code']);
				$('.checknccc #successsale').prop('disabled',false);
				$('.checknccc .hintstring').html(res['data']);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.checknccc #successsale').css({'display':'none'});
				$('.checknccc #checksale').css({'display':'block'});
				$('.checknccc #cancelsale').css({'display':'block'});
				$('.checknccc .hintstring').html(res['statusText']);
			}
			else{//失敗
				$('.checknccc #cancelsale').css({'display':'block'});
				$('.checknccc .hintstring').html(res['data']);
			}
			$('.checknccc .qrhint').css({'visibility':'hidden'});
			clearInterval(dotloading);
		});
	});
	$('.checknccc #checksale').click(function(){//檢查刷卡機紀錄(某種特殊狀況，回傳值為空值)
		$('.checknccc .qrhint').css({'visibility':'visible'});
		dotloading=setInterval(function(){
			if($('.checknccc .qrhint #loading').length>0){
				if($('.checknccc .qrhint #loading').html().length==3){
					$('.checknccc .qrhint #loading').html('.');
				}
				else if($('.checknccc .qrhint #loading').html().length==2){
					$('.checknccc .qrhint #loading').html('...');
				}
				else{
					$('.checknccc .qrhint #loading').html('..');
				}
			}
			else{
			}
		},500);
		$('.checknccc .hintstring').html('');
		$('.checknccc #successsale').css({'display':'block'});
		$('.checknccc #checksale').css({'display':'none'});
		$('.checknccc #cancelsale').css({'display':'none'});
		var res='';
		res=nccc_iscomplete($('.checknccc input[name="date"]').val());
		res.done(function(res){
			if(res['data']=='交易成功'){//成功
				$('.checknccc input[name="methodcode"]').val(res['code']);
				$('.checknccc #successsale').prop('disabled',false);
				$('.checknccc .hintstring').html(res['data']);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.checknccc #successsale').css({'display':'none'});
				$('.checknccc #checksale').css({'display':'block'});
				$('.checknccc #cancelsale').css({'display':'block'});
				$('.checknccc .hintstring').html(res['statusText']);
			}
			else{//失敗
				$('.checknccc #cancelsale').css({'display':'block'});
				$('.checknccc .hintstring').html(res['data']);
			}
			$('.checknccc .qrhint').css({'visibility':'hidden'});
			clearInterval(dotloading);
		});
	});
	$('.checknccc #successsale').click(function(){//成功交易，產生信用卡付款方式記錄(for聯合信用卡中心)
		var content='';
		content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.result .numbox .cashbut #name1').html()+"</span>";
		if($('.result .numbox .cashbut #name2').length>0)content=content+"<span id='name2'>/"+$('.result .numbox .cashbut #name2').html()+"</span>";
		content=content+"</div>";
		content=content+"<div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paycash' data-id='apipay'>"+(Number($('.checknccc input[name="money"]').val())+Number($('.checknccc input[name="commission"]').val()))+"</span>"+$('.result .unit').val()+"<input type='hidden' id='inputmoney' value='"+$('.checknccc input[name="money"]').val()+"'><input type='hidden' class='commission' value='"+$('.checknccc input[name="commission"]').val()+"'></div></div></div>";

		$('.result #paywindow #paycontent').append(content);

		$('.result .sendviewwindow input[name="creditcard"]').val($('.checknccc input[name="methodcode"]').val());

		checknccc.dialog('close');
		
		closedisbut();

		computerchange();
	});
	$('.checknccc #cancelsale').click(function(){//交易失敗(等待逾時)，重新操作
		checknccc.dialog('close');
	});
	$('.voidnccc #checksale').click(function(){//檢查刷卡機紀錄(某種特殊狀況，回傳值為空值)
		$('.voidnccc .qrhint').css({'visibility':'visible'});
		dotloading=setInterval(function(){
			if($('.voidnccc .qrhint #loading').length>0){
				if($('.voidnccc .qrhint #loading').html().length==3){
					$('.voidnccc .qrhint #loading').html('.');
				}
				else if($('.voidnccc .qrhint #loading').html().length==2){
					$('.voidnccc .qrhint #loading').html('...');
				}
				else{
					$('.voidnccc .qrhint #loading').html('..');
				}
			}
			else{
			}
		},500);
		$('.voidnccc .hintstring').html('');
		$('.voidnccc #successsale').css({'display':'block'});
		$('.voidnccc #checksale').css({'display':'none'});
		$('.voidnccc #cancelsale').css({'display':'none'});
		var res='';
		res=nccc_iscomplete($('.voidnccc input[name="date"]').val());
		res.done(function(res){
			if(res['data']=='交易成功'){//成功
				$('.voidnccc input[name="methodcode"]').val(res['code']);
				$('.voidnccc #successsale').prop('disabled',false);
				$('.voidnccc .hintstring').html(res['data']);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.voidnccc #successsale').css({'display':'none'});
				$('.voidnccc #checksale').css({'display':'block'});
				$('.voidnccc #cancelsale').css({'display':'block'});
				$('.voidnccc .hintstring').html(res['statusText']);
			}
			else{//失敗
				$('.voidnccc #cancelsale').css({'display':'block'});
				$('.voidnccc .hintstring').html(res['data']);
			}
			$('.voidnccc .qrhint').css({'visibility':'hidden'});
			clearInterval(dotloading);
		});
	});
	$('.voidnccc #successsale').click(function(){
		voidnccc.dialog('close');
		$('.result #viewwindow .sendviewwindow input[name="creditcard"]').val('');
		$('.result #paywindow .paywaybox .payway .paycash').parent('div').parent('.payway').parent('.paywaybox').remove();

		if($('.result #paywindow .paywaybox').length==0){
			opendisbut();
		}
		else{
		}

		computerchange();
	});
	$('.voidnccc #cancelsale').click(function(){
		voidnccc.dialog('close');
		computerchange();
	});
	$('.voidsalewithnccc #checksale').click(function(){//檢查刷卡機紀錄(某種特殊狀況，回傳值為空值)
		$('.voidsalewithnccc .qrhint').css({'visibility':'visible'});
		dotloading=setInterval(function(){
			if($('.voidsalewithnccc .qrhint #loading').length>0){
				if($('.voidsalewithnccc .qrhint #loading').html().length==3){
					$('.voidsalewithnccc .qrhint #loading').html('.');
				}
				else if($('.voidsalewithnccc .qrhint #loading').html().length==2){
					$('.voidsalewithnccc .qrhint #loading').html('...');
				}
				else{
					$('.voidsalewithnccc .qrhint #loading').html('..');
				}
			}
			else{
			}
		},500);
		$('.voidsalewithnccc .hintstring').html('');
		$('.voidsalewithnccc #successsale').css({'display':'block'});
		$('.voidsalewithnccc #checksale').css({'display':'none'});
		$('.voidsalewithnccc #cancelsale').css({'display':'none'});
		var res='';
		res=nccc_iscomplete($('.voidsalewithnccc input[name="date"]').val());
		res.done(function(res){
			if(res['data']=='交易成功'){//成功
				$('.voidsalewithnccc input[name="methodcode"]').val(res['code']);
				$('.voidsalewithnccc #successsale').prop('disabled',false);
				$('.voidsalewithnccc .hintstring').html(res['data']);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.voidsalewithnccc #successsale').css({'display':'none'});
				$('.voidsalewithnccc #checksale').css({'display':'block'});
				$('.voidsalewithnccc #cancelsale').css({'display':'block'});
				$('.voidsalewithnccc .hintstring').html(res['statusText']);
			}
			else{//失敗
				$('.voidsalewithnccc #cancelsale').css({'display':'block'});
				$('.voidsalewithnccc .hintstring').html(res['data']);
			}
			$('.voidsalewithnccc .qrhint').css({'visibility':'hidden'});
			clearInterval(dotloading);
		});
	});
	$('.voidsalewithnccc #successsale').click(function(){//作廢帳單聯合信用卡中心退款成功
		var type=$('.voidsalewithnccc input[name="type"]').val();
		voidsalewithnccc.dialog('close');
		//console.log('0');
		switch(type){
			case 'editlist'://修改帳單
				//console.log('1');
				var voidbizdate=$('.salelist #date').html();
				var voidconsecnumber=$('.salelist #listno input[name="consecnumber"]').val();
				var nowbizdate=$('.salelist #date').html();
				var listtype='';
				var tabnum='';
				var consecnumber='';
				if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																},
																error:function(e){
																	//console.log(e);
																}
															});
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
													},
													error:function(e){
														//if(d.length>40||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														/*}
														else{
														}*/
														//console.log(e);
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(d.substr(0,7)=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'creditcard getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
										//console.log('e1');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
											//console.log('e2');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'void'://作廢帳單
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'creditcard deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							$('.salevoid #listno').html('');
							$('.salevoid #list #listcontent').html('');
							$('.salevoid #date').html('');
							$('.salevoid #credate').html('');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
						verpsw.dialog('close');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'voidbyinv'://依發票作廢帳單
				var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
					dataType:'html',
					success:function(d){
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													async:false,
													data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							verpsw.dialog('close');
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				salevoidbyinv.dialog('close');
				break;
			case 'viewvoid'://2021/9/14 暫結作廢
				var nowbizdate=$('.viewtemp #date').html();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/viewvoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						var tempres=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile=tempres[1];
						}
						else{
						}
						//console.log(d);
						if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
							if(tempres[0]=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	async:false,
																	data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															$('.viewtemp #salelist #salecontent .listitems').prop('id','');
															$('.viewtemp #listno').html('');
															$('.viewtemp #list #listcontent').html('');
															$('.viewtemp #date').html('');
															$('.viewtemp #credate').html('');
															$('.viewtemp #otherfun button#plus').prop('disabled',true);
															$('.viewtemp #otherfun button#openinv').prop('disabled',true);
															$('.viewtemp #viewvoid').prop('disabled',true);
															$('.viewtemp #fun button#forall').prop('disabled',true);
															$('.viewtemp #fun button#list').prop('disabled',true);
															$('.viewtemp #fun button#tag').prop('disabled',true);
															$('.viewtemp #fun button#kitchen').prop('disabled',true);
															$('.viewtemp #fun button#changecheck').prop('disabled',true);
															$('.viewtemp #fun button#editoutman').prop('disabled',true);
															$('.order#order #banner #detail #tw #view').trigger('click');
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
						}
						else{
							$('.viewtemp #salelist #salecontent .listitems').prop('id','');
							$('.viewtemp #listno').html('');
							$('.viewtemp #list #listcontent').html('');
							$('.viewtemp #date').html('');
							$('.viewtemp #credate').html('');
							$('.viewtemp #otherfun button#plus').prop('disabled',true);
							$('.viewtemp #otherfun button#openinv').prop('disabled',true);
							$('.viewtemp #viewvoid').prop('disabled',true);
							$('.viewtemp #fun button#forall').prop('disabled',true);
							$('.viewtemp #fun button#list').prop('disabled',true);
							$('.viewtemp #fun button#tag').prop('disabled',true);
							$('.viewtemp #fun button#kitchen').prop('disabled',true);
							$('.viewtemp #fun button#changecheck').prop('disabled',true);
							$('.viewtemp #fun button#editoutman').prop('disabled',true);
							$('.order#order #banner #detail #tw #view').trigger('click');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});									
				break;
			default:
				break;
		}
		//$('.result #funbox .intellapay').prop('disabled',false);
		//$('.result #paywindow .paywaybox .payway .intellaother').parent('div').parent('.payway').parent('.paywaybox').remove();
		//computerchange();
	});
	$('.voidsalewithnccc #cancelsale').click(function(){//作廢帳單聯合信用卡中心退款失敗
		voidsalewithnccc.dialog('close');
		//computerchange();
	});
	$('.result #paywindow').on('click','.payway',function(event){//結帳畫面之結帳方式明細模擬labal點選
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面點選付款方式','click');
		//oneEvent(event);
		var index=$('.result #paywindow .payway').index(this);
		$('.result #paywindow .paywaybox').removeClass('focus');
		if($('.result #paywindow .paywaybox:eq('+index+') input[name="checkbox"]').prop('checked')){
			$('.result #paywindow .paywaybox:eq('+index+') input[name="checkbox"]').prop('checked',false);
		}
		else{
			$('.result #paywindow .paywaybox:eq('+index+') input[name="checkbox"]').prop('checked',true);
		}
		if($('.result #paywindow .paywaybox:eq('+index+') .focus').length>0){
		}
		else{
			$('.result #paywindow .paywaybox:eq('+index+')').addClass('focus');
		}
	});
	$('.result #checkfun').on('click','#notsale',function(event){//結帳畫面暫出結帳明細
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面暫出結帳明細',$(this).find('#name1').html());
		//oneEvent(event);
		//console.log('2');
		$('.result #viewwindow input[name="listtotal"]').val($('.result #viewwindow #total').html());
		$('.result #viewwindow input[name="itemdis"]').val($('.result #viewwindow #itemdis').html());
		$('.result #viewwindow input[name="memberdis"]').val($('.result #viewwindow #memberdis').html());
		$('.result #viewwindow input[name="listdis1"]').val($('.result #viewwindow #listdis1').html());
		$('.result #viewwindow input[name="listdis2"]').val($('.result #viewwindow #listdis2').html());
		$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
		$('.result #viewwindow input[name="coupon1"]').val($('.result #viewwindow #coupon1').html());
		$('.result #viewwindow input[name="coupon2"]').val($('.result #viewwindow #coupon2').html());
		$('.result #viewwindow input[name="should"]').val($('.result #viewwindow #should').html());
		$('.result #viewwindow input[name="cashcomm"]').val($('.result #viewwindow #cashcomm').html());
		$('.result #viewwindow input[name="already"]').val($('.result #viewwindow #already').html());
		$('.result #viewwindow input[name="cashmoney"]').val($('.result #viewwindow #cashmoney').html());
		$('.result #viewwindow input[name="cash"]').val($('.result #viewwindow #cash').html());
		$('.result #viewwindow input[name="other"]').val($('.result #viewwindow #other').html());
		$('.result #viewwindow input[name="otherfix"]').val($('.result #viewwindow #otherfix').html());
		$('.result #viewwindow input[name="change"]').val($('.result #viewwindow #change').html());
		$('.result #viewwindow input[name="autodis"]').val($('.result #viewwindow #autodis').html());
		$('.order#order #tabs4 form[data-id="listform"] input[name="tempbuytype"]').val('1');
		$('.order#order #tabs4 form[data-id="listform"] input[name="printclientlist"]').val('1');
		if(typeof $('.result #viewwindow input[name="sendtype"]')=="undefined"||$('.result #viewwindow input[name="sendtype"]').val()=='result'||$('.result #viewwindow input[name="sendtype"]').val()=='tempquicksale'){
			var array1=$('#tabs4 form[data-id="listform"] , .result #viewwindow .sendviewwindow').serialize();
			array1=array1+'&printtempclient';
			//console.log(array1);
		}
		else{
			var array1=$(".result #viewwindow .sendviewwindow").serialize();
			array1=array1+'&charge='+$('.result #viewwindow #charge').html()+'&machinetype='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&bizdate='+$('.viewtemp #date').html()+'&consecnumber='+$('.viewtemp #listno input[name="consecnumber"]').val()+'&printtempclient';
			//console.log(array1);
		}
		array1=array1+'&notconsecnumber';
		if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''||$('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
		}
		else{
			$.ajax({
				url:'./lib/js/create.voidlist.php',
				method:'post',
				async: false,
				data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'sale create.voidlist.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		if($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
			consecnumber=$('.viewtemp #listno input[name="consecnumber"]').val();
			//console.log('3');
		}
		else{
			//console.log('4');
			$.ajax({
				url:'./lib/js/create.list.php',
				method:'post',
				async: false,
				data:array1,
				dataType:'html',
				success:function(d){
					if(d.length>10||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'sale create.list.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log('明細單'+d);
					consecnumber=d;
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		$.ajax({
			url:'./lib/js/gettempdata.ajax.php',
			dataType:'html',
			success:function(d){
				var temp=d.split(',');
				$('.order#order #tabs4 form[data-id="listform"] input[name="tempbuytype"]').val(temp[0]);
				$('.order#order #tabs4 form[data-id="listform"] input[name="printclientlist"]').val(temp[1]);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.result #checkfun').on('click','#submit',function(event){//結帳畫面確認按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面確認按鈕','submit');
		//oneEvent(event);
		/*if((typeof $('.result input[name="sendtype"]')=="undefined"||$('.result input[name="sendtype"]').val()=='result'||$('.result input[name="sendtype"]').val()=='buytemp')&&Number($('.result #viewwindow #notyet').html())>0){
			if($('.sysmeg #name1.syshint2').length>0){
				$('.sysmeg #name1.syshint2').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint2').length>0){
				$('.sysmeg #name2.syshint2').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
		}
		else */if($('.order#order #banner #detail #oinv').length>0&&$('.order#order #banner #detail #oinv').val()=='ERROR'){
		}
		else{
			if((typeof $('.result input[name="sendtype"]')=="undefined"||$('.result input[name="sendtype"]').val()=='result'||$('.result input[name="sendtype"]').val()=='buytemp'||$('.result input[name="sendtype"]').val()=='tempquicksale')){
				$('.result .numbox .moneybut').trigger('click');
				if(Number($('.result #viewwindow .sendviewwindow #notyet').html())>0){
					$('.result .numbox .moneybut').trigger('click');
				}
				else{
				}
			}
			else{
			}
			var gotin=1;
			if($('.order#order .initsetting #pointtree').val()=='1'&&$('.result .sendviewwindow input[name="otherstring"]').val().match("pointtree")){
				var tempors=$('.result .sendviewwindow input[name="otherstring"]').val().split("pointtree-value:");
				var tempors=tempors[1].split("=");
				if(Number(tempors[0])>0&&(!$.isNumeric($('.result #funbox .pointtree #name2').html())||$('.result #funbox .pointtree #name3').html()=="")){
					gotin=0;
				}
				else{
				}
			}
			/*else{
			}*/
			if($('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()=='1'&&(Number($('.setperson #view input[name="personfloor1"]').val())>0||Number($('.setperson #view input[name="personfloor2"]').val())>0||Number($('.setperson #view input[name="personfloor3"]').val())>0)&&parseInt($('.order#order #MemberBill #tabs1 #persons').val())==0){
				//personhint.dialog('open');
				//alertmessage('請填入用餐人數');
				$('.alertmessage #text').html('請填入用餐人數');
				alertmessage.dialog('open');
			}
			else if($('.order#order .initsetting #pointtree').val()=='1'&&gotin==0){
				//alertmessage('請輸入集點樹會員');
				$('.alertmessage #text').html('請輸入集點樹會員');
				alertmessage.dialog('open');
			}
			else{
				/*發票金額，改成帳單折扣與其他付款即時變動*/
				$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val($('.result #viewwindow #should').html());
				if($('.result #paywindow #paycontent .paywaybox .otherpay').length==0){//無其他付款則無需重新計算發票金額
				}
				else{
					for(var i=0;i<$('.result #paywindow #paycontent .paywaybox .otherpay').length;i++){
						if($('.result #paywindow #paycontent .paywaybox .otherpay input[name="inv"]').val()=='0'){
							$('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val(Number($('.order#order #tabs4 form[data-id="listform"] input[name="invsalemoney"]').val())-Number($('.result #paywindow #paycontent .paywaybox .otherpay input[name="viewmoney"]').val()));
						}
						else{
						}
					}
				}

				$('.result #viewwindow input[name="listtotal"]').val($('.result #viewwindow #total').html());
				$('.result #viewwindow input[name="itemdis"]').val($('.result #viewwindow #itemdis').html());
				$('.result #viewwindow input[name="memberdis"]').val($('.result #viewwindow #memberdis').html());
				$('.result #viewwindow input[name="listdis1"]').val($('.result #viewwindow #listdis1').html());
				$('.result #viewwindow input[name="listdis2"]').val($('.result #viewwindow #listdis2').html());
				$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val($('.result #viewwindow #charge').html());
				$('.result #viewwindow input[name="coupon1"]').val($('.result #viewwindow #coupon1').html());
				$('.result #viewwindow input[name="coupon2"]').val($('.result #viewwindow #coupon2').html());
				$('.result #viewwindow input[name="should"]').val($('.result #viewwindow #should').html());
				$('.result #viewwindow input[name="cashcomm"]').val($('.result #viewwindow #cashcomm').html());
				$('.result #viewwindow input[name="already"]').val($('.result #viewwindow #already').html());
				$('.result #viewwindow input[name="cashmoney"]').val($('.result #viewwindow #cashmoney').html());
				$('.result #viewwindow input[name="cash"]').val($('.result #viewwindow #cash').html());
				$('.result #viewwindow input[name="other"]').val($('.result #viewwindow #other').html());
				$('.result #viewwindow input[name="otherfix"]').val($('.result #viewwindow #otherfix').html());
				$('.result #viewwindow input[name="change"]').val($('.result #viewwindow #change').html());
				$('.result #viewwindow input[name="autodis"]').val($('.result #viewwindow #autodis').html());
				$('.order#order #tabs4 form[data-id="listform"] input[name="tempbuytype"]').val('1');
				
				var istrue=1;
				if($('.result #viewwindow input[name="tempban"]').val().length>0){
					if(parseInt($('.result #viewwindow input[name="tempban"]').val())==0){
					}
					else if($('.result #viewwindow input[name="tempban"]').val().length!=8){
						if($('.sysmeg #name1.syshint4').length>0){
							$('.sysmeg #name1.syshint4').css({'display':''});
						}
						else{
						}
						if($('.sysmeg #name2.syshint4').length>0){
							$('.sysmeg #name2.syshint4').css({'display':''});
						}
						else{
						}
						sysmeg.dialog('open');
						istrue=0;
					}
					else{
						var ban=$('.result #viewwindow input[name="tempban"]').val();
						var value=0;
						var t=[1,2,1,2,1,2,4,1];
						var temp=0;
						for(var i=0;i<8;i++){
							temp=parseInt(ban.substr(i,1))*t[i];
							//console.log('temp='+ban.substr(i,1)+'*'+t[i]+'='+temp);
							if(parseInt(temp)>=10){
								//console.log('value='+value+'+'+temp.toString().substr(0,1)+'+'+temp.toString().substr(1,1)+'='+(parseInt(value)+parseInt(temp.toString().substr(0,1))+parseInt(temp.toString().substr(1,1))));
								value=parseInt(value)+parseInt(temp.toString().substr(0,1))+parseInt(temp.toString().substr(1,1));
							}
							else{
								//console.log('value='+value+'+'+temp+'='+(parseInt(value)+parseInt(temp)));
								value=parseInt(value)+parseInt(temp);
							}
						}
						if(value%10==0){
						}
						else if(parseInt(ban.substr(6,1))==7&&(value+1)%10==0){
						}
						else{
							if($('.sysmeg #name1.syshint4').length>0){
								$('.sysmeg #name1.syshint4').css({'display':''});
							}
							else{
							}
							if($('.sysmeg #name2.syshint4').length>0){
								$('.sysmeg #name2.syshint4').css({'display':''});
							}
							else{
							}
							sysmeg.dialog('open');
							istrue=0;
						}
					}
				}
				else{
				}
				if(istrue==0){//由於統編格示錯誤，不做處理
				}
				else{
					/*if($('.result #paywindow .paywaybox .paycash').length>0&&$('.order#order .initsetting #creditcode').val()=='1'){//2022/4/6 強制關閉，不紀錄信用卡後4碼，資料庫欄位轉移給nccc串接編號，以利後續刷退使用//使用信用卡付款
						$('.keybord input[name="type"]').val('creditcard');
						//console.log($('.keybord input[name="type"]').val());
						keybord.dialog('option','title','輸入卡號');
						keybord.dialog('open');
					}
					else{//無使用信用卡付款*/
						var bizdate='';
						if(typeof $('.result #viewwindow input[name="ininv"]').val()!=='undefined'){
							$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());
						}
						else{
						}
						if(typeof $('.result #viewwindow input[name="freeinv"]').val()!=='undefined'){
							$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
						}
						else{
						}
						var nowbizdate=$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val();
						if(typeof $('.result #viewwindow input[name="sendtype"]')=="undefined"||$('.result #viewwindow input[name="sendtype"]').val()=='result'||$('.result #viewwindow input[name="sendtype"]').val()=='tempquicksale'){
							bizdate=$('#tabs4 form[data-id="listform"] input[name="bizdate"]').val();
							var array1=$('#tabs4 form[data-id="listform"] , .result #viewwindow .sendviewwindow').serialize()+'&salelisthint='+$('.order#order #banner #detail #salelisthint').val();
							//console.log(array1);
						}
						else{
							bizdate=$('.viewtemp #date').html();
							var array1=$(".result #viewwindow .sendviewwindow").serialize();
							array1=array1+'&charge='+$('.result #viewwindow #charge').html()+'&machinetype='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&bizdate='+$('.viewtemp #date').html()+'&consecnumber='+$('.viewtemp #listno input[name="consecnumber"]').val()+'&listtype='+$('.viewtemp #listno input[name="listtype"]').val();
							//console.log(array1);
						}
						var invnumber='';
						var consecnumber='';
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile='';
						}
						else{
						}
						$('.result #checkfun #submit').prop('disabled',true);
						$.ajax({//寫入暫存資料表
							url:'./lib/js/create.tempdb.php',
							method:'post',
							async:false,
							data:array1,
							dataType:'html',
							success:function(d){
								//console.log(d);
								if(d.length>40||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'sale create.tempdb.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								var tempd=d.split('-');
								consecnumber=tempd[1];
								if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
									$('.order#order #tabs4 form[data-id="listform"] input[name="saleno"]').val(tempd[0]);
									$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(tempd[1]);
									array1=$('#tabs4 form[data-id="listform"] , .result #viewwindow .sendviewwindow').serialize();
								}
								else{
								}
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									posdvrfile=tempd[2];
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
						var memberapi='';
						$.ajax({
							url:'./lib/js/checkmember.pointmoney.ajax.php',
							method:'post',
							async:false,
							data:{'company':$('.order#order .companydata #company').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'bizdate':bizdate,'consecnumber':consecnumber},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d[0].length==0){
								}
								else{
									if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
										if($('.result #viewwindow input[name="sendtype"]').val()!='tempsale'){//2020/4/20 排除暫開發票的情況
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												//console.log($('.result #viewwindow input[name="sendtype"]').val());
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,'',d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												//console.log(memberapi);
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														//if(d.length>10||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														/*}
														else{
														}*/
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
										}
									}
									else{//本地會員
										if($('.result #viewwindow input[name="sendtype"]').val()!='tempsale'){//2020/4/20 排除暫開發票的情況
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												//console.log(memberapi);
												if(typeof memberapi[0]!=="undefined"&&typeof memberapi[0]['state']!=="undefined"&&memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														//if(d.length>10||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														/*}
														else{
														}*/
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
										}
									}
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
						/*錢都錄借接*/
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							/*start tag*/
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'start posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){console.log(e);}
							});
							if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
								var res=api_sendmessage_posdvr(posdvrfile);
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'success '+posdvrfile,'file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'error sendmessage is not function','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							/*end tag*/
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'end posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order .initsetting #ticketlisttype').val().match($('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val())&&($('.order#order .initsetting #ticket').val()=='2'||$('.order#order .initsetting #ticket').val()=='3')){//出"兌換卷"
							$.ajax({
								url:'./lib/js/create.ticket.php',
								method:'post',
								async:false,
								data:$('#tabs4 form[data-id="listform"]').serialize(),
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temp create.ticket.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									consecnumber=d;
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}

						if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''||$('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
						}
						else{
							$.ajax({
								url:'./lib/js/create.voidlist.php',
								method:'post',
								async: false,
								data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale create.voidlist.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						
						if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''||$('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
						}
						else{
							$.ajax({
								url:'./lib/js/create.voidkitchen.php',
								method:'post',
								async: false,
								data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'username':$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale create.voidkitchen.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						var opencashdraw=1;//2020/5/13
						if(($('.result input[name="sendtype"]').val()=='result'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用發票&&開立發票
							$.ajax({
								url:'./lib/js/open.inv.php',
								method:'post',
								async:false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale open.inv.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('發票'+d);
									invnumber=d;
									/*$.ajax({
										url:'./lib/js/getzdn.invnumber.php',
										dataType:'html',
										success:function(d){
											//console.log(d);
											if(d=='success'){
												//中鼎下載發票
												if(typeof $('.order#order .zdn')!=='undefined'&&typeof api_zdn_gettoken!=="undefined"&&typeof api_zdn_gettoken==="function"){
													var today = new Date();
													if((today.getMonth() + 1)%2==1){
														var mm = String(today.getMonth() + 2); //January is 0!
														if(mm.length<2){
															mm=String('0')+String(mm);
														}
														else{
														}
													}
													else{
														var mm = String(today.getMonth() + 1); //January is 0!
														if(mm.length<2){
															mm=String('0')+String(mm);
														}
														else{
														}
													}
													var yyyy = Number(today.getFullYear())-1911;

													var res='';
													res=api_zdn_gettoken($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #psw').val());//取得中鼎token
													res.done(function(res){
														res=JSON.parse(res);
														//console.log(res['token']);
														if(typeof res['token']){
															$('.order#order .zdn #token').val(res['token']);
															res='';
															res=api_zdn_showTrack($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),String(yyyy)+String(mm));
															res.done(function(res){
																res=JSON.parse(res);
																//console.log(res);
																var remaining=0;
																if(res['data'].length>0){
																	for(var i=0;i<res['data'].length;i++){
																		if(res['data'][i]['type']=='07'&&Number(res['data'][i]['used_booklet'])<Number(res['data'][i]['total_booklet'])){
																			remaining=Number(remaining)+Number(res['data'][i]['total_booklet'])-Number(res['data'][i]['used_booklet']);
																		}
																		else{
																		}
																	}
																	if(remaining>0){
																		res='';
																		res=api_zdn_getInv($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),remaining);//取得發票號(以"本"為單位；1本50張)
																		res.done(function(res){
																			res=JSON.parse(res);
																			//console.log(res);
																			if(res['success']==true){
																				$.ajax({
																					url:'./lib/js/create.invfile.php',
																					method:'post',
																					data:{'machine':$('.order#order .companydata #terminalnumber').val(),'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'data':res},
																					dataType:'html',
																					success:function(d){
																						//console.log(d);
																					},
																					error:function(e){
																						//console.log(e);
																					}
																				});
																			}
																			else{
																			}
																		});
																		//console.log(remaining);
																	}
																	else{
																		//console.log('empty');
																	}
																}
																else{
																}
															});
														}
														else{
														}
													});
												}
												else{
												}
											}
											else{
											}
										},
										error:function(e){
											//console.log(e);
										}
									});*/
								},
								error:function(e){
									//console.log(e);
								}
							});

							if($('.order#order .initsetting #opencashdraw').val()=='0'&&invnumber.length==10&&$('.result #viewwindow input[name="tempcontainer"]').val()==''){//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
								opencashdraw=0;
							}
							else{
								opencashdraw=1;
							}
						}
						else if(($('.result input[name="sendtype"]').val()=='tempsale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用發票&&開立發票
							$.ajax({
								url:'./lib/js/open.inv.php',
								method:'post',
								async:false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale open.inv.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('發票'+d);
									invnumber=d;
								},
								error:function(e){
									//console.log(e);
								}
							});

							if($('.order#order .initsetting #opencashdraw').val()=='0'&&invnumber.length==10&&$('.result #viewwindow input[name="tempcontainer"]').val()==''){//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
								opencashdraw=0;
							}
							else{
								opencashdraw=1;
							}
						}
						else if(($('.result input[name="sendtype"]').val()=='tempquicksale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用發票&&開立發票
							$.ajax({
								url:'./lib/js/open.inv.php',
								method:'post',
								async:false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale open.inv.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('發票'+d);
									invnumber=d;
								},
								error:function(e){
									//console.log(e);
								}
							});

							if($('.order#order .initsetting #opencashdraw').val()=='0'&&invnumber.length==10&&$('.result #viewwindow input[name="tempcontainer"]').val()==''){//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
								opencashdraw=0;
							}
							else{
								opencashdraw=1;
							}
						}
						else if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')&&invnumber==''){
							invnumber=$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html();

							opencashdraw=1;
						}
						if(($('.result input[name="sendtype"]').val()=='result'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useoinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用傳統發票&&開立傳統發票
							$.ajax({
								url:'./lib/js/open.oinv.php',
								method:'post',
								async:false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale open.oinv.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('發票'+d);
									invnumber=d;
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else if(($('.result input[name="sendtype"]').val()=='tempsale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useoinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用傳統發票&&開立傳統發票
							$.ajax({
								url:'./lib/js/open.oinv.php',
								method:'post',
								async:false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale open.oinv.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('發票'+d);
									invnumber=d;
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else if(($('.result input[name="sendtype"]').val()=='tempquicksale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useoinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用傳統發票&&開立傳統發票
							$.ajax({
								url:'./lib/js/open.oinv.php',
								method:'post',
								async:false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale open.oinv.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('發票'+d);
									invnumber=d;
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')&&invnumber==''){
							invnumber=$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html();
						}
						else{
						}
						
						if($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
							consecnumber=$('.viewtemp #listno input[name="consecnumber"]').val();
						}
						else{
							if(typeof memberapi[0]!=="undefined"){
								array1=array1+'&'+decodeURIComponent($.param(memberapi[0]));
							}
							else{
							}
							if(typeof $('.result #funbox #receipt').val()=="undefined"||$('.result #funbox #receipt').val()=='0'){
							}
							else{
								array1=array1+'&receipt=1';
							}
							$.ajax({
								url:'./lib/js/create.list.php',
								method:'post',
								async: false,
								data:array1,
								dataType:'html',
								success:function(d){
									if(d.length>10||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale create.list.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('明細單'+d);
									consecnumber=d;
								},
								error:function(e){
									//console.log(e);
								}
							});
						}

						if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='tempsale'){//暫結需開發票之情況
						}
						else{
							if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result input[name="sendtype"]').val()=='tempquicksale')){
								if($('.nidin #usenidin').length>0){
									if($('.result #paywindow .paywaybox .nidinother').length>0){//2021/11/8 nidin線上已付款
										nidin_finish($('.viewtemp #date').html(),consecnumber,'','');
									}
									else{
										nidin_finish($('.viewtemp #date').html(),consecnumber,13,'1');
									}
								}
								else{
								}
								$.ajax({
									url:'./lib/js/temptodb.ajax.php',
									method:'post',
									async:false,
									data:{'bizdate':$('.viewtemp #date').html(),'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'numbertag':consecnumber},
									dataType:'html',
									success:function(d){
										if(d.length>20||d.match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'sale temptodb.ajax.php '+d},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										//console.log(d);
										//console.log('轉移正式'+consecnumber);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								if($('.nidin #usenidin').length>0){
									if($('.result #paywindow .paywaybox .nidinother').length>0){//2021/11/8 nidin線上已付款(基本上不會進到這個流程，已付款只能暫結直接結帳)
										nidin_finish($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,'','');
									}
									else{
										nidin_finish($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,13,'1');
									}
								}
								else{
								}
								$.ajax({
									url:'./lib/js/temptodb.ajax.php',
									method:'post',
									async:false,
									data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'numbertag':consecnumber},
									dataType:'html',
									success:function(d){
										if(d.length>20||d.match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'sale temptodb.ajax.php '+d},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){//
												//console.log(e);
												}
											});
										}
										else{
										}
										//console.log(d);
										//console.log('轉移正式'+consecnumber);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
						}
						if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')){
						}
						else{
							$.ajax({//產生工作單
								url:'./lib/js/create.kitchen.php',
								method:'post',
								async:false,
								data:array1,
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale create.kitchen.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('工作單'+d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')){
						}
						else{
							$.ajax({//產生貼紙
								url:'./lib/js/create.tag.php',
								method:'post',
								async:false,
								data:array1,
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale create.tag.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log('貼紙'+d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						if($('.order#order .initsetting #secview').val()=='1'){
							$.ajax({
								url:'../secview/cleartemp.ajax.php',
								method:'post',
								async: false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'sale cleartemp.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
								socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
								console.log('send message "clear" to secview');
							}
							else{
							}
						}
						else{
						}

						if(opencashdraw==1){
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'-cashdrawer_'+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
						}

						/*集點樹贈點流程*/
						if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='tempsale'){//暫結需開發票之情況
						}
						else{
							var ptpoint=0;//兌換點數
							var ptpmoney=0;//兌換點數折扣金額
							var ptmoney=parseFloat($('.result #viewwindow #cash').html())+parseFloat($('.result #viewwindow #cashmoney').html());//集點金額:現金+信用卡金額
							if(typeof $('.result .sendviewwindow input[name="otherstring"]').val()!=="undefined"&&$('.result .sendviewwindow input[name="otherstring"]').val().length>0){
								var tempotherstring=$('.result .sendviewwindow input[name="otherstring"]').val().split(",");
								$.each(tempotherstring,function(v,i){
									var t1=i.split(":");
									var t1name=t1[0].split("-");
									var t1point=t1[1].split("=");
									if(t1name[0]=='pointtree'){
										ptpoint=t1point[0];
										ptppoint=t1point[1];
										return false;
									}
									else{
									}
								});
								if($('.result #viewwindow input[name="treetel"]').val().length>0&&Number(ptpoint)>0){
									/*start tag*/
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'start point-tree-exchange redeem','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
									if(typeof api_exchange_pointtree!=="undefined"&&typeof api_exchange_pointtree==="function"){
										if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='buytemp'){
											var exchangeres=api_exchange_pointtree($('.viewtemp #date').html(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),ptpoint);
										}
										else{
											var exchangeres=api_exchange_pointtree($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),ptpoint);
										}
										//console.log(exchangeres);
										if(exchangeres==''){
											$.ajax({
												url:'./lib/api/print.ticket.php',
												method:'post',
												async:false,
												data:{'type':'pointtree','message':'point-tree-exchange getrandom 意外錯誤'},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'point-tree-exchange getrandom 意外錯誤','file':'point-tree'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else if(typeof exchangeres['data']!=="undefined"){//success
											/*$.ajax({
												url:'./lib/api/print.ticket.php',
												method:'post',
												async:false,
												data:{'type':'pointtree','tel':$('.result #viewwindow input[name="treetel"]').val(),'user_balance':exchangeres['data']['user_balance']},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});*/
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'pass point-tree-exchange redeem -PHP_EOL-pos_token_tx_id:'+exchangeres['data']['pos_token_tx_id'],'file':'point-tree'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											var message=JSON.parse(exchangeres['responseText']);
											if(exchangeres['status']==='timeout'){
												$.ajax({
													url:'./lib/api/print.ticket.php',
													method:'post',
													async:false,
													data:{'type':'pointtree','message':'point-tree-exchange redeem timeout'},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'point-tree-exchange redeem timeout','file':'point-tree'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else if(exchangeres['status']=='400'||exchangeres['status']=='406'){
												$.ajax({
													url:'./lib/api/print.ticket.php',
													method:'post',
													async:false,
													data:{'type':'pointtree','status':exchangeres['status'],'code':message['errors'][0]['code'],'message':message['errors'][0]['message']},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'point-tree-exchange redeem error -PHP_EOL-status:'+exchangeres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else{
												$.ajax({
													url:'./lib/api/print.ticket.php',
													method:'post',
													async:false,
													data:{'type':'pointtree','message':'point-tree-exchange redeem 意外錯誤'},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'point-tree-exchange redeem 意外錯誤','file':'point-tree'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
										}
									}
									else{
										$.ajax({
											url:'./lib/api/print.ticket.php',
											method:'post',
											async:false,
											data:{'type':'pointtree','message':'api exchange pointtree is not function'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'api exchange pointtree is not function','file':'point-tree'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									/*end tag*/
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'end point-tree-exchange redeem','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
							}
							else{
							}
							if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
								if($('.result #viewwindow input[name="treetel"]').val().length>0&&Number(ptmoney)>0){
									/*start tag*/
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'start point-tree-gift transfer','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
									if(typeof api_gift_pointtree!=="undefined"&&typeof api_gift_pointtree==="function"){
										if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='buytemp'){
											var giftres=api_gift_pointtree($('.viewtemp #date').html(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),ptmoney);
										}
										else{
											var giftres=api_gift_pointtree($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),ptmoney);
										}
										//console.log(giftres);
										if(giftres==''){
											$.ajax({
												url:'./lib/api/print.ticket.php',
												method:'post',
												async:false,
												data:{'type':'pointtree','message':'point-tree-gift getrandom 意外錯誤'},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'point-tree-gift getrandom 意外錯誤','file':'point-tree'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else if(typeof giftres['data']!=="undefined"){//success
											$.ajax({
												url:'./lib/api/print.ticket.php',
												method:'post',
												async:false,
												data:{'type':'pointtree','tel':$('.result #viewwindow input[name="treetel"]').val(),/*'give_balance':giftres['data']['give_balance'],*/'user_balance':giftres['data']['user_balance']},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'pass point-tree-gift transfer -PHP_EOL-pos_token_tx_id:'+giftres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+giftres['data']['store_balance']+'-PHP_EOL-user_balance:'+giftres['data']['user_balance'],'file':'point-tree'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											var message=JSON.parse(giftres['responseText']);
											if(giftres['status']==='timeout'){
												$.ajax({
													url:'./lib/api/print.ticket.php',
													method:'post',
													async:false,
													data:{'type':'pointtree','message':'point-tree-gift transfer timeout'},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'point-tree-gift transfer timeout','file':'point-tree'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else if(giftres['status']=='400'||giftres['status']=='406'){
												$.ajax({
													url:'./lib/api/print.ticket.php',
													method:'post',
													async:false,
													data:{'type':'pointtree','status':giftres['status'],'code':message['errors'][0]['code'],'message':message['errors'][0]['message']},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'point-tree-gift transfer error -PHP_EOL-status:'+giftres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else{
												$.ajax({
													url:'./lib/api/print.ticket.php',
													method:'post',
													async:false,
													data:{'type':'pointtree','message':'point-tree-gift transfer 意外錯誤'},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'point-tree-gift transfer 意外錯誤','file':'point-tree'},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
										}
									}
									else{
										$.ajax({
											url:'./lib/api/print.ticket.php',
											method:'post',
											async:false,
											data:{'type':'pointtree','message':'api gift pointtree is not function'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'api gift pointtree is not function','file':'point-tree'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									/*end tag*/
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'end point-tree-gift transfer','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
							}
							else{
							}
						}
						
						if($('.order#order .initsetting #changehint').val()=='1'){//找零提示視窗
							result.dialog('close');
							$('.changehint .inv').val(invnumber);
							$('.changehint .should').val($('.result #viewwindow #should').html());
							$('.changehint .already').val($('.result #viewwindow #already').html());
							$('.changehint .change').val($('.result #viewwindow #change').html());
							change.dialog('open');
						}
						else{
							if(viewtemp.dialog('isOpen')){//暫結開立發票
								//alertmessage('發票開立完成。');
								$('.alertmessage #text').html('發票開立完成。');
								alertmessage.dialog('open');
								ClearWindow('','');
								result.dialog('close');
								viewtemp.dialog('close');
								$('.order#order #list #funbox #view').trigger('click');
								$.ajax({
									url:'./lib/js/check.booking.php',
									method:'post',
									async:false,
									data:{'machinetype':$('.order#order .companydata #terminalnumber').val()},
									dataType:'html',
									success:function(d){
										if(d=='success'){
											if($('.order#order #banner #detail #tw #point').css('background-color')=='red'){
											}
											else{
												$('.order#order #banner #detail #tw #point').css({'background-color':'red','z-index':'3'});
											}
										}
										else{
											$('.order#order #banner #detail #tw #point').css({'background-color':'','z-index':''});
										}
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								window.setTimeout(function(){
									if($('.order#order .initsetting #controltable').val()=='1'){
										/*if($('.order#order .companydata #submachine').length>0){
											location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
										}
										else{
											if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
												location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
											}
											else{
												location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
											}
										}*/
										result.dialog('close');
										inittable.dialog('open');
										ClearWindow('','');
									}
									else{
										//if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val().length>0){
											//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
											result.dialog('close');
											ClearWindow('','');
										/*}
										else{
											location.href='./order.php';
										}*/
									}
								},500);
							}
						}
					//}
				}
			}
		}
	});
	$('.result #checkfun').on('click','#cancel',function(event){//結帳畫面取消按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面取消按鈕','cancel');
		if($('.result #paywindow #paycontent .paywaybox .payway .intellaother').length>0&&$('.result #paywindow #paycontent .paywaybox .payway .intellaother').parents('.paywaybox').find('input[type="checkbox"]').length>0){//判斷是否使用英特拉付款，若有須先把該付款清除(退款步驟)
			if($('.sysmeg #name1.syshint10').length>0){
				$('.sysmeg #name1.syshint10').css({'display':'block'});
			}
			else{
			}
			if($('.sysmeg #name2.syshint10').length>0){
				$('.sysmeg #name2.syshint10').css({'display':'block'});
			}
			else{
			}
			sysmeg.dialog('open');
		}
		else if($('.order#order .initsetting #nccc').val()=='1'&&$('.result #paywindow #paycontent .paywaybox .payway .paycash').length>0){//2022/4/13 判斷是否串接聯合信用卡中心並且有使用刷卡付款，若有需先把該付款清除(退款步驟)
			if($('.sysmeg #name1.syshint12').length>0){
				$('.sysmeg #name1.syshint12').css({'display':'block'});
			}
			else{
			}
			if($('.sysmeg #name2.syshint12').length>0){
				$('.sysmeg #name2.syshint12').css({'display':'block'});
			}
			else{
			}
			sysmeg.dialog('open');
		}
		else if($('.result #paywindow #paycontent .paywaybox .payway input[name="directlinepay"]').length>0&&$('.order#order .initsetting #directlinepay').val()=='1'&&eval($('.result #paywindow #paycontent .paywaybox .payway #name1 input[name="directlinepay"]').map(function(){return $(this).val();}).get().join('+'))>0){//2022/5/4 判斷是否串接直接linepay付款且有使用linepay付款，若有需先把該付款清除(退款步驟)
			if($('.sysmeg #name1.syshint13').length>0){
				$('.sysmeg #name1.syshint13').css({'display':'block'});
			}
			else{
			}
			if($('.sysmeg #name2.syshint13').length>0){
				$('.sysmeg #name2.syshint13').css({'display':'block'});
			}
			else{
			}
			sysmeg.dialog('open');
		}
		else if($('.result #paywindow #paycontent .paywaybox .payway input[name="jkos"]').length>0&&$('.order#order .initsetting #jkos').val()=='1'&&eval($('.result #paywindow #paycontent .paywaybox .payway #name1 input[name="jkos"]').map(function(){return $(this).val();}).get().join('+'))>0){//2022/10/6 判斷是否串接街口支付付款且有使用街口支付付款，若有需先把該付款清除(退款步驟)
			if($('.sysmeg #name1.syshint13').length>0){
				$('.sysmeg #name1.syshint13').css({'display':'block'});
			}
			else{
			}
			if($('.sysmeg #name2.syshint13').length>0){
				$('.sysmeg #name2.syshint13').css({'display':'block'});
			}
			else{
			}
			sysmeg.dialog('open');
		}
		else if($('.result #paywindow #paycontent .paywaybox .payway input[name="pxpayplus"]').length>0&&$('.order#order .initsetting #pxpayplus').val()=='1'&&eval($('.result #paywindow #paycontent .paywaybox .payway #name1 input[name="pxpayplus"]').map(function(){return $(this).val();}).get().join('+'))>0){//2022/10/28 判斷是否串接全支付付款且有使用街口支付付款，若有需先把該付款清除(退款步驟)
			if($('.sysmeg #name1.syshint13').length>0){
				$('.sysmeg #name1.syshint13').css({'display':'block'});
			}
			else{
			}
			if($('.sysmeg #name2.syshint13').length>0){
				$('.sysmeg #name2.syshint13').css({'display':'block'});
			}
			else{
			}
			sysmeg.dialog('open');
		}
		else{
			//oneEvent(event);
			$('.result #viewwindow #total').html('0');
			$('.result #viewwindow #temptotal').val('0');
			$('.result #viewwindow #itemdis').html('0');
			$('.result #viewwindow #tempdis').val('0');
			$('.result #viewwindow #memberdis').html('0');
			$('.result #viewwindow #listdis1').html('0');
			$('.result #viewwindow #listdis2').html('0');
			$('.result #viewwindow #charge').html('0');
			$('.result #viewwindow #coupon1').html('0');
			$('.result #viewwindow #coupon2').html('0');
			$('.result #viewwindow #should').html('0');
			$('.result #viewwindow #already').html('0');
			$('.result #viewwindow #cashmoney').html('0');
			$('.result #viewwindow #cash').html('0');
			$('.result #viewwindow #other').html('0');
			$('.result #viewwindow input[name="otherstring"]').val('');
			$('.result #viewwindow #otherfix').html('0');
			$('.result #viewwindow #notyet').html('0');
			$('.result #viewwindow #change').html('0');
			$('.result #viewwindow #autodis').html('0');
			/*if($('.order#order #MemberBill #tabs4 form[data-id="listform"] .listcontent')){
			}
			else{
			}*/
			$.ajax({
				url:'../secview/writepoint.ajax.php',
				method:'post',
				data:{'tel':'','point':'0','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()}
			});
			result.dialog('close');
			if($('.result input[name="sendtype"]').val()=='tempsale'){
			}
			else if($('.result input[name="sendtype"]').val()=='tempquicksale'){
				ClearWindow('','');
			}
			else if($('.result input[name="sendtype"]').val()=='buytemp'){
				$('.memdata #clear').trigger('click');
				/*$('.temptoinv').html('');
				$('.temptoinv').append("<button id='delplus' value='修改帳單'>修改帳單</button>");
				$('.temptoinv').append("<button id='cancel' value='取消'>取消</button>");
				temptoinv.dialog('open');*/
			}
			else{
			}
		}
	});
	$('.itemdis .numbox').on('click','input',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('調整促銷數字',$(this).val());
		//oneEvent(event);
		var index=$('.itemdis .numbox input').index(this);
		if($('.itemdis input[name="view"]').val()==''&&$('.itemdis .numbox input:eq('+index+')').val()=='.'){
			$('.itemdis input[name="view"]').val('0.');
		}
		else{
			$('.itemdis input[name="view"]').val($('.itemdis input[name="view"]').val()+$('.itemdis .numbox input:eq('+index+')').val());
		}
	});
	$('.setchange .numbox').on('click','input',function(event){
		//oneEvent(event);
		var index=$('.setchange .numbox input').index(this);
		if($('.setchange input[name="view"]').val()==''&&$('.setchange .numbox input:eq('+index+')').val()=='.'){
			$('.setchange input[name="view"]').val('0.');
		}
		else if($('.setchange input[name="view"]').val()=='0'){
			$('.setchange input[name="view"]').val($('.setchange .numbox input:eq('+index+')').val());
		}
		else{
			$('.setchange input[name="view"]').val($('.setchange input[name="view"]').val()+$('.setchange .numbox input:eq('+index+')').val());
		}
	});
	$('.setchange .numbox').on('click','button',function(event){
		//oneEvent(event);
		$('.setchange input[name="view"]').val('0');
	});
	$('.itemdis .numbox').on('click','button',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('清除促銷數字',$(this).find('#name1').html());
		//oneEvent(event);
		$('.itemdis input[name="view"]').val('');
	});
	$('.itemdis #funbox').on('click','#free',function(event){//免費招待(單位:數量)
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('免費招待',$('.itemdis input[name="view"]').val());
		returnitempoint();
		//oneEvent(event);
		if($('.itemdis input[name="view"]').val().length>0){
			$('.itemdis #viewwindow #dis2').html(Number($('.itemdis input[name="view"]').val())*(Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html())));
			$('.itemdis #viewwindow #total').html(Number($('.itemdis #viewwindow #subtotal').html())-Number($('.itemdis #viewwindow #dis1').html())-Number($('.itemdis #viewwindow #dis2').html()));
			if(Number($('.itemdis #viewwindow #total').html())<=0){
				$('.itemdis #viewwindow #dis2').html(Number($('.itemdis #viewwindow #total').html())+Number($('.itemdis #viewwindow #dis2').html()));
				$('.itemdis #viewwindow #total').html('0');
			}
			else{
			}
			$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('free');
		}
		/*else if($('.itemdis input[name="view"]').val()==''){//全部免費招待
			$('.itemdis #viewwindow #dis2').html(Number($('.itemdis #viewwindow #number').html())*(Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html())));
			$('.itemdis #viewwindow #total').html(Number($('.itemdis #viewwindow #subtotal').html())-Number($('.itemdis #viewwindow #dis1').html())-Number($('.itemdis #viewwindow #dis2').html()));
			if(Number($('.itemdis #viewwindow #total').html())<=0){
				$('.itemdis #viewwindow #dis2').html(Number($('.itemdis #viewwindow #total').html())+Number($('.itemdis #viewwindow #dis2').html()));
				$('.itemdis #viewwindow #total').html('0');
			}
			else{
			}
			$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('free');
		}*/
		else{
			$('.itemdis #viewwindow #dis2').html((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html())));
			$('.itemdis #viewwindow #total').html(Number($('.itemdis #viewwindow #subtotal').html())-Number($('.itemdis #viewwindow #dis1').html())-Number($('.itemdis #viewwindow #dis2').html()));
			if(Number($('.itemdis #viewwindow #total').html())<=0){
				$('.itemdis #viewwindow #dis2').html(Number($('.itemdis #viewwindow #total').html())+Number($('.itemdis #viewwindow #dis2').html()));
				$('.itemdis #viewwindow #total').html('0');
			}
			else{
			}
			$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('free');
		}
	});
	$('.itemdis #funbox').on('click','#dis1',function(event){//單品折扣(單位:折)
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('單品折扣',$('.itemdis input[name="view"]').val());
		returnitempoint();
		//oneEvent(event);
		if($('.itemdis input[name="view"]').val().length>0){
			//$('.itemdis #viewwindow #dis2').html(discount2(Number($('.itemdis input[name="view"]').val())));//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			$('.itemdis #viewwindow #total').html(discount2(Number($('.itemdis input[name="view"]').val())));
			computeritemsubtotal('dis2');
			$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('dis1');
		}
		else{
		}
	});
	$('.itemdis #funbox').on('click','#dis2',function(event){//單品折讓(單位:元)
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('單品折讓',$('.itemdis input[name="view"]').val());
		returnitempoint();
		//oneEvent(event);
		if($('.itemdis input[name="view"]').val().length>0){
			//$('.itemdis #viewwindow #dis2').html($('.itemdis input[name="view"]').val());//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			$('.itemdis #viewwindow #total').html(discountS($('.itemdis input[name="view"]').val()));
			computeritemsubtotal('dis2');
			$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('dis2');
		}
		else{
		}
	});
	$('.itemdis #funbox').on('click','#sdis1',function(event){//單一價
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('單一價',$('.itemdis input[name="view"]').val());
		returnitempoint();
		//oneEvent(event);
		$('.itemdis input[name="view"]').val('');
		if($('.order#order .initsetting #itemaccuracyseq').val()=='1'){
			if((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))<Number($('.order#order .initsetting #singledis').val())){
				//alertmessage('錯誤操作。');
				$('.alertmessage #text').html('錯誤操作。');
				alertmessage.dialog('open');
			}
			else{
				$('.itemdis #viewwindow #dis2').html(((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))-Number($('.order#order .initsetting #singledis').val()))*Number($('.itemdis #viewwindow #number').html()));
				$('.itemdis #viewwindow #total').html(Number($('.order#order .initsetting #singledis').val())*Number($('.itemdis #viewwindow #number').html()));
				$('.itemdis #viewwindow #disbut').val('sdis1');
			}
		}
		else{
			if(Number($('.itemdis #viewwindow #unitprice').html())<Number($('.order#order .initsetting #singledis').val())){
				//alertmessage('錯誤操作。');
				$('.alertmessage #text').html('錯誤操作。');
				alertmessage.dialog('open');
			}
			else{
				$('.itemdis #viewwindow #dis2').html((Number($('.itemdis #viewwindow #unitprice').html())-Number($('.order#order .initsetting #singledis').val()))*Number($('.itemdis #viewwindow #number').html()));
				$('.itemdis #viewwindow #total').html((Number($('.order#order .initsetting #singledis').val())+Number($('.itemdis #viewwindow #tastemoney').html()))*Number($('.itemdis #viewwindow #number').html()));
				$('.itemdis #viewwindow #disbut').val('sdis1');
			}
		}
	});
	$('.itemdis #funbox').on('click','#qdis1',function(event){//快速折扣
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('快速折扣',$(this).find('#name1').html());
		returnitempoint();
		//oneEvent(event);
		if($('.order#order .initsetting #dis1number').length>0){
			//$('.itemdis #viewwindow #dis2').html(discount2(Number($('.order#order .initsetting #dis1number').val())));//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			$('.itemdis #viewwindow #total').html(discount2(Number($('.order#order .initsetting #dis1number').val())));
			computeritemsubtotal('dis2');
			//$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('dis1');
		}
		else{
		}
	});
	$('.itemdis #funbox').on('click','#qdis2',function(event){//快速折讓
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('快速折讓',$(this).find('#name1').html());
		returnitempoint();
		//oneEvent(event);
		if($('.order#order .initsetting #dis2number').length>0){
			//$('.itemdis #viewwindow #dis2').html($('.order#order .initsetting #dis2number').val());//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			$('.itemdis #viewwindow #total').html(discountS($('.order#order .initsetting #dis2number').val()));
			computeritemsubtotal('dis2');
			//$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('dis2');
		}
		else{
		}
	});
	$('.itemdis #funbox').on('click','button[id^="itemdis"]',function(){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('自訂義單品促銷',$(this).find('#name1').html());
		returnitempoint();
		var disindex=$('.itemdis #funbox button[id^="itemdis"]').index(this);
		if($('.itemdis #funbox input[name="itemdistype'+(Number(disindex)+1)+'"]').length>0&&$('.itemdis #funbox input[name="itemdistype'+(Number(disindex)+1)+'"]').val()=='2'){//2022/3/17 折讓
			//$('.itemdis #viewwindow #dis2').html($('.order#order .initsetting #dis2number').val());//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			$('.itemdis #viewwindow #total').html(discountS($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val()));
			computeritemsubtotal('dis2');
			//$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('dis2');
		}
		else if($('.itemdis #funbox input[name="itemdistype'+(Number(disindex)+1)+'"]').length>0&&$('.itemdis #funbox input[name="itemdistype'+(Number(disindex)+1)+'"]').val()=='3'){//2022/3/17 單一價
			if($('.order#order .initsetting #itemaccuracyseq').val()=='1'){
				if((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))<Number($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val())){
					//alertmessage('錯誤操作。');
					$('.alertmessage #text').html('錯誤操作。');
					alertmessage.dialog('open');
				}
				else{
					$('.itemdis #viewwindow #dis2').html(((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))-Number($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val()))*Number($('.itemdis #viewwindow #number').html()));
					$('.itemdis #viewwindow #total').html(Number($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val())*Number($('.itemdis #viewwindow #number').html()));
					$('.itemdis #viewwindow #disbut').val('sdis1');
				}
			}
			else{
				if(Number($('.itemdis #viewwindow #unitprice').html())<Number($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val())){
					//alertmessage('錯誤操作。');
					$('.alertmessage #text').html('錯誤操作。');
					alertmessage.dialog('open');
				}
				else{
					$('.itemdis #viewwindow #dis2').html((Number($('.itemdis #viewwindow #unitprice').html())-Number($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val()))*Number($('.itemdis #viewwindow #number').html()));
					$('.itemdis #viewwindow #total').html((Number($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val())+Number($('.itemdis #viewwindow #tastemoney').html()))*Number($('.itemdis #viewwindow #number').html()));
					$('.itemdis #viewwindow #disbut').val('sdis1');
				}
			}
		}
		else{
			//$('.itemdis #viewwindow #dis2').html(discount2(Number($('.order#order .initsetting #dis1number').val())));//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			$('.itemdis #viewwindow #total').html(discount2(Number($('.itemdis #funbox input[name="itemdis'+(Number(disindex)+1)+'"]').val())));
			computeritemsubtotal('dis2');
			//$('.itemdis input[name="view"]').val('');
			$('.itemdis #viewwindow #disbut').val('dis1');
		}
	});
	$('.itemdis #funbox #memberpoint').click(function(){//2020/4/15 單品優惠點數兌換
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('點數兌換',$(this).find('#name1').html());
		returnitempoint();
		if($('.itemdis #viewwindow #initpoint').html()!=0&&$('.initsetting #usememberpoints').length>0&&parseFloat($('.itemdis #viewwindow #initpoint').html())>=parseFloat($('.initsetting #usememberpoints').val())){//具有會員點數，且至少能夠使用一次點數優惠
			if($('.initsetting #usememberpoints').length>0&&parseInt($('.initsetting #usememberpoints').val())>0&&$('.initsetting #usemembermaxmoney').length>0&&parseInt($('.initsetting #usemembermaxmoney').val())!=0){//單次使用點數大於0與單次優惠不等於0
				if($('.initsetting #usemembertype').length>0&&$('.initsetting #usemembertype').val()=='1'){//原價計算
					var usepoint=0;//總使用點數
					var dismoney=0;//總優惠金額
					var singletime=0;//單品項優惠次數
					var itemmoney=$('.itemdis #viewwindow #unitprice').html();//品項可優惠金額

					if($('.itemdis input[name="view"]').val()==''){
						var maxpoint=$('.itemdis #viewwindow #initpoint').html();
					}
					else{
						var maxpoint=Math.min(parseFloat(parseInt($('.itemdis input[name="view"]').val())*parseInt($('.initsetting #usememberpoints').val())),parseFloat($('.itemdis #viewwindow #initpoint').html()));
					}
					
					if(parseInt($('.itemdis #viewwindow #number').html())>0){
						var i=0;
						for(;i<parseInt($('.itemdis #viewwindow #number').html());){
							if(parseInt(singletime)<parseInt($('.initsetting #usememberitemtime').val()) && parseFloat(itemmoney)>0 && (parseInt(usepoint)+parseInt($('.initsetting #usememberpoints').val()))<=maxpoint){//單品項優惠次數未達到上限、品項剩餘可優惠金額大於0、剩餘點數夠執行一次優惠、
								usepoint=parseInt(usepoint)+parseInt($('.initsetting #usememberpoints').val());
								if(parseFloat(itemmoney)<=parseFloat($('.initsetting #usemembermaxmoney').val())){
									dismoney=parseFloat(dismoney)+parseFloat(itemmoney);
									itemmoney=0;
								}
								else{
									dismoney=parseFloat(dismoney)+parseFloat($('.initsetting #usemembermaxmoney').val());
									itemmoney=parseFloat(itemmoney)-parseFloat($('.initsetting #usemembermaxmoney').val());
								}
								singletime++;
								//console.log('兌換一次');
							}
							else if((parseInt(usepoint)+parseInt($('.initsetting #usememberpoints').val()))>maxpoint){//剩餘點數不足夠執行下一次優惠，"跳出"
								//console.log('點數不足執行下一次優惠');
								break;
							}
							else{
								i++;
								itemmoney=$('.itemdis #viewwindow #unitprice').html();
								singletime=0;
								//console.log('下一個');
							}
						}
					}
					else if(parseInt($('.itemdis #viewwindow #number').html())==0){
						usepoint=-$('.itemdis #viewwindow #memberpoint').html();
					}
					else{
					}
					
					$('.itemdis #viewwindow #initpoint').html(parseInt($('.itemdis #viewwindow #initpoint').html())-parseInt(usepoint));
					$('.itemdis #viewwindow #memberpoint').html(usepoint);
					$('.itemdis #viewwindow input[name="dispointtime"]').val(parseInt(i)+1);
					$('.itemdis #viewwindow #dis2').html(dismoney);
					//computeritemsubtotal('dis2');//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
					$('.itemdis #viewwindow #total').html(Number(Number($('.itemdis #viewwindow #subtotal').html())-Number(dismoney)));
					$('.itemdis input[name="view"]').val('');
					$('.itemdis #viewwindow #disbut').val('memberpoint');
					//console.log('usepoint: '+usepoint);
					//console.log('dismoney: '+dismoney);
					//console.log('成功兌換點數');
				}
				else{//包含加料
					var usepoint=0;//總使用點數
					var dismoney=0;//總優惠金額
					var singletime=0;//單品項優惠次數
					var itemmoney=parseFloat($('.itemdis #viewwindow #unitprice').html())+parseFloat($('.itemdis #viewwindow #tastemoney').html());//品項可優惠金額

					if($('.itemdis input[name="view"]').val()==''){
						var maxpoint=$('.itemdis #viewwindow #initpoint').html();
					}
					else{
						var maxpoint=Math.min(parseFloat(parseInt($('.itemdis input[name="view"]').val())*parseInt($('.initsetting #usememberpoints').val())),parseFloat($('.itemdis #viewwindow #initpoint').html()));
					}
					
					if(parseInt($('.itemdis #viewwindow #number').html())>0){
						var i=0;
						for(;i<parseInt($('.itemdis #viewwindow #number').html());){
							if(parseInt(singletime)<parseInt($('.initsetting #usememberitemtime').val()) && parseFloat(itemmoney)>0 && (parseInt(usepoint)+parseInt($('.initsetting #usememberpoints').val()))<=maxpoint){//單品項優惠次數未達到上限、品項剩餘可優惠金額大於0、剩餘點數夠執行一次優惠、
								usepoint=parseInt(usepoint)+parseInt($('.initsetting #usememberpoints').val());
								if(parseFloat(itemmoney)<=parseFloat($('.initsetting #usemembermaxmoney').val())){
									dismoney=parseFloat(dismoney)+parseFloat(itemmoney);
									itemmoney=0;
								}
								else{
									dismoney=parseFloat(dismoney)+parseFloat($('.initsetting #usemembermaxmoney').val());
									itemmoney=parseFloat(itemmoney)-parseFloat($('.initsetting #usemembermaxmoney').val());
								}
								singletime++;
								//console.log('兌換一次');
							}
							else if((parseInt(usepoint)+parseInt($('.initsetting #usememberpoints').val()))>maxpoint){//剩餘點數不足夠執行下一次優惠，"跳出"
								//console.log('點數不足執行下一次優惠');
								break;
							}
							else{
								i++;
								itemmoney=parseFloat($('.itemdis #viewwindow #unitprice').html())+parseFloat($('.itemdis #viewwindow #tastemoney').html());
								singletime=0;
								//console.log('下一個');
							}
						}
					}
					else if(parseInt($('.itemdis #viewwindow #number').html())==0){
						usepoint=-$('.itemdis #viewwindow #memberpoint').html();
					}
					else{
					}

					$('.itemdis #viewwindow #initpoint').html(parseInt($('.itemdis #viewwindow #initpoint').html())-parseInt(usepoint));
					$('.itemdis #viewwindow #memberpoint').html(usepoint);
					$('.itemdis #viewwindow input[name="dispointtime"]').val(parseInt(i)+1);
					$('.itemdis #viewwindow #dis2').html(dismoney);
					//computeritemsubtotal('dis2');//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
					$('.itemdis #viewwindow #total').html(Number(Number($('.itemdis #viewwindow #subtotal').html())-Number(dismoney)));
					$('.itemdis input[name="view"]').val('');
					$('.itemdis #viewwindow #disbut').val('memberpoint');
				}
			}
			else{
				console.log('無法使用點數兌換');
			}
		}
		else{
			console.log('點數不足');
		}
	});
	function returnitempoint(){//2020/4/20 (單品促銷)回歸未使用點數優惠前的狀態
		$('.itemdis #viewwindow #initpoint').html(parseInt($('.itemdis #viewwindow #initpoint').html())+parseInt($('.itemdis #viewwindow #memberpoint').html()));
		$('.itemdis #viewwindow #memberpoint').html('0');
		$('.itemdis #viewwindow input[name="dispointtime"]').val('0');
		$('.itemdis #viewwindow #dis2').html('0');
		$('.itemdis #viewwindow #disbut').val('');
		$('.itemdis #viewwindow #total').html((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))*Number($('.itemdis #viewwindow #number').html()));
	}
	function discountS(disn){//2021/3/2
		var temp;
		var precision=$('.order#order .initsetting #accuracy').val();
		if($('.order#order .initsetting #itemaccuracyseq').val()=='1'){//以加料後的價格(設定檔內設定)
			//temp=(Number((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))*Number($('.itemdis #viewwindow #number').html()))*(100-disn))/100;//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			temp=Number((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))*Number($('.itemdis #viewwindow #number').html()))-Number(disn);
			if(Number(temp)<0){
				temp=0;
			}
			else{
			}
		}
		else{//以原始價格
			//temp=Number((Number($('.itemdis #viewwindow #unitprice').html())*Number($('.itemdis #viewwindow #number').html()))*(100-disn))/100;//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			temp=Number((Number($('.itemdis #viewwindow #unitprice').html())*Number($('.itemdis #viewwindow #number').html())))-Number(disn);
			if(Number(temp)<0){
				temp=Number($('.itemdis #viewwindow #tastemoney').html())*Number($('.itemdis #viewwindow #number').html());
			}
			else{
				temp=Number(temp)+Number($('.itemdis #viewwindow #tastemoney').html())*Number($('.itemdis #viewwindow #number').html());
			}
		}
		/*設定檔內可設定使用何種進位*/
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			return roundfun(temp ,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			return ceilfun(temp ,precision);
		}
		else{//無條件捨去
			return floorfun(temp ,precision);
		}
	}
	function discount2(disn){
		var temp;
		//var precision=parseInt($('.order#order .initsetting #accuracy').val())+2;//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確，為此精準度就不用再往後移
		var precision=$('.order#order .initsetting #accuracy').val();
		if($('.order#order .initsetting #itemaccuracyseq').val()=='1'){//以加料後的價格(設定檔內設定)
			//temp=(Number((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))*Number($('.itemdis #viewwindow #number').html()))*(100-disn))/100;//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			temp=(Number((Number($('.itemdis #viewwindow #unitprice').html())+Number($('.itemdis #viewwindow #tastemoney').html()))*Number($('.itemdis #viewwindow #number').html()))*disn)/100;
			if(Number(temp)<0){
				temp=0;
			}
			else{
			}
		}
		else{//以原始價格
			//temp=Number((Number($('.itemdis #viewwindow #unitprice').html())*Number($('.itemdis #viewwindow #number').html()))*(100-disn))/100;//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
			temp=Number((Number($('.itemdis #viewwindow #unitprice').html())*Number($('.itemdis #viewwindow #number').html()))*disn)/100;
			if(Number(temp)<0){
				temp=Number($('.itemdis #viewwindow #tastemoney').html())*Number($('.itemdis #viewwindow #number').html());
			}
			else{
				temp=Number(temp)+Number($('.itemdis #viewwindow #tastemoney').html())*Number($('.itemdis #viewwindow #number').html());
			}
		}
		/*設定檔內可設定使用何種進位*/
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			return roundfun(temp ,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			return ceilfun(temp ,precision);
		}
		else{//無條件捨去
			return floorfun(temp ,precision);
		}
	};
	function computeritemsubtotal(idvalue){
		//2021/3/2 原本計算以折扣金額優先計算，因為會影響到後續的發票金額計算，改由折扣後的小記金額為主，確保發票金額正確
		/*var precision=$('.order#order .initsetting #accuracy').val();
		var temp=Number(Number($('.itemdis #viewwindow #subtotal').html())-Number($('.itemdis #viewwindow #dis1').html())-Number($('.itemdis #viewwindow #dis2').html()));
		//console.log(temp);
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.itemdis #viewwindow #total').html( roundfun(temp ,precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.itemdis #viewwindow #total').html( ceilfun(temp ,precision));
		}
		else{//無條件捨去
			$('.itemdis #viewwindow #total').html( floorfun(temp ,precision));
		}
		if(Number($('.itemdis #viewwindow #total').html())<=0){
			$('.itemdis #viewwindow #'+idvalue).html(Number($('.itemdis #viewwindow #total').html())+Number($('.itemdis #viewwindow #'+idvalue).html()));
			$('.itemdis #viewwindow #total').html('0');
		}
		else{
		}*/
		$('.itemdis #viewwindow #'+idvalue).html(Number(Number($('.itemdis #viewwindow #subtotal').html())-Number($('.itemdis #viewwindow #total').html())));
		//console.log($('.order#order .initsetting #accuracytype').val());
		//console.log($('.itemdis #viewwindow #total').html());
	}
	$('.itemdis #checkfun').on('click','#submit',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('確認促銷','submit');
		//oneEvent(event);
		if(Number($('.itemdis #viewwindow #memberpoint').html())!=0){
			$('.order#order #tabs1 #tempbox input[name="dispoint"]').val(parseInt($('.itemdis #viewwindow #memberpoint').html())+(parseInt($('.itemdis #viewwindow input[name="dispointtime"]').val())*parseInt($('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val())));//2020/4/14 單品優惠使用點數
			$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val($('.itemdis #viewwindow input[name="dispointtime"]').val());//2020/4/24
		}
		else{
			$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
			$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/24
		}
		$('.order#order #tabs1 #tempbox input[name="discount"]').val(Number($('.itemdis #viewwindow #dis1').html())+Number($('.itemdis #viewwindow #dis2').html()));
		$('.order#order #tabs1 #tempbox input[name="discontent"]').val($('.itemdis #viewwindow #disbut').val());

		$('.order#order #MemberBill #tabs1 #membutton #memberpoint').val($('.itemdis #viewwindow #initpoint').html());//2020/4/20
		$('.memdata #point').html($('.itemdis #viewwindow #initpoint').html());//2020/4/20

		$('.order#order #tabs1 #tempbox input[name="subtotal"]').val($('.itemdis #viewwindow #total').html());
		$('.order#order #editview').trigger('change');
		updateview();
		sumsubtotal();
		itemdis.dialog('close');
	});
	$('.itemdis #checkfun').on('click','#cancel',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('取消促銷','cancel');
		//oneEvent(event);
		itemdis.dialog('close');
	});
	$('.changehint').on('click','#reload',function(event){
		//oneEvent(event);
		/*if($('.order#order .initsetting #controltable').val()=='1'){
			if($('.order#order .companydata #submachine').length>0){
				location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
			}
			else{
				if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
					location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				}
				else{
					location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				}
			}
		}
		else{
			change.dialog('close');
			if(viewtemp.dialog('isOpen')){
				viewtemp.dialog('close');
				$('.order#order #list #funbox #view').trigger('click');
			}
			else{
			}
		}*/
		change.dialog('close');
		if(viewtemp.dialog('isOpen')){
			viewtemp.dialog('close');
			$('.order#order #banner #detail #tw #view').trigger('click');
		}
		else{
		}
	});
	$('.exitsys').on('click','.no',function(event){
		//oneEvent(event);
		exitsys.dialog('close');
	});
	$('.exitsys').on('click','.yes',function(event){
		//oneEvent(event);
		if($('.order#order .initsetting #secview').val()=='1'){
			$.ajax({
				url:'../secview/cleartemp.ajax.php',
				method:'post',
				async: false,
				data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
				socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
				console.log('send message "clear" to secview');
			}
			else{
			}
		}
		else{
		}
		/*if($('.order#order .companydata #ispad').val()=='submachine'){//2018/2/7
			//var mywin=window.open('exit://','','width=1px,height=1px');
		}
		else{//2018/2/7
			if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()!='m1'){
				//var mywin=window.open('exit://','','width=1px,height=1px');
			}
			else{*/
			if($('.order#order .initsetting #posexitmode').length>0&&$('.order#order .initsetting #posexitmode').val()=='2'){
				var mywin=window.open('exit://','','width=1px,height=1px');
			}
			else{
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':$('.order#order .companydata #terminalnumber').val()+'-exit_'+$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			/*}
		}*/
		//2017/12/29document.title='點餐畫面－關閉程式';
		//2017/12/29var mywin=window.open('exit://','','width=1px,height=1px');
	});
	$('.sysmeg4').on('click','.closesysmeg',function(event){
		//oneEvent(event);
		$('.order#order #billfun #billfun2 .close').prop('disabled',false);
		sysmeg4.dialog('close');
		if($('.order#order .initsetting #controltable').val()=='1'){
			$('.funbox #close').prop('disabled',false);
			$('.funbox #salelist').prop('disabled',false);
			$('.funbox #voidsale').prop('disabled',false);
			if($('.order#order .initsetting #kvm').val()=='1'){
				$('.funbox #kvm').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #moneycost').val()=='1'){
				$('.funbox #AE').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #openpunch').val()=='1'){
				$('.funbox #punch').prop('disabled',false);
				$('.funbox #editpunch').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #historypaper').val()=='1'){
				$('.funbox #historypaper').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #openindex').val()=='1'){
				$('.funbox #logout').prop('disabled',false);
			}
			else{
			}
			$('.funbox #updatemenu').prop('disabled',false);
			$('.funbox #view').prop('disabled',false);
			$('.funbox #return').prop('disabled',false);
		}
		else{
		}
	});
	$('.sysmeg4').on('click','.check',function(event){
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/close.ajax.php',
			method:'post',
			async: false,
			data:{'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'close.ajax.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				/*}
				else{
				}*/
				if(d=='error'){
					//console.log(d);
				}
				else{
					$.ajax({
						url:'./lib/js/change.class.php',
						method:'post',
						async: false,
						data:{'type':'isopen','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'whopass':'demopos-message4-close.ajax.php'},
						dataType:'html',
						success:function(d){
							//if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'change.class.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							/*}
							else{
							}*/
							//console.log(d);
							$('.order#order #MemberBill #billfun #billfun1button').prop('disabled',true);
							//$billfun.tabs('disable','#billfun1');
							$('.order#order #billfun #billfun2 .outmoney').prop('disabled',true);
							$('.order#order #billfun #billfun2 .open').prop('disabled',false);
							$('.order#order #MemberBill #billfun #billfun2button').trigger('click');
							sysmeg4.dialog('close');
							if($('.order#order .initsetting #controltable').val()=='1'){
								$('.inittable .funcmap #tablesplit').prop('disabled',true);
								$('.inittable .funcmap #combine').prop('disabled',true);
								$('.inittable .funcmap #tablecombine').prop('disabled',true);
								$('.inittable .funcmap #changetable').prop('disabled',true);
								$('.funbox #open').prop('disabled',false);
								$('.funbox #return').prop('disabled',false);
								$('.funbox #printchange').prop('disabled',false);
								funbox.dialog('close');
							}
							else{
							}
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile='';
							}
							else{
							}
							$.ajax({
								url:'./lib/js/shift.paper.php',
								method:'post',
								async: false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'zcounter':d},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'shift.paper.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}

									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var tempd=d.split('-');
										posdvrfile=tempd[0];
									}
									else{
									}
									//console.log(d);
									$.ajax({
										url:'./lib/js/create.cmdtxt.php',
										method:'post',
										async: false,
										data:{'cmd':$('.order#order .companydata #terminalnumber').val()+'-upload_'+$('.order#order .companydata #terminalnumber').val()},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
									//2017/12/29var mywin=window.open('cashdrawer://upload','','width=1px,height=1px');
									//2017/12/29mywin.document.title='cashdrawer';
								},
								error:function(e){
									//console.log(e);
								}
							});
							/*錢都錄借接*/
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								/*start tag*/
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'start posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){console.log(e);}
								});
								if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
									var res=api_sendmessage_posdvr(posdvrfile);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'success '+posdvrfile,'file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'error sendmessage is not function','file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								/*end tag*/
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'end posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.sysmeg5').on('click','.closesysmeg',function(event){
		//oneEvent(event);
		$('.order#order #billfun #billfun2 .close').prop('disabled',false);
		sysmeg5.dialog('close');
		if($('.order#order .initsetting #controltable').val()=='1'){
			$('.funbox #close').prop('disabled',false);
			$('.funbox #salelist').prop('disabled',false);
			$('.funbox #voidsale').prop('disabled',false);
			if($('.order#order .initsetting #kvm').val()=='1'){
				$('.funbox #kvm').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #moneycost').val()=='1'){
				$('.funbox #AE').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #openpunch').val()=='1'){
				$('.funbox #punch').prop('disabled',false);
				$('.funbox #editpunch').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #historypaper').val()=='1'){
				$('.funbox #historypaper').prop('disabled',false);
			}
			else{
			}
			if($('.order#order .initsetting #openindex').val()=='1'){
				$('.funbox #logout').prop('disabled',false);
			}
			else{
			}
			$('.funbox #updatemenu').prop('disabled',false);
			$('.funbox #view').prop('disabled',false);
			$('.funbox #return').prop('disabled',false);
		}
		else{
		}
	});
	$('.sysmeg5').on('click','.check',function(event){
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/close.ajax.php',
			method:'post',
			async: false,
			data:{'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'close.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				/*}
				else{
				}*/
				//console.log(d);
				if(d=='error'){
					//console.log(d);
				}
				else{
					$.ajax({
						url:'./lib/js/change.class.php',
						method:'post',
						async: false,
						data:{'type':'isopen','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'whopass':'demopos-message5-close.ajax.php'},
						dataType:'html',
						success:function(d){
							//if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'change.class.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							/*}
							else{
							}*/
							//console.log(d);
							$('.order#order #MemberBill #billfun #billfun1button').prop('disabled',true);
							//$billfun.tabs('disable','#billfun1');
							$('.order#order #billfun #billfun2 .outmoney').prop('disabled',true);
							$('.order#order #billfun #billfun2 #salevoid').prop('disabled',true);
							$('.order#order #billfun #billfun2 .open').prop('disabled',false);
							$('.order#order #MemberBill #billfun #billfun2button').trigger('click');
							sysmeg5.dialog('close');
							if($('.order#order .initsetting #controltable').val()=='1'){
								$('.inittable .funcmap #tablesplit').prop('disabled',true);
								$('.inittable .funcmap #combine').prop('disabled',true);
								$('.inittable .funcmap #tablecombine').prop('disabled',true);
								$('.inittable .funcmap #changetable').prop('disabled',true);
								$('.funbox #open').prop('disabled',false);
								$('.funbox #return').prop('disabled',false);
								$('.funbox #printchange').prop('disabled',false);
								funbox.dialog('close');
							}
							else{
							}
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile='';
							}
							else{
							}
							$.ajax({
								url:'./lib/js/shift.paper.php',
								method:'post',
								async: false,
								data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'zcounter':d},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'shift.paper.php '+d},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var tempd=d.split('-');
										posdvrfile=tempd[0];
									}
									else{
									}
									//console.log(d);
									$.ajax({
										url:'./lib/js/create.cmdtxt.php',
										method:'post',
										async: false,
										data:{'cmd':$('.order#order .companydata #terminalnumber').val()+'-upload_'+$('.order#order .companydata #terminalnumber').val()},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
									//2017/12/29var mywin=window.open('cashdrawer://upload','','width=1px,height=1px');
									//2017/12/29mywin.document.title='cashdrawer';
								},
								error:function(e){
									//console.log(e);
								}
							});
							/*錢都錄借接*/
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								/*start tag*/
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'start posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){console.log(e);}
								});
								if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
									var res=api_sendmessage_posdvr(posdvrfile);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'success '+posdvrfile,'file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'error sendmessage is not function','file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								/*end tag*/
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'end posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'ERROR change.class.php '+e},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
					});
				}
			},
			error:function(e){
				//console.log(e);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'ERROR close.ajax.php '+e},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
		});
	});
	$('.order#order #billfun #billfun2').on('click','.open',function(event){
		//oneEvent(event);
		$('.order#order #billfun #billfun2 .open').prop('disabled',true);
		$.ajax({
			url:'./lib/js/open.ajax.php',
			method:'post',
			async: false,
			data:{'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				//if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'open.ajax.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				/*}
				else{
				}*/
				if(d=='error'){
					//console.log(d);
				}
				else{
					var bizdate=d.split('-');
					$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(bizdate[1]);
					$('.order#order #billfun #billfun2 .outmoney').prop('disabled',false);
					$('.order#order #billfun #billfun2 #salevoid').prop('disabled',false);
					$('#outmoney #picbizdate').val(bizdate[1].substr(0,4)+'-'+bizdate[1].substr(4,2)+'-'+bizdate[1].substr(6,2));
					$('#outmoney #picbizdate').trigger('change');
					$('.spend #nowbizdate').val(bizdate[1]);
					$('.spend #nowzcounter').val(bizdate[2]);
					$('.computemoney #sendbox input[name="bizdate"]').val(bizdate[1]);
					$('.computemoney #sendbox input[name="zcounter"]').val(bizdate[2]);
					$.ajax({
						url:'./lib/js/change.class.php',
						method:'post',
						async: false,
						data:{'type':'isclose','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'whopass':'demopos-open.ajax.php'},
						dataType:'html',
						success:function(d){
							var tempdata=d.split('-');
							//if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'change.class.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							/*}
							else{
							}*/
							//console.log(d);
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								//data:{'cmd':$('.order#order .companydata #terminalnumber').val()+'-upload_'+$('.order#order .companydata #terminalnumber').val()},
								data:{'cmd':'report'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							//2017/12/29var mywin=window.open('cashdrawer://upload','','width=1px,height=1px');
							//2017/12/29mywin.document.title='cashdrawer';
							$('.order#order #billfun #billfun2 .close').prop('disabled',false);
							if($('.order#order .initsetting #controltable').val()=='1'){
								$('.control#control #bizdate').val(tempdata[0]);
								$('.control#control #zcounter').val(tempdata[1]);
								$('.inittable .funcmap #tablesplit').prop('disabled',false);
								$('.inittable .funcmap #combine').prop('disabled',false);
								$('.inittable .funcmap #tablecombine').prop('disabled',false);
								$('.inittable .funcmap #changetable').prop('disabled',false);
								var temptitle=inittable.dialog('option','title');
								var temptitle1=temptitle.split(':');
								var temptitle2=temptitle1[1].split('；');
								var temptitle3=temptitle1[2].split('；');
								inittable.dialog('option','title',temptitle1[0]+':'+$('.control#control #bizdate').val()+'；'+temptitle2[1]+':'+$('.control#control #zcounter').val()+'；'+temptitle3[1]);
								$('.funbox #close').prop('disabled',false);
								$('.funbox #salelist').prop('disabled',false);
								$('.funbox #voidsale').prop('disabled',false);
								if($('.order#order .initsetting #kvm').val()=='1'){
									$('.funbox #kvm').prop('disabled',false);
								}
								else{
								}
								$('.funbox #return').prop('disabled',false);
								if($('.order#order .initsetting #moneycost').val()=='1'){
									$('.funbox #AE').prop('disabled',false);
								}
								else{
								}
								if($('.order#order .initsetting #openpunch').val()=='1'){
									$('.funbox #punch').prop('disabled',false);
									$('.funbox #editpunch').prop('disabled',false);
								}
								else{
								}
								if($('.order#order .initsetting #historypaper').val()=='1'){
									$('.funbox #historypaper').prop('disabled',false);
								}
								else{
								}
								if($('.order#order .initsetting #openindex').val()=='1'){
									$('.funbox #logout').prop('disabled',false);
								}
								else{
								}
								$('.funbox #updatemenu').prop('disabled',false);
								$('.funbox #printchange').prop('disabled',false);
							}
							else{
							}
							setchange.dialog('open');
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
		if($('.order#order .initsetting #useinv').val()=='1'){
			$.ajax({
				url:'./lib/js/getinvnumber.ajax.php',
				method:'post',
				astnc:false,
				data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
				dataType:'json',
				success:function(d){
					//console.log(d);
					$('.order#order #detail #invnum').val(d['remaining']);
				},
				error:function(e){
					console.log(e);
				}
			});
		}
		else{
		}
	});
	$('.order#order #billfun #billfun2').on('click','.close',function(event){
		//oneEvent(event);
		$('.order#order #billfun #billfun2 .close').prop('disabled',true);
		$.ajax({
			url:'./lib/js/gettemplist.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'gettemplist.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				if(d=='close'){
					sysmeg5.dialog('open');
					/*$.ajax({
						url:'./lib/js/close.ajax.php',
						method:'post',
						async: false,
						data:{'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'close.ajax.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							if(d=='error'){
								//console.log(d);
							}
							else{
								$.ajax({
									url:'./lib/js/change.class.php',
									method:'post',
									async: false,
									data:{'type':'isopen'},
									dataType:'html',
									success:function(d){
										if(d.length>20||d.match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'change.class.php '+d},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										//console.log(d);
										$('.order#order #MemberBill #billfun #billfun1button').prop('disabled',true);
										//$billfun.tabs('disable','#billfun1');
										$('.order#order #billfun #billfun2 .outmoney').prop('disabled',true);
										$('.order#order #billfun #billfun2 #salevoid').prop('disabled',true);
										$('.order#order #billfun #billfun2 .open').prop('disabled',false);
										$.ajax({
											url:'./lib/js/shift.paper.php',
											method:'post',
											async: false,
											data:{'zcounter':d},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'shift.paper.php '+d},
														dataType:'html',
														success:function(d){
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												//console.log(d);
												$.ajax({
													url:'./lib/js/create.cmdtxt.php',
													method:'post',
													async: false,
													data:{'cmd':'upload'},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												//2017/12/29var mywin=window.open('cashdrawer://upload','','width=1px,height=1px');
												//2017/12/29mywin.document.title='cashdrawer';
											},
											error:function(e){
												//console.log(e);
											}
										});
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
						},
						error:function(e){
							//console.log(e);
						}
					});*/
				}
				else{
					sysmeg4.dialog('open');
				}
			},
			error:function(e){
				//console.log(e);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'ERROR gettemplist.ajax.php '+e},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
		});
		
	});
	$('.order#order #billfun #billfun2').on('click','.outmoney',function(event){
		//oneEvent(event);
		$('.order#order #billfun #billfun2 .outmoney').prop('disabled',true);
		$.ajax({
			url:'./lib/js/checkopen.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'checkopen.ajax.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//console.log(d);
				if(d=='success'){
					outmoney.dialog('open');
					/*if($('#outmoney #moneytype').val()==''){
						selecttype.dialog('open');
					}
					else{
					}*/
				}
				else{
					//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
					$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
					alertmessage.dialog('open');
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
		$('.order#order #billfun #billfun2 .outmoney').prop('disabled',false);
	});
	$('.order#order #billfun #billfun2').on('click','#exit',function(event){
		//oneEvent(event);
		exitsys.dialog('open');
	});
	$('.setchange').on('click','#settingchange',function(event){
		//oneEvent(event);
		setchange.dialog('close');
	});
	$('.order#order #banner #detail').on('click','#oinv',function(event){
		//oneEvent(event);
		if($(this).val()=='ERROR'){
			$.ajax({
				url:'./lib/js/getnowoinv.ajax.php',
				async:false,
				dataType:'html',
				success:function(d){
					$('.oinv #view input[name="en"]').val(d.substr(0,2));
					$('.oinv #view input[name="num"]').val(d.substr(2,8));
					oinv.dialog('open');
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			$('.oinv #view input[name="en"]').val($('.order#order #banner #detail #oinv').val().substr(0,2));
			$('.oinv #view input[name="num"]').val($('.order#order #banner #detail #oinv').val().substr(2,8));
			oinv.dialog('open');
		}
	});
	$('.oinv #buttons').on('click','.input',function(event){
		//oneEvent(event);
		if($('.oinv #buttons input[name="tag"]').val()=='num'&&$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val().length<8){
			$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val($('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val()+$(this).val());
		}
		else if($('.oinv #buttons input[name="tag"]').val()=='en'&&$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val().length<2){
			$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val($('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val()+$(this).val());
		}
		else{
		}
	});
	$('.oinv #buttons').on('click','#back',function(event){
		//oneEvent(event);
		if($('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val().length>1){
			$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val($('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val().substr(0,($('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val().length-1)));
		}
		else if($('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val().length==1){
			$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val('');
		}
		else{
		}
	});
	$('.oinv #buttons').on('click','#ac',function(event){
		//oneEvent(event);
		$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').val('');
	});
	$('.oinv #buttons').on('click','.pre',function(event){
		//oneEvent(event);
		if($('.oinv #buttons .input:eq(0)').val()=='Y'){
			$('.oinv #buttons .input:eq(0)').val('M');
			$('.oinv #buttons .input:eq(1)').val('N');
			$('.oinv #buttons .input:eq(2)').val('O');
			$('.oinv #buttons .input:eq(3)').val('P');
			$('.oinv #buttons .input:eq(4)').val('Q');
			$('.oinv #buttons .input:eq(5)').val('R');
			$('.oinv #buttons .input:eq(6)').val('S');
			$('.oinv #buttons .input:eq(7)').val('T');
			$('.oinv #buttons .input:eq(8)').val('U');
			$('.oinv #buttons .input:eq(9)').val('V');
			$('.oinv #buttons .input:eq(10)').val('W');
			$('.oinv #buttons .input:eq(11)').val('X');
			$('.oinv #buttons .input:eq(2)').prop('disabled',false);
			$('.oinv #buttons .input:eq(3)').prop('disabled',false);
			$('.oinv #buttons .input:eq(4)').prop('disabled',false);
			$('.oinv #buttons .input:eq(5)').prop('disabled',false);
			$('.oinv #buttons .input:eq(6)').prop('disabled',false);
			$('.oinv #buttons .input:eq(7)').prop('disabled',false);
			$('.oinv #buttons .input:eq(8)').prop('disabled',false);
			$('.oinv #buttons .input:eq(9)').prop('disabled',false);
			$('.oinv #buttons .input:eq(10)').prop('disabled',false);
			$('.oinv #buttons .input:eq(11)').prop('disabled',false);
			$('.oinv #buttons .next').prop('disabled',false);
		}
		else if($('.oinv #buttons .input:eq(0)').val()=='M'){
			$('.oinv #buttons .input:eq(0)').val('A');
			$('.oinv #buttons .input:eq(1)').val('B');
			$('.oinv #buttons .input:eq(2)').val('C');
			$('.oinv #buttons .input:eq(3)').val('D');
			$('.oinv #buttons .input:eq(4)').val('E');
			$('.oinv #buttons .input:eq(5)').val('F');
			$('.oinv #buttons .input:eq(6)').val('G');
			$('.oinv #buttons .input:eq(7)').val('H');
			$('.oinv #buttons .input:eq(8)').val('I');
			$('.oinv #buttons .input:eq(9)').val('J');
			$('.oinv #buttons .input:eq(10)').val('K');
			$('.oinv #buttons .input:eq(11)').val('L');
			$('.oinv #buttons .pre').prop('disabled',true);
		}
		else{
		}
	});
	$('.oinv #buttons').on('click','.next',function(event){
		//oneEvent(event);
		if($('.oinv #buttons .input:eq(0)').val()=='A'){
			$('.oinv #buttons .input:eq(0)').val('M');
			$('.oinv #buttons .input:eq(1)').val('N');
			$('.oinv #buttons .input:eq(2)').val('O');
			$('.oinv #buttons .input:eq(3)').val('P');
			$('.oinv #buttons .input:eq(4)').val('Q');
			$('.oinv #buttons .input:eq(5)').val('R');
			$('.oinv #buttons .input:eq(6)').val('S');
			$('.oinv #buttons .input:eq(7)').val('T');
			$('.oinv #buttons .input:eq(8)').val('U');
			$('.oinv #buttons .input:eq(9)').val('V');
			$('.oinv #buttons .input:eq(10)').val('W');
			$('.oinv #buttons .input:eq(11)').val('X');
			$('.oinv #buttons .pre').prop('disabled',false);
		}
		else if($('.oinv #buttons .input:eq(0)').val()=='M'){
			$('.oinv #buttons .input:eq(0)').val('Y');
			$('.oinv #buttons .input:eq(1)').val('Z');
			$('.oinv #buttons .input:eq(2)').val('');
			$('.oinv #buttons .input:eq(3)').val('');
			$('.oinv #buttons .input:eq(4)').val('');
			$('.oinv #buttons .input:eq(5)').val('');
			$('.oinv #buttons .input:eq(6)').val('');
			$('.oinv #buttons .input:eq(7)').val('');
			$('.oinv #buttons .input:eq(8)').val('');
			$('.oinv #buttons .input:eq(9)').val('');
			$('.oinv #buttons .input:eq(10)').val('');
			$('.oinv #buttons .input:eq(11)').val('');
			$('.oinv #buttons .input:eq(2)').prop('disabled',true);
			$('.oinv #buttons .input:eq(3)').prop('disabled',true);
			$('.oinv #buttons .input:eq(4)').prop('disabled',true);
			$('.oinv #buttons .input:eq(5)').prop('disabled',true);
			$('.oinv #buttons .input:eq(6)').prop('disabled',true);
			$('.oinv #buttons .input:eq(7)').prop('disabled',true);
			$('.oinv #buttons .input:eq(8)').prop('disabled',true);
			$('.oinv #buttons .input:eq(9)').prop('disabled',true);
			$('.oinv #buttons .input:eq(10)').prop('disabled',true);
			$('.oinv #buttons .input:eq(11)').prop('disabled',true);
			$('.oinv #buttons .next').prop('disabled',true);
		}
		else{
		}
	});
	$('.oinv #view').on('click','input',function(event){
		//oneEvent(event);
		if($('.oinv #buttons input[name="tag"]').val()==$(this).prop('name')){
		}
		else{
			$('.oinv #buttons input[name="tag"]').val($(this).prop('name'));
			$('.oinv #view input').css({'background-color':'#eeeeee'});
			$('.oinv #view input[name="'+$('.oinv #buttons input[name="tag"]').val()+'"]').css({'background-color':'#ffffff'});
			if($('.oinv #buttons input[name="tag"]').val()=='num'){
				$('.oinv #buttons .input:eq(0)').val('7');
				$('.oinv #buttons .input:eq(1)').val('8');
				$('.oinv #buttons .input:eq(2)').val('9');
				$('.oinv #buttons .input:eq(3)').val('4');
				$('.oinv #buttons .input:eq(4)').val('5');
				$('.oinv #buttons .input:eq(5)').val('6');
				$('.oinv #buttons .input:eq(6)').val('1');
				$('.oinv #buttons .input:eq(7)').val('2');
				$('.oinv #buttons .input:eq(8)').val('3');
				$('.oinv #buttons .input:eq(9)').val('0');
				$('.oinv #buttons .input:eq(10)').val('');
				$('.oinv #buttons .input:eq(11)').val('');
				$('.oinv #buttons .input:eq(2)').prop('disabled',false);
				$('.oinv #buttons .input:eq(3)').prop('disabled',false);
				$('.oinv #buttons .input:eq(4)').prop('disabled',false);
				$('.oinv #buttons .input:eq(5)').prop('disabled',false);
				$('.oinv #buttons .input:eq(6)').prop('disabled',false);
				$('.oinv #buttons .input:eq(7)').prop('disabled',false);
				$('.oinv #buttons .input:eq(8)').prop('disabled',false);
				$('.oinv #buttons .input:eq(9)').prop('disabled',false);
				$('.oinv #buttons .input:eq(10)').prop('disabled',true);
				$('.oinv #buttons .input:eq(11)').prop('disabled',true);
				$('.oinv #buttons .pre').prop('disabled',true);
				$('.oinv #buttons .next').prop('disabled',true);
			}
			else{
				$('.oinv #buttons .input:eq(0)').val('A');
				$('.oinv #buttons .input:eq(1)').val('B');
				$('.oinv #buttons .input:eq(2)').val('C');
				$('.oinv #buttons .input:eq(3)').val('D');
				$('.oinv #buttons .input:eq(4)').val('E');
				$('.oinv #buttons .input:eq(5)').val('F');
				$('.oinv #buttons .input:eq(6)').val('G');
				$('.oinv #buttons .input:eq(7)').val('H');
				$('.oinv #buttons .input:eq(8)').val('I');
				$('.oinv #buttons .input:eq(9)').val('J');
				$('.oinv #buttons .input:eq(10)').val('K');
				$('.oinv #buttons .input:eq(10)').prop('disabled',false);
				$('.oinv #buttons .input:eq(11)').val('L');
				$('.oinv #buttons .input:eq(11)').prop('disabled',false);
				$('.oinv #buttons .next').prop('disabled',false);
			}
		}
	});
	$('.oinv #buttons').on('click','#submit',function(event){
		//oneEvent(event);
		if($('.oinv #view input[name="en"]').val().length<2||$('.oinv #view input[name="num"]').val().length<8){
		}
		else{
			$.ajax({
				url:'./lib/js/setoinv.ajax.php',
				method:'post',
				data:{'en':$('.oinv #view input[name="en"]').val(),'num':$('.oinv #view input[name="num"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'setoinv.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//location.reload();
					//console.log(d);
					if(d.length>0){
						$('.order#order #banner #detail #oinv').val(d);
						oinv.dialog('close');
					}
					else{
						//console.log(d);
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
	});
	$('.oinv #buttons').on('click','#cancel',function(event){
		//oneEvent(event);
		oinv.dialog('close');
	});
	$('.order#order #billfun #billfun3').on('click','#cancelinv',function(event){
		//oneEvent(event);
		cancelinv.dialog('open');
	});
	$('.cancelinv #buttons').on('click','.input',function(event){
		//oneEvent(event);
		if($('.cancelinv #buttons input[name="tag"]').val()=='num'&&$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val().length<8){
			$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val($('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val()+$(this).val());
		}
		else if($('.cancelinv #buttons input[name="tag"]').val()=='en'&&$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val().length<2){
			$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val($('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val()+$(this).val());
		}
		else{
		}
	});
	$('.cancelinv #buttons').on('click','#back',function(event){
		//oneEvent(event);
		if($('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val().length>1){
			$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val($('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val().substr(0,($('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val().length-1)));
		}
		else if($('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val().length==1){
			$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val('');
		}
		else{
		}
	});
	$('.cancelinv #buttons').on('click','#ac',function(event){
		//oneEvent(event);
		$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').val('');
	});
	$('.cancelinv #buttons').on('click','.pre',function(event){
		//oneEvent(event);
		if($('.cancelinv #buttons .input:eq(0)').val()=='Y'){
			$('.cancelinv #buttons .input:eq(0)').val('M');
			$('.cancelinv #buttons .input:eq(1)').val('N');
			$('.cancelinv #buttons .input:eq(2)').val('O');
			$('.cancelinv #buttons .input:eq(3)').val('P');
			$('.cancelinv #buttons .input:eq(4)').val('Q');
			$('.cancelinv #buttons .input:eq(5)').val('R');
			$('.cancelinv #buttons .input:eq(6)').val('S');
			$('.cancelinv #buttons .input:eq(7)').val('T');
			$('.cancelinv #buttons .input:eq(8)').val('U');
			$('.cancelinv #buttons .input:eq(9)').val('V');
			$('.cancelinv #buttons .input:eq(10)').val('W');
			$('.cancelinv #buttons .input:eq(11)').val('X');
			$('.cancelinv #buttons .input:eq(2)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(3)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(4)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(5)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(6)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(7)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(8)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(9)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(10)').prop('disabled',false);
			$('.cancelinv #buttons .input:eq(11)').prop('disabled',false);
			$('.cancelinv #buttons .next').prop('disabled',false);
		}
		else if($('.cancelinv #buttons .input:eq(0)').val()=='M'){
			$('.cancelinv #buttons .input:eq(0)').val('A');
			$('.cancelinv #buttons .input:eq(1)').val('B');
			$('.cancelinv #buttons .input:eq(2)').val('C');
			$('.cancelinv #buttons .input:eq(3)').val('D');
			$('.cancelinv #buttons .input:eq(4)').val('E');
			$('.cancelinv #buttons .input:eq(5)').val('F');
			$('.cancelinv #buttons .input:eq(6)').val('G');
			$('.cancelinv #buttons .input:eq(7)').val('H');
			$('.cancelinv #buttons .input:eq(8)').val('I');
			$('.cancelinv #buttons .input:eq(9)').val('J');
			$('.cancelinv #buttons .input:eq(10)').val('K');
			$('.cancelinv #buttons .input:eq(11)').val('L');
			$('.cancelinv #buttons .pre').prop('disabled',true);
		}
		else{
		}
	});
	$('.cancelinv #buttons').on('click','.next',function(event){
		//oneEvent(event);
		if($('.cancelinv #buttons .input:eq(0)').val()=='A'){
			$('.cancelinv #buttons .input:eq(0)').val('M');
			$('.cancelinv #buttons .input:eq(1)').val('N');
			$('.cancelinv #buttons .input:eq(2)').val('O');
			$('.cancelinv #buttons .input:eq(3)').val('P');
			$('.cancelinv #buttons .input:eq(4)').val('Q');
			$('.cancelinv #buttons .input:eq(5)').val('R');
			$('.cancelinv #buttons .input:eq(6)').val('S');
			$('.cancelinv #buttons .input:eq(7)').val('T');
			$('.cancelinv #buttons .input:eq(8)').val('U');
			$('.cancelinv #buttons .input:eq(9)').val('V');
			$('.cancelinv #buttons .input:eq(10)').val('W');
			$('.cancelinv #buttons .input:eq(11)').val('X');
			$('.cancelinv #buttons .pre').prop('disabled',false);
		}
		else if($('.cancelinv #buttons .input:eq(0)').val()=='M'){
			$('.cancelinv #buttons .input:eq(0)').val('Y');
			$('.cancelinv #buttons .input:eq(1)').val('Z');
			$('.cancelinv #buttons .input:eq(2)').val('');
			$('.cancelinv #buttons .input:eq(3)').val('');
			$('.cancelinv #buttons .input:eq(4)').val('');
			$('.cancelinv #buttons .input:eq(5)').val('');
			$('.cancelinv #buttons .input:eq(6)').val('');
			$('.cancelinv #buttons .input:eq(7)').val('');
			$('.cancelinv #buttons .input:eq(8)').val('');
			$('.cancelinv #buttons .input:eq(9)').val('');
			$('.cancelinv #buttons .input:eq(10)').val('');
			$('.cancelinv #buttons .input:eq(11)').val('');
			$('.cancelinv #buttons .input:eq(2)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(3)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(4)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(5)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(6)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(7)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(8)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(9)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(10)').prop('disabled',true);
			$('.cancelinv #buttons .input:eq(11)').prop('disabled',true);
			$('.cancelinv #buttons .next').prop('disabled',true);
		}
		else{
		}
	});
	$('.cancelinv #view').on('click','input',function(event){
		//oneEvent(event);
		if($('.cancelinv #buttons input[name="tag"]').val()==$(this).prop('name')){
		}
		else{
			$('.cancelinv #buttons input[name="tag"]').val($(this).prop('name'));
			$('.cancelinv #view input').css({'background-color':'#eeeeee'});
			$('.cancelinv #view input[name="'+$('.cancelinv #buttons input[name="tag"]').val()+'"]').css({'background-color':'#ffffff'});
			if($('.cancelinv #buttons input[name="tag"]').val()=='num'){
				$('.cancelinv #buttons .input:eq(0)').val('7');
				$('.cancelinv #buttons .input:eq(1)').val('8');
				$('.cancelinv #buttons .input:eq(2)').val('9');
				$('.cancelinv #buttons .input:eq(3)').val('4');
				$('.cancelinv #buttons .input:eq(4)').val('5');
				$('.cancelinv #buttons .input:eq(5)').val('6');
				$('.cancelinv #buttons .input:eq(6)').val('1');
				$('.cancelinv #buttons .input:eq(7)').val('2');
				$('.cancelinv #buttons .input:eq(8)').val('3');
				$('.cancelinv #buttons .input:eq(9)').val('0');
				$('.cancelinv #buttons .input:eq(10)').val('');
				$('.cancelinv #buttons .input:eq(11)').val('');
				$('.cancelinv #buttons .input:eq(2)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(3)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(4)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(5)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(6)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(7)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(8)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(9)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(10)').prop('disabled',true);
				$('.cancelinv #buttons .input:eq(11)').prop('disabled',true);
				$('.cancelinv #buttons .pre').prop('disabled',true);
				$('.cancelinv #buttons .next').prop('disabled',true);
			}
			else{
				$('.cancelinv #buttons .input:eq(0)').val('A');
				$('.cancelinv #buttons .input:eq(1)').val('B');
				$('.cancelinv #buttons .input:eq(2)').val('C');
				$('.cancelinv #buttons .input:eq(3)').val('D');
				$('.cancelinv #buttons .input:eq(4)').val('E');
				$('.cancelinv #buttons .input:eq(5)').val('F');
				$('.cancelinv #buttons .input:eq(6)').val('G');
				$('.cancelinv #buttons .input:eq(7)').val('H');
				$('.cancelinv #buttons .input:eq(8)').val('I');
				$('.cancelinv #buttons .input:eq(9)').val('J');
				$('.cancelinv #buttons .input:eq(10)').val('K');
				$('.cancelinv #buttons .input:eq(10)').prop('disabled',false);
				$('.cancelinv #buttons .input:eq(11)').val('L');
				$('.cancelinv #buttons .input:eq(11)').prop('disabled',false);
				$('.cancelinv #buttons .next').prop('disabled',false);
			}
		}
	});
	$('.cancelinv #buttons').on('click','#submit',function(event){
		//oneEvent(event);
		if($('.cancelinv #view input[name="en"]').val().length<2||$('.cancelinv #view input[name="num"]').val().length<8){
		}
		else{
			$.ajax({
				url:'./lib/js/cancelinv.ajax.php',
				method:'post',
				data:{'en':$('.cancelinv #view input[name="en"]').val(),'num':$('.cancelinv #view input[name="num"]').val(),'invtype':$('.cancelinv #view input[name="invtype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'cancelinv.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//location.reload();
					//console.log(d);
					if(d.length>0){
						$('.order#order #banner #detail #oinv').val(d);
						oinv.dialog('close');
					}
					else{
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
	});
	$('.cancelinv #buttons').on('click','#cancel',function(event){
		//oneEvent(event);
		cancelinv.dialog('close');
	});
	$('.order#order #billfun #billfun2').on('click','#salelist',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單','click');
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/get.bizdate.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.salelist .viewbizdate').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		salelist.dialog('open');
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'sale':'sale','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.salelist #salelist #salecontent').html(d);
				$('.salelist #rightnow #ttmoney').html($('.salelist #salelist input[name="ttmoney"]').val());
				$('.salelist #rightnow #ttcount').html($('.salelist #salelist input[name="ttcount"]').val());
				$('.salelist #rightnow #voidmoney').html($('.salelist #salelist input[name="voidmoney"]').val());
				$('.salelist #rightnow #voidcount').html($('.salelist #salelist input[name="voidcount"]').val());
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.salelist #salelist #salecontent').on('click','.listitems',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單選擇帳單清單','click');
		//oneEvent(event);
		var index=$('.salelist #salelist #salecontent .listitems').index(this);
		$('.salelist #salelist #salecontent .listitems').prop('id','');
		$('.salelist #salelist #salecontent .listitems:eq('+index+')').prop('id','focus');
		$('.salelist #listno').html($('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(1)').html()+"("+$('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(1) input[name="consecnumber"]').val()+")");
		$('.salelist #date').html($('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html());
		////////////
		$('.salelist #credate').val($('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(9)').html().substr(0,8));
		if($('.order#order #MemberBill #billfun #citybox #billfun2 .open').prop('disabled')){//開班狀態
			if($('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(10)').html()=='Y'){
				$('.salelist #reorder').prop('disabled',true);
				$('.salelist #editpay').prop('disabled',true);
				$('.salelist #reinv').prop('disabled',true);
				$('.salelist #rekvm').prop('disabled',true);
			}
			else{
				$('.salelist #reorder').prop('disabled',false);
				$('.salelist #editpay').prop('disabled',false);
				if($.trim($('.salelist #salecontent .listitems:eq('+index+') div:eq(3)').html()).length!=10||$('.order#order .initsetting #useinv').val()=='0'){
					$('.salelist #reinv').prop('disabled',true);
				}
				else{
					$('.salelist #reinv').prop('disabled',false);
				}
				$('.salelist #rekvm').prop('disabled',false);
			}
		}
		else{//未開班狀態
			$('.salelist #reorder').prop('disabled',true);
			$('.salelist #editpay').prop('disabled',true);
			$('.salelist #reinv').prop('disabled',true);
			$('.salelist #rekvm').prop('disabled',true);
		}
		$.ajax({
			url:'./lib/js/getsaledetail.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'bizdate':$('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html(),'no':$('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(1) input[name="consecnumber"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.salelist #list #listcontent').html(d);
				if($('.salelist #salelist #salecontent .listitems:eq('+index+') div:eq(10)').html()=="Y"){
					$('.salelist #fun #tag').prop('disabled',true);
					$('.salelist #fun #forall').prop('disabled',true);
					$('.salelist #fun #kitchen').prop('disabled',true);
					$('.salelist #fun #changecheck').prop('disabled',true);
				}
				else{
					$('.salelist #fun #tag').prop('disabled',false);
					$('.salelist #fun #forall').prop('disabled',false);
					$('.salelist #fun #kitchen').prop('disabled',false);
					$('.salelist #fun #changecheck').prop('disabled',false);
				}
				$('.salelist #fun button#list').prop('disabled',false);
				//$('.salelist #fun #kitchen').prop('disabled',false);
				
			},
			error:function(e){
				//console.log(e);
			}
		});
		
		if($('.salelist #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val()!=''&&$('.salelist #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val()!=null){
			var memtel=$('.salelist #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val().split(';-;');
			/*if(memtel.length>1){//具有會員
				memtel=tempmemtel[0];
			}
			else{
				memtel=tempmemtel[0];
			}*/
			if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
				if(memtel[0]!=''){//2020/5/18 if($('.order#order #tabs4 .listcontentbox input[name="memno"]').val()!=''){ memno檢查不應該在這裡
					$.ajax({
						url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php',
						method:'post',
						async:false,
						data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','memno':memtel[0],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
						dataType:'json',
						success:function(d){
							//console.log(d);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online success)'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
							if(d=="查無資料庫。"){
								$('.salelist #membername').html('');
								$('.salelist #membertel').html('');
							}
							else if(d.length==0){
								$('.salelist #membername').html('');
								$('.salelist #membertel').html('');
							}
							else{
								$('.salelist #membername').html(d[0]['name']);
								$('.salelist #membertel').html(d[0]['tel']);
							}
						},
						error:function(e){
							//console.log(e);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online error) '+e},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
					});
				}
				else{
					$('.salelist #membername').html('');
					$('.salelist #membertel').html('');
				}
			}
			else{//本地會員
				$.ajax({
					url:'../memberapi/getmemdata.ajax.php',
					method:'post',
					async:false,
					data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','memno':memtel[0],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/getmemdata.ajax.php(offline success)'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(d=="查無資料庫。"){
							$('.salelist #membername').html('');
							$('.salelist #membertel').html('');
						}
						else if(d.length==0){
							$('.salelist #membername').html('');
							$('.salelist #membertel').html('');
						}
						else{
							$('.salelist #membername').html(d[0]['name']);
							$('.salelist #membertel').html(d[0]['tel']);
						}
					},
					error:function(e){
						//console.log(e);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/getmemdata.ajax.php(offline error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
				});
			}
		}
		else{
			$('.salelist #membername').html('');
			$('.salelist #membertel').html('');
		}
	});
	$('.salelist').on('click','#reinv',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單重印發票','click');
		//oneEvent(event);
		if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())==''){
		}
		else{
			$('.verpsw input[name="type"]').val('reinv');
			verpsw.dialog('open');
			/*$.ajax({
				url:'./lib/js/reinv.ajax.php',
				method:'post',
				async:false,
				data:{'invno',$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(2)').html())},
				dataType:'html',
				success:function(d){
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		}
	});
	$('.verpsw').on('click','#cancel',function(event){
		//oneEvent(event);
		verpsw.dialog('close');
	});
	$('.verpsw').on('click','#send',function(event){
		//oneEvent(event);
		if((($('.verpsw input[name="type"]').val()=='reinv'||$('.verpsw input[name="type"]').val()=='editlist'||$('.verpsw input[name="type"]').val()=='void'||$('.verpsw input[name="type"]').val()=='viewvoid'||$('.verpsw input[name="type"]').val()=='viewvoidbyemptylist'||$('.verpsw input[name="type"]').val()=='voidbyinv'||$('.verpsw input[name="type"]').val()=='editpay'||$('.verpsw input[name="type"]').val()=='printedvoid')&&typeof $('.order#order .companydata #voidpw').val()!=="undefined"&&$('.order#order .companydata #voidpw').val()=='')||(($('.verpsw input[name="type"]').val()=='paper'||$('.verpsw input[name="type"]').val()=='viewpaper')&&typeof $('.order#order .companydata #paperpw').val()!=="undefined"&&$('.order#order .companydata #paperpw').val()=='')||($('.verpsw input[name="type"]').val()=='editpunch'&&typeof $('.order#order .companydata #punchpw').val()!=="undefined"&&$('.order#order .companydata #punchpw').val()=='')||(($('.verpsw input[name="type"]').val()=='sale_reprint_all'||$('.verpsw input[name="type"]').val()=='tempsale_reprint_all')&&typeof $('.order#order .companydata #reprintpw').val()!=="undefined"&&$('.order#order .companydata #reprintpw').val()=='')){
			$('.verpsw input[name="verpsw"]').val('');
			//alertmessage('目前登入帳號，無使用此功能之權限。');
			//verpsw.dialog('close');
			$('.alertmessage #text').html('目前登入帳號，無使用此功能之權限。');
			alertmessage.dialog('open');
		}
		else if(($('.verpsw input[name="type"]').val()=='reinv'||$('.verpsw input[name="type"]').val()=='editlist'||$('.verpsw input[name="type"]').val()=='void'||$('.verpsw input[name="type"]').val()=='viewvoid'||$('.verpsw input[name="type"]').val()=='viewvoidbyemptylist'||$('.verpsw input[name="type"]').val()=='voidbyinv'||$('.verpsw input[name="type"]').val()=='editpay'||$('.verpsw input[name="type"]').val()=='printedvoid')&&typeof $('.order#order .companydata #voidpw').val()!=="undefined"&&$('.order#order .companydata #voidpw').val()==$('.verpsw input[name="verpsw"]').val()){
			if($('.verpsw input[name="type"]').val()=='reinv'){//補印發票
				$.ajax({
					url:'./lib/js/getinvname.ajax.php',
					method:'post',
					async:false,
					data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(d=='dbempty'){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'reinv getinvname.ajax.php dbempty'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							$.ajax({
								url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
								method:'post',
								async:false,
								data:{'invfile':d[1]},
								dataType:'html',
								success:function(d){
									//console.log(d);
									$.ajax({
										url:'./lib/js/reinv.ajax.php',
										method:'post',
										async:false,
										data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
										dataType:'html',
										success:function(d){
											//console.log(d);
											if(d.length>20||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'creditcard reinv.ajax.php '+d},
													dataType:'html',
													success:function(d){/*console.log(d);*/},
													error:function(e){/*console.log(e);*/}
												});
											}
											else{
											}
											if(d=='success'){
												//alertmessage('發票補印完成。');
												$('.alertmessage #text').html('發票補印完成。');
												alertmessage.dialog('open');
												verpsw.dialog('close');
											}
											else if(d=='dataempty'){
												//alertmessage('查無資料，請確認輸入正確。');
												$('.alertmessage #text').html('查無資料，請確認輸入正確。');
												alertmessage.dialog('open');
											}
											else if(d=='dbempty'){
												//alertmessage('資料庫錯誤。');
												$('.alertmessage #text').html('資料庫錯誤。');
												alertmessage.dialog('open');
											}
											else{
												//alertmessage(d);
												$('.alertmessage #text').html(d);
												alertmessage.dialog('open');
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else if($('.verpsw input[name="type"]').val()=='editlist'){//修改帳單
				var voidbizdate=$('.salelist #date').html();
				var voidconsecnumber=$('.salelist #listno input[name="consecnumber"]').val();
				$.ajax({
					url:'./lib/js/checkopen.ajax.php',
					method:'post',
					async:false,
					data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard checkopen.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
						if(d=='success'){
							var nowbizdate=$('.salelist #date').html();
							if($('.salelist #date').html()!=''){
								var listtype='';
								var tabnum='';
								var consecnumber='';
								var check=0;
								//2022/10/6 加上街口支付//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
								if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
									//console.log('void inv');
									var hint=confirm('該帳單已開發票，如要修改請確認發票正本已收回。');
									if(hint==true){
										if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
											$.ajax({
												url:'./lib/api/intella/check.intellapay.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithintellapay input[name="type"]').val('editlist');
														$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
														$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
														$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
														voidsalewithintellapay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
											$.ajax({
												url:'./lib/api/directlinepay/check.linepay.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithlinepay input[name="type"]').val('editlist');
														$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
														$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
														voidsalewithlinepay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款
											$.ajax({
												url:'./lib/api/jkos/check.jkos.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														var datetime=new Date();
														var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
														$('.voidsalewithjkospay input[name="type"]').val('editlist');
														$('.voidsalewithjkospay input[name="saleno"]').val(orderid);
														$('.voidsalewithjkospay input[name="tradeno"]').val(d['tradeno']);
														$('.voidsalewithjkospay input[name="money"]').val(d['paymoney']);
														voidsalewithjkospay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
											$.ajax({
												url:'./lib/api/pxpayplus/check.pxpayplus.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithpxpaypluspay input[name="type"]').val('editlist');
														$('.voidsalewithpxpaypluspay input[name="orderid"]').val('');
														$('.voidsalewithpxpaypluspay input[name="saleno"]').val(d['saleno']);
														$('.voidsalewithpxpaypluspay input[name="tradeno"]').val(d['tradeno']);
														$('.voidsalewithpxpaypluspay input[name="money"]').val(d['paymoney']);
														//2022/11/7 產生產品明細json
														$('.order#order .pxpayplus #item_json').val(d['itemjson']);
														voidsalewithpxpaypluspay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
											$.ajax({
												url:'./lib/api/nccc/check.nccc.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithnccc input[name="type"]').val('editlist');
														$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
														$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
														voidsalewithnccc.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0){//沒有使用API串接付款
											if($('.nidin #usenidin').length>0){
												nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
											}
											else{
											}
											$.ajax({//作廢帳單
												url:'./lib/js/salevoid.ajax.php',
												method:'post',
												data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
												dataType:'html',
												success:function(d){
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'creditcard salevoid.ajax.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
													}
													if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
														var memtype='online';
													}
													else{
														var memtype='offline';
													}
													var memberapi='';
													$.ajax({
														url:'./lib/js/searchmember.pointmoney.ajax.php',
														method:'post',
														async:false,
														data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
														dataType:'json',
														success:function(d){
															//console.log(d);
															if(d[0].length==0){
															}
															else{
																if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
																	if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																		memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
																		if(memberapi[0]['state']=='success'){
																			$.ajax({
																				url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
																				method:'post',
																				async:false,
																				data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																				dataType:'html',
																				success:function(d){
																					//console.log(d);
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																						dataType:'html',
																						success:function(d){/*console.log(d);*/},
																						error:function(e){/*console.log(e);*/}
																					});
																				},
																				error:function(e){
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																						dataType:'html',
																						success:function(d){
																							//console.log(d);
																						},
																						error:function(e){
																							//console.log(e);
																						}
																					});
																					//console.log(e);
																				}
																			});
																		}
																		else{
																		}
																		$.ajax({
																			url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
																			method:'post',
																			async:false,
																			data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			},
																			error:function(e){
																				//if(d.length>40||d.match('ERROR HINT: ')){
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																				/*}
																				else{
																				}*/
																				//console.log(e);
																			}
																		});
																	}
																	else{
																	}
																}
																else{//本地會員
																	if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																		$.ajax({
																			url:'../memberapi/point_money.ajax.php',
																			method:'post',
																			async:false,
																			data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
																			dataType:'json',
																			timeout:5000,
																			success:function(d){
																				memberapi=d;
																				//console.log(res);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			},
																			error:function(e,t){
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																				if(t==="timeout"){
																					memberapi=[{"state":"fail","message":"AJAX timeout"}];
																				}
																				else{
																					memberapi=e;
																				}
																			}
																		});
																		//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
																		if(memberapi[0]['state']=='success'){
																			$.ajax({
																				url:'../memberapi/change.memberdata.php',
																				method:'post',
																				async:false,
																				data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																				dataType:'html',
																				success:function(d){
																					//console.log(d);
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																						dataType:'html',
																						success:function(d){/*console.log(d);*/},
																						error:function(e){/*console.log(e);*/}
																					});
																				},
																				error:function(e){
																					//console.log(e);
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																						dataType:'html',
																						success:function(d){/*console.log(d);*/},
																						error:function(e){/*console.log(e);*/}
																					});
																				}
																			});
																		}
																		else{
																		}
																		$.ajax({
																			url:'../memberapi/insertmemlist.ajax.php',
																			method:'post',
																			async:false,
																			data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			},
																			error:function(e){
																				//console.log(e);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			}
																		});
																	}
																	else{
																	}
																}
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
													if(d.substr(0,7)=='success'){
														$.ajax({
															url:'./lib/js/getinvname.ajax.php',
															method:'post',
															async:false,
															data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'json',
															success:function(d){
																//console.log(d);
																if(d=='dbempty'){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard getinvname.ajax.php dbempty'},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																	$.ajax({
																		url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
																		method:'post',
																		async:false,
																		data:{'invfile':d[1]},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重新產生C0401 //2020/10/12/週一 使用電子發票
																				$.ajax({
																					url:'./lib/js/reinv.ajax.php',
																					method:'post',
																					async:false,
																					data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
																					dataType:'html',
																					success:function(d){
																						//console.log(d);
																						if(d.length>20||d.match('ERROR HINT: ')){
																							$.ajax({
																								url:'./lib/js/print.php',
																								method:'post',
																								data:{'html':'creditcard reinv.ajax.php '+d},
																								dataType:'html',
																								success:function(d){/*console.log(d);*/},
																								error:function(e){/*console.log(e);*/}
																							});
																						}
																						else{
																						}
																					},
																					error:function(e){
																						//console.log(e);
																					}
																				});
																			}
																			else{
																			}
																			$.ajax({//作廢發票
																				url:'./lib/js/deleteinv.ajax.php',
																				method:'post',
																				data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
																				dataType:'html',
																				success:function(d){
																					if(d.length>40||d.match('ERROR HINT: ')){
																						$.ajax({
																							url:'./lib/js/print.php',
																							method:'post',
																							data:{'html':'creditcard deleteinv.ajax.php '+d},
																							dataType:'html',
																							success:function(d){/*console.log(d);*/},
																							error:function(e){/*console.log(e);*/}
																						});
																					}
																					else{
																					}
																					//console.log(d);
																					//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																					//2017/12/29mywin.document.title='cashdrawer';
																				},
																				error:function(e){
																					//console.log(e);
																				}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																		}
																	});
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
														//console.log(d);
													}
													$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
														url:'./lib/js/copysale.ajax.php',
														method:'post',
														data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
														dataType:'html',
														success:function(d){
															if(d.length>30||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard copysale.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															var t=d.split('-');
															//console.log(t);
															listtype=t[t.length-3];
															bizdate=t[t.length-2];
															consecnumber=t[t.length-1];
															//console.log(d);

															temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
															//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
															verpsw.dialog('close');
															$('.salelist #editpay').prop('disabled',true);
															$('.salelist #reorder').prop('disabled',true);
															$('.salelist #reinv').prop('disabled',true);
															$('.salelist #rekvm').prop('disabled',true);
															$('.salelist #salelist #salecontent .listitems').prop('id','');
															$('.salelist #listno').html('');
															$('.salelist #list #listcontent').html('');
															$('.salelist #date').html('');
															$('.salelist #credate').html('');
															$('.salelist #fun button#forall').prop('disabled',true);
															$('.salelist #fun button#list').prop('disabled',true);
															$('.salelist #fun button#tag').prop('disabled',true);
															$('.salelist #fun button#kitchen').prop('disabled',true);
															$('.salelist #fun button#changecheck').prop('disabled',true);
															salelist.dialog('close');
															if($('.funbox').length>0&&funbox.dialog('isOpen')){
																funbox.dialog('close');
																inittable.dialog('close');
															}
															else{
																//console.log('e1');
															}
															if(!$('.order#order #billfun #billfun1button').prop('disabled')){
																$('.order#order #billfun #billfun1button').trigger('click');
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{//使用API串接付款，須先進行退款
										}
									}
									else{
									}
								}
								else{
									if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
										$.ajax({
											url:'./lib/api/intella/check.intellapay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithintellapay input[name="type"]').val('editlist');
													$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
													$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
													$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
													voidsalewithintellapay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
										$.ajax({
											url:'./lib/api/directlinepay/check.linepay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithlinepay input[name="type"]').val('editlist');
													$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
													$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
													voidsalewithlinepay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #jkos').val()=='1'){//2022/5/5 串接街口支付付款
										$.ajax({
											url:'./lib/api/jkos/check.jkos.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													var datetime=new Date();
													var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
													$('.voidsalewithjkospay input[name="type"]').val('editlist');
													$('.voidsalewithjkospay input[name="saleno"]').val(orderid);
													$('.voidsalewithjkospay input[name="tradeno"]').val(d['tradeno']);
													$('.voidsalewithjkospay input[name="money"]').val(d['paymoney']);
													voidsalewithjkospay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
										$.ajax({
											url:'./lib/api/pxpayplus/check.pxpayplus.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithpxpaypluspay input[name="type"]').val('editlist');
													$('.voidsalewithpxpaypluspay input[name="orderid"]').val('');
													$('.voidsalewithpxpaypluspay input[name="saleno"]').val(d['saleno']);
													$('.voidsalewithpxpaypluspay input[name="tradeno"]').val(d['tradeno']);
													$('.voidsalewithpxpaypluspay input[name="money"]').val(d['paymoney']);
													//2022/11/7 產生產品明細json
													$('.order#order .pxpayplus #item_json').val(d['itemjson']);
													voidsalewithpxpaypluspay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
										$.ajax({
											url:'./lib/api/nccc/check.nccc.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithnccc input[name="type"]').val('editlist');
													$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
													$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
													voidsalewithnccc.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0){//沒有使用API串接付款
										if($('.nidin #usenidin').length>0){
											nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
										}
										else{
										}
										$.ajax({//作廢帳單
											url:'./lib/js/salevoid.ajax.php',
											method:'post',
											data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'creditcard salevoid.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
													var memtype='online';
												}
												else{
													var memtype='offline';
												}
												var memberapi='';
												$.ajax({
													url:'./lib/js/searchmember.pointmoney.ajax.php',
													method:'post',
													async:false,
													data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
													dataType:'json',
													success:function(d){
														//console.log(d);
														if(d[0].length==0){
														}
														else{
															if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
																if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																	memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
																	if(memberapi[0]['state']=='success'){
																		$.ajax({
																			url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
																			method:'post',
																			async:false,
																			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			},
																			error:function(e){
																				//console.log(e);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			}
																		});
																	}
																	else{
																	}
																	$.ajax({
																		url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
																		method:'post',
																		async:false,
																		data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		}
																	});
																}
																else{
																}
															}
															else{//本地會員
																if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																	$.ajax({
																		url:'../memberapi/point_money.ajax.php',
																		method:'post',
																		async:false,
																		data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
																		dataType:'json',
																		timeout:5000,
																		success:function(d){
																			memberapi=d;
																			//console.log(res);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		},
																		error:function(e,t){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																			if(t==="timeout"){
																				memberapi=[{"state":"fail","message":"AJAX timeout"}];
																			}
																			else{
																				memberapi=e;
																			}
																		}
																	});
																	//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
																	if(memberapi[0]['state']=='success'){
																		$.ajax({
																			url:'../memberapi/change.memberdata.php',
																			method:'post',
																			async:false,
																			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			},
																			error:function(e){
																				//console.log(e);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			}
																		});
																	}
																	else{
																	}
																	$.ajax({
																		url:'../memberapi/insertmemlist.ajax.php',
																		method:'post',
																		async:false,
																		data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		}
																	});
																}
																else{
																}
															}
														}
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
													url:'./lib/js/copysale.ajax.php',
													method:'post',
													data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
													dataType:'html',
													success:function(d){
														if(d.length>30||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'creditcard copysale.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														var t=d.split('-');
														//console.log(t);
														listtype=t[t.length-3];
														bizdate=t[t.length-2];
														consecnumber=t[t.length-1];
														//console.log(d);

														temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
														//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
														verpsw.dialog('close');
														$('.salelist #editpay').prop('disabled',true);
														$('.salelist #reorder').prop('disabled',true);
														$('.salelist #reinv').prop('disabled',true);
														$('.salelist #rekvm').prop('disabled',true);
														$('.salelist #salelist #salecontent .listitems').prop('id','');
														$('.salelist #listno').html('');
														$('.salelist #list #listcontent').html('');
														$('.salelist #date').html('');
														$('.salelist #credate').html('');
														$('.salelist #fun button#forall').prop('disabled',true);
														$('.salelist #fun button#list').prop('disabled',true);
														$('.salelist #fun button#tag').prop('disabled',true);
														$('.salelist #fun button#kitchen').prop('disabled',true);
														$('.salelist #fun button#changecheck').prop('disabled',true);
														salelist.dialog('close');
														if($('.funbox').length>0&&funbox.dialog('isOpen')){
															funbox.dialog('close');
															inittable.dialog('close');
														}
														else{
																//console.log('e2');
														}
														if(!$('.order#order #billfun #billfun1button').prop('disabled')){
															$('.order#order #billfun #billfun1button').trigger('click');
														}
														else{
														}
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{//使用API串接付款，須先進行退款
									}
								}
							}
							else{
							}
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':nowbizdate.substr(0,6)+'-change'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
							//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
							$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
							alertmessage.dialog('open');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				
				//2020/5/25 貌似沒有幫助
				/*if(membercheck==''||(typeof membercheck[0]!=="undefined"&&typeof membercheck[0]['state']!=="undefined"&&membercheck[0]['state']=='success')){//本地會員或網路會員伺服器連線成功
				}
				else{
					return;
				}*/

				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
			}
			else if($('.verpsw input[name="type"]').val()=='void'){//作廢帳單
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				var check=0;
				//2022/10/6 加上街口支付//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
				if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
					$.ajax({
						url:'./lib/api/intella/check.intellapay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithintellapay input[name="type"]').val('void');
								$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
								$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
								$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
								voidsalewithintellapay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
					$.ajax({
						url:'./lib/api/directlinepay/check.linepay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithlinepay input[name="type"]').val('void');
								$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
								$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
								voidsalewithlinepay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款
					$.ajax({
						url:'./lib/api/jkos/check.jkos.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								var datetime=new Date();
								var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
								$('.voidsalewithjkospay input[name="type"]').val('void');
								$('.voidsalewithjkospay input[name="saleno"]').val(orderid);
								$('.voidsalewithjkospay input[name="tradeno"]').val(d['tradeno']);
								$('.voidsalewithjkospay input[name="money"]').val(d['paymoney']);
								voidsalewithjkospay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
					$.ajax({
						url:'./lib/api/pxpayplus/check.pxpayplus.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithpxpaypluspay input[name="type"]').val('void');
								$('.voidsalewithpxpaypluspay input[name="orderid"]').val('');
								$('.voidsalewithpxpaypluspay input[name="saleno"]').val(d['saleno']);
								$('.voidsalewithpxpaypluspay input[name="tradeno"]').val(d['tradeno']);
								$('.voidsalewithpxpaypluspay input[name="money"]').val(d['paymoney']);
								//2022/11/7 產生產品明細json
								$('.order#order .pxpayplus #item_json').val(d['itemjson']);
								voidsalewithpxpaypluspay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
					$.ajax({
						url:'./lib/api/nccc/check.nccc.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithnccc input[name="type"]').val('void');
								$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
								$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
								voidsalewithnccc.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0){//沒有使用API串接付款
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							var temp=d.split('-');
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(temp[0]=='success'){
								if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
									var memtype='online';
								}
								else{
									var memtype='offline';
								}
								var memberapi='';
								$.ajax({
									url:'./lib/js/searchmember.pointmoney.ajax.php',
									method:'post',
									async:false,
									data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d[0].length==0){
										}
										else{
											if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
											}
											else{
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													$.ajax({
														url:'../memberapi/point_money.ajax.php',
														method:'post',
														async:false,
														data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
														dataType:'json',
														timeout:5000,
														success:function(d){
															memberapi=d;
															//console.log(res);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e,t){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
															if(t==="timeout"){
																memberapi=[{"state":"fail","message":"AJAX timeout"}];
															}
															else{
																memberapi=e;
															}
														}
													});
													//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'../memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'../memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
											}
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/4mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.order#order #billfun #billfun2 #salevoid').trigger('click');
								$('.salevoid #listno').html('');
								$('.salevoid #list #listcontent').html('');
								$('.salevoid #date').html('');
								$('.salevoid #credate').html('');
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=temp[1];
								}
								else{
								}
							}
							else{
								//console.log(d);
							}
							verpsw.dialog('close');
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':nowbizdate.substr(0,6)+'-change'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					/*錢都錄借接*/
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						/*start tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){console.log(e);}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						/*end tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					/*集點樹收點流程*/
					if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
						/*start tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'start point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
							var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
							if(voidres==''){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(typeof voidres['data']!=="undefined"){//success
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								var message=JSON.parse(voidres['responseText']);
								if(voidres['status']==='timeout'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else if(voidres['status']=='400'||voidres['status']=='406'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
							}
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'api void pointtree is not function','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						/*end tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'end point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
				}
				else{//使用API串接付款，須先進行退款
				}
			}
			else if($('.verpsw input[name="type"]').val()=='viewvoid'){//暫結作廢
				if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
					var hint=confirm('請確認發票正本已收回。');
					if(hint==true){
						var nowbizdate=$('.viewtemp #date').html();
						var check=0;
						//2022/10/6 加上街口支付//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
						if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
							$.ajax({
								url:'./lib/api/intella/check.intellapay.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
										$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
										$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
										$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
										voidsalewithintellapay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
							$.ajax({
								url:'./lib/api/directlinepay/check.linepay.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
										$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
										$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
										voidsalewithlinepay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款
							$.ajax({
								url:'./lib/api/jkos/check.jkos.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										var datetime=new Date();
										var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
										$('.voidsalewithjkospay input[name="type"]').val('viewvoid');
										$('.voidsalewithjkospay input[name="saleno"]').val(orderid);
										$('.voidsalewithjkospay input[name="tradeno"]').val(d['tradeno']);
										$('.voidsalewithjkospay input[name="money"]').val(d['paymoney']);
										voidsalewithjkospay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
							$.ajax({
								url:'./lib/api/pxpayplus/check.pxpayplus.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithpxpaypluspay input[name="type"]').val('viewvoid');
										$('.voidsalewithpxpaypluspay input[name="orderid"]').val('');
										$('.voidsalewithpxpaypluspay input[name="saleno"]').val(d['saleno']);
										$('.voidsalewithpxpaypluspay input[name="tradeno"]').val(d['tradeno']);
										$('.voidsalewithpxpaypluspay input[name="money"]').val(d['paymoney']);
										//2022/11/7 產生產品明細json
										$('.order#order .pxpayplus #item_json').val(d['itemjson']);
										voidsalewithpxpaypluspay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
							$.ajax({
								url:'./lib/api/nccc/check.nccc.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithnccc input[name="type"]').val('viewvoid');
										$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
										$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
										voidsalewithnccc.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0){//沒有使用API串接付款
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile='';
							}
							else{
							}
							if($('.nidin #usenidin').length>0){
								nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
							}
							else{
							}
							$.ajax({
								url:'./lib/js/viewvoid.ajax.php',
								method:'post',
								async:false,
								data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
								dataType:'html',
								success:function(d){
									var tempres=d.split('-');
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var posdvrfile=tempres[1];
									}
									else{
									}
									//console.log(d);
									if(tempres[0]=='success'){
										$.ajax({
											url:'./lib/js/getinvname.ajax.php',
											method:'post',
											async:false,
											data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d=='dbempty'){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'reinv getinvname.ajax.php dbempty'},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
													$.ajax({
														url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
														method:'post',
														async:false,
														data:{'invfile':d[1]},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																$.ajax({
																	url:'./lib/js/reinv.ajax.php',
																	method:'post',
																	async:false,
																	data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		if(d.length>20||d.match('ERROR HINT: ')){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'creditcard reinv.ajax.php '+d},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		}
																		else{
																		}
																		if(d=='success'){
																			//alertmessage('發票補印完成。');
																			$('.alertmessage #text').html('發票補印完成。');
																			alertmessage.dialog('open');
																			verpsw.dialog('close');
																		}
																		else if(d=='dataempty'){
																			//alertmessage('查無資料，請確認輸入正確。');
																			$('.alertmessage #text').html('查無資料，請確認輸入正確。');
																			alertmessage.dialog('open');
																		}
																		else if(d=='dbempty'){
																			//alertmessage('資料庫錯誤。');
																			$('.alertmessage #text').html('資料庫錯誤。');
																			alertmessage.dialog('open');
																		}
																		else{
																			//alertmessage(d);
																			$('.alertmessage #text').html(d);
																			alertmessage.dialog('open');
																		}
																	},
																	error:function(e){
																		//console.log(e);
																	}
																});
															}
															else{
															}
															$.ajax({//作廢發票
																url:'./lib/js/deleteinv.ajax.php',
																method:'post',
																data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
																dataType:'html',
																success:function(d){
																	if(d.length>40||d.match('ERROR HINT: ')){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																			dataType:'html',
																			success:function(d){/*console.log(d);*/},
																			error:function(e){/*console.log(e);*/}
																		});
																	}
																	else{
																	}
																	//console.log(d);
																	$('.viewtemp #salelist #salecontent .listitems').prop('id','');
																	$('.viewtemp #listno').html('');
																	$('.viewtemp #list #listcontent').html('');
																	$('.viewtemp #date').html('');
																	$('.viewtemp #credate').html('');
																	$('.viewtemp #otherfun button#plus').prop('disabled',true);
																	$('.viewtemp #otherfun button#openinv').prop('disabled',true);
																	$('.viewtemp #viewvoid').prop('disabled',true);
																	$('.viewtemp #fun button#forall').prop('disabled',true);
																	$('.viewtemp #fun button#list').prop('disabled',true);
																	$('.viewtemp #fun button#tag').prop('disabled',true);
																	$('.viewtemp #fun button#kitchen').prop('disabled',true);
																	$('.viewtemp #fun button#changecheck').prop('disabled',true);
																	verpsw.dialog('close');
																	$('.order#order #banner #detail #tw #view').trigger('click');
																	//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																	//2017/12/29mywin.document.title='cashdrawer';
																},
																error:function(e){
																	//console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										//console.log(d);
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							/*錢都錄借接*/
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								/*start tag*/
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'start posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){console.log(e);}
								});
								if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
									var res=api_sendmessage_posdvr(posdvrfile);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'success '+posdvrfile,'file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'error sendmessage is not function','file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								/*end tag*/
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'end posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':nowbizdate.substr(0,6)+'-change'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{//使用API串接付款，須先進行退款
						}
					}
					else{
					}
				}
				else{
					var nowbizdate=$('.viewtemp #date').html();
					var check=0;
					//2022/10/6 加上街口支付//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
					if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
						$.ajax({
							url:'./lib/api/intella/check.intellapay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
									$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
									$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
									$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
									voidsalewithintellapay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
						$.ajax({
							url:'./lib/api/directlinepay/check.linepay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
									$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
									$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
									voidsalewithlinepay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款
						$.ajax({
							url:'./lib/api/jkos/check.jkos.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									var datetime=new Date();
									var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
									$('.voidsalewithjkospay input[name="type"]').val('viewvoid');
									$('.voidsalewithjkospay input[name="saleno"]').val(orderid);
									$('.voidsalewithjkospay input[name="tradeno"]').val(d['tradeno']);
									$('.voidsalewithjkospay input[name="money"]').val(d['paymoney']);
									voidsalewithjkospay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
						$.ajax({
							url:'./lib/api/pxpayplus/check.pxpayplus.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithpxpaypluspay input[name="type"]').val('viewvoid');
									$('.voidsalewithpxpaypluspay input[name="orderid"]').val('');
									$('.voidsalewithpxpaypluspay input[name="saleno"]').val(d['saleno']);
									$('.voidsalewithpxpaypluspay input[name="tradeno"]').val(d['tradeno']);
									$('.voidsalewithpxpaypluspay input[name="money"]').val(d['paymoney']);
									//2022/11/7 產生產品明細json
									$('.order#order .pxpayplus #item_json').val(d['itemjson']);
									voidsalewithpxpaypluspay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
						$.ajax({
							url:'./lib/api/nccc/check.nccc.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithnccc input[name="type"]').val('viewvoid');
									$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
									$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
									voidsalewithnccc.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0){//沒有使用API串接付款
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile='';
						}
						else{
						}
						if($('.nidin #usenidin').length>0){
							nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
						}
						else{
						}
						$.ajax({
							url:'./lib/js/viewvoid.ajax.php',
							method:'post',
							async:false,
							data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
							dataType:'html',
							success:function(d){
								var tempres=d.split('-');
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=tempres[1];
								}
								else{
								}
								//console.log(d);
								$('.viewtemp #salelist #salecontent .listitems').prop('id','');
								$('.viewtemp #listno').html('');
								$('.viewtemp #list #listcontent').html('');
								$('.viewtemp #date').html('');
								$('.viewtemp #credate').html('');
								$('.viewtemp #otherfun button#plus').prop('disabled',true);
								$('.viewtemp #otherfun button#openinv').prop('disabled',true);
								$('.viewtemp #viewvoid').prop('disabled',true);
								$('.viewtemp #fun button#forall').prop('disabled',true);
								$('.viewtemp #fun button#list').prop('disabled',true);
								$('.viewtemp #fun button#tag').prop('disabled',true);
								$('.viewtemp #fun button#kitchen').prop('disabled',true);
								$('.viewtemp #fun button#changecheck').prop('disabled',true);
								$('.viewtemp #fun button#editoutman').prop('disabled',true);
								verpsw.dialog('close');
								$('.order#order #banner #detail #tw #view').trigger('click');
							},
							error:function(e){
								//console.log(e);
							}
						});
						/*錢都錄借接*/
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							/*start tag*/
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'start posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){console.log(e);}
							});
							if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
								var res=api_sendmessage_posdvr(posdvrfile);
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'success '+posdvrfile,'file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'error sendmessage is not function','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							/*end tag*/
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'end posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						$.ajax({
							url:'./lib/js/create.cmdtxt.php',
							method:'post',
							async: false,
							data:{'cmd':nowbizdate.substr(0,6)+'-change'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{//使用API串接付款，須先進行退款
					}
				}
			}
			else if($('.verpsw input[name="type"]').val()=='viewvoidbyemptylist'){//全部刪除後刪單
				var nowbizdate=$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.voidtempdb.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'void emptyitemsvoidlist create.voidtempdb.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				if($('.order#order .initsetting #secview').val()=='1'){
					$.ajax({
						url:'../secview/cleartemp.ajax.php',
						method:'post',
						async: false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'temp cleartemp.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
						socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
						console.log('send message "clear" to secview');
					}
					else{
					}
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/viewvoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						var tempres=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'view-void-by-empty-list viewvoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile=tempres[1];
						}
						else{
						}
						//console.log(d);
						verpsw.dialog('close');
						emptyitemsvoidlist.dialog('close');
						if($('.order#order .initsetting #controltable').val()=='1'){
							inittable.dialog('open');
							ClearWindow('','');
						}
						else{
							ClearWindow('','');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else if($('.verpsw input[name="type"]').val()=='voidbyinv'){//依發票作廢帳單
				var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
				var check=0;
				//2022/10/6 加上街口支付//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
				if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
					$.ajax({
						url:'./lib/api/intella/check.intellapay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithintellapay input[name="type"]').val('voidbyinv');
								$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
								$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
								$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
								voidsalewithintellapay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
					$.ajax({
						url:'./lib/api/directlinepay/check.linepay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithlinepay input[name="type"]').val('voidbyinv');
								$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
								$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
								voidsalewithlinepay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款
					$.ajax({
						url:'./lib/api/jkos/check.jkos.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								var datetime=new Date();
								var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
								$('.voidsalewithjkospay input[name="type"]').val('voidbyinv');
								$('.voidsalewithjkospay input[name="saleno"]').val(orderid);
								$('.voidsalewithjkospay input[name="tradeno"]').val(d['tradeno']);
								$('.voidsalewithjkospay input[name="money"]').val(d['paymoney']);
								voidsalewithjkospay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
					$.ajax({
						url:'./lib/api/pxpayplus/check.pxpayplus.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithpxpaypluspay input[name="type"]').val('voidbyinv');
								$('.voidsalewithpxpaypluspay input[name="orderid"]').val('');
								$('.voidsalewithpxpaypluspay input[name="saleno"]').val(d['saleno']);
								$('.voidsalewithpxpaypluspay input[name="tradeno"]').val(d['tradeno']);
								$('.voidsalewithpxpaypluspay input[name="money"]').val(d['paymoney']);
								//2022/11/7 產生產品明細json
								$('.order#order .pxpayplus #item_json').val(d['itemjson']);
								voidsalewithpxpaypluspay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
					$.ajax({
						url:'./lib/api/nccc/check.nccc.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithnccc input[name="type"]').val('voidbyinv');
								$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
								$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
								voidsalewithnccc.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0){//沒有使用API串接付款
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
					}
					else{
					}
					$.ajax({
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						async:false,
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
						dataType:'html',
						success:function(d){
							var temp=d.split('-');
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(temp[0]=='success'){
								if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
									var memtype='online';
								}
								else{
									var memtype='offline';
								}
								var memberapi='';
								$.ajax({
									url:'./lib/js/searchmember.pointmoney.ajax.php',
									method:'post',
									async:false,
									data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d[0].length==0){
										}
										else{
											if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
											}
											else{
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													$.ajax({
														url:'../memberapi/point_money.ajax.php',
														method:'post',
														async:false,
														data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
														dataType:'json',
														timeout:5000,
														success:function(d){
															memberapi=d;
															//console.log(res);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e,t){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
															if(t==="timeout"){
																memberapi=[{"state":"fail","message":"AJAX timeout"}];
															}
															else{
																memberapi=e;
															}
														}
													});
													//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'../memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline errpr) '+e},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'../memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
											}
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/4mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								verpsw.dialog('close');
								$('.order#order #billfun #billfun2 #salevoid').trigger('click');
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=temp[1];
								}
								else{
								}
							}
							else{
								//console.log(d);
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':nowbizdate.substr(0,6)+'-change'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					/*錢都錄借接*/
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						/*start tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						/*end tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					/*集點樹收點流程*/
					if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
						/*start tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'start point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
							var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
							if(voidres==''){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(typeof voidres['data']!=="undefined"){//success
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								var message=JSON.parse(voidres['responseText']);
								if(voidres['status']==='timeout'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else if(voidres['status']=='400'||voidres['status']=='406'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
							}
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'api void pointtree is not function','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						/*end tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'end point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					salevoidbyinv.dialog('close');
				}
				else{//使用API串接付款，須先進行退款
				}
			}
			else if($('.verpsw input[name="type"]').val()=='editpay'){//修改付款
				var nowbizdate=$('.editpay #viewwindow #editform input[name="bizdate"]').val();
				var temparray=$('.editpay #viewwindow #editform').serialize();
				temparray=temparray+'&machinetype='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val();
				$.ajax({
					url:'./lib/js/cover.ajax.php',
					method:'post',
					async:false,
					data:$('.editpay #viewwindow #editform').serialize(),
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'editpay-send cover.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
						verpsw.dialog('close');

						$('.editpay #viewwindow #cancel').trigger('click');
						$('.salelist #fun #exit').trigger('click');
						$('.order#order #billfun #billfun2 #salelist').trigger('click');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else if($('.verpsw input[name="type"]').val()=='printedvoid'){//2020/9/9 刪除已出單品項
				verpsw.dialog('close');
				reason.dialog('open');
			}
			else{
				//console.log('other');
			}
		}
		else if(($('.verpsw input[name="type"]').val()=='paper'||$('.verpsw input[name="type"]').val()=='viewpaper')&&typeof $('.order#order .companydata #paperpw').val()!=="undefined"&&$('.order#order .companydata #paperpw').val()==$('.verpsw input[name="verpsw"]').val()){
			if($('.verpsw input[name="type"]').val()=='paper'){//列印報表
				if($('.historypaper select[name="paperlist"] option:selected').val()=='paper1'){
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					$.ajax({
						url:'./lib/js/shift.paper.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var tempd=d.split('-');
								posdvrfile=tempd[0];
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					/*錢都錄借接*/
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						/*start tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){console.log(e);}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						/*end tag*/
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper2'){
					$.ajax({
						url:'./lib/js/hispaper2.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper3'){
					$.ajax({
						url:'./lib/js/hispaper3.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper4'){
					$.ajax({
						url:'./lib/js/hispaper4.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else{
				}
			}
			else if($('.verpsw input[name="type"]').val()=='viewpaper'){//瀏覽報表
				if($('.historypaper select[name="paperlist"] option:selected').val()=='paper1'){
					$.ajax({
						url:'./lib/js/shift.paper.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper2'){
					$.ajax({
						url:'./lib/js/hispaper2.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper3'){
					$.ajax({
						url:'./lib/js/hispaper3.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper4'){
					$.ajax({
						url:'./lib/js/hispaper4.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else{
				}
			}
			else{
			}
		}
		else if($('.verpsw input[name="type"]').val()=='editpunch'&&typeof $('.order#order .companydata #punchpw').val()!=="undefined"&&$('.order#order .companydata #punchpw').val()==$('.verpsw input[name="verpsw"]').val()){
			if($('.verpsw input[name="type"]').val()=='editpunch'){//修改打卡紀錄
				verpsw.dialog('close');
				editpunch.dialog('open');
			}
			else{
			}
		}
		else if($('.verpsw input[name="type"]').val()=='sale_reprint_all'&&typeof $('.order#order .companydata #reprintpw').val()!=="undefined"&&$('.order#order .companydata #reprintpw').val()==$('.verpsw input[name="verpsw"]').val()){//補印單據(包含明細單、工作單與貼紙)
			var index='';
			var qty='';
			var inumber='';
			var linenumber='';
			for(var i=0;i<$('.salelist #list #listcontent .label').length;i++){
				if(index.length==0){
					index=index+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
				else{
					index=index+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
			}
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'','memname':$('.salelist #membername').html(),'memtel':$('.salelist #membertel').html() },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.list.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.list.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'' },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.tag.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.tag.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.kitchen.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.kitchen.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			/*$.ajax({
				url:'./lib/js/reprint.ajax.php',
				method:'post',
				data:{'company':$('.order#order .companydata #company').val(),'type':'all','listtype':$('.salelist input[name="listtype"]').val(),'no':$('.salelist #listno input[name="consecnumber"]').val(),'bizdate':$('.salelist #date').html(),'date':$('.salelist #credate').val(),'index':index,'qty':qty,'inumber':inumber,'linenumber':linenumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'reprint-forall reprint.ajax.php '+d},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
					//2017/12/4mywin.document.title='cashdrawer';
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
			verpsw.dialog('close');
		}
		else if($('.verpsw input[name="type"]').val()=='tempsale_reprint_all'&&typeof $('.order#order .companydata #reprintpw').val()!=="undefined"&&$('.order#order .companydata #reprintpw').val()==$('.verpsw input[name="verpsw"]').val()){//補印暫結單據(包含明細單、工作單與貼紙)
			var index='';
			var qty='';
			var inumber='';
			var linenumber='';
			for(var i=0;i<$('.viewtemp #list #listcontent .label').length;i++){
				if(index.length==0){
					index=index+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
				else{
					index=index+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
			}
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'temp','memname':$('.viewtemp #membername').html(),'memtel':$('.viewtemp #membertel').html() },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.list.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.list.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'temp' },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.tag.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.tag.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.kitchen.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.kitchen.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			//$.ajax({
			//	url:'./lib/js/reprint.ajax.php',
			//	method:'post',
			//	data:{'company':$('.order#order .companydata #company').val(),'type':'tempall','listtype':$('.viewtemp input[name="listtype"]').val(),'bizdate':$('.viewtemp #date').html(),'no':$('.viewtemp #listno input[name="consecnumber"]').val(),'date':$('.viewtemp #credate').val(),'index':index,'qty':qty,'inumber':inumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'linenumber':linenumber,'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
			//	dataType:'html',
			//	success:function(d){
			//		if(d.length>20||d.match('ERROR HINT: ')){
			//			$.ajax({
			//				url:'./lib/js/print.php',
			//				method:'post',
			//				data:{'html':'viewtemp-forall reprint.ajax.php '+d},
			//				dataType:'html',
			//				success:function(d){
			//					//console.log(d);
			//				},
			//				error:function(e){
			//					//console.log(e);
			//				}
			//			});
			//		}
			//		else{
			//		}
			//		//console.log(d);
			//		//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
			//		//2017/12/4mywin.document.title='cashdrawer';
			//	},
			//	error:function(e){
			//		//console.log(e);
			//	}
			//});
			verpsw.dialog('close');
		}
		//2022/4/21 在登入畫面補齊密碼參數後，該流程不存在(只適用登入帳號資料庫為舊版的情況)
		/*else if(((($('.verpsw input[name="type"]').val()=='reinv'||$('.verpsw input[name="type"]').val()=='editlist'||$('.verpsw input[name="type"]').val()=='void'||$('.verpsw input[name="type"]').val()=='viewvoid'||$('.verpsw input[name="type"]').val()=='viewvoidbyemptylist'||$('.verpsw input[name="type"]').val()=='voidbyinv'||$('.verpsw input[name="type"]').val()=='editpay'||$('.verpsw input[name="type"]').val()=='printedvoid')&&typeof $('.order#order .companydata #voidpw').val()==="undefined")||(($('.verpsw input[name="type"]').val()=='paper'||$('.verpsw input[name="type"]').val()=='viewpaper')&&typeof $('.order#order .companydata #paperpw').val()==="undefined")||($('.verpsw input[name="type"]').val()=='editpunch'&&typeof $('.order#order .companydata #punchpw').val()==="undefined")||(($('.verpsw input[name="type"]').val()=='sale_reprint_all'||$('.verpsw input[name="type"]').val()=='tempsale_reprint_all')&&typeof $('.order#order .companydata #reprintpw').val()==="undefined"))&&$('.verpsw input[name="verpsw"]').val()==$('.order#order .initsetting #voidpsw').val()){
			if($('.verpsw input[name="type"]').val()=='reinv'){//補印發票
				$.ajax({
					url:'./lib/js/getinvname.ajax.php',
					method:'post',
					async:false,
					data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(d=='dbempty'){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'reinv getinvname.ajax.php dbempty'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
							$.ajax({
								url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
								method:'post',
								async:false,
								data:{'invfile':d[1]},
								dataType:'html',
								success:function(d){
									//console.log(d);
									$.ajax({
										url:'./lib/js/reinv.ajax.php',
										method:'post',
										async:false,
										data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
										dataType:'html',
										success:function(d){
											console.log(d);
											if(d.length>20||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'creditcard reinv.ajax.php '+d},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
											else{
											}
											if(d=='success'){
												//alertmessage('發票補印完成。');
												$('.alertmessage #text').html('發票補印完成。');
												alertmessage.dialog('open');
												verpsw.dialog('close');
											}
											else if(d=='dataempty'){
												//alertmessage('查無資料，請確認輸入正確。');
												$('.alertmessage #text').html('查無資料，請確認輸入正確。');
												alertmessage.dialog('open');
											}
											else if(d=='dbempty'){
												//alertmessage('資料庫錯誤。');
												$('.alertmessage #text').html('資料庫錯誤。');
												alertmessage.dialog('open');
											}
											else{
												//alertmessage(d);
												$('.alertmessage #text').html(d);
												alertmessage.dialog('open');
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				//$.ajax({
				//	url:'./lib/js/reinv.ajax.php',
				//	method:'post',
				//	async:false,
				//	data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
				//	dataType:'html',
				//	success:function(d){
				//		if(d.length>20||d.match('ERROR HINT: ')){
				//			$.ajax({
				//				url:'./lib/js/print.php',
				//				method:'post',
				//				data:{'html':'creditcard reinv.ajax.php '+d},
				//				dataType:'html',
				//				success:function(d){
				//					//console.log(d);
				//				},
				//				error:function(e){
				//					//console.log(e);
				//				}
				//			});
				//		}
				//		else{
				//		}
				//		if(d=='success'){
				//			alertmessage('發票補印完成。');
				//			verpsw.dialog('close');
				//		}
				//		else if(d=='dataempty'){
				//			alertmessage('查無資料，請確認輸入正確。');
				//		}
				//		else if(d=='dbempty'){
				//			alertmessage('資料庫錯誤。');
				//		}
				//		else{
				//			alertmessage(d);
				//		}
				//	},
				//	error:function(e){
				//		//console.log(e);
				//	}
				//});
			}
			else if($('.verpsw input[name="type"]').val()=='editlist'){//修改帳單1
				var voidbizdate=$('.salelist #date').html();
				var voidconsecnumber=$('.salelist #listno input[name="consecnumber"]').val();
				$.ajax({
					url:'./lib/js/checkopen.ajax.php',
					method:'post',
					async:false,
					data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard checkopen.ajax.php '+d},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
						}
						//console.log(d);
						if(d=='success'){
							var nowbizdate=$('.salelist #date').html();
							if($('.salelist #date').html()!=''){
								var listtype='';
								var tabnum='';
								var consecnumber='';
								var check=0;
								//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
								if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
									//console.log('void inv');
									var hint=confirm('該帳單已開發票，如要修改請確認發票正本已收回。');
									if(hint==true){
										if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
											$.ajax({
												url:'./lib/api/intella/check.intellapay.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithintellapay input[name="type"]').val('editlist');
														$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
														$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
														$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
														voidsalewithintellapay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
											$.ajax({
												url:'./lib/api/directlinepay/check.linepay.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithlinepay input[name="type"]').val('editlist');
														$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
														$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
														voidsalewithlinepay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
											$.ajax({
												url:'./lib/api/nccc/check.nccc.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithnccc input[name="type"]').val('editlist');
														$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
														$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
														voidsalewithnccc.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0){//沒有使用API串接付款
											if($('.nidin #usenidin').length>0){
												nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
											}
											else{
											}
											$.ajax({//作廢帳單
												url:'./lib/js/salevoid.ajax.php',
												method:'post',
												data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
												dataType:'html',
												success:function(d){
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'creditcard salevoid.ajax.php '+d},
															dataType:'html',
															success:function(d){
																console.log(d);
															},
															error:function(e){
																console.log(e);
															}
														});
													}
													else{
													}
													if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
														var memtype='online';
													}
													else{
														var memtype='offline';
													}
													var memberapi='';
													$.ajax({
														url:'./lib/js/searchmember.pointmoney.ajax.php',
														method:'post',
														async:false,
														data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
														dataType:'json',
														success:function(d){
															//console.log(d);
															if(d[0].length==0){
															}
															else{
																if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
																	if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																		memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
																		if(memberapi[0]['state']=='success'){
																			$.ajax({
																				url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
																				method:'post',
																				async:false,
																				data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																				dataType:'html',
																				success:function(d){
																					//console.log(d);
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																						dataType:'html',
																						success:function(d){
																							console.log(d);
																						},
																						error:function(e){
																							console.log(e);
																						}
																					});
																				},
																				error:function(e){
																					//console.log(e);
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																						dataType:'html',
																						success:function(d){
																							console.log(d);
																						},
																						error:function(e){
																							console.log(e);
																						}
																					});
																				}
																			});
																		}
																		else{
																		}
																		$.ajax({
																			url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
																			method:'post',
																			async:false,
																			data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			},
																			error:function(e){
																				//console.log(e);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			}
																		});
																	}
																	else{
																	}
																}
																else{
																	if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																		$.ajax({
																			url:'../memberapi/point_money.ajax.php',
																			method:'post',
																			async:false,
																			data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
																			dataType:'json',
																			timeout:5000,
																			success:function(d){
																				memberapi=d;
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																				//console.log(res);
																			},
																			error:function(e,t){
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																				if(t==="timeout"){
																					memberapi=[{"state":"fail","message":"AJAX timeout"}];
																				}
																				else{
																					memberapi=e;
																				}
																			}
																		});
																		//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
																		if(memberapi[0]['state']=='success'){
																			$.ajax({
																				url:'../memberapi/change.memberdata.php',
																				method:'post',
																				async:false,
																				data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																				dataType:'html',
																				success:function(d){
																					//console.log(d);
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																						dataType:'html',
																						success:function(d){
																							console.log(d);
																						},
																						error:function(e){
																							console.log(e);
																						}
																					});
																				},
																				error:function(e){
																					//console.log(e);
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																						dataType:'html',
																						success:function(d){
																							console.log(d);
																						},
																						error:function(e){
																							console.log(e);
																						}
																					});
																				}
																			});
																		}
																		else{
																		}
																		$.ajax({
																			url:'../memberapi/insertmemlist.ajax.php',
																			method:'post',
																			async:false,
																			data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			},
																			error:function(e){
																				//console.log(e);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			}
																		});
																	}
																	else{
																	}
																}
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
													if(d.substr(0,7)=='success'){
														$.ajax({
															url:'./lib/js/getinvname.ajax.php',
															method:'post',
															async:false,
															data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'json',
															success:function(d){
																//console.log(d);
																if(d=='dbempty'){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'reinv getinvname.ajax.php dbempty'},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
																else{
																	$.ajax({
																		url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
																		method:'post',
																		async:false,
																		data:{'invfile':d[1]},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																				$.ajax({
																					url:'./lib/js/reinv.ajax.php',
																					method:'post',
																					async:false,
																					data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
																					dataType:'html',
																					success:function(d){
																						//console.log(d);
																						if(d.length>20||d.match('ERROR HINT: ')){
																							$.ajax({
																								url:'./lib/js/print.php',
																								method:'post',
																								data:{'html':'creditcard reinv.ajax.php '+d},
																								dataType:'html',
																								success:function(d){
																									console.log(d);
																								},
																								error:function(e){
																									console.log(e);
																								}
																							});
																						}
																						else{
																						}
																					},
																					error:function(e){
																						//console.log(e);
																					}
																				});
																			}
																			else{
																			}
																			$.ajax({//作廢發票
																				url:'./lib/js/deleteinv.ajax.php',
																				method:'post',
																				data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
																				dataType:'html',
																				success:function(d){
																					if(d.length>40||d.match('ERROR HINT: ')){
																						$.ajax({
																							url:'./lib/js/print.php',
																							method:'post',
																							data:{'html':'creditcard deleteinv.ajax.php '+d},
																							dataType:'html',
																							success:function(d){
																								console.log(d);
																							},
																							error:function(e){
																								console.log(e);
																							}
																						});
																					}
																					else{
																					}
																					//console.log(d);
																					//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																					//2017/12/29mywin.document.title='cashdrawer';
																				},
																				error:function(e){
																					//console.log(e);
																				}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																		}
																	});
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
														//console.log(d);
													}
													$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
														url:'./lib/js/copysale.ajax.php',
														method:'post',
														data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
														dataType:'html',
														success:function(d){
															if(d.length>30||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard copysale.ajax.php '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
															else{
															}
															var t=d.split('-');
															//console.log(t);
															listtype=t[t.length-3];
															bizdate=t[t.length-2];
															consecnumber=t[t.length-1];
															//console.log(d);

															temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
															//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
															verpsw.dialog('close');
															$('.salelist #editpay').prop('disabled',true);
															$('.salelist #reorder').prop('disabled',true);
															$('.salelist #reinv').prop('disabled',true);
															$('.salelist #rekvm').prop('disabled',true);
															$('.salelist #salelist #salecontent .listitems').prop('id','');
															$('.salelist #listno').html('');
															$('.salelist #list #listcontent').html('');
															$('.salelist #date').html('');
															$('.salelist #credate').html('');
															$('.salelist #fun button#forall').prop('disabled',true);
															$('.salelist #fun button#list').prop('disabled',true);
															$('.salelist #fun button#tag').prop('disabled',true);
															$('.salelist #fun button#kitchen').prop('disabled',true);
															$('.salelist #fun button#changecheck').prop('disabled',true);
															salelist.dialog('close');
															if($('.funbox').length>0&&funbox.dialog('isOpen')){
																funbox.dialog('close');
																inittable.dialog('close');
															}
															else{
																//console.log('e3');
															}
															if(!$('.order#order #billfun #billfun1button').prop('disabled')){
																$('.order#order #billfun #billfun1button').trigger('click');
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{//使用API串接付款，須先進行退款
										}
									}
									else{
									}
								}
								else{
									if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
										$.ajax({
											url:'./lib/api/intella/check.intellapay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithintellapay input[name="type"]').val('editlist');
													$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
													$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
													$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
													voidsalewithintellapay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
										$.ajax({
											url:'./lib/api/directlinepay/check.linepay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithlinepay input[name="type"]').val('editlist');
													$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
													$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
													voidsalewithlinepay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
										$.ajax({
											url:'./lib/api/nccc/check.nccc.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithnccc input[name="type"]').val('editlist');
													$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
													$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
													voidsalewithnccc.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0){//沒有使用API串接付款
										if($('.nidin #usenidin').length>0){
											nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
										}
										else{
										}
										$.ajax({//作廢帳單
											url:'./lib/js/salevoid.ajax.php',
											method:'post',
											data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
											dataType:'html',
											success:function(d){
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'creditcard salevoid.ajax.php '+d},
														dataType:'html',
														success:function(d){
															console.log(d);
														},
														error:function(e){
															console.log(e);
														}
													});
												}
												else{
												}
												if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
													var memtype='online';
												}
												else{
													var memtype='offline';
												}
												var memberapi='';
												$.ajax({
													url:'./lib/js/searchmember.pointmoney.ajax.php',
													method:'post',
													async:false,
													data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
													dataType:'json',
													success:function(d){
														//console.log(d);
														if(d[0].length==0){
														}
														else{
															if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
																if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																	memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
																	if(memberapi[0]['state']=='success'){
																		$.ajax({
																			url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
																			method:'post',
																			async:false,
																			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			},
																			error:function(e){
																				//console.log(e);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			}
																		});
																	}
																	else{
																	}
																	$.ajax({
																		url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
																		method:'post',
																		async:false,
																		data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		}
																	});
																}
																else{
																}
															}
															else{
																if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																	$.ajax({
																		url:'../memberapi/point_money.ajax.php',
																		method:'post',
																		async:false,
																		data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
																		dataType:'json',
																		timeout:5000,
																		success:function(d){
																			memberapi=d;
																			//console.log(res);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		},
																		error:function(e,t){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																			if(t==="timeout"){
																				memberapi=[{"state":"fail","message":"AJAX timeout"}];
																			}
																			else{
																				memberapi=e;
																			}
																		}
																	});
																	//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
																	if(memberapi[0]['state']=='success'){
																		$.ajax({
																			url:'../memberapi/change.memberdata.php',
																			method:'post',
																			async:false,
																			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			},
																			error:function(e){
																				//console.log(e);
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			}
																		});
																	}
																	else{
																	}
																	$.ajax({
																		url:'../memberapi/insertmemlist.ajax.php',
																		method:'post',
																		async:false,
																		data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		}
																	});
																}
																else{
																}
															}
														}
													},
													error:function(e){
														//console.log(e);
													}
												});
												$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
													url:'./lib/js/copysale.ajax.php',
													method:'post',
													data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
													dataType:'html',
													success:function(d){
														if(d.length>30||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'creditcard copysale.ajax.php '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
														else{
														}
														var t=d.split('-');
														//console.log(t);
														listtype=t[t.length-3];
														bizdate=t[t.length-2];
														consecnumber=t[t.length-1];
														//console.log(d);

														temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
														//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
														verpsw.dialog('close');
														$('.salelist #editpay').prop('disabled',true);
														$('.salelist #reorder').prop('disabled',true);
														$('.salelist #reinv').prop('disabled',true);
														$('.salelist #rekvm').prop('disabled',true);
														$('.salelist #salelist #salecontent .listitems').prop('id','');
														$('.salelist #listno').html('');
														$('.salelist #list #listcontent').html('');
														$('.salelist #date').html('');
														$('.salelist #credate').html('');
														$('.salelist #fun button#forall').prop('disabled',true);
														$('.salelist #fun button#list').prop('disabled',true);
														$('.salelist #fun button#tag').prop('disabled',true);
														$('.salelist #fun button#kitchen').prop('disabled',true);
														$('.salelist #fun button#changecheck').prop('disabled',true);
														salelist.dialog('close');
														if($('.funbox').length>0&&funbox.dialog('isOpen')){
															funbox.dialog('close');
															inittable.dialog('close');
														}
														else{
															//console.log('e4');
														}
														if(!$('.order#order #billfun #billfun1button').prop('disabled')){
															$('.order#order #billfun #billfun1button').trigger('click');
														}
														else{
														}
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{//使用API串接付款，須先進行退款
									}
								}
							}
							else{
							}
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':nowbizdate.substr(0,6)+'-change'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
							//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
							$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
							alertmessage.dialog('open');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				
				//2020/5/25 貌似沒有幫助
				//if(membercheck==''||(typeof membercheck[0]!=="undefined"&&typeof membercheck[0]['state']!=="undefined"&&membercheck[0]['state']=='success')){//本地會員或網路會員伺服器連線成功
				//}
				//else{
				//	return;
				//}

				//集點樹收點流程
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					//start tag
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){
							console.log(d);
						},
						error:function(e){
							console.log(e);
						}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					//end tag
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){
							console.log(d);
						},
						error:function(e){
							console.log(e);
						}
					});
				}
				else{
				}
			}
			else if($('.verpsw input[name="type"]').val()=='void'){//作廢帳單1
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				var check=0;
				//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
				if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
					$.ajax({
						url:'./lib/api/intella/check.intellapay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithintellapay input[name="type"]').val('void');
								$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
								$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
								$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
								voidsalewithintellapay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
					$.ajax({
						url:'./lib/api/directlinepay/check.linepay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithlinepay input[name="type"]').val('void');
								$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
								$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
								voidsalewithlinepay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
					$.ajax({
						url:'./lib/api/nccc/check.nccc.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithnccc input[name="type"]').val('void');
								$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
								$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
								voidsalewithnccc.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0){//沒有使用API串接付款
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							var temp=d.split('-');
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
							}
							if(temp[0]=='success'){
								if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
									var memtype='online';
								}
								else{
									var memtype='offline';
								}
								var memberapi='';
								$.ajax({
									url:'./lib/js/searchmember.pointmoney.ajax.php',
									method:'post',
									async:false,
									data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d[0].length==0){
										}
										else{
											if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
											else{
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													$.ajax({
														url:'../memberapi/point_money.ajax.php',
														method:'post',
														async:false,
														data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
														dataType:'json',
														timeout:5000,
														success:function(d){
															memberapi=d;
															//console.log(res);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e,t){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
															if(t==="timeout"){
																memberapi=[{"state":"fail","message":"AJAX timeout"}];
															}
															else{
																memberapi=e;
															}
														}
													});
													//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'../memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'../memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){
													console.log(d);
												},
												error:function(e){
													console.log(e);
												}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/4mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.order#order #billfun #billfun2 #salevoid').trigger('click');
								$('.salevoid #listno').html('');
								$('.salevoid #list #listcontent').html('');
								$('.salevoid #date').html('');
								$('.salevoid #credate').html('');
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=temp[1];
								}
								else{
								}
							}
							else{
								//console.log(d);
							}
							verpsw.dialog('close');
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':nowbizdate.substr(0,6)+'-change'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					//錢都錄借接
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){console.log(e);}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
					//集點樹收點流程
					if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'start point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
						if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
							var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
							if(voidres==''){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else if(typeof voidres['data']!=="undefined"){//success
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
								var message=JSON.parse(voidres['responseText']);
								if(voidres['status']==='timeout'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else if(voidres['status']=='400'||voidres['status']=='406'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
							}
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'api void pointtree is not function','file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'end point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
				}
				else{//使用API串接付款，須先進行退款
				}
			}
			else if($('.verpsw input[name="type"]').val()=='viewvoid'){//暫結作廢
				if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
					var hint=confirm('請確認發票正本已收回。');
					if(hint==true){
						var nowbizdate=$('.viewtemp #date').html();
						var check=0;
						//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
						if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
							$.ajax({
								url:'./lib/api/intella/check.intellapay.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
										$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
										$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
										$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
										voidsalewithintellapay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
							$.ajax({
								url:'./lib/api/directlinepay/check.linepay.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
										$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
										$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
										voidsalewithlinepay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
							$.ajax({
								url:'./lib/api/nccc/check.nccc.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithnccc input[name="type"]').val('viewvoid');
										$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
										$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
										voidsalewithnccc.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0){//沒有使用API串接付款
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile='';
							}
							else{
							}
							if($('.nidin #usenidin').length>0){
								nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
							}
							else{
							}
							$.ajax({
								url:'./lib/js/viewvoid.ajax.php',
								method:'post',
								async:false,
								data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
								dataType:'html',
								success:function(d){
									var tempres=d.split('-');
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
											dataType:'html',
											success:function(d){
												console.log(d);
											},
											error:function(e){
												console.log(e);
											}
										});
									}
									else{
									}
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var posdvrfile=tempres[1];
									}
									else{
									}
									//console.log(d);
									if(tempres[0]=='success'){
										$.ajax({
											url:'./lib/js/getinvname.ajax.php',
											method:'post',
											async:false,
											data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d=='dbempty'){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'reinv getinvname.ajax.php dbempty'},
														dataType:'html',
														success:function(d){
															console.log(d);
														},
														error:function(e){
															console.log(e);
														}
													});
												}
												else{
													$.ajax({
														url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
														method:'post',
														async:false,
														data:{'invfile':d[1]},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																$.ajax({
																	url:'./lib/js/reinv.ajax.php',
																	method:'post',
																	async:false,
																	data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		if(d.length>20||d.match('ERROR HINT: ')){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'creditcard reinv.ajax.php '+d},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		}
																		else{
																		}
																	},
																	error:function(e){
																		//console.log(e);
																	}
																});
															}
															else{
															}
															$.ajax({//作廢發票
																url:'./lib/js/deleteinv.ajax.php',
																method:'post',
																data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
																dataType:'html',
																success:function(d){
																	if(d.length>40||d.match('ERROR HINT: ')){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	}
																	else{
																	}
																	//console.log(d);
																	$('.viewtemp #salelist #salecontent .listitems').prop('id','');
																	$('.viewtemp #listno').html('');
																	$('.viewtemp #list #listcontent').html('');
																	$('.viewtemp #date').html('');
																	$('.viewtemp #credate').html('');
																	$('.viewtemp #otherfun button#plus').prop('disabled',true);
																	$('.viewtemp #otherfun button#openinv').prop('disabled',true);
																	$('.viewtemp #viewvoid').prop('disabled',true);
																	$('.viewtemp #fun button#forall').prop('disabled',true);
																	$('.viewtemp #fun button#list').prop('disabled',true);
																	$('.viewtemp #fun button#tag').prop('disabled',true);
																	$('.viewtemp #fun button#kitchen').prop('disabled',true);
																	$('.viewtemp #fun button#changecheck').prop('disabled',true);
																	$('.viewtemp #fun button#editoutman').prop('disabled',true);
																	verpsw.dialog('close');
																	$('.order#order #banner #detail #tw #view').trigger('click');
																	//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																	//2017/12/29mywin.document.title='cashdrawer';
																},
																error:function(e){
																	//console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										//console.log(d);
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//錢都錄借接
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								//start tag
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'start posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){console.log(e);}
								});
								if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
									var res=api_sendmessage_posdvr(posdvrfile);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'success '+posdvrfile,'file':'posdvr'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'error sendmessage is not function','file':'posdvr'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								//end tag
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'end posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
							}
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':nowbizdate.substr(0,6)+'-change'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{//使用API串接付款，須先進行退款
						}
					}
					else{
					}
				}
				else{
					var nowbizdate=$('.viewtemp #date').html();
					var check=0;
					//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
					if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
						$.ajax({
							url:'./lib/api/intella/check.intellapay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
									$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
									$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
									$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
									voidsalewithintellapay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
						$.ajax({
							url:'./lib/api/directlinepay/check.linepay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
									$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
									$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
									voidsalewithlinepay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
						$.ajax({
							url:'./lib/api/nccc/check.nccc.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithnccc input[name="type"]').val('viewvoid');
									$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
									$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
									voidsalewithnccc.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0){//沒有使用API串接付款
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile='';
						}
						else{
						}
						if($('.nidin #usenidin').length>0){
							nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
						}
						else{
						}
						$.ajax({
							url:'./lib/js/viewvoid.ajax.php',
							method:'post',
							async:false,
							data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
							dataType:'html',
							success:function(d){
								var tempres=d.split('-');
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=tempres[1];
								}
								else{
								}
								//console.log(d);
								$('.viewtemp #salelist #salecontent .listitems').prop('id','');
								$('.viewtemp #listno').html('');
								$('.viewtemp #list #listcontent').html('');
								$('.viewtemp #date').html('');
								$('.viewtemp #credate').html('');
								$('.viewtemp #otherfun button#plus').prop('disabled',true);
								$('.viewtemp #otherfun button#openinv').prop('disabled',true);
								$('.viewtemp #viewvoid').prop('disabled',true);
								$('.viewtemp #fun button#forall').prop('disabled',true);
								$('.viewtemp #fun button#list').prop('disabled',true);
								$('.viewtemp #fun button#tag').prop('disabled',true);
								$('.viewtemp #fun button#kitchen').prop('disabled',true);
								$('.viewtemp #fun button#changecheck').prop('disabled',true);
								$('.viewtemp #fun button#editoutman').prop('disabled',true);
								verpsw.dialog('close');
								$('.order#order #banner #detail #tw #view').trigger('click');
							},
							error:function(e){
								//console.log(e);
							}
						});
						//錢都錄借接
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							//start tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'start posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){console.log(e);}
							});
							if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
								var res=api_sendmessage_posdvr(posdvrfile);
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'success '+posdvrfile,'file':'posdvr'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'error sendmessage is not function','file':'posdvr'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							//end tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'end posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
						}
						$.ajax({
							url:'./lib/js/create.cmdtxt.php',
							method:'post',
							async: false,
							data:{'cmd':nowbizdate.substr(0,6)+'-change'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{//使用API串接付款，須先進行退款
					}
				}
			}
			else if($('.verpsw input[name="type"]').val()=='viewvoidbyemptylist'){//全部刪除後刪單
				var nowbizdate=$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.voidtempdb.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'void emptyitemsvoidlist create.voidtempdb.php '+d},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				if($('.order#order .initsetting #secview').val()=='1'){
					$.ajax({
						url:'../secview/cleartemp.ajax.php',
						method:'post',
						async: false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'temp cleartemp.ajax.php '+d},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
						socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
						console.log('send message "clear" to secview');
					}
					else{
					}
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/viewvoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						var tempres=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'view-void-by-empty-list viewvoid.ajax.php '+d},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile=tempres[1];
						}
						else{
						}
						//console.log(d);
						verpsw.dialog('close');
						emptyitemsvoidlist.dialog('close');
						if($('.order#order .initsetting #controltable').val()=='1'){
							inittable.dialog('open');
							ClearWindow('','');
						}
						else{
							ClearWindow('','');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				//錢都錄借接
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					//start tag
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){
							console.log(d);
						},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					//end tag
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){
							console.log(d);
						},
						error:function(e){
							console.log(e);
						}
					});
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else if($('.verpsw input[name="type"]').val()=='voidbyinv'){//依發票作廢帳單1
				var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
				var check=0;
				//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
				if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
					$.ajax({
						url:'./lib/api/intella/check.intellapay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').html(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithintellapay input[name="type"]').val('voidbyinv');
								$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
								$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
								$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
								voidsalewithintellapay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
					$.ajax({
						url:'./lib/api/directlinepay/check.linepay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').html(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithlinepay input[name="type"]').val('voidbyinv');
								$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
								$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
								voidsalewithlinepay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
					$.ajax({
						url:'./lib/api/nccc/check.nccc.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoidbyinv #checkcontent #bizdate').html(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithnccc input[name="type"]').val('voidbyinv');
								$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
								$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
								voidsalewithnccc.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0){//沒有使用API串接付款
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
					}
					else{
					}
					$.ajax({
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						async:false,
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
						dataType:'html',
						success:function(d){
							var temp=d.split('-');
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
							}
							if(temp[0]=='success'){
								if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
									var memtype='online';
								}
								else{
									var memtype='offline';
								}
								var memberapi='';
								$.ajax({
									url:'./lib/js/searchmember.pointmoney.ajax.php',
									method:'post',
									async:false,
									data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d[0].length==0){
										}
										else{
											if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
											else{
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													$.ajax({
														url:'../memberapi/point_money.ajax.php',
														method:'post',
														async:false,
														data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
														dataType:'json',
														timeout:5000,
														success:function(d){
															memberapi=d;
															//console.log(res);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e,t){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
															if(t==="timeout"){
																memberapi=[{"state":"fail","message":"AJAX timeout"}];
															}
															else{
																memberapi=e;
															}
														}
													});
													//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'../memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'../memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){
													console.log(d);
												},
												error:function(e){
													console.log(e);
												}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/4mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								verpsw.dialog('close');
								$('.order#order #billfun #billfun2 #salevoid').trigger('click');
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=temp[1];
								}
								else{
								}
							}
							else{
								//console.log(d);
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':nowbizdate.substr(0,6)+'-change'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					//錢都錄借接
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
					//集點樹收點流程
					if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'start point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
						if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
							var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
							if(voidres==''){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else if(typeof voidres['data']!=="undefined"){//success
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
								var message=JSON.parse(voidres['responseText']);
								if(voidres['status']==='timeout'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else if(voidres['status']=='400'||voidres['status']=='406'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
							}
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'api void pointtree is not function','file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'end point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
					salevoidbyinv.dialog('close');
				}
				else{//使用API串接付款，須先進行退款
				}
			}
			else if($('.verpsw input[name="type"]').val()=='editpay'){//修改付款1
				var nowbizdate=$('.editpay #viewwindow #editform input[name="bizdate"]').val();
				var temparray=$('.editpay #viewwindow #editform').serialize();
				temparray=temparray+'&machinetype='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val();
				$.ajax({
					url:'./lib/js/cover.ajax.php',
					method:'post',
					async:false,
					data:$('.editpay #viewwindow #editform').serialize(),
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'editpay-send cover.ajax.php '+d},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
						}
						//console.log(d);
						verpsw.dialog('close');

						$('.editpay #viewwindow #cancel').trigger('click');
						$('.salelist #fun #exit').trigger('click');
						$('.order#order #billfun #billfun2 #salelist').trigger('click');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else if($('.verpsw input[name="type"]').val()=='printedvoid'){//2020/9/9 刪除已出單品項1
				verpsw.dialog('close');
				reason.dialog('open');
			}
			else if($('.verpsw input[name="type"]').val()=='paper'){//列印報表
				if($('.historypaper select[name="paperlist"] option:selected').val()=='paper1'){
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					$.ajax({
						url:'./lib/js/shift.paper.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var tempd=d.split('-');
								posdvrfile=tempd[0];
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
					//錢都錄借接
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){console.log(e);}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper2'){
					$.ajax({
						url:'./lib/js/hispaper2.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper3'){
					$.ajax({
						url:'./lib/js/hispaper3.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper4'){
					$.ajax({
						url:'./lib/js/hispaper4.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else{
				}
			}
			else if($('.verpsw input[name="type"]').val()=='viewpaper'){//瀏覽報表
				if($('.historypaper select[name="paperlist"] option:selected').val()=='paper1'){
					$.ajax({
						url:'./lib/js/shift.paper.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper2'){
					$.ajax({
						url:'./lib/js/hispaper2.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper3'){
					$.ajax({
						url:'./lib/js/hispaper3.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper4'){
					$.ajax({
						url:'./lib/js/hispaper4.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
						dataType:'html',
						success:function(d){
							$('.viewpaper').html(d);
							viewpaper.dialog('open');
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					verpsw.dialog('close');
				}
				else{
				}
			}
			else if($('.verpsw input[name="type"]').val()=='editpunch'){//修改打卡紀錄
				verpsw.dialog('close');
				editpunch.dialog('open');
			}
			else if($('.verpsw input[name="type"]').val()=='sale_reprint_all'){//補印單據(包含明細單、工作單與貼紙)
				var index='';
				var qty='';
				var inumber='';
				var linenumber='';
				for(var i=0;i<$('.salelist #list #listcontent .label').length;i++){
					if(index.length==0){
						index=index+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
						qty=qty+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
						inumber=inumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
						linenumber=linenumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
					}
					else{
						index=index+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
						qty=qty+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
						inumber=inumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
						linenumber=linenumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
					}
				}
				$.ajax({
					url:'./lib/js/reprint.transdata.ajax.php',
					method:'post',
					data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'','memname':$('.salelist #membername').html(),'memtel':$('.salelist #membertel').html() },
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/create.list.php',
							method:'post',
							async: false,
							data:d,
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reprint forall create.list.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					},
					error:function(e){
						console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/reprint.transdata.ajax.php',
					method:'post',
					data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'' },
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/create.tag.php',
							method:'post',
							async: false,
							data:d,
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reprint forall create.tag.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						$.ajax({
							url:'./lib/js/create.kitchen.php',
							method:'post',
							async: false,
							data:d,
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reprint forall create.kitchen.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					},
					error:function(e){
						console.log(e);
					}
				});
				//$.ajax({
				//	url:'./lib/js/reprint.ajax.php',
				//	method:'post',
				//	data:{'company':$('.order#order .companydata #company').val(),'type':'all','listtype':$('.salelist input[name="listtype"]').val(),'no':$('.salelist #listno input[name="consecnumber"]').val(),'bizdate':$('.salelist #date').html(),'date':$('.salelist #credate').val(),'index':index,'qty':qty,'inumber':inumber,'linenumber':linenumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
				//	dataType:'html',
				//	success:function(d){
				//		if(d.length>20||d.match('ERROR HINT: ')){
				//			$.ajax({
				//				url:'./lib/js/print.php',
				//				method:'post',
				//				data:{'html':'reprint-forall reprint.ajax.php '+d},
				//				dataType:'html',
				//				success:function(d){
				//					//console.log(d);
				//				},
				//				error:function(e){
				//					//console.log(e);
				//				}
				//			});
				//		}
				//		else{
				//		}
				//		//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//		//2017/12/4mywin.document.title='cashdrawer';
				//		//console.log(d);
				//	},
				//	error:function(e){
				//		//console.log(e);
				//	}
				//});
				verpsw.dialog('close');
			}
			else if($('.verpsw input[name="type"]').val()=='tempsale_reprint_all'){//補印暫結單據(包含明細單、工作單與貼紙)
				var index='';
				var qty='';
				var inumber='';
				var linenumber='';
				for(var i=0;i<$('.viewtemp #list #listcontent .label').length;i++){
					if(index.length==0){
						index=index+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
						qty=qty+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
						inumber=inumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
						linenumber=linenumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
					}
					else{
						index=index+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
						qty=qty+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
						inumber=inumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
						linenumber=linenumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
					}
				}
				$.ajax({
					url:'./lib/js/reprint.transdata.ajax.php',
					method:'post',
					data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'temp','memname':$('.viewtemp #membername').html(),'memtel':$('.viewtemp #membertel').html() },
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/create.list.php',
							method:'post',
							async: false,
							data:d,
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reprint forall create.list.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					},
					error:function(e){
						console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/reprint.transdata.ajax.php',
					method:'post',
					data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'temp' },
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/create.tag.php',
							method:'post',
							async: false,
							data:d,
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reprint forall create.tag.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						$.ajax({
							url:'./lib/js/create.kitchen.php',
							method:'post',
							async: false,
							data:d,
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reprint forall create.kitchen.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					},
					error:function(e){
						console.log(e);
					}
				});
				//$.ajax({
				//	url:'./lib/js/reprint.ajax.php',
				//	method:'post',
				//	data:{'company':$('.order#order .companydata #company').val(),'type':'tempall','listtype':$('.viewtemp input[name="listtype"]').val(),'bizdate':$('.viewtemp #date').html(),'no':$('.viewtemp #listno input[name="consecnumber"]').val(),'date':$('.viewtemp #credate').val(),'index':index,'qty':qty,'inumber':inumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'linenumber':linenumber,'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
				//	dataType:'html',
				//	success:function(d){
				//		if(d.length>20||d.match('ERROR HINT: ')){
				//			$.ajax({
				//				url:'./lib/js/print.php',
				//				method:'post',
				//				data:{'html':'viewtemp-forall reprint.ajax.php '+d},
				//				dataType:'html',
				//				success:function(d){
				//					//console.log(d);
				//				},
				//				error:function(e){
				//					//console.log(e);
				//				}
				//			});
				//		}
				//		else{
				//		}
				//		//console.log(d);
				//		//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//		//2017/12/4mywin.document.title='cashdrawer';
				//	},
				//	error:function(e){
				//		//console.log(e);
				//	}
				//});
				verpsw.dialog('close');
			}
			else{
			}
		}*/
		else{
			$('.verpsw input[name="verpsw"]').val('');
			//alertmessage('密碼錯誤。');
			$('.alertmessage #text').html('密碼錯誤。');
			alertmessage.dialog('open');
		}
	});
	$('.verpsw #buttons').on('click','.input',function(event){
		//oneEvent(event);
		var index=$('.verpsw #buttons .input').index(this);
		$('.verpsw input[name="verpsw"]').val($('.verpsw input[name="verpsw"]').val()+$('.verpsw #buttons .input:eq('+index+')').val());
	});
	$('.verpsw #buttons').on('click','#change',function(event){
		//oneEvent(event);
		if($('.verpsw #buttons .input:eq(0)').val()=='7'){
			for(var i=0;i<12;i++){
				$('.verpsw #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)));
			}
			$('.verpsw #buttons .pre').prop('disabled',false);
			$('.verpsw #buttons .next').prop('disabled',false);
		}
		else{
			$('.verpsw #buttons .input:eq(0)').val('7');
			$('.verpsw #buttons .input:eq(1)').val('8');
			$('.verpsw #buttons .input:eq(2)').val('9');
			$('.verpsw #buttons .input:eq(3)').val('4');
			$('.verpsw #buttons .input:eq(4)').val('5');
			$('.verpsw #buttons .input:eq(5)').val('6');
			$('.verpsw #buttons .input:eq(6)').val('1');
			$('.verpsw #buttons .input:eq(7)').val('2');
			$('.verpsw #buttons .input:eq(8)').val('3');
			$('.verpsw #buttons .input:eq(9)').val('0');
			$('.verpsw #buttons .input:eq(10)').val('');
			$('.verpsw #buttons .input:eq(11)').val('');
			$('.verpsw #buttons .input:eq(0)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(1)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(2)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(3)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(4)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(5)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(6)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(7)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(8)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(9)').prop('disabled',false);
			$('.verpsw #buttons .input:eq(10)').prop('disabled',true);
			$('.verpsw #buttons .input:eq(11)').prop('disabled',true);
			$('.verpsw #buttons .pre').prop('disabled',true);
			$('.verpsw #buttons .next').prop('disabled',true);
		}
	});
	$('.verpsw #buttons').on('click','#next',function(event){
		//oneEvent(event);
		if($('.verpsw #buttons .input:eq(0)').val()=='A'){
			for(var i=0;i<12;i++){
				$('.verpsw #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(12)));
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
		else if($('.verpsw #buttons .input:eq(0)').val()=='M'){
			for(var i=0;i<2;i++){
				$('.verpsw #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(24)));
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',false);
			}
			for(var i=2;i<12;i++){
				$('.verpsw #buttons .input:eq('+i+')').val('');
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',true);
			}
		}
		else{
			for(var i=0;i<12;i++){
				$('.verpsw #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)));
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
	});
	$('.verpsw #buttons').on('click','#pre',function(event){
		//oneEvent(event);
		if($('.verpsw #buttons .input:eq(0)').val()=='A'){
			for(var i=0;i<2;i++){
				$('.verpsw #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(24)));
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',false);
			}
			for(var i=2;i<12;i++){
				$('.verpsw #buttons .input:eq('+i+')').val('');
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',true);
			}
		}
		else if($('.verpsw #buttons .input:eq(0)').val()=='M'){
			for(var i=0;i<12;i++){
				$('.verpsw #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)));
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
		else{
			for(var i=0;i<12;i++){
				$('.verpsw #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(12)));
				$('.verpsw #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
	});
	$('.verpsw #buttons').on('click','#ac',function(event){
		//oneEvent(event);
		$('.verpsw input[name="verpsw"]').val('');
	});
	var salelabel='';
	$('.salelist #list #listcontent').on('click','.label',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單選擇帳單品項','click');
		//oneEvent(event);
		var index=$('.salelist #list #listcontent .label').index(this);
		salelabel=index;
		if($('.salelist #list #listcontent .label:eq('+index+') input[name="order"]').val()=='－'){//2021/7/29 套餐品項
			for(var i=index-1;i>=0;i--){
				if($('.salelist #list #listcontent .label:eq('+i+') input[name="order"]').val()!='－'){
					if($('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label focus'){
						$('.salelist #list #listcontent .label:eq('+i+')').addClass( "check" );
						$('.salelist #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',true);
					}
					else if($('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label focus check'){
						//$('.salelist #list #listcontent .label:eq('+i+')').removeClass( "check" );
						//$('.salelist #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',false);//2021/7/29 套餐品項不勾選時，不連動套餐名稱的勾選狀態
					}
					else{
						$('.salelist #list #listcontent .label').removeClass( "focus" );
						$('.salelist #list #listcontent .label:eq('+i+')').addClass( "focus" );
					}
					break;
				}
				else{
				}
			}
		}
		else{
			if($('.salelist #list #listcontent .label:eq('+(index+1)+') input[name="order"]').length>0&&$('.salelist #list #listcontent .label:eq('+(index+1)+') input[name="order"]').val()=='－'){
				for(var i=index+1;i<$('.salelist #list #listcontent .label').length;i++){
					if($('.salelist #list #listcontent .label:eq('+i+') input[name="order"]').val()=='－'){
						if($('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label focus'){
							$('.salelist #list #listcontent .label:eq('+i+')').addClass( "check" );
							$('.salelist #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',true);
						}
						else if($('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label focus check'){
							$('.salelist #list #listcontent .label:eq('+i+')').removeClass( "check" );
							$('.salelist #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',false);
						}
						else{
							$('.salelist #list #listcontent .label').removeClass( "focus" );
							$('.salelist #list #listcontent .label:eq('+i+')').addClass( "focus" );
						}
					}
					else{
						break;
					}
				}
			}
			else{
			}
		}
		if($('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label focus'){
			$('.salelist #list #listcontent .label:eq('+index+')').addClass( "check" );
			$('.salelist #list #listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
		}
		else if($('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.salelist #list #listcontent .label:eq('+index+')').prop('class')=='label focus check'){
			$('.salelist #list #listcontent .label:eq('+index+')').removeClass( "check" );
			$('.salelist #list #listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
		}
		else{
			$('.salelist #list #listcontent .label').removeClass( "focus" );
			$('.salelist #list #listcontent .label:eq('+index+')').addClass( "focus" );
		}
	});
	$('.salelist #fun').on('click','#changecheck',function(event){
		console.log('1');
		//oneEvent(event);
		if($('.salelist #list #listcontent .label').length==$('.salelist #list #listcontent .label input[data-id^="checkbox"]:checked').length||$('.salelist #list #listcontent .label input[data-id^="checkbox"]:checked').length==0){
			if($('.salelist #list #listcontent .label input[data-id^="checkbox"]:checked').length>0){
				$('.salelist #list #listcontent .label input[data-id^="checkbox"]').prop('checked',false);
				$('.salelist #list #listcontent .label').removeClass('check');
			}
			else{
				$('.salelist #list #listcontent .label input[data-id^="checkbox"]').prop('checked',true);
				$('.salelist #list #listcontent .label').addClass('check');
			}
		}
		else{
			for(var i=0;i<$('.salelist #list #listcontent .label').length;i++){
				if($('.salelist #list #listcontent .label:eq('+i+') input[data-id^="checkbox"]').prop('checked')){
					$('.salelist #list #listcontent .label:eq('+i+') input[data-id^="checkbox"]').prop('checked',false);
					$('.salelist #list #listcontent .label').removeClass('check');
				}
				else{
					$('.salelist #list #listcontent .label:eq('+i+') input[data-id^="checkbox"]').prop('checked',true);
					$('.salelist #list #listcontent .label').addClass('check');
				}
			}
		}
	});
	$('.salelist').on('click','#reorder',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單修改帳單','click');
		//oneEvent(event);
		$('.salelist #reorder').prop('disabled',true);
		if($('.order#order .initsetting #voidsale').val()=='0'){
			//2022/4/20 增加作廢帳單二次確認流程，並自動帶入作廢密碼模擬不驗證密碼
			$('.checkdeletesale .bizdate').html($('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html());
			$('.checkdeletesale .saleno').html($('.salelist #salelist #salecontent .listitems#focus div:eq(1)').html());
			$('.checkdeletesale .consecnumber').html($('.salelist #salelist #salecontent .listitems#focus div:eq(2)').html());
			$('.checkdeletesale .invoicenumber').html($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html());
			$('.checkdeletesale .money').html($('.salelist #salelist #salecontent .listitems#focus div:eq(5)').html());
			$('.checkdeletesale input[name="type"]').val('editlist');
			$('.checkdeletesale input[name="psw"]').val($('.order#order .companydata #voidpw').val());
			checkdeletesale.dialog('open');
			$('.salelist #reorder').prop('disabled',false);
			
			//2022/4/21 自動將密碼帶入，模擬不驗證密碼
			/*var nowbizdate=$('.salelist #date').html();
			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'reorder checkopen.ajax.php '+d},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
					//console.log(d);
					if(d=='success'){
						if($('.salelist #date').html()!=''){
							var listtype='';
							var tabnum='';
							var consecnumber='';
							if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
								//console.log('void inv');
								var hint=confirm('該帳單已開發票，如要修改請確認發票正本已收回。');
								if(hint==true){
									if($('.nidin #usenidin').length>0){
										nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
									}
									else{
									}
									$.ajax({//作廢帳單
										url:'./lib/js/salevoid.ajax.php',
										method:'post',
										data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
										dataType:'html',
										success:function(d){
											//console.log(d);
											if(d.length>20||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'reorder salevoid.ajax.php '+d},
													dataType:'html',
													success:function(d){
														console.log(d);
													},
													error:function(e){
														console.log(e);
													}
												});
											}
											else{
											}
											if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
												var memtype='online';
											}
											else{
												var memtype='offline';
											}
											var memberapi='';
											$.ajax({
												url:'./lib/js/searchmember.pointmoney.ajax.php',
												method:'post',
												async:false,
												data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d[0].length==0){
													}
													else{
														if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
															if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
																if(memberapi[0]['state']=='success'){
																	$.ajax({
																		url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
																		method:'post',
																		async:false,
																		data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		}
																	});
																}
																else{
																}
																$.ajax({
																	url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
																	method:'post',
																	async:false,
																	data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	},
																	error:function(e){
																		//console.log(e);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	}
																});
															}
															else{
															}
														}
														else{
															if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
																$.ajax({
																	url:'../memberapi/point_money.ajax.php',
																	method:'post',
																	async:false,
																	data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
																	dataType:'json',
																	timeout:5000,
																	success:function(d){
																		memberapi=d;
																		//console.log(res);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	},
																	error:function(e,t){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																		if(t==="timeout"){
																			memberapi=[{"state":"fail","message":"AJAX timeout"}];
																		}
																		else{
																			memberapi=e;
																		}
																	}
																});
																//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
																if(memberapi[0]['state']=='success'){
																	$.ajax({
																		url:'../memberapi/change.memberdata.php',
																		method:'post',
																		async:false,
																		data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		}
																	});
																}
																else{
																}
																$.ajax({
																	url:'../memberapi/insertmemlist.ajax.php',
																	method:'post',
																	async:false,
																	data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	},
																	error:function(e){
																		//console.log(e);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	}
																});
															}
															else{
															}
														}
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
											if(d.substr(0,7)=='success'){
												$.ajax({
													url:'./lib/js/getinvname.ajax.php',
													method:'post',
													async:false,
													data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
													dataType:'json',
													success:function(d){
														//console.log(d);
														if(d=='dbempty'){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'reinv getinvname.ajax.php dbempty'},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																	}
															});
														}
														else{
															$.ajax({
																url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
																method:'post',
																async:false,
																data:{'invfile':d[1]},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																	if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																		$.ajax({
																			url:'./lib/js/reinv.ajax.php',
																			method:'post',
																			async:false,
																			data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
																			dataType:'html',
																			success:function(d){
																				//console.log(d);
																				if(d.length>20||d.match('ERROR HINT: ')){
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'creditcard reinv.ajax.php '+d},
																						dataType:'html',
																						success:function(d){
																							console.log(d);
																						},
																						error:function(e){
																							console.log(e);
																						}
																					});
																				}
																				else{
																				}
																			},
																			error:function(e){
																				//console.log(e);
																			}
																		});
																	}
																	else{
																	}
																	$.ajax({//作廢發票
																		url:'./lib/js/deleteinv.ajax.php',
																		method:'post',
																		data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
																		dataType:'html',
																		success:function(d){
																			if(d.length>40||d.match('ERROR HINT: ')){
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'reorder deleteinv.ajax.php '+d},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			}
																			else{
																			}
																			//console.log(d);
																			//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																			//2017/12/29mywin.document.title='cashdrawer';
																		},
																		error:function(e){
																			//console.log(e);
																		}
																	});
																},
																error:function(e){
																	//console.log(e);
																}
															});
														}
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
											else{
												//console.log(d);
											}
											$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
												url:'./lib/js/copysale.ajax.php',
												method:'post',
												data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
												dataType:'html',
												success:function(d){
													if(d.length>30||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'reorder copysale.ajax.php '+d},
															dataType:'html',
															success:function(d){
																console.log(d);
															},
															error:function(e){
																console.log(e);
															}
														});
													}
													else{
													}
													var t=d.split('-');
													//console.log(t);
													listtype=t[t.length-3];
													bizdate=t[t.length-2];
													consecnumber=t[t.length-1];
													//console.log(d);

													temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
													//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
													$('.salelist #editpay').prop('disabled',true);
													$('.salelist #reorder').prop('disabled',true);
													$('.salelist #reinv').prop('disabled',true);
													$('.salelist #rekvm').prop('disabled',true);
													$('.salelist #salelist #salecontent .listitems').prop('id','');
													$('.salelist #listno').html('');
													$('.salelist #list #listcontent').html('');
													$('.salelist #date').html('');
													$('.salelist #credate').html('');
													$('.salelist #fun button#forall').prop('disabled',true);
													$('.salelist #fun button#list').prop('disabled',true);
													$('.salelist #fun button#tag').prop('disabled',true);
													$('.salelist #fun button#kitchen').prop('disabled',true);
													$('.salelist #fun button#changecheck').prop('disabled',true);
													salelist.dialog('close');
													if($('.funbox').length>0&&funbox.dialog('isOpen')){
														funbox.dialog('close');
														inittable.dialog('close');
													}
													else{
															//console.log('e5');
													}
													if(!$('.order#order #billfun #billfun1button').prop('disabled')){
														$('.order#order #billfun #billfun1button').trigger('click');
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
									$('.salelist #reorder').prop('disabled',false);
								}
							}
							else{
								if($('.nidin #usenidin').length>0){
									nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
								}
								else{
								}
								$.ajax({//作廢帳單
									url:'./lib/js/salevoid.ajax.php',
									method:'post',
									data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
									dataType:'html',
									success:function(d){
										if(d.length>20||d.match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reorder salevoid.ajax.php '+d},
												dataType:'html',
												success:function(d){
													console.log(d);
												},
												error:function(e){
													console.log(e);
												}
											});
										}
										else{
										}
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											var memtype='online';
										}
										else{
											var memtype='offline';
										}
										//console.log(memtype);
										var memberapi='';
										$.ajax({
											url:'./lib/js/searchmember.pointmoney.ajax.php',
											method:'post',
											async:false,
											data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d[0].length==0){
												}
												else{
													if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
														if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
															memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
															if(memberapi[0]['state']=='success'){
																$.ajax({
																	url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
																	method:'post',
																	async:false,
																	data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	},
																	error:function(e){
																		//console.log(e);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	}
																});
															}
															else{
															}
															$.ajax({
																url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
																method:'post',
																async:false,
																data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																},
																error:function(e){
																	//console.log(e);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
															});
														}
														else{
														}
													}
													else{
														if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
															$.ajax({
																url:'../memberapi/point_money.ajax.php',
																method:'post',
																async:false,
																data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
																dataType:'json',
																timeout:5000,
																success:function(d){
																	memberapi=d;
																	//console.log(res);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																},
																error:function(e,t){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																	if(t==="timeout"){
																		memberapi=[{"state":"fail","message":"AJAX timeout"}];
																	}
																	else{
																		memberapi=e;
																	}
																}
															});
															//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
															if(memberapi[0]['state']=='success'){
																$.ajax({
																	url:'../memberapi/change.memberdata.php',
																	method:'post',
																	async:false,
																	data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	},
																	error:function(e){
																		//console.log(e);
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	}
																});
															}
															else{
															}
															$.ajax({
																url:'../memberapi/insertmemlist.ajax.php',
																method:'post',
																async:false,
																data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																},
																error:function(e){
																	//console.log(e);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
															});
														}
														else{
														}
													}
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
										if(d.substr(0,7)=='success'){
											$.ajax({
												url:'./lib/js/getinvname.ajax.php',
												method:'post',
												async:false,
												data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d=='dbempty'){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'reinv getinvname.ajax.php dbempty'},
															dataType:'html',
															success:function(d){
																console.log(d);
															},
															error:function(e){
																console.log(e);
															}
														});
													}
													else{
														$.ajax({
															url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
															method:'post',
															async:false,
															data:{'invfile':d[1]},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																	$.ajax({
																		url:'./lib/js/reinv.ajax.php',
																		method:'post',
																		async:false,
																		data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			if(d.length>20||d.match('ERROR HINT: ')){
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'creditcard reinv.ajax.php '+d},
																					dataType:'html',
																					success:function(d){
																						console.log(d);
																					},
																					error:function(e){
																						console.log(e);
																					}
																				});
																			}
																			else{
																			}
																		},
																		error:function(e){
																			//console.log(e);
																		}
																	});
																}
																else{
																}
																$.ajax({//作廢發票
																	url:'./lib/js/deleteinv.ajax.php',
																	method:'post',
																	data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
																	dataType:'html',
																	success:function(d){
																		if(d.length>40||d.match('ERROR HINT: ')){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'reorder deleteinv.ajax.php '+d},
																				dataType:'html',
																				success:function(d){
																					console.log(d);
																				},
																				error:function(e){
																					console.log(e);
																				}
																			});
																		}
																		else{
																		}
																		//console.log(d);
																		//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																		//2017/12/29mywin.document.title='cashdrawer';
																	},
																	error:function(e){
																		//console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
											//console.log(d);
										}
										$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
											url:'./lib/js/copysale.ajax.php',
											method:'post',
											data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
											dataType:'html',
											success:function(d){
												if(d.length>30||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'reorder copysale.ajax.php '+d},
														dataType:'html',
														success:function(d){
															console.log(d);
														},
														error:function(e){
															console.log(e);
														}
													});
												}
												else{
												}
												var t=d.split('-');
												//console.log(t);
												listtype=t[t.length-3];
												bizdate=t[t.length-2];
												consecnumber=t[t.length-1];
												//console.log(d);

												temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
												//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
												$('.salelist #editpay').prop('disabled',true);
												$('.salelist #reorder').prop('disabled',true);
												$('.salelist #reinv').prop('disabled',true);
												$('.salelist #rekvm').prop('disabled',true);
												$('.salelist #salelist #salecontent .listitems').prop('id','');
												$('.salelist #listno').html('');
												$('.salelist #list #listcontent').html('');
												$('.salelist #date').html('');
												$('.salelist #credate').html('');
												$('.salelist #fun button#forall').prop('disabled',true);
												$('.salelist #fun button#list').prop('disabled',true);
												$('.salelist #fun button#tag').prop('disabled',true);
												$('.salelist #fun button#kitchen').prop('disabled',true);
												$('.salelist #fun button#changecheck').prop('disabled',true);
												salelist.dialog('close');
												if($('.funbox').length>0&&funbox.dialog('isOpen')){
													funbox.dialog('close');
													inittable.dialog('close');
												}
												else{
															//console.log('e6');
												}
												if(!$('.order#order #billfun #billfun1button').prop('disabled')){
													$('.order#order #billfun #billfun1button').trigger('click');
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
						}
						else{
						}
						$.ajax({
							url:'./lib/js/create.cmdtxt.php',
							method:'post',
							async: false,
							data:{'cmd':nowbizdate.substr(0,6)+'-change'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
						$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		}
		else{
			//console.log('1');
			//2022/4/20 增加作廢帳單二次確認流程
			//$('.verpsw input[name="type"]').val('editlist');
			//verpsw.dialog('open');
			$('.checkdeletesale .bizdate').html($('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html());
			$('.checkdeletesale .saleno').html($('.salelist #salelist #salecontent .listitems#focus div:eq(1)').html());
			$('.checkdeletesale .consecnumber').html($('.salelist #salelist #salecontent .listitems#focus div:eq(2)').html());
			$('.checkdeletesale .invoicenumber').html($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html());
			$('.checkdeletesale .money').html($('.salelist #salelist #salecontent .listitems#focus div:eq(5)').html());
			$('.checkdeletesale input[name="type"]').val('editlist');
			$('.checkdeletesale input[name="psw"]').val('');
			checkdeletesale.dialog('open');
			$('.salelist #reorder').prop('disabled',false);
		}
	});
	$('.salelist').on('click','#editpay',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單修改付款','click');
		//oneEvent(event);
		$('.salelist #editpay').prop('disabled',true);
		if($('.order#order .initsetting #cashbut').val()=='1'&&$('.order#order .initsetting #nccc').val()=='0'){//2022/5/6 並解沒有串接聯合信用卡中心，才能在修改付款中修改紀錄//開啟信用卡
			$('.editpay #cashbut').prop('disabled',false);
		}
		else{
			$('.editpay #cashbut').prop('disabled',true);
		}
		$.ajax({
			url:'./lib/js/checkopen.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'editpay checkopen.ajax.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//console.log(d);
				if(d=='success'){
					$.ajax({
						url:'./lib/js/getpay.ajax.php',
						method:'post',
						async: false,
						data:{'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
						dataType:'html',
						success:function(d){
							if(d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'editpay getpay.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							var temp=d.split("－");
							var otherfix=0;
							//console.log(d);
							$('.editpay #viewwindow input[name="bizdate"]').val(temp[temp.length-3]);
							$('.editpay #viewwindow input[name="consecnumber"]').val(temp[temp.length-2]);
							$('.editpay #viewwindow input[name="usercode"]').val($('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val());
							$('.editpay #viewwindow input[name="username"]').val($('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
							$('.editpay #viewwindow #should').html(temp[0]);
							$('.editpay #viewwindow input[name="should"]').val(temp[0]);
							$('.editpay #viewwindow #cashcomm').html(temp[4]);
							$('.editpay #viewwindow input[name="cashcomm"]').val(temp[4]);
							$('.editpay #viewwindow #already').html(Number(temp[0])+Number(temp[4]));
							$('.editpay #viewwindow input[name="already"]').val(Number(temp[0])+Number(temp[4]));
							$('.editpay #viewwindow #cashmoney').html(temp[1]);
							$('.editpay #viewwindow input[name="cashmoney"]').val(temp[1]);
							$('.editpay #viewwindow #cash').html(temp[2]);
							$('.editpay #viewwindow input[name="cash"]').val(temp[2]);
							//console.log(temp);
							for(var i=5;i<(temp.length-5);i++){
								var payname=temp[i].split(":");
								if(payname[1]=='0'){
								}
								else{
									if($('.paywindow #'+payname[0]+' input[name="type"]').val()=='2'){
										if(payname[1].match("=")){
											var tempmoney=payname[1].split("=");
											otherfix=Number(otherfix)+Number(tempmoney[1]);
										}
										else{
											//console.log(payname[1]);
											//var tempmoney=payname[1].split("=");
											//otherfix=Number(otherfix)+Number(tempmoney[1]);
										}
									}
									else{
									}
								}
							}
							$('.editpay #viewwindow #other').html(Number(temp[3])-Number(otherfix));
							$('.editpay #viewwindow input[name="other"]').val(temp[3]-Number(otherfix));
							$('.editpay #viewwindow #otherfix').html(Number(otherfix));
							$('.editpay #viewwindow input[name="otherfix"]').val(Number(otherfix));
							$('.editpay #viewwindow #nontax').val(temp[temp.length-5]);
							if(Number(temp[1])>0){
								$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.editpay #moneybut').html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paymoney'>"+temp[1]+"</span>"+$('.result .unit').val()+"</div></div></div>");
							}
							else{
							}
							if(Number(temp[2])>0){
								$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.editpay #cashbut').html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paycash'>"+temp[2]+"</span>"+$('.result .unit').val()+"<input type='hidden' id='inputmoney' value='"+(Number(temp[2])-Number(temp[4]))+"'><input type='hidden' class='commission' value='"+temp[4]+"'></div></div></div>");
							}
							else{
							}
							if(Number(temp[3])>0){
								//console.log(temp);
								for(var i=0;i<10;i++){
									var sptemp=temp[5+Number(i)].split(":");
									if(sptemp[1].match("=")){
										var pointmoney=sptemp[1].split("=");
										$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.paywindow #'+sptemp[0]).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='otherpay' id='"+$('.paywindow #'+sptemp[0]+' input[name="location"]').val()+"-"+sptemp[0]+"'>"+pointmoney[0]+"<input type='hidden' name='initview' value='"+pointmoney[0]+"'><input type='hidden' name='viewmoney' value='"+pointmoney[1]+"'><input type='hidden' name='inv' value='"+$('.paywindow #'+sptemp[0]+' input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.paywindow #'+sptemp[0]+' input[name="type"]').val()+"'></span>"+$('.result .unit').val()+"</div></div></div>");
										if($('.editpay #viewwindow input[name="otherstring"]').val()==''||$('.editpay #viewwindow input[name="otherstring"]').val()=='0'){
											$('.editpay #viewwindow input[name="otherstring"]').val($('.paywindow #'+sptemp[0]+' input[name="location"]').val()+"-"+sptemp[0]+":"+sptemp[1]);
										}
										else{
											$('.editpay #viewwindow input[name="otherstring"]').val($('.editpay #viewwindow input[name="otherstring"]').val()+","+$('.paywindow #'+sptemp[0]+' input[name="location"]').val()+"-"+sptemp[0]+":"+sptemp[1]);
										}
									}
									else if(Number(sptemp[1])>0){
										$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.paywindow #'+sptemp[0]).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='otherpay' id='"+$('.paywindow #'+sptemp[0]+' input[name="location"]').val()+"-"+sptemp[0]+"'>"+sptemp[1]+"<input type='hidden' name='initview' value='"+sptemp[1]+"'><input type='hidden' name='viewmoney' value='"+sptemp[1]+"'><input type='hidden' name='inv' value='"+$('.paywindow #'+sptemp[0]+' input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.paywindow #'+sptemp[0]+' input[name="type"]').val()+"'></span>"+$('.result .unit').val()+"</div></div></div>");
										if($('.editpay #viewwindow input[name="otherstring"]').val()==''||$('.editpay #viewwindow input[name="otherstring"]').val()=='0'){
											$('.editpay #viewwindow input[name="otherstring"]').val($('.paywindow #'+sptemp[0]+' input[name="location"]').val()+"-"+sptemp[0]+":"+sptemp[1]);
										}
										else{
											$('.editpay #viewwindow input[name="otherstring"]').val($('.editpay #viewwindow input[name="otherstring"]').val()+","+$('.paywindow #'+sptemp[0]+' input[name="location"]').val()+"-"+sptemp[0]+":"+sptemp[1]);
										}
									}
									else{
									}
								}
								for(var i=15;i<(temp.length-5);i++){
									var payname=temp[i].split(":");
									//console.log(temp[i]);
									if(payname[1].match("=")){
										var pointmoney=payname[1].split("=");
										if(payname[1]=='0'){
										}
										else{
											$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.paywindow .'+payname[0]).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='otherpay' id='"+$('.paywindow .'+payname[0]+' input[name="location"]').val()+"-value'>"+pointmoney[0]+"<input type='hidden' name='initview' value='"+pointmoney[0]+"'><input type='hidden' name='viewmoney' value='"+pointmoney[1]+"'><input type='hidden' name='inv' value='"+$('.paywindow .'+payname[0]+' input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.paywindow .'+payname[0]+' input[name="type"]').val()+"'></span>"+$('.result .unit').val()+"</div></div></div>");
											if($('.editpay #viewwindow input[name="otherstring"]').val()==''||$('.editpay #viewwindow input[name="otherstring"]').val()=='0'){
												$('.editpay #viewwindow input[name="otherstring"]').val(payname[0]+"-value"+":"+pointmoney[0]+"="+pointmoney[1]);
											}
											else{
												$('.editpay #viewwindow input[name="otherstring"]').val($('.editpay #viewwindow input[name="otherstring"]').val()+","+payname[0]+"-value"+":"+pointmoney[0]+"="+pointmoney[1]);
											}
										}
									}
									else if(payname[0]=='intella'){//英特拉付款
										var intellabox=payname[1].split(",");
										if(payname[1]=='0'||payname[1]==''){
										}
										else{
											$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.result #funbox .intellapay').html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+intellabox[1]+"'>"+intellabox[2]+"<input type='hidden' name='viewmoney' value='"+intellabox[2]+"'></span>"+$('.result .unit').val()+"</div></div></div>");
											if($('.editpay #viewwindow input[name="otherstring"]').val()==''||$('.editpay #viewwindow input[name="otherstring"]').val()=='0'){
												$('.editpay #viewwindow input[name="otherstring"]').val("intellaother-"+intellabox[1]+":"+intellabox[2]);
											}
											else{
												$('.editpay #viewwindow input[name="otherstring"]').val($('.editpay #viewwindow input[name="otherstring"]').val()+",intellaother-"+intellabox[1]+":"+intellabox[2]);
											}
										}
									}
									else if(payname[0]=='nidin'){//nidin付款
										var nidinbox=payname[1].split(",");
										if(nidinbox[2]==10){//2021/3/11 nidin線上付款
											for(var nidinmethod=3;nidinmethod<nidinbox.length;nidinmethod=nidinmethod+2){
												$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>Nidin</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='nidinother' id='"+nidinbox[nidinmethod]+"'>"+nidinbox[nidinmethod+1]+"<input type='hidden' name='viewmoney' value='"+nidinbox[nidinmethod+1]+"'></span>"+$('.result .unit').val()+"</div></div></div>");
												if($('.editpay #viewwindow input[name="otherstring"]').val()==''||$('.editpay #viewwindow input[name="otherstring"]').val()=='0'){
													$('.editpay #viewwindow input[name="otherstring"]').val("nidinother-"+nidinbox[nidinmethod]+":"+nidinbox[nidinmethod+1]);
												}
												else{
													$('.editpay #viewwindow input[name="otherstring"]').val($('.editpay #viewwindow input[name="otherstring"]').val()+",nidinother-"+nidinbox[nidinmethod]+":"+nidinbox[nidinmethod+1]);
												}
											}
										}
										else{//if(nidinbox[2]==50)//2021/3/11 pos付款
										}
										/*if(payname[1]=='0'||payname[1]==''){
										}
										else{
											$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>Nidin</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='nidinother' id='"+intellabox[1]+"'>"+intellabox[2]+"<input type='hidden' name='viewmoney' value='"+intellabox[2]+"'></span>"+$('.result .unit').val()+"</div></div></div>");
											if($('.editpay #viewwindow input[name="otherstring"]').val()==''||$('.editpay #viewwindow input[name="otherstring"]').val()=='0'){
												$('.editpay #viewwindow input[name="otherstring"]').val("intellaother-"+intellabox[1]+":"+intellabox[2]);
											}
											else{
												$('.editpay #viewwindow input[name="otherstring"]').val($('.editpay #viewwindow input[name="otherstring"]').val()+",intellaother-"+intellabox[1]+":"+intellabox[2]);
											}
										}*/
									}
								}
								if(Number(temp[temp.length-5])>0){
									$('.editpay #viewwindow #editpaywindow #paycontent').append("<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.paywindow #NONTAX').html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='otherpay' id='NONTAX'>"+temp[temp.length-5]+"</span>"+$('.result .unit').val()+"</div></div></div>");
									if($('.editpay #viewwindow input[name="otherstring"]').val()==''||$('.editpay #viewwindow input[name="otherstring"]').val()=='0'){
										$('.editpay #viewwindow input[name="otherstring"]').val("NONTAX:"+temp[temp.length-5]);
									}
									else{
										$('.editpay #viewwindow input[name="otherstring"]').val($('.editpay #viewwindow input[name="otherstring"]').val()+",NONTAX:"+temp[temp.length-5]);
									}
								}
								else{
								}
							}
							else{
							}
							editpay.dialog('open');
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
					$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
					alertmessage.dialog('open');
					$('.salelist #editpay').prop('disabled',false);
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
		$('.salelist #editpay').prop('disabled',false);
	});
	$('.salelist #fun').on('click','#forall',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單重印','click');
		//oneEvent(event);
		if($('.order#order .initsetting #voidsale').val()=='1'){
			$('.verpsw input[name="type"]').val('sale_reprint_all');
			verpsw.dialog('open');
		}
		else{
			var index='';
			var qty='';
			var inumber='';
			var linenumber='';
			for(var i=0;i<$('.salelist #list #listcontent .label').length;i++){
				if(index.length==0){
					index=index+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
				else{
					index=index+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
			}
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'','memname':$('.salelist #membername').html(),'memtel':$('.salelist #membertel').html() },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.list.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.list.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'' },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.tag.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.tag.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.kitchen.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.kitchen.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			/*$.ajax({
				url:'./lib/js/reprint.ajax.php',
				method:'post',
				data:{'company':$('.order#order .companydata #company').val(),'type':'all','listtype':$('.salelist input[name="listtype"]').val(),'no':$('.salelist #listno input[name="consecnumber"]').val(),'bizdate':$('.salelist #date').html(),'date':$('.salelist #credate').val(),'index':index,'qty':qty,'inumber':inumber,'linenumber':linenumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'reprint-forall reprint.ajax.php '+d},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
					//2017/12/4mywin.document.title='cashdrawer';
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		}
	});
	$('.salelist #fun').on('click','#list',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單重印明細單','click');
		//oneEvent(event);
		var index='';
		var qty='';
		$.ajax({
			url:'./lib/js/reprint.transdata.ajax.php',
			method:'post',
			data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'','memname':$('.salelist #membername').html(),'memtel':$('.salelist #membertel').html() },
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/create.list.php',
					method:'post',
					async: false,
					data:d,
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.list.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			},
			error:function(e){
				console.log(e);
			}
		});
		/*$.ajax({
			url:'./lib/js/reprint.ajax.php',
			method:'post',
			data:{'type':'list','no':$('.salelist #listno input[name="consecnumber"]').val(),'bizdate':$('.salelist #date').html(),'date':$('.salelist #credate').val(),'listtype':$('.viewtemp #listno input[name="listtype"]').val(),'index':index,'qty':qty,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'reprint-list reprint.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//2017/12/4mywin.document.title='cashdrawer';
			},
			error:function(e){
				//console.log(e);
			}
		});*/
	});
	$('.salelist #fun').on('click','#tag',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單重印貼紙','click');
		//oneEvent(event);
		var index='';
		var qty='';
		var linenumber='';
		for(var i=0;i<$('.salelist #list #listcontent .label').length;i++){
			if($('.salelist #list #listcontent .label:eq('+i+') input[data-id="checkbox[]"]').prop('checked')){
				if(index.length==0){
					index=index+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val()+','+('00'+(Number($('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1)).substr(3-(Number($('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1).length);
					qty=qty+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					linenumber=linenumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
				else{
					index=index+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val()+','+('00'+(Number($('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1)).substr(3-(Number($('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1).length);
					qty=qty+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					linenumber=linenumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
			}
			else{
			}
		}
		$.ajax({
			url:'./lib/js/reprint.transdata.ajax.php',
			method:'post',
			data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'' },
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/create.tag.php',
					method:'post',
					async: false,
					data:d,
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.list.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			},
			error:function(e){
				console.log(e);
			}
		});
		/*$.ajax({
			url:'./lib/js/reprint.ajax.php',
			method:'post',
			data:{'type':'tag','no':$('.salelist #listno input[name="consecnumber"]').val(),'bizdate':$('.salelist #date').html(),'date':$('.salelist #credate').val(),'index':index,'qty':qty,'linenumber':linenumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'reprint-tag reprint.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//2017/12/4mywin.document.title='cashdrawer';
			},
			error:function(e){
				//console.log(e);
			}
		});*/
	});
	$('.salelist #fun').on('click','#kitchen',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單重印工作單','click');
		//oneEvent(event);
		var inumber='';
		var qty='';
		var index='';
		var linenumber='';
		for(var i=0;i<$('.salelist #list #listcontent .label').length;i++){
			if($('.salelist #list #listcontent .label:eq('+i+') input[data-id="checkbox[]"]').prop('checked')){
				if(inumber.length==0){
					index=index+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
					inumber=inumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					qty=qty+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					linenumber=linenumber+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
				else{
					index=index+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(1)').html();
					inumber=inumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					qty=qty+','+$('.salelist #list #listcontent .label:eq('+i+') div:eq(4)').html();
					linenumber=linenumber+','+$('.salelist #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
			}
			else{
			}
		}
		$.ajax({
			url:'./lib/js/reprint.transdata.ajax.php',
			method:'post',
			data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.salelist #listno input[name="listtype"]').val(), "consecnumber":$('.salelist #listno input[name="consecnumber"]').val(), "bizdate":$('.salelist #date').html(), "credate":$('.salelist #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'kitchen','saletype':'' },
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/create.kitchen.php',
					method:'post',
					async: false,
					data:d,
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.list.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			},
			error:function(e){
				console.log(e);
			}
		});
		/*$.ajax({
			url:'./lib/js/reprint.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'type':'kitchen','listtype':$('.salelist input[name="listtype"]').val(),'no':$('.salelist #listno input[name="consecnumber"]').val(),'bizdate':$('.salelist #date').html(),'date':$('.salelist #credate').val(),'inumber':inumber,'qty':qty,'index':index,'linenumber':linenumber,'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'reprint-kitchen reprint.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//2017/12/4mywin.document.title='cashdrawer';
			},
			error:function(e){
				//console.log(e);
			}
		});*/
	});
	$('.salelist #fun').on('click','#prebizdate',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單切換營業日',$(this).find('#name1').html());
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/get.bizdate.ajax.php',
			method:'post',
			async:false,
			data:{'bizdate':$('.salelist #salelist #salecontent #bizdate').val(),'type':'-','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.salelist .viewbizdate').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'bizdate':$('.salelist #salelist #salecontent #bizdate').val(),'type':'-','sale':'sale','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.salelist #salelist #salecontent').html(d);
				$('.salelist #listno').html('');
				$('.salelist #list #listcontent').html('');
				$('.salelist #date').html('');
				$('.salelist #credate').html('');
				$('.salelist #fun #tag').prop('disabled',true);
				$('.salelist #fun button#list').prop('disabled',true);
				$('.salelist #fun #kitchen').prop('disabled',true);
				$('.salelist #fun #forall').prop('disabled',true);
				$('.salelist #fun #changecheck').prop('disabled',true);
				$('.salelist #rightnow #ttmoney').html($('.salelist #salelist input[name="ttmoney"]').val());
				$('.salelist #rightnow #ttcount').html($('.salelist #salelist input[name="ttcount"]').val());
				$('.salelist #rightnow #voidmoney').html($('.salelist #salelist input[name="voidmoney"]').val());
				$('.salelist #rightnow #voidcount').html($('.salelist #salelist input[name="voidcount"]').val());
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.salelist #fun').on('click','#nextbizdate',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('瀏覽帳單切換營業日',$(this).find('#name1').html());
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/get.bizdate.ajax.php',
			method:'post',
			async:false,
			data:{'bizdate':$('.salelist #salelist #salecontent #bizdate').val(),'type':'+','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.salelist .viewbizdate').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'bizdate':$('.salelist #salelist #salecontent #bizdate').val(),'type':'+','sale':'sale','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.salelist #salelist #salecontent').html(d);
				$('.salelist #listno').html('');
				$('.salelist #list #listcontent').html('');
				$('.salelist #date').html('');
				$('.salelist #credate').html('');
				$('.salelist #fun #tag').prop('disabled',true);
				$('.salelist #fun button#list').prop('disabled',true);
				$('.salelist #fun #kitchen').prop('disabled',true);
				$('.salelist #fun #forall').prop('disabled',true);
				$('.salelist #fun #changecheck').prop('disabled',true);
				$('.salelist #rightnow #ttmoney').html($('.salelist #salelist input[name="ttmoney"]').val());
				$('.salelist #rightnow #ttcount').html($('.salelist #salelist input[name="ttcount"]').val());
				$('.salelist #rightnow #voidmoney').html($('.salelist #salelist input[name="voidmoney"]').val());
				$('.salelist #rightnow #voidcount').html($('.salelist #salelist input[name="voidcount"]').val());
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.salelist #fun').on('click','#exit',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('關閉瀏覽帳單','click');
		//oneEvent(event);
		$('.salelist #editpay').prop('disabled',true);
		$('.salelist #reorder').prop('disabled',true);
		$('.salelist #reinv').prop('disabled',true);
		$('.salelist #rekvm').prop('disabled',true);
		$('.salelist #salelist #salecontent .listitems').prop('id','');
		$('.salelist #listno').html('');
		$('.salelist #list #listcontent').html('');
		$('.salelist #date').html('');
		$('.salelist #credate').html('');
		$('.salelist #fun button#forall').prop('disabled',true);
		$('.salelist #fun button#list').prop('disabled',true);
		$('.salelist #fun button#tag').prop('disabled',true);
		$('.salelist #fun button#kitchen').prop('disabled',true);
		$('.salelist #fun button#changecheck').prop('disabled',true);
		salelist.dialog('close');
	});
	function editpaycomchange(){//計算找零金額
		var precision=$('.order#order .initsetting #accuracy').val();
		editpaycomalready();
		/*if(Number($('.result #viewwindow #total').html())<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
			var temp=Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
		}
		else{*/
			var temp=Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html());
		//}
		if(temp-Number($('.editpay #viewwindow #already').html())<=0){
			$('.editpay #viewwindow #notyet').html('0');
		}
		else{
			$('.editpay #viewwindow #notyet').html(temp-Number($('.editpay #viewwindow #already').html()));
		}
		/*if(Number($('.editpay #viewwindow #already').html())-temp<=0){
			$('.editpay #viewwindow #change').html('0');
		}
		else{
			$('.editpay #viewwindow #change').html(Number($('.editpay #viewwindow #already').html())-temp);
		}*/
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.editpay #viewwindow #notyet').html( roundfun($('.editpay #viewwindow #notyet').html(),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.editpay #viewwindow #notyet').html( ceilfun($('.editpay #viewwindow #notyet').html(),precision));
		}
		else{//無條件捨去
			$('.editpay #viewwindow #notyet').html( floorfun($('.editpay #viewwindow #notyet').html(),precision));
		}
		//計算找零金
		if(Number($('.editpay #viewwindow #otherfix').html())==0){//無不找零支付方式
			if(Number($('.editpay #viewwindow #already').html())-temp<=0){
				$('.editpay #viewwindow #change').html('0');
			}
			else{
				$('.editpay #viewwindow #change').html(Number($('.editpay #viewwindow #already').html())-temp);
			}
		}
		else{//有利用到不找零支付方式
			if(Number($('.editpay #viewwindow #otherfix').html())<=Number(temp)){//不找零支付方式所支付之金額不大於應收金額，因此還需要找零
				if(Number($('.editpay #viewwindow #already').html())-temp<=0){
					$('.editpay #viewwindow #change').html('0');
				}
				else{
					$('.editpay #viewwindow #change').html(Number($('.editpay #viewwindow #already').html())-temp);
				}
			}
			else{
				$('.editpay #viewwindow #change').html(Number($('.editpay #viewwindow #already').html())-Number($('.editpay #viewwindow #otherfix').html()));
			}
		}
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			$('.editpay #viewwindow #change').html( roundfun($('.editpay #viewwindow #change').html(),precision));
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			$('.editpay #viewwindow #change').html( ceilfun($('.editpay #viewwindow #change').html(),precision));
		}
		else{//無條件捨去
			$('.editpay #viewwindow #change').html( floorfun($('.editpay #viewwindow #change').html(),precision));
		}
	};
	function editpaycomalready(){//計算已付金額
		var pay=0;
		var money=0;
		var cash=0;
		var commission=0;
		var other=0;
		var otherfix=0;
		var tempstring={};
		var otherstring='';
		var precision=$('.order#order .initsetting #accuracy').val();
		for(var i=0;i<$('.editpay #viewwindow #editpaywindow .paymoney').length;i++){//計算已付現金
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .paymoney:eq('+i+')').html()),precision);
				money=roundfun(Number(money)+Number($('.editpay #viewwindow #editpaywindow .paymoney:eq('+i+')').html()),precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .paymoney:eq('+i+')').html()),precision);
				money=ceilfun(Number(money)+Number($('.editpay #viewwindow #editpaywindow .paymoney:eq('+i+')').html()),precision);
			}
			else{//無條件捨去
				pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .paymoney:eq('+i+')').html()),precision);
				money=floorfun(Number(money)+Number($('.editpay #viewwindow #editpaywindow .paymoney:eq('+i+')').html()),precision);
			}
		}
		for(var i=0;i<$('.editpay #viewwindow #editpaywindow .paycash').length;i++){//計算已付信用卡與手續費
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .paycash:eq('+i+')').html()),precision);
				cash=roundfun(Number(cash)+Number($('.editpay #viewwindow #editpaywindow .paycash:eq('+i+')').html()),precision);
				commission=roundfun(Number(commission)+Number($('.editpay #viewwindow #editpaywindow .commission:eq('+i+')').val()),precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .paycash:eq('+i+')').html()),precision);
				cash=ceilfun(Number(cash)+Number($('.editpay #viewwindow #editpaywindow .paycash:eq('+i+')').html()),precision);
				commission=ceilfun(Number(commission)+Number($('.editpay #viewwindow #editpaywindow .commission:eq('+i+')').val()),precision);
			}
			else{//無條件捨去
				pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .paycash:eq('+i+')').html()),precision);
				cash=floorfun(Number(cash)+Number($('.editpay #viewwindow #editpaywindow .paycash:eq('+i+')').html()),precision);
				commission=floorfun(Number(commission)+Number($('.editpay #viewwindow #editpaywindow .commission:eq('+i+')').val()),precision);
			}
		}
		for(var i=0;i<$('.editpay #viewwindow #editpaywindow .otherpay').length;i++){//計算已付其他付款
			if($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="type"]').val()=='1'){//找零
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=roundfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=ceilfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=floorfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
			}
			else{
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfix=roundfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfix=ceilfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfixpay=floorfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
			}
			
			if(typeof tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')]!=='undefined'){
				if(tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')].match("=")){
					var ttempstringa=tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')].split("=");
					tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')]=Number(ttempstringa[1])+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val());
				}
				else{
					tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')]=Number(tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')])+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val());
				}
			}
			else{
				tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')]=Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val());
			}
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="initview"]').val()+"="+roundfun(tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')],precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="initview"]').val()+"="+ceilfun(tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')],precision);
			}
			else{//無條件捨去
				tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="initview"]').val()+"="+floorfun(tempstring[$('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+')').attr('id')],precision);
			}
		}
		for(var i=0;i<$('.editpay #viewwindow #editpaywindow .intellaother').length;i++){//計算已付英特拉
			//if($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="type"]').val()=='1'){//找零
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=roundfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=ceilfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=floorfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
			/*}
			else{
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfix=roundfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfix=ceilfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfixpay=floorfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
			}*/
			
			if(typeof tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')]!=='undefined'){
				if(tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')].match("=")){
					var ttempstringa=tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')].split("=");
					tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')]=Number(ttempstringa[1])+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val());
				}
				else{
					tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')]=Number(tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')])+Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val());
				}
			}
			else{
				tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')]=Number($('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="viewmoney"]').val());
			}
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="initview"]').val()+"="+roundfun(tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')],precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="initview"]').val()+"="+ceilfun(tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')],precision);
			}
			else{//無條件捨去
				tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+') input[name="initview"]').val()+"="+floorfun(tempstring[$('.editpay #viewwindow #editpaywindow .intellaother:eq('+i+')').attr('id')],precision);
			}
		}
		for(var i=0;i<$('.editpay #viewwindow #editpaywindow .nidinother').length;i++){//2021/8/18 計算已付你訂
			//if($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="type"]').val()=='1'){//找零
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=roundfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=ceilfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
					other=floorfun(Number(other)+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
			/*}
			else{
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					pay=roundfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfix=roundfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					pay=ceilfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfix=ceilfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
				else{//無條件捨去
					pay=floorfun(Number(pay)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
					otherfixpay=floorfun(Number(otherfix)+Number($('.editpay #viewwindow #editpaywindow .otherpay:eq('+i+') input[name="viewmoney"]').val()),precision);
				}
			}*/
			
			if(typeof tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')]!=='undefined'){
				if(tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')].match("=")){
					var ttempstringa=tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')].split("=");
					tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')]=Number(ttempstringa[1])+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val());
				}
				else{
					tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')]=Number(tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')])+Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val());
				}
			}
			else{
				tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')]=Number($('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="viewmoney"]').val());
			}
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="initview"]').val()+"="+roundfun(tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')],precision);
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="initview"]').val()+"="+ceilfun(tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')],precision);
			}
			else{//無條件捨去
				tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')]=$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+') input[name="initview"]').val()+"="+floorfun(tempstring[$('.editpay #viewwindow #editpaywindow .nidinother:eq('+i+')').attr('id')],precision);
			}
		}
		$.each(tempstring,function(i,value){
			if(otherstring==''){
				otherstring=otherstring+i+':'+value;
			}
			else{
				otherstring=otherstring+','+i+':'+value;
			}
		});
		/*for(var i=1;i<=10;i++){
			if(typeof tempstring['TA'+i]!=='undefined'){
				if(otherstring==''){
					otherstring=otherstring+'TA'+i+':'+tempstring['TA'+i];
				}
				else{
					otherstring=otherstring+',TA'+i+':'+tempstring['TA'+i];
				}
			}
			else{
			}
		}*/
		if(typeof tempstring['NONTAX']!=='undefined'){
			if(otherstring==''){
				otherstring=otherstring+'NONTAX:'+tempstring['NONTAX'];
			}
			else{
				otherstring=otherstring+',NONTAX:'+tempstring['NONTAX'];
			}
		}
		else{
		}
		//console.log(otherstring);
		$('.editpay #viewwindow #cashcomm').html(commission);
		$('.editpay #viewwindow input[name="cashcomm"]').val(commission);

		$('.editpay #viewwindow #already').html(pay);
		$('.editpay #viewwindow input[name="already"]').val(pay);

		$('.editpay #viewwindow #cash').html(cash);
		$('.editpay #viewwindow input[name="cash"]').val(cash);

		$('.editpay #viewwindow #other').html(other);
		$('.editpay #viewwindow input[name="other"]').val(other);
		$('.editpay #viewwindow input[name="otherstring"]').val(otherstring);
		$('.editpay #viewwindow #otherfix').html(otherfix);
		$('.editpay #viewwindow input[name="otherfix"]').val(otherfix);
		if(Number(money)>=(Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #cash').html())-Number($('.editpay #viewwindow #other').html())-Number($('.editpay #viewwindow #otherfix').html()))){
			$('.editpay #viewwindow #cashmoney').html((Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #cash').html())-Number($('.editpay #viewwindow #other').html())-Number($('.editpay #viewwindow #otherfix').html())));
			$('.editpay #viewwindow input[name="cashmoney"]').val((Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #cash').html())-Number($('.editpay #viewwindow #other').html())-Number($('.editpay #viewwindow #otherfix').html())));
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.editpay #viewwindow #cashmoney').html(roundfun($('.editpay #viewwindow #cashmoney').html(),precision));
				$('.editpay #viewwindow input[name="cashmoney"]').val(roundfun($('.editpay #viewwindow input[name="cashmoney"]').val(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.editpay #viewwindow #cashmoney').html(ceilfun($('.editpay #viewwindow #cashmoney').html(),precision));
				$('.editpay #viewwindow input[name="cashmoney"]').val(ceilfun($('.editpay #viewwindow input[name="cashmoney"]').val(),precision));
			}
			else{//無條件捨去
				$('.editpay #viewwindow #cashmoney').html(floorfun($('.editpay #viewwindow #cashmoney').html(),precision));
				$('.editpay #viewwindow input[name="cashmoney"]').val(floorfun($('.editpay #viewwindow input[name="cashmoney"]').val(),precision));
			}
		}
		else{
			$('.editpay #viewwindow #cashmoney').html(money);
			$('.editpay #viewwindow input[name="cashmoney"]').val(money);
		}
		if(Number($('.editpay #viewwindow #cashmoney').html())<0){
			$('.editpay #viewwindow #cashmoney').html('0');
			$('.editpay #viewwindow input[name="cashmoney"]').val('0');
		}
		else{
		}
	};
	$('.editpay').on('click','#number',function(event){
		//oneEvent(event);
		$('.editpay input[name="view"]').val($('.editpay input[name="view"]').val()+$(this).val());
	});
	$('.editpay').on('click','#clear',function(event){
		//oneEvent(event);
		if($('.editpay #viewwindow #editpaywindow .paywaybox input[name="checkbox"]:checked').length>0){//清除已勾選之結帳方式明細
			for(var i=($('.editpay #viewwindow #editpaywindow .paywaybox').length-1);i>=0;i--){
				if($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') input[name="checkbox"]').prop('checked')&&($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') .payway #name1 input[name="inv"]').length==0||$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') .payway #name1 input[name="inv"]').val()=='1')&&($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') .payway #name1 input[name="fromdb"]').length==0||$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') .payway #name1 input[name="fromdb"]').val()=='')&&$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') .payway .intellaother').length<1&&$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') .payway .nidinother').length<1&&($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') .payway .paycash').length<1||$('.order#order .initsetting #nccc').val()!='1')&&(($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') #name1 input[name="directlinepay"]').length==0||$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') #name1 input[name="directlinepay"]').val()=='0')||$('.order#order .initsetting #directlinepay').val()=='0')&&(($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') #name1 input[name="jkos"]').length==0||$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') #name1 input[name="jkos"]').val()=='0')||$('.order#order .initsetting #jkos').val()=='0')&&(($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') #name1 input[name="pxpayplus"]').length==0||$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') #name1 input[name="pxpayplus"]').val()=='0')||$('.order#order .initsetting #pxpayplus').val()=='0')){
					$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+')').remove();
				}
				else{
					$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+i+') input[name="checkbox"]').prop('checked',false);
				}
			}
			editpaycomchange();
		}
		else{
		}
		$('.editpay input[name="view"]').val('');
	});
	$('.editpay').on('click','#other',function(event){
		//oneEvent(event);
		$('.paywindow input[name="target"]').val('editpay');
		for(var i=0;i<$('.paywindow button').length;i++){
			if(($('.paywindow button:eq('+i+') input[name="inv"]').length==0||$('.paywindow button:eq('+i+') input[name="inv"]').val()=='1')&&($('.paywindow button:eq('+i+') input[name="fromdb"]').length==0||$('.paywindow button:eq('+i+') input[name="fromdb"]').val()=='')&&(($('.paywindow button:eq('+i+') input[name="directlinepay"]').length==0||$('.paywindow button:eq('+i+') input[name="directlinepay"]').val()=='0')||$('.order#order .initsetting #directlinepay').val()=='0')&&(($('.paywindow button:eq('+i+') input[name="jkos"]').length==0||$('.paywindow button:eq('+i+') input[name="jkos"]').val()=='0')||$('.order#order .initsetting #jkos').val()=='0')&&(($('.paywindow button:eq('+i+') input[name="pxpayplus"]').length==0||$('.paywindow button:eq('+i+') input[name="pxpayplus"]').val()=='0')||$('.order#order .initsetting #pxpayplus').val()=='0')){
			}
			else{
				$('.paywindow button:eq('+i+')').prop('disabled',true);
			}
		}
		paywindow.dialog('open');
	});
	$('.editpay').on('click','#cashbut',function(event){//信用卡
		//oneEvent(event);
		var content='';
		var inputmoney=0;
		var commission=0;
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)

		if($('.editpay input[name="view"]').val().length>0){
			if((Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()))<=0){
			}
			else{
				if(Number($('.editpay input[name="view"]').val())>=(Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()))){
					inputmoney=Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html());
				}
				else{
					inputmoney=$('.editpay input[name="view"]').val();
				}
			}
			$('.editpay input[name="view"]').val('');
		}
		else if((Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()))>0){
			inputmoney=Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html());
		}
		else{
		}

		commission=(Number(inputmoney)*$('.order#order .initsetting #cashcomm').val())/100;
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			commission= roundfun(commission ,precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			commission= ceilfun(commission ,precision);
		}
		else{//無條件捨去
			commission= floorfun(commission ,precision);
		}

		if(Number(inputmoney)==0){
		}
		else{
			content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.editpay #cashbut').html()+"</span>";
			content=content+"</div>";
			content=content+"<div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paycash'>"+(Number(inputmoney)+Number(commission))+"</span>"+$('.result .unit').val()+"<input type='hidden' id='inputmoney' value='"+inputmoney+"'><input type='hidden' class='commission' value='"+commission+"'></div></div></div>";
			$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
		}

		editpaycomchange();
	});
	$('.editpay').on('click','#moneybut',function(event){//現金
		//oneEvent(event);
		var content='';
		if($('.editpay input[name="view"]').val().length>0){
			
			if((Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()))<=0){
			}
			else{
				content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.editpay #moneybut').html()+"</span>";
				content=content+"</div>";
				content=content+"<div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paymoney'>";
				if((Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()))<=Number($('.editpay input[name="view"]').val())){
					content=content+(Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()));
				}
				else{
					content=content+$('.editpay input[name="view"]').val();
				}
				content=content+"</span>"+$('.result .unit').val()+"</div></div></div>";

				$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
			}
			$('.editpay input[name="view"]').val('');
			
		}
		else if((Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()))>0){
			content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.editpay #moneybut').html()+"</span>";
			content=content+"</div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='paymoney'>"+(Number($('.editpay #viewwindow #should').html())+Number($('.editpay #viewwindow #cashcomm').html())-Number($('.editpay #viewwindow #already').html()))+"</span>"+$('.result .unit').val()+"</div></div></div>";
			$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
		}
		else{
		}
		editpaycomchange();
	});
	$('.editpay #viewwindow #editpaywindow').on('click','.payway',function(event){//結帳畫面之結帳方式明細模擬labal點選
		//oneEvent(event);
		var index=$('.editpay #viewwindow #editpaywindow .payway').index(this);
		$('.editpay #viewwindow #editpaywindow .paywaybox').removeClass('focus');
		if($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+index+') input[name="checkbox"]').prop('checked')){
			$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+index+') input[name="checkbox"]').prop('checked',false);
		}
		else{
			$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+index+') input[name="checkbox"]').prop('checked',true);
		}
		if($('.editpay #viewwindow #editpaywindow .paywaybox:eq('+index+') .focus').length>0){
		}
		else{
			$('.editpay #viewwindow #editpaywindow .paywaybox:eq('+index+')').addClass('focus');
		}
	});
	$('.editpay #viewwindow').on('click','#send',function(event){
		//oneEvent(event);
		if($('.editpay #viewwindow #notyet').html()!='0'){
		}
		else{
			if($('.order#order .initsetting #voidsale').val()=='1'){//驗證密碼
				$('.verpsw input[name="type"]').val('editpay');
				verpsw.dialog('open');				
			}
			else{
				var nowbizdate=$('.editpay #viewwindow #editform input[name="bizdate"]').val();
				var temparray=$('.editpay #viewwindow #editform').serialize();
				temparray=temparray+'&machinetype='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val();
				$.ajax({
					url:'./lib/js/cover.ajax.php',
					method:'post',
					async:false,
					data:$('.editpay #viewwindow #editform').serialize(),
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'editpay-send cover.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
						$('.editpay #viewwindow #cancel').trigger('click');
						$('.salelist #fun #exit').trigger('click');
						$('.order#order #billfun #billfun2 #salelist').trigger('click');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
		}
	});
	$('.editpay #viewwindow').on('click','#cancel',function(event){
		//oneEvent(event);
		$('.editpay input[name="view"]').val('');
		$('.editpay #viewwindow #should').html('0');
		$('.editpay #viewwindow input[name="should"]').val('0');

		$('.editpay #viewwindow #cashcomm').html('0');
		$('.editpay #viewwindow input[name="cashcomm"]').val('0');

		$('.editpay #viewwindow #already').html('0');
		$('.editpay #viewwindow input[name="already"]').val('0');

		$('.editpay #viewwindow #cashmoney').html('0');
		$('.editpay #viewwindow input[name="cashmoney"]').val('0');

		$('.editpay #viewwindow #cash').html('0');
		$('.editpay #viewwindow input[name="cash"]').val('0');

		$('.editpay #viewwindow #other').html('0');
		$('.editpay #viewwindow input[name="other"]').val('0');
		$('.editpay #viewwindow input[name="otherstring"]').val('0');

		$('.editpay #viewwindow #notyet').html('0');
		$('.editpay #viewwindow #editpaywindow #paycontent').html('');
		if(editpay.dialog('isOpen')){
			editpay.dialog('close');
		}
		else{
		}
	});
	$('.order#order #billfun #billfun2').on('click','#salevoid',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('帳單作廢','click');
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/get.bizdate.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.salevoid .viewbizdate').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'./lib/js/checkopen.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'checkopen.ajax.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//console.log(d);
				if(d=='success'){
					if($('.order#order #useinv').val()=='1'){
						$('.salevoid #fun #invvoid').prop('disabled',false);
					}
					else{
						$('.salevoid #fun #invvoid').prop('disabled',true);
					}
					salevoid.dialog('open');
					$.ajax({
						url:'./lib/js/getsalelist.ajax.php',
						method:'post',
						data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
						dataType:'html',
						success:function(d){
							$('.salevoid #salelist #salecontent').html(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
					$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
					alertmessage.dialog('open');
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.salevoid #salelist #salecontent').on('click','.listitems',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('帳單作廢選擇帳單','click');
		//oneEvent(event);
		var index=$('.salevoid #salelist #salecontent .listitems').index(this);
		$('.salevoid #salelist #salecontent .listitems').prop('id','');
		$('.salevoid #salelist #salecontent .listitems:eq('+index+')').prop('id','focus');
		$('.salevoid #listno').html($('.salevoid #salelist #salecontent .listitems:eq('+index+') div:eq(1)').html());
		$('.salevoid #date').html($('.salevoid #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html());
		$('.salevoid #credate').val($('.salevoid #salelist #salecontent .listitems:eq('+index+') div:eq(9)').html().substr(0,8));
		$.ajax({
			url:'./lib/js/getsaledetail.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'bizdate':$('.salevoid #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html(),'no':$('.salevoid #salelist #salecontent .listitems:eq('+index+') div:eq(1) input[name="consecnumber"]').val()},
			dataType:'html',
			success:function(d){
				if(d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'salecontent getsaledetail.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$('.salevoid #list #listcontent').html('查詢錯誤');
					$('.salevoid #fun #void').prop('disabled',true);
				}
				else{
					$('.salevoid #list #listcontent').html(d);
					if($('.order#order .companydata #ispad').val()=='submachine'){
						$('.salevoid #fun #void').prop('disabled',true);
					}
					else{
						$('.salevoid #fun #void').prop('disabled',false);
					}
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
		
		if($('.salevoid #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val()!=''&&$('.salevoid #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val()!=null){
			var memtel=$('.salevoid #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val().split(';-;');
			/*if(memtel.length>1){//具有會員
				memtel=tempmemtel[0];
			}
			else{
				memtel=tempmemtel[0];
			}*/
			if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
				if(memtel[0]!=''){//2020/5/18 if($('.order#order #tabs4 .listcontentbox input[name="memno"]').val()!=''){ memno檢查不應該在這裡
					$.ajax({
						url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php',
						method:'post',
						async:false,
						data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','memno':memtel[0],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
						dataType:'json',
						success:function(d){
							//console.log(d);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online success)'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
							if(d=="查無資料庫。"){
								$('.salevoid #membername').html('');
								$('.salevoid #membertel').html('');
							}
							else if(d.length==0){
								$('.salevoid #membername').html('');
								$('.salevoid #membertel').html('');
							}
							else{
								$('.salevoid #membername').html(d[0]['name']);
								$('.salevoid #membertel').html(d[0]['tel']);
							}
						},
						error:function(e){
							//console.log(e);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online error) '+e},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
					});
				}
				else{
					$('.salevoid #membername').html('');
					$('.salevoid #membertel').html('');
				}
			}
			else{//本地會員
				$.ajax({
					url:'../memberapi/getmemdata.ajax.php',
					method:'post',
					async:false,
					data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','memno':memtel[0],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/getmemdata.ajax.php(offline success)'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(d=="查無資料庫。"){
							$('.salevoid #membername').html('');
							$('.salevoid #membertel').html('');
						}
						else if(d.length==0){
							$('.salevoid #membername').html('');
							$('.salevoid #membertel').html('');
						}
						else{
							$('.salevoid #membername').html(d[0]['name']);
							$('.salevoid #membertel').html(d[0]['tel']);
						}
					},
					error:function(e){
						//console.log(e);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/getmemdata.ajax.php(offline error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
				});
			}
		}
		else{
			$('.salevoid #membername').html('');
			$('.salevoid #membertel').html('');
		}
	});
	$('.salevoid #fun').on('click','#prebizdate',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('帳單作廢切換營業日',$(this).find('#name1').html());
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/get.bizdate.ajax.php',
			method:'post',
			async:false,
			data:{'bizdate':$('.salevoid #salelist #salecontent #bizdate').val(),'type':'-','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.salevoid .viewbizdate').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'bizdate':$('.salevoid #salelist #salecontent #bizdate').val(),'type':'-','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.salevoid #salelist #salecontent').html(d);
				$('.salevoid #listno').html('');
				$('.salevoid #list #listcontent').html('');
				$('.salevoid #date').html('');
				$('.salevoid #credate').html('');
				$('.salevoid #fun #void').prop('disabled',true);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.salevoid #fun').on('click','#nextbizdate',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('帳單作廢切換營業日',$(this).find('#name1').html());
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/get.bizdate.ajax.php',
			method:'post',
			async:false,
			data:{'bizdate':$('.salevoid #salelist #salecontent #bizdate').val(),'type':'+','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.salevoid .viewbizdate').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'bizdate':$('.salevoid #salelist #salecontent #bizdate').val(),'type':'+','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.salevoid #salelist #salecontent').html(d);
				$('.salevoid #listno').html('');
				$('.salevoid #list #listcontent').html('');
				$('.salevoid #date').html('');
				$('.salevoid #credate').html('');
				$('.salevoid #fun #void').prop('disabled',true);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.salevoid #fun').on('click','#salevoidbyinv',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('帳單作廢依發票作廢','click');
		//oneEvent(event);
		salevoidbyinv.dialog('open');
	});
	$('.salevoidbyinv input[name="inv"]').keyup(function(){
		//console.log($('.salevoidbyinv input[name="inv"]').val().length);
		$('.salevoidbyinv input[name="inv"]').val($('.salevoidbyinv input[name="inv"]').val().toUpperCase());
		if($('.salevoidbyinv input[name="inv"]').val().length==10){
			$('.salevoidbyinv #checkcontent').html('');
			$.ajax({
				url:'./lib/js/salevoidbyinv.ajax.php',
				method:'post',
				async:false,
				data:{'invno':$('.salevoidbyinv input[name="inv"]').val()},
				dataType:'json',
				success:function(d){
					//console.log(d);
					if(d[0]=='empty'){
						$('.salevoidbyinv #checkcontent').html('查無帳單');
						$('.salevoidbyinv #check').prop('disabled',true);
					}
					else{
						$('.salevoidbyinv #checkcontent').html(d[0]);
						$('.salevoidbyinv #check').prop('disabled',false);
					}
				},
				error:function(e){
					//console.log(e);
					$('.salevoidbyinv #check').prop('disabled',true);
				}
			});
		}
		else if($('.salevoidbyinv input[name="inv"]').val().length==19){
			$('.salevoidbyinv input[name="inv"]').val($('.salevoidbyinv input[name="inv"]').val().substr(5,10));
		}
		else{
			$('.salevoidbyinv #check').prop('disabled',true);
			$('.salevoidbyinv #checkcontent').html('');
		}
	});
	$('.salevoidbyinv #check').click(function(){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('帳單作廢依發票作廢送出','click');
		//oneEvent(event);
		if($('.order#order .initsetting #voidsale').val()=='0'){
			//2022/4/20 增加作廢帳單二次確認流程，並自動帶入作廢密碼模擬不驗證密碼
			$('.checkdeletesale .bizdate').html($('.salevoidbyinv #checkcontent tr:eq(3) td:eq(1)').html());
			$('.checkdeletesale .saleno').html($('.salevoidbyinv #checkcontent tr:eq(4) td:eq(1)').html());
			$('.checkdeletesale .consecnumber').html($('.salevoidbyinv #checkcontent tr:eq(5) td:eq(1)').html());
			$('.checkdeletesale .invoicenumber').html($('.salevoidbyinv #checkcontent tr:eq(0) td:eq(1)').html());
			$('.checkdeletesale .money').html($('.salevoidbyinv #checkcontent tr:eq(6) td:eq(1)').html());
			$('.checkdeletesale input[name="type"]').val('voidbyinv');
			$('.checkdeletesale input[name="psw"]').val($('.order#order .companydata #voidpw').val());
			checkdeletesale.dialog('open');

			/*//if($.trim($('.salevoid #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
				var hint=confirm('請確認發票正本已收回。');
				if(hint==true){
					salevoidbyinv.dialog('close');
					var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
					var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
					var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
					}
					else{
					}
					$.ajax({
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						async:false,
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
						dataType:'html',
						success:function(d){
							var temp=d.split('-');
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
							}
							if(temp[0]=='success'){
								if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
									var memtype='online';
								}
								else{
									var memtype='offline';
								}
								var memberapi='';
								$.ajax({
									url:'./lib/js/searchmember.pointmoney.ajax.php',
									method:'post',
									async:false,
									data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d[0].length==0){
										}
										else{
											if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
											else{
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													$.ajax({
														url:'../memberapi/point_money.ajax.php',
														method:'post',
														async:false,
														data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
														dataType:'json',
														timeout:5000,
														success:function(d){
															memberapi=d;
															//console.log(res);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e,t){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
															if(t==="timeout"){
																memberapi=[{"state":"fail","message":"AJAX timeout"}];
															}
															else{
																memberapi=e;
															}
														}
													});
													//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'../memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'../memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){
													console.log(d);
												},
												error:function(e){
													console.log(e);
												}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/4mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.order#order #billfun #billfun2 #salevoid').trigger('click');
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=temp[1];
								}
								else{
								}
							}
							else{
								//console.log(d);
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':nowbizdate.substr(0,6)+'-change'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					//錢都錄借接
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
					//集點樹收點流程
					if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'start point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
						if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
							var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
							if(voidres==''){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else if(typeof voidres['data']!=="undefined"){//success
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
								var message=JSON.parse(voidres['responseText']);
								if(voidres['status']==='timeout'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else if(voidres['status']=='400'||voidres['status']=='406'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
							}
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'api void pointtree is not function','file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'end point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
				}
				else{
				}
			//}*/
		}
		else{
			//2022/4/20 增加作廢帳單二次確認流程
			//$('.verpsw input[name="type"]').val('voidbyinv');
			//verpsw.dialog('open');
			$('.checkdeletesale .bizdate').html($('.salevoidbyinv #checkcontent tr:eq(3) td:eq(1)').html());
			$('.checkdeletesale .saleno').html($('.salevoidbyinv #checkcontent tr:eq(4) td:eq(1)').html());
			$('.checkdeletesale .consecnumber').html($('.salevoidbyinv #checkcontent tr:eq(5) td:eq(1)').html());
			$('.checkdeletesale .invoicenumber').html($('.salevoidbyinv #checkcontent tr:eq(0) td:eq(1)').html());
			$('.checkdeletesale .money').html($('.salevoidbyinv #checkcontent tr:eq(6) td:eq(1)').html());
			$('.checkdeletesale input[name="type"]').val('voidbyinv');
			$('.checkdeletesale input[name="psw"]').val('');
			checkdeletesale.dialog('open');
		}
	});
	$('.salevoid #fun').on('click','#void',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('帳單作廢作廢選擇的帳單','click');
		//oneEvent(event);
		if($('.order#order .initsetting #voidsale').val()=='0'){
			//2022/4/20 增加作廢帳單二次確認流程，並自動帶入作廢密碼模擬不驗證密碼
			$('.checkdeletesale .bizdate').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(0)').html());
			$('.checkdeletesale .saleno').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(1)').html());
			$('.checkdeletesale .consecnumber').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(2)').html());
			$('.checkdeletesale .invoicenumber').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(3)').html());
			$('.checkdeletesale .money').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(5)').html());
			$('.checkdeletesale input[name="type"]').val('void');
			$('.checkdeletesale input[name="psw"]').val($('.order#order .companydata #voidpw').val());
			checkdeletesale.dialog('open');

			/*if($.trim($('.salevoid #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
				var hint=confirm('請確認發票正本已收回。');
				if(hint==true){
					var nowbizdate=$('.salevoid #date').html();
					var voidbizdate=$('.salevoid #date').html();
					var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
					var check=0;
					//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
					if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
						$.ajax({
							url:'./lib/api/intella/check.intellapay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithintellapay input[name="type"]').val('void');
									$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
									$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
									$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
									voidsalewithintellapay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
						$.ajax({
							url:'./lib/api/directlinepay/check.linepay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithlinepay input[name="type"]').val('void');
									$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
									$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
									voidsalewithlinepay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
						$.ajax({
							url:'./lib/api/nccc/check.nccc.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithnccc input[name="type"]').val('void');
									$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
									$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
									voidsalewithnccc.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0){//沒有使用API串接付款
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile='';
						}
						else{
						}
						if($('.nidin #usenidin').length>0){
							nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
						}
						else{
						}
						$.ajax({
							url:'./lib/js/salevoid.ajax.php',
							method:'post',
							async:false,
							data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
							dataType:'html',
							success:function(d){
								var temp=d.split('-');
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'salevoid.ajax.php '+d},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
								}
								if(temp[0]=='success'){
									if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
										var memtype='online';
									}
									else{
										var memtype='offline';
									}
									var memberapi='';
									$.ajax({
										url:'./lib/js/searchmember.pointmoney.ajax.php',
										method:'post',
										async:false,
										data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
										dataType:'json',
										success:function(d){
											//console.log(d);
											if(d[0].length==0){
											}
											else{
												if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
													if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
														memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
														if(memberapi[0]['state']=='success'){
															$.ajax({
																url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
																method:'post',
																async:false,
																data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																},
																error:function(e){
																	//console.log(e);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
															});
														}
														else{
														}
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
															method:'post',
															async:false,
															data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
												}
												else{
													if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
														$.ajax({
															url:'../memberapi/point_money.ajax.php',
															method:'post',
															async:false,
															data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
															dataType:'json',
															timeout:5000,
															success:function(d){
																memberapi=d;
																//console.log(res);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e,t){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
																if(t==="timeout"){
																	memberapi=[{"state":"fail","message":"AJAX timeout"}];
																}
																else{
																	memberapi=e;
																}
															}
														});
														//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
														if(memberapi[0]['state']=='success'){
															$.ajax({
																url:'../memberapi/change.memberdata.php',
																method:'post',
																async:false,
																data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																},
																error:function(e){
																	//console.log(e);
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
															});
														}
														else{
														}
														$.ajax({
															url:'../memberapi/insertmemlist.ajax.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
												}
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
									//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
									$.ajax({
										url:'./lib/js/getinvname.ajax.php',
										method:'post',
										async:false,
										data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
										dataType:'json',
										success:function(d){
											//console.log(d);
											if(d=='dbempty'){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'reinv getinvname.ajax.php dbempty'},
													dataType:'html',
													success:function(d){
														console.log(d);
													},
													error:function(e){
														console.log(e);
													}
												});
											}
											else{
												$.ajax({
													url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
													method:'post',
													async:false,
													data:{'invfile':d[1]},
													dataType:'html',
													success:function(d){
														//console.log(d);
														if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
															$.ajax({
																url:'./lib/js/reinv.ajax.php',
																method:'post',
																async:false,
																data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																	if(d.length>20||d.match('ERROR HINT: ')){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'creditcard reinv.ajax.php '+d},
																			dataType:'html',
																			success:function(d){
																				console.log(d);
																			},
																			error:function(e){
																				console.log(e);
																			}
																		});
																	}
																	else{
																	}
																},
																error:function(e){
																	//console.log(e);
																}
															});
														}
														else{
														}
														$.ajax({
															url:'./lib/js/deleteinv.ajax.php',
															method:'post',
															async:false,
															data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
															dataType:'html',
															success:function(d){
																if(d.length>40||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'deleteinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
																else{
																}
																//console.log(d);
																//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																//2017/12/4mywin.document.title='cashdrawer';
															},
															error:function(e){
																//console.log(e);
															}
														});
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
									$('.order#order #billfun #billfun2 #salevoid').trigger('click');
									$('.salevoid #listno').html('');
									$('.salevoid #list #listcontent').html('');
									$('.salevoid #date').html('');
									$('.salevoid #credate').html('');
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var posdvrfile=temp[1];
									}
									else{
									}
								}
								else{
									console.log(d);
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
						$.ajax({
							url:'./lib/js/create.cmdtxt.php',
							method:'post',
							async: false,
							data:{'cmd':nowbizdate.substr(0,6)+'-change'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						//錢都錄借接
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							//start tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'start posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){console.log(e);}
							});
							if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
								var res=api_sendmessage_posdvr(posdvrfile);
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'success '+posdvrfile,'file':'posdvr'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'error sendmessage is not function','file':'posdvr'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							//end tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'end posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
						}
						//集點樹收點流程
						if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
							//start tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'start point-tree-void transfer','file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
							if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
								var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
								if(voidres==''){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else if(typeof voidres['data']!=="undefined"){//success
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
									var message=JSON.parse(voidres['responseText']);
									if(voidres['status']==='timeout'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
											dataType:'html',
											success:function(d){
												console.log(d);
											},
											error:function(e){
												console.log(e);
											}
										});
									}
									else if(voidres['status']=='400'||voidres['status']=='406'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
											dataType:'html',
											success:function(d){
												console.log(d);
											},
											error:function(e){
												console.log(e);
											}
										});
									}
									else{
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
											dataType:'html',
											success:function(d){
												console.log(d);
											},
											error:function(e){
												console.log(e);
											}
										});
									}
								}
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'api void pointtree is not function','file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							//end tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'end point-tree-void transfer','file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
						}
					}
					else{//使用API串接付款，須先進行退款
					}
				}
				else{
				}
			}
			else{
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				var check=0;
				//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
				if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
					$.ajax({
						url:'./lib/api/intella/check.intellapay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithintellapay input[name="type"]').val('void');
								$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
								$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
								$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
								voidsalewithintellapay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
					$.ajax({
						url:'./lib/api/directlinepay/check.linepay.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithlinepay input[name="type"]').val('void');
								$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
								$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
								voidsalewithlinepay.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
					$.ajax({
						url:'./lib/api/nccc/check.nccc.php',
						method:'post',
						async:false,
						data:{'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['result']=='exists'){
								check=1;
								verpsw.dialog('close');
								$('.voidsalewithnccc input[name="type"]').val('void');
								$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
								$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
								voidsalewithnccc.dialog('open');
								return;
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(check==0){//沒有使用API串接付款
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						var posdvrfile='';
					}
					else{
					}
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						async:false,
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							var temp=d.split('-');
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
							}
							if(temp[0]=='success'){
								if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
									var memtype='online';
								}
								else{
									var memtype='offline';
								}
								var memberapi='';
								$.ajax({
									url:'./lib/js/searchmember.pointmoney.ajax.php',
									method:'post',
									async:false,
									data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d[0].length==0){
										}
										else{
											if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
											else{
												if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
													$.ajax({
														url:'../memberapi/point_money.ajax.php',
														method:'post',
														async:false,
														data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
														dataType:'json',
														timeout:5000,
														success:function(d){
															memberapi=d;
															//console.log(res);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e,t){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
															if(t==="timeout"){
																memberapi=[{"state":"fail","message":"AJAX timeout"}];
															}
															else{
																memberapi=e;
															}
														}
													});
													//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
													if(memberapi[0]['state']=='success'){
														$.ajax({
															url:'../memberapi/change.memberdata.php',
															method:'post',
															async:false,
															data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
															dataType:'html',
															success:function(d){
																//console.log(d);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
														});
													}
													else{
													}
													$.ajax({
														url:'../memberapi/insertmemlist.ajax.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
																dataType:'html',
																success:function(d){
																	console.log(d);
																},
																error:function(e){
																	console.log(e);
																}
															});
														}
													});
												}
												else{
												}
											}
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){
													console.log(d);
												},
												error:function(e){
													console.log(e);
												}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){
																			console.log(d);
																		},
																		error:function(e){
																			console.log(e);
																		}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){
																		console.log(d);
																	},
																	error:function(e){
																		console.log(e);
																	}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/4mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.order#order #billfun #billfun2 #salevoid').trigger('click');
								$('.salevoid #listno').html('');
								$('.salevoid #list #listcontent').html('');
								$('.salevoid #date').html('');
								$('.salevoid #credate').html('');
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=temp[1];
								}
								else{
								}
							}
							else{
								//console.log(d);
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':nowbizdate.substr(0,6)+'-change'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					//錢都錄借接
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'start posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){console.log(d);},
							error:function(e){console.log(e);}
						});
						if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
							var res=api_sendmessage_posdvr(posdvrfile);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'success '+posdvrfile,'file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'error sendmessage is not function','file':'posdvr'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'end posdvr-sendmessage','file':'posdvr'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
					//集點樹收點流程
					if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
						//start tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'start point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
						if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
							var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
							if(voidres==''){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else if(typeof voidres['data']!=="undefined"){//success
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									}
								});
							}
							else{
								var message=JSON.parse(voidres['responseText']);
								if(voidres['status']==='timeout'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else if(voidres['status']=='400'||voidres['status']=='406'){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){
											console.log(d);
										},
										error:function(e){
											console.log(e);
										}
									});
								}
							}
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'api void pointtree is not function','file':'point-tree'},
								dataType:'html',
								success:function(d){
									console.log(d);
								},
								error:function(e){
									console.log(e);
								}
							});
						}
						//end tag
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'end point-tree-void transfer','file':'point-tree'},
							dataType:'html',
							success:function(d){
								console.log(d);
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
					}
				}
				else{//使用API串接付款，須先進行退款
				}
			}*/
		}
		else{
			//2022/4/20 增加作廢帳單二次確認流程
			//$('.verpsw input[name="type"]').val('void');
			//verpsw.dialog('open');
			$('.checkdeletesale .bizdate').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(0)').html());
			$('.checkdeletesale .saleno').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(1)').html());
			$('.checkdeletesale .consecnumber').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(2)').html());
			$('.checkdeletesale .invoicenumber').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(3)').html());
			$('.checkdeletesale .money').html($('.salevoid #salelist #salecontent .listitems#focus div:eq(5)').html());
			$('.checkdeletesale input[name="type"]').val('void');
			$('.checkdeletesale input[name="psw"]').val('');
			checkdeletesale.dialog('open');
		}
	});
	$('.salevoid #fun').on('click','#exit',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('關閉作廢帳單','click');
		//oneEvent(event);
		$('.salevoid #salelist #salecontent .listitems').prop('id','');
		$('.salevoid #listno').html('');
		$('.salevoid #list #listcontent').html('');
		$('.salevoid #date').html('');
		$('.salevoid #credate').html('');
		salevoid.dialog('close');
	});
	$('.order#order #banner #tablenumber').on('click','.tabnumbox',function(event){
		//oneEvent(event);
		if($('.order#order .initsetting #controltable').val()=='1'){
		}
		else{
			$('.tabinput #view #tabnum').html($('.order#order #banner #tablenumber .tabnumbox').html());
			tabinput.dialog('open');
		}
	});
	$('.tabinput #buttons').on('click','.input',function(event){
		//oneEvent(event);
		var index=$('.tabinput #buttons .input').index(this);
		if($('.tabinput #view #tabnum').html().length>=20){
		}
		else{
			$('.tabinput #view #tabnum').html($('.tabinput #view #tabnum').html()+$('.tabinput #buttons .input:eq('+index+')').val());
		}
	});
	$('.tabinput #buttons').on('click','#change',function(event){
		//oneEvent(event);
		if($('.tabinput #buttons .input:eq(0)').val()=='7'){
			for(var i=0;i<12;i++){
				$('.tabinput #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)));
			}
			$('.tabinput #buttons .pre').prop('disabled',false);
			$('.tabinput #buttons .next').prop('disabled',false);
		}
		else{
			$('.tabinput #buttons .input:eq(0)').val('7');
			$('.tabinput #buttons .input:eq(1)').val('8');
			$('.tabinput #buttons .input:eq(2)').val('9');
			$('.tabinput #buttons .input:eq(3)').val('4');
			$('.tabinput #buttons .input:eq(4)').val('5');
			$('.tabinput #buttons .input:eq(5)').val('6');
			$('.tabinput #buttons .input:eq(6)').val('1');
			$('.tabinput #buttons .input:eq(7)').val('2');
			$('.tabinput #buttons .input:eq(8)').val('3');
			$('.tabinput #buttons .input:eq(9)').val('0');
			$('.tabinput #buttons .input:eq(10)').val('.');
			$('.tabinput #buttons .input:eq(11)').val('-');
			$('.tabinput #buttons .input:eq(0)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(1)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(2)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(3)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(4)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(5)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(6)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(7)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(8)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(9)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(10)').prop('disabled',false);
			$('.tabinput #buttons .input:eq(11)').prop('disabled',false);
			$('.tabinput #buttons .pre').prop('disabled',true);
			$('.tabinput #buttons .next').prop('disabled',true);
		}
	});
	$('.tabinput #buttons').on('click','#next',function(event){
		//oneEvent(event);
		if($('.tabinput #buttons .input:eq(0)').val()=='A'){
			for(var i=0;i<12;i++){
				$('.tabinput #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(12)));
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
		else if($('.tabinput #buttons .input:eq(0)').val()=='M'){
			for(var i=0;i<2;i++){
				$('.tabinput #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(24)));
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',false);
			}
			for(var i=2;i<12;i++){
				$('.tabinput #buttons .input:eq('+i+')').val('');
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',true);
			}
		}
		else{
			for(var i=0;i<12;i++){
				$('.tabinput #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)));
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
	});
	$('.tabinput #buttons').on('click','#pre',function(event){
		//oneEvent(event);
		if($('.tabinput #buttons .input:eq(0)').val()=='A'){
			for(var i=0;i<2;i++){
				$('.tabinput #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(24)));
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',false);
			}
			for(var i=2;i<12;i++){
				$('.tabinput #buttons .input:eq('+i+')').val('');
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',true);
			}
		}
		else if($('.tabinput #buttons .input:eq(0)').val()=='M'){
			for(var i=0;i<12;i++){
				$('.tabinput #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)));
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
		else{
			for(var i=0;i<12;i++){
				$('.tabinput #buttons .input:eq('+i+')').val(String.fromCharCode(parseInt(65)+parseInt(i)+parseInt(12)));
				$('.tabinput #buttons .input:eq('+i+')').prop('disabled',false);
			}
		}
	});
	$('.tabinput #buttons').on('click','#ac',function(event){
		//oneEvent(event);
		$('.tabinput #view #tabnum').html('');
	});
	$('.tabinput #buttons').on('click','#submit',function(event){
		//oneEvent(event);
		$('.order#order #banner #tablenumber .tabnumbox').html($('.tabinput #view #tabnum').html());
		$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="tablenumber"]').val($('.tabinput #view #tabnum').html());
		$('.tabinput #view #tabnum').html('');
		tabinput.dialog('close');
	});
	$('.tabinput #buttons').on('click','#cancel',function(event){
		//oneEvent(event);
		$('.tabinput #view #tabnum').html('');
		tabinput.dialog('close');
	});
	/**/
	$('.openmoney #buttons').on('click','.input',function(event){
		//oneEvent(event);
		var index=$('.openmoney #buttons .input').index(this);
		if($('.openmoney #view #money').val().length>=20){
		}
		else{
			if($('.openmoney #view #money').val()=='0'){
				$('.openmoney #view #money').val($('.openmoney #buttons .input:eq('+index+')').val());
			}
			else{
				$('.openmoney #view #money').val($('.openmoney #view #money').val()+$('.openmoney #buttons .input:eq('+index+')').val());
			}
		}
	});
	$('.openmoney #buttons').on('click','#changesign',function(event){
		//oneEvent(event);
		$('.openmoney #view #money').val(Number($('.openmoney #view #money').val())*-1);
	});
	$('.openmoney #buttons').on('click','#ac',function(event){
		//oneEvent(event);
		$('.openmoney #view #money').val('0');
	});
	$('.openmoney #buttons').on('click','#back',function(event){
		//oneEvent(event);
		if($('.openmoney #view #money').val().length==1||$('.openmoney #view #money').val()=='0'){
			$('.openmoney #view #money').val('0');
		}
		else{
			$('.openmoney #view #money').val($('.openmoney #view #money').val().substr(0,$('.openmoney #view #money').val().length-1));
		}
	});
	$('.openmoney #buttons').on('click','#submit',function(event){
		//oneEvent(event);
		diff();
		$('.order#order #tabs1 #tempbox input[name="unitprice"]').val($('.openmoney #view #money').val());
		$('.order#order #tabs1 #tempbox input[name="money"]').val(Number($('.openmoney #view #money').val())+Number($('.order#order #tabs1 #tempbox input[name="taste1money"]').val()));
		$('.order#order #tabs1 #tempbox input[name="subtotal"]').val(Number($('.order#order #tabs1 #tempbox input[name="number"]').val())*Number($('.order#order #tabs1 #tempbox input[name="money"]').val()));
		$('.order#order #editview').trigger('change');
		sumsubtotal();
		$('.openmoney #view #money').val('0');
		openmoney.dialog('close');
	});
	$('.openmoney #buttons').on('click','#cancel',function(event){
		//oneEvent(event);
		$('.openmoney #view #money').val('0');
		openmoney.dialog('close');
	});
	/**/
	$('.order#order #banner #detail #tw #view').click(function(event){//('.order#order #banner #detail #tw #view')
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單','click');
		//oneEvent(event);
		if(viewtemp.dialog('isOpen')){
			viewtemp.dialog('close');
		}
		viewtemp.dialog('open');
		$('.viewtemp input[name="salebarcode"]').focus();
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'temp':'temp','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.viewtemp #salelist #salecontent').html(d);
				$('.viewtemp #rightnow #ttmoney').html($('.viewtemp #salelist input[name="ttmoney"]').val());
				$('.viewtemp #rightnow #ttcount').html($('.viewtemp #salelist input[name="ttcount"]').val());
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.funbox').on('click','#view',function(event){
		//oneEvent(event);
		viewtemp.dialog('open');
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'temp':'temp','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.viewtemp #salelist #salecontent').html(d);
				$('.viewtemp #rightnow #ttmoney').html($('.viewtemp #salelist input[name="ttmoney"]').val());
				$('.viewtemp #rightnow #ttcount').html($('.viewtemp #salelist input[name="ttcount"]').val());
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.order#order #MemberBill #list #funbox').on('click','#numkeybord',function(event){
		//oneEvent(event);
		keybord.dialog('open');
	});
	$('.keybord').on('click','#cancel',function(event){
		//oneEvent(event);
		keybord.dialog('close');
	});
	$('.keybord').on('click','#send',function(event){
		//oneEvent(event);
		if($('.keybord input[name="num"]').val().length>=0&&$('.keybord input[name="num"]').val().substr(1,1)!="e"){
			/*if($('.keybord input[name="type"]').val()=='creditcard'){//2022/4/6 強制關閉，不紀錄信用卡後4碼，資料庫欄位轉移給nccc串接編號，以利後續刷退使用//輸入完信用卡後4碼，再進入結帳流程
				$('.result .sendviewwindow input[name="creditcard"]').val($('.keybord input[name="num"]').val());
				var nowbizdate=$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val();
				if(typeof $('.result #viewwindow input[name="ininv"]').val()!=='undefined'){
					$('.result #viewwindow input[name="ininv"]').val($('.result #viewwindow #ininv').html());
				}
				else{
				}
				if(typeof $('.result #viewwindow input[name="freeinv"]').val()!=='undefined'){
					$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
				}
				else{
				}
				var bizdate='';
				if(typeof $('.result #viewwindow input[name="sendtype"]')=="undefined"||$('.result #viewwindow input[name="sendtype"]').val()=='result'||$('.result #viewwindow input[name="sendtype"]').val()=='tempquicksale'){
					bizdate=$('#tabs4 form[data-id="listform"] input[name="bizdate"]').val();
					var array1=$('#tabs4 form[data-id="listform"] , .result #viewwindow .sendviewwindow').serialize()+'&salelisthint='+$('.order#order #banner #detail #salelisthint').val();
					//console.log(array1);
				}
				else{
					bizdate=$('.viewtemp #date').html();
					var array1=$(".result #viewwindow .sendviewwindow").serialize();
					array1=array1+'&charge='+$('.result #viewwindow #charge').html()+'&machinetype='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&bizdate='+$('.viewtemp #date').html()+'&consecnumber='+$('.viewtemp #listno input[name="consecnumber"]').val();
					//console.log(array1);
				}
				var invnumber='';
				var consecnumber='';
				$('.result #checkfun #submit').prop('disabled',true);
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				$.ajax({//寫入暫存資料表
					url:'./lib/js/create.tempdb.php',
					method:'post',
					async:false,
					data:array1,
					dataType:'html',
					success:function(d){
						if(d.length>40||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard-send create.tempdb.php '+d},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						//console.log(d);
						var tempd=d.split('-');
						consecnumber=tempd[1];
						if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
							$('.order#order #tabs4 form[data-id="listform"] input[name="saleno"]').val(tempd[0]);
							$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(tempd[1]);
							array1=$('#tabs4 form[data-id="listform"] , .result #viewwindow .sendviewwindow').serialize();
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							posdvrfile=tempd[2];
						}
						else{
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				var memberapi='';
				$.ajax({
					url:'./lib/js/checkmember.pointmoney.ajax.php',
					method:'post',
					async:false,
					data:{'company':$('.order#order .companydata #company').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'bizdate':bizdate,'consecnumber':consecnumber},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(d[0].length==0){
						}
						else{
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								if($('.result #viewwindow input[name="sendtype"]').val()!='tempsale'){//2020/4/20 排除暫開發票的情況
									if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
										memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,'',d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
										//if(memberapi[0]['state']=='success'){//與上方api_point_money_ourmember功能重複//2020/5/5 移除，若有會員點數、儲值金有錯誤再打開
										//	$.ajax({
										//		url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
										//		method:'post',
										//		async:false,
										//		data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
										//		dataType:'html',
										//		success:function(d){
										//			//console.log(d);
										//		},
										//		error:function(e){
										//			//console.log(e);
										//		}
										//	});
										//}
										//else{
										//}
										$.ajax({
											url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
											method:'post',
											async:false,
											data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
											dataType:'html',
											success:function(d){
												//console.log(d);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
										});
									}
									else{
									}
								}
								else{
								}
							}
							else{//本地會員
								if($('.result #viewwindow input[name="sendtype"]').val()!='tempsale'){//2020/4/20 排除暫開發票的情況
									if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
										$.ajax({
											url:'../memberapi/point_money.ajax.php',
											method:'post',
											async:false,
											data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
											dataType:'json',
											timeout:5000,
											success:function(d){
												memberapi=d;
												//console.log(res);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e,t){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
												if(t==="timeout"){
													memberapi=[{"state":"fail","message":"AJAX timeout"}];
												}
												else{
													memberapi=e;
												}
											}
										});
										//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
										if(memberapi[0]['state']=='success'){
											$.ajax({
												url:'../memberapi/change.memberdata.php',
												method:'post',
												async:false,
												data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
												dataType:'html',
												success:function(d){
													//console.log(d);
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
														dataType:'html',
														success:function(d){
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
														dataType:'html',
														success:function(d){
															//console.log(d);
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
											});
										}
										else{
										}
										$.ajax({
											url:'../memberapi/insertmemlist.ajax.php',
											method:'post',
											async:false,
											data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
											dataType:'html',
											success:function(d){
												//console.log(d);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
										});
									}
									else{
									}
								}
								else{
								}
							}
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				//錢都錄借接
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					//start tag
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					//end tag
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if($('.order#order .initsetting #ticketlisttype').val().match($('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val())&&($('.order#order .initsetting #ticket').val()=='2'||$('.order#order .initsetting #ticket').val()=='3')){//出"兌換卷"
					$.ajax({
						url:'./lib/js/create.ticket.php',
						method:'post',
						async:false,
						data:$('#tabs4 form[data-id="listform"]').serialize(),
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'temp create.ticket.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							consecnumber=d;
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''||$('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
				}
				else{
					$.ajax({
						url:'./lib/js/create.voidlist.php',
						method:'post',
						async: false,
						data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send create.voidlist.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				
				if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''||$('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
				}
				else{
					$.ajax({
						url:'./lib/js/create.voidkitchen.php',
						method:'post',
						async: false,
						data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'username':$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send create.voidkitchen.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				//$.ajax({//產生產品明細單
				//	url:'./lib/js/create.list.php',
				//	method:'post',
				//	async:false,
				//	data:array1,
				//	dataType:'html',
				//	success:function(d){
				//		if(d.length>10||d.match('ERROR HINT: ')){//write error log
				//			$.ajax({
				//				url:'./lib/js/print.php',
				//				method:'post',
				//				data:{'html':d},
				//				dataType:'html',
				//				success:function(d){
				//					//console.log(d);
				//				},
				//				error:function(e){
				//					//console.log(e);
				//				}
				//			});
				//		}
				//		else{
				//		}
				//		//console.log('明細單'+d);
				//		consecnumber=d;
				//	},
				//	error:function(e){
				//		//console.log(e);
				//	}
				//});
				var opencashdraw=1;//2020/5/13
				if(($('.result input[name="sendtype"]').val()=='result'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用發票&&開立發票
					$.ajax({
						url:'./lib/js/open.inv.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send open.inv.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('發票'+d);
							invnumber=d;
							//$.ajax({
							//	url:'./lib/js/getzdn.invnumber.php',
							//	dataType:'html',
							//	success:function(d){
							//		//console.log(d);
							//		if(d=='success'){
							//			//中鼎下載發票
							//			if(typeof $('.order#order .zdn')!=='undefined'&&typeof api_zdn_gettoken!=="undefined"&&typeof api_zdn_gettoken==="function"){
							//				var today = new Date();
							//				if((today.getMonth() + 1)%2==1){
							//					var mm = String(today.getMonth() + 2); //January is 0!
							//					if(mm.length<2){
							//						mm=String('0')+String(mm);
							//					}
							//					else{
							//					}
							//				}
							//				else{
							//					var mm = String(today.getMonth() + 1); //January is 0!
							//					if(mm.length<2){
							//						mm=String('0')+String(mm);
							//					}
							//					else{
							//					}
							//				}
							//				var yyyy = Number(today.getFullYear())-1911;
							//
							//				var res='';
							//				res=api_zdn_gettoken($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #psw').val());//取得中鼎token
							//				res.done(function(res){
							//					res=JSON.parse(res);
							//					//console.log(res['token']);
							//					if(typeof res['token']){
							//						$('.order#order .zdn #token').val(res['token']);
							//						res='';
							//						res=api_zdn_showTrack($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),String(yyyy)+String(mm));
							//						res.done(function(res){
							//							res=JSON.parse(res);
							//							//console.log(res);
							//							var remaining=0;
							//							if(res['data'].length>0){
							//								for(var i=0;i<res['data'].length;i++){
							//									if(res['data'][i]['type']=='07'&&Number(res['data'][i]['used_booklet'])<Number(res['data'][i]['total_booklet'])){
							//										remaining=Number(remaining)+Number(res['data'][i]['total_booklet'])-Number(res['data'][i]['used_booklet']);
							//									}
							//									else{
							//									}
							//								}
							//								if(remaining>0){
							//									res='';
							//									res=api_zdn_getInv($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),remaining);//取得發票號(以"本"為單位；1本50張)
							//									res.done(function(res){
							//										res=JSON.parse(res);
							//										//console.log(res);
							//										if(res['success']==true){
							//											$.ajax({
							//												url:'./lib/js/create.invfile.php',
							//												method:'post',
							//												data:{'machine':$('.order#order .companydata #terminalnumber').val(),'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'data':res},
							//												dataType:'html',
							//												success:function(d){
							//													//console.log(d);
							//												},
							//												error:function(e){
							//													//console.log(e);
							//												}
							//											});
							//										}
							//										else{
							//										}
							//									});
							//									//console.log(remaining);
							//								}
							//								else{
							//									//console.log('empty');
							//								}
							//							}
							//							else{
							//							}
							//						});
							//					}
							//					else{
							//					}
							//				});
							//			}
							//			else{
							//			}
							//		}
							//		else{
							//		}
							//	},
							//	error:function(e){
							//		//console.log(e);
							//	}
							//});
						},
						error:function(e){
							//console.log(e);
						}
					});

					if($('.order#order .initsetting #opencashdraw').val()=='0'&&invnumber.length==10&&$('.result #viewwindow input[name="tempcontainer"]').val()==''){//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
						opencashdraw=0;
					}
					else{
						opencashdraw=1;
					}
				}
				else if(($('.result input[name="sendtype"]').val()=='tempsale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用發票&&開立發票
					$.ajax({
						url:'./lib/js/open.inv.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send open.inv.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('發票'+d);
							invnumber=d;
							//$.ajax({
							//	url:'./lib/js/getzdn.invnumber.php',
							//	dataType:'html',
							//	success:function(d){
							//		//console.log(d);
							//		if(d=='success'){
							//			//中鼎下載發票
							//			if(typeof $('.order#order .zdn')!=='undefined'&&typeof api_zdn_gettoken!=="undefined"&&typeof api_zdn_gettoken==="function"){
							//				var today = new Date();
							//				if((today.getMonth() + 1)%2==1){
							//					var mm = String(today.getMonth() + 2); //January is 0!
							//					if(mm.length<2){
							//						mm=String('0')+String(mm);
							//					}
							//					else{
							//					}
							//				}
							//				else{
							//					var mm = String(today.getMonth() + 1); //January is 0!
							//					if(mm.length<2){
							//						mm=String('0')+String(mm);
							//					}
							//					else{
							//					}
							//				}
							//				var yyyy = Number(today.getFullYear())-1911;
							//
							//				var res='';
							//				res=api_zdn_gettoken($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #psw').val());//取得中鼎token
							//				res.done(function(res){
							//					res=JSON.parse(res);
							//					//console.log(res['token']);
							//					if(typeof res['token']){
							//						$('.order#order .zdn #token').val(res['token']);
							//						res='';
							//						res=api_zdn_showTrack($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),String(yyyy)+String(mm));
							//						res.done(function(res){
							//							res=JSON.parse(res);
							//							//console.log(res);
							//							var remaining=0;
							//							if(res['data'].length>0){
							//								for(var i=0;i<res['data'].length;i++){
							//									if(res['data'][i]['type']=='07'&&Number(res['data'][i]['used_booklet'])<Number(res['data'][i]['total_booklet'])){
							//										remaining=Number(remaining)+Number(res['data'][i]['total_booklet'])-Number(res['data'][i]['used_booklet']);
							//									}
							//									else{
							//									}
							//								}
							//								if(remaining>0){
							//									res='';
							//									res=api_zdn_getInv($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),remaining);//取得發票號(以"本"為單位；1本50張)
							//									res.done(function(res){
							//										res=JSON.parse(res);
							//										//console.log(res);
							//										if(res['success']==true){
							//											$.ajax({
							//												url:'./lib/js/create.invfile.php',
							//												method:'post',
							//												data:{'machine':$('.order#order .companydata #terminalnumber').val(),'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'data':res},
							//												dataType:'html',
							//												success:function(d){
							//													//console.log(d);
							//												},
							//												error:function(e){
							//													//console.log(e);
							//												}
							//											});
							//										}
							//										else{
							//										}
							//									});
							//									//console.log(remaining);
							//								}
							//								else{
							//									//console.log('empty');
							//								}
							//							}
							//							else{
							//							}
							//						});
							//					}
							//					else{
							//					}
							//				});
							//			}
							//			else{
							//			}
							//		}
							//		else{
							//		}
							//	},
							//	error:function(e){
							//		//console.log(e);
							//	}
							//});
						},
						error:function(e){
							//console.log(e);
						}
					});

					if($('.order#order .initsetting #opencashdraw').val()=='0'&&invnumber.length==10&&$('.result #viewwindow input[name="tempcontainer"]').val()==''){//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
						opencashdraw=0;
					}
					else{
						opencashdraw=1;
					}
				}
				else if(($('.result input[name="sendtype"]').val()=='tempquicksale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用發票&&開立發票
					$.ajax({
						url:'./lib/js/open.inv.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'sale open.inv.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('發票'+d);
							invnumber=d;
						},
						error:function(e){
							//console.log(e);
						}
					});

					if($('.order#order .initsetting #opencashdraw').val()=='0'&&invnumber.length==10&&$('.result #viewwindow input[name="tempcontainer"]').val()==''){//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
						opencashdraw=0;
					}
					else{
						opencashdraw=1;
					}
				}
				else if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')){
					invnumber=$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html();

					opencashdraw=1;
				}
				if(($('.result input[name="sendtype"]').val()=='result'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useoinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用傳統發票&&開立傳統發票
					$.ajax({
						url:'./lib/js/open.oinv.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send open.oinv.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('發票'+d);
							invnumber=d;
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else if(($('.result input[name="sendtype"]').val()=='tempsale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useoinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用傳統發票&&開立傳統發票
					$.ajax({
						url:'./lib/js/open.oinv.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send open.oinv.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('發票'+d);
							invnumber=d;
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else if(($('.result input[name="sendtype"]').val()=='tempquicksale'&&!$('.result #funbox .invbut').prop('disabled'))&&(typeof $('.result #funbox .invno').val()=="undefined"||$('.result #funbox .invno').val()=='1')&&$('.order#order .initsetting #useoinv').val()=='1'&&Number($('.result #viewwindow input[name="ininv"]').val())>0){//啟用傳統發票&&開立傳統發票
					$.ajax({
						url:'./lib/js/open.oinv.php',
						method:'post',
						async:false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'tempban':$('.result #viewwindow input[name="tempban"]').val(),'tempcontainer':$('.result #viewwindow input[name="tempcontainer"]').val(),'invlist':$('.order#order #tabs4 form[data-id="listform"] input[name="invlist"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'sale open.oinv.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('發票'+d);
							invnumber=d;
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')){
					invnumber=$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html();
				}
				else{
				}

				if($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale'){
					consecnumber=$('.viewtemp #listno input[name="consecnumber"]').val();
				}
				else{
					if(typeof memberapi[0]!=="undefined"){
						array1=array1+'&'+decodeURIComponent($.param(memberapi[0]));
					}
					else{
					}
					if(typeof $('.result #funbox #receipt').val()=="undefined"||$('.result #funbox #receipt').val()=='0'){
					}
					else{
						array1=array1+'&receipt=1';
					}
					$.ajax({
						url:'./lib/js/create.list.php',
						method:'post',
						async: false,
						data:array1,
						dataType:'html',
						success:function(d){
							if(d.length>10||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send create.list.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('明細單'+d);
							consecnumber=d;
						},
						error:function(e){
							//console.log(e);
						}
					});
				}

				if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='tempsale'){//暫結需開發票之情況
				}
				else{
					if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='buytemp'||$('.result input[name="sendtype"]').val()=='tempquicksale'){
						if($('.nidin #usenidin').length>0){
							if($('.result #paywindow .paywaybox .nidinother').length>0){//2021/11/8 nidin線上已付款
								nidin_finish($('.viewtemp #date').html(),consecnumber,'','');
							}
							else{
								nidin_finish($('.viewtemp #date').html(),consecnumber,13,'1');
							}
						}
						else{
						}
						$.ajax({
							url:'./lib/js/temptodb.ajax.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'numbertag':consecnumber},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'creditcard-send temptodb.ajax.php '+d},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
								//console.log('轉移正式'+consecnumber);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						if($('.nidin #usenidin').length>0){
							if($('.result #paywindow .paywaybox .nidinother').length>0){//2021/11/8 nidin線上已付款(基本上不會進到這個流程，已付款只能暫結直接結帳)
								nidin_finish($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,'','');
							}
							else{
								nidin_finish($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,13,'1');
							}
						}
						else{
						}
						$.ajax({
							url:'./lib/js/temptodb.ajax.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'numbertag':consecnumber},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'creditcard-send temptodb.ajax.php '+d},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
								//console.log('轉移正式'+consecnumber);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
				}
				if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')){
				}
				else{
					$.ajax({//產生工作單
						url:'./lib/js/create.kitchen.php',
						method:'post',
						async:false,
						data:array1,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send create.kitchen.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log('工作單'+d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				if(typeof $('.result input[name="sendtype"]')!="undefined"&&($('.result input[name="sendtype"]').val()=='buytemp'||$('.result #viewwindow input[name="sendtype"]').val()=='tempsale')){
				}
				else{
					$.ajax({//產生貼紙
						url:'./lib/js/create.tag.php',
						method:'post',
						async:false,
						data:array1,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send create.tag.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}

							//console.log('貼紙'+d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				if($('.order#order .initsetting #secview').val()=='1'){
					$.ajax({
						url:'../secview/cleartemp.ajax.php',
						method:'post',
						async: false,
						data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard-send cleartemp.ajax.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
						socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
						console.log('send message "clear" to secview');
					}
					else{
					}
				}
				else{
				}

				if(opencashdraw==1){
					$.ajax({
						url:'./lib/js/create.cmdtxt.php',
						method:'post',
						async: false,
						data:{'cmd':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'-cashdrawer_'+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{//2020/5/13 使用中鼎發票，具有發票號碼且有載具號碼
				}
				
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				//2017/12/29var mywin=window.open('cashdrawer://','','width=1px,height=1px');
				//2017/12/29mywin.document.title='cashdrawer';

				//集點樹贈點流程
				if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='tempsale'){//暫結需開發票之情況
				}
				else{
					var ptpoint=0;//兌換點數
					var ptpmoney=0;//兌換點數折扣金額
					var ptmoney=parseFloat($('.result #viewwindow #cash').html())+parseFloat($('.result #viewwindow #cashmoney').html());//集點金額:現金+信用卡金額
					if(typeof $('.result .sendviewwindow input[name="otherstring"]').val()!=="undefined"&&$('.result .sendviewwindow input[name="otherstring"]').val().length>0){
						var tempotherstring=$('.result .sendviewwindow input[name="otherstring"]').val().split(",");
						$.each(tempotherstring,function(v,i){
							var t1=i.split(":");
							var t1name=t1[0].split("-");
							var t1point=t1[1].split("=");
							if(t1name[0]=='pointtree'){
								ptpoint=t1point[0];
								ptppoint=t1point[1];
								return false;
							}
							else{
							}
						});
						if($('.result #viewwindow input[name="treetel"]').val().length>0&&Number(ptpoint)>0){
							//start tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'start point-tree-exchange redeem','file':'point-tree'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(typeof api_exchange_pointtree!=="undefined"&&typeof api_exchange_pointtree==="function"){
								if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='buytemp'){
									var exchangeres=api_exchange_pointtree($('.viewtemp #date').html(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),ptpoint);
								}
								else{
									var exchangeres=api_exchange_pointtree($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),ptpoint);
								}
								//console.log(exchangeres);
								if(exchangeres==''){
									$.ajax({
										url:'./lib/api/print.ticket.php',
										method:'post',
										async:false,
										data:{'type':'pointtree','message':'point-tree-exchange getrandom 意外錯誤'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-exchange getrandom 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else if(typeof exchangeres['data']!=="undefined"){//success
									//$.ajax({
									//	url:'./lib/api/print.ticket.php',
									//	method:'post',
									//	async:false,
									//	data:{'type':'pointtree','tel':$('.result #viewwindow input[name="treetel"]').val(),'user_balance':exchangeres['data']['user_balance']},
									//	dataType:'html',
									//	success:function(d){
									//		//console.log(d);
									//	},
									//	error:function(e){
									//		//console.log(e);
									//	}
									//});
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'pass point-tree-exchange redeem -PHP_EOL-pos_token_tx_id:'+exchangeres['data']['pos_token_tx_id'],'file':'point-tree'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
									var message=JSON.parse(exchangeres['responseText']);
									if(exchangeres['status']==='timeout'){
										$.ajax({
											url:'./lib/api/print.ticket.php',
											method:'post',
											async:false,
											data:{'type':'pointtree','message':'point-tree-exchange redeem timeout'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-exchange redeem timeout','file':'point-tree'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else if(exchangeres['status']=='400'||exchangeres['status']=='406'){
										$.ajax({
											url:'./lib/api/print.ticket.php',
											method:'post',
											async:false,
											data:{'type':'pointtree','status':exchangeres['status'],'code':message['errors'][0]['code'],'message':message['errors'][0]['message']},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-exchange redeem error -PHP_EOL-status:'+exchangeres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										$.ajax({
											url:'./lib/api/print.ticket.php',
											method:'post',
											async:false,
											data:{'type':'pointtree','message':'point-tree-exchange redeem 意外錯誤'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-exchange redeem 意外錯誤','file':'point-tree'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								}
							}
							else{
								$.ajax({
									url:'./lib/api/print.ticket.php',
									method:'post',
									async:false,
									data:{'type':'pointtree','message':'api exchange pointtree is not function'},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'api exchange pointtree is not function','file':'point-tree'},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							//end tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'end point-tree-exchange redeem','file':'point-tree'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
					}
					else{
					}
					if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
						if($('.result #viewwindow input[name="treetel"]').val().length>0&&Number(ptmoney)>0){
							//start tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'start point-tree-gift transfer','file':'point-tree'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(typeof api_gift_pointtree!=="undefined"&&typeof api_gift_pointtree==="function"){
								if(typeof $('.result input[name="sendtype"]')!="undefined"&&$('.result input[name="sendtype"]').val()=='buytemp'){
									var giftres=api_gift_pointtree($('.viewtemp #date').html(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),(parseFloat($('.result #viewwindow #cash').html())+parseFloat($('.result #viewwindow #cashmoney').html())));
								}
								else{
									var giftres=api_gift_pointtree($('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),consecnumber,$('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val(),(parseFloat($('.result #viewwindow #cash').html())+parseFloat($('.result #viewwindow #cashmoney').html())));
								}
								if(giftres==''){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'point-tree-gift getrandom 意外錯誤','file':'point-tree'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else if(typeof giftres['data']!=="undefined"){//success
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'pass point-tree-gift transfer -PHP_EOL-pos_token_tx_id:'+giftres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+giftres['data']['store_balance']+'-PHP_EOL-user_balance:'+giftres['data']['user_balance'],'file':'point-tree'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
									var message=JSON.parse(giftres['responseText']);
									if(giftres['status']==='timeout'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-gift transfer timeout','file':'point-tree'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else if(giftres['status']=='400'||giftres['status']=='406'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-gift transfer error -PHP_EOL-status:'+giftres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'point-tree-gift transfer 意外錯誤','file':'point-tree'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								}
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'api gift pointtree is not function','file':'point-tree'},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							//end tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'end point-tree-gift transfer','file':'point-tree'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
					}
					else{
					}
				}

				if($('.order#order .initsetting #changehint').val()=='1'){
					keybord.dialog('close');
					result.dialog('close');
					$('.changehint .inv').val(invnumber);
					$('.changehint .should').val($('.result #viewwindow #should').html());
					$('.changehint .already').val($('.result #viewwindow #already').html());
					$('.changehint .change').val($('.result #viewwindow #change').html());
					change.dialog('open');
				}
				else{
					if(viewtemp.dialog('isOpen')){
						//alertmessage('發票開立完成。');
						$('.alertmessage #text').html('發票開立完成。');
						alertmessage.dialog('open');
						ClearWindow('','');
						keybord.dialog('close');
						result.dialog('close');
						viewtemp.dialog('close');
						$('.order#order #list #funbox #view').trigger('click');
						$.ajax({
							url:'./lib/js/check.booking.php',
							method:'post',
							async:false,
							data:{'machinetype':$('.order#order .companydata #terminalnumber').val()},
							dataType:'html',
							success:function(d){
								if(d=='success'){
									if($('.order#order #banner #detail #tw #point').css('background-color')=='red'){
									}
									else{
										$('.order#order #banner #detail #tw #point').css({'background-color':'red','z-index':'3'});
									}
								}
								else{
									$('.order#order #banner #detail #tw #point').css({'background-color':'','z-index':''});
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						window.setTimeout(function(){
							if($('.order#order .initsetting #controltable').val()=='1'){
								if($('.order#order .companydata #submachine').length>0){
									location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
								}
								else{
									if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
										location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
									}
									else{
										location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
									}
								}
							}
							else{
								//if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val().length>0){
									//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
									ClearWindow('','');
									keybord.dialog('close');
									result.dialog('close');
								//}
								//else{
								//	location.href='./order.php';
								//}
							}},500);
					}
				}
			}
			else{*///192.168.0.128
				if($.isNumeric($('.keybord input[name="num"]').val())){
					$.ajax({
						url:'./lib/js/getborddata.ajax.php',
						method:'post',
						async:false,
						data:{'num':$('.keybord input[name="num"]').val()},
						dataType:'json',
						success:function(d){
							$.ajax({
								url:'http://'+d[3]+'/bord/callnumber.php',
								method:'get',
								data:{'company':d[0],'dep':d[1],'num':d[2]},
								dataType:'html',
								success:function(v){
									if(v.match(/http:/)){
										$.ajax({
											url:v,
											method:'get'
										});
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'call number : '+d[2]},
								dataType:'html',
								success:function(d){},
								error:function(e){}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/writecallnum.ajax.php',
						method:'post',
						data:{'num':$('.keybord input[name="num"]').val()},
						dataType:'html',
						success:function(d){
							if(d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'callnumber writecallnum.ajax.php '+d},
									dataType:'html',
									success:function(d){},
									error:function(e){}
								});
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					//console.log('call');
				}
				else{
					if($('.sysmeg #name1.syshint3').length>0){
						$('.sysmeg #name1.syshint3').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint3').length>0){
						$('.sysmeg #name2.syshint3').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
					//alertmessage('號碼格式錯誤。');
				}
			//}
		}
		else{
			if($('.sysmeg #name1.syshint3').length>0){
				$('.sysmeg #name1.syshint3').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint3').length>0){
				$('.sysmeg #name2.syshint3').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
			//alertmessage('號碼格式錯誤。');
		}
	});
	$('.keybord').on('click','#clear',function(event){
		//oneEvent(event);
		/*if($('.keybord input[name="type"]').val()=='creditcard'){//2022/4/6 強制關閉，不紀錄信用卡後4碼，資料庫欄位轉移給nccc串接編號，以利後續刷退使用
			$('.keybord input[name="num"]').val('');
		}
		else{*/
			$('.keybord input[name="num"]').val('0');
		//}
	});
	$('.keybord').on('click','#back',function(event){
		//oneEvent(event);
		if($('.keybord input[name="num"]').val().length==1){
			/*if($('.keybord input[name="type"]').val()=='creditcard'){//2022/4/6 強制關閉，不紀錄信用卡後4碼，資料庫欄位轉移給nccc串接編號，以利後續刷退使用
				$('.keybord input[name="num"]').val('');
			}
			else{*/
				$('.keybord input[name="num"]').val('0');
			//}
		}
		else{
			$('.keybord input[name="num"]').val($('.keybord input[name="num"]').val().substr(0,$('.keybord input[name="num"]').val().length-1));
		}
	});
	$('.keybord').on('click','#number',function(event){
		//oneEvent(event);
		if(($('.keybord input[name="num"]').val().toString()+$(this).val().toString()).length>$('.keybord input[name="num"]').prop('max').length||Number($('.keybord input[name="num"]').val().toString()+$(this).val().toString())>Number($('.keybord input[name="num"]').prop('max'))){
		}
		else{
			/*if($('.keybord input[name="type"]').val()=='creditcard'){//2022/4/6 強制關閉，不紀錄信用卡後4碼，資料庫欄位轉移給nccc串接編號，以利後續刷退使用
				$('.keybord input[name="num"]').val($('.keybord input[name="num"]').val()+$(this).val());
			}
			else{*/
				if($('.keybord input[name="num"]').val()=='0'){
					$('.keybord input[name="num"]').val($(this).val());
				}
				else{
					$('.keybord input[name="num"]').val($('.keybord input[name="num"]').val()+$(this).val());
				}
			//}
		}
	});
	$('.keybord input[name="num"]').putCursorAtEnd().on("focus", function() {
		$('.keybord input[name="num"]').putCursorAtEnd()
    });
	$('.keybord input[name="num"]').on('input',function(){
		if($('.keybord input[name="num"]').val().toString().length>$('.keybord input[name="num"]').prop('max').length||Number($('.keybord input[name="num"]').val())>Number($('.keybord input[name="num"]').prop('max'))){
			$('.keybord input[name="num"]').val($('.keybord input[name="num"]').val().substr(1,$('.keybord input[name="num"]').prop('max').length));
		}
		else{
		}
	});
	$('.keybord').on('click','#add',function(event){
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/addnumber.php',
			dataType:'html',
			success:function(d){
				$('.keybord input[name="num"]').val(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.keybord').on('click','#diff',function(event){
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/diffnumber.php',
			dataType:'html',
			success:function(d){
				$('.keybord input[name="num"]').val(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.viewtemp #salelist #salecontent').on('click','.listitems',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單選擇帳單',$('.itemdis input[name="view"]').val());
		//oneEvent(event);
		var index=$('.viewtemp #salelist #salecontent .listitems').index(this);
		$('.viewtemp #salelist #salecontent .listitems').prop('id','');
		$('.viewtemp #salelist #salecontent .listitems:eq('+index+')').prop('id','focus');
		$('.viewtemp #listno').html($('.viewtemp #salelist #salecontent .listitems:eq('+index+') div:eq(1)').html());
		$('.viewtemp #date').html($('.viewtemp #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html());
		$('.viewtemp #credate').val($('.viewtemp #salelist #salecontent .listitems:eq('+index+') div:eq(9)').html().substr(0,8));
		$('.viewtemp #credatetime').val($('.viewtemp #salelist #salecontent .listitems:eq('+index+') div:eq(9)').html());
		$.ajax({
			url:'./lib/js/getsaledetail.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'bizdate':$('.viewtemp #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html(),'no':$('.viewtemp #salelist #salecontent .listitems:eq('+index+') div:eq(1) input[name="consecnumber"]').val(),'temp':'temp'},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.viewtemp #list #listcontent').html(d);
				$.ajax({//2021/11/1 檢查開班狀態，避免未開班直接結帳
					url:'./lib/js/checkopen.ajax.php',
					method:'post',
					async:false,
					data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						if(d=='success'){
							if($('.viewtemp #salelist #salecontent .listitems:eq('+index+') div:eq(10)').html()=="Y"){
								$('.viewtemp #viewvoid').prop('disabled',true);
								$('.viewtemp #otherfun button#plus').prop('disabled',true);
								$('.viewtemp #otherfun button#sale').prop('disabled',true);
								$('.viewtemp #otherfun button#openinv').prop('disabled',true);
								$('.viewtemp #fun button#tag').prop('disabled',true);
								$('.viewtemp #fun button#forall').prop('disabled',true);
								$('.viewtemp #fun button#kitchen').prop('disabled',true);
								$('.viewtemp #fun button#changecheck').prop('disabled',true);
								$('.viewtemp #fun button#editoutman').prop('disabled',true);
							}
							else{
								if($('.order#order .companydata #ispad').val()=='submachine'){
									$('.viewtemp #viewvoid').prop('disabled',true);
								}
								else{
									$('.viewtemp #viewvoid').prop('disabled',false);
								}
								if($('.viewtemp #salelist #salecontent .listitems#focus div:eq(7)').html()=='QuickClick'){//2022/2/10 quickclick接單不允許加點
									$('.viewtemp #otherfun button#plus').prop('disabled',true);
								}
								else if($('.viewtemp #salelist #salecontent .listitems#focus div:eq(7)').html()=='FoodPanda'){//2021/11/4 foodpanda接單不允許加點
									$('.viewtemp #otherfun button#plus').prop('disabled',true);
								}
								else if($('.viewtemp #salelist #salecontent .listitems#focus div:eq(7)').html()=='UberEats'){//2021/11/4 ubereats接單不允許加點
									$('.viewtemp #otherfun button#plus').prop('disabled',true);
								}
								else if($('.viewtemp #salelist #salecontent .listitems#focus div:eq(7)').html()=='nidin'){//2021/3/11 nidin訂單不允許加點
									$('.viewtemp #otherfun button#plus').prop('disabled',true);
								}
								else if($('.viewtemp #salelist #salecontent .listitems#focus div:eq(7)').html()=='英特拉付款'){//2021/9/10 網路訂單且已使用英特拉付款不允許加點
									$('.viewtemp #otherfun button#plus').prop('disabled',true);
								}
								else{
									$('.viewtemp #otherfun button#plus').prop('disabled',false);
								}
								$('.viewtemp #otherfun button#sale').prop('disabled',false);
								if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())==""&&$('.order#order .initsetting #useinv').val()==1&&$('.order#order .initsetting #temptoinv').val()==1){
									$('.viewtemp #otherfun button#openinv').prop('disabled',false);
									$('.viewtemp #otherfun button#reinv').prop('disabled',true);
								}
								else{
									$('.viewtemp #otherfun button#openinv').prop('disabled',true);
									$('.viewtemp #otherfun button#reinv').prop('disabled',false);
								}
								$('.viewtemp #fun button#tag').prop('disabled',false);
								$('.viewtemp #fun button#forall').prop('disabled',false);
								$('.viewtemp #fun button#kitchen').prop('disabled',false);
								$('.viewtemp #fun button#changecheck').prop('disabled',false);
								if($('.viewtemp #salelist #salecontent .listitems#focus input[name="listtype"]').val()=='1'||$('.viewtemp #salelist #salecontent .listitems#focus input[name="listtype"]').val()=='2'||$('.viewtemp #salelist #salecontent .listitems#focus input[name="listtype"]').val()=='4'){
									$('.viewtemp #fun button#editoutman').prop('disabled',true);
								}
								else{
									$('.viewtemp #fun button#editoutman').prop('disabled',false);
								}
							}
							$('.viewtemp #fun button#list').prop('disabled',false);
						}
						else{
							$('.viewtemp #viewvoid').prop('disabled',true);
							$('.viewtemp #otherfun button#plus').prop('disabled',true);
							$('.viewtemp #otherfun button#sale').prop('disabled',true);
							$('.viewtemp #otherfun button#openinv').prop('disabled',true);
							$('.viewtemp #fun button#tag').prop('disabled',true);
							$('.viewtemp #fun button#forall').prop('disabled',true);
							$('.viewtemp #fun button#kitchen').prop('disabled',true);
							$('.viewtemp #fun button#changecheck').prop('disabled',true);
							$('.viewtemp #fun button#editoutman').prop('disabled',true);
							$('.viewtemp #fun button#list').prop('disabled',true);
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				//$('.viewtemp #fun #kitchen').prop('disabled',false);
				
			},
			error:function(e){
				//console.log(e);
			}
		});

		if($('.viewtemp #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val()!=''&&$('.viewtemp #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val()!=null){
			var memtel=$('.viewtemp #salelist #salecontent .listitems:eq('+index+') input[name="memno"]').val().split(';-;');
			/*if(memtel.length>1){//具有會員
				memtel=tempmemtel[0];
			}
			else{
				memtel=tempmemtel[0];
			}*/
			if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
				if(memtel[0]!=''){//2020/5/18 if($('.order#order #tabs4 .listcontentbox input[name="memno"]').val()!=''){ memno檢查不應該在這裡
					$.ajax({
						url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php',
						method:'post',
						async:false,
						data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','memno':memtel[0],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
						dataType:'json',
						success:function(d){
							//console.log(d);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online success)'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
							if(d=="查無資料庫。"){
								$('.viewtemp #membername').html('');
								$('.viewtemp #membertel').html('');
							}
							else if(d.length==0){
								$('.viewtemp #membername').html('');
								$('.viewtemp #membertel').html('');
							}
							else{
								$('.viewtemp #membername').html(d[0]['name']);
								$('.viewtemp #membertel').html(d[0]['tel']);
							}
						},
						error:function(e){
							//console.log(e);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online error) '+e},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
					});
				}
				else{
					$('.viewtemp #membername').html('');
					$('.viewtemp #membertel').html('');
				}
			}
			else{//本地會員
				$.ajax({
					url:'../memberapi/getmemdata.ajax.php',
					method:'post',
					async:false,
					data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','memno':memtel[0],'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'ajax':''},
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/getmemdata.ajax.php(offline success)'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(d=="查無資料庫。"){
							$('.viewtemp #membername').html('');
							$('.viewtemp #membertel').html('');
						}
						else if(d.length==0){
							$('.viewtemp #membername').html('');
							$('.viewtemp #membertel').html('');
						}
						else{
							$('.viewtemp #membername').html(d[0]['name']);
							$('.viewtemp #membertel').html(d[0]['tel']);
						}
					},
					error:function(e){
						//console.log(e);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/getmemdata.ajax.php(offline error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
				});
			}
		}
		else{
			$('.viewtemp #membername').html('');
			$('.viewtemp #membertel').html('');
		}
	});
	$('.viewtemp #list #listcontent').on('click','.label',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單點選帳單品項','click');
		//oneEvent(event);
		var index=$('.viewtemp #list #listcontent .label').index(this);
		if($('.viewtemp #list #listcontent .label:eq('+index+') input[name="order"]').val()=='－'){//2021/7/29 套餐品項
			for(var i=index-1;i>=0;i--){
				if($('.viewtemp #list #listcontent .label:eq('+i+') input[name="order"]').val()!='－'){
					if($('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label focus'){
						$('.viewtemp #list #listcontent .label:eq('+i+')').addClass( "check" );
						$('.viewtemp #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',true);
					}
					else if($('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label focus check'){
						//$('.viewtemp #list #listcontent .label:eq('+i+')').removeClass( "check" );
						//$('.viewtemp #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',false);//2021/7/29 套餐品項不勾選時，不連動套餐名稱的勾選狀態
					}
					else{
						$('.viewtemp #list #listcontent .label').removeClass( "focus" );
						$('.viewtemp #list #listcontent .label:eq('+i+')').addClass( "focus" );
					}
					break;
				}
				else{
				}
			}
		}
		else{
			if($('.viewtemp #list #listcontent .label:eq('+(index+1)+') input[name="order"]').length>0&&$('.viewtemp #list #listcontent .label:eq('+(index+1)+') input[name="order"]').val()=='－'){
				for(var i=index+1;i<$('.viewtemp #list #listcontent .label').length;i++){
					if($('.viewtemp #list #listcontent .label:eq('+i+') input[name="order"]').val()=='－'){
						if($('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label focus'){
							$('.viewtemp #list #listcontent .label:eq('+i+')').addClass( "check" );
							$('.viewtemp #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',true);
						}
						else if($('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label focus check'){
							$('.viewtemp #list #listcontent .label:eq('+i+')').removeClass( "check" );
							$('.viewtemp #list #listcontent .label:eq('+i+') input[type="checkbox"]').prop('checked',false);
						}
						else{
							$('.viewtemp #list #listcontent .label').removeClass( "focus" );
							$('.viewtemp #list #listcontent .label:eq('+i+')').addClass( "focus" );
						}
					}
					else{
						break;
					}
				}
			}
			else{
			}
		}
		if($('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label focus'){
			$('.viewtemp #list #listcontent .label:eq('+index+')').addClass( "check" );
			$('.viewtemp #list #listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',true);
		}
		else if($('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label check focus'||$('.viewtemp #list #listcontent .label:eq('+index+')').prop('class')=='label focus check'){
			$('.viewtemp #list #listcontent .label:eq('+index+')').removeClass( "check" );
			$('.viewtemp #list #listcontent .label:eq('+index+') input[type="checkbox"]').prop('checked',false);
		}
		else{
			$('.viewtemp #list #listcontent .label').removeClass( "focus" );
			$('.viewtemp #list #listcontent .label:eq('+index+')').addClass( "focus" );
		}
	});
	$('.viewtemp #fun').on('click','#editoutman',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單調整外送員','click');
		$('.editoutman input[name="mancode"]').val($('.viewtemp #salelist #salecontent .listitems#focus input[name="mancode"]').val());
		$('.editoutman input[name="manname"]').val($('.viewtemp #salelist #salecontent .listitems#focus input[name="manname"]').val());
		editoutman.dialog('open');
	});
	$('.editoutman #number').click(function(){
		$('.editoutman input[name="mancode"]').val($('.editoutman input[name="mancode"]').val()+$(this).val());
		$.ajax({
			url:'./lib/js/get.manname.php',
			method:'post',
			async:false,
			data:{'mancode':$('.editoutman input[name="mancode"]').val()},
			dataType:'json',
			success:function(d){
				//console.log(typeof d[0]);
				if(typeof d[0]==="undefined"){
					$('.editoutman input[name="manname"]').val('');
				}
				else{
					$('.editoutman input[name="manname"]').val(d[0]['name']);
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.editoutman #return').click(function(){
		editoutman.dialog('close');
	});
	$('.editoutman #back').click(function(){
		if($('.editoutman input[name="mancode"]').val().length==0){
		}
		else{
			$('.editoutman input[name="mancode"]').val($('.editoutman input[name="mancode"]').val().substr(0,$('.editoutman input[name="mancode"]').val().length-1));
		}
		$.ajax({
			url:'./lib/js/get.manname.php',
			method:'post',
			async:false,
			data:{'mancode':$('.editoutman input[name="mancode"]').val()},
			dataType:'json',
			success:function(d){
				//console.log(typeof d[0]);
				if(typeof d[0]==="undefined"){
					$('.editoutman input[name="manname"]').val('');
				}
				else{
					$('.editoutman input[name="manname"]').val(d[0]['name']);
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.editoutman #send').click(function(){
		if($('.editoutman input[name="mancode"]').val()!=''&&$('.editoutman input[name="manname"]').val()!=''){
			$.ajax({
				url:'./lib/js/editoutman.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html(),'consecnumber':$('.viewtemp #salelist #salecontent .listitems#focus input[name="consecnumber"]').val(),'mancode':$('.editoutman input[name="mancode"]').val(),'manname':$('.editoutman input[name="manname"]').val()},
				dataType:'html',
				success:function(d){
					//console.log('success'+d);
					$('.editoutman #return').trigger('click');
					viewtemp.dialog('close');
					$('.order#order #banner #detail #tw #view').trigger('click');
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			$.ajax({
				url:'./lib/js/editoutman.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html(),'consecnumber':$('.viewtemp #salelist #salecontent .listitems#focus input[name="consecnumber"]').val(),'mancode':'','manname':''},
				dataType:'html',
				success:function(d){
					//console.log('success'+d);
					$('.editoutman #return').trigger('click');
					viewtemp.dialog('close');
					$('.order#order #banner #detail #tw #view').trigger('click');
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
	});
	$('.viewtemp #fun').on('click','#changecheck',function(event){
		//oneEvent(event);
		if($('.viewtemp #list #listcontent .label').length==$('.viewtemp #list #listcontent .label input[id^="checkbox"]:checked').length||$('.viewtemp #list #listcontent .label input[id^="checkbox"]:checked').length==0){
			if($('.viewtemp #list #listcontent .label input[data-id^="checkbox"]:checked').length>0){
				$('.viewtemp #list #listcontent .label input[data-id^="checkbox"]').prop('checked',false);
				$('.viewtemp #list #listcontent .label').removeClass('check');
			}
			else{
				$('.viewtemp #list #listcontent .label input[data-id^="checkbox"]').prop('checked',true);
				$('.viewtemp #list #listcontent .label').addClass('check');
			}
		}
		else{
			for(var i=0;i<$('.viewtemp #list #listcontent .label').length;i++){
				if($('.viewtemp #list #listcontent .label:eq('+i+') input[data-id^="checkbox"]').prop('checked')){
					$('.viewtemp #list #listcontent .label:eq('+i+') input[data-id^="checkbox"]').prop('checked',false);
					$('.viewtemp #list #listcontent .label').removeClass('check');
				}
				else{
					$('.viewtemp #list #listcontent .label:eq('+i+') input[data-id^="checkbox"]').prop('checked',true);
					$('.viewtemp #list #listcontent .label').addClass('check');
				}
			}
		}
	});
	$('.viewtemp #fun').on('click','#forall',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單重印','click');
		//oneEvent(event);
		if($('.order#order .initsetting #voidsale').val()=='1'){
			$('.verpsw input[name="type"]').val('tempsale_reprint_all');
			verpsw.dialog('open');
		}
		else{
			var index='';
			var qty='';
			var inumber='';
			var linenumber='';
			for(var i=0;i<$('.viewtemp #list #listcontent .label').length;i++){
				if(index.length==0){
					index=index+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
				else{
					index=index+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
					qty=qty+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
					inumber=inumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					linenumber=linenumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
			}
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'temp','memname':$('.viewtemp #membername').html(),'memtel':$('.viewtemp #membertel').html() },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.list.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.list.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			$.ajax({
				url:'./lib/js/reprint.transdata.ajax.php',
				method:'post',
				data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'temp' },
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.tag.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.tag.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.kitchen.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reprint forall create.kitchen.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					console.log(e);
				}
			});
			/*$.ajax({
				url:'./lib/js/reprint.ajax.php',
				method:'post',
				data:{'company':$('.order#order .companydata #company').val(),'type':'tempall','listtype':$('.viewtemp input[name="listtype"]').val(),'bizdate':$('.viewtemp #date').html(),'no':$('.viewtemp #listno input[name="consecnumber"]').val(),'date':$('.viewtemp #credate').val(),'index':index,'qty':qty,'inumber':inumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'linenumber':linenumber,'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'viewtemp-forall reprint.ajax.php '+d},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					//console.log(d);
					//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
					//2017/12/4mywin.document.title='cashdrawer';
				},
				error:function(e){
					//console.log(e);
				}
			});*/
		}
	});
	$('.viewtemp #fun').on('click','#list',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單重印明細','click');
		//oneEvent(event);
		var index='';
		var qty='';
		$.ajax({
			url:'./lib/js/reprint.transdata.ajax.php',
			method:'post',
			data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'clientlist','saletype':'temp','memname':$('.viewtemp #membername').html(),'memtel':$('.viewtemp #membertel').html() },
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/create.list.php',
					method:'post',
					async: false,
					data:d,
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.list.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			},
			error:function(e){
				console.log(e);
			}
		});
		/*$.ajax({
			url:'./lib/js/reprint.ajax.php',
			method:'post',
			data:{'type':'templist','no':$('.viewtemp #listno input[name="consecnumber"]').val(),'bizdate':$('.viewtemp #date').html(),'date':$('.viewtemp #credate').val(),'listtype':$('.viewtemp #listno input[name="listtype"]').val(),'index':index,'qty':qty,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'viewtemp-list reprint.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//2017/12/4mywin.document.title='cashdrawer';
			},
			error:function(e){
				//console.log(e);
			}
		});*/
	});
	$('.viewtemp #fun').on('click','#tag',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單重印貼紙','click');
		//oneEvent(event);
		var index='';
		var qty='';
		var linenumber='';
		for(var i=0;i<$('.viewtemp #list #listcontent .label').length;i++){
			if($('.viewtemp #list #listcontent .label:eq('+i+') input[data-id="checkbox[]"]').prop('checked')){
				if(index.length==0){
					index=index+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val()+','+('00'+(Number($('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1)).substr(3-(Number($('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1).length);
					qty=qty+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
					linenumber=linenumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
				else{
					index=index+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val()+','+('00'+(Number($('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1)).substr(3-(Number($('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val())+1).length);
					qty=qty+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(4)').html();
					linenumber=linenumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
				}
			}
			else{
			}
		}
		$.ajax({
			url:'./lib/js/reprint.transdata.ajax.php',
			method:'post',
			data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'tag','saletype':'temp' },
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/create.tag.php',
					method:'post',
					async: false,
					data:d,
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.list.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			},
			error:function(e){
				console.log(e);
			}
		});
		/*$.ajax({
			url:'./lib/js/reprint.ajax.php',
			method:'post',
			data:{'type':'temptag','no':$('.viewtemp #listno input[name="consecnumber"]').val(),'bizdate':$('.viewtemp #date').html(),'date':$('.viewtemp #credate').val(),'index':index,'qty':qty,'linenumber':linenumber,'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'viewtemp-tag reprint.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//2017/12/4mywin.document.title='cashdrawer';
			},
			error:function(e){
				//console.log(e);
			}
		});*/
	});
	$('.viewtemp #fun').on('click','#kitchen',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單重印工作單','click');
		//oneEvent(event);
		var qty='';
		var linenumber='';
		for(var i=0;i<$('.viewtemp #list #listcontent .label').length;i++){
			if($('.viewtemp #list #listcontent .label:eq('+i+') input[data-id="checkbox[]"]').prop('checked')){
				if(linenumber.length==0){
					//index=index+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
					linenumber=linenumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
					//inumber=inumber+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					qty=qty+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
				}
				else{
					//index=index+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
					linenumber=linenumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="linenumber"]').val();
					//inumber=inumber+','+$('.viewtemp #list #listcontent .label:eq('+i+') input[name="inumber"]').val();
					qty=qty+','+$('.viewtemp #list #listcontent .label:eq('+i+') div:eq(1)').html();
				}
			}
			else{
			}
		}
		$.ajax({
			url:'./lib/js/reprint.transdata.ajax.php',
			method:'post',
			data:{"company":$('.order#order .companydata #company').val(), "listtype":$('.viewtemp #listno input[name="listtype"]').val(), "consecnumber":$('.viewtemp #listno input[name="consecnumber"]').val(), "bizdate":$('.viewtemp #date').html(), "credate":$('.viewtemp #credate').val(), 'linenumber':linenumber, "machinetype":$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(), "username":$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'reprint':'kitchen','saletype':'temp' },
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/create.kitchen.php',
					method:'post',
					async: false,
					data:d,
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.list.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			},
			error:function(e){
				console.log(e);
			}
		});
		/*$.ajax({
			url:'./lib/js/reprint.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'type':'tempkitchen','listtype':$('.viewtemp input[name="listtype"]').val(),'no':$('.viewtemp #listno input[name="consecnumber"]').val(),'bizdate':$('.viewtemp #date').html(),'date':$('.viewtemp #credate').val(),'qty':qty,'linenumber':linenumber,'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'viewtemp-kitchen reprint.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
				//2017/12/4mywin.document.title='cashdrawer';
			},
			error:function(e){
				//console.log(e);
			}
		});*/
	});
	//2021/7/21 未結帳單前一日的按鈕早已移除
	/*$('.viewtemp #fun').on('click','#prebizdate',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單切換營業日',$(this).find('#name1').html());
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'bizdate':$('.viewtemp #salelist #salecontent #bizdate').val(),'type':'-','temp':'temp','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.viewtemp #salelist #salecontent').html(d);
				$('.viewtemp #listno').html('');
				$('.viewtemp #list #listcontent').html('');
				$('.viewtemp #date').html('');
				$('.viewtemp #credate').html('');
				$('.viewtemp #viewvoid').prop('disabled',true);
				$('.viewtemp #fun #tag').prop('disabled',true);
				$('.viewtemp #fun button#list').prop('disabled',true);
				$('.viewtemp #fun #kitchen').prop('disabled',true);
				$('.viewtemp #fun #forall').prop('disabled',true);
				$('.viewtemp #fun #changecheck').prop('disabled',true);
				$('.viewtemp #rightnow #ttmoney').html($('.viewtemp #salelist input[name="ttmoney"]').val());
				$('.viewtemp #rightnow #ttcount').html($('.viewtemp #salelist input[name="ttcount"]').val());
			},
			error:function(e){
				//console.log(e);
			}
		});
	});*/
	//2021/7/21 未結帳單後一日的按鈕早已移除
	/*('.viewtemp #fun').on('click','#nextbizdate',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單切換營業日',$(this).find('#name').html());
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/getsalelist.ajax.php',
			method:'post',
			data:{'bizdate':$('.viewtemp #salelist #salecontent #bizdate').val(),'type':'+','temp':'temp','machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				$('.viewtemp #salelist #salecontent').html(d);
				$('.viewtemp #listno').html('');
				$('.viewtemp #list #listcontent').html('');
				$('.viewtemp #date').html('');
				$('.viewtemp #credate').html('');
				$('.viewtemp #viewvoid').prop('disabled',true);
				$('.viewtemp #fun #tag').prop('disabled',true);
				$('.viewtemp #fun button#list').prop('disabled',true);
				$('.viewtemp #fun #kitchen').prop('disabled',true);
				$('.viewtemp #fun #forall').prop('disabled',true);
				$('.viewtemp #fun #changecheck').prop('disabled',true);
				$('.viewtemp #rightnow #ttmoney').html($('.viewtemp #salelist input[name="ttmoney"]').val());
				$('.viewtemp #rightnow #ttcount').html($('.viewtemp #salelist input[name="ttcount"]').val());
			},
			error:function(e){
				//console.log(e);
			}
		});
	});*/
	$('.viewtemp').on('click','#viewvoid',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單暫結作廢','click');
		//oneEvent(event);
		if($('.order#order .initsetting #controltable').val()=='1'){
			$.ajax({
				url:'./lib/js/checktabstate.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					var tempd=d.split('-');
					if(tempd[0]=='unlock'){
						//$('.viewtemp #viewvoid').prop('disabled',true);
						if($('.order#order .initsetting #voidsale').val()=='0'){
							//2022/4/20 增加作廢帳單二次確認流程，並自動帶入作廢密碼模擬不驗證密碼
							$('.checkdeletesale .bizdate').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html());
							$('.checkdeletesale .saleno').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(1)').html());
							$('.checkdeletesale .consecnumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(2)').html());
							$('.checkdeletesale .invoicenumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html());
							$('.checkdeletesale .money').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(5)').html());
							$('.checkdeletesale input[name="type"]').val('viewvoid');
							$('.checkdeletesale input[name="psw"]').val($('.order#order .companydata #voidpw').val());
							checkdeletesale.dialog('open');

							/*if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
								var hint=confirm('請確認發票正本已收回。');
								if(hint==true){
									var nowbizdate=$('.viewtemp #date').html();
									var check=0;
									//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
									if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
										$.ajax({
											url:'./lib/api/intella/check.intellapay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
													$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
													$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
													$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
													voidsalewithintellapay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
										$.ajax({
											url:'./lib/api/directlinepay/check.linepay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
													$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
													$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
													voidsalewithlinepay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
										$.ajax({
											url:'./lib/api/nccc/check.nccc.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithnccc input[name="type"]').val('viewvoid');
													$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
													$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
													voidsalewithnccc.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0){//沒有使用API串接付款
										if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
											var posdvrfile='';
										}
										else{
										}
										if($('.nidin #usenidin').length>0){
											nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
										}
										else{
										}
										$.ajax({
											url:'./lib/js/viewvoid.ajax.php',
											method:'post',
											async:false,
											data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
											dataType:'html',
											success:function(d){
												var tempres=d.split('-');
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														async:false,
														data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
														dataType:'html',
														success:function(d){console.log(d);},
														error:function(e){console.log(e);}
													});
												}
												else{
												}
												if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
													var posdvrfile=tempres[1];
												}
												else{
												}
												//console.log(d);
												if(tempres[0]=='success'){
													$.ajax({
														url:'./lib/js/getinvname.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
														dataType:'json',
														success:function(d){
															//console.log(d);
															if(d=='dbempty'){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'reinv getinvname.ajax.php dbempty'},
																	dataType:'html',
																	success:function(d){console.log(d);},
																	error:function(e){console.log(e);}
																});
															}
															else{
																$.ajax({
																	url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
																	method:'post',
																	async:false,
																	data:{'invfile':d[1]},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																			$.ajax({
																				url:'./lib/js/reinv.ajax.php',
																				method:'post',
																				async:false,
																				data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
																				dataType:'html',
																				success:function(d){
																					//console.log(d);
																					if(d.length>20||d.match('ERROR HINT: ')){
																						$.ajax({
																							url:'./lib/js/print.php',
																							method:'post',
																							data:{'html':'creditcard reinv.ajax.php '+d},
																							dataType:'html',
																							success:function(d){/*console.log(d);},
																							error:function(e){/*console.log(e);}
																						});
																					}
																					else{
																					}
																				},
																				error:function(e){
																					//console.log(e);
																				}
																			});
																		}
																		else{
																		}
																		$.ajax({//作廢發票
																			url:'./lib/js/deleteinv.ajax.php',
																			method:'post',
																			async:false,
																			data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
																			dataType:'html',
																			success:function(d){
																				if(d.length>40||d.match('ERROR HINT: ')){
																					$.ajax({
																						url:'./lib/js/print.php',
																						method:'post',
																						data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																						dataType:'html',
																						success:function(d){/*console.log(d);},
																						error:function(e){/*console.log(e);}
																					});
																				}
																				else{
																				}
																				//console.log(d);
																				$('.viewtemp #salelist #salecontent .listitems').prop('id','');
																				$('.viewtemp #listno').html('');
																				$('.viewtemp #list #listcontent').html('');
																				$('.viewtemp #date').html('');
																				$('.viewtemp #credate').html('');
																				$('.viewtemp #otherfun button#plus').prop('disabled',true);
																				$('.viewtemp #otherfun button#openinv').prop('disabled',true);
																				$('.viewtemp #viewvoid').prop('disabled',true);
																				$('.viewtemp #fun button#forall').prop('disabled',true);
																				$('.viewtemp #fun button#list').prop('disabled',true);
																				$('.viewtemp #fun button#tag').prop('disabled',true);
																				$('.viewtemp #fun button#kitchen').prop('disabled',true);
																				$('.viewtemp #fun button#changecheck').prop('disabled',true);
																				$('.viewtemp #fun button#editoutman').prop('disabled',true);
																				$('.order#order #banner #detail #tw #view').trigger('click');
																				//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																				//2017/12/29mywin.document.title='cashdrawer';
																			},
																			error:function(e){
																				//console.log(e);
																			}
																		});
																	},
																	error:function(e){
																		//console.log(e);
																	}
																});
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
													//console.log(d);
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
										$.ajax({
											url:'./lib/js/create.cmdtxt.php',
											method:'post',
											async: false,
											data:{'cmd':nowbizdate.substr(0,6)+'-change'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
										/*錢都錄借接
										if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
											/*start tag
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'start posdvr-sendmessage','file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);},
												error:function(e){console.log(e);}
											});
											if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
												var res=api_sendmessage_posdvr(posdvrfile);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'success '+posdvrfile,'file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);},
													error:function(e){/*console.log(e);}
												});
											}
											else{
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'error sendmessage is not function','file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);},
													error:function(e){/*console.log(e);}
												});
											}
											/*end tag
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'end posdvr-sendmessage','file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);},
												error:function(e){/*console.log(e);}
											});
										}
										else{
										}
									}
									else{//使用API串接付款，須先進行退款
									}
								}
								else{
								}
								
							}
							else{
								var nowbizdate=$('.viewtemp #date').html();
								var check=0;
								//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
								if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
									$.ajax({
										url:'./lib/api/intella/check.intellapay.php',
										method:'post',
										async:false,
										data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
										dataType:'json',
										success:function(d){
											//console.log(d);
											if(d['result']=='exists'){
												check=1;
												verpsw.dialog('close');
												$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
												$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
												$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
												$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
												voidsalewithintellapay.dialog('open');
												return;
											}
											else{
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
									$.ajax({
										url:'./lib/api/directlinepay/check.linepay.php',
										method:'post',
										async:false,
										data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
										dataType:'json',
										success:function(d){
											//console.log(d);
											if(d['result']=='exists'){
												check=1;
												verpsw.dialog('close');
												$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
												$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
												$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
												voidsalewithlinepay.dialog('open');
												return;
											}
											else{
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
									$.ajax({
										url:'./lib/api/nccc/check.nccc.php',
										method:'post',
										async:false,
										data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
										dataType:'json',
										success:function(d){
											//console.log(d);
											if(d['result']=='exists'){
												check=1;
												verpsw.dialog('close');
												$('.voidsalewithnccc input[name="type"]').val('viewvoid');
												$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
												$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
												voidsalewithnccc.dialog('open');
												return;
											}
											else{
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								if(check==0){//沒有使用API串接付款
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var posdvrfile='';
									}
									else{
									}
									if($('.nidin #usenidin').length>0){
										nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
									}
									else{
									}
									$.ajax({
										url:'./lib/js/viewvoid.ajax.php',
										method:'post',
										async:false,
										data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
										dataType:'html',
										success:function(d){
											var tempres=d.split('-');
											if(d.length>20||d.match('ERROR HINT: ')){
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
													dataType:'html',
													success:function(d){/*console.log(d);},
													error:function(e){/*console.log(e);}
												});
											}
											else{
											}
											if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
												var posdvrfile=tempres[1];
											}
											else{
											}
											//console.log(d);
											$('.viewtemp #salelist #salecontent .listitems').prop('id','');
											$('.viewtemp #listno').html('');
											$('.viewtemp #list #listcontent').html('');
											$('.viewtemp #date').html('');
											$('.viewtemp #credate').html('');
											$('.viewtemp #otherfun button#plus').prop('disabled',true);
											$('.viewtemp #otherfun button#openinv').prop('disabled',true);
											$('.viewtemp #viewvoid').prop('disabled',true);
											$('.viewtemp #fun button#forall').prop('disabled',true);
											$('.viewtemp #fun button#list').prop('disabled',true);
											$('.viewtemp #fun button#tag').prop('disabled',true);
											$('.viewtemp #fun button#kitchen').prop('disabled',true);
											$('.viewtemp #fun button#changecheck').prop('disabled',true);
											$('.viewtemp #fun button#editoutman').prop('disabled',true);
											$('.order#order #banner #detail #tw #view').trigger('click');
										},
										error:function(e){
											//console.log(e);
										}
									});
									/*錢都錄借接
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										/*start tag
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'start posdvr-sendmessage','file':'posdvr'},
											dataType:'html',
											success:function(d){/*console.log(d);},
											error:function(e){console.log(e);}
										});
										if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
											var res=api_sendmessage_posdvr(posdvrfile);
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'success '+posdvrfile,'file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);},
												error:function(e){/*console.log(e);}
											});
										}
										else{
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'error sendmessage is not function','file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);},
												error:function(e){/*console.log(e);}
											});
										}
										/*end tag
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											async:false,
											data:{'html':'end posdvr-sendmessage','file':'posdvr'},
											dataType:'html',
											success:function(d){/*console.log(d);},
											error:function(e){/*console.log(e);}
										});
									}
									else{
									}
									$.ajax({
										url:'./lib/js/create.cmdtxt.php',
										method:'post',
										async: false,
										data:{'cmd':nowbizdate.substr(0,6)+'-change'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{//使用API串接付款，須先進行退款
								}
							}*/
						}
						else{
							//2022/4/20 增加作廢帳單二次確認流程
							//$('.verpsw input[name="type"]').val('viewvoid');
							//verpsw.dialog('open');
							$('.checkdeletesale .bizdate').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html());
							$('.checkdeletesale .saleno').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(1)').html());
							$('.checkdeletesale .consecnumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(2)').html());
							$('.checkdeletesale .invoicenumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html());
							$('.checkdeletesale .money').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(5)').html());
							$('.checkdeletesale input[name="type"]').val('viewvoid');
							$('.checkdeletesale input[name="psw"]').val('');
							checkdeletesale.dialog('open');
						}
					}
					else{
						var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
						if(res==true){
							if($('.order#order .initsetting #voidsale').val()=='0'){
								//2022/4/20 增加作廢帳單二次確認流程，並自動帶入作廢密碼模擬不驗證密碼
								$('.checkdeletesale .bizdate').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html());
								$('.checkdeletesale .saleno').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(1)').html());
								$('.checkdeletesale .consecnumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(2)').html());
								$('.checkdeletesale .invoicenumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html());
								$('.checkdeletesale .money').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(5)').html());
								$('.checkdeletesale input[name="type"]').val('viewvoid');
								$('.checkdeletesale input[name="psw"]').val($('.order#order .companydata #voidpw').val());
								checkdeletesale.dialog('open');

								/*if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
									var hint=confirm('請確認發票正本已收回。');
									if(hint==true){
										var nowbizdate=$('.viewtemp #date').html();
										var check=0;
										//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
										if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
											$.ajax({
												url:'./lib/api/intella/check.intellapay.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
														$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
														$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
														$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
														voidsalewithintellapay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
											$.ajax({
												url:'./lib/api/directlinepay/check.linepay.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
														$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
														$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
														voidsalewithlinepay.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
											$.ajax({
												url:'./lib/api/nccc/check.nccc.php',
												method:'post',
												async:false,
												data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d['result']=='exists'){
														check=1;
														verpsw.dialog('close');
														$('.voidsalewithnccc input[name="type"]').val('viewvoid');
														$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
														$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
														voidsalewithnccc.dialog('open');
														return;
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										if(check==0){//沒有使用API串接付款
											if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
												var posdvrfile='';
											}
											else{
											}
											if($('.nidin #usenidin').length>0){
												nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
											}
											else{
											}
											$.ajax({
												url:'./lib/js/viewvoid.ajax.php',
												method:'post',
												async:false,
												data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
												dataType:'html',
												success:function(d){
													var tempres=d.split('-');
													if(d.length>20||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															async:false,
															data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
															dataType:'html',
															success:function(d){/*console.log(d);},
															error:function(e){/*console.log(e);}
														});
													}
													else{
													}
													if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
														var posdvrfile=tempres[1];
													}
													else{
													}
													//console.log(d);
													if(tempres[0]=='success'){
														$.ajax({
															url:'./lib/js/getinvname.ajax.php',
															method:'post',
															async:false,
															data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'json',
															success:function(d){
																//console.log(d);
																if(d=='dbempty'){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'reinv getinvname.ajax.php dbempty'},
																		dataType:'html',
																		success:function(d){/*console.log(d);},
																		error:function(e){/*console.log(e);}
																	});
																}
																else{
																	$.ajax({
																		url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
																		method:'post',
																		async:false,
																		data:{'invfile':d[1]},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																				$.ajax({
																					url:'./lib/js/reinv.ajax.php',
																					method:'post',
																					async:false,
																					data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
																					dataType:'html',
																					success:function(d){
																						//console.log(d);
																						if(d.length>20||d.match('ERROR HINT: ')){
																							$.ajax({
																								url:'./lib/js/print.php',
																								method:'post',
																								data:{'html':'creditcard reinv.ajax.php '+d},
																								dataType:'html',
																								success:function(d){/*console.log(d);},
																								error:function(e){/*console.log(e);}
																							});
																						}
																						else{
																						}
																					},
																					error:function(e){
																						//console.log(e);
																					}
																				});
																			}
																			else{
																			}
																			$.ajax({//作廢發票
																				url:'./lib/js/deleteinv.ajax.php',
																				method:'post',
																				async:false,
																				data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
																				dataType:'html',
																				success:function(d){
																					if(d.length>40||d.match('ERROR HINT: ')){
																						$.ajax({
																							url:'./lib/js/print.php',
																							method:'post',
																							async:false,
																							data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																							dataType:'html',
																							success:function(d){/*console.log(d);},
																							error:function(e){/*console.log(e);}
																						});
																					}
																					else{
																					}
																					//console.log(d);
																					$('.viewtemp #salelist #salecontent .listitems').prop('id','');
																					$('.viewtemp #listno').html('');
																					$('.viewtemp #list #listcontent').html('');
																					$('.viewtemp #date').html('');
																					$('.viewtemp #credate').html('');
																					$('.viewtemp #otherfun button#plus').prop('disabled',true);
																					$('.viewtemp #otherfun button#openinv').prop('disabled',true);
																					$('.viewtemp #viewvoid').prop('disabled',true);
																					$('.viewtemp #fun button#forall').prop('disabled',true);
																					$('.viewtemp #fun button#list').prop('disabled',true);
																					$('.viewtemp #fun button#tag').prop('disabled',true);
																					$('.viewtemp #fun button#kitchen').prop('disabled',true);
																					$('.viewtemp #fun button#changecheck').prop('disabled',true);
																					$('.viewtemp #fun button#editoutman').prop('disabled',true);
																					$('.order#order #banner #detail #tw #view').trigger('click');
																					//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																					//2017/12/29mywin.document.title='cashdrawer';
																				},
																				error:function(e){
																					//console.log(e);
																				}
																			});
																		},
																		error:function(e){
																			//console.log(e);
																		}
																	});
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
														//console.log(d);
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
											/*錢都錄借接
											if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
												/*start tag
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'start posdvr-sendmessage','file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);},
													error:function(e){console.log(e);}
												});
												if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
													var res=api_sendmessage_posdvr(posdvrfile);
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'success '+posdvrfile,'file':'posdvr'},
														dataType:'html',
														success:function(d){/*console.log(d);},
														error:function(e){/*console.log(e);}
													});
												}
												else{
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														async:false,
														data:{'html':'error sendmessage is not function','file':'posdvr'},
														dataType:'html',
														success:function(d){/*console.log(d);},
														error:function(e){/*console.log(e);}
													});
												}
												/*end tag
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'end posdvr-sendmessage','file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);},
													error:function(e){/*console.log(e);}
												});
											}
											else{
											}
											$.ajax({
												url:'./lib/js/create.cmdtxt.php',
												method:'post',
												async: false,
												data:{'cmd':nowbizdate.substr(0,6)+'-change'},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{//使用API串接付款，須先進行退款
										}
									}
									else{
									}
									
								}
								else{
									var nowbizdate=$('.viewtemp #date').html();
									var check=0;
									//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
									if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
										$.ajax({
											url:'./lib/api/intella/check.intellapay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
													$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
													$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
													$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
													voidsalewithintellapay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
										$.ajax({
											url:'./lib/api/directlinepay/check.linepay.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
													$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
													$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
													voidsalewithlinepay.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
										$.ajax({
											url:'./lib/api/nccc/check.nccc.php',
											method:'post',
											async:false,
											data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d['result']=='exists'){
													check=1;
													verpsw.dialog('close');
													$('.voidsalewithnccc input[name="type"]').val('viewvoid');
													$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
													$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
													voidsalewithnccc.dialog('open');
													return;
												}
												else{
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									if(check==0){//沒有使用API串接付款
										if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
											var posdvrfile='';
										}
										else{
										}
										if($('.nidin #usenidin').length>0){
											nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
										}
										else{
										}
										$.ajax({
											url:'./lib/js/viewvoid.ajax.php',
											method:'post',
											async:false,
											data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
											dataType:'html',
											success:function(d){
												var tempres=d.split('-');
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														async:false,
														data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);},
														error:function(e){/*console.log(e);}
													});
												}
												else{
												}
												if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
													var posdvrfile=tempres[1];
												}
												else{
												}
												//console.log(d);
												$('.viewtemp #salelist #salecontent .listitems').prop('id','');
												$('.viewtemp #listno').html('');
												$('.viewtemp #list #listcontent').html('');
												$('.viewtemp #date').html('');
												$('.viewtemp #credate').html('');
												$('.viewtemp #otherfun button#plus').prop('disabled',true);
												$('.viewtemp #otherfun button#openinv').prop('disabled',true);
												$('.viewtemp #viewvoid').prop('disabled',true);
												$('.viewtemp #fun button#forall').prop('disabled',true);
												$('.viewtemp #fun button#list').prop('disabled',true);
												$('.viewtemp #fun button#tag').prop('disabled',true);
												$('.viewtemp #fun button#kitchen').prop('disabled',true);
												$('.viewtemp #fun button#changecheck').prop('disabled',true);
												$('.viewtemp #fun button#editoutman').prop('disabled',true);
												$('.order#order #banner #detail #tw #view').trigger('click');
											},
											error:function(e){
												//console.log(e);
											}
										});
										/*錢都錄借接
										if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
											/*start tag
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'start posdvr-sendmessage','file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);},
												error:function(e){console.log(e);}
											});
											if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
												var res=api_sendmessage_posdvr(posdvrfile);
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													data:{'html':'success '+posdvrfile,'file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);},
													error:function(e){/*console.log(e);}
												});
											}
											else{
												$.ajax({
													url:'./lib/js/print.php',
													method:'post',
													async:false,
													data:{'html':'error sendmessage is not function','file':'posdvr'},
													dataType:'html',
													success:function(d){/*console.log(d);},
													error:function(e){/*console.log(e);}
												});
											}
											/*end tag
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												async:false,
												data:{'html':'end posdvr-sendmessage','file':'posdvr'},
												dataType:'html',
												success:function(d){/*console.log(d);},
												error:function(e){/*console.log(e);}
											});
										}
										else{
										}
										$.ajax({
											url:'./lib/js/create.cmdtxt.php',
											method:'post',
											async: false,
											data:{'cmd':nowbizdate.substr(0,6)+'-change'},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{//使用API串接付款，須先進行退款
									}
								}*/
							}
							else{
								//2022/4/20 增加作廢帳單二次確認流程
								//$('.verpsw input[name="type"]').val('viewvoid');
								//verpsw.dialog('open');
								$('.checkdeletesale .bizdate').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html());
								$('.checkdeletesale .saleno').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(1)').html());
								$('.checkdeletesale .consecnumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(2)').html());
								$('.checkdeletesale .invoicenumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html());
								$('.checkdeletesale .money').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(5)').html());
								$('.checkdeletesale input[name="type"]').val('viewvoid');
								$('.checkdeletesale input[name="psw"]').val('');
								checkdeletesale.dialog('open');
							}
						}
						else{
						}
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			//$('.viewtemp #viewvoid').prop('disabled',true);
			if($('.order#order .initsetting #voidsale').val()=='0'){
				//2022/4/20 增加作廢帳單二次確認流程，並自動帶入作廢密碼模擬不驗證密碼
				$('.checkdeletesale .bizdate').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html());
				$('.checkdeletesale .saleno').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(1)').html());
				$('.checkdeletesale .consecnumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(2)').html());
				$('.checkdeletesale .invoicenumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html());
				$('.checkdeletesale .money').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(5)').html());
				$('.checkdeletesale input[name="type"]').val('viewvoid');
				$('.checkdeletesale input[name="psw"]').val($('.order#order .companydata #voidpw').val());
				checkdeletesale.dialog('open');

				/*if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
					var hint=confirm('請確認發票正本已收回。');
					if(hint==true){
						var nowbizdate=$('.viewtemp #date').html();
						var check=0;
						//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
						if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
							$.ajax({
								url:'./lib/api/intella/check.intellapay.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
										$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
										$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
										$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
										voidsalewithintellapay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
							$.ajax({
								url:'./lib/api/directlinepay/check.linepay.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
										$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
										$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
										voidsalewithlinepay.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
							$.ajax({
								url:'./lib/api/nccc/check.nccc.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d['result']=='exists'){
										check=1;
										verpsw.dialog('close');
										$('.voidsalewithnccc input[name="type"]').val('viewvoid');
										$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
										$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
										voidsalewithnccc.dialog('open');
										return;
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						if(check==0){//沒有使用API串接付款
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile='';
							}
							else{
							}
							if($('.nidin #usenidin').length>0){
								nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
							}
							else{
							}
							$.ajax({
								url:'./lib/js/viewvoid.ajax.php',
								method:'post',
								async:false,
								data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
								dataType:'html',
								success:function(d){
									var tempres=d.split('-');
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);},
											error:function(e){/*console.log(e);}
										});
									}
									else{
									}
									if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
										var posdvrfile=tempres[1];
									}
									else{
									}
									//console.log(d);
									if(tempres[0]=='success'){
										$.ajax({
											url:'./lib/js/getinvname.ajax.php',
											method:'post',
											async:false,
											data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d=='dbempty'){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'reinv getinvname.ajax.php dbempty'},
														dataType:'html',
														success:function(d){/*console.log(d);},
														error:function(e){/*console.log(e);}
													});
												}
												else{
													$.ajax({
														url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
														method:'post',
														async:false,
														data:{'invfile':d[1]},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																$.ajax({
																	url:'./lib/js/reinv.ajax.php',
																	method:'post',
																	async:false,
																	data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		if(d.length>20||d.match('ERROR HINT: ')){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'creditcard reinv.ajax.php '+d},
																				dataType:'html',
																				success:function(d){/*console.log(d);},
																				error:function(e){/*console.log(e);}
																			});
																		}
																		else{
																		}
																	},
																	error:function(e){
																		//console.log(e);
																	}
																});
															}
															else{
															}
															$.ajax({//作廢發票
																url:'./lib/js/deleteinv.ajax.php',
																method:'post',
																async:false,
																data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
																dataType:'html',
																success:function(d){
																	if(d.length>40||d.match('ERROR HINT: ')){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			async:false,
																			data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																			dataType:'html',
																			success:function(d){/*console.log(d);},
																			error:function(e){/*console.log(e);}
																		});
																	}
																	else{
																	}
																	//console.log(d);
																	$('.viewtemp #salelist #salecontent .listitems').prop('id','');
																	$('.viewtemp #listno').html('');
																	$('.viewtemp #list #listcontent').html('');
																	$('.viewtemp #date').html('');
																	$('.viewtemp #credate').html('');
																	$('.viewtemp #otherfun button#plus').prop('disabled',true);
																	$('.viewtemp #otherfun button#openinv').prop('disabled',true);
																	$('.viewtemp #viewvoid').prop('disabled',true);
																	$('.viewtemp #fun button#forall').prop('disabled',true);
																	$('.viewtemp #fun button#list').prop('disabled',true);
																	$('.viewtemp #fun button#tag').prop('disabled',true);
																	$('.viewtemp #fun button#kitchen').prop('disabled',true);
																	$('.viewtemp #fun button#changecheck').prop('disabled',true);
																	$('.viewtemp #fun button#editoutman').prop('disabled',true);
																	$('.order#order #banner #detail #tw #view').trigger('click');
																	//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																	//2017/12/29mywin.document.title='cashdrawer';
																},
																error:function(e){
																	//console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										//console.log(d);
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							/*錢都錄借接
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								/*start tag
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'start posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);},
									error:function(e){console.log(e);}
								});
								if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
									var res=api_sendmessage_posdvr(posdvrfile);
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'success '+posdvrfile,'file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);},
										error:function(e){/*console.log(e);}
									});
								}
								else{
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										async:false,
										data:{'html':'error sendmessage is not function','file':'posdvr'},
										dataType:'html',
										success:function(d){/*console.log(d);},
										error:function(e){/*console.log(e);}
									});
								}
								/*end tag
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'end posdvr-sendmessage','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);},
									error:function(e){/*console.log(e);}
								});
							}
							else{
							}
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':nowbizdate.substr(0,6)+'-change'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{//使用API串接付款，須先進行退款
						}
					}
					else{
					}
					
				}
				else{
					var nowbizdate=$('.viewtemp #date').html();
					var check=0;
					//2022/5/5 同一帳單中必須不允許同時出現nccc付款、直接linepay付款與英特拉付款，否則這邊的判斷會出現問題
					if(check==0&&$('.order#order .initsetting #intellapay').val()=='1'){//啟用英特拉付款
						$.ajax({
							url:'./lib/api/intella/check.intellapay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithintellapay input[name="type"]').val('viewvoid');
									$('.voidsalewithintellapay input[name="intellaconsecnumber"]').val(d['intellaconsecnumber']);
									$('.voidsalewithintellapay input[name="paycode"]').val(d['paycode']);
									$('.voidsalewithintellapay input[name="money"]').val(d['paymoney']);
									voidsalewithintellapay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/5/5 串接直接linepay付款
						$.ajax({
							url:'./lib/api/directlinepay/check.linepay.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithlinepay input[name="type"]').val('viewvoid');
									$('.voidsalewithlinepay input[name="saleno"]').val(d['saleno']);
									$('.voidsalewithlinepay input[name="money"]').val(d['paymoney']);
									voidsalewithlinepay.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0&&$('.order#order .initsetting #nccc').val()=='1'){//2022/3/29 串接信用卡聯合中心刷卡機
						$.ajax({
							url:'./lib/api/nccc/check.nccc.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'type':'viewvoid'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(d['result']=='exists'){
									check=1;
									verpsw.dialog('close');
									$('.voidsalewithnccc input[name="type"]').val('viewvoid');
									$('.voidsalewithnccc input[name="asm"]').val(d['asm']);
									$('.voidsalewithnccc input[name="money"]').val(d['paymoney']);
									voidsalewithnccc.dialog('open');
									return;
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if(check==0){//沒有使用API串接付款
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile='';
						}
						else{
						}
						if($('.nidin #usenidin').length>0){
							nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
						}
						else{
						}
						$.ajax({
							url:'./lib/js/viewvoid.ajax.php',
							method:'post',
							async:false,
							data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
							dataType:'html',
							success:function(d){
								var tempres=d.split('-');
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);},
										error:function(e){/*console.log(e);}
									});
								}
								else{
								}
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var posdvrfile=tempres[1];
								}
								else{
								}
								//console.log(d);
								$('.viewtemp #salelist #salecontent .listitems').prop('id','');
								$('.viewtemp #listno').html('');
								$('.viewtemp #list #listcontent').html('');
								$('.viewtemp #date').html('');
								$('.viewtemp #credate').html('');
								$('.viewtemp #otherfun button#plus').prop('disabled',true);
								$('.viewtemp #otherfun button#openinv').prop('disabled',true);
								$('.viewtemp #viewvoid').prop('disabled',true);
								$('.viewtemp #fun button#forall').prop('disabled',true);
								$('.viewtemp #fun button#list').prop('disabled',true);
								$('.viewtemp #fun button#tag').prop('disabled',true);
								$('.viewtemp #fun button#kitchen').prop('disabled',true);
								$('.viewtemp #fun button#changecheck').prop('disabled',true);
								$('.viewtemp #fun button#editoutman').prop('disabled',true);
								$('.order#order #banner #detail #tw #view').trigger('click');
							},
							error:function(e){
								//console.log(e);
							}
						});
						/*錢都錄借接
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							/*start tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'start posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);},
								error:function(e){console.log(e);}
							});
							if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
								var res=api_sendmessage_posdvr(posdvrfile);
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'success '+posdvrfile,'file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);},
									error:function(e){/*console.log(e);}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'error sendmessage is not function','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);},
									error:function(e){/*console.log(e);}
								});
							}
							/*end tag
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'end posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);},
								error:function(e){/*console.log(e);}
							});
						}
						else{
						}
						$.ajax({
							url:'./lib/js/create.cmdtxt.php',
							method:'post',
							async: false,
							data:{'cmd':nowbizdate.substr(0,6)+'-change'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{//使用API串接付款，須先進行退款
					}
				}*/
			}
			else{
				////2022/4/20 增加作廢帳單二次確認流程
				//$('.verpsw input[name="type"]').val('viewvoid');
				//verpsw.dialog('open');
				$('.checkdeletesale .bizdate').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(0)').html());
				$('.checkdeletesale .saleno').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(1)').html());
				$('.checkdeletesale .consecnumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(2)').html());
				$('.checkdeletesale .invoicenumber').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html());
				$('.checkdeletesale .money').html($('.viewtemp #salelist #salecontent .listitems#focus div:eq(5)').html());
				$('.checkdeletesale input[name="type"]').val('viewvoid');
				$('.checkdeletesale input[name="psw"]').val('');
				checkdeletesale.dialog('open');
			}
		}
	});
	$('.viewtemp #fun').on('click','#exit',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('關閉未結帳單','click');
		//oneEvent(event);
		viewtemp.dialog('close');
	});
	$('.viewtemp #otherfun').on('click','#sale',function(event){//結帳
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單直接結帳','click');
		if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
			if($('.order#order .initsetting #controltable').val()=='1'){
				$.ajax({
					url:'./lib/js/checktabstate.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var tempd=d.split('-');
						if(tempd[0]=='unlock'){
							temptoinv.dialog('close');
							$('.result input[name="sendtype"]').val('buytemp');
							$.ajax({
								url:'./lib/js/searchlist.member.php',
								method:'post',
								async:false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$('.order#order #membutton #memberpoint').val(d[0]['point']);
									$('.order#order #membutton #membermoney').val(d[0]['money']);
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({
								url:'./lib/js/templistdata.ajax.php',
								method:'post',
								async: false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'json',
								success:function(d){
									if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temptoinv-buylist templistdata.ajax.php '+d},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									$('.result #funbox .invbut').prop('disabled',true);
									$('.result #funbox .invbut #name1').html('開立發票');
									$('.result #funbox .invno').val('1');
									if($('.order#order .initsetting #openpay').val()=='1'){
										$('.result .numbox .otherpay').prop('disabled',false);
										for(var i=0;i<$('.paywindow button').length;i++){
											if($('.paywindow button:eq('+i+') input[name="inv"]').length==0||$('.paywindow button:eq('+i+') input[name="inv"]').val()=='1'){
												$('.paywindow button:eq('+i+')').prop('disabled',false);
											}
											else{
												$('.paywindow button:eq('+i+')').prop('disabled',true);
											}
										}
										for(var i=0;i<$('.result .numbox .otherfunction').length;i++){
											if($('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').length==0||$('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').val()=='1'){
												$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',false);
											}
											else{
												$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',true);
											}
										}
									}
									else{
										$('.result .numbox .otherpay').prop('disabled',true);
										$('.result .numbox .otherfunction').prop('disabled',true);
									}
									if($('.order#order .initsetting #cashbut').val()=='1'){
										$('.result .numbox .cashbut').prop('disabled',false);
									}
									else{
										$('.result .numbox .cashbut').prop('disabled',true);
									}
									$('.result .numbox .moneybut').prop('disabled',false);
									$('.result .numbox .ban').prop('disabled',true);
									$('.result .numbox .carrier').prop('disabled',true);
									$('.result .numbox .carrier2').prop('disabled',true);
									$('.result .numbox .donate').prop('disabled',true);
									$('.result #funbox #listdisbutA').prop('disabled',true);
									$('.result #funbox #listdisbutB').prop('disabled',true);
									$('.result #funbox button[class^="listdisbut"]').prop('disabled',true);
									$('.result #funbox .chargebut').prop('disabled',true);
									$('.result #funbox .receiptbut').prop('disabled',true);
									if(typeof d['buyerid']=="undefined"){
										$('.result #viewwindow input[name="tempban"]').val('');
									}
									else{
										if(d['buyerid']!='0000000000'){
											$('.result #viewwindow input[name="tempban"]').val(d['buyerid']);
										}
										else{
											$('.result #viewwindow input[name="tempban"]').val('');
										}
									}
									if(typeof d['carrierid1']=="undefined"){
										$('.result #viewwindow input[name="tempcontainer"]').val('');
									}
									else{
										if(d['carrierid1']!=null||d['carrierid1']!=''){
											$('.result #viewwindow input[name="tempcontainer"]').val(d['carrierid1']);
										}
										else{
											$('.result #viewwindow input[name="tempcontainer"]').val('');
										}
									}
									if(typeof d['item']=="undefined"){
										$('.result #viewwindow #total').html('0');
									}
									else{
										$('.result #viewwindow #total').html(Number(d['item']));
									}
									if(typeof d['temptotal']=="undefined"){
										$('.result #viewwindow #temptotal').val('0');
									}
									else{
										$('.result #viewwindow #temptotal').val(Number(d['temptotal']));
									}
									if(typeof d['disitem']=="undefined"){
										$('.result #viewwindow #itemdis').html('0');
									}
									else{
										$('.result #viewwindow #itemdis').html(0-Number(d['disitem']));
									}
									if(typeof d['discount']=="undefined"){
										$('.result #viewwindow #tempdis').val('0');
									}
									else{
										$('.result #viewwindow #tempdis').val(0-Number(d['discount']));
									}
									if(typeof d['autodis']=="undefined"){
										$('.result #viewwindow #autodis').html('0');
										$('.result #viewwindow input[name="autodiscontent"]').val('');
										$('.result #viewwindow input[name="autodispremoney"]').val('0');
									}
									else{
										$('.result #viewwindow #autodis').html(0-Number(d['autodis']));
										$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
										$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
									}
									$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
									if(typeof d['charge']=="undefined"){
										$('.result #viewwindow #charge').html('0');
									}
									else{
										$('.result #viewwindow #charge').html(d['charge']);
									}
									$('.result #viewwindow #listdis1').html('0');
									if(typeof d['dislist']=="undefined"){//存的是金額，因此放在折讓
										$('.result #viewwindow #listdis2').html('0');
									}
									else{
										$('.result #viewwindow #listdis2').html(0-Number(d['dislist']));
									}
									$('.result #viewwindow #should').html(d['should']);
									$('.result #viewwindow #cashcomm').html('0');
									$('.result #viewwindow #already').html('0');
									$('.result #viewwindow #cashmoney').html('0');
									$('.result #viewwindow #cash').html('0');
									$('.result #viewwindow #other').html('0');
									$('.result #viewwindow input[name="otherstring"]').html('');
									$('.result #viewwindow #notyet').html(d['should']);
									$('.result #viewwindow #change').html('0');
									$('.result #paycontent').html('');

									d['freeinv']=Number(d['freeinv'])-Number($('.result #viewwindow #autodis').html());
									if(d['freeinv']<0){
										d['ininv']=Number(d['ininv'])+Number(d['freeinv']);
										d['freeinv']=0;
									}
									else{
									}
									$('.result #viewwindow #ininv').html(d['ininv']+Number(d['charge']));
									$('.result #viewwindow input[name="ininv"]').val(d['ininv']);
									$('.result #viewwindow #freeinv').html(d['freeinv']);
									$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							result.dialog('open');
						}
						else{
							var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
							if(res==true){
								temptoinv.dialog('close');
								$('.result input[name="sendtype"]').val('buytemp');
								$.ajax({
									url:'./lib/js/templistdata.ajax.php',
									method:'post',
									async: false,
									data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
									dataType:'json',
									success:function(d){
										if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'temptoinv-buylist templistdata.ajax.php '+d},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										$('.result #funbox .invbut').prop('disabled',true);
										$('.result #funbox .invbut #name1').html('開立發票');
										$('.result #funbox .invno').val('1');
										if($('.order#order .initsetting #openpay').val()=='1'){
											$('.result .numbox .otherpay').prop('disabled',false);
											$('.result .numbox .otherfunction').prop('disabled',false);
										}
										else{
											$('.result .numbox .otherpay').prop('disabled',true);
											$('.result .numbox .otherfunction').prop('disabled',true);
										}
										if($('.order#order .initsetting #cashbut').val()=='1'){
											$('.result .numbox .cashbut').prop('disabled',false);
										}
										else{
											$('.result .numbox .cashbut').prop('disabled',true);
										}
										$('.result .numbox .moneybut').prop('disabled',false);
										$('.result .numbox .ban').prop('disabled',true);
										$('.result .numbox .carrier').prop('disabled',true);
										$('.result .numbox .carrier2').prop('disabled',true);
										$('.result .numbox .donate').prop('disabled',true);
										$('.result #funbox #listdisbutA').prop('disabled',true);
										$('.result #funbox #listdisbutB').prop('disabled',true);
										$('.result #funbox button[class^="listdisbut"]').prop('disabled',true);
										$('.result #funbox .chargebut').prop('disabled',true);
										$('.result #funbox .receiptbut').prop('disabled',true);
										if(typeof d['buyerid']=="undefined"){
											$('.result #viewwindow input[name="tempban"]').val('');
										}
										else{
											if(d['buyerid']!='0000000000'){
												$('.result #viewwindow input[name="tempban"]').val(d['buyerid']);
											}
											else{
												$('.result #viewwindow input[name="tempban"]').val('');
											}
										}
										if(typeof d['carrierid1']=="undefined"){
											$('.result #viewwindow input[name="tempcontainer"]').val('');
										}
										else{
											if(d['carrierid1']!=null||d['carrierid1']!=''){
												$('.result #viewwindow input[name="tempcontainer"]').val(d['carrierid1']);
											}
											else{
												$('.result #viewwindow input[name="tempcontainer"]').val('');
											}
										}
										if(typeof d['item']=="undefined"){
											$('.result #viewwindow #total').html('0');
										}
										else{
											$('.result #viewwindow #total').html(Number(d['item']));
										}
										if(typeof d['temptotal']=="undefined"){
											$('.result #viewwindow #temptotal').val('0');
										}
										else{
											$('.result #viewwindow #temptotal').val(Number(d['temptotal']));
										}
										if(typeof d['disitem']=="undefined"){
											$('.result #viewwindow #itemdis').html('0');
										}
										else{
											$('.result #viewwindow #itemdis').html(0-Number(d['disitem']));
										}
										if(typeof d['tempdis']=="undefined"){
											$('.result #viewwindow #tempdis').val('0');
										}
										else{
											$('.result #viewwindow #tempdis').val(0-Number(d['tempdis']));
										}
										if(typeof d['autodis']=="undefined"){
											$('.result #viewwindow #autodis').html('0');
											$('.result #viewwindow input[name="autodiscontent"]').val('');
											$('.result #viewwindow input[name="autodispremoney"]').val('0');
										}
										else{
											$('.result #viewwindow #autodis').html(0-Number(d['autodis']));
											$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
											$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
										}
										$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
										if(typeof d['charge']=="undefined"){
											$('.result #viewwindow #charge').html('0');
										}
										else{
											$('.result #viewwindow #charge').html(d['charge']);
										}
										$('.result #viewwindow #listdis1').html('0');
										if(typeof d['dislist']=="undefined"){//存的是金額，因此放在折讓
											$('.result #viewwindow #listdis2').html('0');
										}
										else{
											$('.result #viewwindow #listdis2').html(0-Number(d['dislist']));
										}
										$('.result #viewwindow #should').html(d['should']);
										$('.result #viewwindow #cashcomm').html('0');
										$('.result #viewwindow #already').html('0');
										$('.result #viewwindow #cashmoney').html('0');
										$('.result #viewwindow #cash').html('0');
										$('.result #viewwindow #other').html('0');
										$('.result #viewwindow input[name="otherstring"]').html('');
										$('.result #viewwindow #notyet').html(d['should']);
										$('.result #viewwindow #change').html('0');
										$('.result #paycontent').html('');

										d['freeinv']=Number(d['freeinv'])-Number($('.result #viewwindow #autodis').html());
										if(d['freeinv']<0){
											d['ininv']=Number(d['ininv'])+Number(d['freeinv']);
											d['freeinv']=0;
										}
										else{
										}
										$('.result #viewwindow #ininv').html(d['ininv']+Number(d['charge']));
										$('.result #viewwindow input[name="ininv"]').val(d['ininv']);
										$('.result #viewwindow #freeinv').html(d['freeinv']);
										$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
								result.dialog('open');
							}
							else{
							}
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
				temptoinv.dialog('close');
				$('.result input[name="sendtype"]').val('buytemp');
				$('.memdata #clear').trigger('click');
				$.ajax({
					url:'./lib/js/searchlist.member.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
					dataType:'json',
					success:function(d){
						//console.log(d);
						$('.order#order #membutton #memberpoint').val(d[0]['point']);
						$('.order#order #membutton #membermoney').val(d[0]['money']);
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/templistdata.ajax.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'json',
					success:function(d){
						if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-buylist templistdata.ajax.php '+d},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
						$('.result #funbox .invbut').prop('disabled',true);
						$('.result #funbox .invbut #name1').html('開立發票');
						$('.result #funbox .invno').val('1');
						if($('.order#order .initsetting #openpay').val()=='1'){
							$('.result .numbox .otherpay').prop('disabled',false);
							for(var i=0;i<$('.paywindow button').length;i++){
								//console.log($('.paywindow button:eq('+i+') input[name="inv"]').val());
								if($('.paywindow button:eq('+i+') input[name="inv"]').length==0||$('.paywindow button:eq('+i+') input[name="inv"]').val()=='1'){
									$('.paywindow button:eq('+i+')').prop('disabled',false);
								}
								else{
									$('.paywindow button:eq('+i+')').prop('disabled',true);
								}
							}
							for(var i=0;i<$('.result .numbox .otherfunction').length;i++){
								if($('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').length==0||$('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').val()=='1'){
									$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',false);
								}
								else{
									$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',true);
								}
							}
						}
						else{
							$('.result .numbox .otherpay').prop('disabled',true);
							$('.result .numbox .otherfunction').prop('disabled',true);
						}
						if($('.order#order .initsetting #cashbut').val()=='1'){
							$('.result .numbox .cashbut').prop('disabled',false);
						}
						else{
							$('.result .numbox .cashbut').prop('disabled',true);
						}
						$('.result .numbox .moneybut').prop('disabled',false);
						$('.result .numbox .ban').prop('disabled',true);
						$('.result .numbox .carrier').prop('disabled',true);
						$('.result .numbox .carrier2').prop('disabled',true);
						$('.result .numbox .donate').prop('disabled',true);
						$('.result #funbox #listdisbutA').prop('disabled',true);
						$('.result #funbox #listdisbutB').prop('disabled',true);
						$('.result #funbox button[class^="listdisbut"]').prop('disabled',true);
						$('.result #funbox .chargebut').prop('disabled',true);
						$('.result #funbox .receiptbut').prop('disabled',true);
						if(typeof d['buyerid']=="undefined"){
							$('.result #viewwindow input[name="tempban"]').val('');
						}
						else{
							if(d['buyerid']!='0000000000'){
								$('.result #viewwindow input[name="tempban"]').val(d['buyerid']);
							}
							else{
								$('.result #viewwindow input[name="tempban"]').val('');
							}
						}
						if(typeof d['carrierid1']=="undefined"){
							$('.result #viewwindow input[name="tempcontainer"]').val('');
						}
						else{
							if(d['carrierid1']!=null||d['carrierid1']!=''){
								$('.result #viewwindow input[name="tempcontainer"]').val(d['carrierid1']);
							}
							else{
								$('.result #viewwindow input[name="tempcontainer"]').val('');
							}
						}
						if(typeof d['item']=="undefined"){
							$('.result #viewwindow #total').html('0');
						}
						else{
							$('.result #viewwindow #total').html(Number(d['item']));
						}
						if(typeof d['temptotal']=="undefined"){
							$('.result #viewwindow #temptotal').val('0');
						}
						else{
							$('.result #viewwindow #temptotal').val(Number(d['temptotal']));
						}
						if(typeof d['disitem']=="undefined"){
							$('.result #viewwindow #itemdis').html('0');
						}
						else{
							$('.result #viewwindow #itemdis').html(0-Number(d['disitem']));
						}
						if(typeof d['discount']=="undefined"){
							$('.result #viewwindow #tempdis').val('0');
						}
						else{
							$('.result #viewwindow #tempdis').val(0-Number(d['discount']));
						}
						if(typeof d['autodis']=="undefined"){
							$('.result #viewwindow #autodis').html('0');
							$('.result #viewwindow input[name="autodiscontent"]').val('');
							$('.result #viewwindow input[name="autodispremoney"]').val('0');
						}
						else{
							$('.result #viewwindow #autodis').html(0-Number(d['autodis']));
							$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
							$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
						}
						$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
						if(typeof d['charge']=="undefined"){
							$('.result #viewwindow #charge').html('0');
						}
						else{
							$('.result #viewwindow #charge').html(d['charge']);
						}
						$('.result #viewwindow #listdis1').html('0');
						if(typeof d['dislist']=="undefined"){//存的是金額，因此放在折讓
							$('.result #viewwindow #listdis2').html('0');
						}
						else{
							$('.result #viewwindow #listdis2').html(0-Number(d['dislist']));
						}
						if(typeof d['payment']!=='undefined'){
							var content='';
							if(typeof d['payment']['nidin']!=='undefined'&&typeof d['payment']['nidin']['method']!=='undefined'){
								for(var i=0;i<d['payment']['nidin']['method'].length;i++){
									content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>Nidin</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='nidinother' id='"+d['payment']['nidin']['method'][i]+"'>";
									content=content+d['payment']['nidin']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['nidin']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

									$('.result #paywindow #paycontent').append(content);
								}
							}
							else if(typeof d['payment']['intella']!=='undefined'&&typeof d['payment']['intella']['method']!=='undefined'){
								for(var i=0;i<d['payment']['intella']['method'].length;i++){
									content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+d['payment']['intella']['method'][i]+"'>";
									content=content+d['payment']['intella']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['intella']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

									$('.result #paywindow #paycontent').append(content);
								}
							}
							else if(typeof d['payment']['foodpanda']!=='undefined'&&typeof d['payment']['foodpanda']['method']!=='undefined'){
								//$('.paywindow #'+d['payment']['foodpanda']['method']).trigger('click');
								autoclick=d['payment']['foodpanda']['method'];
							}
							else if(typeof d['payment']['ubereats']!=='undefined'&&typeof d['payment']['ubereats']['method']!=='undefined'){
								//$('.paywindow #'+d['payment']['ubereats']['method']).trigger('click');
								autoclick=d['payment']['ubereats']['method'];
							}
							else if(typeof d['payment']['quickclick']!=='undefined'&&typeof d['payment']['quickclick']['method']!=='undefined'){
								//$('.paywindow #'+d['payment']['quickclick']['method']).trigger('click');
								autoclick=d['payment']['quickclick']['method'];
							}
							else{
							}
						}
						else{
							$('.result #paycontent').html('');
						}
						$('.result #viewwindow #should').html(d['should']);
						$('.result #viewwindow #cashcomm').html('0');
						$('.result #viewwindow #already').html('0');
						$('.result #viewwindow #cashmoney').html('0');
						$('.result #viewwindow #cash').html('0');
						$('.result #viewwindow #other').html('0');
						$('.result #viewwindow input[name="otherstring"]').html('');
						$('.result #viewwindow #notyet').html(d['should']);
						$('.result #viewwindow #change').html('0');
						//$('.result #paycontent').html('');

						d['freeinv']=Number(d['freeinv'])-Number($('.result #viewwindow #autodis').html())-Number($('.result #viewwindow #listdis2').html());
						if(d['freeinv']<0){
							d['ininv']=Number(d['ininv'])+Number(d['freeinv']);
							d['freeinv']=0;
						}
						else{
						}
						$('.result #viewwindow #ininv').html(d['ininv']+Number(d['charge']));
						$('.result #viewwindow input[name="ininv"]').val(d['ininv']);
						$('.result #viewwindow #freeinv').html(d['freeinv']);
						$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());

						if(typeof d['payment']==='undefined'){
						}
						else{
							closedisbut();

							computerchange();
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
				result.dialog('open');
			}
		}
		else{
			if($('.order#order .initsetting #controltable').val()=='1'){
				$.ajax({
					url:'./lib/js/checktabstate.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						if(d.substr(0,6)=='unlock'){
							var tabs=changetagtarget();
							//if($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0'){
								//alertmessage('目前發票數量不足，無法開立發票。');
							//	$('.alertmessage #text').html('目前發票數量不足，無法開立發票。');
							//	alertmessage.dialog('open');
							//}
							//else{
								$('.result input[name="sendtype"]').val('tempquicksale');

								temporder($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val());
								
								//2022/2/15 自動點選付款方式
								var autoclick='';

								$.ajax({
									url:'./lib/js/templistitems.ajax.php',
									method:'post',
									async: false,
									data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
									dataType:'json',
									success:function(d){
										if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'viewtemp-openinv templistitems.ajax.php '+d},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										var temp='';
										//console.log(d);
										$.each(d,function(index,value){
											if($.isArray(value)){
												$.each(value,function(k,v){
													temp=temp+index+'[]='+v+'&';
												});
											}
											else{
												temp=temp+index+'='+value+'&';
											}
										});
										//console.log(temp);
										if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
											$.ajax({
												//url:'./lib/js/compdis.ajax.php',//2021/4/29 為了讓nidin訂單的折扣正確顯示，同時在暫結直接結帳的流程中，已經計算好自動優惠，不用再次計算
												url:'./lib/js/getdis.ajax.php',
												method:'post',
												async: false,
												//data:temp,//2021/4/29 為了讓nidin訂單的折扣正確顯示，更換使用參數
												data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
												//dataType:'html',//2021/4/29
												dataType:'json',
												success:function(d){
													//console.log(d);
													/*if(d.length>20||d.match('ERROR HINT: ')){//2021/4/29
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'viewtemp-openinv compdis.ajax.php '+d},
															dataType:'html',
															success:function(d){
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}*/
													/*var temp=d.split(';');//2021/4/29
													if($.isNumeric(temp[0])){
														$('.result #viewwindow #autodis').html(temp[0]);
														$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
														$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
													}
													else{
														$('.result #viewwindow #autodis').html('0');
														$('.result #viewwindow input[name="autodiscontent"]').val('');
														$('.result #viewwindow input[name="autodispremoney"]').val('0');
													}*/
													if(d['autodis']!=0){
														$('.result #viewwindow #autodis').html(0-d['autodis']);
														$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
														$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
													}
													else{
														$('.result #viewwindow #autodis').html('0');
														$('.result #viewwindow input[name="autodiscontent"]').val('');
														$('.result #viewwindow input[name="autodispremoney"]').val('0');
													}
													//console.log(d);
												},
												error:function(e){
													//console.log(e)
												}
											});
										}
										else{
											$('.result #viewwindow #autodis').html('0');
											$('.result #viewwindow input[name="autodiscontent"]').val('');
											$('.result #viewwindow input[name="autodispremoney"]').val('0');
										}
										var flooramt=0;
										flooramt=Number(flooramt)+(parseInt(d['person1'])*Number($('.setperson #view input[name="personfloor1"]').val()));
										flooramt=Number(flooramt)+(parseInt(d['person2'])*Number($('.setperson #view input[name="personfloor2"]').val()));
										flooramt=Number(flooramt)+(parseInt(d['person3'])*Number($('.setperson #view input[name="personfloor3"]').val()));
										$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val(flooramt);
										var total=0;
										var itemdis=0;
										var temptotal=0;
										var tempdis=0;
										var caninilistdis=0;
										var canlistdis=0;
										var cannotlistdis=0;

										var canusemempoint=0;
										var usepoint=0;

										//console.log(d['no'].length);
										for(var i=0;i<d['no'].length;i++){
											total=Number(total)+Number(d['subtotal'][i]);
											itemdis=Number(itemdis)+Number(d['discount'][i]);
											if(d['needcharge'][i]=='1'){
												temptotal=Number(temptotal)+Number(d['subtotal'][i]);
												tempdis=Number(tempdis)+Number(d['discount'][i]);
											}
											else{
											}
											if(d['listdis'][i]=='1'){
												caninilistdis=Number(caninilistdis)+Number(d['subtotal'][i]);

												if(Number(d['discount'][i])!=0){//具有單品促銷

													if(Number(d['dispoint'][i])!=0){//有使用單品促銷－點數兌換
														usepoint=parseInt(usepoint)+parseInt(d['dispoint'][i]);
													}
													else{
													}

													if(d['bothdis'][i]=='1'){//允許同時使用單品促銷與帳單折扣(讓)
														canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
													}
													else{
														continue;
													}
												}
												else{
													canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
												}
												
											}
											else{
												cannotlistdis=Number(cannotlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
											}
											if(d['getpointtype'][i]=='2'){//2020/4/20 品項中多一個屬性，紀錄該品項的集點方式；固定點數、金額點數。本欄位是只計算金額點數
												canusemempoint=parseFloat(canusemempoint)+parseFloat(d['subtotal'][i]);
											}
											else{
											}
										}
										if($('.order#order .initsetting #comfloor').val()=='1'){
											if(Number(total)<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
												$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(total)));
											}
											else{
												$('.result #viewwindow input[name="floorspan"]').val('0');
											}
										}
										else{
											if(Number(d['amt'])<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
												$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(d['amt'])));
											}
											else{
												$('.result #viewwindow input[name="floorspan"]').val('0');
											}
										}
										if(Number($('.result #viewwindow input[name="floorspan"]').val())>0){
											var t=confirm('不足低銷，將以低消計算('+$('.result .frontunit').val()+$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val()+$('.result .unit').val()+')');
											if(t==true){
												$('.result #viewwindow #total').html($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
												$('.result #viewwindow #temptotal').val($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
												$('.result #viewwindow #itemdis').html('0');
												$('.result #viewwindow #tempdis').val('0');
											}
											else{
												$('.result #viewwindow #total').html(total);
												$('.result #viewwindow #temptotal').val(temptotal);
												$('.result #viewwindow #itemdis').html(-itemdis);
												$('.result #viewwindow #tempdis').val(-tempdis);
											}
											if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'&&$('.viewtemp #listno input[name="listtype"]').val()=='1'){//開啟服務費
												$('.result #viewwindow #charge').html(temparray['charge']);
											}
											else{//關閉服務費
											}
										}
										else{
											$('.result #viewwindow #total').html(total);
											$('.result #viewwindow #temptotal').val(temptotal);
											$('.result #viewwindow #itemdis').html(-itemdis);
											$('.result #viewwindow #tempdis').val(-tempdis);
										}
										$('.result .caninilistdis').val(caninilistdis);
										$('.result .canlistdis').val(canlistdis);
										$('.result .cannotlistdis').val(cannotlistdis);
										$('.result .canusemempoint').val(canusemempoint);
										$('.result .usepoint').val(usepoint);
										$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
										$('.result #viewwindow #charge').html(d['charge']);
										$('.result #viewwindow #listdis1').html('0');
										$('.result #viewwindow #listdis2').html(0-d['listdis2']);
										$('.result #paywindow #paycontent').html('');
										if(typeof d['payment']!=='undefined'){
											var content='';
											if(typeof d['payment']['nidin']!=='undefined'&&typeof d['payment']['nidin']['method']!=='undefined'){
												for(var i=0;i<d['payment']['nidin']['method'].length;i++){
													content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>Nidin</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='nidinother' id='"+d['payment']['nidin']['method'][i]+"'>";
													content=content+d['payment']['nidin']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['nidin']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

													$('.result #paywindow #paycontent').append(content);
												}
											}
											else if(typeof d['payment']['intella']!=='undefined'&&typeof d['payment']['intella']['method']!=='undefined'){
												for(var i=0;i<d['payment']['intella']['method'].length;i++){
													content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+d['payment']['intella']['method'][i]+"'>";
													content=content+d['payment']['intella']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['intella']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

													$('.result #paywindow #paycontent').append(content);
												}
											}
											else if(typeof d['payment']['foodpanda']!=='undefined'&&typeof d['payment']['foodpanda']['method']!=='undefined'){
												//$('.paywindow #'+d['payment']['foodpanda']['method']).trigger('click');
												autoclick=d['payment']['foodpanda']['method'];
											}
											else if(typeof d['payment']['ubereats']!=='undefined'&&typeof d['payment']['ubereats']['method']!=='undefined'){
												//$('.paywindow #'+d['payment']['ubereats']['method']).trigger('click');
												autoclick=d['payment']['ubereats']['method'];
											}
											else if(typeof d['payment']['quickclick']!=='undefined'&&typeof d['payment']['quickclick']['method']!=='undefined'){
												//$('.paywindow #'+d['payment']['quickclick']['method']).trigger('click');
												autoclick=d['payment']['quickclick']['method'];
											}
											else{
											}
										}
										else{
										}
										$('.result #viewwindow #already').html('0');
										$('.result #viewwindow #cashmoney').html('0');
										$('.result #viewwindow #cash').html('0');
										$('.result #viewwindow #other').html('0');
										$('.result #viewwindow input[name="already"]').val('0');
										$('.result #viewwindow #should').html(Number(d['amt'])+Number(d['charge']));
										$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
										$('.result #viewwindow #change').html('0');

										//d['ininv']=Number(d['ininv'])+Number(d['charge']);
										d['freeinv']=Number(d['freeinv'])-Number($('.result #viewwindow #autodis').html());
										if(d['freeinv']<0){
											d['ininv']=Number(d['ininv'])+Number(d['freeinv']);
											d['freeinv']=0;
										}
										else{
										}
										$('.result #viewwindow #ininv').html(d['ininv']+Number(d['charge'])-Number($('.result #viewwindow #listdis2').html()));
										$('.result #viewwindow input[name="ininv"]').val(d['ininv']);
										$('.result #viewwindow #freeinv').html(d['freeinv']);
										$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());

										if(typeof d['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
											$('.result #viewwindow input[name="tempcontainer"]').val(d['container']);
										}
										else{
											$('.result #viewwindow input[name="tempcontainer"]').val('');
										}
										if(typeof d['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
											$('.result #viewwindow input[name="tempban"]').val(d['ban']);
										}
										else{
											$('.result #viewwindow input[name="tempban"]').val('');
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
								$('.result .numbox .otherpay').prop('disabled',false);
								$('.result .numbox .otherfunction').prop('disabled',false);
								if($('.order#order .initsetting #cashbut').val()=='1'){
									$('.result .numbox .cashbut').prop('disabled',false);
								}
								else{
									$('.result .numbox .cashbut').prop('disabled',true);
								}
								$('.result .numbox .moneybut').prop('disabled',false);
								$('.result .numbox .ban').prop('disabled',false);
								$('.result .numbox .carrier').prop('disabled',false);
								$('.result .numbox .carrier2').prop('disabled',false);
								$('.result .numbox .donate').prop('disabled',false);
								if($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0'){
									$('.result #funbox .invbut #name1').html('不開立發票');
									$('.result #funbox .invno').val('0');
								}
								else{
									$('.result #funbox .invbut #name1').html('開立發票');
									$('.result #funbox .invno').val('1');
								}
								$('.result #funbox #loopbut #name1').html($('.order#order .initsetting #listprintname1').val());
								$('.result #funbox #loopbut #name2').html($('.order#order .initsetting #listprintname2').val());
								$('.result #viewwindow .sendviewwindow input[name="looptype"]').val($('.order#order .initsetting #looptype').val());
								if($('.order#order .initsetting #openchar').val()=='0'){
									$('.result #funbox .chargebut').prop('disabled',true);
									$('.result #funbox .chargebut #name1').html('不收服務費');
									$('.result #funbox #charno').html($('.order#order .initsetting #charge').val());
								}
								else{
									$('.result #funbox .chargebut').prop('disabled',false);
									if($('.order#order .initsetting #charge').val()=='1'&&$('.viewtemp #listno input[name="listtype"]').val()=='1'){
										$('.result #funbox .chargebut #name1').html('收服務費');
										$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
									}
									else{
										$('.result #funbox .chargebut #name1').html('不收服務費');
										$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
									}
								}
								$('.result #funbox .receiptbut').prop('disabled',false);
								$('.result #funbox .receiptbut #name1').html('不列印收據章');//2019/11/28
								$('.result #funbox #receipt').val('0');
								$('.result .numbox .ban #name1').html('輸入統編');
								$('.result input[name="view"]').val('');
								$('.result input[name="view"]').css({'background-color':'#FFFFFF'});
								$('.result #viewwindow input[name="tempban"]').css({'background-color':'#EFEBDE'});
								$('.result #viewwindow input[name="tempban"]').prop('readonly',true);
								//2021/3/10 提到前面填入
								/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
									$('.result #viewwindow input[name="tempban"]').val(d['payment']['ban']);
								}
								else{
									$('.result #viewwindow input[name="tempban"]').val('');
								}*/
								$('.result #viewwindow input[name="tempcontainer"]').css({'background-color':'#EFEBDE'});
								$('.result #viewwindow input[name="tempcontainer"]').prop('readonly',true);
								//2021/3/10 提到前面填入
								/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
									$('.result #viewwindow input[name="tempcontainer"]').val(d['payment']['container']);
								}
								else{
									$('.result #viewwindow input[name="tempcontainer"]').val('');
								}*/
								$('.result .target').val('view');
								$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
								result.dialog('open');

								//2022/2/15 自動點選foodpanda、ubereats、quickclick付款方式
								if(autoclick!=''){
									$('.paywindow #'+autoclick).trigger('click');
								}
								else{
								}
							//}
						}
						else{
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
				var tabs=changetagtarget();
				//if($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0'){
				//		alertmessage('目前發票數量不足，無法開立發票。');
				//	$('.alertmessage #text').html('目前發票數量不足，無法開立發票。');
				//	alertmessage.dialog('open');
				//}
				//else{

					temporder($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val());
					
					//2022/2/15 自動點選付款方式
					var autoclick='';

					$('.result input[name="sendtype"]').val('tempquicksale');
					$.ajax({
						url:'./lib/js/templistitems.ajax.php',
						method:'post',
						async: false,
						data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
						dataType:'json',
						success:function(d){
							console.log(d);
							if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'viewtemp-openinv templistitems.ajax.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							var temp='';
							//console.log(d);
							$.each(d,function(index,value){
								if($.isArray(value)){
									$.each(value,function(k,v){
										temp=temp+index+'[]='+v+'&';
									});
								}
								else{
									temp=temp+index+'='+value+'&';
								}
							});
							//console.log(temp);
							if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
								$.ajax({
									//url:'./lib/js/compdis.ajax.php',//2021/4/29 為了讓nidin訂單的折扣正確顯示，同時在暫結直接結帳的流程中，已經計算好自動優惠，不用再次計算
									url:'./lib/js/getdis.ajax.php',
									method:'post',
									async: false,
									//data:temp,//2021/4/29 為了讓nidin訂單的折扣正確顯示，更換使用參數
									data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
									//dataType:'html',//2021/4/29
									dataType:'json',
									success:function(d){
										//console.log(d);
										/*if(d.length>20||d.match('ERROR HINT: ')){//2021/4/29
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'viewtemp-openinv compdis.ajax.php '+d},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}*/
										/*var temp=d.split(';');//2021/4/29
										if($.isNumeric(temp[0])){
											$('.result #viewwindow #autodis').html(temp[0]);
											$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
											$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
										}
										else{
											$('.result #viewwindow #autodis').html('0');
											$('.result #viewwindow input[name="autodiscontent"]').val('');
											$('.result #viewwindow input[name="autodispremoney"]').val('0');
										}*/
										if(d['autodis']!=0){
											$('.result #viewwindow #autodis').html(0-d['autodis']);
											$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
											$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
										}
										else{
											$('.result #viewwindow #autodis').html('0');
											$('.result #viewwindow input[name="autodiscontent"]').val('');
											$('.result #viewwindow input[name="autodispremoney"]').val('0');
										}
										//console.log(d);
									},
									error:function(e){
										//console.log(e)
									}
								});
							}
							else{
								$('.result #viewwindow #autodis').html('0');
								$('.result #viewwindow input[name="autodiscontent"]').val('');
								$('.result #viewwindow input[name="autodispremoney"]').val('0');
							}
							var flooramt=0;
							flooramt=Number(flooramt)+(parseInt(d['person1'])*Number($('.setperson #view input[name="personfloor1"]').val()));
							flooramt=Number(flooramt)+(parseInt(d['person2'])*Number($('.setperson #view input[name="personfloor2"]').val()));
							flooramt=Number(flooramt)+(parseInt(d['person3'])*Number($('.setperson #view input[name="personfloor3"]').val()));
							$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val(flooramt);
							var total=0;
							var itemdis=0;
							var temptotal=0;
							var tempdis=0;
							var caninilistdis=0;
							var canlistdis=0;
							var cannotlistdis=0;

							var canusemempoint=0;
							var usepoint=0;

							//console.log(d['no'].length);
							for(var i=0;i<d['no'].length;i++){
								total=Number(total)+Number(d['subtotal'][i]);
								itemdis=Number(itemdis)+Number(d['discount'][i]);
								if(d['needcharge'][i]){
									temptotal=Number(temptotal)+Number(d['subtotal'][i]);
									tempdis=Number(tempdis)+Number(d['discount'][i]);
								}
								else{
								}
								if(d['listdis'][i]=='1'){
									caninilistdis=Number(caninilistdis)+Number(d['subtotal'][i]);

									if(Number(d['discount'][i])!=0){//具有單品促銷

										if(Number(d['dispoint'][i])!=0){//有使用單品促銷－點數兌換
											usepoint=parseInt(usepoint)+parseInt(d['dispoint'][i]);
										}
										else{
										}

										if(d['bothdis'][i]=='1'){//允許同時使用單品促銷與帳單折扣(讓)
											canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
										}
										else{
											continue;
										}
									}
									else{
										canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
									}
								}
								else{
									cannotlistdis=Number(cannotlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
								}
								if(d['getpointtype'][i]=='2'){//2020/4/20 品項中多一個屬性，紀錄該品項的集點方式；固定點數、金額點數。本欄位是只計算金額點數
									canusemempoint=parseFloat(canusemempoint)+parseFloat(d['subtotal'][i]);
								}
								else{
								}
							}
							if($('.order#order .initsetting #comfloor').val()=='1'){
								if(Number(total)<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
									$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(total)));
								}
								else{
									$('.result #viewwindow input[name="floorspan"]').val('0');
								}
							}
							else{
								if(Number(d['amt'])<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
									$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(d['amt'])));
								}
								else{
									$('.result #viewwindow input[name="floorspan"]').val('0');
								}
							}
							if(Number($('.result #viewwindow input[name="floorspan"]').val())>0){
								var t=confirm('不足低銷，將以低消計算('+$('.result .frontunit').val()+$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val()+$('.result .unit').val()+')');
								if(t==true){
									$('.result #viewwindow #total').html($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
									$('.result #viewwindow #temptotal').val($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
									$('.result #viewwindow #itemdis').html('0');
									$('.result #viewwindow #tempdis').val('0');
								}
								else{
									$('.result #viewwindow #total').html(total);
									$('.result #viewwindow #temptotal').val(temptotal);
									$('.result #viewwindow #itemdis').html(-itemdis);
									$('.result #viewwindow #tempdis').val(-tempdis);
								}
								if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'&&$('.viewtemp #listno input[name="listtype"]').val()=='1'){//開啟服務費
									$('.result #viewwindow #charge').html(temparray['charge']);
								}
								else{//關閉服務費
								}
							}
							else{
								$('.result #viewwindow #total').html(total);
								$('.result #viewwindow #temptotal').val(temptotal);
								$('.result #viewwindow #itemdis').html(-itemdis);
								$('.result #viewwindow #tempdis').val(-tempdis);
							}
							$('.result .caninilistdis').val(caninilistdis);
							$('.result .canlistdis').val(canlistdis);
							$('.result .cannotlistdis').val(cannotlistdis);
							$('.result .canusemempoint').val(canusemempoint);
							$('.result .usepoint').val(usepoint);
							$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
							$('.result #viewwindow #charge').html(d['charge']);
							$('.result #viewwindow #listdis1').html('0');
							$('.result #viewwindow #listdis2').html(0-d['listdis2']);
							$('.result #paywindow #paycontent').html('');
							if(typeof d['payment']!=='undefined'){
								var content='';
								if(typeof d['payment']['nidin']!=='undefined'&&typeof d['payment']['nidin']['method']!=='undefined'){
									for(var i=0;i<d['payment']['nidin']['method'].length;i++){
										content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>Nidin</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='nidinother' id='"+d['payment']['nidin']['method'][i]+"'>";
										content=content+d['payment']['nidin']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['nidin']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

										$('.result #paywindow #paycontent').append(content);
									}
								}
								else if(typeof d['payment']['intella']!=='undefined'&&typeof d['payment']['intella']['method']!=='undefined'){
									for(var i=0;i<d['payment']['intella']['method'].length;i++){
										content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+d['payment']['intella']['method'][i]+"'>";
										content=content+d['payment']['intella']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['intella']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

										$('.result #paywindow #paycontent').append(content);
									}
								}
								else if(typeof d['payment']['foodpanda']!=='undefined'&&typeof d['payment']['foodpanda']['method']!=='undefined'){
									//$('.paywindow #'+d['payment']['foodpanda']['method']).trigger('click');
									autoclick=d['payment']['foodpanda']['method'];
								}
								else if(typeof d['payment']['ubereats']!=='undefined'&&typeof d['payment']['ubereats']['method']!=='undefined'){
									//$('.paywindow #'+d['payment']['ubereats']['method']).trigger('click');
									autoclick=d['payment']['ubereats']['method'];
								}
								else if(typeof d['payment']['quickclick']!=='undefined'&&typeof d['payment']['quickclick']['method']!=='undefined'){
									//$('.paywindow #'+d['payment']['quickclick']['method']).trigger('click');
									autoclick=d['payment']['quickclick']['method'];
								}
								else{
								}
							}
							else{
							}
							$('.result #viewwindow #already').html('0');
							$('.result #viewwindow #cashmoney').html('0');
							$('.result #viewwindow #cash').html('0');
							$('.result #viewwindow #other').html('0');
							$('.result #viewwindow input[name="already"]').val('0');
							$('.result #viewwindow #should').html(Number(d['amt'])+Number(d['charge']));
							$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
							$('.result #viewwindow #change').html('0');

							//d['ininv']=Number(d['ininv'])+Number(d['charge']);
							d['freeinv']=Number(d['freeinv'])-Number($('.result #viewwindow #autodis').html());
							if(d['freeinv']<0){
								d['ininv']=Number(d['ininv'])+Number(d['freeinv']);
								d['freeinv']=0;
							}
							else{
							}
							$('.result #viewwindow #ininv').html(d['ininv']+Number(d['charge'])-Number($('.result #viewwindow #listdis2').html()));
							$('.result #viewwindow input[name="ininv"]').val(d['ininv']);
							$('.result #viewwindow #freeinv').html(d['freeinv']);
							$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());

							if(typeof d['payment']==='undefined'){
							}
							else{
								closedisbut();

								computerchange();
							}

							if(typeof d['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
								$('.result #viewwindow input[name="tempcontainer"]').val(d['container']);
							}
							else{
								$('.result #viewwindow input[name="tempcontainer"]').val('');
							}
							if(typeof d['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
								$('.result #viewwindow input[name="tempban"]').val(d['ban']);
							}
							else{
								$('.result #viewwindow input[name="tempban"]').val('');
							}
						},
						error:function(e){
							//console.log(e);
						}
					});
					$('.result .numbox .otherpay').prop('disabled',false);
					$('.result .numbox .otherfunction').prop('disabled',false);
					if($('.order#order .initsetting #cashbut').val()=='1'){
						$('.result .numbox .cashbut').prop('disabled',false);
					}
					else{
						$('.result .numbox .cashbut').prop('disabled',true);
					}
					$('.result .numbox .moneybut').prop('disabled',false);
					$('.result .numbox .ban').prop('disabled',false);
					$('.result .numbox .carrier').prop('disabled',false);
					$('.result .numbox .carrier2').prop('disabled',false);
					$('.result .numbox .donate').prop('disabled',false);
					if($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0'){
						$('.result #funbox .invbut #name1').html('不開立發票');
						$('.result #funbox .invno').val('0');
					}
					else{
						$('.result #funbox .invbut #name1').html('開立發票');
						$('.result #funbox .invno').val('1');
					}
					$('.result #funbox #loopbut #name1').html($('.order#order .initsetting #listprintname1').val());
					$('.result #funbox #loopbut #name2').html($('.order#order .initsetting #listprintname2').val());
					$('.result #viewwindow .sendviewwindow input[name="looptype"]').val($('.order#order .initsetting #looptype').val());
					if($('.order#order .initsetting #openchar').val()=='0'){
						$('.result #funbox .chargebut').prop('disabled',true);
						$('.result #funbox .chargebut #name1').html('不收服務費');
						$('.result #funbox #charno').html($('.order#order .initsetting #charge').val());
					}
					else{
						$('.result #funbox .chargebut').prop('disabled',false);
						if($('.order#order .initsetting #charge').val()=='1'&&$('.viewtemp #listno input[name="listtype"]').val()=='1'){
							$('.result #funbox .chargebut #name1').html('收服務費');
							$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
						}
						else{
							$('.result #funbox .chargebut #name1').html('不收服務費');
							$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
						}
					}
					$('.result #funbox .receiptbut').prop('disabled',false);
					$('.result #funbox .receiptbut #name1').html('不列印收據章');//2019/11/28
					$('.result #funbox #receipt').val('0');
					$('.result .numbox .ban #name1').html('輸入統編');
					$('.result input[name="view"]').val('');
					$('.result input[name="view"]').css({'background-color':'#FFFFFF'});
					$('.result #viewwindow input[name="tempban"]').css({'background-color':'#EFEBDE'});
					$('.result #viewwindow input[name="tempban"]').prop('readonly',true);
					//2021/3/10 提到前面填入
					/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
						$('.result #viewwindow input[name="tempban"]').val(d['paymeny']['ban']);
					}
					else{
						$('.result #viewwindow input[name="tempban"]').val('');
					}*/
					$('.result #viewwindow input[name="tempcontainer"]').css({'background-color':'#EFEBDE'});
					$('.result #viewwindow input[name="tempcontainer"]').prop('readonly',true);
					//2021/3/10 提到前面填入
					/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
						$('.result #viewwindow input[name="tempcontainer"]').val(d['payment']['container']);
					}
					else{
						$('.result #viewwindow input[name="tempcontainer"]').val('');
					}*/
					$('.result .target').val('view');
					$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
					result.dialog('open');

					//2022/2/15 自動點選foodpanda、ubereats、quickclick付款方式
					if(autoclick!=''){
						$('.paywindow #'+autoclick).trigger('click');
					}
					else{
					}
				//}
			}
		}
	});
	$('.viewtemp #otherfun').on('click','#plus',function(event){//加點
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單帳單加點','click');
		//oneEvent(event);
		if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
			$('.temptoinv').html('');
			$('.temptoinv').append("<button id='delplus' value='修改帳單'>修改帳單</button>");
			$('.temptoinv').append("<button id='cancel' value='取消'>取消</button>");
			temptoinv.dialog('open');
		}
		else{
			//console.log($.trim($('.viewtemp #listno').html()));
			if($('.order#order .initsetting #controltable').val()=='1'){
				$.ajax({
					url:'./lib/js/checktabstate.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var tempd=d.split('-');
						if(tempd[0]=='unlock'){
							temporder($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val());
							viewtemp.dialog('close');
							if($('.funbox').length>0&&funbox.dialog('isOpen')){
								funbox.dialog('close');
								inittable.dialog('close');
							}
							else{
							}
						}
						else{
							var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
							if(res==true){
								temporder($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val());
								viewtemp.dialog('close');
								if($('.funbox').length>0&&funbox.dialog('isOpen')){
									funbox.dialog('close');
									inittable.dialog('close');
								}
								else{
								}
							}
							else{
							}
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
				temporder($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val());
				viewtemp.dialog('close');
			}
		}
	});
	$('.order#order #MemberBill #member').on('click','#membutton',function(event){
		//oneEvent(event);
		if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').length==0){
			//console.log('遺失memno變數');
		}
		else if($('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val().length==0){
			meminput.dialog('open');
		}
		else{
			memdata.dialog('open');
		}
	});
	$('.meminput').on('click','#cremem',function(event){
		//oneEvent(event);
		if($('.order#order .initsetting #quickcremember').val()=='0'){
			cremem.dialog('open');//開啟新增會員介面
		}
		else{//新增會員
			if($('.meminput #memtel').val()==''){
			}
			else{
				if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
					$.ajax({
						url:'http://api.tableplus.com.tw/outposandorder/memberapi/create.member.php',
						method:'post',
						async: false,
						data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'name':$('.meminput #memtel').val(),'tel':$('.meminput #memtel').val(),'initpower':$('.order#order .companydata #initpower').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/create.member.php(online success) '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(d=='exists'){
								//alertmessage('該電話已存在。');
							}
							else if(d=='success'){
								//alertmessage('新增成功。');
							}
							else{
							}
						},
						error:function(e){
							//console.log(e);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/create.member.php(online error) '+e},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
					});
				}
				else{
					$.ajax({
						url:'../memberapi/create.member.php',
						method:'post',
						async: false,
						data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'name':$('.meminput #memtel').val(),'tel':$('.meminput #memtel').val(),'initpower':$('.order#order .companydata #initpower').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'../memberapi/create.member.php(offline success) '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(d=='exists'){
								//alertmessage('該電話已存在。');
							}
							else if(d=='success'){
								//alertmessage('新增成功。');
							}
							else{
							}
						},
						error:function(e){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'../memberapi/create.member.php(offline error) '+e},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
					});
				}
				$('.meminput #searchmem').trigger('click');
			}
		}
	});
	$('.meminput').on('click','#searchmem',function(event){//查詢會員
		//oneEvent(event);
		if($('.meminput #memtel').val().length<2){
			if($('.initsetting #faceidmember').length>0&&$('.initsetting #faceidmember').val()=='1'){//會員臉部ID
				$.ajax({
					url:'./lib/api/faceid/check.facedata.php',
					method:'post',
					async:false,
					data:{'machine':'m1'},
					dataType:'json',
					success:function(d){
						if(d['state']=='success'){
							//console.log(d);
							$('.meminput #memtel').val(d['tel']);
							$('.meminput #searchmem').trigger('click');
						}
						else{
							//alertmessage('請填入至少兩碼。');
							$('.alertmessage #text').html('請會員再次嘗試臉部識別或填入至少兩碼。');
							alertmessage.dialog('open');
						}
					},
					error:function(e){
						//alertmessage('請填入至少兩碼。');
						$('.alertmessage #text').html('請會員再次嘗試臉部識別或填入至少兩碼。'+e);
						alertmessage.dialog('open');
					}
				});
			}
			else{
				//alertmessage('請填入至少兩碼。');
				$('.alertmessage #text').html('請填入至少兩碼。');
				alertmessage.dialog('open');
			}
		}
		else{
			//console.log('1');
			if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
				$.ajax({
					url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php',
					method:'post',
					async:false,
					data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','tel':$('.meminput #memtel').val(),'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val()},
					dataType:'json',
					success:function(d){
						//console.log(JSON.stringify(d));
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online success)'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if($(window).width()==1920){
							var preitem=7;//???尚未確認
						}
						else if($(window).width()==1366){
							var preitem=8;
						}
						else if($(window).width()==1280){
							var preitem=9;
						}
						else if($(window).width()<=1280&&$(window).width()>1024){
							var preitem=9;
						}
						else{// if($(window).width()==1024)
							var preitem=10;
						}
						if(d=="查無資料庫。"){
							$.ajax({
								url:'./lib/js/getinterfacename.ajax.php',
								method:'post',
								async:false,
								data:{'name':'emptydatabase'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$('.meminput #memslist #listbox #lists').html(d[0]);
								},
								error:function(e){
									//console.log(e);
									$('.meminput #memslist #listbox #lists').html('查無資料庫。');
								}
							});
							
							$('.meminput #memslist #listbox input[name="allitems"]').val('');
							$('.meminput #memslist #listbox input[name="page"]').val('');
							$('.meminput #memslist #listbox #allresult').html('');
						}
						else if(d.length==0){
							$.ajax({
								url:'./lib/js/getinterfacename.ajax.php',
								method:'post',
								async:false,
								data:{'name':'emptydata'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$('.meminput #memslist #listbox #lists').html(d[0]);
								},
								error:function(e){
									//console.log(e);
									$('.meminput #memslist #listbox #lists').html('查無資料');
								}
							});
							$('.meminput #memslist #listbox input[name="allitems"]').val('');
							$('.meminput #memslist #listbox input[name="page"]').val('');
							$('.meminput #memslist #listbox #allresult').html('');
						}
						else{
							$('.meminput #memslist #listbox input[name="allitems"]').val(d.length);
							$('.meminput #memslist #listbox input[name="page"]').val('0');
							$('.meminput #memslist #listbox #allresult').html('');
							for(var i=0;i<d.length;i++){
								if(typeof d[i]['point']==="undefined"){
									var mempoint='0';
								}
								else{
									var mempoint=d[i]['point'];
								}
								if(typeof d[i]['money']==="undefined"){
									var memmoney='0';
								}
								else{
									var memmoney=d[i]['money'];
								}
								$('.meminput #memslist #listbox #allresult').append("<input type='hidden' id='"+i+"' value='"+d[i]['memno']+","+d[i]['tel']+","+d[i]['tel2']+","+d[i]['name']+","+d[i]['address']+","+d[i]['setting']+","+mempoint+","+memmoney+","+d[i]['powername']+"'>");
							}
							$('.meminput #memslist #listbox #lists').html('');
							if(parseInt(d.length%preitem)>0){
								if((parseInt(d.length/preitem)+1)==1){
									$('.meminput #memslist #fun #change').prop('disabled',true);
								}
								else{
									$('.meminput #memslist #fun #change').prop('disabled',false);
								}
							}
							else{
								if(parseInt(d.length/preitem)==1){
									$('.meminput #memslist #fun #change').prop('disabled',true);
								}
								else{
									$('.meminput #memslist #fun #change').prop('disabled',false);
								}
							}
							var maxitem=0;
							if(d.length>preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1)){
								maxitem=preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1);
							}
							else{
								maxitem=d.length;
							}
							for(var i=0;i<maxitem;i++){
								if(d[i]['address']==null){
									d[i]['address']='';
								}
								else{
								}
								if(d[i]['tel2']==null){
									d[i]['tel2']='';
								}
								else{
								}
								if(typeof d[i]['point']==="undefined"){
									var mempoint='0';
								}
								else{
									var mempoint=d[i]['point'];
								}
								if(typeof d[i]['money']==="undefined"){
									var memmoney='0';
								}
								else{
									var memmoney=d[i]['money'];
								}
								if(d[i]['address'].match(';php;')){
									var addressarray=d[i]['address'].split(';php;');
									d[i]['address']=addressarray[0];
								}
								else{
								}
								if(typeof d[i]['companynumber']==="undefined"||d[i]['companynumber']==null){
									var companynumber='';
								}
								else{
									var companynumber=d[i]['companynumber'];
								}
								if(typeof d[i]['remark']==="undefined"||d[i]['remark']==null){
									var remark='';
								}
								else{
									var remark=d[i]['remark'];
								}
								$('.meminput #memslist #listbox #lists').append('<div class="memitem" style="width:calc(100% - 10px);margin:10px 5px 0 5px;padding-bottom:5px;border-bottom:1px solid #898989;float:left;"><input type="hidden" name="memno" value="'+d[i]['memno']+'"><input type="hidden" name="address" value="'+d[i]['address']+'"><input type="hidden" name="tel2" value="'+d[i]['tel2']+'"><input type="hidden" name="point" value="'+mempoint+'"><input type="hidden" name="money" value="'+memmoney+'"><input type="hidden" name="powername" value="'+d[i]['powername']+'"><input type="hidden" name="companynumber" value="'+companynumber+'"><input type="hidden" name="remark" value="'+remark+'"><div style="width:calc(100% / 3);float:left;">'+d[i]['tel']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['name']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['setting']+'</div></div>');
							}
						}
						//$('.meminput #memtel').val('');//2021/8/24 搜尋完不清空(志)
					},
					error:function(e){
						//console.log(e);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemdata.ajax.php(online error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
				});
			}
			else{//本地會員
				$.ajax({
					url:'../memberapi/getmemdata.ajax.php',
					method:'post',
					async:false,
					data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','tel':$('.meminput #memtel').val(),'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val()},
					dataType:'json',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/create.member.php(offline success)'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if($(window).width()==1920){
							var preitem=7;//???尚未確認
						}
						else if($(window).width()==1366){
							var preitem=8;
						}
						else if($(window).width()==1280){
							var preitem=9;
						}
						else if($(window).width()<=1280&&$(window).width()>1024){
							var preitem=9;
						}
						else{// if($(window).width()==1024)
							var preitem=10;
						}
						if(d=="查無資料庫。"){
							$.ajax({
								url:'./lib/js/getinterfacename.ajax.php',
								method:'post',
								async:false,
								data:{'name':'emptydatabase'},
								dataType:'json',
								success:function(d){
									//console.log(d);
									$('.meminput #memslist #listbox #lists').html(d[0]);
								},
								error:function(e){
									//console.log(e);
									$('.meminput #memslist #listbox #lists').html('查無資料庫。');
								}
							});
							$('.meminput #memslist #listbox input[name="allitems"]').val('');
							$('.meminput #memslist #listbox input[name="page"]').val('');
							$('.meminput #memslist #listbox #allresult').html('');
						}
						else if(d.length==0){
							$.ajax({
								url:'./lib/js/getinterfacename.ajax.php',
								method:'post',
								async:false,
								data:{'name':'emptydata'},
								dataType:'html',
								success:function(d){
									//console.log(d);
									$('.meminput #memslist #listbox #lists').html(d[0]);
								},
								error:function(e){
									//console.log(e);
									$('.meminput #memslist #listbox #lists').html('查無資料');
								}
							});
							$('.meminput #memslist #listbox input[name="allitems"]').val('');
							$('.meminput #memslist #listbox input[name="page"]').val('');
							$('.meminput #memslist #listbox #allresult').html('');
						}
						else{
							$('.meminput #memslist #listbox input[name="allitems"]').val(d.length);
							$('.meminput #memslist #listbox input[name="page"]').val('0');
							for(var i=0;i<d.length;i++){
								if(typeof d[i]['point']==="undefined"){
									var mempoint='0';
								}
								else{
									var mempoint=d[i]['point'];
								}
								if(typeof d[i]['money']==="undefined"){
									var memmoney='0';
								}
								else{
									var memmoney=d[i]['money'];
								}
								$('.meminput #memslist #listbox #allresult').append("<input type='hidden' id='"+i+"' value='"+d[i]['memno']+","+d[i]['tel']+","+d[i]['tel2']+","+d[i]['name']+","+d[i]['address']+","+d[i]['setting']+","+mempoint+","+memmoney+"'>");
							}
							$('.meminput #memslist #listbox #lists').html('');
							if(parseInt(d.length%preitem)>0){
								if((parseInt(d.length/preitem)+1)==1){
									$('.meminput #memslist #fun #change').prop('disabled',true);
								}
								else{
									$('.meminput #memslist #fun #change').prop('disabled',false);
								}
							}
							else{
								if(parseInt(d.length/preitem)==1){
									$('.meminput #memslist #fun #change').prop('disabled',true);
								}
								else{
									$('.meminput #memslist #fun #change').prop('disabled',false);
								}
							}
							var maxitem=0;
							if(d.length>preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1)){
								maxitem=preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1);
							}
							else{
								maxitem=d.length;
							}
							for(var i=0;i<maxitem;i++){
								if(d[i]['address']==null){
									d[i]['address']='';
								}
								else{
								}
								if(d[i]['tel2']==null){
									d[i]['tel2']='';
								}
								else{
								}
								if(typeof d[i]['point']==="undefined"){
									var mempoint='0';
								}
								else{
									var mempoint=d[i]['point'];
								}
								if(typeof d[i]['money']==="undefined"){
									var memmoney='0';
								}
								else{
									var memmoney=d[i]['money'];
								}
								if(typeof d[i]['companynumber']==="undefined"||d[i]['companynumber']==null){
									var companynumber='';
								}
								else{
									var companynumber=d[i]['companynumber'];
								}
								if(typeof d[i]['remark']==="undefined"||d[i]['remark']==null){
									var remark='';
								}
								else{
									var remark=d[i]['remark'];
								}
								$('.meminput #memslist #listbox #lists').append('<div class="memitem" style="width:calc(100% - 10px);margin:10px 5px 0 5px;padding-bottom:5px;border-bottom:1px solid #898989;float:left;"><input type="hidden" name="memno" value="'+d[i]['memno']+'"><input type="hidden" name="address" value="'+d[i]['address']+'"><input type="hidden" name="tel2" value="'+d[i]['tel2']+'"><input type="hidden" name="point" value="'+mempoint+'"><input type="hidden" name="money" value="'+memmoney+'"><input type="hidden" name="powername" value="'+d[i]['powername']+'"><input type="hidden" name="companynumber" value="'+companynumber+'"><input type="hidden" name="remark" value="'+remark+'"><div style="width:calc(100% / 3);float:left;">'+d[i]['tel']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['name']+'</div><div style="width:calc(100% / 3);float:left;">'+d[i]['setting']+'</div></div>');
							}
						}
						//$('.meminput #memtel').val('');//2021/8/24 搜尋完不清空(志)
					},
					error:function(e){
						//console.log(e);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/create.member.php(offline error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
				});
			}
		}
	});
	$('.cremem').on('click','#create',function(event){//新增會員－送出
		//oneEvent(event);
		if($('.cremem input[name="tel"]').val()!=""){
			var tel=$('.cremem input[name="tel"]').val();
			if($('.cremem input[name="name"]').val()==''){
				var name=tel;
			}
			else{
				var name=$('.cremem input[name="name"]').val();
			}
			if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
				$.ajax({
					url:'http://api.tableplus.com.tw/outposandorder/memberapi/create.member.php',
					method:'post',
					async: false,
					data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'name':name,'tel':tel,'address':$('.cremem input[name="address"]').val(),'remark':$('.cremem textarea[name="remark"]').val(),'initpower':$('.order#order .companydata #initpower').val(),'setting':$('.cremem input[name="setting"]').val(),'recommend':$('.cremem input[name="recommend"]').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/create.member.php(online success) '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(d=='exists'){
							//alertmessage('該電話已存在。');
							$('.alertmessage #text').html('該電話已存在。');
							alertmessage.dialog('open');
						}
						else if(d=='success'){
							//alertmessage('新增成功。');
							$.ajax({
								url:'./lib/js/create.cmdtxt.php',
								method:'post',
								async: false,
								data:{'cmd':'downloadmember'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
							if(d.statusText=="error"){
								//alertmessage('新增失敗，請確認網路狀態。(net)');
								$('.alertmessage #text').html('新增失敗，請確認網路狀態。(net)');
								alertmessage.dialog('open');
							}
							else{
								//console.log(e);
								//alertmessage('新增失敗。(net)');
								$('.alertmessage #text').html('新增失敗。(net)');
								alertmessage.dialog('open');
							}
						}
					},
					error:function(e){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/create.member.php(online error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(e.statusText=="error"){
							//alertmessage('新增失敗，請確認網路狀態。(net)');
							$('.alertmessage #text').html('新增失敗，請確認網路狀態。(net)');
							alertmessage.dialog('open');
						}
						else{
						}
					}
				});
			}
			else{
				$.ajax({
					url:'../memberapi/create.member.php',
					method:'post',
					async: false,
					data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'name':name,'tel':tel,'address':$('.cremem input[name="address"]').val(),'remark':$('.cremem textarea[name="remark"]').val(),'initpower':$('.order#order .companydata #initpower').val(),'setting':$('.cremem input[name="setting"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'../memberapi/create.member.php(offline success) '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(d=='exists'){
							//alertmessage('該電話已存在。');
							$('.alertmessage #text').html('該電話已存在。(local)');
							alertmessage.dialog('open');
						}
						else if(d=='success'){
							//alertmessage('新增成功。');
							$('.alertmessage #text').html('新增成功。(local)');
							alertmessage.dialog('open');
						}
						else{
							if(d.statusText=="error"){
								//alertmessage('新增失敗。(local)');
								$('.alertmessage #text').html('新增失敗。(local)');
								alertmessage.dialog('open');
							}
							else{
								//alertmessage('新增失敗。(local)');
								//console.log(d);
								$('.alertmessage #text').html('新增失敗。(local)');
								alertmessage.dialog('open');
							}
						}
					},
					error:function(e){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'../memberapi/create.member.php(offline error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(e.statusText=="error"){
							//alertmessage('新增失敗，請聯絡工程師。(local)');
							$('.alertmessage #text').html('新增失敗，請聯絡工程師。(local)');
							alertmessage.dialog('open');
						}
						else{
						}
					}
				});
			}
			$('.cremem input[name="name"]').val('');
			$('.cremem input[name="tel"]').val('');
			$('.cremem input[name="address"]').val('');
			if($('.cremem input[name="setting"]').length>0){
				$('.cremem input[name="setting"]').val('');
			}
			else{
			}
			$('.cremem textarea[name="remark"]').val('');
			$('.cremem input[name="recommend"]').val('');
		}
		else{
			//alertmessage('至少填寫電話。');
			$('.alertmessage #text').html('至少填寫電話。');
			alertmessage.dialog('open');
		}
	});
	$('.meminput').on('click','#reloadmem',function(event){//更新會員//之後會移除該功能，因為不用從遠端下載資料到本地端，"網路"與"本地"完全切開
		//oneEvent(event);
		//$('.cremem').on('click','#reflash',function(){
		$.ajax({
			url:'./lib/js/create.cmdtxt.php',
			method:'post',
			async: false,
			data:{'cmd':'downloadmember'},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.cremem').on('click','#close',function(event){//關閉新增會員介面
		//oneEvent(event);
		$('.cremem input[name="name"]').val('');
		$('.cremem input[name="tel"]').val('');
		$('.cremem input[name="address"]').val('');
		$('.cremem textarea[name="remark"]').val('');
		cremem.dialog('close');
	});
	$('.meminput #inputbox').on('click','#button',function(event){
		//oneEvent(event);
		var index=$('.meminput #inputbox input').index(this);
		if(index==14){
			$('.meminput #memtel').val('');
		}
		else if(index==13){
			$('.meminput #memtel').val($('.meminput #memtel').val().substr(0,$('.meminput #memtel').val().length-1));
		}
		else{
			$('.meminput #memtel').val($('.meminput #memtel').val()+$(this).val());
		}
	});
	$('.meminput #memslist #listbox #lists').on('click','.memitem',function(event){
		//oneEvent(event);
		if($(this).prop('id')=='focus'){
			$('.meminput #memslist #listbox #lists .memitem').css({'background-color':'#ffffff'});
			$('.meminput #memslist #listbox #lists .memitem').prop('id','');
			$('.meminput #memslist #fun #check').prop('disabled',true);
		}
		else{
			$('.meminput #memslist #listbox #lists .memitem').css({'background-color':'#ffffff'});
			$('.meminput #memslist #listbox #lists .memitem').prop('id','');
			$(this).css({'background-color':'#5A748B'});
			$(this).prop('id','focus');
			$('.meminput #memslist #fun #check').prop('disabled',false);
		}
	});
	$('.meminput #memslist #fun').on('click','#change',function(event){
		//oneEvent(event);
		if($(window).width()==1920){
			var preitem=7;//???尚未確認
		}
		else if($(window).width()==1366){
			var preitem=8;
		}
		else if($(window).width()==1280){
			var preitem=9;
		}
		else if($(window).width()<=1280&&$(window).width()>1024){
			var preitem=9;
		}
		else{// if($(window).width()==1024)
			var preitem=10;
		}
		if(parseInt($('.meminput #memslist #listbox input[name="allitems"]').val())%preitem>0){
			var maxpage=parseInt((parseInt($('.meminput #memslist #listbox input[name="allitems"]').val())/preitem)+1);
		}
		else{
			var maxpage=parseInt((parseInt($('.meminput #memslist #listbox input[name="allitems"]').val())/preitem));
		}
		if((parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1)>=maxpage){
			$('.meminput #memslist #listbox input[name="page"]').val('0');
		}
		else{
			$('.meminput #memslist #listbox input[name="page"]').val(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1);
		}
		$('.meminput #memslist #listbox #lists').html('');
		if(parseInt($('.meminput #memslist #listbox input[name="allitems"]').val())>preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1)){
			var maxitem=preitem*(parseInt($('.meminput #memslist #listbox input[name="page"]').val())+1);
		}
		else{
			var maxitem=parseInt($('.meminput #memslist #listbox input[name="allitems"]').val());
		}
		for(var i=(parseInt($('.meminput #memslist #listbox input[name="page"]').val())*preitem);i<maxitem;i++){
			var d=$('.meminput #memslist #listbox #allresult input:eq('+i+')').val().split(',');
			if(d[0]=='null'){
				d[0]='';
			}
			else{
			}
			if(d[1]=='null'){
				d[1]='';
			}
			else{
			}
			if(d[2]=='null'){
				d[2]='';
			}
			else{
			}
			if(d[3]=='null'){
				d[3]='';
			}
			else{
			}
			if(d[4]=='null'){
				d[4]='';
			}
			else{
			}

			$('.meminput #memslist #listbox #lists').append('<div class="memitem" style="width:calc(100% - 10px);margin:10px 5px 0 5px;padding-bottom:5px;border-bottom:1px solid #898989;float:left;"><input type="hidden" name="memno" value="'+d[0]+'"><input type="hidden" name="address" value="'+d[4]+'"><input type="hidden" name="tel2" value="'+d[2]+'"><input type="hidden" name="point" value="'+d[6]+'"><input type="hidden" name="money" value="'+d[7]+'"><input type="hidden" name="powername" value="'+d[8]+'"><div style="width:calc(100% / 3);float:left;">'+d[1]+'</div><div style="width:calc(100% / 3);float:left;">'+d[3]+'</div><div style="width:calc(100% / 3);float:left;">'+d[5]+'</div></div>');
		}
	});
	$('.meminput #memslist #fun').on('click','#check',function(event){
		//oneEvent(event);
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val($('.meminput #memslist #listbox #lists .memitem#focus input[name="memno"]').val());
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').val($('.meminput #memslist #listbox #lists .memitem#focus div:eq(0)').html());
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val('1');
		$('.order#order #tabs1 #membutton div:eq(0)').html($('.meminput #memslist #listbox #lists .memitem#focus div:eq(1)').html()+'('+$('.meminput #memslist #listbox #lists .memitem#focus input[name="powername"]').val()+')');
		$('.order#order #tabs1 #membutton div:eq(1)').html($('.meminput #memslist #listbox #lists .memitem#focus div:eq(0)').html());
		$('.order#order #tabs1 #membutton div:eq(2)').html($('.meminput #memslist #listbox #lists .memitem#focus input[name="remark"]').val());
		$('.memdata #name').html($('.meminput #memslist #listbox #lists .memitem#focus div:eq(1)').html()+'('+$('.meminput #memslist #listbox #lists .memitem#focus input[name="powername"]').val()+')');
		$('.memdata #tel').html($('.meminput #memslist #listbox #lists .memitem#focus div:eq(0)').html());
		$('.memdata #memremark').html($('.meminput #memslist #listbox #lists .memitem#focus input[name="remark"]').val());
		if($('.meminput #memslist #listbox #lists .memitem#focus div:eq(2)').length==0||$('.meminput #memslist #listbox #lists .memitem#focus div:eq(2)').html()==''){
			$('.memdata #setting').html('');
		}
		else{
			$('.memdata #setting').html($('.meminput #memslist #listbox #lists .memitem#focus div:eq(2)').html());
		}
		if($('.meminput #memslist #listbox #lists .memitem#focus input[name="address"]').val()==null){
			$('.memdata #address').html('');
		}
		else{
			//$('.memdata #address').html($('.meminput #memslist #listbox #lists .memitem#focus input[name="address"]').val());
			if($('.meminput #memslist #listbox #lists .memitem#focus input[name="address"]').val().match(/;*;/g)){
				var addlist=$('.meminput #memslist #listbox #lists .memitem#focus input[name="address"]').val().split(';*;');
				var addselect='<select id="addselect" style="width:100%;padding:5px;">';
				for(var i=0;i<addlist.length;i++){
					addselect += '<option value="'+(parseInt(i)+1)+'" ';
					if(i!=0){
					}
					else{
						addselect += 'selected';
					}
					addselect += '>'+addlist[i]+'</option>';
				}
				addselect += '</select>';
				$('.memdata #address').html(addselect);
			}
			else{
				var addselect='<select><option value="1" selected>'+$('.meminput #memslist #listbox #lists .memitem#focus input[name="address"]').val()+'</option></select>';
				$('.memdata #address').html(addselect);
			}
		}
		if($('.meminput #memslist #listbox #lists .memitem#focus input[name="tel2"]').val()==null){
			$('.memdata #tel2').html('');
		}
		else{
			$('.memdata #tel2').html($('.meminput #memslist #listbox #lists .memitem#focus input[name="tel2"]').val());
		}
		if($('.meminput #memslist #listbox #lists .memitem#focus input[name="point"]').val()==null){
			$('.memdata #point').html('0');
			$('.order#order #tabs1 #membutton #memberpoint').val('0');
		}
		else{
			$('.memdata #point').html($('.meminput #memslist #listbox #lists .memitem#focus input[name="point"]').val());
			$('.order#order #tabs1 #membutton #memberpoint').val($('.meminput #memslist #listbox #lists .memitem#focus input[name="point"]').val());
		}
		if($('.meminput #memslist #listbox #lists .memitem#focus input[name="money"]').val()==null){
			$('.memdata #money').html('0');
			$('.order#order #tabs1 #membutton #membermoney').val('0');
		}
		else{
			$('.memdata #money').html($('.meminput #memslist #listbox #lists .memitem#focus input[name="money"]').val());
			$('.order#order #tabs1 #membutton #membermoney').val($('.meminput #memslist #listbox #lists .memitem#focus input[name="money"]').val());
		}
		if($('.meminput #memslist #listbox #lists .memitem#focus input[name="companynumber"]').val()==null){
			$('.memdata #companynumber').html('');
			$('.order#order #tabs1 #membutton #companynumber').val('');
		}
		else{
			$('.memdata #companynumber').html($('.meminput #memslist #listbox #lists .memitem#focus input[name="companynumber"]').val());
			$('.order#order #tabs1 #membutton #companynumber').val($('.meminput #memslist #listbox #lists .memitem#focus input[name="companynumber"]').val());
		}

		meminput.dialog('close');
		$('.meminput #memtel').html('');
		$('.meminput #memslist #listbox #lists').html('');
		$('.meminput #memslist #listbox input[name="allitems"]').val('');
		$('.meminput #memslist #listbox input[name="page"]').val('');
		$('.meminput #memslist #listbox #allresult').html('');
		$('.meminput #memslist #fun #change').prop('disabled',true);
		$('.meminput #memslist #fun #check').prop('disabled',true);
		if($('.initsetting #yunlincoinsopen').val()=='1'){//2022/9/27 串接yunlincoins
			$.ajax({
				url:'./lib/api/yunlincoins/GetToken.php',
				method:'post',
				async:false,
				dataType:'json',
				success:function(d){
					//console.log(d);
					d=JSON.parse(d);
					if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
						$('.yunlincoins input[name="yunlintoken"]').val(d['value']['access_token']);
						$.ajax({
							url:'./lib/api/yunlincoins/CheckPhone.php',
							method:'post',
							async:false,
							data:{'account':$('.memdata #tel').html(),'token':d['value']['access_token']},
							dataType:'json',
							success:function(d){
								//console.log(d);
								//d=JSON.parse(d);
								if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
									if(parseInt(d['value']['balance'])>0){//尚有餘額，顯示yunlincoins icon
										$('.yunlincoinsico').css({'display':'block'});
									}
									else{
										$('.yunlincoinsico').css({'display':'none'});
									}
								}
								else if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==false){
									$.ajax({
										url:'./lib/api/yunlincoins/GetToken.php',
										method:'post',
										async:false,
										dataType:'json',
										success:function(d){
											//console.log(d);
											d=JSON.parse(d);
											if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
												$('.yunlincoins input[name="yunlintoken"]').val(d['value']['access_token']);
												$.ajax({
													url:'./lib/api/yunlincoins/CheckPhone.php',
													method:'post',
													async:false,
													data:{'account':$('.memdata #tel').html(),'token':d['value']['access_token']},
													dataType:'json',
													success:function(d){
														//console.log(d);
														//d=JSON.parse(d);
														if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
															if(parseInt(d['value']['balance'])>0){//尚有餘額，顯示yunlincoins icon
																$('.yunlincoinsico').css({'display':'block'});
															}
															else{
																$('.yunlincoinsico').css({'display':'none'});
															}
														}
														else{
															$('.yunlincoinsico').css({'display':'none'});
														}
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
											else{
												//console.log('get token fail.');
											}
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
									$('.yunlincoinsico').css({'display':'none'});
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						//console.log('get token fail.');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
		}
	});
	$('.meminput #memslist #fun').on('click','#return',function(event){
		//oneEvent(event);
		meminput.dialog('close');
		$('.meminput #memtel').html('');
		$('.meminput #memslist #listbox #lists').html('');
		$('.meminput #memslist #listbox input[name="allitems"]').val('');
		$('.meminput #memslist #listbox input[name="page"]').val('');
		$('.meminput #memslist #listbox #allresult').html('');
		$('.meminput #memslist #fun #change').prop('disabled',true);
		$('.meminput #memslist #fun #check').prop('disabled',true);
	});
	$('.memdata').on('click','#close',function(event){
		//oneEvent(event);
		memdata.dialog('close');
	});
	$('.memdata').on('click','#clear',function(event){//清除會員
		//oneEvent(event);
		memdata.dialog('close');
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val('');
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').val('');
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val('');
		$.ajax({
			url:'./lib/js/getbuttonname.ajax.php',
			method:'post',
			async:false,
			data:{'name':'member'},
			dataType:'json',
			success:function(d){
				//console.log(d);
				$('.order#order #tabs1 #membutton div:eq(1)').html('');
				$('.order#order #tabs1 #membutton div:eq(2)').html('');
				$('.order#order #tabs1 #membutton div:eq(0)').html('<div id="name1">'+d[0]+'</div>');
				$('.order#order #tabs1 #membutton #memberpoint').val('0');
				$('.order#order #tabs1 #membutton #membermoney').val('0');
				$('.order#order #tabs1 #membutton #companynumber').val('');
				$('.yunlincoinsico').css({'display':'none'});//2022/9/27 隱藏yunlincoins icon
			},
			error:function(e){
				//console.log(e);
			}
		});

		returnitemdisall();//2020/4/20 針對該單上所有已點品項，還原單品促銷
	});
	/*$('.memdata').on('click','#edit',function(){//2020/8/14 修改資料//2020/8/21 修改為交易密碼
		memdata.dialog('close');
		editmem.dialog('open');
	});
	$('.editmem #close').click(function(){
		editmem.dialog('close');
		$('.order#order #MemberBill #member #membutton').trigger('click');
	});*/
	$('.memdata').on('click','#editpaypw',function(){//2020/8/21
		$.ajax({
			url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmember.paypw.ajax.php',
			method:'post',
			async:false,
			data:{'company':$('.order#order .companydata #company').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val()},
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmember.paypw.ajax.php(online success) '+JSON.stringify(d)},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
				if(d[0]['paypw']==null){
					$('.editpaypw input[name="initpw"]').prop('disabled',true);
					$('.editpaypw input[name="initpw"]').val('');
					$('.editpaypw #initpw').css({'visibility':'hidden'});
					$('.editpaypw input[name="newpw1"]').val('');
					$('.editpaypw input[name="newpw2"]').val('');
				}
				else{
					$('.editpaypw input[name="initpw"]').prop('disabled',false);
					$('.editpaypw input[name="initpw"]').val('');
					$('.editpaypw #initpw').css({'visibility':'visible'});
					$('.editpaypw input[name="newpw1"]').val('');
					$('.editpaypw input[name="newpw2"]').val('');
				}
				memdata.dialog('close');
				editpaypw.dialog('open');
			},
			error:function(e){
				//console.log(e);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmember.paypw.ajax.php(online error) '+e},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
			}
		});
	});
	$('.editpaypw #save').click(function(){//2020/8/25 送出修改密碼
		if($('.editpaypw input[name="initpw"]').prop('disabled')){//該會員沒有設定交易密碼
			var initpw='disabled';
		}
		else{
			var initpw=$('.editpaypw input[name="initpw"]').val();
		}

		if(initpw!=''&&$('.editpaypw input[name="newpw1"]').val()!=''&&$('.editpaypw input[name="newpw2"]').val()!=''){
			if($('.editpaypw input[name="newpw1"]').val()!=$('.editpaypw input[name="newpw2"]').val()){
				$('.alertmessage #text').html('新密碼輸入錯誤。');
				alertmessage.dialog('open');
				$('.editpaypw input[name="newpw1"]').val('');
				$('.editpaypw input[name="newpw2"]').val('');
			}
			else{
				$.ajax({
					url:'http://api.tableplus.com.tw/outposandorder/memberapi/editmember.paypw.ajax.php',
					method:'post',
					async:false,
					data:{'company':$('.order#order .companydata #company').val(),'memno':$('.order#order #content #list #tabs4 .listcontentbox input[name="memno"]').val(),'initpw':initpw,'newpw':$('.editpaypw input[name="newpw1"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/editmember.paypw.ajax.php(online success) '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
						if(d=='pass'){
							editpaypw.dialog('close');
							$('.alertmessage #text').html('會員交易密碼修改成功。');
							alertmessage.dialog('open');
						}
						else{
							$('.alertmessage #text').html('原始密碼輸入錯誤。');
							alertmessage.dialog('open');
							$('.editpaypw input[name="initpw"]').val('');
						}
					},
					error:function(e){
						//console.log(e);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/editmember.paypw.ajax.php(online error) '+e},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
				});
			}
		}
		else{
			$('.alertmessage #text').html('請填寫完整表格。');
			alertmessage.dialog('open');
		}
	});
	$('.editpaypw #close').click(function(){
		editpaypw.dialog('close');
	});
	$('.memdata').on('click','#change',function(event){
		//oneEvent(event);
		memdata.dialog('close');
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memno"]').val('');
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memtel"]').val('');
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val('');
		$.ajax({
			url:'./lib/js/getbuttonname.ajax.php',
			method:'post',
			async:false,
			data:{'name':'member'},
			dataType:'json',
			success:function(d){
				//console.log(d);
				$('.order#order #tabs1 #membutton div:eq(0)').html(d[0]);
			},
			error:function(e){
				//console.log(e);
				$('.order#order #tabs1 #membutton div:eq(0)').html('會員');
			}
		});
		$('.order#order #tabs1 #membutton div:eq(1)').html('');
		$('.order#order #tabs1 #membutton div:eq(2)').html('');
		$('.order#order #tabs1 #membutton #memberpoint').val('0');
		$('.order#order #tabs1 #membutton #membermoney').val('0');
		$('.order#order #tabs1 #membutton #companynumber').val('');
		meminput.dialog('open');

		returnitemdisall();//2020/4/20 針對該單上所有已點品項，還原單品促銷
		$('.yunlincoinsico').css({'display':'none'});//2022/9/27 隱藏yunlincoins icon
	});
	$('.memdata').on('change','#addselect',function(){
		$('.order#order #tabs4 .listcontentbox form[data-id="listform"] input[name="memaddno"]').val($('.memdata #address #addselect option:selected').val());
	});
	$('.memdata #getmembermoney').click(function(){
		memdata.dialog('close');
		$('.paymembermoney .remainingmoney').val($('.memdata #money').html());
		$('.paymembermoney .paymoney').val('');
		$('.paymembermoney .getmemmoney').val('0');
		$('.paymembermoney .precompute').val($('.memdata #money').html());
		paymembermoney.dialog('open');
	});
	$('.paymembermoney .num').click(function(){
		$('.paymembermoney .paymoney').val($('.paymembermoney .paymoney').val()+$(this).html());
		$('.paymembermoney .paymoney').trigger('change');
	});
	$('.paymembermoney #reset').click(function(){
		$('.paymembermoney .paymoney').val('');
		$('.paymembermoney .paymoney').trigger('change');
	});
	$('.paymembermoney #back').click(function(){
		if($('.paymembermoney .paymoney').val().length>0){
			$('.paymembermoney .paymoney').val($('.paymembermoney .paymoney').val().substr(0,$('.paymembermoney .paymoney').val().length-1));
			$('.paymembermoney .paymoney').trigger('change');
		}
		else{
			//$('.paymembermoney .paymoney').val($('.paymembermoney .paymoney').val()+$(this).html());
		}
	});
	$('.paymembermoney .paymoney').change(function(){
		//console.log($('.paymembermoney .paymoney').val());
		$.ajax({
			url:'./lib/js/getmemmoney.ajax.php',
			method:'post',
			async:false,
			data:{'remaining':$('.paymembermoney .remainingmoney').val(),'money':$('.paymembermoney .paymoney').val()},
			dataType:'json',
			success:function(d){
				//console.log(d);
				if(typeof d['memmoney']!=='undefined'){
					$('.paymembermoney .getmemmoney').val(d['memmoney']);
				}
				else{
				}
				if(typeof d['precompute']!=='undefined'){
					$('.paymembermoney .precompute').val(d['precompute']);
				}
				else{
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.paymembermoney #cancel').click(function(){
		paymembermoney.dialog('close');
	});
	$('.paymembermoney #send').click(function(){
		if($('.paymembermoney .paymoney').val().length>0&&Number($('.paymembermoney .paymoney').val())>0){
			$.ajax({
				url:'./lib/js/checkopen.ajax.php',
				method:'post',
				async:false,
				data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'paymembermoney send checkopen.ajax.php '+d},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					//console.log(d);
					if(d=='success'){
						$.ajax({//寫入sales中，給交班表查詢使用
							url:'./lib/js/insert.paymoney.php',
							method:'post',
							async:false,
							data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':$('.paymembermoney .paymoney').val(),'getmemmoney':$('.paymembermoney .getmemmoney').val()},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(typeof d['bizdate']!=='undefined'&&typeof d['zcounter']!=='undefined'&&typeof d['timepoint']!=='undefined'&&typeof d['settime']!=='undefined'){
									$.ajax({//寫入tableplus資料庫
										url:'http://api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php',
										method:'post',
										async:false,
										data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':$('.paymembermoney .paymoney').val(),'getmemmoney':$('.paymembermoney .getmemmoney').val(),'bizdate':d['bizdate'],'settime':d['settime']},
										dataType:'json',
										success:function(d){
											//console.log(d);
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php(online success) '+JSON.stringify(d)},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
											$('.memdata #money').html(d[0]['money']);
											//console.log($('.memdata #money').html());
											$('.order#order #content #member #membutton #membermoney').val($('.paymembermoney .precompute').val());
											paymembermoney.dialog('close');
										},
										error:function(e){
											//console.log(e);
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php(online error) '+e},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
									});
								}
								else{
								}
								$.ajax({
									url:'./lib/js/membermoney.ticket.php',
									method:'post',
									async:false,
									data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':$('.paymembermoney .paymoney').val()},
									dataType:'json',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
						$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
		}
	});
	$('.memdata #membermoneylist').click(function(){
		memdata.dialog('close');
		$('.membermoneylist #moneylist').html('');
		$('.membermoneylist #delete').prop('disabled',true);
		$.ajax({
			url:'http://api.tableplus.com.tw/outposandorder/memberapi/getmemmoneylist.ajax.php',
			method:'post',
			async:false,
			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('.order#order #content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'bizdate':$('.order#order #content #listtabbox #tabs4 form[data-id="listform"] input[name="bizdate"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemmoneylist.ajax.php(online success) '+d},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
				$('.membermoneylist #moneylist').append(d);
			},
			error:function(e){
				//console.log(e);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getmemmoneylist.ajax.php(online error) '+e},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
			}
		});
		$.ajax({
			url:'http://api.tableplus.com.tw/outposandorder/memberapi/getsubtotal.ajax.php',
			method:'post',
			async:false,
			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('.order#order #content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'bizdate':$('.order#order #content #listtabbox #tabs4 form[data-id="listform"] input[name="bizdate"]').val()},
			dataType:'json',
			success:function(d){
				//console.log(d);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getsubtotal.ajax.php(online success) '+JSON.stringify(d)},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
				//console.log(d[0]['totaltime']);
				//console.log(d[0]['totalmoney']);
				$('.membermoneylist #paper #totaltime').html(d[0]['totaltime']);
				$('.membermoneylist #paper #totalmoney').html(d[0]['totalmoney']);
			},
			error:function(e){
				//console.log(e);
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/getsubtotal.ajax.php(online error) '+e},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
			}
		});
		membermoneylist.dialog('open');
	});
	$('.membermoneylist #moneylist').on('click','.moneylist',function(){
		$('.membermoneylist #moneylist .moneylist').prop('id','');
		$(this).prop('id','focus');
		if($(this).find('input[name="state"]').val()=='1'){
			$('.membermoneylist #delete').prop('disabled',false);
		}
		else{
			$('.membermoneylist #delete').prop('disabled',true);
		}
	});
	$('.membermoneylist #delete').click(function(){
		$.ajax({
			url:'./lib/js/checkopen.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'membermoneylist delete checkopen.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				//console.log(d);
				if(d=='success'){
					if(Number($('.memdata #money').html())>=Number($('.membermoneylist #moneylist .moneylist#focus input[name="membermoney"]').val())){
						$('.checkdeletemommoney #text').html('退款金額：'+$('.membermoneylist #moneylist .moneylist#focus input[name="money"]').val()+'<br>作廢儲值金：'+$('.membermoneylist #moneylist .moneylist#focus input[name="membermoney"]').val());
						checkdeletemommoney.dialog('open');
					}
					else{
						//alertmessage('剩餘點數不足。');
						$('.alertmessage #text').html('剩餘點數不足。');
						alertmessage.dialog('open');
					}
				}
				else{
					//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
					$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
					alertmessage.dialog('open');
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.checkdeletemommoney .yes').click(function(){
		$.ajax({
			url:'./lib/js/insert.paymoney.php',
			method:'post',
			async:false,
			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':(0-$('.membermoneylist #moneylist .moneylist#focus input[name="money"]').val()),'getmemmoney':(0-$('.membermoneylist #moneylist .moneylist#focus input[name="membermoney"]').val()),'deletetime':$('.membermoneylist #moneylist .moneylist#focus input[name="datetime"]').val()},
			dataType:'json',
			success:function(d){
				//console.log(d);
				if(typeof d['bizdate']!=='undefined'&&typeof d['zcounter']!=='undefined'&&typeof d['timepoint']!=='undefined'&&typeof d['settime']!=='undefined'){
					$.ajax({//寫入tableplus資料庫
						url:'http://api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php',
						method:'post',
						async:false,
						data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':(0-$('.membermoneylist #moneylist .moneylist#focus input[name="money"]').val()),'getmemmoney':(0-$('.membermoneylist #moneylist .moneylist#focus input[name="membermoney"]').val()),'bizdate':d['bizdate'],'settime':d['settime'],'deletetime':$('.membermoneylist #moneylist .moneylist#focus input[name="datetime"]').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php(online success) '+JSON.stringify(d)},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
							$('.memdata #money').html(d[0]['money']);
							//console.log($('.memdata #money').html());
							//paymembermoney.dialog('close');
							membermoneylist.dialog('close');
							$('.memdata #membermoneylist').trigger('click');
						},
						error:function(e){
							//console.log(e);
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php(online error) '+e},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
					});
				}
				else{
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
		$('.checkdeletemommoney #text').html('');
		checkdeletemommoney.dialog('close');
	});
	$('.checkdeletemommoney .no').click(function(){
		$('.checkdeletemommoney #text').html('');
		checkdeletemommoney.dialog('close');
	});
	$('.membermoneylist #cancel').click(function(){
		$('.membermoneylist #moneylist').html('');
		membermoneylist.dialog('close');
	});
	$('#reason').on('click','button',function(event){//刪除已出單產品之原因選項按鈕
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('刪除品項選擇刪除原因',$(this).val());
		//oneEvent(event);
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		$('#reason button').prop('disabled',true);
		if($(this).val()=='other'){
			reasoninput.dialog('open');
		}
		/*else if($(this).val()=='splitlist'){//2022/12/1 拆單(依品項為單位；僅限暫結後的帳單使用)

		}*/
		else{
			var tabs=changetagtarget();
			var reasonval=$(this).val();
			if($('.order#order #'+tabs+' form[data-id="listform"] .label.check').length>0){
				var deltarget='check';
			}
			else{
				var deltarget='focus';
			}
			if(deltarget=='check'){
				var minticket=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.check'));
				var ticketlength=parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label').length)-1;
				while($('.order#order #'+tabs+' form[data-id="listform"] .label.check').length>0){
					var i=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.check'));
					if(tabs=='tabs5'&&i==0){
						/*不會發生*/
						/*var r=confirm("您確認要取消套餐嗎？");
						if(r==true){
							$('.order#order #'+tabs+' form[data-id="listform"] .listcontent').html('');
						}
						else{
							$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked',false);
						}*/
					}
					else{
						//$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
						//$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
						//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
						//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

						$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
						$('.setperson #buttons #submit').trigger('click');
						if($('.order#order .initsetting #secview').val()=='1'){
							$.ajax({
								url:'../secview/voiditem.ajax.php',
								method:'post',
								async: false,
								data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reason voiditem.ajax.php '+d},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									//console.log(d);
									//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
								socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
								console.log('send message "listitemupdate" to secview');
							}
							else{
							}
						}
						else{
						}
						if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
							$.ajax({
								url:'./lib/js/voiditem.ajax.php',
								method:'post',
								async: false,
								data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'reason':reasonval},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reason voiditem.ajax.php '+d},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									//console.log(d);
									$('.order#order #tabs1 #tempbox input[name="target"]').val('');
									$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
									$('.order#order #tabs1 #tempbox input[name="type"]').val('');
									$('.order#order #tabs1 #tempbox input[name="no"]').val('');
									$('.order#order #tabs1 #tempbox input[name="name"]').val('');
									$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
									$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
									$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
									$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
									$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
									$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
									$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
									$('.order#order #tabs1 #tempbox input[name="money"]').val('');
									$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
									$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
									$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
									$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
									$('.order#order #tabs1 #tempbox input[name="number"]').val('');
									$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
									$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
									$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
									$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
									$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
									$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
									$('.order#order #tabs1 #editview').val('');
									$('.order#order .parameters #typeno').val('');
									$('.order#order .parameters #type').val('');
									$('.order#order .parameters #no').val('');
									$('.order#order .parameters #name').val('');
									$('.order#order .parameters #msize').val('');
									$('.order#order .parameters input[id^="mname"]').val('');
									$('.order#order .parameters input[id^="money"]').val('');
									$('.order#order .parameters #taste1').val('');
									$('.order#order .parameters #taste1name').val('');
									$('.order#order .parameters #taste1money').val('');
									$('.order#order #menubox #itemfun .startchangetaste').val('0');
									$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
							$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
						}
					}
				}
				if($('.order#order #'+tabs+' form[data-id="listform"] .label').length>0){
					if(minticket==0){
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq(0)').trigger('click');
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(parseInt(minticket)-1)+')').trigger('click');
					}
				}
				else{
				}
			}
			else{
				var minticket=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.focus'));
				//console.log(minticket);
				var ticketlength=parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label').length)-1;
				//console.log(ticketlength);
				while($('.order#order #'+tabs+' form[data-id="listform"] .label.focus').length>0){
					var i=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.focus'));
					if(tabs=='tabs5'&&i==0){
						/*不會發生*/
						/*var r=confirm("您確認要取消套餐嗎？");
						if(r==true){
							$('.order#order #'+tabs+' form[data-id="listform"] .listcontent').html('');
						}
						else{
							$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked',false);
						}*/
					}
					else{
						//$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
						//$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
						//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
						//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

						$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
						$('.setperson #buttons #submit').trigger('click');
						if($('.order#order .initsetting #secview').val()=='1'){
							$.ajax({
								url:'../secview/voiditem.ajax.php',
								method:'post',
								async: false,
								data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machinename':$('.order#order .companydata #terminalnumber').val()},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reason voiditem.ajax.php '+d},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									//console.log(d);
									//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
								socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
								console.log('send message "listitemupdate" to secview');
							}
							else{
							}
						}
						else{
						}
						if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
							$.ajax({
								url:'./lib/js/voiditem.ajax.php',
								method:'post',
								async: false,
								data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'reason':reasonval},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reason voiditem.ajax.php '+d},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
									}
									//console.log(d);
									$('.order#order #tabs1 #tempbox input[name="target"]').val('');
									$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
									$('.order#order #tabs1 #tempbox input[name="type"]').val('');
									$('.order#order #tabs1 #tempbox input[name="no"]').val('');
									$('.order#order #tabs1 #tempbox input[name="name"]').val('');
									$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
									$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
									$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
									$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
									$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
									$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
									$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
									$('.order#order #tabs1 #tempbox input[name="money"]').val('');
									$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
									$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
									$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
									$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
									$('.order#order #tabs1 #tempbox input[name="number"]').val('');
									$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
									$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
									$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
									$('.order#order #tabs1 #tempbox input[name="itemdis"]').val('');
									$('.order#order #tabs1 #tempbox input[name="listdis"]').val('');
									$('.order#order #tabs1 #tempbox input[name="bothdis"]').val('');
									$('.order#order #tabs1 #tempbox input[name="usemempoint"]').val('');
									$('.order#order #tabs1 #tempbox input[name="getpointtype"]').val('');
									$('.order#order #tabs1 #tempbox input[name="initgetpoint"]').val('');
									$('.order#order #tabs1 #tempbox input[name="getpoint"]').val('');
									$('.order#order #tabs1 #editview').val('');
									$('.order#order .parameters #typeno').val('');
									$('.order#order .parameters #type').val('');
									$('.order#order .parameters #no').val('');
									$('.order#order .parameters #name').val('');
									$('.order#order .parameters #msize').val('');
									$('.order#order .parameters input[id^="mname"]').val('');
									$('.order#order .parameters input[id^="money"]').val('');
									$('.order#order .parameters #taste1').val('');
									$('.order#order .parameters #taste1name').val('');
									$('.order#order .parameters #taste1money').val('');
									$('.order#order #menubox #itemfun .startchangetaste').val('0');
									$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
									$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
							$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
						}
					}
				}
				if($('.order#order #'+tabs+' form[data-id="listform"] .label').length>0){
					if(minticket==0){
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq(0)').trigger('click');
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(parseInt(minticket)-1)+')').trigger('click');
					}
				}
				else{
				}
			}
			/*for(var i=($('.order#order #'+tabs+' form[data-id="listform"] .label').length-1);i>=0;i--){
				if(tabs=='tabs5'&&i==0&&$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked')){
					var r=confirm("您確認要取消套餐嗎？");
					if(r==true){
						$('.order#order #'+tabs+' form[data-id="listform"] .listcontent').html('');
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked',false);
					}
				}
				else if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked')){
					//$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
					//$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
					/$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
					//$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

					$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
					$('.setperson #buttons #submit').trigger('click');
					if($('.order#order .initsetting #secview').val()=='1'){
						$.ajax({
							url:'../secview/voiditem.ajax.php',
							method:'post',
							async: false,
							data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val()},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reason voiditem.ajax.php '+d},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
								//$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
						$.ajax({
							url:'./lib/js/voiditem.ajax.php',
							method:'post',
							async: false,
							data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'reason':reasonval},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reason voiditem.ajax.php '+d},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
								$('.order#order #tabs1 #tempbox input[name="target"]').val('');
								$('.order#order #tabs1 #tempbox input[name="typeno"]').val('');
								$('.order#order #tabs1 #tempbox input[name="type"]').val('');
								$('.order#order #tabs1 #tempbox input[name="no"]').val('');
								$('.order#order #tabs1 #tempbox input[name="name"]').val('');
								$('.order#order #tabs1 #tempbox input[name="name2"]').val('');
								$('.order#order #tabs1 #tempbox input[name="isgroup"]').val('0');
								$('.order#order #tabs1 #tempbox input[name="childtype"]').val('');
								$('.order#order #tabs1 #tempbox input[name="mname1"]').val('');
								$('.order#order #tabs1 #tempbox input[name="mname2"]').val('');
								$('.order#order #tabs1 #tempbox input[name="insaleinv"]').val('');
								$('.order#order #tabs1 #tempbox input[name="unitprice"]').val('');
								$('.order#order #tabs1 #tempbox input[name="money"]').val('');
								$('.order#order #tabs1 #tempbox input[name="discount"]').val('0');
								$('.order#order #tabs1 #tempbox input[name="discontent"]').val('');
								$('.order#order #tabs1 #tempbox input[name="dispoint"]').val('0');//2020/4/14 單品優惠使用點數
								$('.order#order #tabs1 #tempbox input[name="dispointtime"]').val('0');//2020/4/14 單品優惠使用在幾項產品上
								$('.order#order #tabs1 #tempbox input[name="number"]').val('');
								$('.order#order #tabs1 #tempbox input[name="subtotal"]').val('');
								$('.order#order #tabs1 #tempbox input[name="taste1"]').val('');
								$('.order#order #tabs1 #tempbox input[name="taste1name"]').val('');
								$('.order#order #tabs1 #tempbox input[name="taste2name"]').val('');
								$('.order#order #tabs1 #tempbox input[name="taste1price"]').val('');
								$('.order#order #tabs1 #tempbox input[name="taste1number"]').val('');
								$('.order#order #tabs1 #tempbox input[name="taste1money"]').val('0');
								$('.order#order #tabs1 #tempbox input[name="taste2"]').val('');
								$('.order#order #tabs1 #editview').val('');
								$('.order#order .parameters #typeno').val('');
								$('.order#order .parameters #type').val('');
								$('.order#order .parameters #no').val('');
								$('.order#order .parameters #name').val('');
								$('.order#order .parameters #msize').val('');
								$('.order#order .parameters input[id^="mname"]').val('');
								$('.order#order .parameters input[id^="money"]').val('');
								$('.order#order .parameters #taste1').val('');
								$('.order#order .parameters #taste1name').val('');
								$('.order#order .parameters #taste1money').val('');
								$('.order#order #menubox #itemfun .startchangetaste').val('0');
								$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
								$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
					}
				}
				else{
				}
			}*/
			$('.order#order #banner #detail #viewtotal').val('0');
			$('.order#order #banner #detail #viewnumber').val('0');
			for(var i=($('.order#order #'+tabs+' form[data-id="listform"] .label').length-1);i>=0;i--){
				$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
				$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())+Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));	
			}
			if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
				$('.order#order #banner #detail #viewtotal').val( roundfun($('.order#order #banner #detail #viewtotal').val(),precision));
				$('.order#order #banner #detail #viewnumber').val( roundfun($('.order#order #banner #detail #viewnumber').val(),precision));
			}
			else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
				$('.order#order #banner #detail #viewtotal').val( ceilfun($('.order#order #banner #detail #viewtotal').val(),precision));
				$('.order#order #banner #detail #viewnumber').val( ceilfun($('.order#order #banner #detail #viewnumber').val(),precision));
			}
			else{//無條件捨去
				$('.order#order #banner #detail #viewtotal').val( floorfun($('.order#order #banner #detail #viewtotal').val(),precision));
				$('.order#order #banner #detail #viewnumber').val( floorfun($('.order#order #banner #detail #viewnumber').val(),precision));
			}
			$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
			$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

			$('.order#order #numbox input[type="button"]:eq(14)').prop('disabled',true);
			$('.order#order #numbox input[type="button"]:eq(14)').css({'color':'#a8a8a8'});
			if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="templistitem[]"]').length!=$('.order#order #MemberBill #tabs4 form[data-id="listform"] .label').length){
			}
			else{
				if($('.order#order .initsetting #opentemp').val()==1&&$('.order#order .initsetting #controltable').val()==1){
					$.ajax({
						url:'./lib/js/change.button4.php',
						method:'post',
						data:{'type':'b'},
						dataType:'json',
						success:function(d){
							if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reason change.button4.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
								$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
							}
							else{
							}
							if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
								$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[0]);
							}
							else{
							}
							if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
								$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
							}
							else{
							}
							$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
			}
			$('#reason button').prop('disabled',false);
			reason.dialog('close');
		}
	});
	$('#reasoninput').on('click','#cancel',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('關閉手打刪除理由','click');
		//oneEvent(event);
		/*$('#reasoninput #cancel').prop('disabled',true);
		$('#reasoninput #send').prop('disabled',true);
		$('#reasoninput input[name="reason"]').prop('disabled',true);*/
		reasoninput.dialog('close');
		//$('#reason button').prop('disabled',false);
		/*$('#reasoninput #cancel').prop('disabled',false);
		$('#reasoninput #send').prop('disabled',false);
		$('#reasoninput input[name="reason"]').prop('disabled',false);
		$('#reasoninput input[name="reason"]').val('');*/
	});
	$('#reasoninput').on('click','#send',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('輸入手打刪除理由',$('#reasoninput input[name="reason"]').val());
		//oneEvent(event);
		$('#reasoninput #cancel').prop('disabled',true);
		$('#reasoninput #send').prop('disabled',true);
		$('#reasoninput input[name="reason"]').prop('disabled',true);
		var tabs=changetagtarget();
		var reasonval=$(this).val();
		if($('.order#order #'+tabs+' form[data-id="listform"] .label.check').length>0){
			var deltarget='check';
		}
		else{
			var deltarget='focus';
		}
		if(deltarget=='check'){
			var minticket=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.check'));
			var ticketlength=parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label').length)-1;
			while($('.order#order #'+tabs+' form[data-id="listform"] .label.check').length>0){
				var i=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.check'));
				if(tabs=='tabs5'&&i==0){
					/*不會發生*/
					/*var r=confirm("您確認要取消套餐嗎？");
					if(r==true){
						$('.order#order #'+tabs+' form[data-id="listform"] .listcontent').html('');
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked',false);
					}*/
				}
				else{
					$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
					$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						$('.order#order #banner #detail #viewtotal').val( roundfun($('.order#order #banner #detail #viewtotal').val(),precision));
						$('.order#order #banner #detail #viewnumber').val( roundfun($('.order#order #banner #detail #viewnumber').val(),precision));
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						$('.order#order #banner #detail #viewtotal').val( ceilfun($('.order#order #banner #detail #viewtotal').val(),precision));
						$('.order#order #banner #detail #viewnumber').val( ceilfun($('.order#order #banner #detail #viewnumber').val(),precision));
					}
					else{//無條件捨去
						$('.order#order #banner #detail #viewtotal').val( floorfun($('.order#order #banner #detail #viewtotal').val(),precision));
						$('.order#order #banner #detail #viewnumber').val( floorfun($('.order#order #banner #detail #viewnumber').val(),precision));
					}
					$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
					$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

					$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
					$('.setperson #buttons #submit').trigger('click');
					if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
						$.ajax({
							url:'./lib/js/voiditem.ajax.php',
							method:'post',
							async: false,
							data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'reason':$('#reasoninput input[name="reason"]').val()},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reasoninput voiditem.ajax.php '+d},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
								$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
					}
				}
			}
			if($('.order#order #'+tabs+' form[data-id="listform"] .label').length>0){
				if(minticket==0){
					$('.order#order #'+tabs+' form[data-id="listform"] .label:eq(0)').trigger('click');
				}
				else{
					$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(parseInt(minticket)-1)+')').trigger('click');
				}
			}
			else{
			}
		}
		else{
			var minticket=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.focus'));
			//console.log(minticket);
			var ticketlength=parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label').length)-1;
			//console.log(ticketlength);
			var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
			while($('.order#order #'+tabs+' form[data-id="listform"] .label.focus').length>0){
				var i=$('.order#order #'+tabs+' form[data-id="listform"] .label').index($('.order#order #'+tabs+' form[data-id="listform"] .label.focus'));
				if(tabs=='tabs5'&&i==0){
					/*不會發失*/
					/*var r=confirm("您確認要取消套餐嗎？");
					if(r==true){
						$('.order#order #'+tabs+' form[data-id="listform"] .listcontent').html('');
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked',false);
					}*/
				}
				else{
					$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
					$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						$('.order#order #banner #detail #viewtotal').val( roundfun($('.order#order #banner #detail #viewtotal').val(),precision));
						$('.order#order #banner #detail #viewnumber').val( roundfun($('.order#order #banner #detail #viewnumber').val(),precision));
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						$('.order#order #banner #detail #viewtotal').val( ceilfun($('.order#order #banner #detail #viewtotal').val(),precision));
						$('.order#order #banner #detail #viewnumber').val( ceilfun($('.order#order #banner #detail #viewnumber').val(),precision));
					}
					else{//無條件捨去
						$('.order#order #banner #detail #viewtotal').val( floorfun($('.order#order #banner #detail #viewtotal').val(),precision));
						$('.order#order #banner #detail #viewnumber').val( floorfun($('.order#order #banner #detail #viewnumber').val(),precision));
					}
					$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
					$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

					$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
					$('.setperson #buttons #submit').trigger('click');
					if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
						$.ajax({
							url:'./lib/js/voiditem.ajax.php',
							method:'post',
							async: false,
							data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'reason':$('#reasoninput input[name="reason"]').val()},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'reasoninput voiditem.ajax.php '+d},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
								$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
						$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
					}
				}
			}
			if($('.order#order #'+tabs+' form[data-id="listform"] .label').length>0){
				if(minticket==0){
					$('.order#order #'+tabs+' form[data-id="listform"] .label:eq(0)').trigger('click');
				}
				else{
					$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+(parseInt(minticket)-1)+')').trigger('click');
				}
			}
			else{
			}
		}
		/*for(var i=($('.order#order #'+tabs+' form[data-id="listform"] .label').length-1);i>=0;i--){
			if(tabs=='tabs5'&&i==0&&$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked')){
				var r=confirm("您確認要取消套餐嗎？");
				if(r==true){
					$('.order#order #'+tabs+' form[data-id="listform"] .listcontent').html('');
				}
				else{
					$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked',false);
				}
			}
			else if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[id="checkbox[]"]').prop('checked')){
				$('.order#order #banner #detail #viewtotal').val(Number($('.order#order #banner #detail #viewtotal').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="subtotal[]"]').val()));
				$('.order#order #banner #detail #viewnumber').val(Number($('.order#order #banner #detail #viewnumber').val())-Number($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
				$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="total"]').val($('.order#order #banner #detail #viewtotal').val());
				$('.order#order #MemberBill #list #tabs4 .listcontentbox input[name="totalnumber"]').val($('.order#order #banner #detail #viewnumber').val());

				$('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val(parseInt($('.setperson #view input[name="persons'+$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="personcount[]"]').val()+'"]').val())-parseInt($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="number[]"]').val()));
				$('.setperson #buttons #submit').trigger('click');
				if($('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+') input[name="templistitem[]"]').length>0){
					$.ajax({
						url:'./lib/js/voiditem.ajax.php',
						method:'post',
						async: false,
						data:{'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'linenumber':$('.order#order #tabs4 form[data-id="listform"] .label:eq('+i+') input[name="linenumber[]"]').val(),'reason':$('#reasoninput input[name="reason"]').val()},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'reasoninput voiditem.ajax.php '+d},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
							//console.log(d);
							$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					$('.order#order #'+tabs+' form[data-id="listform"] .label:eq('+i+')').remove();
				}
			}
			else{
			}
		}*/
		$('.order#order #numbox input[type="button"]:eq(14)').prop('disabled',true);
		$('.order#order #numbox input[type="button"]:eq(14)').css({'color':'#a8a8a8'});
		if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="templistitem[]"]').length!=$('.order#order #MemberBill #tabs4 form[data-id="listform"] .label').length){
		}
		else{
			if($('.order#order .initsetting #opentemp').val()==1&&$('.order#order .initsetting #controltable').val()==1){
				$.ajax({
					url:'./lib/js/change.button4.php',
					method:'post',
					data:{'type':'b'},
					dataType:'json',
					success:function(d){
						if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'reasoninput change.button4.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
							$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
						}
						else{
						}
						if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
							$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[0]);
						}
						else{
						}
						if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
							$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
						}
						else{
						}
						$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
			}
		}
		reasoninput.dialog('close');
		$('#reasoninput #cancel').prop('disabled',false);
		$('#reasoninput #send').prop('disabled',false);
		$('#reasoninput input[name="reason"]').prop('disabled',false);
		$('#reasoninput input[name="reason"]').val('');
		reason.dialog('close');
		$('#reason button').prop('disabled',false);
	});
	$('.result').on('click','.otherpay',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面選擇其他付款','click');
		//oneEvent(event);
		$('.paywindow input[name="target"]').val('result');
		paywindow.dialog('open');
	});
	$('.paywindow').on('click','button',function(event){//其他付款
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('選擇付款方式',$(this).find('input[name="name"]').val());
		if($(this).find('input[name="fromdb"]').val()!='member'){//2020/8/24 非會員儲值金、點數付款，不需要判斷會員交易密碼
			if($(this).find('input[name="directlinepay"]').val()=='1'&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/4/29 串接直接linepay付款
				$('.readlinecode #buttonhtml').html($(this).html());
				$('.readlinecode input[name="saverowname"]').val($(this).attr('class')+"-"+$(this).attr('id'));
				$('.readlinecode input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.readlinecode input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.readlinecode input[name="type"]').val($(this).find('input[name="type"]').val());
				//2022/5/4 金額的部分，因為流程上是在掃描條碼後才讀入，因此這邊不清空，且金額比例已固定1:1(因為linepay金額視為現金，不會有比例不同的狀況)
				$('.result .directlinepay').trigger('click');
				//$('.'+target+' input[name="view"]').val('');
				paywindow.dialog('close');
			}
			else if($(this).find('input[name="jkos"]').val()=='1'&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款
				$('.readjkoscode #buttonhtml').html($(this).html());
				$('.readjkoscode input[name="saverowname"]').val($(this).attr('class')+"-"+$(this).attr('id'));
				$('.readjkoscode input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.readjkoscode input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.readjkoscode input[name="type"]').val($(this).find('input[name="type"]').val());
				//2022/5/4 金額的部分，因為流程上是在掃描條碼後才讀入，因此這邊不清空，且金額比例已固定1:1(因為linepay金額視為現金，不會有比例不同的狀況)
				$('.result .jkos').trigger('click');
				//$('.'+target+' input[name="view"]').val('');
				paywindow.dialog('close');
			}
			else if($(this).find('input[name="pxpayplus"]').val()=='1'&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
				$('.readpxpaypluscode #buttonhtml').html($(this).html());
				$('.readpxpaypluscode input[name="saverowname"]').val($(this).attr('class')+"-"+$(this).attr('id'));
				$('.readpxpaypluscode input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.readpxpaypluscode input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.readpxpaypluscode input[name="type"]').val($(this).find('input[name="type"]').val());
				//2022/5/4 金額的部分，因為流程上是在掃描條碼後才讀入，因此這邊不清空，且金額比例已固定1:1(因為linepay金額視為現金，不會有比例不同的狀況)
				$('.result .pxpayplus').trigger('click');
				//$('.'+target+' input[name="view"]').val('');
				paywindow.dialog('close');
			}
			else{
				//oneEvent(event);
				var content='';
				var target='';
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
					target='result';
				}
				else{
					target='editpay';
				}
				/********/
				//新版其他付款計算邏輯
				//金額計算  總品項可使用金額(會員點數專用;未實作)、最大使用金額、剩餘可用金額、輸入金額在四者中取最小值
				/********/
				var itemsusenumber=9999999;
				//var limitnumber=9999999;
				var conditionlimitnumber=999999999;
				var remainingnumber=9999999;
				var enternumber=9999999;
				/*計算最大使用金額與剩餘可用金額*/
				if($(this).find('input[name="fromdb"]').val()=='member'){
					/*最大使用金額為不超過為主*/
					//console.log(Number($(this).find('input[name="pay"]').val()));
					//console.log(Number($(this).find('input[name="should"]').val()));
					if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){				
						if(target=='result'){
							if($('.result #paywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());
								var used=0;

								for(var i=0;i<$('.result #paywindow #paycontent .paywaybox').length;i++){
									if($('.result #paywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
						else{
							if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());
								var used=0;

								for(var i=0;i<$('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length;i++){
									if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
					}
					else{
					}
					/*if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){
						limitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
					}
					else{
					}*/
					if($(this).find('input[name="location"]').val()=='memberpoint'){//會員點數
						remainingnumber=Number($('.order#order #membutton #memberpoint').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="memberpoint"').length<=0){//當前沒有使用會員點數
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('memberpoint')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
						if($('.result .canusemempoint').length>0){
							if(Number($(this).find('input[name="price"]').val())<=0){
								//itemsusenumber=9999999;//總品項可使用數量
							}
							else{
								itemsusenumber=floorfun((Number($('.result .canusemempoint').val())/Number($(this).find('input[name="price"]').val())),precision);//總品項可使用數量
							}
						}
						else{
						}
					}
					else if($(this).find('input[name="location"]').val()=='membermoney'){//會員儲值金
						remainingnumber=Number($('.order#order #membutton #membermoney').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="membermoney"').length<=0){//當前沒有使用會員儲值金
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('membermoney')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
					}
					else{
					}
				}
				else if($(this).find('input[name="location"]').val()=='pointtree'){//集點樹
					remainingnumber=Number($('.result .pointtree #name2').html());
					if($('.'+target+' #paycontent .paywaybox span[id^="pointtree"]').length<=0){//當前沒有使用集點樹
					}
					else{
						for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
							if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('pointtree')){
								remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
							}
							else{
							}
						}
					}
				}
				else{
				}
				var viewtext=Math.abs($('.'+target+' input[name="view"]').val());//2020/8/3 防呆：負數金額
				/*計算輸入金額*/
				if($(this).find('input[name="type"]').val()=='1'){//找零
					if(Number(viewtext)==0||(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){
						/*無條件進位取近似值，與price乘積後恰超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
					}
					else{
						enternumber=Number(viewtext);
					}
				}
				else{//不找零
					if(Number(viewtext)==0){//2020/7/20 未填入數量已不超過為優先
						enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
					}
					else if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){//2020/7/20 有填入數量且金額超過未付金額，已支付金額恰好超過應付金額為優先
						/*無條件捨去取近似值，與price乘積後超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
							//enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
							//enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
					}
					else{//2020/7/20 有填入數量且金額未超過未付金額，數量已填入數量為優先
						enternumber=Number(viewtext);
					}
				}
				//console.log(remainingnumber);
				//console.log(enternumber);
				//console.log(Math.min(conditionlimitnumber,remainingnumber,enternumber));
				var minnumber=Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber);
				if(minnumber==0&&$(this).find('input[name="fromdb"]').val()=='member'){
					if($('.sysmeg #name1.syshint7').length>0){
						$('.sysmeg #name1.syshint7').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint7').length>0){
						$('.sysmeg #name2.syshint7').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else if(minnumber==0){//2020/7/20 提醒付款金額為0
					if($('.sysmeg #name1.syshint11').length>0){
						$('.sysmeg #name1.syshint11').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint11').length>0){
						$('.sysmeg #name2.syshint11').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else{
					content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$(this).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' id='"+$(this).attr('class')+"-"+$(this).attr('id')+"'>"+minnumber+"<input type='hidden' name='initview' value='"+minnumber+"'>";
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						var temp=roundfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						var temp=ceilfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else{//無條件捨去
						var temp=floorfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span></div></div></div>";
					if(target=='result'){
						$('.result #paywindow #paycontent').append(content);
					}
					else{
						$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
					}
					if(target=='result'){
						closedisbut();

						computerchange();
					}
					else{
						editpaycomchange();
					}
				}
				$('.'+target+' input[name="view"]').val('');
				computerinvbypay();
				paywindow.dialog('close');
			}
		}
		else{
			if($('.order#order .initsetting #openpaypw').val()=='0'){//2020/8/24 停用會員交易密碼
				//oneEvent(event);
				var content='';
				var target='';
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
					target='result';
				}
				else{
					target='editpay';
				}
				/********/
				//新版其他付款計算邏輯
				//金額計算  總品項可使用金額(會員點數專用;未實作)、最大使用金額、剩餘可用金額、輸入金額在四者中取最小值
				/********/
				var itemsusenumber=9999999;
				//var limitnumber=9999999;
				var conditionlimitnumber=999999999;
				var remainingnumber=9999999;
				var enternumber=9999999;
				/*計算最大使用金額與剩餘可用金額*/
				if($(this).find('input[name="fromdb"]').val()=='member'){
					/*最大使用金額為不超過為主*/
					//console.log(Number($(this).find('input[name="pay"]').val()));
					//console.log(Number($(this).find('input[name="should"]').val()));
					if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){				
						if(target=='result'){
							if($('.result #paywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());
								var used=0;

								for(var i=0;i<$('.result #paywindow #paycontent .paywaybox').length;i++){
									if($('.result #paywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
						else{
							if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());
								var used=0;

								for(var i=0;i<$('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length;i++){
									if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
					}
					else{
					}
					/*if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){
						limitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
					}
					else{
					}*/
					if($(this).find('input[name="location"]').val()=='memberpoint'){//會員點數
						remainingnumber=Number($('.order#order #membutton #memberpoint').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="memberpoint"').length<=0){//當前沒有使用會員點數
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('memberpoint')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
						if($('.result .canusemempoint').length>0){
							if(Number($(this).find('input[name="price"]').val())<=0){
								//itemsusenumber=9999999;//總品項可使用數量
							}
							else{
								itemsusenumber=floorfun((Number($('.result .canusemempoint').val())/Number($(this).find('input[name="price"]').val())),precision);//總品項可使用數量
							}
						}
						else{
						}
					}
					else if($(this).find('input[name="location"]').val()=='membermoney'){//會員儲值金
						remainingnumber=Number($('.order#order #membutton #membermoney').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="membermoney"').length<=0){//當前沒有使用會員儲值金
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('membermoney')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
					}
					else{
					}
				}
				else if($(this).find('input[name="location"]').val()=='pointtree'){//集點樹
					remainingnumber=Number($('.result .pointtree #name2').html());
					if($('.'+target+' #paycontent .paywaybox span[id^="pointtree"]').length<=0){//當前沒有使用集點樹
					}
					else{
						for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
							if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('pointtree')){
								remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
							}
							else{
							}
						}
					}
				}
				else{
				}
				var viewtext=Math.abs($('.'+target+' input[name="view"]').val());//2020/8/3 防呆：負數金額
				/*計算輸入金額*/
				if($(this).find('input[name="type"]').val()=='1'){//找零
					if(Number(viewtext)==0||(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){
						/*無條件進位取近似值，與price乘積後恰超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
					}
					else{
						enternumber=Number(viewtext);
					}
				}
				else{//不找零
					if(Number(viewtext)==0){//2020/7/20 未填入數量已不超過為優先
						enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
					}
					else if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){//2020/7/20 有填入數量且金額超過未付金額，已支付金額恰好超過應付金額為優先
						/*無條件捨去取近似值，與price乘積後超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
							//enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
							//enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
					}
					else{//2020/7/20 有填入數量且金額未超過未付金額，數量已填入數量為優先
						enternumber=Number(viewtext);
					}
				}
				//console.log(remainingnumber);
				//console.log(enternumber);
				//console.log(Math.min(conditionlimitnumber,remainingnumber,enternumber));
				var minnumber=Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber);
				if(minnumber==0&&$(this).find('input[name="fromdb"]').val()=='member'){
					if($('.sysmeg #name1.syshint7').length>0){
						$('.sysmeg #name1.syshint7').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint7').length>0){
						$('.sysmeg #name2.syshint7').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else if(minnumber==0){//2020/7/20 提醒付款金額為0
					if($('.sysmeg #name1.syshint11').length>0){
						$('.sysmeg #name1.syshint11').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint11').length>0){
						$('.sysmeg #name2.syshint11').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else{
					content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$(this).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' id='"+$(this).attr('class')+"-"+$(this).attr('id')+"'>"+minnumber+"<input type='hidden' name='initview' value='"+minnumber+"'>";
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						var temp=roundfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						var temp=ceilfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else{//無條件捨去
						var temp=floorfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span></div></div></div>";
					if(target=='result'){
						$('.result #paywindow #paycontent').append(content);
					}
					else{
						$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
					}
					if(target=='result'){
						closedisbut();

						computerchange();
					}
					else{
						editpaycomchange();
					}
				}
				$('.'+target+' input[name="view"]').val('');
				computerinvbypay();
				paywindow.dialog('close');
			}
			else{//2020/8/24 啟用會員交易密碼
				$.ajax({
					url:'./lib/api/mempaypw/writepw.secview.php',
					method:'post',
					async:false,
					data:{'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});

				$('.getpaypw .paymethoddata input[name="class"]').val($(this).attr('class'));
				$('.getpaypw .paymethoddata input[name="dbname"]').val($(this).attr('id'));
				$('.getpaypw .paymethoddata input[name="should"]').val($(this).find('input[name="should"]').val());
				$('.getpaypw .paymethoddata input[name="fromdb"]').val($(this).find('input[name="fromdb"]').val());
				$('.getpaypw .paymethoddata input[name="pay"]').val($(this).find('input[name="pay"]').val());
				$('.getpaypw .paymethoddata input[name="location"]').val($(this).find('input[name="location"]').val());
				$('.getpaypw .paymethoddata input[name="name"]').val($(this).find('input[name="name"]').val());
				$('.getpaypw .paymethoddata input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.getpaypw .paymethoddata input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.getpaypw .paymethoddata input[name="type"]').val($(this).find('input[name="type"]').val());
				getpaypw.dialog('open');
			}
		}
	});
	$('.getpaypw input[name="paypw"]').keypress(function(event){//2020/8/24 輸入會員交易密碼
		if(event.which==13){
			$.ajax({
				url:'http://api.tableplus.com.tw/outposandorder/memberapi/checkmem.paypw.ajax.php',
				method:'post',
				async:false,
				data:{'company':$('.order#order .companydata #company').val(),'memno':$('.order#order #content #list #tabs4 .listcontentbox input[name="memno"]').val(),'enterpaypw':$('.getpaypw input[name="paypw"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/checkmem.paypw.ajax.php(online success) '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					$('.getpaypw input[name="paypw"]').val('');
					if(d=='pass'){//驗證通過
						//oneEvent(event);
						var content='';
						var target='';
						var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
						if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
							target='result';
						}
						else{
							target='editpay';
						}
						/********/
						//新版其他付款計算邏輯
						//金額計算  總品項可使用金額(會員點數專用;未實作)、最大使用金額、剩餘可用金額、輸入金額在四者中取最小值
						/********/
						var itemsusenumber=9999999;
						//var limitnumber=9999999;
						var conditionlimitnumber=999999999;
						var remainingnumber=9999999;
						var enternumber=9999999;
						/*計算最大使用金額與剩餘可用金額*/
						if($('.getpaypw .paymethoddata input[name="fromdb"]').val()=='member'){
							/*最大使用金額為不超過為主*/
							//console.log(Number($('.getpaypw .paymethoddata input[name="pay"]').val()));
							//console.log(Number($('.getpaypw .paymethoddata input[name="should"]').val()));
							if(Number($('.getpaypw .paymethoddata input[name="pay"]').val())>=0&&Number($('.getpaypw .paymethoddata input[name="should"]').val())>0){				
								if(target=='result'){
									if($('.result #paywindow #paycontent .paywaybox').length>0){
										var should=Number($('.'+target+' #viewwindow #should').html());
										var used=0;

										for(var i=0;i<$('.result #paywindow #paycontent .paywaybox').length;i++){
											if($('.result #paywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($('.getpaypw .paymethoddata input[name="location"]').val())){
												should=Number(should)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
												used=Number(used)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
											}
											else{
											}
										}
										conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val()))-Number(used),precision);
									}
									else{
										conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val())),precision);
									}
								}
								else{
									if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length>0){
										var should=Number($('.'+target+' #viewwindow #should').html());
										var used=0;

										for(var i=0;i<$('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length;i++){
											if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($('.getpaypw .paymethoddata input[name="location"]').val())){
												should=Number(should)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
												used=Number(used)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
											}
											else{
											}
										}
										conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val()))-Number(used),precision);
									}
									else{
										conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val())),precision);
									}
								}
							}
							else{
							}
							/*if(Number($('.getpaypw .paymethoddata input[name="pay"]').val())>=0&&Number($('.getpaypw .paymethoddata input[name="should"]').val())>0){
								limitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val())),precision);
							}
							else{
							}*/
							if($('.getpaypw .paymethoddata input[name="location"]').val()=='memberpoint'){//會員點數
								remainingnumber=Number($('.order#order #membutton #memberpoint').val());
								if($('.'+target+' #paycontent .paywaybox span[id^="memberpoint"').length<=0){//當前沒有使用會員點數
								}
								else{
									for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
										if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('memberpoint')){
											remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
										}
										else{
										}
									}
								}
								if($('.result .canusemempoint').length>0){
									if(Number($('.getpaypw .paymethoddata input[name="price"]').val())<=0){
										//itemsusenumber=9999999;//總品項可使用數量
									}
									else{
										itemsusenumber=floorfun((Number($('.result .canusemempoint').val())/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);//總品項可使用數量
									}
								}
								else{
								}
							}
							else if($('.getpaypw .paymethoddata input[name="location"]').val()=='membermoney'){//會員儲值金
								remainingnumber=Number($('.order#order #membutton #membermoney').val());
								if($('.'+target+' #paycontent .paywaybox span[id^="membermoney"').length<=0){//當前沒有使用會員儲值金
								}
								else{
									for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
										if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('membermoney')){
											remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
										}
										else{
										}
									}
								}
							}
							else{
							}
						}
						else if($('.getpaypw .paymethoddata input[name="location"]').val()=='pointtree'){//集點樹
							remainingnumber=Number($('.result .pointtree #name2').html());
							if($('.'+target+' #paycontent .paywaybox span[id^="pointtree"]').length<=0){//當前沒有使用集點樹
							}
							else{
								for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
									if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('pointtree')){
										remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
									}
									else{
									}
								}
							}
						}
						else{
						}
						var viewtext=Math.abs($('.'+target+' input[name="view"]').val());//2020/8/3 防呆：負數金額
						/*計算輸入金額*/
						if($('.getpaypw .paymethoddata input[name="type"]').val()=='1'){//找零
							if(Number(viewtext)==0||(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($('.getpaypw .paymethoddata input[name="price"]').val())))<=0){
								/*無條件進位取近似值，與price乘積後恰超過應收*/
								if(Number($('.getpaypw .paymethoddata input[name="price"]').val())==0){
									if(Number(viewtext)==0){
									}
									else{
										enternumber=viewtext;
									}
								}
								else{
									enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
								}
							}
							else{
								enternumber=Number(viewtext);
							}
						}
						else{//不找零
							if(Number(viewtext)==0){//2020/7/20 未填入數量已不超過為優先
								enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							else if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($('.getpaypw .paymethoddata input[name="price"]').val())))<=0){//2020/7/20 有填入數量且金額超過未付金額，已支付金額恰好超過應付金額為優先
								/*無條件捨去取近似值，與price乘積後超過應收*/
								if(Number($('.getpaypw .paymethoddata input[name="price"]').val())==0){
									if(Number(viewtext)==0){
									}
									else{
										enternumber=viewtext;
									}
									//enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
								}
								else{
									enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
									//enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
								}
							}
							else{//2020/7/20 有填入數量且金額未超過未付金額，數量已填入數量為優先
								enternumber=Number(viewtext);
							}
						}
						//console.log(remainingnumber);
						//console.log(enternumber);
						//console.log(Math.min(conditionlimitnumber,remainingnumber,enternumber));
						var minnumber=Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber);
						if(minnumber==0&&$('.getpaypw .paymethoddata input[name="fromdb"]').val()=='member'){
							if($('.sysmeg #name1.syshint7').length>0){
								$('.sysmeg #name1.syshint7').css({'display':''});
							}
							else{
							}
							if($('.sysmeg #name2.syshint7').length>0){
								$('.sysmeg #name2.syshint7').css({'display':''});
							}
							else{
							}
							sysmeg.dialog('open');
						}
						else if(minnumber==0){//2020/7/20 提醒付款金額為0
							if($('.sysmeg #name1.syshint11').length>0){
								$('.sysmeg #name1.syshint11').css({'display':''});
							}
							else{
							}
							if($('.sysmeg #name2.syshint11').length>0){
								$('.sysmeg #name2.syshint11').css({'display':''});
							}
							else{
							}
							sysmeg.dialog('open');
						}
						else{
							content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.getpaypw .paymethoddata input[name="name"]').val()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' id='"+$('.getpaypw .paymethoddata input[name="class"]').val()+"-"+$('.getpaypw .paymethoddata input[name="dbname"]').val()+"'>"+minnumber+"<input type='hidden' name='initview' value='"+minnumber+"'>";
							if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
								var temp=roundfun((Number(minnumber)*Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
								var temp=ceilfun((Number(minnumber)*Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							else{//無條件捨去
								var temp=floorfun((Number(minnumber)*Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$('.getpaypw .paymethoddata input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.getpaypw .paymethoddata input[name="type"]').val()+"'></span></div></div></div>";
							if(target=='result'){
								$('.result #paywindow #paycontent').append(content);
							}
							else{
								$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
							}
							if(target=='result'){
								closedisbut();

								computerchange();
							}
							else{
								editpaycomchange();
							}
						}
						$('.'+target+' input[name="view"]').val('');
						computerinvbypay();
						paywindow.dialog('close');

						getpaypw.dialog('close');
					}
					else{
						$.ajax({
							url:'./lib/api/mempaypw/emptypw.secview.php',
							method:'post',
							async:false,
							data:{'machine':$('.order#order .companydata #terminalnumber').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						$('.alertmessage #text').html('會員交易密碼錯誤。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/checkmem.paypw.ajax.php(online error) '+e},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
			});
		}
		else{
			$.ajax({
				url:'./lib/api/mempaypw/writepw.secview.php',
				method:'post',
				async:false,
				data:{'machine':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
	});
	$('.getpaypw #send').click(function(event){//2020/8/24 輸入會員交易密碼
		if($('.getpaypw input[name="paypw"]').val()!=''){
			$.ajax({
				url:'http://api.tableplus.com.tw/outposandorder/memberapi/checkmem.paypw.ajax.php',
				method:'post',
				async:false,
				data:{'company':$('.order#order .companydata #company').val(),'memno':$('.order#order #content #list #tabs4 .listcontentbox input[name="memno"]').val(),'enterpaypw':$('.getpaypw input[name="paypw"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/checkmem.paypw.ajax.php(online success) '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					$('.getpaypw input[name="paypw"]').val('');
					if(d=='pass'){//驗證通過
						//oneEvent(event);
						var content='';
						var target='';
						var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
						if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
							target='result';
						}
						else{
							target='editpay';
						}
						/********/
						//新版其他付款計算邏輯
						//金額計算  總品項可使用金額(會員點數專用;未實作)、最大使用金額、剩餘可用金額、輸入金額在四者中取最小值
						/********/
						var itemsusenumber=9999999;
						//var limitnumber=9999999;
						var conditionlimitnumber=999999999;
						var remainingnumber=9999999;
						var enternumber=9999999;
						/*計算最大使用金額與剩餘可用金額*/
						if($('.getpaypw .paymethoddata input[name="fromdb"]').val()=='member'){
							/*最大使用金額為不超過為主*/
							//console.log(Number($('.getpaypw .paymethoddata input[name="pay"]').val()));
							//console.log(Number($('.getpaypw .paymethoddata input[name="should"]').val()));
							if(Number($('.getpaypw .paymethoddata input[name="pay"]').val())>=0&&Number($('.getpaypw .paymethoddata input[name="should"]').val())>0){				
								if(target=='result'){
									if($('.result #paywindow #paycontent .paywaybox').length>0){
										var should=Number($('.'+target+' #viewwindow #should').html());
										var used=0;

										for(var i=0;i<$('.result #paywindow #paycontent .paywaybox').length;i++){
											if($('.result #paywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($('.getpaypw .paymethoddata input[name="location"]').val())){
												should=Number(should)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
												used=Number(used)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
											}
											else{
											}
										}
										conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val()))-Number(used),precision);
									}
									else{
										conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val())),precision);
									}
								}
								else{
									if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length>0){
										var should=Number($('.'+target+' #viewwindow #should').html());
										var used=0;

										for(var i=0;i<$('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length;i++){
											if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($('.getpaypw .paymethoddata input[name="location"]').val())){
												should=Number(should)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
												used=Number(used)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
											}
											else{
											}
										}
										conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val()))-Number(used),precision);
									}
									else{
										conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val())),precision);
									}
								}
							}
							else{
							}
							/*if(Number($('.getpaypw .paymethoddata input[name="pay"]').val())>=0&&Number($('.getpaypw .paymethoddata input[name="should"]').val())>0){
								limitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($('.getpaypw .paymethoddata input[name="pay"]').val())/Number($('.getpaypw .paymethoddata input[name="should"]').val())),precision);
							}
							else{
							}*/
							if($('.getpaypw .paymethoddata input[name="location"]').val()=='memberpoint'){//會員點數
								remainingnumber=Number($('.order#order #membutton #memberpoint').val());
								if($('.'+target+' #paycontent .paywaybox span[id^="memberpoint"').length<=0){//當前沒有使用會員點數
								}
								else{
									for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
										if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('memberpoint')){
											remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
										}
										else{
										}
									}
								}
								if($('.result .canusemempoint').length>0){
									if(Number($('.getpaypw .paymethoddata input[name="price"]').val())<=0){
										//itemsusenumber=9999999;//總品項可使用數量
									}
									else{
										itemsusenumber=floorfun((Number($('.result .canusemempoint').val())/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);//總品項可使用數量
									}
								}
								else{
								}
							}
							else if($('.getpaypw .paymethoddata input[name="location"]').val()=='membermoney'){//會員儲值金
								remainingnumber=Number($('.order#order #membutton #membermoney').val());
								if($('.'+target+' #paycontent .paywaybox span[id^="membermoney"').length<=0){//當前沒有使用會員儲值金
								}
								else{
									for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
										if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('membermoney')){
											remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
										}
										else{
										}
									}
								}
							}
							else{
							}
						}
						else if($('.getpaypw .paymethoddata input[name="location"]').val()=='pointtree'){//集點樹
							remainingnumber=Number($('.result .pointtree #name2').html());
							if($('.'+target+' #paycontent .paywaybox span[id^="pointtree"]').length<=0){//當前沒有使用集點樹
							}
							else{
								for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
									if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('pointtree')){
										remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
									}
									else{
									}
								}
							}
						}
						else{
						}
						var viewtext=Math.abs($('.'+target+' input[name="view"]').val());//2020/8/3 防呆：負數金額
						/*計算輸入金額*/
						if($('.getpaypw .paymethoddata input[name="type"]').val()=='1'){//找零
							if(Number(viewtext)==0||(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($('.getpaypw .paymethoddata input[name="price"]').val())))<=0){
								/*無條件進位取近似值，與price乘積後恰超過應收*/
								if(Number($('.getpaypw .paymethoddata input[name="price"]').val())==0){
									if(Number(viewtext)==0){
									}
									else{
										enternumber=viewtext;
									}
								}
								else{
									enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
								}
							}
							else{
								enternumber=Number(viewtext);
							}
						}
						else{//不找零
							if(Number(viewtext)==0){//2020/7/20 未填入數量已不超過為優先
								enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							else if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($('.getpaypw .paymethoddata input[name="price"]').val())))<=0){//2020/7/20 有填入數量且金額超過未付金額，已支付金額恰好超過應付金額為優先
								/*無條件捨去取近似值，與price乘積後超過應收*/
								if(Number($('.getpaypw .paymethoddata input[name="price"]').val())==0){
									if(Number(viewtext)==0){
									}
									else{
										enternumber=viewtext;
									}
									//enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
								}
								else{
									enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
									//enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
								}
							}
							else{//2020/7/20 有填入數量且金額未超過未付金額，數量已填入數量為優先
								enternumber=Number(viewtext);
							}
						}
						//console.log(remainingnumber);
						//console.log(enternumber);
						//console.log(Math.min(conditionlimitnumber,remainingnumber,enternumber));
						var minnumber=Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber);
						if(minnumber==0&&$('.getpaypw .paymethoddata input[name="fromdb"]').val()=='member'){
							if($('.sysmeg #name1.syshint7').length>0){
								$('.sysmeg #name1.syshint7').css({'display':''});
							}
							else{
							}
							if($('.sysmeg #name2.syshint7').length>0){
								$('.sysmeg #name2.syshint7').css({'display':''});
							}
							else{
							}
							sysmeg.dialog('open');
						}
						else if(minnumber==0){//2020/7/20 提醒付款金額為0
							if($('.sysmeg #name1.syshint11').length>0){
								$('.sysmeg #name1.syshint11').css({'display':''});
							}
							else{
							}
							if($('.sysmeg #name2.syshint11').length>0){
								$('.sysmeg #name2.syshint11').css({'display':''});
							}
							else{
							}
							sysmeg.dialog('open');
						}
						else{
							content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.getpaypw .paymethoddata input[name="name"]').val()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' id='"+$('.getpaypw .paymethoddata input[name="class"]').val()+"-"+$('.getpaypw .paymethoddata input[name="dbname"]').val()+"'>"+minnumber+"<input type='hidden' name='initview' value='"+minnumber+"'>";
							if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
								var temp=roundfun((Number(minnumber)*Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
								var temp=ceilfun((Number(minnumber)*Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							else{//無條件捨去
								var temp=floorfun((Number(minnumber)*Number($('.getpaypw .paymethoddata input[name="price"]').val())),precision);
							}
							content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$('.getpaypw .paymethoddata input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.getpaypw .paymethoddata input[name="type"]').val()+"'></span></div></div></div>";
							if(target=='result'){
								$('.result #paywindow #paycontent').append(content);
							}
							else{
								$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
							}
							if(target=='result'){
								closedisbut();

								computerchange();
							}
							else{
								editpaycomchange();
							}
						}
						$('.'+target+' input[name="view"]').val('');
						computerinvbypay();
						paywindow.dialog('close');

						getpaypw.dialog('close');
					}
					else{
						$.ajax({
							url:'./lib/api/mempaypw/emptypw.secview.php',
							method:'post',
							async:false,
							data:{'machine':$('.order#order .companydata #terminalnumber').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						$('.alertmessage #text').html('會員交易密碼錯誤。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/checkmem.paypw.ajax.php(online error) '+e},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
			});
		}
		else{
		}
	});
	$('.getpaypw #cancel').click(function(event){//2020/8/24 關閉會員交易密碼輸入視窗
		getpaypw.dialog('close');
	});
	$('.result .otherfunction').click(function(){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面點選其他付款',$(this).find('#name1').html());
		if($(this).find('input[name="fromdb"]').val()!='member'){//2020/8/24 非會員儲值金、點數付款，不需要判斷會員交易密碼
			if($(this).find('input[name="directlinepay"]').val()=='1'&&$('.order#order .initsetting #directlinepay').val()=='1'){//2022/4/29 串接直接linepay付款
				$('.readlinecode #buttonhtml').html($(this).html());
				$('.readlinecode input[name="saverowname"]').val($(this).find('input[name="location"]').val()+"-"+$(this).attr('id'));
				$('.readlinecode input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.readlinecode input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.readlinecode input[name="type"]').val($(this).find('input[name="type"]').val());
				//2022/5/4 金額的部分，因為流程上是在掃描條碼後才讀入，因此這邊不清空，且金額比例已固定1:1(因為linepay金額視為現金，不會有比例不同的狀況)
				$('.result .directlinepay').trigger('click');
				//$('.'+target+' input[name="view"]').val('');
				//paywindow.dialog('close');
			}
			else if($(this).find('input[name="jkos"]').val()=='1'&&$('.order#order .initsetting #jkos').val()=='1'){//2022/10/6 串接街口支付付款
				$('.readjkoscode #buttonhtml').html($(this).html());
				$('.readjkoscode input[name="saverowname"]').val($(this).find('input[name="location"]').val()+"-"+$(this).attr('id'));
				$('.readjkoscode input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.readjkoscode input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.readjkoscode input[name="type"]').val($(this).find('input[name="type"]').val());
				//2022/5/4 金額的部分，因為流程上是在掃描條碼後才讀入，因此這邊不清空，且金額比例已固定1:1(因為linepay金額視為現金，不會有比例不同的狀況)
				$('.result .jkos').trigger('click');
				//$('.'+target+' input[name="view"]').val('');
				//paywindow.dialog('close');
			}
			else if($(this).find('input[name="pxpayplus"]').val()=='1'&&$('.order#order .initsetting #pxpayplus').val()=='1'){//2022/10/28 串接全支付付款
				$('.readpxpaypluscode #buttonhtml').html($(this).html());
				$('.readpxpaypluscode input[name="saverowname"]').val($(this).find('input[name="location"]').val()+"-"+$(this).attr('id'));
				$('.readpxpaypluscode input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.readpxpaypluscode input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.readpxpaypluscode input[name="type"]').val($(this).find('input[name="type"]').val());
				//2022/5/4 金額的部分，因為流程上是在掃描條碼後才讀入，因此這邊不清空，且金額比例已固定1:1(因為linepay金額視為現金，不會有比例不同的狀況)
				$('.result .pxpayplus').trigger('click');
				//$('.'+target+' input[name="view"]').val('');
				//paywindow.dialog('close');
			}
			else{
				$('.paywindow input[name="target"]').val('result');
				var content='';
				var target='';
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
					target='result';
				}
				else{
					target='editpay';
				}
				/********/
				//新版其他付款計算邏輯
				//數量計算  總品項可使用數量(會員點數專用;未實作)、最大使用數量、剩餘可用數量、輸入數量在四者中取最小值
				/********/
				var itemsusenumber=9999999;//總品項可使用數量
				//var limitnumber=9999999;//最大使用數量//與輸入數量邏輯重複
				var conditionlimitnumber=999999999;//條件限制最大使用數量(最大還能使用的數量)
				var remainingnumber=9999999;//剩餘可用數量
				var enternumber=9999999;//輸入數量
				/*計算最大使用數量與剩餘可用數量*/
				if($(this).find('input[name="fromdb"]').val()=='member'){
					/*最大使用數量為不超過為主*/
					//console.log(Number($(this).find('input[name="pay"]').val()));
					//console.log(Number($(this).find('input[name="should"]').val()));
					if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){				
						if(target=='result'){
							if($('.result #paywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());//2020/6/1 計算使用該付款前的金額
								var used=0;

								for(var i=0;i<$('.result #paywindow #paycontent .paywaybox').length;i++){
									if($('.result #paywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
						else{
							if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());//2020/6/1 計算使用該付款前的金額
								var used=0;//2020/6/1 紀錄以使用數量

								for(var i=0;i<$('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length;i++){
									if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
					}
					else{
					}
					/*if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){
						limitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
					}
					else{
					}*/
					/*剩餘可用數量*/
					if($(this).find('input[name="location"]').val()=='memberpoint'){//會員點數
						remainingnumber=Number($('.order#order #membutton #memberpoint').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="memberpoint"').length<=0){//當前沒有使用會員點數
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('memberpoint')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
						if($('.result .canusemempoint').length>0){
							if(Number($(this).find('input[name="price"]').val())<=0){
								//itemsusenumber=9999999;//總品項可使用數量
							}
							else{
								itemsusenumber=floorfun((Number($('.result .canusemempoint').val())/Number($(this).find('input[name="price"]').val())),precision);//總品項可使用數量
							}
						}
						else{
						}
					}
					else if($(this).find('input[name="location"]').val()=='membermoney'){//會員儲值金
						remainingnumber=Number($('.order#order #membutton #membermoney').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="membermoney"').length<=0){//當前沒有使用會員儲值金
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('membermoney')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
					}
					else{
					}
				}
				else if($(this).find('input[name="location"]').val()=='pointtree'){//集點樹
					remainingnumber=Number($('.result .pointtree #name2').html());
					if($('.'+target+' #paycontent .paywaybox span[id^="pointtree"]').length<=0){//當前沒有使用集點樹
					}
					else{
						for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
							if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('pointtree')){
								remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
							}
							else{
							}
						}
					}
				}
				else{
				}
				var viewtext=Math.abs($('.'+target+' input[name="view"]').val());//2020/8/3 防呆：負數金額
				/*計算輸入數量*/
				if($(this).find('input[name="type"]').val()=='1'){//找零
					if(Number(viewtext)==0||(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){
						/*無條件進位取近似值，與price乘積後恰超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						//console.log('1');
					}
					else{
						enternumber=Number(viewtext);
						//console.log('2');
					}
				}
				else{//不找零
					if(Number(viewtext)==0){//2020/7/20 未填入數量已不超過為優先
						enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
					}
					else if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){//2020/7/20 有填入數量且金額超過未付金額，已支付金額恰好超過應付金額為優先
						/*無條件捨去取近似值，與price乘積後超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
							//enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
					}
					else{//2020/7/20 有填入數量且金額未超過未付金額，數量已填入數量為優先
						enternumber=Number(viewtext);
					}
				}
				if(typeof $(this).find('input[name="inv"]')!=='undefined'&&$(this).find('input[name="inv"]').val()=='0'){//不納入發票金額

				}
				else{//計算發票金額
				}
				//console.log('limitnumber:'+limitnumber);
				//console.log('conditionlimitnumber:'+conditionlimitnumber);
				//console.log('remainingnumber:'+remainingnumber);
				//console.log('enternumber:'+enternumber);
				//console.log('itemsusenumber:'+itemsusenumber);
				//console.log(Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber));
				var minnumber=Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber);
				if(minnumber==0&&$(this).find('input[name="fromdb"]').val()=='member'){
					if($('.sysmeg #name1.syshint7').length>0){
						$('.sysmeg #name1.syshint7').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint7').length>0){
						$('.sysmeg #name2.syshint7').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else if(minnumber==0){//2020/7/20 提醒付款金額為0
					if($('.sysmeg #name1.syshint11').length>0){
						$('.sysmeg #name1.syshint11').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint11').length>0){
						$('.sysmeg #name2.syshint11').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else{
					content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$(this).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>"+minnumber+"<input type='hidden' name='initview' value='"+minnumber+"'>";
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						var temp=roundfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						var temp=ceilfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else{//無條件捨去
						var temp=floorfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					//console.log((Number(minnumber)*Number($(this).find('input[name="price"]').val())));
					content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span></div></div></div>";
					if(target=='result'){
						$('.result #paywindow #paycontent').append(content);
					}
					else{
						$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
					}
					$('.'+target+' input[name="view"]').val('');
					if(target=='result'){
						closedisbut();

						computerchange();
					}
					else{
						editpaycomchange();
					}
				}
				computerinvbypay();
			}
		}
		else{
			if($('.order#order .initsetting #openpaypw').val()=='0'){//2020/8/24 停用會員交易密碼
				$('.paywindow input[name="target"]').val('result');
				var content='';
				var target='';
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
					target='result';
				}
				else{
					target='editpay';
				}
				/********/
				//新版其他付款計算邏輯
				//數量計算  總品項可使用數量(會員點數專用;未實作)、最大使用數量、剩餘可用數量、輸入數量在四者中取最小值
				/********/
				var itemsusenumber=9999999;//總品項可使用數量
				//var limitnumber=9999999;//最大使用數量//與輸入數量邏輯重複
				var conditionlimitnumber=999999999;//條件限制最大使用數量(最大還能使用的數量)
				var remainingnumber=9999999;//剩餘可用數量
				var enternumber=9999999;//輸入數量
				/*計算最大使用數量與剩餘可用數量*/
				if($(this).find('input[name="fromdb"]').val()=='member'){
					/*最大使用數量為不超過為主*/
					//console.log(Number($(this).find('input[name="pay"]').val()));
					//console.log(Number($(this).find('input[name="should"]').val()));
					if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){				
						if(target=='result'){
							if($('.result #paywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());//2020/6/1 計算使用該付款前的金額
								var used=0;

								for(var i=0;i<$('.result #paywindow #paycontent .paywaybox').length;i++){
									if($('.result #paywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.result #paywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
						else{
							if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length>0){
								var should=Number($('.'+target+' #viewwindow #should').html());//2020/6/1 計算使用該付款前的金額
								var used=0;//2020/6/1 紀錄以使用數量

								for(var i=0;i<$('.editpay #viewwindow #editpaywindow #paycontent .paywaybox').length;i++){
									if($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox .payway .otherpay').prop('id').match($(this).find('input[name="location"]').val())){
										should=Number(should)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="viewmoney"]').val());
										used=Number(used)+Number($('.editpay #viewwindow #editpaywindow #paycontent .paywaybox:eq('+i+') .payway .otherpay input[name="initview"]').val());
									}
									else{
									}
								}
								conditionlimitnumber=floorfun(((Number(should)+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val()))-Number(used),precision);
							}
							else{
								conditionlimitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))*Number($(this).find('input[name="pay"]').val())/Number($(this).find('input[name="should"]').val())),precision);
							}
						}
					}
					else{
					}
					/*if(Number($(this).find('input[name="pay"]').val())>=0&&Number($(this).find('input[name="should"]').val())>0){
						limitnumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
					}
					else{
					}*/
					/*剩餘可用數量*/
					if($(this).find('input[name="location"]').val()=='memberpoint'){//會員點數
						remainingnumber=Number($('.order#order #membutton #memberpoint').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="memberpoint"').length<=0){//當前沒有使用會員點數
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('memberpoint')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
						if($('.result .canusemempoint').length>0){
							if(Number($(this).find('input[name="price"]').val())<=0){
								//itemsusenumber=9999999;//總品項可使用數量
							}
							else{
								itemsusenumber=floorfun((Number($('.result .canusemempoint').val())/Number($(this).find('input[name="price"]').val())),precision);//總品項可使用數量
							}
						}
						else{
						}
					}
					else if($(this).find('input[name="location"]').val()=='membermoney'){//會員儲值金
						remainingnumber=Number($('.order#order #membutton #membermoney').val());
						if($('.'+target+' #paycontent .paywaybox span[id^="membermoney"').length<=0){//當前沒有使用會員儲值金
						}
						else{
							for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
								if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('membermoney')){
									remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
								}
								else{
								}
							}
						}
					}
					else{
					}
				}
				else if($(this).find('input[name="location"]').val()=='pointtree'){//集點樹
					remainingnumber=Number($('.result .pointtree #name2').html());
					if($('.'+target+' #paycontent .paywaybox span[id^="pointtree"]').length<=0){//當前沒有使用集點樹
					}
					else{
						for(var i=0;i<$('.'+target+' #paycontent .paywaybox .otherpay').length;i++){
							if($('.'+target+' #paycontent .paywaybox .otherpay').prop('id').match('pointtree')){
								remainingnumber=Number(remainingnumber)-Number($('.'+target+' #paycontent .paywaybox .otherpay:eq('+i+') input[name="initview"]').val());
							}
							else{
							}
						}
					}
				}
				else{
				}
				var viewtext=Math.abs($('.'+target+' input[name="view"]').val());//2020/8/3 防呆：負數金額
				/*計算輸入數量*/
				if($(this).find('input[name="type"]').val()=='1'){//找零
					if(Number(viewtext)==0||(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){
						/*無條件進位取近似值，與price乘積後恰超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						//console.log('1');
					}
					else{
						enternumber=Number(viewtext);
						//console.log('2');
					}
				}
				else{//不找零
					if(Number(viewtext)==0){//2020/7/20 未填入數量已不超過為優先
						enternumber=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
					}
					else if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html())-(Number(viewtext)*Number($(this).find('input[name="price"]').val())))<=0){//2020/7/20 有填入數量且金額超過未付金額，已支付金額恰好超過應付金額為優先
						/*無條件捨去取近似值，與price乘積後超過應收*/
						if(Number($(this).find('input[name="price"]').val())==0){
							if(Number(viewtext)==0){
							}
							else{
								enternumber=viewtext;
							}
							//enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						else{
							enternumber=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
					}
					else{//2020/7/20 有填入數量且金額未超過未付金額，數量已填入數量為優先
						enternumber=Number(viewtext);
					}
				}
				if(typeof $(this).find('input[name="inv"]')!=='undefined'&&$(this).find('input[name="inv"]').val()=='0'){//不納入發票金額

				}
				else{//計算發票金額
				}
				//console.log('limitnumber:'+limitnumber);
				//console.log('conditionlimitnumber:'+conditionlimitnumber);
				//console.log('remainingnumber:'+remainingnumber);
				//console.log('enternumber:'+enternumber);
				//console.log('itemsusenumber:'+itemsusenumber);
				//console.log(Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber));
				var minnumber=Math.min(conditionlimitnumber,remainingnumber,enternumber,itemsusenumber);
				if(minnumber==0&&$(this).find('input[name="fromdb"]').val()=='member'){
					if($('.sysmeg #name1.syshint7').length>0){
						$('.sysmeg #name1.syshint7').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint7').length>0){
						$('.sysmeg #name2.syshint7').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else if(minnumber==0){//2020/7/20 提醒付款金額為0
					if($('.sysmeg #name1.syshint11').length>0){
						$('.sysmeg #name1.syshint11').css({'display':''});
					}
					else{
					}
					if($('.sysmeg #name2.syshint11').length>0){
						$('.sysmeg #name2.syshint11').css({'display':''});
					}
					else{
					}
					sysmeg.dialog('open');
				}
				else{
					content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$(this).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>"+minnumber+"<input type='hidden' name='initview' value='"+minnumber+"'>";
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						var temp=roundfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						var temp=ceilfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else{//無條件捨去
						var temp=floorfun((Number(minnumber)*Number($(this).find('input[name="price"]').val())),precision);
					}
					//console.log((Number(minnumber)*Number($(this).find('input[name="price"]').val())));
					content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span></div></div></div>";
					if(target=='result'){
						$('.result #paywindow #paycontent').append(content);
					}
					else{
						$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
					}
					$('.'+target+' input[name="view"]').val('');
					if(target=='result'){
						closedisbut();

						computerchange();
					}
					else{
						editpaycomchange();
					}
				}
				computerinvbypay();
			}
			else{
				$.ajax({
					url:'./lib/api/mempaypw/writepw.secview.php',
					method:'post',
					async:false,
					data:{'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});

				$('.getpaypw .paymethoddata input[name="class"]').val($(this).attr('class'));
				$('.getpaypw .paymethoddata input[name="dbname"]').val($(this).attr('id'));
				$('.getpaypw .paymethoddata input[name="should"]').val($(this).find('input[name="should"]').val());
				$('.getpaypw .paymethoddata input[name="fromdb"]').val($(this).find('input[name="fromdb"]').val());
				$('.getpaypw .paymethoddata input[name="pay"]').val($(this).find('input[name="pay"]').val());
				$('.getpaypw .paymethoddata input[name="location"]').val($(this).find('input[name="location"]').val());
				$('.getpaypw .paymethoddata input[name="name"]').val($(this).find('input[name="name"]').val());
				$('.getpaypw .paymethoddata input[name="inv"]').val($(this).find('input[name="inv"]').val());
				$('.getpaypw .paymethoddata input[name="price"]').val($(this).find('input[name="price"]').val());
				$('.getpaypw .paymethoddata input[name="type"]').val($(this).find('input[name="type"]').val());
				getpaypw.dialog('open');
			}
		}
	});
	$('.editpay .otherfunction').click(function(){
		$('.paywindow input[name="target"]').val('editpay');
		var content='';
		var target='';
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
			target='result';
		}
		else{
			target='editpay';
		}
		if($('.'+target+' input[name="view"]').val().length>0){
			if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))<=0){
			}
			else{
				content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$(this).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>";
				if($(this).find('input[name="type"]').val()=='1'){//找零
					content=content+"<span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>";

					if((Number($('.'+target+' input[name="view"]').val())*Number($(this).find('input[name="price"]').val()))>=(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))){
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							var temp=roundfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							var temp=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}
						else{//無條件捨去
							var temp=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
						}

						content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}
						else{//無條件捨去
							var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}

						content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
					}
					else{
						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							var temp=roundfun($('.'+target+' input[name="view"]').val(),precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							var temp=ceilfun($('.'+target+' input[name="view"]').val(),precision);
						}
						else{//無條件捨去
							var temp=floorfun($('.'+target+' input[name="view"]').val(),precision);
						}

						content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}
						else{//無條件捨去
							var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}

						content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
					}
				}
				else{//不找零
					if((Number($('.'+target+' input[name="view"]').val())*Number($(this).find('input[name="price"]').val()))>=(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))){
						if((parseInt((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val()))*Number($(this).find('input[name="price"]').val()))<(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))){
							content=content+"<span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>";

							var temp=(parseInt((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val()))+1);

							content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

							if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
								var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
							}
							else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
								var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
							}
							else{//無條件捨去
								var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
							}

							content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
						}
						else{
							content=content+"<span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>";

							var temp=parseInt((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val()));

							content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

							if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
								var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
							}
							else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
								var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
							}
							else{//無條件捨去
								var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
							}

							content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
						}
					}
					else{
						content=content+"<span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>";

						var temp=parseInt($('.'+target+' input[name="view"]').val());

						content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

						if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
							var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}
						else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
							var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}
						else{//無條件捨去
							var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
						}

						content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
					}
				}

				content=content+"</div></div></div>";

				if(target=='result'){
					$('.result #paywindow #paycontent').append(content);
				}
				else{
					$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
				}
			}
			$('.'+target+' input[name="view"]').val('');
			
		}
		else if((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))>0){
			content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$(this).html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>";
			
			if($(this).find('input[name="type"]').val()=='1'){//找零
				content=content+"<span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>";

				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					var temp=roundfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					var temp=ceilfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
				}
				else{//無條件捨去
					var temp=floorfun(((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val())),precision);
				}

				content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
				}
				else{//無條件捨去
					var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
				}
				
				content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
			}
			else{//不找零
				if((parseInt((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val()))*Number($(this).find('input[name="price"]').val()))<(Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))){
					content=content+""+$('.result .frontunit').val()+"<span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>";

					var temp=parseInt((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val()))+1;

					content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else{//無條件捨去
						var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
					}
					
					content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
				}
				else{
					content=content+"<span class='otherpay' id='"+$(this).find('input[name="location"]').val()+"-"+$(this).attr('id')+"'>";

					var temp=parseInt((Number($('.'+target+' #viewwindow #should').html())+Number($('.'+target+' #viewwindow #cashcomm').html())-Number($('.'+target+' #viewwindow #already').html()))/Number($(this).find('input[name="price"]').val()));

					content=content+temp+"<input type='hidden' name='initview' value='"+temp+"'>";

					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						var temp=roundfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						var temp=ceilfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
					}
					else{//無條件捨去
						var temp=floorfun((Number(temp)*Number($(this).find('input[name="price"]').val())),precision);
					}
					
					content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$(this).find('input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$(this).find('input[name="type"]').val()+"'></span>";
				}
			}

			content=content+"</div></div></div>";
			if(target=='result'){
				$('.result #paywindow #paycontent').append(content);
			}
			else{
				$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
			}
		}
		else{
		}
		if(target=='result'){
			closedisbut();

			computerchange();
		}
		else{
			editpaycomchange();
		}
		paywindow.dialog('close');
	});
	$('.order#order #MemberBill #billfun #citybox #billfun3').on('click','#punch',function(event){
		//oneEvent(event);
		punch.dialog('open');
	});
	$('.punch').on('click','#return',function(event){
		//oneEvent(event);
		punch.dialog('close');
	});
	$('.punch').on('click','#number',function(event){
		//oneEvent(event);
		$('.punch input[name="num"]').val($('.punch input[name="num"]').val()+$(this).val());
	});
	$('.punch').on('click','#clear',function(event){
		//oneEvent(event);
		$('.punch input[name="num"]').val('');
	});
	$('.punch').on('click','#back',function(event){
		//oneEvent(event);
		if($('.punch input[name="num"]').val().length>0){
			$('.punch input[name="num"]').val($('.punch input[name="num"]').val().substr(0,$('.punch input[name="num"]').val().length-1));
		}
		else{
			$('.punch input[name="num"]').val('');
		}
	});
	$('.punch').on('click','#on',function(event){
		//oneEvent(event);
		if($('.punch input[name="num"]').val().length>0){
			$.ajax({
				url:'./lib/js/checkpunch.ajax.php',
				method:'post',
				async:false,
				data:{'type':'off','punchno':$('.punch input[name="num"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'punch-on checkpunch.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					var temp=d.split(';');
					//console.log(temp);
					if(temp[0]=='success'){
						//console.log(d);
						$.ajax({
							url:'./lib/js/pushpunch.ajax.php',
							method:'post',
							async:false,
							data:{'type':'on','time':temp[1],'punchno':$('.punch input[name="num"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
							dataType:'html',
							success:function(d){
								if(d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'punch-on pushpunch.ajax.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								//console.log(d);
								if(d=='success'){
									//alertmessage('成功打卡。');
									$('.alertmessage #text').html('工號：'+temp[2]+' '+temp[3]+'成功打卡。');
									alertmessage.dialog('open');
								}
								else{
									//alertmessage('員工編號輸入錯誤。');
									$('.alertmessage #text').html('員工編號輸入錯誤。');
									alertmessage.dialog('open');
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if(temp[0]=='error'){
						//alertmessage('查無工號。');
						$('.alertmessage #text').html('<span style="color:#ff0000;font-weight:bold;">查無工號，打卡失敗。</span>');
						alertmessage.dialog('open');
					}
					else{
						//alertmessage('您尚未下班，因此無法打上班卡。');
						$('.alertmessage #text').html('您尚未下班，因此無法打上班卡。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
			$('.punch input[name="num"]').val('');
		}
		else{
		}
	});
	$('.punch').on('click','#off',function(event){
		//oneEvent(event);
		if($('.punch input[name="num"]').val().length>0){
			$.ajax({
				url:'./lib/js/checkpunch.ajax.php',
				method:'post',
				async:false,
				data:{'type':'on','punchno':$('.punch input[name="num"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					if(d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'punch-off checkpunch.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					var temp=d.split(';');
					if(temp[0]=='success'){
						//console.log(d);
						$.ajax({
							url:'./lib/js/pushpunch.ajax.php',
							method:'post',
							async:false,
							data:{'type':'off','time':temp[1],'punchno':$('.punch input[name="num"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
							dataType:'html',
							success:function(d){
								if(d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'punch-off pushpunch.ajax.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								//console.log(d);
								if(d=='success'){
									//alertmessage('成功打卡。');
									$('.alertmessage #text').html('工號：'+temp[2]+' '+temp[3]+'成功打卡。');
									alertmessage.dialog('open');
								}
								else{
									//alertmessage('員工編號輸入錯誤。');
									$('.alertmessage #text').html('員工編號輸入錯誤。');
									alertmessage.dialog('open');
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if(temp[0]=='error'){
						//alertmessage('查無工號。');
						$('.alertmessage #text').html('<span style="color:#ff0000;font-weight:bold;">查無工號，打卡失敗。</span>');
						alertmessage.dialog('open');
					}
					else{
						//alertmessage('您尚未上班，因此無法打下班卡。');
						$('.alertmessage #text').html('您尚未上班，因此無法打下班卡。');
						alertmessage.dialog('open');
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
			$('.punch input[name="num"]').val('');
		}
		else{
		}
	});
	$('.viewtemp #otherfun').on('click','#openinv',function(){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('未結帳單開立發票','click');
		if($('.order#order .initsetting #controltable').val()=='1'){
			$.ajax({
				url:'./lib/js/checktabstate.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					if(d.substr(0,6)=='unlock'){
						var tabs=changetagtarget();
						if($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0'){
							//alertmessage('目前發票數量不足，無法開立發票。');
							$('.alertmessage #text').html('目前發票數量不足，無法開立發票。');
							alertmessage.dialog('open');
						}
						else{
							$('.result input[name="sendtype"]').val('tempsale');
							$.ajax({
								url:'./lib/js/templistitems.ajax.php',
								method:'post',
								async: false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'viewtemp-openinv templistitems.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var temp='';
									//console.log(d);
									$.each(d,function(index,value){
										if($.isArray(value)){
											$.each(value,function(k,v){
												temp=temp+index+'[]='+v+'&';
											});
										}
										else{
											temp=temp+index+'='+value+'&';
										}
									});
									//console.log(temp);
									if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
										$.ajax({
											url:'./lib/js/compdis.ajax.php',
											method:'post',
											async: false,
											data:temp,
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d.length>20||d.match('ERROR HINT: ')){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'viewtemp-openinv compdis.ajax.php '+d},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
												}
												var temp=d.split(';');
												if($.isNumeric(temp[0])){
													$('.result #viewwindow #autodis').html(temp[0]);
													$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
													$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
												}
												else{
													$('.result #viewwindow #autodis').html('0');
													$('.result #viewwindow input[name="autodiscontent"]').val('');
													$('.result #viewwindow input[name="autodispremoney"]').val('0');
												}
												//console.log(d);
											},
											error:function(e){
												//console.log(e)
											}
										});
									}
									else{
										$('.result #viewwindow #autodis').html('0');
										$('.result #viewwindow input[name="autodiscontent"]').val('');
										$('.result #viewwindow input[name="autodispremoney"]').val('0');
									}
									var flooramt=0;
									flooramt=Number(flooramt)+(parseInt(d['person1'])*Number($('.setperson #view input[name="personfloor1"]').val()));
									flooramt=Number(flooramt)+(parseInt(d['person2'])*Number($('.setperson #view input[name="personfloor2"]').val()));
									flooramt=Number(flooramt)+(parseInt(d['person3'])*Number($('.setperson #view input[name="personfloor3"]').val()));
									$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val(flooramt);
									var total=0;
									var itemdis=0;
									var temptotal=0;
									var tempdis=0;
									var caninilistdis=0;
									var canlistdis=0;
									var cannotlistdis=0;

									var canusemempoint=0;
									var usepoint=0;

									//console.log(d['no'].length);
									for(var i=0;i<d['no'].length;i++){
										total=Number(total)+Number(d['subtotal'][i]);
										itemdis=Number(itemdis)+Number(d['discount'][i]);
										if(d['needcharge'][i]=='1'){
											temptotal=Number(temptotal)+Number(d['subtotal'][i]);
											tempdis=Number(tempdis)+Number(d['discount'][i]);
										}
										else{
										}
										if(d['listdis'][i]=='1'){
											caninilistdis=Number(caninilistdis)+Number(d['subtotal'][i]);

											if(Number(d['discount'][i])!=0){//具有單品促銷

												if(Number(d['dispoint'][i])!=0){//有使用單品促銷－點數兌換
													usepoint=parseInt(usepoint)+parseInt(d['dispoint'][i]);
												}
												else{
												}

												if(d['bothdis'][i]=='1'){//允許同時使用單品促銷與帳單折扣(讓)
													canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
												}
												else{
													continue;
												}
											}
											else{
												canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
											}
											
										}
										else{
											cannotlistdis=Number(cannotlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
										}

										if(d['getpointtype'][i]=='2'){//2020/4/20 品項中多一個屬性，紀錄該品項的集點方式；固定點數、金額點數。本欄位是只計算金額點數
											canusemempoint=parseFloat(canusemempoint)+parseFloat(d['subtotal'][i]);
										}
										else{
										}
									}
									if($('.order#order .initsetting #comfloor').val()=='1'){
										if(Number(total)<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
											$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(total)));
										}
										else{
											$('.result #viewwindow input[name="floorspan"]').val('0');
										}
									}
									else{
										if(Number(d['AMT'])<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
											$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(d['AMT'])));
										}
										else{
											$('.result #viewwindow input[name="floorspan"]').val('0');
										}
									}
									if(Number($('.result #viewwindow input[name="floorspan"]').val())>0){
										var t=confirm('不足低銷，將以低消計算('+$('.result .frontunit').val()+$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val()+$('.result .unit').val()+')');
										if(t==true){
											$('.result #viewwindow #total').html($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
											$('.result #viewwindow #temptotal').val($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
											$('.result #viewwindow #itemdis').html('0');
											$('.result #viewwindow #tempdis').val('0');
										}
										else{
											$('.result #viewwindow #total').html(total);
											$('.result #viewwindow #temptotal').val(temptotal);
											$('.result #viewwindow #itemdis').html(-itemdis);
											$('.result #viewwindow #tempdis').val(-tempdis);
										}
										if($('.order#order .initsetting #openchar').val()=='1'){//開啟服務費
											$('.result #viewwindow #charge').html(temparray['charge']);
										}
										else{//關閉服務費
										}
									}
									else{
										$('.result #viewwindow #total').html(total);
										$('.result #viewwindow #temptotal').val(temptotal);
										$('.result #viewwindow #itemdis').html(-itemdis);
										$('.result #viewwindow #tempdis').val(-tempdis);
									}
									$('.result .caninilistdis').val(caninilistdis);
									$('.result .canlistdis').val(canlistdis);
									$('.result .cannotlistdis').val(cannotlistdis);
									$('.result .canusemempoint').val(canusemempoint);
									$('.result .usepoint').val(usepoint);
									$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
									$('.result #viewwindow #charge').html(d['charge']);
									$('.result #viewwindow #listdis1').html('0');
									$('.result #viewwindow #listdis2').html(0-d['listdis2']);
									$('.result #paywindow #paycontent').html('');
									if(typeof d['payment']!=='undefined'){
										var content='';
										if(typeof d['payment']['nidin']!=='undefined'&&typeof d['payment']['nidin']['method']!=='undefined'){
											for(var i=0;i<d['payment']['nidin']['method'].length;i++){
												content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>Nidin</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='nidinother' id='"+d['payment']['nidin']['method'][i]+"'>";
												content=content+d['payment']['nidin']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['nidin']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

												$('.result #paywindow #paycontent').append(content);

												closedisbut();
											}
										}
										else if(typeof d['payment']['intella']!=='undefined'&&typeof d['payment']['intella']['method']!=='undefined'){
											for(var i=0;i<d['payment']['intella']['method'].length;i++){
												content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+d['payment']['intella']['method'][i]+"'>";
												content=content+d['payment']['intella']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['intella']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

												$('.result #paywindow #paycontent').append(content);

												closedisbut();
											}
										}
										else{
										}
									}
									else{
									}
									$('.result #viewwindow #already').html('0');
									$('.result #viewwindow #cashmoney').html('0');
									$('.result #viewwindow #cash').html('0');
									$('.result #viewwindow #other').html('0');
									$('.result #viewwindow input[name="already"]').val('0');
									$('.result #viewwindow #should').html(Number(d['amt'])+Number(d['charge']));
									$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
									$('.result #viewwindow #change').html('0');

									d['freeinv']=Number(d['freeinv'])-Number($('.result #viewwindow #autodis').html());
									if(d['freeinv']<0){
										d['ininv']=Number(d['ininv'])+Number(d['freeinv']);
										d['freeinv']=0;
									}
									else{
									}
									$('.result #viewwindow #ininv').html(d['ininv']+Number(d['charge'])-Number($('.result #viewwindow #listdis2').html()));
									$('.result #viewwindow input[name="ininv"]').val(d['ininv']);
									$('.result #viewwindow #freeinv').html(d['freeinv']);
									$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());

									if(typeof d['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
										$('.result #viewwindow input[name="tempcontainer"]').val(d['container']);
									}
									else{
										$('.result #viewwindow input[name="tempcontainer"]').val('');
									}
									if(typeof d['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
										$('.result #viewwindow input[name="tempban"]').val(d['ban']);
									}
									else{
										$('.result #viewwindow input[name="tempban"]').val('');
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.result .numbox .otherpay').prop('disabled',true);
							$('.result .numbox .otherfunction').prop('disabled',true);
							$('.result .numbox .cashbut').prop('disabled',true);
							$('.result .numbox .moneybut').prop('disabled',true);
							$('.result #funbox #loopbut #name1').html($('.order#order .initsetting #listprintname1').val());
							$('.result #funbox #loopbut #name2').html($('.order#order .initsetting #listprintname2').val());
							$('.result #viewwindow .sendviewwindow input[name="looptype"]').val($('.order#order .initsetting #looptype').val());
							if($('.order#order .initsetting #openchar').val()=='0'){
								$('.result #funbox .chargebut').prop('disabled',true);
								$('.result #funbox .chargebut #name1').html('不收服務費');
								$('.result #funbox #charno').html($('.order#order .initsetting #charge').val());
							}
							else{
								$('.result #funbox .chargebut').prop('disabled',false);
								if($('.order#order .initsetting #charge').val()=='1'&&$('.order#order #content #tabs4 .listcontentbox input[name="listtype"]').val()=='1'){
									$('.result #funbox .chargebut #name1').html('收服務費');
									$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
								}
								else{
									$('.result #funbox .chargebut #name1').html('不收服務費');
									$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
								}
							}
							$('.result #funbox .receiptbut').prop('disabled',true);
							$('.result .numbox .ban #name1').html('輸入統編');
							$('.result input[name="view"]').val('');
							$('.result input[name="view"]').css({'background-color':'#FFFFFF'});
							$('.result #viewwindow input[name="tempban"]').css({'background-color':'#EFEBDE'});
							$('.result #viewwindow input[name="tempban"]').prop('readonly',true);
							//2021/3/10 提到前面填入
							/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
								$('.result #viewwindow input[name="tempban"]').val(d['payment']['ban']);
							}
							else{
								$('.result #viewwindow input[name="tempban"]').val('');
							}*/
							$('.result #viewwindow input[name="tempcontainer"]').css({'background-color':'#EFEBDE'});
							$('.result #viewwindow input[name="tempcontainer"]').prop('readonly',true);
							//2021/3/10 提到前面填入
							/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
								$('.result #viewwindow input[name="tempcontainer"]').val(d['payment']['container']);
							}
							else{
								$('.result #viewwindow input[name="tempcontainer"]').val('');
							}*/
							$('.result .target').val('view');
							$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							result.dialog('open');
						}
					}
					else{
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			var tabs=changetagtarget();
			if($('.order#order #banner #detail #invnum').length>0&&$('.order#order #banner #detail #invnum').val()=='0'){
				//alertmessage('目前發票數量不足，無法開立發票。');
				$('.alertmessage #text').html('目前發票數量不足，無法開立發票。');
				alertmessage.dialog('open');
			}
			else{
				$('.result input[name="sendtype"]').val('tempsale');
				$.ajax({
					url:'./lib/js/templistitems.ajax.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
					dataType:'json',
					success:function(d){
						//console.log(d);
						if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'viewtemp-openinv templistitems.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						var temp='';
						$.each(d,function(index,value){
							if($.isArray(value)){
								$.each(value,function(k,v){
									temp=temp+index+'[]='+v+'&';
								});
							}
							else{
								temp=temp+index+'='+value+'&';
							}
						});
						//console.log(temp);
						if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
							$.ajax({
								url:'./lib/js/compdis.ajax.php',
								method:'post',
								async: false,
								data:temp,
								dataType:'html',
								success:function(d){
									//console.log(d);
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'viewtemp-openinv compdis.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var temp=d.split(';');
									if($.isNumeric(temp[0])){
										$('.result #viewwindow #autodis').html(temp[0]);
										$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
										$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
									}
									else{
										$('.result #viewwindow #autodis').html('0');
										$('.result #viewwindow input[name="autodiscontent"]').val('');
										$('.result #viewwindow input[name="autodispremoney"]').val('0');
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e)
								}
							});
						}
						else{
							$('.result #viewwindow #autodis').html('0');
							$('.result #viewwindow input[name="autodiscontent"]').val('');
							$('.result #viewwindow input[name="autodispremoney"]').val('0');
						}
						var flooramt=0;
						flooramt=Number(flooramt)+(parseInt(d['person1'])*Number($('.setperson #view input[name="personfloor1"]').val()));
						flooramt=Number(flooramt)+(parseInt(d['person2'])*Number($('.setperson #view input[name="personfloor2"]').val()));
						flooramt=Number(flooramt)+(parseInt(d['person3'])*Number($('.setperson #view input[name="personfloor3"]').val()));
						$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val(flooramt);
						var total=0;
						var itemdis=0;
						var temptotal=0;
						var tempdis=0;
						var caninilistdis=0;
						var canlistdis=0;
						var cannotlistdis=0;

						var canusemempoint=0;
						var usepoint=0;

						//console.log(d['no'].length);
						for(var i=0;i<d['no'].length;i++){
							total=Number(total)+Number(d['subtotal'][i]);
							itemdis=Number(itemdis)+Number(d['discount'][i]);
							if(d['needcharge'][i]){
								temptotal=Number(temptotal)+Number(d['subtotal'][i]);
								tempdis=Number(tempdis)+Number(d['discount'][i]);
							}
							else{
							}
							if(d['listdis'][i]=='1'){
								caninilistdis=Number(caninilistdis)+Number(d['subtotal'][i]);

								if(Number(d['discount'][i])!=0){//具有單品促銷

									if(Number(d['dispoint'][i])!=0){//有使用單品促銷－點數兌換
										usepoint=parseInt(usepoint)+parseInt(d['dispoint'][i]);
									}
									else{
									}

									if(d['bothdis'][i]=='1'){//允許同時使用單品促銷與帳單折扣(讓)
										canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
									}
									else{
										continue;
									}
								}
								else{
									canlistdis=Number(canlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
								}
							}
							else{
								cannotlistdis=Number(cannotlistdis)+Number(d['subtotal'][i])+Number(d['discount'][i]);
							}
							
							if(d['getpointtype'][i]=='2'){//2020/4/20 品項中多一個屬性，紀錄該品項的集點方式；固定點數、金額點數。本欄位是只計算金額點數
								canusemempoint=parseFloat(canusemempoint)+parseFloat(d['subtotal'][i]);
							}
							else{
							}
						}
						if($('.order#order .initsetting #comfloor').val()=='1'){
							if(Number(total)<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
								$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(total)));
							}
							else{
								$('.result #viewwindow input[name="floorspan"]').val('0');
							}
						}
						else{
							if(Number(d['AMT'])<Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())){
								$('.result #viewwindow input[name="floorspan"]').val((Number($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val())-Number(d['AMT'])));
							}
							else{
								$('.result #viewwindow input[name="floorspan"]').val('0');
							}
						}
						if(Number($('.result #viewwindow input[name="floorspan"]').val())>0){
							var t=confirm('不足低銷，將以低消計算('+$('.result .frontunit').val()+$('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val()+$('.result .unit').val()+')');
							if(t==true){
								$('.result #viewwindow #total').html($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
								$('.result #viewwindow #temptotal').val($('.result #viewwindow .sendviewwindow input[name="ttlfloor"]').val());
								$('.result #viewwindow #itemdis').html('0');
								$('.result #viewwindow #tempdis').val('0');
							}
							else{
								$('.result #viewwindow #total').html(total);
								$('.result #viewwindow #temptotal').val(temptotal);
								$('.result #viewwindow #itemdis').html(-itemdis);
								$('.result #viewwindow #tempdis').val(-tempdis);
							}
							if($('.order#order .initsetting #openchar').val()=='1'){//開啟服務費
								$('.result #viewwindow #charge').html(temparray['charge']);
							}
							else{//關閉服務費
							}
						}
						else{
							$('.result #viewwindow #total').html(total);
							$('.result #viewwindow #temptotal').val(temptotal);
							$('.result #viewwindow #itemdis').html(-itemdis);
							$('.result #viewwindow #tempdis').val(-tempdis);
						}
						$('.result .caninilistdis').val(caninilistdis);
						$('.result .canlistdis').val(canlistdis);
						$('.result .cannotlistdis').val(cannotlistdis);
						$('.result .canusemempoint').val(canusemempoint);
						$('.result .usepoint').val(usepoint);
						$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
						$('.result #viewwindow #charge').html(d['charge']);
						$('.result #viewwindow #listdis1').html('0');
						$('.result #viewwindow #listdis2').html(0-d['listdis2']);
						$('.result #paywindow #paycontent').html('');
						if(typeof d['payment']!=='undefined'){
							var content='';
							if(typeof d['payment']['nidin']!=='undefined'&&typeof d['payment']['nidin']['method']!=='undefined'){
								for(var i=0;i<d['payment']['nidin']['method'].length;i++){
									content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>Nidin</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='nidinother' id='"+d['payment']['nidin']['method'][i]+"'>";
									content=content+d['payment']['nidin']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['nidin']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

									$('.result #paywindow #paycontent').append(content);

									closedisbut();
								}
							}
							else if(typeof d['payment']['intella']!=='undefined'&&typeof d['payment']['intella']['method']!=='undefined'){
								for(var i=0;i<d['payment']['intella']['method'].length;i++){
									content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><!-- <input type='checkbox' name='checkbox'> --></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+d['payment']['intella']['method'][i]+"'>";
									content=content+d['payment']['intella']['money'][i]+"<input type='hidden' name='viewmoney' value='"+d['payment']['intella']['money'][i]+"'></span>"+$('.result .unit').val()+"</div></div></div>";

									$('.result #paywindow #paycontent').append(content);

									closedisbut();
								}
							}
							else{
							}
						}
						else{
						}
						$('.result #viewwindow #already').html('0');
						$('.result #viewwindow #cashmoney').html('0');
						$('.result #viewwindow #cash').html('0');
						$('.result #viewwindow #other').html('0');
						$('.result #viewwindow input[name="already"]').val('0');
						$('.result #viewwindow #should').html(Number(d['amt'])+Number(d['charge']));
						$('.result #viewwindow #notyet').html($('.result #viewwindow #should').html());
						$('.result #viewwindow #change').html('0');

						d['freeinv']=Number(d['freeinv'])-Number($('.result #viewwindow #autodis').html());
						if(d['freeinv']<0){
							d['ininv']=Number(d['ininv'])+Number(d['freeinv']);
							d['freeinv']=0;
						}
						else{
						}
						$('.result #viewwindow #ininv').html(d['ininv']+Number(d['charge'])-Number($('.result #viewwindow #listdis2').html()));
						$('.result #viewwindow input[name="ininv"]').val(d['ininv']);
						$('.result #viewwindow #freeinv').html(d['freeinv']);
						$('.result #viewwindow input[name="freeinv"]').val($('.result #viewwindow #freeinv').html());

						if(typeof d['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
							$('.result #viewwindow input[name="tempcontainer"]').val(d['container']);
						}
						else{
							$('.result #viewwindow input[name="tempcontainer"]').val('');
						}
						if(typeof d['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
							$('.result #viewwindow input[name="tempban"]').val(d['ban']);
						}
						else{
							$('.result #viewwindow input[name="tempban"]').val('');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$('.result .numbox .otherpay').prop('disabled',true);
				$('.result .numbox .otherfunction').prop('disabled',true);
				$('.result .numbox .cashbut').prop('disabled',true);
				$('.result .numbox .moneybut').prop('disabled',true);
				$('.result #funbox #loopbut #name1').html($('.order#order .initsetting #listprintname1').val());
				$('.result #funbox #loopbut #name2').html($('.order#order .initsetting #listprintname2').val());
				$('.result #viewwindow .sendviewwindow input[name="looptype"]').val($('.order#order .initsetting #looptype').val());
				if($('.order#order .initsetting #openchar').val()=='0'){
					$('.result #funbox .chargebut').prop('disabled',true);
					$('.result #funbox .chargebut #name1').html('不收服務費');
					$('.result #funbox #charno').html($('.order#order .initsetting #charge').val());
				}
				else{
					$('.result #funbox .chargebut').prop('disabled',false);
					if($('.order#order .initsetting #charge').val()=='1'&&$('.order#order #content #tabs4 .listcontentbox input[name="listtype"]').val()=='1'){
						$('.result #funbox .chargebut #name1').html('收服務費');
						$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
					}
					else{
						$('.result #funbox .chargebut #name1').html('不收服務費');
						$('.result #funbox #charno').val($('.order#order .initsetting #charge').val());
					}
				}
				$('.result #funbox .receiptbut').prop('disabled',true);
				$('.result .numbox .ban #name1').html('輸入統編');
				$('.result input[name="view"]').val('');
				$('.result input[name="view"]').css({'background-color':'#FFFFFF'});
				$('.result #viewwindow input[name="tempban"]').css({'background-color':'#EFEBDE'});
				$('.result #viewwindow input[name="tempban"]').prop('readonly',true);
				//2021/3/10 提到前面填入
				/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['ban']!=='undefined'){//2021/3/10 nidin訂單消費者指定統編
					$('.result #viewwindow input[name="tempban"]').val(d['payment']['ban']);
				}
				else{
					$('.result #viewwindow input[name="tempban"]').val('');
				}*/
				$('.result #viewwindow input[name="tempcontainer"]').css({'background-color':'#EFEBDE'});
				$('.result #viewwindow input[name="tempcontainer"]').prop('readonly',true);
				//2021/3/10 提到前面填入
				/*if(typeof d['payment']!=='undefined'&&typeof d['payment']['container']!=='undefined'){//2021/3/10 nidin訂單消費者指定載具
					$('.result #viewwindow input[name="tempcontainer"]').val(d['payment']['container']);
				}
				else{
					$('.result #viewwindow input[name="tempcontainer"]').val('');
				}*/
				$('.result .target').val('view');
				$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
				result.dialog('open');
			}
		}
	});
	$('.temptoinv').on('click','#cancel',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('關閉已開發票的暫結單點選加點的確認視窗','click');
		//oneEvent(event);
		temptoinv.dialog('close');
		temptoinv.dialog('option','height',220);
		temptoinv.dialog('option','width',450);
	});
	$('.temptoinv').on('click','#delplus',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('修改已開發票的暫結單','click');
		//oneEvent(event);
		if($('.order#order .initsetting #controltable').val()=='1'){
			$.ajax({
				url:'./lib/js/checktabstate.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					var tempd=d.split('-');
					if(tempd[0]=='unlock'){
						var hint=confirm('該帳單已開發票，如要修改請確認發票正本已收回。');
						if(hint==true){
							if($('.nidin #usenidin').length>0){
								nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
							}
							else{
							}
							$.ajax({//作廢帳單
								url:'./lib/js/salevoid.ajax.php',
								method:'post',
								data:{'bizdate':$('.viewtemp #date').html(),'createdatetime':$('.viewtemp #credate').val(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.viewtemp #listno input[name="memno"]').val(),'remarks':'tempeditsale'},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'viewtemp-delplus salevoid.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									if(d.substr(0,7)=='success'){
										$.ajax({
											url:'./lib/js/getinvname.ajax.php',
											method:'post',
											async:false,
											data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
											dataType:'json',
											success:function(d){
												//console.log(d);
												if(d=='dbempty'){
													$.ajax({
														url:'./lib/js/print.php',
														method:'post',
														data:{'html':'reinv getinvname.ajax.php dbempty'},
														dataType:'html',
														success:function(d){/*console.log(d);*/},
														error:function(e){/*console.log(e);*/}
													});
												}
												else{
													$.ajax({
														url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
														method:'post',
														async:false,
														data:{'invfile':d[1]},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																$.ajax({
																	url:'./lib/js/reinv.ajax.php',
																	method:'post',
																	async:false,
																	data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
																	dataType:'html',
																	success:function(d){
																		//console.log(d);
																		if(d.length>20||d.match('ERROR HINT: ')){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'creditcard reinv.ajax.php '+d},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		}
																		else{
																		}
																	},
																	error:function(e){
																		//console.log(e);
																	}
																});
															}
															else{
															}
															$.ajax({//作廢發票
																url:'./lib/js/deleteinv.ajax.php',
																method:'post',
																data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
																dataType:'html',
																success:function(d){
																	if(d.length>40||d.match('ERROR HINT: ')){
																		$.ajax({
																			url:'./lib/js/print.php',
																			method:'post',
																			data:{'html':'viewtemp-delplus deleteinv.ajax.php '+d},
																			dataType:'html',
																			success:function(d){/*console.log(d);*/},
																			error:function(e){/*console.log(e);*/}
																		});
																	}
																	else{
																	}
																	//console.log(d);
																	//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																	//2017/12/29mywin.document.title='cashdrawer';
																},
																error:function(e){
																	//console.log(e);
																}
															});
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else{
										//console.log(d);
									}
									$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
										url:'./lib/js/copysale.ajax.php',
										method:'post',
										data:{'bizdate':$('.viewtemp #date').html(),'createdatetime':$('.viewtemp #credate').val(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
										dataType:'html',
										success:function(d){
											var t=d.split('-');
											//console.log(t);
											listtype=t[t.length-3];
											bizdate=t[t.length-2];
											consecnumber=t[t.length-1];
											//console.log(d);
											temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
											temptoinv.dialog('close');
											viewtemp.dialog('close');
											//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
										},
										error:function(e){
											//console.log(e);
										}
									});
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}
					}
					else{
						var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
						if(res==true){
							var hint=confirm('該帳單已開發票，如要修改請確認發票正本已收回。');
							if(hint==true){
								if($('.nidin #usenidin').length>0){
									nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
								}
								else{
								}
								$.ajax({//作廢帳單
									url:'./lib/js/salevoid.ajax.php',
									method:'post',
									data:{'bizdate':$('.viewtemp #date').html(),'createdatetime':$('.viewtemp #credate').val(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.viewtemp #listno input[name="memno"]').val(),'remarks':'tempeditsale'},
									dataType:'html',
									success:function(d){
										if(d.length>20||d.match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'viewtemp-delplus salevoid.ajax.php '+d},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
										}
										if(d.substr(0,7)=='success'){
											$.ajax({
												url:'./lib/js/getinvname.ajax.php',
												method:'post',
												async:false,
												data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
												dataType:'json',
												success:function(d){
													//console.log(d);
													if(d=='dbempty'){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'reinv getinvname.ajax.php dbempty'},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
													else{
														$.ajax({
															url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
															method:'post',
															async:false,
															data:{'invfile':d[1]},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
																	$.ajax({
																		url:'./lib/js/reinv.ajax.php',
																		method:'post',
																		async:false,
																		data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
																		dataType:'html',
																		success:function(d){
																			//console.log(d);
																			if(d.length>20||d.match('ERROR HINT: ')){
																				$.ajax({
																					url:'./lib/js/print.php',
																					method:'post',
																					data:{'html':'creditcard reinv.ajax.php '+d},
																					dataType:'html',
																					success:function(d){/*console.log(d);*/},
																					error:function(e){/*console.log(e);*/}
																				});
																			}
																			else{
																			}
																		},
																		error:function(e){
																			//console.log(e);
																		}
																	});
																}
																else{
																}
																$.ajax({//作廢發票
																	url:'./lib/js/deleteinv.ajax.php',
																	method:'post',
																	data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
																	dataType:'html',
																	success:function(d){
																		if(d.length>40||d.match('ERROR HINT: ')){
																			$.ajax({
																				url:'./lib/js/print.php',
																				method:'post',
																				data:{'html':'viewtemp-delplus deleteinv.ajax.php '+d},
																				dataType:'html',
																				success:function(d){/*console.log(d);*/},
																				error:function(e){/*console.log(e);*/}
																			});
																		}
																		else{
																		}
																		//console.log(d);
																		//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
																		//2017/12/29mywin.document.title='cashdrawer';
																	},
																	error:function(e){
																		//console.log(e);
																	}
																});
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
											//console.log(d);
										}
										$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
											url:'./lib/js/copysale.ajax.php',
											method:'post',
											data:{'bizdate':$('.viewtemp #date').html(),'createdatetime':$('.viewtemp #credate').val(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
											dataType:'html',
											success:function(d){
												var t=d.split('-');
												//console.log(t);
												listtype=t[t.length-3];
												bizdate=t[t.length-2];
												consecnumber=t[t.length-1];
												//console.log(d);
												temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
												temptoinv.dialog('close');
												viewtemp.dialog('close');
												//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
											},
											error:function(e){
												//console.log(e);
											}
										});
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
							}
						}
						else{
						}
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			var hint=confirm('該帳單已開發票，如要修改請確認發票正本已收回。');
			if(hint==true){
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({//作廢帳單
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					data:{'bizdate':$('.viewtemp #date').html(),'createdatetime':$('.viewtemp #credate').val(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.viewtemp #listno input[name="memno"]').val(),'remarks':'tempeditsale'},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'viewtemp-delplus salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(d.substr(0,7)=='success'){
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({//作廢發票
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'viewtemp-delplus deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/29mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
							//console.log(d);
						}
						$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
							url:'./lib/js/copysale.ajax.php',
							method:'post',
							data:{'bizdate':$('.viewtemp #date').html(),'createdatetime':$('.viewtemp #credate').val(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
							dataType:'html',
							success:function(d){
								var t=d.split('-');
								//console.log(t);
								listtype=t[t.length-3];
								bizdate=t[t.length-2];
								consecnumber=t[t.length-1];
								//console.log(d);
								temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
								temptoinv.dialog('close');
								viewtemp.dialog('close');
								//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
							},
							error:function(e){
								//console.log(e);
							}
						});
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
			}
		}
	});
	$('.temptoinv').on('click','#buylist',function(event){
		//oneEvent(event);
		if($('.order#order .initsetting #controltable').val()=='1'){
			$.ajax({
				url:'./lib/js/checktabstate.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					var tempd=d.split('-');
					if(tempd[0]=='unlock'){
						temptoinv.dialog('close');
						$('.result input[name="sendtype"]').val('buytemp');
						$.ajax({
							url:'./lib/js/searchlist.member.php',
							method:'post',
							async:false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
							dataType:'json',
							success:function(d){
								//console.log(d);
								$('.order#order #membutton #memberpoint').val(d[0]['point']);
								$('.order#order #membutton #membermoney').val(d[0]['money']);
							},
							error:function(e){
								//console.log(e);
							}
						});
						$.ajax({
							url:'./lib/js/templistdata.ajax.php',
							method:'post',
							async: false,
							data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
							dataType:'json',
							success:function(d){
								if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'temptoinv-buylist templistdata.ajax.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								$('.result #funbox .invbut').prop('disabled',true);
								$('.result #funbox .invbut #name1').html('開立發票');
								$('.result #funbox .invno').val('1');
								if($('.order#order .initsetting #openpay').val()=='1'){
									$('.result .numbox .otherpay').prop('disabled',false);
									for(var i=0;i<$('.paywindow button').length;i++){
										if($('.paywindow button:eq('+i+') input[name="inv"]').length==0||$('.paywindow button:eq('+i+') input[name="inv"]').val()=='1'){
											$('.paywindow button:eq('+i+')').prop('disabled',false);
										}
										else{
											$('.paywindow button:eq('+i+')').prop('disabled',true);
										}
									}
									for(var i=0;i<$('.result .numbox .otherfunction').length;i++){
										if($('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').length==0||$('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').val()=='1'){
											$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',false);
										}
										else{
											$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',true);
										}
									}
								}
								else{
									$('.result .numbox .otherpay').prop('disabled',true);
									$('.result .numbox .otherfunction').prop('disabled',true);
								}
								if($('.order#order .initsetting #cashbut').val()=='1'){
									$('.result .numbox .cashbut').prop('disabled',false);
								}
								else{
									$('.result .numbox .cashbut').prop('disabled',true);
								}
								$('.result .numbox .moneybut').prop('disabled',false);
								$('.result .numbox .ban').prop('disabled',true);
								$('.result .numbox .carrier').prop('disabled',true);
								$('.result .numbox .carrier2').prop('disabled',true);
								$('.result .numbox .donate').prop('disabled',true);
								$('.result #funbox #listdisbutA').prop('disabled',true);
								$('.result #funbox #listdisbutB').prop('disabled',true);
								$('.result #funbox button[class^="listdisbut"]').prop('disabled',true);
								$('.result #funbox .chargebut').prop('disabled',true);
								$('.result #funbox .receiptbut').prop('disabled',true);
								if(typeof d['buyerid']=="undefined"){
									$('.result #viewwindow input[name="tempban"]').val('');
								}
								else{
									if(d['buyerid']!='0000000000'){
										$('.result #viewwindow input[name="tempban"]').val(d['buyerid']);
									}
									else{
										$('.result #viewwindow input[name="tempban"]').val('');
									}
								}
								if(typeof d['carrierid1']=="undefined"){
									$('.result #viewwindow input[name="tempcontainer"]').val('');
								}
								else{
									if(d['carrierid1']!=null||d['carrierid1']!=''){
										$('.result #viewwindow input[name="tempcontainer"]').val(d['carrierid1']);
									}
									else{
										$('.result #viewwindow input[name="tempcontainer"]').val('');
									}
								}
								if(typeof d['item']=="undefined"){
									$('.result #viewwindow #total').html('0');
								}
								else{
									$('.result #viewwindow #total').html(Number(d['item']));
								}
								if(typeof d['temptotal']=="undefined"){
									$('.result #viewwindow #temptotal').val('0');
								}
								else{
									$('.result #viewwindow #temptotal').val(Number(d['temptotal']));
								}
								if(typeof d['disitem']=="undefined"){
									$('.result #viewwindow #itemdis').html('0');
								}
								else{
									$('.result #viewwindow #itemdis').html(0-Number(d['disitem']));
								}
								if(typeof d['discount']=="undefined"){
									$('.result #viewwindow #tempdis').val('0');
								}
								else{
									$('.result #viewwindow #tempdis').val(0-Number(d['discount']));
								}
								if(typeof d['autodis']=="undefined"){
									$('.result #viewwindow #autodis').html('0');
									$('.result #viewwindow input[name="autodiscontent"]').val('');
									$('.result #viewwindow input[name="autodispremoney"]').val('0');
								}
								else{
									$('.result #viewwindow #autodis').html(0-Number(d['autodis']));
									$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
									$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
								}
								$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
								if(typeof d['charge']=="undefined"){
									$('.result #viewwindow #charge').html('0');
								}
								else{
									$('.result #viewwindow #charge').html(d['charge']);
								}
								$('.result #viewwindow #listdis1').html('0');
								if(typeof d['dislist']=="undefined"){//存的是金額，因此放在折讓
									$('.result #viewwindow #listdis2').html('0');
								}
								else{
									$('.result #viewwindow #listdis2').html(0-Number(d['dislist']));
								}
								$('.result #viewwindow #should').html(d['should']);
								$('.result #viewwindow #cashcomm').html('0');
								$('.result #viewwindow #already').html('0');
								$('.result #viewwindow #cashmoney').html('0');
								$('.result #viewwindow #cash').html('0');
								$('.result #viewwindow #other').html('0');
								$('.result #viewwindow input[name="otherstring"]').html('');
								$('.result #viewwindow #notyet').html(d['should']);
								$('.result #viewwindow #change').html('0');
								$('.result #paycontent').html('');
							},
							error:function(e){
								//console.log(e);
							}
						});
						$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
						result.dialog('open');
					}
					else{
						var res=confirm(tempd[1]+'點餐中。\n是否仍要點餐？');
						if(res==true){
							temptoinv.dialog('close');
							$('.result input[name="sendtype"]').val('buytemp');
							$.ajax({
								url:'./lib/js/templistdata.ajax.php',
								method:'post',
								async: false,
								data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'json',
								success:function(d){
									if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temptoinv-buylist templistdata.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									$('.result #funbox .invbut').prop('disabled',true);
									$('.result #funbox .invbut #name1').html('開立發票');
									$('.result #funbox .invno').val('1');
									if($('.order#order .initsetting #openpay').val()=='1'){
										$('.result .numbox .otherpay').prop('disabled',false);
										$('.result .numbox .otherfunction').prop('disabled',false);
									}
									else{
										$('.result .numbox .otherpay').prop('disabled',true);
										$('.result .numbox .otherfunction').prop('disabled',true);
									}
									if($('.order#order .initsetting #cashbut').val()=='1'){
										$('.result .numbox .cashbut').prop('disabled',false);
									}
									else{
										$('.result .numbox .cashbut').prop('disabled',true);
									}
									$('.result .numbox .moneybut').prop('disabled',false);
									$('.result .numbox .ban').prop('disabled',true);
									$('.result .numbox .carrier').prop('disabled',true);
									$('.result .numbox .carrier2').prop('disabled',true);
									$('.result .numbox .donate').prop('disabled',true);
									$('.result #funbox #listdisbutA').prop('disabled',true);
									$('.result #funbox #listdisbutB').prop('disabled',true);
									$('.result #funbox button[class^="listdisbut"]').prop('disabled',true);
									$('.result #funbox .chargebut').prop('disabled',true);
									$('.result #funbox .receiptbut').prop('disabled',true);
									if(typeof d['buyerid']=="undefined"){
										$('.result #viewwindow input[name="tempban"]').val('');
									}
									else{
										if(d['buyerid']!='0000000000'){
											$('.result #viewwindow input[name="tempban"]').val(d['buyerid']);
										}
										else{
											$('.result #viewwindow input[name="tempban"]').val('');
										}
									}
									if(typeof d['carrierid1']=="undefined"){
										$('.result #viewwindow input[name="tempcontainer"]').val('');
									}
									else{
										if(d['carrierid1']!=null||d['carrierid1']!=''){
											$('.result #viewwindow input[name="tempcontainer"]').val(d['carrierid1']);
										}
										else{
											$('.result #viewwindow input[name="tempcontainer"]').val('');
										}
									}
									if(typeof d['item']=="undefined"){
										$('.result #viewwindow #total').html('0');
									}
									else{
										$('.result #viewwindow #total').html(Number(d['item']));
									}
									if(typeof d['temptotal']=="undefined"){
										$('.result #viewwindow #temptotal').val('0');
									}
									else{
										$('.result #viewwindow #temptotal').val(Number(d['temptotal']));
									}
									if(typeof d['disitem']=="undefined"){
										$('.result #viewwindow #itemdis').html('0');
									}
									else{
										$('.result #viewwindow #itemdis').html(0-Number(d['disitem']));
									}
									if(typeof d['tempdis']=="undefined"){
										$('.result #viewwindow #tempdis').val('0');
									}
									else{
										$('.result #viewwindow #tempdis').val(0-Number(d['tempdis']));
									}
									if(typeof d['autodis']=="undefined"){
										$('.result #viewwindow #autodis').html('0');
										$('.result #viewwindow input[name="autodiscontent"]').val('');
										$('.result #viewwindow input[name="autodispremoney"]').val('0');
									}
									else{
										$('.result #viewwindow #autodis').html(0-Number(d['autodis']));
										$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
										$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
									}
									$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
									if(typeof d['charge']=="undefined"){
										$('.result #viewwindow #charge').html('0');
									}
									else{
										$('.result #viewwindow #charge').html(d['charge']);
									}
									$('.result #viewwindow #listdis1').html('0');
									if(typeof d['dislist']=="undefined"){//存的是金額，因此放在折讓
										$('.result #viewwindow #listdis2').html('0');
									}
									else{
										$('.result #viewwindow #listdis2').html(0-Number(d['dislist']));
									}
									$('.result #viewwindow #should').html(d['should']);
									$('.result #viewwindow #cashcomm').html('0');
									$('.result #viewwindow #already').html('0');
									$('.result #viewwindow #cashmoney').html('0');
									$('.result #viewwindow #cash').html('0');
									$('.result #viewwindow #other').html('0');
									$('.result #viewwindow input[name="otherstring"]').html('');
									$('.result #viewwindow #notyet').html(d['should']);
									$('.result #viewwindow #change').html('0');
									$('.result #paycontent').html('');
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							result.dialog('open');
						}
						else{
						}
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			temptoinv.dialog('close');
			$('.result input[name="sendtype"]').val('buytemp');
			$('.memdata #clear').trigger('click');
			$.ajax({
				url:'./lib/js/searchlist.member.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val()},
				dataType:'json',
				success:function(d){
					//console.log(d);
					$('.order#order #membutton #memberpoint').val(d[0]['point']);
					$('.order#order #membutton #membermoney').val(d[0]['money']);
				},
				error:function(e){
					//console.log(e);
				}
			});
			$.ajax({
				url:'./lib/js/templistdata.ajax.php',
				method:'post',
				async: false,
				data:{'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'machine':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
				dataType:'json',
				success:function(d){
					if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-buylist templistdata.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					$('.result #funbox .invbut').prop('disabled',true);
					$('.result #funbox .invbut #name1').html('開立發票');
					$('.result #funbox .invno').val('1');
					if($('.order#order .initsetting #openpay').val()=='1'){
						$('.result .numbox .otherpay').prop('disabled',false);
						for(var i=0;i<$('.paywindow button').length;i++){
							//console.log($('.paywindow button:eq('+i+') input[name="inv"]').val());
							if($('.paywindow button:eq('+i+') input[name="inv"]').length==0||$('.paywindow button:eq('+i+') input[name="inv"]').val()=='1'){
								$('.paywindow button:eq('+i+')').prop('disabled',false);
							}
							else{
								$('.paywindow button:eq('+i+')').prop('disabled',true);
							}
						}
						for(var i=0;i<$('.result .numbox .otherfunction').length;i++){
							if($('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').length==0||$('.result .numbox .otherfunction:eq('+i+') input[name="inv"]').val()=='1'){
								$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',false);
							}
							else{
								$('.result .numbox .otherfunction:eq('+i+')').prop('disabled',true);
							}
						}
					}
					else{
						$('.result .numbox .otherpay').prop('disabled',true);
						$('.result .numbox .otherfunction').prop('disabled',true);
					}
					if($('.order#order .initsetting #cashbut').val()=='1'){
						$('.result .numbox .cashbut').prop('disabled',false);
					}
					else{
						$('.result .numbox .cashbut').prop('disabled',true);
					}
					$('.result .numbox .moneybut').prop('disabled',false);
					$('.result .numbox .ban').prop('disabled',true);
					$('.result .numbox .carrier').prop('disabled',true);
					$('.result .numbox .carrier2').prop('disabled',true);
					$('.result .numbox .donate').prop('disabled',true);
					$('.result #funbox #listdisbutA').prop('disabled',true);
					$('.result #funbox #listdisbutB').prop('disabled',true);
					$('.result #funbox button[class^="listdisbut"]').prop('disabled',true);
					$('.result #funbox .chargebut').prop('disabled',true);
					$('.result #funbox .receiptbut').prop('disabled',true);
					if(typeof d['buyerid']=="undefined"){
						$('.result #viewwindow input[name="tempban"]').val('');
					}
					else{
						if(d['buyerid']!='0000000000'){
							$('.result #viewwindow input[name="tempban"]').val(d['buyerid']);
						}
						else{
							$('.result #viewwindow input[name="tempban"]').val('');
						}
					}
					if(typeof d['carrierid1']=="undefined"){
						$('.result #viewwindow input[name="tempcontainer"]').val('');
					}
					else{
						if(d['carrierid1']!=null||d['carrierid1']!=''){
							$('.result #viewwindow input[name="tempcontainer"]').val(d['carrierid1']);
						}
						else{
							$('.result #viewwindow input[name="tempcontainer"]').val('');
						}
					}
					if(typeof d['item']=="undefined"){
						$('.result #viewwindow #total').html('0');
					}
					else{
						$('.result #viewwindow #total').html(Number(d['item']));
					}
					if(typeof d['temptotal']=="undefined"){
						$('.result #viewwindow #temptotal').val('0');
					}
					else{
						$('.result #viewwindow #temptotal').val(Number(d['temptotal']));
					}
					if(typeof d['disitem']=="undefined"){
						$('.result #viewwindow #itemdis').html('0');
					}
					else{
						$('.result #viewwindow #itemdis').html(0-Number(d['disitem']));
					}
					if(typeof d['discount']=="undefined"){
						$('.result #viewwindow #tempdis').val('0');
					}
					else{
						$('.result #viewwindow #tempdis').val(0-Number(d['discount']));
					}
					if(typeof d['autodis']=="undefined"){
						$('.result #viewwindow #autodis').html('0');
						$('.result #viewwindow input[name="autodiscontent"]').val('');
						$('.result #viewwindow input[name="autodispremoney"]').val('0');
					}
					else{
						$('.result #viewwindow #autodis').html(0-Number(d['autodis']));
						$('.result #viewwindow input[name="autodiscontent"]').val(d['autodiscontent']);
						$('.result #viewwindow input[name="autodispremoney"]').val(d['autodispremoney']);
					}
					$('.result #viewwindow #listtotal').html(Number($('.result #viewwindow #total').html())-Number($('.result #viewwindow #itemdis').html())-Number($('.result #viewwindow #autodis').html()));
					if(typeof d['charge']=="undefined"){
						$('.result #viewwindow #charge').html('0');
					}
					else{
						$('.result #viewwindow #charge').html(d['charge']);
					}
					$('.result #viewwindow #listdis1').html('0');
					if(typeof d['dislist']=="undefined"){//存的是金額，因此放在折讓
						$('.result #viewwindow #listdis2').html('0');
					}
					else{
						$('.result #viewwindow #listdis2').html(0-Number(d['dislist']));
					}
					$('.result #viewwindow #should').html(d['should']);
					$('.result #viewwindow #cashcomm').html('0');
					$('.result #viewwindow #already').html('0');
					$('.result #viewwindow #cashmoney').html('0');
					$('.result #viewwindow #cash').html('0');
					$('.result #viewwindow #other').html('0');
					$('.result #viewwindow input[name="otherstring"]').html('');
					$('.result #viewwindow #notyet').html(d['should']);
					$('.result #viewwindow #change').html('0');
					$('.result #paycontent').html('');
				},
				error:function(e){
					//console.log(e);
				}
			});
			$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
			result.dialog('open');
		}
	});
	$('.temptoinv').on('click','#reserve',function(event){//開立預約單
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('開立預約單','click');
		//oneEvent(event);
		if($('.temptoinv .div input[name="outman"]').val()!=''){
			$('.order#order #tabs4 form[data-id="listform"] input[name="mancode"]').val($('.temptoinv .outmandiv #mancode').val());
			$('.order#order #tabs4 form[data-id="listform"] input[name="manname"]').val($('.temptoinv .div input[name="outman"]').val());
		}
		else{
			$('.order#order #tabs4 form[data-id="listform"] input[name="mancode"]').val('');
			$('.order#order #tabs4 form[data-id="listform"] input[name="manname"]').val('');
		}
		if($('.temptoinv select[name="date"] option:selected').val()=='0'){
			$('.temptoinv #continue').trigger('click');
		}
		else{
			if($('.order#order .initsetting #secview').val()=='1'){
				$.ajax({
					url:'../secview/cleartemp.ajax.php',
					method:'post',
					async: false,
					data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve cleartemp.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
					socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
					console.log('send message "clear" to secview');
				}
				else{
				}
			}
			else{
			}
			var total=0;
			var subtotal=0;
			var qty=0;
			var temptotal=0;
			var tempdis=0;
			$.each($('.order#order #tabs4 form[data-id="listform"] .label'),function(index,value){
				total=Number(total)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
				subtotal=Number(subtotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="subtotal[]"]').val()));
				qty=Number(qty)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="qty[]"]').val()));
				if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="needcharge[]"]').val()=='1'){
					temptotal=Number(temptotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
					tempdis=Number(tempdis)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
				}
				else{
				}
			});
			if($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').length>0&&Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val())==''){
				if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'){
					if($('.order#order .initsetting #chargeeq').val()=='2'){//服務費以折扣後之價格計算
						$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val((Number(temptotal)-Number(tempdis))*Number($('.order#order .initsetting #chargenumber').val())/100);
					}
					else{//服務費以原價格計算
						$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(Number(temptotal)*Number($('.order#order .initsetting #chargenumber').val())/100);
					}
					var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
					/*設定檔內可設定使用何種進位*/
					if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
						$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( roundfun(Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val()),precision));
					}
					else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
						$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( ceilfun(Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val()),precision));
					}
					else{//無條件捨去
						$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( floorfun(Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val()),precision));
					}
				}
				else{
				}
			}
			else{
			}
			var consecnumber='';
			$('.order#order #billfun1 button:eq(4)').prop('disabled',true);
			$.ajax({
				url:'./lib/js/create.tempdb.php',
				method:'post',
				async: false,
				data:$('#tabs4 form[data-id="listform"]').serialize()+'&salelisthint='+$('.order#order #banner #detail #salelisthint').val(),
				dataType:'html',
				success:function(d){
					if(d.length>40||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-reserve create.tempdb.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					var tempd=d.split('-');
					consecnumber=tempd[1];
					if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
						$('.order#order #tabs4 form[data-id="listform"] input[name="saleno"]').val(tempd[0]);
						$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(tempd[1]);
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.temptoinv input[name="printtag"]:checked').length>0){
				var printtag=1;
			}
			else{
				var printtag=0;
			}
			$.ajax({
				url:'./lib/js/reserve.ajax.php',
				method:'post',
				async: false,
				data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':consecnumber,'datetime':$('.temptoinv select[name="date"] option:selected').val()+$('.temptoinv select[name="hour"] option:selected').val()+$('.temptoinv select[name="min"] option:selected').val()+';'+printtag},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-reserve reserve.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
				$.ajax({
					url:'./lib/js/compdis.ajax.php',
					method:'post',
					async: false,
					data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve compdis.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
						var temp=d.split(';');
						if($.isNumeric(temp[0])){
							$.ajax({
								url:'./lib/js/wttempdis.ajax.php',
								method:'post',
								async: false,
								data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':consecnumber,'autodis':temp[0],'autodiscontent':temp[1],'autodispermoney':temp[2]},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temptoinv-reserve wttempdis.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							//$('.result #viewwindow #autodis').html(temp[0]);
							//$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
							//$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e)
					}
				});
			}
			else{
			}
			if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
			}
			else{
				$.ajax({
					url:'./lib/js/create.voidlist.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.voidlist.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			var array1=$('#tabs4 form[data-id="listform"]').serialize();
			if(typeof $('.temptoinv .div input[name="receipt"]')==='undefined'||$('.temptoinv .div input[name="receipt"]:checked').length==0){
			}
			else{
				array1=array1+'&receipt=1';
			}
			$.ajax({
				url:'./lib/js/create.list.php',
				method:'post',
				async: false,
				data:array1,
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-reserve create.list.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
			}
			else{
				$.ajax({
					url:'./lib/js/create.voidkitchen.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'username':$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.voidkitchen.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			$.ajax({
				url:'./lib/js/create.kitchen.php',
				method:'post',
				async: false,
				data:$('#tabs4 form[data-id="listform"]').serialize(),
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-reserve create.kitchen.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.temptoinv input[name="printtag"]:checked').length>0){
				$.ajax({
					url:'./lib/js/create.tag.php',
					method:'post',
					async: false,
					data:$('#tabs4 form[data-id="listform"]').serialize(),
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.tag.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
			}
			if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
			}
			else{
				$.ajax({
					url:'./lib/js/create.voidtempdb.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temptoinv-reserve create.tag.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			if($('.order#order .initsetting #controltable').val()=='1'){
				if($('.order#order .companydata #submachine').length>0){
					location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				}
				else{
					if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
						location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					}
					else{
						location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					}
				}
			}
			else{
				if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val().length>0){
					//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					ClearWindow('','');
				}
				else{
					//location.href='./order.php';
					ClearWindow('','');
				}
				$('.order#order #billfun1 button:eq(4)').prop('disabled',false);
			}
			temptoinv.dialog('close');
			temptoinv.dialog('option','height',220);
		}
	});
	$('.temptoinv').on('click','#continue',function(event){//原始暫結流程
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('外送/自取暫結(開啟預約單功能)','click');
		//oneEvent(event);
		//console.log('1');
		if($('.temptoinv .div input[name="outman"]').val()!=''){
			$('.order#order #tabs4 form[data-id="listform"] input[name="mancode"]').val($('.temptoinv .outmandiv #mancode').val());
			$('.order#order #tabs4 form[data-id="listform"] input[name="manname"]').val($('.temptoinv .div input[name="outman"]').val());
		}
		else{
			$('.order#order #tabs4 form[data-id="listform"] input[name="mancode"]').val('');
			$('.order#order #tabs4 form[data-id="listform"] input[name="manname"]').val('');
		}
		if($('.order#order .initsetting #secview').val()=='1'){
			$.ajax({
				url:'../secview/cleartemp.ajax.php',
				method:'post',
				async: false,
				data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-continue cleartemp.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
				socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
				console.log('send message "clear" to secview');
			}
			else{
			}
		}
		else{
		}
		var total=0;
		var subtotal=0;
		var qty=0;
		var temptotal=0;
		var tempdis=0;
		var nowbizdate=$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val();
		$.each($('.order#order #tabs4 form[data-id="listform"] .label'),function(index,value){
			total=Number(total)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
			subtotal=Number(subtotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="subtotal[]"]').val()));
			qty=Number(qty)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="qty[]"]').val()));
			if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="needcharge[]"]').val()=='1'){
				temptotal=Number(temptotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
				tempdis=Number(tempdis)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
			}
			else{
			}
		});
		if($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').length>0&&Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val())==''){
			if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'&&$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()==1){
				if($('.order#order .initsetting #chargeeq').val()=='2'){//服務費以折扣後之價格計算
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val((Number(temptotal)-Number(tempdis))*Number($('.order#order .initsetting #chargenumber').val())/100);
				}
				else{//服務費以原價格計算
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(Number(temptotal)*Number($('.order#order .initsetting #chargenumber').val())/100);
				}
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				/*設定檔內可設定使用何種進位*/
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( roundfun(Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val()),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( ceilfun(Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val()),precision));
				}
				else{//無條件捨去
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( floorfun(Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val()),precision));
				}
			}
			else{
			}
		}
		else{
		}
		var consecnumber='';
		$('.order#order #billfun1 button:eq(4)').prop('disabled',true);
		$.ajax({
			url:'./lib/js/create.tempdb.php',
			method:'post',
			async: false,
			data:$('#tabs4 form[data-id="listform"]').serialize()+'&salelisthint='+$('.order#order #banner #detail #salelisthint').val(),
			dataType:'html',
			success:function(d){
				if(d.length>40||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'temptoinv-continue create.tempdb.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				var tempd=d.split('-');
				consecnumber=tempd[1];
				if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
					$('.order#order #tabs4 form[data-id="listform"] input[name="saleno"]').val(tempd[0]);
					$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(tempd[1]);
				}
				else{
				}
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
			$.ajax({
				url:'./lib/js/compdis.ajax.php',
				method:'post',
				async: false,
				data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-continue compdis.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					var temp=d.split(';');
					if($.isNumeric(temp[0])){
						$.ajax({
							url:'./lib/js/wttempdis.ajax.php',
							method:'post',
							async: false,
							data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':consecnumber,'autodis':temp[0],'autodiscontent':temp[1],'autodispermoney':temp[2]},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'temptoinv-continue wttempdis.ajax.php '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						//$('.result #viewwindow #autodis').html(temp[0]);
						//$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
						//$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e)
				}
			});
		}
		else{
		}
		if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
		}
		else{
			$.ajax({
				url:'./lib/js/create.voidlist.php',
				method:'post',
				async: false,
				data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-continue create.voidlist.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		$.ajax({
			url:'./lib/js/create.cmdtxt.php',
			method:'post',
			async: false,
			data:{'cmd':nowbizdate.substr(0,6)+'-change'},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		var array1=$('#tabs4 form[data-id="listform"]').serialize();
		if(typeof $('.temptoinv .div input[name="receipt"]')==='undefined'||$('.temptoinv .div input[name="receipt"]:checked').length==0){
		}
		else{
			array1=array1+'&receipt=1';
		}
		$.ajax({
			url:'./lib/js/create.list.php',
			method:'post',
			async: false,
			data:array1,
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'temptoinv-continue create.list.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
		}
		else{
			$.ajax({
				url:'./lib/js/create.voidkitchen.php',
				method:'post',
				async: false,
				data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'username':$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-continue create.voidkitchen.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		$.ajax({
			url:'./lib/js/create.kitchen.php',
			method:'post',
			async: false,
			data:$('#tabs4 form[data-id="listform"]').serialize(),
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'temptoinv-continue create.kitchen.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'./lib/js/create.tag.php',
			method:'post',
			async: false,
			data:$('#tabs4 form[data-id="listform"]').serialize(),
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'temptoinv-continue create.tag.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
		}
		else{
			$.ajax({
				url:'./lib/js/create.voidtempdb.php',
				method:'post',
				async: false,
				data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temptoinv-continue create.voidtempdb.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		if($('.order#order .initsetting #controltable').val()=='1'){
			if($('.order#order .companydata #submachine').length>0){
				location.href='./control.php?submachine&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
			}
			else{
				if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
					location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				}
				else{
					location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				}
			}
		}
		else{
			if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val().length>0){
				//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				ClearWindow('','');
			}
			else{
				//location.href='./order.php';
				ClearWindow('','');
			}
			$('.order#order #billfun1 button:eq(4)').prop('disabled',false);
		}
		temptoinv.dialog('close');
		temptoinv.dialog('option','height',220);
	});
	$('.temptoinv').on('click','#sendlink',function(event){//連接內用帳單
		//console.log('2');
		if($('#tabs4 form[data-id="listform"] input[name="linklist"]').length>0){
			if($('.temptoinv select[name="linklist"] option:selected').val()==''){//不連接內用帳單
				$('#tabs4 form[data-id="listform"] input[name="linklist"]').val('');
			}
			else{
				$('#tabs4 form[data-id="listform"] input[name="linklist"]').val($('.temptoinv select[name="linklist"] option:selected').val());
			}
		}
		else{
			if($('.temptoinv select[name="linklist"] option:selected').val()==''){//不連接內用帳單
			}
			else{
				$('#tabs4 form[data-id="listform"]').append('<input type="hidden" name="linklist" value="'+$('.temptoinv select[name="linklist"] option:selected').val()+'">');
			}
		}
		temptoinv.dialog('close');
		temptoinv.dialog('option','height',220);
		if($('.order#order .initsetting #secview').val()=='1'){
			$.ajax({
				url:'../secview/cleartemp.ajax.php',
				method:'post',
				async: false,
				data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'linklist cleartemp.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
				socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
				console.log('send message "clear" to secview');
			}
			else{
			}
		}
		else{
		}
		var total=0;
		var subtotal=0;
		var qty=0;
		var temptotal=0;
		var tempdis=0;
		$.each($('.order#order #tabs4 form[data-id="listform"] .label'),function(index,value){
			total=Number(total)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
			subtotal=Number(subtotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="subtotal[]"]').val()));
			qty=Number(qty)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="qty[]"]').val()));
			if($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="needcharge[]"]').val()=='1'){
				temptotal=Number(temptotal)+(Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="money[]"]').val())*Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="number[]"]').val()));
				tempdis=Number(tempdis)+Number($('.order#order #tabs4 form[data-id="listform"] .label:eq('+index+') input[name="discount[]"]').val());
			}
			else{
			}
		});
		if($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').length>0&&Number($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val())==''){
			if($('.order#order .initsetting #openchar').val()=='1'&&$('.order#order .initsetting #charge').val()=='1'){
				if($('.order#order .initsetting #chargeeq').val()=='2'){//服務費以折扣後之價格計算
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val((Number(temptotal)-Number(tempdis))*Number($('.order#order .initsetting #chargenumber').val())/100);
				}
				else{//服務費以原價格計算
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(Number(temptotal)*Number($('.order#order .initsetting #chargenumber').val())/100);
				}
				var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
				/*設定檔內可設定使用何種進位*/
				if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( roundfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
				}
				else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( ceilfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
				}
				else{//無條件捨去
					$('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val( floorfun($('.order#order #tabs4 form[data-id="listform"] input[name="charge"]').val(),precision));
				}
			}
			else{
			}
		}
		else{
		}
		var consecnumber='';
		if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
			var posdvrfile='';
		}
		else{
		}
		$('.order#order #billfun1 button:eq(4)').prop('disabled',true);
		//var dbrequery='';
		$.ajax({
			url:'./lib/js/create.tempdb.php',
			method:'post',
			async: false,
			data:$('#tabs4 form[data-id="listform"]').serialize(),
			dataType:'html',
			success:function(d){
				if(d.length>40||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'linklist create.tempdb.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}//database is locked
				//dbrequery=d;
				/*if(dbrequery.match(/database is locked/g)){
					//產生db locked
				}
				else{*/
					var tempd=d.split('-');
					consecnumber=tempd[1];
					if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
						$('.order#order #tabs4 form[data-id="listform"] input[name="saleno"]').val(tempd[0]);
						$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(tempd[1]);
					}
					else{
					}
					if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
						posdvrfile=tempd[2];
					}
					else{
					}
				//}
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		/*if(dbrequery.match(/database is locked/g)){
			//產生db locked
			dblock.dialog('open');
		}
		else{*/
			/*錢都錄借接*/
			//console.log(posdvrfile);
			if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
				/*start tag*/
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					async:false,
					data:{'html':'start posdvr-sendmessage','file':'posdvr'},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){console.log(e);}
				});
				if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
					var res=api_sendmessage_posdvr(posdvrfile);
					//console.log(res);
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'success '+posdvrfile,'file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'error sendmessage is not function','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				/*end tag*/
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					async:false,
					data:{'html':'end posdvr-sendmessage','file':'posdvr'},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
			}
			else{
			}
			if($('.order#order .initsetting #ticketlisttype').val().match($('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val())&&($('.order#order .initsetting #ticket').val()=='1'||$('.order#order .initsetting #ticket').val()=='3')){//出"兌換卷"
				$.ajax({
					url:'./lib/js/create.ticket.php',
					method:'post',
					async:false,
					data:$('#tabs4 form[data-id="listform"]').serialize(),
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temp create.ticket.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						consecnumber=d;
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			else{
			}
			if($('.order#order .initsetting #autodis').val()=='1'){//開啟自動優惠
				$.ajax({
					url:'./lib/js/compdis.ajax.php',
					method:'post',
					async: false,
					data:$('.order#order #tabs4 form[data-id="listform"]').serialize(),
					dataType:'html',
					success:function(d){
						//console.log(d);
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temp compdis.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						var temp=d.split(';');
						if($.isNumeric(temp[0])){
							$.ajax({
								url:'./lib/js/wttempdis.ajax.php',
								method:'post',
								async: false,
								data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':consecnumber,'autodis':temp[0],'autodiscontent':temp[1],'autodispermoney':temp[2]},
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temp wttempdis.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							//$('.result #viewwindow #autodis').html(temp[0]);
							//$('.result #viewwindow input[name="autodiscontent"]').val(temp[1]);
							//$('.result #viewwindow input[name="autodispremoney"]').val(temp[2]);
						}
						else{
							//console.log('fail');
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e)
					}
				});
			}
			else{
			}
			if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
			}
			else{
				$.ajax({
					url:'./lib/js/create.voidlist.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temp create.voidlist.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			$.ajax({
				url:'./lib/js/create.list.php',
				method:'post',
				async: false,
				data:$('#tabs4 form[data-id="listform"]').serialize(),
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temp create.list.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
			}
			else{
				$.ajax({
					url:'./lib/js/create.voidkitchen.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'username':$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temp create.voidkitchen.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			$.ajax({
				url:'./lib/js/create.kitchen.php',
				method:'post',
				async: false,
				data:$('#tabs4 form[data-id="listform"]').serialize(),
				dataType:'html',
				success:function(d){
					//console.log(d);
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temp create.kitchen.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
			$.ajax({
				url:'./lib/js/create.tag.php',
				method:'post',
				async: false,
				data:$('#tabs4 form[data-id="listform"]').serialize(),
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temp create.tag.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if($('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val()==''){
			}
			else{
				$.ajax({
					url:'./lib/js/create.voidtempdb.php',
					method:'post',
					async: false,
					data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'temp create.voidtempdb.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
			/*$.ajax({
				url:'./lib/js/create.cmdtxt.php',
				method:'post',
				async: false,
				data:{'cmd':'report'},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});*/
			if($('.order#order .initsetting #controltable').val()=='1'){
				/*if($('.order#order .companydata #submachine').length>0){
					location.href='./control.php?submachine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
				}
				else{
					if($('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()=='m1'){
						location.href='./control.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					}
					else{
						location.href='./control.php?machine='+$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()+'&usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					}
				}*/
				inittable.dialog('open');
				ClearWindow('','');
			}
			else{
				if($('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val().length>0){
					//location.href='./order.php?usercode='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #MemberBill #tabs4 form[data-id="listform"] input[name="username"]').val();
					ClearWindow('','');
				}
				else{
					//location.href='./order.php';
					ClearWindow('','');
				}
			}
			$('.order#order #billfun1 button:eq(4)').prop('disabled',false);
			if($('.order#order .initsetting #controltable').val()=='1'){
				var buttype='b';
			}
			else{
				var buttype='a';
			}
			$.ajax({
				url:'./lib/js/change.button4.php',
				method:'post',
				data:{'type':buttype},
				dataType:'json',
				success:function(d){
					if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
						$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
					}
					else{
					}
					if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
						$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[1]);
					}
					else{
					}
					if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
						if(buttype=='a'){
							$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
						}
						else{
							$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
						}
					}
					else{
					}
					$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
				},
				error:function(e){
					//console.log(e);
				}
			});
		//}
	});
	$('.result .numbox').on('click','.carrier',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面手機載具','click');
		//oneEvent(event);
		container.dialog('open');
	});
	$('.container #check').click(function(){
		$('.container input[name="containercode"]').val($('.container input[name="containercode"]').val().replace("/",""));
		$('.container input[name="containercode"]').val($('.container input[name="containercode"]').val().toUpperCase());
		if($('.container input[name="containercode"]').val().length==(Number($('.order#order .initsetting #container1').val())-1)&&$('.container input[name="containercode"]').val().match(/[0-9A-Z\.\+\-]{7}/)){
			$('.result #viewwindow input[name="tempcontainer"]').val('/'+$('.container input[name="containercode"]').val());
			$('.container input[name="containercode"]').val('');
			container.dialog('close');
			$.ajax({
				url:'../secview/writeban.ajax.php',
				method:'post',
				data:{'tempban':$('.result #viewwindow input[name="tempcontainer"]').val(),'machinetype':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'ban writeban.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else if($('.container input[name="containercode"]').val().length==0){
			$('.result #viewwindow input[name="tempcontainer"]').val('');
			$('.container input[name="containercode"]').val('');
			container.dialog('close');
			$.ajax({
				url:'../secview/writeban.ajax.php',
				method:'post',
				data:{'tempban':'','machinetype':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'ban writeban.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			$.ajax({
				url:'./lib/js/print.php',
				method:'post',
				data:{'html':'container(phone) error code : '+$('.container input[name="containercode"]').val()},
				dataType:'html',
				success:function(d){/*console.log(d);*/},
				error:function(e){/*console.log(e);*/}
			});
			$('.alertmessage #text').html('條碼格式不符。');
			alertmessage.dialog('open');
		}
	});
	$('.container #cancel').click(function(){
		$('.container input[name="containercode"]').val('');
		container.dialog('close');
	});
	$('.result .numbox').on('click','.carrier2',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面自然人憑證','click');
		//oneEvent(event);
		container2.dialog('open');
	});
	$('.container2 #check').click(function(){
		if($('.container2 input[name="containercode"]').val().length==$('.order#order .initsetting #container2').val()&&$('.container2 input[name="containercode"]').val().match(/[A-Za-z]{2}[0-9]{14}/g)){
			$('.result #viewwindow input[name="tempcontainer"]').val($('.container2 input[name="containercode"]').val().toUpperCase());
			$('.container2 input[name="containercode"]').val('');
			container2.dialog('close');
		}
		else if($('.container2 input[name="containercode"]').val().length==0){
			$('.result #viewwindow input[name="tempcontainer"]').val('');
			$('.container2 input[name="containercode"]').val('');
			container2.dialog('close');
		}
		else{
		}
	});
	$('.container2 #cancel').click(function(){
		$('.container2 input[name="containercode"]').val('');
		container2.dialog('close');
	});
	$('.result .numbox').on('click','.donate',function(event){
		if($('.order#order .initsetting #steplog').val()=='1')writesteplog('結帳畫面愛心碼','click');
		//oneEvent(event);
		donatewin.dialog('open');
	});
	$(document).on('keydown','.donatewin input[name="containercode"]',function(event){
		if(event.which==13){
			$.ajax({
				url:'./lib/js/searchdonate.ajax.php',
				method:'post',
				async:false,
				data:{'code':$('.donatewin input[name="containercode"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
					if(d.match(/,/)){
						var temp=d.split(',');
						if(temp[3]==''){
							$('.donatewin input[name="label"]').val(temp[1]);
						}
						else{
							$('.donatewin input[name="label"]').val(temp[3]);
						}
					}
					else{
					}
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
			//console.log('1');
			$('.donatewin input[name="label"]').val('');
		}
	});
	$('.donatewin #check').click(function(){
		if($('.donatewin input[name="label"]').val()!=''){
			$('.result #viewwindow input[name="tempban"]').val('');
			$('.result #viewwindow input[name="tempcontainer"]').val($('.donatewin input[name="containercode"]').val().toUpperCase());
			$('.donatewin input[name="containercode"]').val('');
			$('.donatewin input[name="label"]').val('');
			donatewin.dialog('close');
		}
		else if($('.donatewin input[name="containercode"]').val().length==0){
			$('.result #viewwindow input[name="tempcontainer"]').val('');
			$('.donatewin input[name="containercode"]').val('');
			$('.donatewin input[name="label"]').val('');
			donatewin.dialog('close');
		}
		else{
		}
	});
	$('.donatewin #cancel').click(function(){
		$('.donatewin input[name="containercode"]').val('');
		$('.donatewin input[name="label"]').val('');
		donatewin.dialog('close');
	});
	$('.order#order #content #list #funbox #webbooking').click(function(event){
		//oneEvent(event);
		//if($('.order#order .initsetting #loopding').val()=='1'){//2021/11/3 循環播放提示音
			/*if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
			}
			else{*///2022/9/28 直接暫停播放提示音，無論是否有播放提示音
				$('.order#order #content #list #funbox #player')[0].pause();
			//}
		/*}
		else{
		}*/
		$('.webbooking').dialog('open');
		if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
		}
		else if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'){
			nidin_loop();
			nidin_listnumberloop();
		}
		else{
		}
		
		if($('.order#order .initsetting #quickclick').val()=='1'&&$('.order#order .initsetting #quickclicklisttype').val()=='1'){//2022/6/1 QuickClick訂單手動接單
			quickclick_loop();
			quickclick_listnumberloop();
		}
		else{
		}
		if(($('.webbooking #nidin .remaining .remainingtable #remainingnumber').length>0&&parseInt($('.webbooking #nidin .remaining .remainingtable #remainingnumber').html(),10)>0)||($('.webbooking #quickclick .remaining .remainingtable #remainingnumber').length>0&&parseInt($('.webbooking #quickclick .remaining .remainingtable #remainingnumber').html(),10)>0)){
			//console.log('1');
		}
		else if($('.webbooking #nidin .remaining .remainingtable #remainingnumber').length>0&&parseInt($('.webbooking #nidin .remaining .remainingtable #remainingnumber').html(),10)<=0){
			//2022/11/17 不顯示退訂通知
			/*if($('.order#order #content #list #funbox #point').css('background-color')=='rgb(255, 0, 0)'){//2022/9/28  nidin若訂單數為0，則顯示退訂通知
				$('.alertmessage #text').html('Nidin退訂通知！');
				alertmessage.dialog('open');
			}
			else{
				//console.log('2');
			}*/
		}
		else if($('.webbooking #quickclick .remaining .remainingtable #remainingnumber').length>0&&parseInt($('.webbooking #quickclick .remaining .remainingtable #remainingnumber').html(),10)<=0){
			/*if($('.order#order #content #list #funbox #point').css('background-color')=='rgb(255, 0, 0)'){//2022/9/28  quickclick若訂單數為0，則不額外顯示退訂通知
				$('.alertmessage #text').html('退訂通知！');
				alertmessage.dialog('open');
			}
			else{
				//console.log('2');
			}*/
		}
		else{
		}
		$('.order#order #content #list #funbox #webbooking').prop('disabled',true);
		$('.order#order #content #list #funbox #point').css({'background-color':'transparent','z-index':'0'});
		$('.order#order #content #list #funbox #point').html('');
	});
	$('.webbooking #nidin .listheader').on('click','.accept',function(){
		//if($('.order#order .initsetting #loopding').val()=='1'){//2021/11/3 循環播放提示音
			if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
			}
			else{
				$('.order#order #content #list #funbox #player')[0].pause();
			}
		/*}
		else{
		}*/
		var orderid=$('.webbooking #nidin .listheader .headertable #orderid').val();
		//console.log('orderid= '+orderid);
		var res='';
		$('.webbooking #nidin .listheader .accept').prop('class','disaccept');
		$('.webbooking #nidin .listheader .reject').prop('class','disreject');
		//if($('.webbooking #nidin .listheader .headertable #listspace').html()=='Nidin'){//2022/5/25 依照訂單平台對應相對的API接單
			res=nidin_getthelist(orderid);
			res.done(function(){
				if(getthelistdata!=""&&getthelistdata['order']['order_info']['status']==10){
					var consecnumber='';
					var saleno='';
					$.ajax({
						url:'./lib/api/nidin/trandata.php',
						method:'post',
						async:false,
						cache:false,
						data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machinetype':$('.order#order .companydata #terminalnumber').val(),'membertype':$('.order#order .initsetting #membertype').val(),'getlistarray':getthelistdata,'initpower':$('.order#order .companydata #initpower').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							$.ajax({
								url:'./lib/js/create.tempdb.php',
								method:'post',
								async: false,
								data:d,
								dataType:'html',
								success:function(d){
									if(d.length>40||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temptoinv-continue create.tempdb.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var tempd=d.split('-');
									saleno=tempd[0];
									consecnumber=tempd[1];
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							delete d['listtotal'];//2021/8/13 出單不使用該值，寫資料庫時強制使用，方便折扣寫入，因為nidin的折扣流程與我們不同
							//2021/3/10 所有單下載都進暫結單且不自動開發票
							//if(d['payment']['payment_status']!=11){
								//nidin_finish(d['bizdate'],consecnumber,'','');
								$.ajax({
									url:'./lib/api/nidin/nidin_paymentmethod.php',
									method:'post',
									async:false,
									data:{'bizdate':d['bizdate'],'consecnumber':consecnumber,'payment':d['payment']},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							/*}
							else{
							}*/
							$.ajax({
								url:'./lib/js/create.list.php',
								method:'post',
								async:false,
								data:d,
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temp create.list.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({
								url:'./lib/js/create.tag.php',
								method:'post',
								async:false,
								data:d,
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temp create.list.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({
								url:'./lib/js/create.kitchen.php',
								method:'post',
								async:false,
								data:d,
								dataType:'html',
								success:function(d){
									if(d.length>20||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'temp create.list.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});

					res=nidin_accept(orderid,consecnumber,saleno,$('.order#order .companydata #terminalnumber').val());
					res.done(function(){
						if($('.nidin #autoaccept').length<=0||$('.nidin #autoaccept').val()=='0'){//2022/3/16 nidin訂單手動接單
							$('.alertmessage #text').html('接受訂單。');
							alertmessage.dialog('open');
							nidin_loop();
							nidin_listnumberloop();
						}
						else{//2022/3/16 nidin訂單自動接單，不顯示狀態
							success_prompt('新訂單通知');
							//console.log('new program1');
							autoaccept();//2022/3/16 放在這裡確保所有程序都結束才執行
						}
					});
				}
				else{
					nidin_loop();
					nidin_listnumberloop();
					
					if($('.nidin #autoaccept').length<=0||$('.nidin #autoaccept').val()=='0'){//2022/3/16 nidin訂單手動接單
						switch(getthelistdata['order']['order_info']['status']){
							case 9:
								//$('.system .message').html('該訂單 已取消(使用者取消)。');
								$('.alertmessage #text').html('該訂單 已取消(使用者取消)。');
								alertmessage.dialog('open');
								break;
							case 11:
								//$('.system .message').html('該訂單 已接單。');
								$('.alertmessage #text').html('該訂單 已接單。');
								alertmessage.dialog('open');
								break;
							case 12:
								//$('.system .message').html('該訂單 已退訂。');
								$('.alertmessage #text').html('該訂單 已退訂。');
								alertmessage.dialog('open');
								break;
							case 13:
								//$('.system .message').html('該訂單 已完成)。');
								$('.alertmessage #text').html('該訂單 已完成)。');
								alertmessage.dialog('open');
								break;
							case 14:
								//$('.system .message').html('該訂單 已作廢。');
								$('.alertmessage #text').html('該訂單 已作廢。');
								alertmessage.dialog('open');
								break;
							default:
								break;
						}
					}
					else{//2022/3/16 nidin訂單自動接單，不顯示狀態
						//console.log('new program2');
						autoaccept();//2022/3/16 放在這裡確保所有程序都結束才執行
					}
				}
			});
		/*}
		else{
		}*/
	});
	$('.webbooking #nidin .listheader').on('click','.reject',function(){
		//if($('.order#order .initsetting #loopding').val()=='1'){//2021/11/3 循環播放提示音
			if($('.nidin #usenidin').length>0&&$('.nidin #usenidin').val()=='1'&&$('.nidin #autoaccept').length>0&&$('.nidin #autoaccept').val()=='1'){//2022/3/16 直接將nidin訂單下載至暫結並出單
			}
			else{
				$('.order#order #content #list #funbox #player')[0].pause();
			}
		/*}
		else{
		}*/
		var orderid=$('.webbooking #nidin .listheader .headertable #orderid').val();
		var res='';
		$('.webbooking #nidin .listheader .accept').prop('class','disaccept');
		$('.webbooking #nidin .listheader .reject').prop('class','disreject');
		//if($('.webbooking #nidin .listheader .headertable #listspace').html()=='Nidin'){//2022/5/25 依照訂單平台對應相對的API接單
			res=nidin_getthelist(orderid);
			res.done(function(){
				if(getthelistdata!=""&&getthelistdata['order']['order_info']['status']==10){
					res=nidin_reject(orderid);
					res.done(function(){
						$('.alertmessage #text').html('拒絕訂單。');
						alertmessage.dialog('open');
						nidin_loop();
						nidin_listnumberloop();
					});
				}
				else{
					nidin_loop();
					nidin_listnumberloop();

					switch(getthelistdata['order']['order_info']['status']){
						case 9:
							$('.alertmessage #text').html('該訂單 已取消(使用者取消)。');
							alertmessage.dialog('open');
							break;
						case 11:
							$('.alertmessage #text').html('該訂單 已接單。');
							alertmessage.dialog('open');
							break;
						case 12:
							$('.alertmessage #text').html('該訂單 已退訂。');
							alertmessage.dialog('open');
							break;
						case 13:
							$('.alertmessage #text').html('該訂單 已完成)。');
							alertmessage.dialog('open');
							break;
						case 14:
							$('.alertmessage #text').html('該訂單 已作廢。');
							alertmessage.dialog('open');
							break;
						default:
							break;
					}
				}
			});
		/*}
		else{
		}*/
	});
	//2021/2/24 將原先功能與按鈕移除，換至外部網路訂單接口按鈕
	/*$('.order#order #MemberBill #billfun #citybox #billfun1').on('click','#weborder',function(event){
		//oneEvent(event);
		$('.order#order #content #MemberBill #billfun #billfun1 #weborder').prop('disabled',true);
		$('.order#order #content #MemberBill #billfun #billfun1 #point').css({'background-color':'transparent','z-index':'0'});
		$('.order#order #content #MemberBill #billfun #billfun1 #point').html('');
		$.ajax({
			url:'./lib/js/lockdb.ajax.php',
			async:false,
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'http://api.tableplus.com.tw/outposandorder/demopos/lib/js/downweb.ajax.php',
			method:'post',
			async:false,
			data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val()},
			dataType:'json',
			success:function(d){
				//console.log(d);
				if(d=='empty'){
				}
				else{
					d[-1]=$('.order#order .companydata #company').val();
					d[-2]=$('.order#order .companydata #story').val();
					//console.log(d);
					$.ajax({
						url:'./lib/js/pushlistdata.ajax.php',
						method:'post',
						async:false,
						data:{'data':d,'machinetype':'rightnow'},
						dataType:'json',
						success:function(d){
							//console.log(d);
							$.ajax({
								url:'http://api.tableplus.com.tw/outposandorder/demopos/lib/js/changeweb.ajax.php',
								method:'post',
								data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':d},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
		$.ajax({
			url:'./lib/js/unlockdb.ajax.php',
			async:false,
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});*/
	$('.webbooking #quickclick .listheader').on('click','.accept',function(){
		if($('.order#order .initsetting #quickclick').val()=='1'&&$('.order#order .initsetting #quickclicklisttype').val()=='1'){//2022/6/1 QuickClick訂單手動接單
			$('.order#order #content #list #funbox #player')[0].pause();
		}
		else{
		}
		var orderid=$('.webbooking #quickclick .listheader .headertable #orderid').val();
		//console.log('orderid= '+orderid);
		var res='';
		$('.webbooking #quickclick .listheader .accept').prop('class','disaccept');
		$('.webbooking #quickclick .listheader .reject').prop('class','disreject');
		//if($('.webbooking #quickclick .listheader .headertable #listspace').html()=='QuickClick'){//2022/6/1 因為利用分頁把平台單區分開來，不用再利用該參數判斷//2022/5/25 依照訂單平台對應相對的API接單
			var consecnumber='';
			var saleno='';
			$.ajax({
				url:'./lib/api/quickclick/trandata.php',
				method:'post',
				async:false,
				cache:false,
				data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machinetype':$('.order#order .companydata #terminalnumber').val(),'membertype':$('.order#order .initsetting #membertype').val(),'getlistarray':getlistarrayQ,'initpower':$('.order#order .companydata #initpower').val()},
				dataType:'json',
				success:function(d){
					//console.log(d);
					$.ajax({
						url:'./lib/js/create.tempdb.php',
						method:'post',
						async: false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>40||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'temptoinv-continue create.tempdb.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							var tempd=d.split('-');
							saleno=tempd[0];
							consecnumber=tempd[1];
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					delete d['listtotal'];//2021/8/13 出單不使用該值，寫資料庫時強制使用，方便折扣寫入，因為nidin的折扣流程與我們不同
					//2021/3/10 所有單下載都進暫結單且不自動開發票
					$.ajax({
						url:'./lib/js/create.list.php',
						method:'post',
						async:false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'temp create.list.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.tag.php',
						method:'post',
						async:false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'temp create.list.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/js/create.kitchen.php',
						method:'post',
						async:false,
						data:d,
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'temp create.list.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				},
				error:function(e){
					//console.log(e);
				}
			});

			res=quickclick_accept(orderid);
			res.done(function(){
				webbooking_cleardata('quickclick');
				$('.alertmessage #text').html('接受訂單。');
				alertmessage.dialog('open');
				quickclick_loop();
				quickclick_listnumberloop();
			});
		/*}
		else{
		}*/
	});
	$('.webbooking #quickclick .listheader').on('click','.reject',function(){
		if($('.order#order .initsetting #quickclick').val()=='1'&&$('.order#order .initsetting #quickclicklisttype').val()=='1'){//2022/6/1 QuickClick訂單手動接單
			$('.order#order #content #list #funbox #player')[0].pause();
		}
		else{
		}
		var orderid=$('.webbooking #quickclick .listheader .headertable #orderid').val();
		var res='';
		$('.webbooking #quickclick .listheader .accept').prop('class','disaccept');
		$('.webbooking #quickclick .listheader .reject').prop('class','disreject');
		//if($('.webbooking #quickclick .listheader .headertable #listspace').html()=='Nidin'){//2022/5/25 依照訂單平台對應相對的API接單
			res=quickclick_reject(orderid);
			res.done(function(){
				webbooking_cleardata('quickclick');
				$('.alertmessage #text').html('拒絕訂單。');
				alertmessage.dialog('open');
				quickclick_loop();
				quickclick_listnumberloop();
			});
		/*}
		else{
		}*/
	});
	$('.order#order #MemberBill #billfun #citybox #billfun3 #historypaper').click(function(){
		historypaper.dialog('open');
	});
	$('.historypaper select[name="paperlist"]').change(function(){
		$('.historypaper select[name="zcounter"] option').prop('selected',false);
		$('.historypaper select[name="zcounter"] option:eq(0)').prop('selected',true);
		if($('.historypaper select[name="paperlist"] option:selected').val()!='paper5'){//2022/1/4 非A1倉庫庫存表
			$('.historypaper select[name="zcounter"]').attr('disabled',false);
			$('.historypaper #papbizdateS').attr('disabled',false);
			$('.historypaper #papbizdateE').attr('disabled',false);
		}
		else{
			$('.historypaper select[name="zcounter"]').attr('disabled',true);
			$('.historypaper #papbizdateS').attr('disabled',true);
			$('.historypaper #papbizdateE').attr('disabled',true);
		}
	});
	$('.historypaper #cancel').click(function(){
		historypaper.dialog('close');
	});
	$('.historypaper #send').click(function(){
		if($('.historypaper select[name="paperlist"] option:selected').val()=='paper5'){//2022/1/4 A1倉庫庫存表
			$.ajax({
				url:'./lib/js/getmenudarray.erp.php',
				async:false,
				cache:false,
				dataType:'json',
				success:function(d){
					//console.log(d);
					waitstockload.dialog('open');//先開啟讀取畫面卡住操作流程
					var stock={};
					var ok=0;
					if(d!=''){
						for(var i=0;i<d.length;i++){
							stock[d[i]['inumber']]={};
							stock[d[i]['inumber']]['name']=d[i]['name'];
							stock[d[i]['inumber']]['qty']='';
							$.ajax({
								url:'./lib/js/geterpstock.ajax.php',
								method:'post',
								cache:false,
								data:{'number':d[i]['inumber'],'erpcode':d[i]['erpcode']},
								dataType:'json',
								success:function(t){
									//console.log(t);
									if(typeof t['Qty']!=="undefined"){
										stock[t['inumber']]['qty']=t['Qty'];
									}
									else{
										stock[t['inumber']]['qty']='N/A';
									}
								},
								error:function(e){
									//console.log(e);
								},
								complete:function(){
									ok++;
								}
							});
						}
						var checkdata=setInterval(function(){
							if(ok==d.length){
								clearInterval(checkdata);
								//console.log(stock);
								$.ajax({
									url:'./lib/js/print.erpstock.php',
									method:'post',
									async:false,
									data:{'stockdata':JSON.stringify(stock)},
									dataType:'html',
									success:function(d){
										console.log(d);
									},
									error:function(e){
										console.log(e);
									},
									complete:function(){
										waitstockload.dialog('close');//關閉讀取畫面
									}
								});
							}
							else{
								//console.log('ok= '+ok);
								//console.log('length= '+d.length);
								if($('.waitstockload .loadingdot').html()=='...'){
									$('.waitstockload .loadingdot').html('.');
								}
								else{
									$('.waitstockload .loadingdot').append('.');
								}
								$('.waitstockload .loadingtext').html(ok);
								$('.waitstockload .loadinggoal').html(d.length);
							}
						},500);
					}
					else{
					}
				},
				error:function(e){
					console.log(e);
				}
			});
		}
		else if(parseInt($('.historypaper #papbizdateS').val().substr(0,4))-parseInt($('.historypaper #papbizdateE').val().substr(0,4))==0&&parseInt($('.historypaper #papbizdateS').val().substr(5,2))-parseInt($('.historypaper #papbizdateE').val().substr(5,2))==0){
			if(parseInt($('.historypaper #papbizdateS').val().replace(/-/g,''))<=parseInt($('.historypaper #papbizdateE').val().replace(/-/g,''))){
				if($('.order#order .initsetting #voidsale').val()=='0'){
					if($('.historypaper select[name="paperlist"] option:selected').val()=='paper1'){
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile='';
						}
						else{
						}
						$.ajax({
							url:'./lib/js/shift.paper.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
								if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
									var tempd=d.split('-');
									posdvrfile=tempd[0];
								}
								else{
								}
							},
							error:function(e){
								//console.log(e);
							}
						});
						/*錢都錄借接*/
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							/*start tag*/
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'start posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){
									//console.log(e);
								}
							});
							if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
								var res=api_sendmessage_posdvr(posdvrfile);
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'success '+posdvrfile,'file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'error sendmessage is not function','file':'posdvr'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							/*end tag*/
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'end posdvr-sendmessage','file':'posdvr'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
					}
					else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper2'){
						$.ajax({
							url:'./lib/js/hispaper2.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper3'){
						$.ajax({
							url:'./lib/js/hispaper3.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper4'){
						$.ajax({
							url:'./lib/js/hispaper4.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
				}
				else{
					$('.verpsw input[name="type"]').val('paper');
					verpsw.dialog('open');
				}
			}
			else{
				if($('.sysmeg #name1.syshint5').length>0){
					$('.sysmeg #name1.syshint5').css({'display':''});
				}
				else{
				}
				if($('.sysmeg #name2.syshint5').length>0){
					$('.sysmeg #name2.syshint5').css({'display':''});
				}
				else{
				}
				sysmeg.dialog('open');
			}
		}
		else{
			if($('.sysmeg #name1.syshint6').length>0){
				$('.sysmeg #name1.syshint6').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint6').length>0){
				$('.sysmeg #name2.syshint6').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
		}
	});
	$('.historypaper #view').click(function(){
		//viewpaper.dialog('open');
		if($('.historypaper select[name="paperlist"] option:selected').val()=='paper5'){//2022/1/4 A1倉庫庫存表
			$.ajax({
				url:'./lib/js/getmenudarray.erp.php',
				async:false,
				cache:false,
				dataType:'json',
				success:function(d){
					//console.log(d);
					waitstockload.dialog('open');//先開啟讀取畫面卡住操作流程
					var stock={};
					var ok=0;
					if(d!=''){
						for(var i=0;i<d.length;i++){
							stock[d[i]['inumber']]={};
							stock[d[i]['inumber']]['name']=d[i]['name'];
							stock[d[i]['inumber']]['qty']='';
							$.ajax({
								url:'./lib/js/geterpstock.ajax.php',
								method:'post',
								cache:false,
								data:{'number':d[i]['inumber'],'erpcode':d[i]['erpcode']},
								dataType:'json',
								success:function(t){
									//console.log(t);
									if(typeof t['Qty']!=="undefined"){
										stock[t['inumber']]['qty']=t['Qty'];
									}
									else{
										stock[t['inumber']]['qty']='N/A';
									}
								},
								error:function(e){
									//console.log(e);
								},
								complete:function(){
									ok++;
								}
							});
						}
						var checkdata=setInterval(function(){
							if(ok==d.length){
								clearInterval(checkdata);
								//console.log(stock);
								/*view stock table*/
								$.ajax({
									url:'./lib/js/print.erpstock.php',
									method:'post',
									async:false,
									data:{'type':'view','stockdata':JSON.stringify(stock)},
									dataType:'html',
									success:function(d){
										$('.viewpaper').html(d);
										viewpaper.dialog('open');
									},
									error:function(e){
										console.log(e);
									},
									complete:function(){
										waitstockload.dialog('close');//關閉讀取畫面
									}
								});
							}
							else{
								//console.log('ok= '+ok);
								//console.log('length= '+d.length);
								if($('.waitstockload .loadingdot').html()=='...'){
									$('.waitstockload .loadingdot').html('.');
								}
								else{
									$('.waitstockload .loadingdot').append('.');
								}
								$('.waitstockload .loadingtext').html(ok);
								$('.waitstockload .loadinggoal').html(d.length);
							}
						},500);
					}
					else{
					}
				},
				error:function(e){
					console.log(e);
				}
			});
		}
		else if(parseInt($('.historypaper #papbizdateS').val().substr(0,4))-parseInt($('.historypaper #papbizdateE').val().substr(0,4))==0&&parseInt($('.historypaper #papbizdateS').val().substr(5,2))-parseInt($('.historypaper #papbizdateE').val().substr(5,2))==0){
			if(parseInt($('.historypaper #papbizdateS').val().replace(/-/g,''))<=parseInt($('.historypaper #papbizdateE').val().replace(/-/g,''))){
				if($('.order#order .initsetting #voidsale').val()=='0'){
					if($('.historypaper select[name="paperlist"] option:selected').val()=='paper1'){
						$.ajax({
							url:'./lib/js/shift.paper.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								$('.viewpaper').html(d);
								viewpaper.dialog('open');
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper2'){
						$.ajax({
							url:'./lib/js/hispaper2.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								$('.viewpaper').html(d);
								viewpaper.dialog('open');
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper3'){
						$.ajax({
							url:'./lib/js/hispaper3.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								$('.viewpaper').html(d);
								viewpaper.dialog('open');
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if($('.historypaper select[name="paperlist"] option:selected').val()=='paper4'){
						$.ajax({
							url:'./lib/js/hispaper4.php',
							method:'post',
							async:false,
							data:{'machinename':$('.order#order .companydata #terminalnumber').val(),'type':'view','papbizdateS':$('.historypaper #papbizdateS').val().replace(/-/g,''),'papbizdateE':$('.historypaper #papbizdateE').val().replace(/-/g,''),'zcounter':$('.historypaper select[name="zcounter"] option:selected').val()},
							dataType:'html',
							success:function(d){
								$('.viewpaper').html(d);
								viewpaper.dialog('open');
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
				}
				else{
					$('.verpsw input[name="type"]').val('viewpaper');
					verpsw.dialog('open');
				}
			}
			else{
				if($('.sysmeg #name1.syshint5').length>0){
					$('.sysmeg #name1.syshint5').css({'display':''});
				}
				else{
				}
				if($('.sysmeg #name2.syshint5').length>0){
					$('.sysmeg #name2.syshint5').css({'display':''});
				}
				else{
				}
				sysmeg.dialog('open');
			}
		}
		else{
			if($('.sysmeg #name1.syshint6').length>0){
				$('.sysmeg #name1.syshint6').css({'display':''});
			}
			else{
			}
			if($('.sysmeg #name2.syshint6').length>0){
				$('.sysmeg #name2.syshint6').css({'display':''});
			}
			else{
			}
			sysmeg.dialog('open');
		}
	});
	$('.order#order #menubox #itemfun #changetaste').click(function(){
		if($('.order#order .parameters #taste1').val()!=''){
			var temp=$('.order#order .parameters #taste1').val().split(';');
			temp=temp[1].split(',');
			if(temp.length>((Number($('.order#order #menubox #itemfun .startchangetaste').val())+1)*10)){
				$('.order#order #menubox #itemfun .startchangetaste').val((Number($('.order#order #menubox #itemfun .startchangetaste').val())+1));
			}
			else{
				$('.order#order #menubox #itemfun .startchangetaste').val('0');
			}
		}
		else{
		}
		$('.order#order #menubox #itemfun .itemfun').trigger( "click" );
	});
	$('.order#order #MemberBill #billfun #citybox #billfun2').on('click','#kvm',function(event){
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/getkvmlist.ajax.php',
			async:false,
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.kvm #salelist #salecontent').html(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		if(kvm.dialog('isOpen')){
		}
		else{
			kvm.dialog('open');
		}
	});
	$('.kvm #salelist #salecontent').on('click','.listitems',function(event){
		//oneEvent(event);
		var index=$('.kvm #salelist #salecontent .listitems').index(this);
		$('.kvm #salelist #salecontent .listitems').prop('id','');
		$('.kvm #salelist #salecontent .listitems:eq('+index+')').prop('id','focus');
		$('.kvm #listno').html($('.kvm #salelist #salecontent .listitems:eq('+index+') div:eq(1)').html()+"("+$('.kvm #salelist #salecontent .listitems:eq('+index+') div:eq(1) input[name="consecnumber"]').val()+")");
		$('.kvm #date').html($('.kvm #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html());
		$('.kvm #credate').val($('.kvm #salelist #salecontent .listitems:eq('+index+') div:eq(3)').html().substr(0,8));
		$.ajax({
			url:'./lib/js/getsaledetail.ajax.php',
			method:'post',
			data:{'company':$('.order#order .companydata #company').val(),'bizdate':$('.kvm #salelist #salecontent .listitems:eq('+index+') div:eq(0)').html(),'no':$('.kvm #salelist #salecontent .listitems:eq('+index+') div:eq(1) input[name="consecnumber"]').val(),'createdatetime':$('.kvm #salelist #salecontent .listitems:eq('+index+') div:eq(3)').html(),'temp':'kvm'},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.kvm #list #listcontent').html(d);
				$('.kvm #delete').prop('disabled',false);
				
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.kvm #fun').on('click','#delete',function(event){
		//oneEvent(event);
		//console.log('1');
		$.ajax({
			url:'./lib/js/deletekvm.ajax.php',
			method:'post',
			async:false,
			data:{'bizdate':$('.kvm #date').html(),'consecnumber':$('.kvm #listno input[name="consecnumber"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.kvm #listno').html('');
				$('.kvm #date').html('');
				$('.kvm #credate').html('');
				$('.kvm #list #listcontent').html('');
				$('.kvm #delete').prop('disabled',true);
				$('.order#order #MemberBill #billfun #citybox #billfun2 #kvm').trigger('click');
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.kvm #fun').on('click','#exit',function(event){
		//oneEvent(event);
		kvm.dialog('close');
	});
	$('.order#order #MemberBill #billfun #citybox #billfun3').on('click','#editpunch',function(event){
		//oneEvent(event);
		if($('.order#order .initsetting #voidsale').val()=='1'){
			$('.verpsw input[name="type"]').val('editpunch');
			verpsw.dialog('open');
		}
		else{
			editpunch.dialog('open');
		}
	});
	$('.editpunch').on('click','#search',function(event){
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/getpunchlist.ajax.php',
			method:'post',
			async:false,
			data:{'start':$('.editpunch #startpunch').val(),'end':$('.editpunch #endpunch').val(),'perno':$('.editpunch select[name="punchname"] option:selected').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
				$('.editpunch #searchresult').html(d);
				$('.editpunch #printpunch').prop('disabled',false);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.editpunch').on('click','#printpunch',function(event){
		//oneEvent(event);
		$.ajax({
			url:'./lib/js/create.punchlist.php',
			method:'post',
			async:false,
			data:{'start':$('.editpunch #startpunch').val(),'end':$('.editpunch #endpunch').val(),'perno':$('.editpunch select[name="punchname"] option:selected').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.editpunch #searchresult').on('click','.punchlabel',function(event){
		//oneEvent(event);
		if($(this).find('#date').val()!=''&&$(this).find('#time').val()!=''){
			$.ajax({
				url:'./lib/js/getpunchlistdata.ajax.php',
				method:'post',
				async:false,
				data:{'perno':$(this).find('#perno').val(),'type':$(this).find('#type').val(),'date':$(this).find('#date').val(),'time':$(this).find('#time').val()},
				dataType:'json',
				success:function(d){
					if(d.length>20||JSON.stringify(d).match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'editpunch search getpunchlistdata.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
					$('.editpunch #editperson').val(d[0]['name']);
					$('.editpunch #editperno').val(d[0]['perno']);
					$('.editpunch #initeditTYPE').val(d[0]['type']);
					$('.editpunch #initeditDATE').val(d[0]['date']);
					$('.editpunch #initeditTIME').val(d[0]['time']);
					$('.editpunch #initeditH').val(d[0]['time'].substr(0,2));
					$('.editpunch #initeditI').val(d[0]['time'].substr(3,2));

					$(".editpunch #editDATE").datepicker('setDate',d[0]['date']);
					$('.editpunch #editDATE').prop('disabled',false);
					$('.editpunch #editH option').prop('selected',false);
					$('.editpunch #editH option:eq('+(Number(d[0]['time'].substr(0,2))+1)+')').prop('selected',true);
					$('.editpunch #editH').prop('disabled',false);
					$('.editpunch #editI option').prop('selected',false);
					$('.editpunch #editI option:eq('+(Number(d[0]['time'].substr(3,2))+1)+')').prop('selected',true);
					$('.editpunch #editI').prop('disabled',false);

					$('.editpunch #cancel').prop('disabled',false);
					$('.editpunch #save').prop('disabled',false);
					$('.editpunch #printpunch').prop('disabled',true);
				},
				error:function(e){
					//console.log(e);
				}
			});
		}
		else{
		}
	});
	$('.editpunch #cancel').click(function(){
		$('.editpunch #editperson').val('');
		$('.editpunch #editperno').val('');
		$('.editpunch #initeditTYPE').val('');
		$('.editpunch #initeditDATE').val('');
		$('.editpunch #initeditTIME').val('');
		$('.editpunch #initeditH').val('');
		$('.editpunch #initeditI').val('');

		$(".editpunch #editDATE").datepicker('setDate','');
		$('.editpunch #editDATE').prop('disabled',true);
		$('.editpunch #editH option').prop('selected',false);
		$('.editpunch #editH option:eq(0)').prop('selected',true);
		$('.editpunch #editH').prop('disabled',true);
		$('.editpunch #editI option').prop('selected',false);
		$('.editpunch #editI option:eq(0)').prop('selected',true);
		$('.editpunch #editI').prop('disabled',true);
		
		$('.editpunch #cancel').prop('disabled',true);
		$('.editpunch #save').prop('disabled',true);
	});
	$('.editpunch #save').click(function(){
		$.ajax({
			url:'./lib/js/savepunchlist.ajax.php',
			method:'post',
			async:false,
			data:{'perno':$('.editpunch #editperno').val(),'inittype':$('.editpunch #initeditTYPE').val(),'initdate':$('.editpunch #initeditDATE').val(),'inittime':$('.editpunch #initeditTIME').val(),'date':$('.editpunch #editDATE').val(),'time':$('.editpunch #editH').val()+':'+$('.editpunch #editI').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		$('.editpunch #editperson').val('');
		$('.editpunch #editperno').val('');
		$('.editpunch #initeditTYPE').val('');
		$('.editpunch #initeditDATE').val('');
		$('.editpunch #initeditTIME').val('');
		$('.editpunch #initeditH').val('');
		$('.editpunch #initeditI').val('');

		$(".editpunch #editDATE").datepicker('setDate','');
		$('.editpunch #editDATE').prop('disabled',true);
		$('.editpunch #editH option').prop('selected',false);
		$('.editpunch #editH option:eq(0)').prop('selected',true);
		$('.editpunch #editH').prop('disabled',true);
		$('.editpunch #editI option').prop('selected',false);
		$('.editpunch #editI option:eq(0)').prop('selected',true);
		$('.editpunch #editI').prop('disabled',true);
		
		$('.editpunch #cancel').prop('disabled',true);
		$('.editpunch #save').prop('disabled',true);
		$('.editpunch #search').trigger('click');
	});
	$('.editpunch').on('click','#exit',function(event){
		//oneEvent(event);
		editpunch.dialog('close');
	});
	$('.order#order #content #member #memdeposit').click(function(){
		memdeposit.dialog('open');
	});
	$('.memdeposit #exit').click(function(){
		$('.memdeposit input[name="type"]').prop('checked',false);
		$('.memdeposit input[name="type"]:eq(0)').prop('checked',true);
		$('.memdeposit #memcard').val('');
		$('.memdeposit #memname').val('');
		$('.memdeposit #remaining').val('');
		$('.memdeposit #money').val('');
		memdeposit.dialog('close');
	});
	$('.emptyitemsvoidlist .void').click(function(){//如果沒有開啟驗證密碼會卡住，但系統不會死當
		$('.verpsw input[name="type"]').val('viewvoidbyemptylist');
		verpsw.dialog('open');
	});
	$('.emptyitemsvoidlist .return').click(function(){
		var nowbizdate=$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val();
		$.ajax({
			url:'./lib/js/create.voidtempdb.php',
			method:'post',
			async: false,
			data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'tablenumber':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'return emptyitemsvoidlist create.voidtempdb.php '+d},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		if($('.order#order .initsetting #secview').val()=='1'){
			$.ajax({
				url:'../secview/cleartemp.ajax.php',
				method:'post',
				async: false,
				data:{'machinename':$('.order#order .companydata #terminalnumber').val()},
				dataType:'html',
				success:function(d){
					if(d.length>20||d.match('ERROR HINT: ')){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'temp cleartemp.ajax.php '+d},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
					}
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});
			if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
				socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'clear']);
				console.log('send message "clear" to secview');
			}
			else{
			}
		}
		else{
		}
		$.ajax({
			url:'./lib/js/create.cmdtxt.php',
			method:'post',
			async: false,
			data:{'cmd':nowbizdate.substr(0,6)+'-change'},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		if($('.order#order .initsetting #controltable').val()=='1'){
			$.ajax({
				url:'./lib/js/changetabini.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.order#order #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'tabnum':$('.order#order #tabs4 form[data-id="listform"] input[name="tablenumber"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val()},
				dataType:'html',
				success:function(d){
					//console.log(d);
				},
				error:function(e){
					//console.log(e);
				}
			});

			inittable.dialog('open');
			ClearWindow('','');
		}
		else{
			ClearWindow('','');
		}
		emptyitemsvoidlist.dialog('close');
		$('.order#order #billfun1 button:eq(4)').prop('disabled',false);
		if($('.order#order .initsetting #controltable').val()=='1'){
			var buttype='b';
		}
		else{
			var buttype='a';
		}
		$.ajax({
			url:'./lib/js/change.button4.php',
			method:'post',
			data:{'type':buttype},
			dataType:'json',
			success:function(d){
				if($('.order#order #billfun #billfun1 button:eq(4) #name1').length>0){
					$('.order#order #billfun #billfun1 button:eq(4) #name1').html(d[0]);
				}
				else{
				}
				if($('.order#order #billfun #billfun1 button:eq(4) #name2').length>0){
					$('.order#order #billfun #billfun1 button:eq(4) #name2').html(d[1]);
				}
				else{
				}
				if($('.order#order .initsetting #controltable').val()=='1'&&$('.order#order .initsetting #opentemp').val()=='0'){
					if(buttype=='a'){
						$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',true);
					}
					else{
						$('.order#order #billfun #billfun1 button:eq(4)').prop('disabled',false);
					}
				}
				else{
				}
				$('.order#order #billfun #billfun1 button:eq(4)').val(d[2]);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	/*$('.salelist #rekvm').click(function(){
		$.ajax({
			url:'./lib/js/create.rekvm.php',
			method:'post',
			async:false,
			data:{'type':'salelist','bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});*/
	/*鑫寶錸查詢會員資訊*/
	$('.memdeposit #memcard').keypress(function(event){
		if(event.which==13){
			/*start tag*/
			$.ajax({
				url:'./lib/js/print.php',
				method:'post',
				async:false,
				data:{'html':'start bolai-search','file':'bolai'},
				dataType:'html',
				success:function(d){/*console.log(d);*/},
				error:function(e){/*console.log(e);*/}
			});
			if(typeof api_search_bolai!=="undefined"&&typeof api_search_bolai==="function"){
				var searchres=api_search_bolai();
			}
			else{
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					async:false,
					data:{'html':'api search bolai is not function','file':'bolai'},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
				//console.log('not function');
			}
			/*end tag*/
			$.ajax({
				url:'./lib/js/print.php',
				method:'post',
				async:false,
				data:{'html':'end bolai-search','file':'bolai'},
				dataType:'html',
				success:function(d){/*console.log(d);*/},
				error:function(e){/*console.log(e);*/}
			});
		}
		else{
		}
	});
	/*鑫寶錸儲值*/
	$('.memdeposit #send').click(function(){
		/*start tag*/
		$.ajax({
			url:'./lib/js/print.php',
			method:'post',
			async:false,
			data:{'html':'start bolai-deposit','file':'bolai'},
			dataType:'html',
			success:function(d){/*console.log(d);*/},
			error:function(e){/*console.log(e);*/}
		});
		if(typeof api_deposit_bolai!=="undefined"&&typeof api_deposit_bolai==="function"){
			var depositres=api_deposit_bolai($('.memdeposit input[name="type"]:checked').val(),$('.memdeposit #memcard').val(),$('.memdeposit #money').val());
			//console.log(depositres);
		}
		else{
			$.ajax({
				url:'./lib/js/print.php',
				method:'post',
				async:false,
				data:{'html':'api deposit bolai is not function','file':'bolai'},
				dataType:'html',
				success:function(d){/*console.log(d);*/},
				error:function(e){/*console.log(e);*/}
			});
			//console.log('not function');
		}
		/*end tag*/
		$.ajax({
			url:'./lib/js/print.php',
			method:'post',
			async:false,
			data:{'html':'end bolai-deposit','file':'bolai'},
			dataType:'html',
			success:function(d){/*console.log(d);*/},
			error:function(e){/*console.log(e);*/}
		});
	});
	/*集點樹查詢剩餘點數*/
	$('.result #funbox .pointtree').click(function(){
		$('.result #viewwindow input[name="treetel"]').val($('.result input[name="view"]').val());
		if($('.result input[name="view"]').val()==''){
			$('.result #funbox .pointtree #name3').html('');
			$('.result #funbox .pointtree #name2').html('');
			$('.pointtreememdata #tel').html('');
			$('.pointtreememdata #name').html('');
			$('.pointtreememdata #ismem').html('');
			$('.pointtreememdata #sex').html('');
			$('.pointtreememdata #balance').html('');
			if($('.order#order .initsetting #secview').val()=='1'){
				$.ajax({
					url:'../secview/writepoint.ajax.php',
					method:'post',
					data:{'tel':$('.result #viewwindow input[name="treetel"]').val(),'point':'0','machinetype':$('.order#order .companydata #terminalnumber').val()},
					dataType:'html',
					success:function(d){
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'searchpoint writepoint.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
					socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
					console.log('send message "listitemupdate" to secview');
				}
				else{
				}
			}
			else{
			}
		}
		else{
			/*start tag*/
			$.ajax({
				url:'./lib/js/print.php',
				method:'post',
				async:false,
				data:{'html':'start point-tree-search transfer','file':'point-tree'},
				dataType:'html',
				success:function(d){/*console.log(d);*/},
				error:function(e){/*console.log(e);*/}
			});

			if(typeof api_search_pointtree!=="undefined"&&typeof api_search_pointtree==="function"){
				var searchres=api_search_pointtree($('.result #viewwindow input[name="treetoken"]').val(),$('.result #viewwindow input[name="treetel"]').val());
				//console.log(searchres);
				if(typeof searchres['data']!=="undefined"){//success
					if($('.order#order .initsetting #secview').val()=='1'){
						$.ajax({
							url:'../secview/writepoint.ajax.php',
							method:'post',
							data:{'tel':$('.result #viewwindow input[name="treetel"]').val(),'point':searchres["data"]["balance"],'machinetype':$('.order#order .companydata #terminalnumber').val()},
							dataType:'html',
							success:function(d){
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'searchpoint writepoint.ajax.php '+d,'file':'point-tree'},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
							socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
							console.log('send message "listitemupdate" to secview');
						}
						else{
						}
					}
					else{
					}
					//console.log(searchres);
					$('.result #funbox .pointtree #name3').html($('.result #viewwindow input[name="treetel"]').val());
					$('.result #funbox .pointtree #name2').html(searchres["data"]["balance"]);
					$('.pointtreememdata #tel').html($('.result #viewwindow input[name="treetel"]').val());
					$('.pointtreememdata #name').html(searchres['data']['name']);
					if(searchres['data']['is_active']){
						$('.pointtreememdata #ismem').html("YES");
					}
					else{
						$('.pointtreememdata #ismem').html("NO");
					}
					$('.pointtreememdata #sex').html(searchres['data']['sex']);
					$('.pointtreememdata #balance').html(searchres['data']['balance']);
					pointtreememdata.dialog('open');

					if($('.order#order .initsetting #onlinemember').length>0&&$('.order#order .initsetting #onlinemember').val()==='1'){//網路會員
						//不用檢查網路狀態，如果沒網路，頂多門市沒有該會員資料，不影響集點數使用
						$.ajax({
							url:'http://api.tableplus.com.tw/outposandorder/memberapi/create.member.php',
							method:'post',
							async: false,
							data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'name':searchres['data']['name']+' ','tel':$('.result #viewwindow input[name="treetel"]').val(),'initpower':$('.order#order .companydata #initpower').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/create.member.php(online success) '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								if(d=='exists'){
								}
								else if(d=='success'){
								}
								else{
								}
							},
							error:function(e){
								//if(e.length>20||e.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/create.member.php(online error) '+e},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
								/*}
								else{
								}*/
							}
						});
					}
					else{
						$.ajax({
							url:'../memberapi/create.member.php',
							method:'post',
							async: false,
							data:{'membertype':$('.order#order .initsetting #membertype').val(),'type':'offline','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'name':searchres['data']['name']+' ','tel':$('.result #viewwindow input[name="treetel"]').val(),'initpower':$('.order#order .companydata #initpower').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
								if(d.length>20||d.match('ERROR HINT: ')){
									$.ajax({
										url:'./lib/js/print.php',
										method:'post',
										data:{'html':'../memberapi/create.member.php(offline success) '+d},
										dataType:'html',
										success:function(d){/*console.log(d);*/},
										error:function(e){/*console.log(e);*/}
									});
								}
								else{
								}
								if(d=='exists'){
								}
								else if(d=='success'){
								}
								else{
								}
							},
							error:function(e){
								//if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'../memberapi/create.member.php(offline error) '+e},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
								/*}
								else{
								}*/
							}
						});
					}
				}
				else{
					//console.log(searchres);
					var message=JSON.parse(searchres['responseText']);
					if(searchres['status']==='timeout'){
						//alertmessage('與查詢伺服器連線逾時。');
						$('.alertmessage #text').html('與查詢伺服器連線逾時。');
						alertmessage.dialog('open');
						$('.result #viewwindow input[name="treetel"]').val('');
					}
					else if(searchres['status']=='400'){
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'API https://pointtree.com.tw/api/v1/pos/members/information -PHP_EOL-status:'+searchres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						//console.log(searchres);
						$('.result #funbox .pointtree #name3').html('查詢錯誤');
						$('.result #funbox .pointtree #name2').html('');
						//alertmessage('status:'+e['status']+'\ncode:'+message['errors'][0]['code']+'\nmessage:'+message['errors'][0]['message']);
						$('.result #viewwindow input[name="treetel"]').val('');
					}
					else if(searchres['status']=='406'){
						if(message['errors'][0]['code']=='not_found'){
							if($('.order#order .initsetting #secview').val()=='1'){
								$.ajax({
									url:'../secview/writepoint.ajax.php',
									method:'post',
									data:{'tel':$('.result #viewwindow input[name="treetel"]').val(),'point':'0','machinetype':$('.order#order .companydata #terminalnumber').val()},
									dataType:'html',
									success:function(d){
										if(d.length>20||d.match('ERROR HINT: ')){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'searchpoint writepoint.ajax.php '+d,'file':'point-tree'},
												dataType:'html',
												success:function(d){
													//console.log(d);
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
								if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
									socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
									console.log('send message "listitemupdate" to secview');
								}
								else{
								}
							}
							else{
							}
							$('.result #funbox .pointtree #name3').html($('.result #viewwindow input[name="treetel"]').val());
							$('.result #funbox .pointtree #name2').html('0');
							//alertmessage('客戶手機:'+$('.result #viewwindow input[name="treetel"]').val()+'\n剩餘點數:0');
						}
						else{
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'API https://pointtree.com.tw/api/v1/pos/members/information -PHP_EOL-status:'+searchres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.result #funbox .pointtree #name3').html('查詢錯誤');
							$('.result #funbox .pointtree #name2').html('');
							//alertmessage('status:'+e['status']+'\ncode:'+message['errors'][0]['code']+'\nmessage:'+message['errors'][0]['message']);
							$('.result #viewwindow input[name="treetel"]').val('');
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'API https://pointtree.com.tw/api/v1/pos/members/information 意外錯誤。','file':'point-tree'},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
						$('.result #funbox .pointtree #name3').html('查詢錯誤');
						$('.result #funbox .pointtree #name2').html('');
						//alertmessage('意外錯誤。');
						$('.result #viewwindow input[name="treetel"]').val('');
					}
				}
			}
			else{
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					async:false,
					data:{'html':'api search pointtree is not function','file':'point-tree'},
					dataType:'html',
					success:function(d){/*console.log(d);*/},
					error:function(e){/*console.log(e);*/}
				});
				//console.log('not function');
			}
			/*end tag*/
			$.ajax({
				url:'./lib/js/print.php',
				method:'post',
				async:false,
				data:{'html':'end point-tree-search transfer','file':'point-tree'},
				dataType:'html',
				success:function(d){/*console.log(d);*/},
				error:function(e){/*console.log(e);*/}
			});
		}
		$('.result input[name="view"]').val('');
	});
	$('.pointtreememdata #exit').click(function(){
		pointtreememdata.dialog('close');
	});
	$('.result #funbox .intellapay').click(function(){
		intellapay.dialog('open');
	});
	$('.intellapaymethod #easycard').click(function(){//英特拉悠遊卡支付
		if($('.result #paywindow #paycontent .payway span[data-id="apipay"]').length==0){//2022/5/6 未使用api串接的付款方式(英特拉電子支付、聯合信用卡中心刷卡、直接linepay付款)才能使用該付款方式
			$('.checkeasycard input[name="methodcode"]').val('');//2021/8/10 支付代號(使用悠遊卡(31800)機讀取 愛金卡(icash)(32800)或一卡通(32100))
			if(typeof api_easycard!=="undefined"&&typeof api_easycard==="function"){
				var intellaconsecnumber='';
				var intellamoney='';
				if($('.result input[name="view"]').val()==''||$('.result input[name="view"]').val()=='0'){
					var money=$('.result #viewwindow #notyet').html();
				}
				else if(Number($('.result input[name="view"]').val())>Number($('.result #viewwindow #notyet').html())){
					var money=$('.result #viewwindow #notyet').html();
				}
				else{
					var money=$('.result input[name="view"]').val();
				}
				$.ajax({//填入對應intella使用之帳單編號(自定義);因為在可能在暫結前使用，因此產生另一個編號
					url:'./lib/api/intella/write_intellaconsecnumber.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.order#order #content #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'money':money,'type':'easycard'},/*$('.result #viewwindow #should').html()*/
					dataType:'json',
					success:function(d){
						intellaconsecnumber=d['data']['intellaconsecnumber'];
						intellamoney=d['data']['money'];
						//console.log(intellaconsecnumber);
					},
					error:function(e){
						//console.log(e);
					}
				});

				intellapay.dialog('close');
				$('.checkeasycard input[name="money"]').val(intellamoney);
				checkeasycard.dialog('open');

				var res='';

				res=api_easycard('Payment',$('.order#order .companydata #terminalnumber').val(),intellaconsecnumber,intellamoney);
				res.done(function(res){
					//console.log(res);
					if(typeof res==='object'){
					}
					else{
						res=JSON.parse(res);
					}
					//console.log(res);
					if(res=='errorinput'){
						//console.log('變數輸入錯誤');
					}
					else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
						/*if(typeof res['Data']['Retry']!=='undefined'){
							//res['Data']['Retry']++;
						}
						else{
							res['Data']['Retry']=1;
						}*/
						$('.checkeasycard #retry').css({'display':'block'});
						$('.checkeasycard #retry #time').html(res['Data']['Retry']);
						
						res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),intellaconsecnumber,intellamoney,res);//第一次重試
						res.done(function(res){
							//console.log(res);
							if(typeof res==='object'){
							}
							else{
								res=JSON.parse(res);
							}

							if(res=='errorinput'){
								//console.log('變數輸入錯誤');
							}
							else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
								/*if(typeof res['Data']['Retry']!=='undefined'){
									//res['Data']['Retry']++;
								}
								else{
									res['Data']['Retry']=1;
								}*/
								$('.checkeasycard #retry').css({'display':'block'});
								$('.checkeasycard #retry #time').html(res['Data']['Retry']);
								
								res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),intellaconsecnumber,intellamoney,res);//第二次重試
								res.done(function(res){
									//console.log(typeof res);
									//console.log(res);
									if(typeof res==='object'){
									}
									else{
										res=JSON.parse(res);
									}

									if(res=='errorinput'){
										//console.log('變數輸入錯誤');
									}
									else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
										/*if(typeof res['Data']['Retry']!=='undefined'){
											//res['Data']['Retry']++;
										}
										else{
											res['Data']['Retry']=1;
										}*/
										$('.checkeasycard #retry').css({'display':'block'});
										$('.checkeasycard #retry #time').html(res['Data']['Retry']);
										
										res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),intellaconsecnumber,intellamoney,res);//第三次重試
										res.done(function(res){
											//console.log(res);
											if(typeof res==='object'){
											}
											else{
												res=JSON.parse(res);
											}
											//console.log(res);

											if(res=='errorinput'){
												//console.log('變數輸入錯誤');
											}
											else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第三次重試錯誤，不再重試
												/*if(typeof res['Data']['Retry']!=='undefined'){
													//res['Data']['Retry']++;
												}
												else{
													res['Data']['Retry']=1;
												}*/

												//$('.checkeasycard #retry').css({'display':'block'});
												//$('.checkeasycard #retry #time').html(res['Data']['Retry']);
												$('.checkeasycard .qrhint').css({'visibility':'hidden'});
												$('.checkeasycard .hintstring').html('重試三次失敗。(easy card)');
												$('.checkeasycard #cancelsale').css({'display':'block'});
												clearInterval(dotloading);

												//console.log('retry '+JSON.stringify(res));
												/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
													$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
												}
												else{
												}*/
											}
											else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
												$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
												$('.checkeasycard input[name="methodcode"]').val(res['Header']['Method']);
												$('.checkeasycard .qrhint').css({'visibility':'hidden'});
												$('.checkeasycard .hintstring').html('交易成功。(3)');
												$('.checkeasycard #successsale').prop('disabled',false);
												clearInterval(dotloading);
												$.ajax({
													url:'./lib/api/intella/easycard_saleticket_api.php',
													method:'post',
													data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
													dataType:'html',
													success:function(d){
														//console.log(d);
													},
													error:function(e){
														//console.log(e);
													}
												});
											}
											else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
												//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
												$('.checkeasycard .qrhint').css({'visibility':'hidden'});
												$('.checkeasycard .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
												//$('.checkeasycard #successsale').prop('disabled',false);
												$('.checkeasycard #cancelsale').css({'display':'block'});
												clearInterval(dotloading);
											}
											else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
												//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
												$('.checkeasycard .qrhint').css({'visibility':'hidden'});
												$('.checkeasycard .hintstring').html('連線逾時，請重試一次。');
												//$('.checkeasycard #successsale').prop('disabled',false);
												$('.checkeasycard #cancelsale').css({'display':'block'});
												clearInterval(dotloading);
											}
											else{//其餘意外狀況
												//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
												$('.checkeasycard .qrhint').css({'visibility':'hidden'});
												$('.checkeasycard .hintstring').html(res['Header']['StatusDesc']+'(3)');
												//$('.checkeasycard #successsale').prop('disabled',false);
												$('.checkeasycard #cancelsale').css({'display':'block'});
												clearInterval(dotloading);
											}
										});
										//console.log('retry '+JSON.stringify(res));
										/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
											$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
										}
										else{
										}*/
									}
									else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
										$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
										$('.checkeasycard input[name="methodcode"]').val(res['Header']['Method']);
										$('.checkeasycard .qrhint').css({'visibility':'hidden'});
										$('.checkeasycard .hintstring').html('交易成功。(2)');
										$('.checkeasycard #successsale').prop('disabled',false);
										clearInterval(dotloading);
										$.ajax({
											url:'./lib/api/intella/easycard_saleticket_api.php',
											method:'post',
											data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
											dataType:'html',
											success:function(d){
												//console.log(d);
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
									else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
										//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
										$('.checkeasycard .qrhint').css({'visibility':'hidden'});
										$('.checkeasycard .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
										//$('.checkeasycard #successsale').prop('disabled',false);
										$('.checkeasycard #cancelsale').css({'display':'block'});
										clearInterval(dotloading);
									}
									else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
										//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
										$('.checkeasycard .qrhint').css({'visibility':'hidden'});
										$('.checkeasycard .hintstring').html('連線逾時，請重試一次。');
										//$('.checkeasycard #successsale').prop('disabled',false);
										$('.checkeasycard #cancelsale').css({'display':'block'});
										clearInterval(dotloading);
									}
									else{//其餘意外狀況
										//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
										$('.checkeasycard .qrhint').css({'visibility':'hidden'});
										$('.checkeasycard .hintstring').html(res['Header']['StatusDesc']+'(2)');
										//$('.checkeasycard #successsale').prop('disabled',false);
										$('.checkeasycard #cancelsale').css({'display':'block'});
										clearInterval(dotloading);
									}
								});
								//console.log('retry '+JSON.stringify(res));
								/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
									$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
								}
								else{
								}*/
							}
							else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
								$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
								$('.checkeasycard input[name="methodcode"]').val(res['Header']['Method']);
								$('.checkeasycard .qrhint').css({'visibility':'hidden'});
								$('.checkeasycard .hintstring').html('交易成功。(1)');
								$('.checkeasycard #successsale').prop('disabled',false);
								clearInterval(dotloading);
								$.ajax({
									url:'./lib/api/intella/easycard_saleticket_api.php',
									method:'post',
									data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
									dataType:'html',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
								//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
								$('.checkeasycard .qrhint').css({'visibility':'hidden'});
								$('.checkeasycard .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
								//$('.checkeasycard #successsale').prop('disabled',false);
								$('.checkeasycard #cancelsale').css({'display':'block'});
								clearInterval(dotloading);
							}
							else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
								//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
								$('.checkeasycard .qrhint').css({'visibility':'hidden'});
								$('.checkeasycard .hintstring').html('連線逾時，請重試一次。');
								//$('.checkeasycard #successsale').prop('disabled',false);
								$('.checkeasycard #cancelsale').css({'display':'block'});
								clearInterval(dotloading);
							}
							else{//其餘意外狀況
								//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
								$('.checkeasycard .qrhint').css({'visibility':'hidden'});
								$('.checkeasycard .hintstring').html(res['Header']['StatusDesc']+'(1)');
								//$('.checkeasycard #successsale').prop('disabled',false);
								$('.checkeasycard #cancelsale').css({'display':'block'});
								clearInterval(dotloading);
							}
						});

						//console.log('retry '+JSON.stringify(res));
						/*if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='success'){
							$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
						}
						else{
						}*/
					}
					else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
						$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
						$('.checkeasycard input[name="methodcode"]').val(res['Header']['Method']);
						$('.checkeasycard .qrhint').css({'visibility':'hidden'});
						$('.checkeasycard .hintstring').html('交易成功。');
						$('.checkeasycard #successsale').prop('disabled',false);
						clearInterval(dotloading);
						$.ajax({
							url:'./lib/api/intella/easycard_saleticket_api.php',
							method:'post',
							data:{'data':res,'machine':$('.order#order .companydata #terminalnumber').val()},
							dataType:'html',
							success:function(d){
								//console.log(d);
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
						//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
						$('.checkeasycard .qrhint').css({'visibility':'hidden'});
						$('.checkeasycard .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
						//$('.checkeasycard #successsale').prop('disabled',false);
						$('.checkeasycard #cancelsale').css({'display':'block'});
						clearInterval(dotloading);
					}
					else if(typeof res['statusText']!=='undefined'&&res['statusText']=='timeout'){//連線逾時
						//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
						$('.checkeasycard .qrhint').css({'visibility':'hidden'});
						$('.checkeasycard .hintstring').html('連線逾時，請重試一次。');
						//$('.checkeasycard #successsale').prop('disabled',false);
						$('.checkeasycard #cancelsale').css({'display':'block'});
						clearInterval(dotloading);
					}
					else{//其餘意外狀況
						//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
						$('.checkeasycard .qrhint').css({'visibility':'hidden'});
						$('.checkeasycard .hintstring').html(res['Header']['StatusDesc']);
						//$('.checkeasycard #successsale').prop('disabled',false);
						$('.checkeasycard #cancelsale').css({'display':'block'});
						clearInterval(dotloading);
					}
				});
			}
			else{
			}
		}
		else{
		}
	});
	$('.checkeasycard #successsale').click(function(){//成功交易，產生對應的付款方式記錄(英特拉悠遊卡)
		var content='';
		content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+$('.checkeasycard input[name="methodcode"]').val()+"'>";
		content=content+$('.checkeasycard input[name="money"]').val()+"<input type='hidden' name='viewmoney' value='"+$('.checkeasycard input[name="money"]').val()+"'></span>"+$('.result .unit').val()+"</div></div></div>";

		$('.result #paywindow #paycontent').append(content);

		checkeasycard.dialog('close');
		
		closedisbut();

		computerchange();

		$('.result #funbox .intellapay').prop('disabled',true);
	});
	$('.checkeasycard #cancelsale').click(function(){//取消交易，英特拉悠遊卡重試三次失敗
		checkeasycard.dialog('close');
	});
	$('.intellapaymethod #linepay').click(function(){//英特拉linepay支付，消費者被掃
		
	});
	$('.intellapaymethod #creditcardpay').click(function(){//英特拉線上信用卡支付
		
	});
	$('.intellapaymethod #intellaother').click(function(){//英特拉消費者主掃
		if($('.result #paywindow #paycontent .payway span[data-id="apipay"]').length==0){//2022/5/6 未使用api串接的付款方式(英特拉電子支付、聯合信用卡中心刷卡、直接linepay付款)才能使用該付款方式
			if(typeof api_intellaother!=="undefined"&&typeof api_intellaother==="function"){
				var intellaconsecnumber='';
				var intellamoney='';
				if($('.result input[name="view"]').val()==''||$('.result input[name="view"]').val()=='0'){
					var money=$('.result #viewwindow #notyet').html();
				}
				else if(Number($('.result input[name="view"]').val())>Number($('.result #viewwindow #notyet').html())){
					var money=$('.result #viewwindow #notyet').html();
				}
				else{
					var money=$('.result input[name="view"]').val();
				}
				$('.result input[name="view"]').html('');
				$.ajax({//填入對應intella使用之帳單編號(自定義);因為在可能在暫結前使用，因此產生另一個編號
					url:'./lib/api/intella/write_intellaconsecnumber.ajax.php',
					method:'post',
					async:false,
					data:{'bizdate':$('.order#order #content #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'money':money,'type':'other'},/*$('.result #viewwindow #should').html()*/
					dataType:'json',
					success:function(d){
						intellaconsecnumber=d['data']['intellaconsecnumber'];
						intellamoney=d['data']['money'];
						//console.log(intellaconsecnumber);
					},
					error:function(e){
						//console.log(e);
					}
				});

				if(typeof $('.order#order .initsetting #intellaotherprint')==='undefined'||$('.order#order .initsetting #intellaotherprint').val()=='1'){//QRcode顯示於客顯
					var qrcodename=api_intellaother(intellaconsecnumber,intellamoney,$('.order#order .companydata #story').val(),$('.order#order #tabs4 input[name="usercode"]').val(),$('.order#order .companydata #terminalnumber').val(),1);
					$.ajax({
						url:'./lib/api/intella/intella.log.php',
						method:'post',
						data:{'function':'intellaother','res':qrcodename,'consecnumber':intellaconsecnumber,'total':intellamoney,'dep':$('.order#order .companydata #story').val(),'usercode':$('.order#order #tabs4 input[name="usercode"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'type':1}
					});
				}
				else{//QRcode列印於暫出明細單
					var qrcodename=api_intellaother(intellaconsecnumber,intellamoney,$('.order#order .companydata #story').val(),$('.order#order #tabs4 input[name="usercode"]').val(),$('.order#order .companydata #terminalnumber').val(),2);
					$.ajax({
						url:'./lib/api/intella/intella.log.php',
						method:'post',
						data:{'function':'intellaother','res':qrcodename,'consecnumber':intellaconsecnumber,'total':intellamoney,'dep':$('.order#order .companydata #story').val(),'usercode':$('.order#order #tabs4 input[name="usercode"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'type':2}
					});
				}

				if(typeof $('.order#order .initsetting #intellaotherprint')==='undefined'||$('.order#order .initsetting #intellaotherprint').val()=='1'){//QRcode顯示於客顯
				}
				else{//$('.order#order .initsetting #intellaotherprint').val()=='2'//QRcode列印於暫出明細單
					$('.result #checkfun #notsale').trigger('click');
					//console.log('1');
				}

				$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);

				intellapay.dialog('close');
				$('.checkintella input[name="money"]').val(intellamoney);
				checkintella.dialog('open');
			}
			else{
			}
		}
		else{
		}
	});
	$('.checkintella .qrhint').on('click','#recreateqrcode',function(){//重新產生英特拉QRcode(英特拉消費者主掃)
		checkintella.dialog('close');
		$('.intellapaymethod #intellaother').trigger('click');
	});
	$('.checkintella').on('click','#recheck',function(){//檢查交易狀態(英特拉消費者主掃)
		$.ajax({
			url:'./lib/api/intella/checkintellasale.ajax.php',
			method:'post',
			async:false,
			data:{'intellaconsecnumber':$('.result #viewwindow input[name="intellaconsecnumber"]').val()},
			dataType:'json',
			success:function(d){
				//console.log(JSON.parse(d));
				$.ajax({
					url:'./lib/api/intella/intella.log.php',
					method:'post',
					data:{'function':'checkintellasale','res':d,'intellaconsecnumber':$('.result #viewwindow input[name="intellaconsecnumber"]').val()}
				});
				d=JSON.parse(d);
				if(d['Header']['StatusCode']=='0000'&&typeof d['Data']['OrderStatus']!=='undefined'&&d['Data']['OrderStatus']=='1'){//交易成功
					$.ajax({
						url:'./lib/api/intella/delete.failqrcode.php',
						method:'post',
						async:false,
						data:{'machine':$('.order#order .companydata #terminalnumber').val()},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
					$.ajax({
						url:'./lib/api/intella/check.paymethod.php',
						method:'post',
						async:false,
						data:{'method':d['Header']['Method']},
						dataType:'json',
						success:function(m){
							//console.log(d);
							$('.checkintella .hintstring').html(m['payname']+' '+d['Header']['StatusDesc']+'<input type="hidden" name="methodcode" value="'+d['Header']['Method']+'"><input type="hidden" name="payname" value="'+m['payname']+'"><input type="hidden" name="method" value="'+d['Header']['Method']+'">');
							$.ajax({
								url:'./lib/api/intella/intella.log.php',
								method:'post',
								data:{'function':'check.paymethod','res':m,'method':d['Header']['Method'],}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
					$('.checkintella #cancelsale').prop('disabled',true);
					$('.checkintella #successsale').prop('disabled',false);
				}
				else if(d['Header']['StatusCode']=='0000'){//以選取付款方式，但未結帳
					$.ajax({
						url:'./lib/api/intella/check.paymethod.php',
						method:'post',
						async:false,
						data:{'method':d['Header']['Method']},
						dataType:'json',
						success:function(m){
							//console.log(d);
							$('.checkintella .hintstring').html('付款方式：'+m['payname']+'<br>未付款<input type="hidden" name="methodcode" value="'+d['Header']['Method']+'"><input type="hidden" name="payname" value="'+m['payname']+'"><input type="hidden" name="method" value="'+d['Header']['Method']+'"><button id="recheck" style="float:right;">檢查交易狀態</button>');
							$.ajax({
								url:'./lib/api/intella/intella.log.php',
								method:'post',
								data:{'function':'check.paymethod','res':m,'method':d['Header']['Method']}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					$('.checkintella .hintstring').html(d['Header']['StatusDesc']+'<button id="recheck" style="float:right;">檢查交易狀態</button>');
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.checkintella #successsale').click(function(){//成功交易，產生對應的付款方式記錄(英特拉消費者主掃)
		var content='';
		content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+$('.checkintella .hintstring input[name="methodcode"]').val()+"'>";
		content=content+$('.checkintella input[name="money"]').val()+"<input type='hidden' name='viewmoney' value='"+$('.checkintella input[name="money"]').val()+"'></span>"+$('.result .unit').val()+"</div></div></div>";

		$('.result #paywindow #paycontent').append(content);

		checkintella.dialog('close');
		
		closedisbut();

		computerchange();

		$('.result #funbox .intellapay').prop('disabled',true);
	});
	$('.checkintella #cancelsale').click(function(){//取消交易(英特拉消費者主掃)
		$.ajax({
			url:'./lib/api/intella/delete.failqrcode.php',
			method:'post',
			async:false,
			data:{'machine':$('.order#order .companydata #terminalnumber').val()},
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
		clearInterval(intellaqrcodetime);
		clearInterval(checkintellasale);
		checkintella.dialog('close');
	});
	$('.intellapaymethod #intellauser').click(function(){//英特拉消費者被掃
		if($('.result #paywindow #paycontent .payway span[data-id="apipay"]').length==0){//2022/5/6 未使用api串接的付款方式(英特拉電子支付、聯合信用卡中心刷卡、直接linepay付款)才能使用該付款方式
			intellapay.dialog('close');
			$('.checkintellauser input[name="authcode"]').val('');
			checkintellauser.dialog('open');
		}
		else{
		}
	});
	$('.checkintellauser .inputdiv').on('keypress','input[name="authcode"]',function(event){//掃描消費者條碼(QRcode)
		if(event.which==13&&typeof api_intellauser!=="undefined"&&typeof api_intellauser==="function"){
			$('.checkintellauser .inputdiv').css({'display':'none'});
			$('.checkintellauser .loaddiv').css({'display':'block'});
			$('.checkintellauser #cancelsale').prop('disabled',true);

			var dotloading='';
			
			dotloading=setInterval(function(){
				if($('.checkintellauser .loaddiv #dot').length>0){
					if($('.checkintellauser .loaddiv #dot').html().length==3){
						$('.checkintellauser .loaddiv #dot').html('.');
					}
					else if($('.checkintellauser .loaddiv #dot').html().length==2){
						$('.checkintellauser .loaddiv #dot').html('...');
					}
					else{
						$('.checkintellauser .loaddiv #dot').html('..');
					}
				}
				else{
				}
			},500);

			var intellaconsecnumber='';
			var intellamoney='';
			if($('.result input[name="view"]').val()==''||$('.result input[name="view"]').val()=='0'){
				var money=$('.result #viewwindow #notyet').html();
			}
			else if(Number($('.result input[name="view"]').val())>Number($('.result #viewwindow #notyet').html())){
				var money=$('.result #viewwindow #notyet').html();
			}
			else{
				var money=$('.result input[name="view"]').val();
			}
			$('.result input[name="view"]').html('');
			$.ajax({//填入對應intella使用之帳單編號(自定義);因為在可能在暫結前使用，因此產生另一個編號
				url:'./lib/api/intella/write_intellaconsecnumber.ajax.php',
				method:'post',
				async:false,
				data:{'bizdate':$('.order#order #content #tabs4 form[data-id="listform"] input[name="bizdate"]').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'money':money,'type':'user'},/*$('.result #viewwindow #should').html()*/
				dataType:'json',
				success:function(d){
					intellaconsecnumber=d['data']['intellaconsecnumber'];
					intellamoney=d['data']['money'];
					//console.log(intellaconsecnumber);
				},
				error:function(e){
					//console.log(e);
				}
			});

			$('.checkintellauser .paras input[name="money"]').val(intellamoney);

			var res='';

			/***正式***/
			res=api_intellauser(intellaconsecnumber,intellamoney,$('.order#order .companydata #story').val(),$('.order#order #tabs4 input[name="usercode"]').val(),$('.checkintellauser .inputdiv input[name="authcode"]').val(),$('.order#order .companydata #terminalnumber').val());
			res.done(function(res){
				$.ajax({
					url:'./lib/api/intella/intella.log.php',
					method:'post',
					async:false,
					data:{'function':'intellauser','res':res,'consecnumber':intellaconsecnumber,'total':intellamoney,'dep':$('.order#order .companydata #story').val(),'usercode':$('.order#order #tabs4 input[name="usercode"]').val(),'authcode':$('.checkintellauser .inputdiv input[name="authcode"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()}
				});
				if(typeof res==='object'){
					clearInterval(dotloading);
					if(res['Header']['StatusCode']=='0000'){//成功交易
						$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
						$('.checkintellauser .paras input[name="methodcode"]').val(res['Header']['Method']);
						$('.checkintellauser .loaddiv').html(res['Header']['MethodName']+' : 交易成功');
						$('.checkintellauser #successsale').prop('disabled',false);
					}
					else{//交易失敗
						$('.checkintellauser .loaddiv').html(res['Header']['MethodName']+'=>'+res['Header']['StatusDesc']);
						$('.checkintellauser #retry').prop('disabled',false);
					}
				}
				else{
					clearInterval(dotloading);
					res=JSON.parse(res);
					if(res['Header']['StatusCode']=='0000'){//成功交易
						$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
						$('.checkintellauser .paras input[name="methodcode"]').val(res['Header']['Method']);
						$('.checkintellauser .loaddiv').html(res['Header']['MethodName']+' : 交易成功');
						$('.checkintellauser #successsale').prop('disabled',false);
					}
					else{//交易失敗
						$('.checkintellauser .loaddiv').html(res['Header']['MethodName']+'=>'+res['Header']['StatusDesc']);
						$('.checkintellauser #retry').prop('disabled',false);
					}
				}
				$('.checkintellauser #cancelsale').prop('disabled',false);
			});
			/***正式***/
			/***demo***
			clearInterval(dotloading);
			$('.result #viewwindow input[name="intellaconsecnumber"]').val('testconsecnumber');
			$('.checkintellauser .paras input[name="methodcode"]').val('00000');
			$('.checkintellauser .loaddiv').html('交易成功');
			$('.checkintellauser #successsale').prop('disabled',false);
			$('.checkintellauser #cancelsale').prop('disabled',false);
			/***demo***/
		}
		else{
		}
	});
	$('.checkintellauser #successsale').click(function(){
		var content='';
		content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>英特拉</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'>"+$('.result .frontunit').val()+"<span class='intellaother' data-id='apipay' id='"+$('.checkintellauser .paras input[name="methodcode"]').val()+"'>";
		content=content+$('.checkintellauser .paras input[name="money"]').val()+"<input type='hidden' name='viewmoney' value='"+$('.checkintellauser .paras input[name="money"]').val()+"'></span>"+$('.result .unit').val()+"</div></div></div>";

		$('.result #paywindow #paycontent').append(content);

		checkintellauser.dialog('close');
		
		closedisbut();

		computerchange();

		$('.result #funbox .intellapay').prop('disabled',true);
	});
	$('.checkintellauser #retry').click(function(){
		$('.checkintellauser #retry').prop('disabled',true);
		$('.checkintellauser .loaddiv').css({'display':'none'});
		$('.checkintellauser .loaddiv').html("檢查交易<span id='dot'>...</span>");
		$('.checkintellauser .inputdiv input[name="authcode"]').val('');
		$('.checkintellauser .inputdiv').css({'display':'block'});
	});
	$('.checkintellauser #cancelsale').click(function(){
		if(!$('.checkintellauser #successsale').prop('disabled')){//交易成功
			$('.checkintellauser #successsale').trigger('click');
			$('.result #paywindow #paycontent .paywaybox:eq('+($('.result #paywindow #paycontent .paywaybox').length-1)+') input[name="checkbox"]').prop('checked',true);
			/***正式***/
			if(voidintella.dialog('isOpen')){
				$('.voidintella .qrhint').css({'visibility':'visible'});
				$('.voidintella #retry').css({'display':'none'});
				$('.voidintella #retry #time').html('');
				$('.voidintella').parent('.ui-dialog').find('.ui-dialog-titlebar .ui-button').css({'display':'none'});
				$('.voidintella #successsale').prop('disabled',true);
				$('.voidintella #cancelsale').css({'display':'none'});
				$('.voidintella .hintstring').html('');
				$('.voidintella .qrhint').html("退款連線中<span id='loading'>...</span>");
				dotloading=setInterval(function(){
					if($('.voidintella .qrhint #loading').length>0){
						if($('.voidintella .qrhint #loading').html().length==3){
							$('.voidintella .qrhint #loading').html('.');
						}
						else if($('.voidintella .qrhint #loading').html().length==2){
							$('.voidintella .qrhint #loading').html('...');
						}
						else{
							$('.voidintella .qrhint #loading').html('..');
						}
					}
					else{
					}
				},500);
			}
			else{
			/***正式***/
				$('.voidintella .qrhint').html("退款連線中<span id='loading'>...</span>");
				voidintella.dialog('open');
			/***正式***/
			}
			/***正式***/

			/***正式***/
			var res='';
			res=api_void_intellaother($('.result #viewwindow input[name="intellaconsecnumber"]').val(),$('.checkintellauser .paras input[name="money"]').val(),$('.order#order .companydata #story').val(),$('.order#order #tabs4 input[name="usercode"]').val(),$('.order#order .companydata #terminalnumber').val());
			res.done(function(res){
				$.ajax({
					url:'./lib/api/intella/intella.log.php',
					method:'post',
					async:false,
					data:{'function':'void_intellaother','res':res,'consecnumber':$('.result #viewwindow input[name="intellaconsecnumber"]').val(),'total':$('.checkintellauser .paras input[name="money"]').val(),'dep':$('.order#order .companydata #story').val(),'usercode':$('.order#order #tabs4 input[name="usercode"]').val(),'machine':$('.order#order .companydata #terminalnumber').val()}
				});
				res=JSON.parse(res);
				if(res['Header']['StatusCode']=='0000'){//退款成功
					$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
					$('.voidintella .qrhint').css({'visibility':'hidden'});
					$('.voidintella .hintstring').html(res['Header']['StatusDesc']);
					$('.voidintella #successsale').prop('disabled',false);
					clearInterval(dotloading);
				}
				else{
					$('.voidintella .qrhint').css({'visibility':'hidden'});
					$('.voidintella .hintstring').html(res['Header']['StatusDesc']+'<button id="retryvoid" style="float:right;">再試一次</button>');
					$('.voidintella #cancelsale').css({'display':'block'});
					clearInterval(dotloading);
				}
			});
			/***正式***/
			/***demo***
			$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
			$('.voidintella .qrhint').css({'visibility':'hidden'});
			$('.voidintella .hintstring').html('退款成功');
			$('.voidintella #successsale').prop('disabled',false);
			clearInterval(dotloading);
			/***demo***/
			checkintellauser.dialog('close');
		}
		else{//交易失敗
			checkintellauser.dialog('close');
		}
	});
	$('.intellapaymethod #exit').click(function(){
		intellapay.dialog('close');
	});
	$('.order#order #content #billfun #billfun3 #easycardbalancequery').click(function(){
		if(typeof api_easycard!=="undefined"&&typeof api_easycard==="function"){//英特拉悠遊卡
			intellabalancequery.dialog('open');
			var res=api_easycard('BalanceQuery',$('.order#order .companydata #terminalnumber').val());
			res.done(function(res){
				res=JSON.parse(res);
				if(res=='errorinput'){
					//console.log('變數輸入錯誤');
				}
				else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
					$('.intellabalancequery #retry').css({'display':'block'});
					$('.intellabalancequery #retry #time').html(res['Data']['Retry']);

					res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);//第一次重試
					res.done(function(res){
						res=JSON.parse(res);
						if(res=='errorinput'){
							//console.log('變數輸入錯誤');
						}
						else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
							$('.intellabalancequery #retry').css({'display':'block'});
							$('.intellabalancequery #retry #time').html(res['Data']['Retry']);

							res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);//第二次重試
							res.done(function(res){
								res=JSON.parse(res);
								if(res=='errorinput'){
									//console.log('變數輸入錯誤');
								}
								else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){
									$('.intellabalancequery #retry').css({'display':'block'});
									$('.intellabalancequery #retry #time').html(res['Data']['Retry']);

									res=api_easycard('Retry',$('.order#order .companydata #terminalnumber').val(),'',0,res);//第三次重試
									res.done(function(res){
										res=JSON.parse(res);
										if(res=='errorinput'){
											//console.log('變數輸入錯誤');
										}
										else if((typeof res['Data']['Retry']!=='undefined'&&parseInt(res['Data']['Retry'])>=1)&&(res['Data']['ErrorCode']=='000125'||res['Data']['ErrorCode']=='0462xx')){//第三次重試錯誤，不再重試
											$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
											$('.intellabalancequery .hintstring').html('重試三次失敗。(easy card)');
											$('.intellabalancequery #cancelsale').css({'display':'block'});
											clearInterval(dotloading);
										}
										else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
											$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
											$('.intellabalancequery .hintstring').html('卡片餘額：'+res['Data']['Balance']);
											$('.intellabalancequery #successsale').prop('disabled',false);
											clearInterval(dotloading);
										}
										else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
											$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
											$('.intellabalancequery .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
											//$('.intellabalancequery #successsale').prop('disabled',false);
											$('.intellabalancequery #cancelsale').css({'display':'block'});
											clearInterval(dotloading);
										}
										else{//其餘意外狀況
											//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
											$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
											$('.intellabalancequery .hintstring').html(res['Header']['StatusDesc']+'(3)');
											//$('.intellabalancequery #successsale').prop('disabled',false);
											$('.intellabalancequery #cancelsale').css({'display':'block'});
											clearInterval(dotloading);
										}
									});
								}
								else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
									$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
									$('.intellabalancequery .hintstring').html('卡片餘額：'+res['Data']['Balance']);
									$('.intellabalancequery #successsale').prop('disabled',false);
									clearInterval(dotloading);
								}
								else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
									$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
									$('.intellabalancequery .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
									//$('.intellabalancequery #successsale').prop('disabled',false);
									$('.intellabalancequery #cancelsale').css({'display':'block'});
									clearInterval(dotloading);
								}
								else{//其餘意外狀況
									//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
									$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
									$('.intellabalancequery .hintstring').html(res['Header']['StatusDesc']+'(3)');
									//$('.intellabalancequery #successsale').prop('disabled',false);
									$('.intellabalancequery #cancelsale').css({'display':'block'});
									clearInterval(dotloading);
								}
							});
						}
						else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
							$('.intellabalancequery .hintstring').html('卡片餘額：'+res['Data']['Balance']);
							$('.intellabalancequery #successsale').prop('disabled',false);
							clearInterval(dotloading);
						}
						else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
							$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
							$('.intellabalancequery .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
							//$('.intellabalancequery #successsale').prop('disabled',false);
							$('.intellabalancequery #cancelsale').css({'display':'block'});
							clearInterval(dotloading);
						}
						else{//其餘意外狀況
							//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
							$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
							$('.intellabalancequery .hintstring').html(res['Header']['StatusDesc']+'(3)');
							//$('.intellabalancequery #successsale').prop('disabled',false);
							$('.intellabalancequery #cancelsale').css({'display':'block'});
							clearInterval(dotloading);
						}
					});
				}
				else if(typeof res['Data']['TXNResult']!=='undefined'&&res['Data']['TXNResult']=='Success'){
					//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
					$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
					$('.intellabalancequery .hintstring').html('卡片餘額：'+res['Data']['Balance']);
					$('.intellabalancequery #successsale').prop('disabled',false);
					clearInterval(dotloading);
				}
				else if(typeof res['Header']['StatusCode']!=='undefined'&&res['Header']['StatusCode']=='0000'){
					//$('.result #viewwindow input[name="intellaconsecnumber"]').val(intellaconsecnumber);
					$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
					$('.intellabalancequery .hintstring').html('交易失敗代碼'+res['Data']['ErrorCode']);
					//$('.intellabalancequery #successsale').prop('disabled',false);
					$('.intellabalancequery #cancelsale').css({'display':'block'});
					clearInterval(dotloading);
				}
				else{//其餘意外狀況
					//$('.result #viewwindow input[name="intellaconsecnumber"]').val('');
					$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
					$('.intellabalancequery .hintstring').html(res['Header']['StatusDesc']+'(3)');
					//$('.intellabalancequery #successsale').prop('disabled',false);
					$('.intellabalancequery #cancelsale').css({'display':'block'});
					clearInterval(dotloading);
				}
			});
		}
		else if($('.order#order .initsetting #nccc').val()=='1'&&$('.order#order .initsetting #nccceasycard').val()=='1'){//2022/5/11 nccc電子票證
			var ncccdate='';
			intellabalancequery.dialog('open');
			$.ajax({
				url:'./lib/api/nccc/create.in.php',
				method:'post',
				async:false,
				data:{'type':'66'},
				dataType:'json',
				success:function(d){
					//console.log(d);
					ncccdate=d['date'];
				},
				error:function(e){
					//console.log(e);
				}
			});
			var res='';
			res=nccc_iscomplete(ncccdate);
			res.done(function(res){
				if(res['data']=='交易成功'){//成功
					$('.intellabalancequery .hintstring').html('卡片餘額：'+res['balance']);
					$('.intellabalancequery #successsale').prop('disabled',false);
				}
				else if(typeof res['statusText']!=='undefined'){//等待逾時
					$('.intellabalancequery .hintstring').html(res['statusText']);
					$('.intellabalancequery #cancelsale').css({'display':'block'});
				}
				else{//失敗
					$('.intellabalancequery .hintstring').html(res['data']);
					$('.intellabalancequery #cancelsale').css({'display':'block'});
				}
				$('.intellabalancequery .qrhint').css({'visibility':'hidden'});
				clearInterval(dotloading);
			});
		}
		else{
		}
	});
	$('.intellabalancequery #successsale, .intellabalancequery #cancelsale').click(function(){
		intellabalancequery.dialog('close');
	});
	$('.result #funbox .itri').click(function(){
		itritext.dialog('open');
	});
	$('.itritext #exit').click(function(){
		itritext.dialog('close');
	});
	$('.itritext #send').click(function(){
		if($('.itritext #coupon').val().length>0){
			if(typeof api_itri!=="undefined"&&typeof api_itri==="function"){
				var res=api_itri('Coupon_Exchange_CouponCert',$('.itritext #coupon').val());
				if(res['val']=="T"){
					//alertmessage('兌換成功');
					$('.alertmessage #text').html('兌換成功');
					alertmessage.dialog('open');
				}
				else{
					//alertmessage(res['msg']);
					$('.alertmessage #text').html(res['msg']);
					alertmessage.dialog('open');
				}
			}
			else{
			}
		}
		else{
		}
	});
	$('.alertmessage .check').click(function(){
		alertmessage.dialog('close');
	});
	//中鼎
	if(typeof $('.order#order .zdn')!=='undefined'&&typeof api_zdn_gettoken!=="undefined"&&typeof api_zdn_gettoken==="function"){
		var today = new Date();
		if((today.getMonth() + 1)%2==1){
			var mm = String(today.getMonth() + 2); //January is 0!
			if(mm.length<2){
				mm=String('0')+String(mm);
			}
			else{
			}
		}
		else{
			var mm = String(today.getMonth() + 1); //January is 0!
			if(mm.length<2){
				mm=String('0')+String(mm);
			}
			else{
			}
		}
		var yyyy = Number(today.getFullYear())-1911;

		var res='';
		res=api_zdn_gettoken($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #psw').val());//取得中鼎token
		res.done(function(res){
			res=JSON.parse(res);
			//console.log(res['token']);
			if(typeof res['token']){
				$('.order#order .zdn #token').val(res['token']);
				res='';
				res=api_zdn_showTrack($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),String(yyyy)+String(mm));
				res.done(function(res){
					res=JSON.parse(res);
					//console.log(res);
					var remaining=0;
					if(typeof res['data']!=="undefined"&&res['data'].length>0){
						for(var i=0;i<res['data'].length;i++){
							if(res['data'][i]['type']=='07'&&Number(res['data'][i]['used_booklet'])<Number(res['data'][i]['total_booklet'])){
								remaining=Number(remaining)+Number(res['data'][i]['total_booklet'])-Number(res['data'][i]['used_booklet']);
							}
							else{
							}
						}
						if(remaining>0){
							res='';
							/*res=api_zdn_getInv($('.order#order .zdn #url').val(),$('.order#order .zdn #id').val(),$('.order#order .zdn #token').val(),remaining);//取得發票號(以"本"為單位；1本50張)
							res.done(function(res){
								res=JSON.parse(res);
								//console.log(res);
								if(res['success']==true){
									$.ajax({
										url:'./lib/js/create.invfile.php',
										method:'post',
										data:{'machine':$('.order#order .companydata #terminalnumber').val(),'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'data':res},
										dataType:'html',
										success:function(d){
											//console.log(d);
										},
										error:function(e){
											//console.log(e);
										}
									});
								}
								else{
								}
							});*/
							//console.log(remaining);
						}
						else{
							//console.log('empty');
						}
					}
					else{
					}
				});
			}
			else{
				$.ajax({
					url:'./lib/js/print.php',
					method:'post',
					async:false,
					data:{'file':'zdninvlog','html':'api_zdn_gettoken get token fail','data':res},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
			}
		});
	}
	else{
	}

	$('.temptoinv').on('click','input[name="outman"]',function(){
		if($('.temptoinv .outmandiv').css('display')=='none'){
			$('.temptoinv select[name="date"]').prop('disabled',true);
			$('.temptoinv select[name="hour"]').prop('disabled',true);
			$('.temptoinv select[name="min"]').prop('disabled',true);
			$('.temptoinv input[name="outman"]').prop('disabled',true);
			$('.temptoinv input[name="printtag"]').prop('disabled',true);
			$('.temptoinv #reserve').prop('disabled',true);
			$('.temptoinv #continue').prop('disabled',true);
			temptoinv.dialog('option','width',900);
			$('.temptoinv .div').css({'width':'50%'});
			$('.temptoinv .outmandiv').css({'display':'block'});
		}
		else{
		}
	});
	$('.temptoinv').on('click','.outmandiv #number',function(){
		$('.temptoinv .outmandiv #mancode').val($('.temptoinv .outmandiv #mancode').val()+$(this).val());
		$.ajax({
			url:'./lib/js/get.manname.php',
			method:'post',
			async:false,
			data:{'mancode':$('.temptoinv .outmandiv #mancode').val()},
			dataType:'json',
			success:function(d){
				//console.log(typeof d[0]);
				if(typeof d[0]==="undefined"){
					$('.temptoinv .div input[name="outman"]').val('');
				}
				else{
					$('.temptoinv .div input[name="outman"]').val(d[0]['name']);
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.temptoinv').on('click','.outmandiv #clear',function(){
		$('.temptoinv .outmandiv #mancode').val('');
		$('.temptoinv .div input[name="outman"]').val('');
	});
	$('.temptoinv').on('click','.outmandiv #back',function(){
		if($('.temptoinv .outmandiv #mancode').val().length==0){
		}
		else{
			$('.temptoinv .outmandiv #mancode').val($('.temptoinv .outmandiv #mancode').val().substr(0,$('.temptoinv .outmandiv #mancode').val().length-1));
		}
		$.ajax({
			url:'./lib/js/get.manname.php',
			method:'post',
			async:false,
			data:{'mancode':$('.temptoinv .outmandiv #mancode').val()},
			dataType:'json',
			success:function(d){
				//console.log(typeof d[0]);
				if(typeof d[0]==="undefined"){
					$('.temptoinv .div input[name="outman"]').val('');
				}
				else{
					$('.temptoinv .div input[name="outman"]').val(d[0]['name']);
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.temptoinv').on('click','.outmandiv #return',function(){
		$('.temptoinv select[name="date"]').prop('disabled',false);
		$('.temptoinv select[name="hour"]').prop('disabled',false);
		$('.temptoinv select[name="min"]').prop('disabled',false);
		$('.temptoinv input[name="outman"]').prop('disabled',false);
		$('.temptoinv input[name="printtag"]').prop('disabled',false);
		$('.temptoinv #reserve').prop('disabled',false);
		$('.temptoinv #continue').prop('disabled',false);
		temptoinv.dialog('option','width',450);
		$('.temptoinv .div').css({'width':'100%'});
		$('.temptoinv .outmandiv').css({'display':'none'});
	});
	$('.viewtemp input[name="salebarcode"]').keypress(function(event){//查詢未結帳單
		//console.log(event.which);
		if(event.which==13){//送出查詢
			if($('.viewtemp input[name="salebarcode"]').val().length==14){//bizdate+consecnumber
				if($('.viewtemp #salelist').width()<$('.viewtemp #salelist .saletitle').width()){
					var scrollY=14+20;//saletitle height+bottom scroll height
				}
				else{
					var scrollY=14;//saletitle height
				}
				for(var i=0;i<$('.viewtemp #salelist #salecontent .listitems').length;i++){
					var bizdate=$('.viewtemp input[name="salebarcode"]').val().substr(0,8);
					var consecnumber=$('.viewtemp input[name="salebarcode"]').val().substr(8,6);
					scrollY += $('.viewtemp #salelist #salecontent .listitems:eq('+i+')').height()+21;
					//console.log(scrollY);
					if(bizdate==$('.viewtemp #salelist #salecontent .listitems:eq('+i+') div:eq(0)').html()&&consecnumber==$('.viewtemp #salelist #salecontent .listitems:eq('+i+') input[name="consecnumber"]').val()){
						$('.viewtemp #salelist #salecontent .listitems:eq('+i+')').trigger('click');
						if((scrollY-$('.viewtemp #salelist').height())<=0){
							$('.viewtemp #salelist').animate({
								scrollTop:0
							},600);
							//console.log('top');
						}
						else{
							$('.viewtemp #salelist').animate({
								scrollTop:(scrollY-$('.viewtemp #salelist').height())
							},600);
							//console.log('move');
						}
						//console.log((scrollY-$('.viewtemp #salelist').height()));
						break;
					}
					else{
					}
				}
			}
			else{
			}

			$('.viewtemp input[name="salebarcode"]').val('');
			console.log('send');
		}
		else{//輸入barcode
			console.log('enter');
		}
	});
	$('.order#order #content #billfun #billfun3 #computemoney').click(function(){
		$.ajax({
			url:'./lib/js/get.moneyinbox.php',
			method:'post',
			async:false,
			data:{'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.computemoney #sendbox input[name="bizdate"]').val(),'zcounter':$('.computemoney #sendbox input[name="zcounter"]').val()},
			dataType:'json',
			success:function(d){
				//console.log(d);
				$('.computemoney .change input[name="change"]').val(d[0]['change']);
				$('.computemoney .TAX2 input[name="TAX2"]').val(d[0]['initTAX2']);
				$('.computemoney .outmoney input[name="outmoney"]').val(d[0]['AMT']);
				$('.computemoney .previewmoney input[name="previewmoney"]').val(d[0]['TAX2']);
				$('.computemoney .diffmoney input[name="diffmoney"]').val(-d[0]['TAX2']);
				$('.computemoney #sendbox div[class^=div]').prop('id','');
				$('.computemoney #sendbox div[class^=div]:eq(0)').prop('id','focus');

				computemoney.dialog('open');
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.computemoney div[class^=div]').click(function(){
		$('.computemoney div[class^=div]').prop('id','');
		$(this).prop('id','focus');
	});
	$('.computemoney #number').click(function(){
		if($('.computemoney div[class^=div]#focus').length>0){
			if($(this).val()=='AC'){//AC
				$('.computemoney .total input[name="total"]').val(parseInt($('.computemoney .total input[name="total"]').val())-parseInt($('.computemoney div[class^=div]#focus input[name="coinvalue[]"]').val()*$('.computemoney div[class^=div]#focus input[name="coinnumber[]"]').val()));
				$('.computemoney div[class^=div]#focus input[name="coinnumber[]"]').val('0');

				$('.computemoney .diffmoney input[name="diffmoney"]').val(parseInt($('.computemoney .total input[name="total"]').val())-parseInt($('.computemoney .previewmoney input[name="previewmoney"]').val()));
			}
			else if($(this).val()=='NEXT'){//NEXT
				var index=$('.computemoney div[class^=div]#focus').index('.computemoney div[class^=div]');
				$('.computemoney div[class^=div]').prop('id','');
				if((index+1)<$('.computemoney div[class^=div]').length){
					$('.computemoney div[class^=div]:eq('+(index+1)+')').prop('id','focus');
				}
				else{
				}
			}
			else{
				$('.computemoney .total input[name="total"]').val(parseInt($('.computemoney .total input[name="total"]').val())-parseInt($('.computemoney div[class^=div]#focus input[name="coinvalue[]"]').val()*$('.computemoney div[class^=div]#focus input[name="coinnumber[]"]').val()));
				$('.computemoney div[class^=div]#focus input[name="coinnumber[]"]').val(parseInt($('.computemoney div[class^=div]#focus input[name="coinnumber[]"]').val()*10)+parseInt($(this).val()));
				$('.computemoney .total input[name="total"]').val(parseInt($('.computemoney .total input[name="total"]').val())+parseInt($('.computemoney div[class^=div]#focus input[name="coinvalue[]"]').val()*$('.computemoney div[class^=div]#focus input[name="coinnumber[]"]').val()));

				$('.computemoney .diffmoney input[name="diffmoney"]').val(parseInt($('.computemoney .total input[name="total"]').val())-parseInt($('.computemoney .previewmoney input[name="previewmoney"]').val()));
			}
		}
		else{
		}
	});
	$('.computemoney #return').click(function(){
		computemoney.dialog('close');
	});
	$('.computemoney #send').click(function(){
		$.ajax({
			url:'./lib/js/print.ticket.php',
			method:'post',
			async:false,
			data:$('.computemoney #sendbox').serialize(),
			dataType:'html',
			success:function(d){
				//console.log(d);
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.order#order #banner #salelisthint').click(function(){
		$('.salelisthint textarea[name="hintstring"]').val($(this).val());
		salelisthint.dialog('open');
	});
	$('.salelisthint button[data-id="number"], .salelisthint #quickhint .hintitem').click(function(){
		$('.salelisthint textarea[name="hintstring"]').val($('.salelisthint textarea[name="hintstring"]').val()+$(this).val());
		$('.salelisthint textarea[name="hintstring"]').scrollTop($('.salelisthint textarea[name="hintstring"]')[0].scrollHeight);
	});
	$('.salelisthint button[data-id="ntoe"]').click(function(){
		if($('.salelisthint button[data-id="number"]:eq(0)').val()=='1'){//目前為數字，轉為英文
			$(this).html('123');
			$('.salelisthint button[data-id="chpage"]').prop('disabled',false);
			$('.salelisthint button[data-id="chpage"]').val('1');
			for(var i=0;i<$('.salelisthint button[data-id="number"]').length;i++){
				var chart=String.fromCharCode(parseInt(65)+parseInt(i));
				$('.salelisthint button[data-id="number"]:eq('+i+')').val(chart);
				$('.salelisthint button[data-id="number"]:eq('+i+')').html(chart);
			}
		}
		else{//目前為英文，轉為數字
			$(this).html('ABC');
			$('.salelisthint button[data-id="chpage"]').prop('disabled',true);
			for(var i=0;i<$('.salelisthint button[data-id="number"]').length;i++){
				//var chart=String.fromCharCode(parseInt(65)+parseInt(i));
				$('.salelisthint button[data-id="number"]:eq('+i+')').val((i+1)%10);
				$('.salelisthint button[data-id="number"]:eq('+i+')').html((i+1)%10);
			}
		}
	});
	$('.salelisthint button[data-id="chpage"]').click(function(){
		if($(this).val()=='3'){
			$(this).val('1');
		}
		else{
			$(this).val(parseInt($(this).val())+parseInt(1));
		}
		for(var i=0;i<$('.salelisthint button[data-id="number"]').length;i++){
			var code=parseInt(65)+parseInt(i)+(parseInt($(this).val())-parseInt(1))*10;
			if(code<=90){//Z>>String.fromCharCode(65+25)
				var chart=String.fromCharCode(code);
				$('.salelisthint button[data-id="number"]:eq('+i+')').val(chart);
				$('.salelisthint button[data-id="number"]:eq('+i+')').html(chart);
			}
			else{
				$('.salelisthint button[data-id="number"]:eq('+i+')').val('');
				$('.salelisthint button[data-id="number"]:eq('+i+')').html('');
			}
		}
	});
	$('.salelisthint #clear').click(function(){
		$('.salelisthint textarea[name="hintstring"]').val('');
	});
	$('.salelisthint #check').click(function(){
		$('.order#order #banner #detail #salelisthint').val($('.salelisthint textarea[name="hintstring"]').val());
		salelisthint.dialog('close');
	});
	$('.checkdeletesale #cancel').click(function(){
		checkdeletesale.dialog('close');
	});
	$('.checkdeletesale #send').click(function(){
		$('.verpsw input[name="type"]').val($('.checkdeletesale input[name="type"]').val());
		if($('.order#order .initsetting #voidsale').val()=='0'){
			$('.verpsw input[name="verpsw"]').val($('.checkdeletesale input[name="psw"]').val());
			//verpsw.dialog('open');
			$('.verpsw #send').trigger('click');
		}
		else{
			verpsw.dialog('open');
		}

		checkdeletesale.dialog('close');
	});

	if($('.order#order .initsetting #openrfid').val()=='2'){//2020/5/20 單卡讀取需要
		function autoread(){
			var res='';
			res=api_single_readrfid();
			res.done(function(res){
				if(res!=''){
					if(typeof res==='object'){
					}
					else{
						res=JSON.parse(res);
					}

					if($('.rfidlist .readnumber').val()!=''){
					}
					else{
						$('.rfidlist .readnumber').val('0');
					}
					$('.rfidlist .readnumber').val(parseInt($('.rfidlist .readnumber').val())+parseInt(res.length));
					$('.rfidlist .listno').val(res.toString());

					if(res.length>0){
						if($('.rfidlist .list .items').length>0){
							var lastone=parseInt($('.rfidlist .list .items:eq('+($('.rfidlist .list .items').length-1)+') input[name="linenumber[]"]').val())+2;
							var lastorder=parseInt($('.rfidlist .list .items:eq('+($('.rfidlist .list .items').length-1)+') input[name="order[]"]').val())+1;
						}
						else if($('.order#order #tabs4 .listcontent .label').length>0){
							var lastone=parseInt($('.order#order #tabs4 .listcontent .label:eq('+($('.order#order #tabs4 .listcontent .label').length-1)+') input[name="linenumber[]"]').val())+2;
							var lastorder=parseInt($('.order#order #tabs4 .listcontent .label:eq('+($('.order#order #tabs4 .listcontent .label').length-1)+') input[name="order[]"]').val())+1;
						}
						else{
							var lastone=1;
							var lastorder=1;
						}
						$.ajax({
							url:'./lib/js/get.rfidlist.ajax.php',
							method:'post',
							async:false,
							data:{'list':res.toString(),'lastone':lastone,'lastorder':lastorder,'type':'2','readlast':$('.rfidlist .list .items').length},
							dataType:'html',
							success:function(d){
								//console.log(d);
								$('.rfidbeep .beepcontrol')[0].play();
								$('.rfidlist .list').append(d);
								$('.rfidlist .list').scrollTop($('.rfidlist .list').height());
							},
							error:function(e){
								console.log(e);
							}
						});

						if(stop==0){
							setTimeout(function(){autoread()},parseFloat($('.order#order .initsetting #readrfidinterval').val())*1000);
						}
						else{
						}
					}
					else{
						if(stop==0){
							autoread();
						}
						else{
						}
					}
				}
				else{
					if(stop==0){
						autoread();
					}
					else{
					}
				}
			});
		}
	}
	else{
	}

	$('.order#order #list #funbox .readrfid').click(function(){
		if($('.order#order .initsetting #openrfid').val()=='1'){//2020/5/20 開啟多卡讀取
			checkrfid.dialog('open');
			var res='';
			res=api_readrfid();
			res.done(function(res){
				if(typeof res==='object'){
				}
				else{
					res=JSON.parse(res);
				}
				
				//console.log(res);

				/*if(res.length>0&&res[0]!=''){
					var e = $.Event( "keypress", { which: 13 } );
					for(var i=0;i<res.length;i++){
						//console.log(parseInt(res[i]));
						$('.order#order #MemberBill #list #funbox .quickorder').val(parseInt(res[i]));
						$('.order#order #MemberBill #list #funbox .quickorder').trigger(e);
					}
				}
				else{
					//console.log('error');
				}*/

				checkrfid.dialog('close');
				
				$('.rfidlist .readnumber').val(res.length);
				$('.rfidlist .listno').val(res.toString());
				
				if(res.length>0){
					if($('.order#order #tabs4 .listcontent .label').length>0){
						var lastone=parseInt($('.order#order #tabs4 .listcontent .label:eq('+($('.order#order #tabs4 .listcontent .label').length-1)+') input[name="linenumber[]"]').val())+2;
						var lastorder=parseInt($('.order#order #tabs4 .listcontent .label:eq('+($('.order#order #tabs4 .listcontent .label').length-1)+') input[name="order[]"]').val())+1;
					}
					else{
						var lastone=1;
						var lastorder=1;
					}
					$.ajax({
						url:'./lib/js/get.rfidlist.ajax.php',
						method:'post',
						async:false,
						data:{'list':res.toString(),'lastone':lastone,'lastorder':lastorder},
						dataType:'html',
						success:function(d){
							//console.log(d);
							$('.rfidlist .list').html(d);
						},
						error:function(e){
							console.log(e);
						}
					});
				}
				else{
				}
				//getdata('',limit[1],'quickcode','','');

				rfidlist.dialog('open');
			});
		}
		else{//2020/5/20 $('.order#order .initsetting #openrfid').val()=='2' 開啟單卡讀取
			rfidlist.dialog('open');
			autoread();
		}
	});
	$('.rfidlist .retry').click(function(){
		if($('.order#order .initsetting #openrfid').val()=='1'){//2020/5/20 開啟多卡讀取
			rfidlist.dialog('close');
			$('.order#order #list #funbox .readrfid').trigger('click');
		}
		else{
			stop=1;
			$('.rfidlist .retry').prop('disabled',true);
			$('.rfidlist .send').prop('disabled',false);
		}
	});
	$('.rfidlist .send').click(function(){
		if(Number($('.rfidlist .readnumber').val())>0){
			for(var i=0;i<$('.rfidlist .list .items').length;i++){
				var itemhtml='<div class="label" style="width:100%;border-top:1px solid #dfdfdf;">';
				itemhtml += '<input type="hidden" name="linenumber[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="linenumber[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="order[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="order[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="typeno[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="typeno[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="type[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="type[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="no[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="no[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="needcharge[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="needcharge[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="personcount[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="personcount[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="dis1[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="dis1[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="dis2[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="dis2[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="dis3[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="dis3[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="dis4[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="dis4[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="name[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="name[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="name2[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="name2[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="isgroup[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="isgroup[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="childtype[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="childtype[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="mname1[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="mname1[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="mname2[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="mname2[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="insaleinv[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="insaleinv[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="unitprice[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="unitprice[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="money[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="money[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="discount[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="discount[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="discontent[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="discontent[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="dispoint[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="dispoint[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="dispointtime[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="dispointtime[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="number[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="number[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="subtotal[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="subtotal[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="taste1[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="taste1[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="taste1name[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="taste1name[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="taste1price[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="taste1price[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="taste1number[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="taste1number[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="taste1money[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="taste1money[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="itemdis[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="itemdis[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="listdis[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="listdis[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="bothdis[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="bothdis[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="usemempoint[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="usemempoint[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="getpointtype[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="getpointtype[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="initgetpoint[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="initgetpoint[]"]').val()+'">';
				itemhtml += '<input type="hidden" name="gerpoint[]" value="'+$('.rfidlist .list .items:eq('+i+') input[name="gerpoint[]"]').val()+'">';
				itemhtml += '<div style="width:3%;padding:3px 0;"><input type="checkbox" data-id="checkbox[]"></div>';
				itemhtml += '<div style="width:10%;padding:3px 0 3px 3px;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;">'+$('.rfidlist .list .items:eq('+i+') input[name="order[]"]').val()+'</div>';
				itemhtml += '<div style="width:calc(57%);padding:3px 0;" id="view">'+$('.rfidlist .list .items:eq('+i+') input[name="name[]"]').val();
				if($('.rfidlist .list .items:eq('+i+') input[name="name2[]"]').val()!=''){
					itemhtml += ' /'+$('.rfidlist .list .items:eq('+i+') input[name="name2[]"]').val();
				}
				else{
				}
				if($('.rfidlist .list .items:eq('+i+') input[name="mname1[]"]').val()!=''){
					itemhtml += '('+$('.rfidlist .list .items:eq('+i+') input[name="mname1[]"]').val()+')';
				}
				else{
				}
				itemhtml += '</div>';
				itemhtml += '<div style="width:10%;text-align:right;padding:3px 0;" id="unitprice">'+$('.rfidlist .list .items:eq('+i+') input[name="unitprice[]"]').val()+'</div>';
				itemhtml += '<div style="width:10%;text-align:center;padding:3px 0;" id="number">'+$('.rfidlist .list .items:eq('+i+') input[name="number[]"]').val()+'</div>';
				itemhtml += '<div style="width:10%;text-align:right;padding:3px 0;" id="subtotal">'+$('.rfidlist .list .items:eq('+i+') input[name="subtotal[]"]').val()+'</div>';
				itemhtml += '</div>';
				$('.order#order #tabs4 .listcontent').append(itemhtml);
			}
			if($('.order#order .initsetting #secview').val()=='1'){//2020/4/24 寫入客顯tempDB
				$.ajax({
					url:'../secview/writeitem.rfid.php',
					method:'post',
					data:{'linenumber':$.map($('.rfidlist .list .items input[name="linenumber[]"]').toArray(),function(item,idnex){return item.value}),'usercode':'rfid','username':'RFID','company':$('.order#order .companydata #company').val(),'listtype':$('.order#order #tabs4 form[data-id="listform"] input[name="listtype"]').val(),'consecnumber':$('.order#order #tabs4 form[data-id="listform"] input[name="consecnumber"]').val(),'itemtype':$.map($('.rfidlist .list .items input[name="typeno[]"]').toArray(),function(item,idnex){return item.value}),'no':$.map($('.rfidlist .list .items input[name="no[]"]').toArray(),function(item,idnex){return item.value}),'dep':'','number':$.map($('.rfidlist .list .items input[name="number[]"]').toArray(),function(item,idnex){return item.value}),'mname':$.map($('.rfidlist .list .items input[name="mname1[]"]').toArray(),function(item,idnex){return item.value}),'money1':$.map($('.rfidlist .list .items input[name="unitprice[]"]').toArray(),function(item,idnex){return item.value}),'taste':$.map($('.rfidlist .list .items input[name="taste1[]"]').toArray(),function(item,idnex){return item.value}),'tastenumber':$.map($('.rfidlist .list .items input[name="taste1number[]"]').toArray(),function(item,idnex){return item.value}),'tastemoney':$.map($('.rfidlist .list .items input[name="taste1money[]"]').toArray(),function(item,idnex){return item.value}),'subtotal':$.map($('.rfidlist .list .items input[name="subtotal[]"]').toArray(),function(item,idnex){return item.value}),'machinename':$('.order#order .companydata #terminalnumber').val()},
					async: false,
					dataType:'html',
					success:function(d){
						/*if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'writeitem.ajax.php '+d},
								dataType:'html',
								success:function(d){
									//console.log(d);
								},
								error:function(e){
									//console.log(e);
								}
							});
						}
						else{
						}*/
						console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				if(typeof socket!=="undefined"){//2020/10/29 nodejs - Push server
					socket.emit('secviewupdate',[$('.order#order .companydata #terminalnumber').val(),'listitemupdate']);
					console.log('send message "listitemupdate" to secview');
				}
				else{
				}
			}
			else{
			}
			sumsubtotal('quickorder');
		}
		else{
		}
		rfidlist.dialog('close');
	});
	/*directlinepay*/
	$('.result .directlinepay').click(function(){
		//$('.result .directlinepay').prop('disabled',true);
		if($('.result #paywindow #paycontent .payway span[data-id="apipay"]').length==0){//2022/10/28 加上全支付//2022/10/6 加上街口支付//2022/5/6 未使用api串接的付款方式(英特拉電子支付、聯合信用卡中心刷卡、直接linepay付款)才能使用該付款方式
			readlinecode.dialog('open');
		}
		else{
		}
	});
	$('.readlinecode input[name="linecode"]').keydown(function(event){
		//console.log($('.readlinecode input[name="linecode"]').val());
		if(event.which==13){
			$('.readlinecode input[name="linecode"]').attr('type','hidden');
			if($('.result input[name="view"]').val()==''||$('.result input[name="view"]').val()=='0'){
				var money=$('.result #viewwindow #notyet').html();
			}
			else if(Number($('.result input[name="view"]').val())>Number($('.result #viewwindow #notyet').html())){
				var money=$('.result #viewwindow #notyet').html();
			}
			else{
				var money=$('.result input[name="view"]').val();
			}
			$('.readlinecode input[name="money"]').val(money);
			var datetime=new Date();
			var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
			$('.readlinecode input[name="orderid"]').val(orderid);
			if(money>0&&typeof directlinepay_payment!=="undefined"&&typeof directlinepay_payment==="function"){
				$('.readlinecode .qrhint').html('交易中<span id="dot">...</span>');
				$('.readlinecode #cancelsale').prop('disabled',true);
				var dotloading=setInterval(function(){
					if($('.readlinecode .qrhint #dot').length>0){
						if($('.readlinecode .qrhint #dot').html().length==3){
							$('.readlinecode .qrhint #dot').html('.');
						}
						else if($('.readlinecode .qrhint #dot').html().length==2){
							$('.readlinecode .qrhint #dot').html('...');
						}
						else{
							$('.readlinecode .qrhint #dot').html('..');
						}
					}
					else{
					}
				},500);
				var res='';
				res=directlinepay_payment($('.order#order .companydata #company').val(),$('.order#order .companydata #story').val(),$('.order#order .directlinepay #url').val(),$('.order#order .directlinepay #channelid').val(),$('.order#order .directlinepay #channelsecret').val(),money,orderid,$('.readlinecode input[name="linecode"]').val());
				res.done(function(res){
					//console.log(res['returnCode']);
					if(typeof res['returnCode']!=='undefined'&&res['returnCode']=='0000'){//2022/4/28 成功交易
						$('.readlinecode .hintstring').html(res['returnMessageC']);
						$('.readlinecode #successsale').prop('disabled',false);
						//2022/11/14 linepay付款，吐回手機載具
						/*if(typeof res['info']!=='undefined'&&typeof res['info']['merchantReference']!=='undefined'&&typeof res['info']['merchantReference']['affiliateCards']!=='undefined'){
						}
						else{
						}*/
					}
					else if(typeof res['statusText']!=='undefined'){//等待逾時
						$('.readlinecode #successsale').css({'display':'none'});
						$('.readlinecode #checksale').css({'display':'block'});
						$('.readlinecode #cancelsale').prop('disabled',true);
						$('.readlinecode .hintstring').html(res['statusText']);
					}
					else{
						$('.readlinecode .hintstring').html(res['returnMessageC']);
						$('.readlinecode #cancelsale').prop('disabled',false);
					}
					clearInterval(dotloading);
					$('.readlinecode .qrhint').html('');
				});
			}
			else if(money<=0){//提醒付款金額不大於0
				if($('.sysmeg #name1.syshint11').length>0){
					$('.sysmeg #name1.syshint11').css({'display':''});
				}
				else{
				}
				if($('.sysmeg #name2.syshint11').length>0){
					$('.sysmeg #name2.syshint11').css({'display':''});
				}
				else{
				}
				sysmeg.dialog('open');
			}
			else{
			}
		}
		else{
		}
	});
	$('.readlinecode #successsale').click(function(){
		if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
			target='result';
		}
		else{
			target='editpay';
		}
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		var content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.readlinecode #buttonhtml').html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' data-id='apipay' id='"+$('.readlinecode input[name="saverowname"]').val()+"'>"+$('.readlinecode input[name="money"]').val()+"<input type='hidden' name='initview' value='"+$('.readlinecode input[name="money"]').val()+"'>";
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			var temp=roundfun((Number($('.readlinecode input[name="money"]').val())*Number($('.readlinecode input[name="price"]').val())),precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			var temp=ceilfun((Number($('.readlinecode input[name="money"]').val())*Number($('.readlinecode input[name="price"]').val())),precision);
		}
		else{//無條件捨去
			var temp=floorfun((Number($('.readlinecode input[name="money"]').val())*Number($('.readlinecode input[name="price"]').val())),precision);
		}
		content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$('.readlinecode input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.readlinecode input[name="type"]').val()+"'><input type='hidden' name='directlinepay' value='1'><input type='hidden' name='orderid' value='"+$('.readlinecode input[name="orderid"]').val()+"'></span></div></div></div>";
		if(target=='result'){
			$('.result #paywindow #paycontent').append(content);
		}
		else{
			$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
		}
		if(target=='result'){
			closedisbut();

			computerchange();
		}
		else{
			editpaycomchange();
		}
		readlinecode.dialog('close');
	});
	$('.readlinecode #checksale').click(function(){
		$('.readlinecode .qrhint').html('檢查交易中<span id="dot">...</span>');
		$('.readlinecode .hintstring').html('');
		$('.readlinecode #successsale').css({'display':'block'});
		$('.readlinecode #checksale').css({'display':'none'});
		$('.readlinecode #cancelsale').prop('disabled',true);
		var dotloading=setInterval(function(){
			if($('.readlinecode .qrhint #dot').length>0){
				if($('.readlinecode .qrhint #dot').html().length==3){
					$('.readlinecode .qrhint #dot').html('.');
				}
				else if($('.readlinecode .qrhint #dot').html().length==2){
					$('.readlinecode .qrhint #dot').html('...');
				}
				else{
					$('.readlinecode .qrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		console.log($('.readlinecode input[name="orderid"]').length);
		res=directlinepay_payment_statuscheck($('.order#order .companydata #company').val(),$('.order#order .companydata #story').val(),$('.order#order .directlinepay #url').val(),$('.order#order .directlinepay #channelid').val(),$('.order#order .directlinepay #channelsecret').val(),$('.readlinecode input[name="orderid"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['returnCode']!=='undefined'&&res['returnCode']=='0000'){//2022/4/28 成功交易
				if(res['info']['status']=='COMPLETE'){//成功
					//$('.readlinecode input[name="orderid"]').val(res['info']['orderId']);
					$('.readlinecode .hintstring').html('成功');
					$('.readlinecode #successsale').prop('disabled',false);
				}
				else{//if(res['info']['status']=='FAIL')//失敗
					$('.readlinecode .hintstring').html(res['failReturnMessageC']);
					$('.readlinecode #cancelsale').prop('disabled',false);
				}
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.readlinecode #successsale').css({'display':'none'});
				$('.readlinecode #checksale').css({'display':'block'});
				$('.readlinecode #cancelsale').prop('disabled',false);
				$('.readlinecode .hintstring').html(res['statusText']);
			}
			else{
				$('.readlinecode .hintstring').html(res['returnMessageC']);
				$('.readlinecode #cancelsale').prop('disabled',false);
			}
			clearInterval(dotloading);
			$('.readlinecode .qrhint').html('');
		});
	});
	$('.readlinecode #cancelsale').click(function(){
		readlinecode.dialog('close');
		$('.result .directlinepay').prop('disabled',false);
	});
	$('.voidlinepay #successsale').click(function(){
		voidlinepay.dialog('close');
		//$('.result #viewwindow .sendviewwindow input[name="creditcard"]').val('');
		$('.result #paywindow .paywaybox .payway #name1 input[name="directlinepay"][value="1"]').parent('#name1').parent('div').parent('.payway').parent('.paywaybox').remove();

		if($('.result #paywindow .paywaybox').length==0){
			opendisbut();
		}
		else{
		}

		computerchange();
	});
	$('.voidlinepay #cancelsale').click(function(){
		voidlinepay.dialog('close');
		computerchange();
	});
	$('.voidsalewithlinepay #successsale').click(function(){//作廢帳單直接linepay付款退款成功
		var type=$('.voidsalewithlinepay input[name="type"]').val();
		voidsalewithlinepay.dialog('close');
		switch(type){
			case 'editlist'://修改帳單
				//console.log('1');
				var voidbizdate=$('.salelist #date').html();
				var voidconsecnumber=$('.salelist #listno input[name="consecnumber"]').val();
				var nowbizdate=$('.salelist #date').html();
				var listtype='';
				var tabnum='';
				var consecnumber='';
				if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																},
																error:function(e){
																	//console.log(e);
																}
															});
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
													},
													error:function(e){
														//if(d.length>40||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														/*}
														else{
														}*/
														//console.log(e);
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(d.substr(0,7)=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'creditcard getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
										//console.log('e1');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
											//console.log('e2');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'void'://作廢帳單
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'creditcard deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							$('.salevoid #listno').html('');
							$('.salevoid #list #listcontent').html('');
							$('.salevoid #date').html('');
							$('.salevoid #credate').html('');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
						verpsw.dialog('close');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'voidbyinv'://依發票作廢帳單
				var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
					dataType:'html',
					success:function(d){
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													async:false,
													data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							verpsw.dialog('close');
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				salevoidbyinv.dialog('close');
				break;
			case 'viewvoid'://2021/9/14 暫結作廢
				var nowbizdate=$('.viewtemp #date').html();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/viewvoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						var tempres=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile=tempres[1];
						}
						else{
						}
						//console.log(d);
						if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
							if(tempres[0]=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	async:false,
																	data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															$('.viewtemp #salelist #salecontent .listitems').prop('id','');
															$('.viewtemp #listno').html('');
															$('.viewtemp #list #listcontent').html('');
															$('.viewtemp #date').html('');
															$('.viewtemp #credate').html('');
															$('.viewtemp #otherfun button#plus').prop('disabled',true);
															$('.viewtemp #otherfun button#openinv').prop('disabled',true);
															$('.viewtemp #viewvoid').prop('disabled',true);
															$('.viewtemp #fun button#forall').prop('disabled',true);
															$('.viewtemp #fun button#list').prop('disabled',true);
															$('.viewtemp #fun button#tag').prop('disabled',true);
															$('.viewtemp #fun button#kitchen').prop('disabled',true);
															$('.viewtemp #fun button#changecheck').prop('disabled',true);
															$('.viewtemp #fun button#editoutman').prop('disabled',true);
															$('.order#order #banner #detail #tw #view').trigger('click');
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
						}
						else{
							$('.viewtemp #salelist #salecontent .listitems').prop('id','');
							$('.viewtemp #listno').html('');
							$('.viewtemp #list #listcontent').html('');
							$('.viewtemp #date').html('');
							$('.viewtemp #credate').html('');
							$('.viewtemp #otherfun button#plus').prop('disabled',true);
							$('.viewtemp #otherfun button#openinv').prop('disabled',true);
							$('.viewtemp #viewvoid').prop('disabled',true);
							$('.viewtemp #fun button#forall').prop('disabled',true);
							$('.viewtemp #fun button#list').prop('disabled',true);
							$('.viewtemp #fun button#tag').prop('disabled',true);
							$('.viewtemp #fun button#kitchen').prop('disabled',true);
							$('.viewtemp #fun button#changecheck').prop('disabled',true);
							$('.viewtemp #fun button#editoutman').prop('disabled',true);
							$('.order#order #banner #detail #tw #view').trigger('click');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});									
				break;
			default:
				break;
		}
	});
	$('.voidsalewithlinepay #cancelsale').click(function(){//作廢帳單直接linepay付款退款失敗
		voidsalewithlinepay.dialog('close');
	});
	/*jkos*/
	$('.result .jkos').click(function(){
		//$('.result .jkos').prop('disabled',true);
		if($('.result #paywindow #paycontent .payway span[data-id="apipay"]').length==0){//2022/10/28 加上全支付//2022/10/6 加上街口支付//2022/5/6 未使用api串接的付款方式(英特拉電子支付、聯合信用卡中心刷卡、直接linepay付款)才能使用該付款方式
			readjkoscode.dialog('open');
		}
		else{
		}
	});
	$('.readjkoscode input[name="jkoscode"]').keydown(function(event){
		//console.log($('.readjkoscode input[name="jkoscode"]').val());
		if(event.which==13){
			$('.readjkoscode input[name="jkoscode"]').attr('type','hidden');
			if($('.result input[name="view"]').val()==''||$('.result input[name="view"]').val()=='0'){
				var money=$('.result #viewwindow #notyet').html();
			}
			else if(Number($('.result input[name="view"]').val())>Number($('.result #viewwindow #notyet').html())){
				var money=$('.result #viewwindow #notyet').html();
			}
			else{
				var money=$('.result input[name="view"]').val();
			}
			$('.readjkoscode input[name="money"]').val(money);
			var datetime=new Date();
			var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
			$('.readjkoscode input[name="orderid"]').val(orderid);
			if(money>0&&typeof jkos_Payment!=="undefined"&&typeof jkos_Payment==="function"){
				$('.readjkoscode .payTitle').html('Payment');
				$('.readjkoscode .payqrhint').html('交易中<span id="dot">...</span>');
				$('.readjkoscode #closejkos').prop('disabled',true);
				var dotloading=setInterval(function(){
					if($('.readjkoscode .payqrhint #dot').length>0){
						if($('.readjkoscode .payqrhint #dot').html().length==3){
							$('.readjkoscode .payqrhint #dot').html('.');
						}
						else if($('.readjkoscode .payqrhint #dot').html().length==2){
							$('.readjkoscode .payqrhint #dot').html('...');
						}
						else{
							$('.readjkoscode .payqrhint #dot').html('..');
						}
					}
					else{
					}
				},500);
				var res='';
				res=jkos_Payment($('.order#order .jkos #url').val(),$('.order#order .jkos #systemname').val(),$('.order#order .jkos #merchantkey').val(),$('.order#order .jkos #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),orderid,$('.readjkoscode input[name="jkoscode"]').val(),money);
				res.done(function(res){
					//console.log(res['StatusCode']);
					if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='000'){//2022/4/28 成功交易
						$('.readjkoscode .payhintstring').html(res['StatusDesc']);
						$('.readjkoscode #successsale').prop('disabled',false);
						if(typeof res['InvoiceVehicle']!=='undefined'&&res['InvoiceVehicle']!=''&&res['InvoiceVehicle']!=null){//2022/10/13 發票載具(依照文件來看，只有手機載具
							$('.readjkoscode input[name="carrier"]').val(res['InvoiceVehicle']);
						}
						else{
						}
						if(typeof res['TradeNo']!=='undefined'&&res['TradeNo']!=''&&res['TradeNo']!=null){//2022/10/13 街口支付端交易序號，後續退款需要使用
							$('.readjkoscode input[name="tradeno"]').val(res['TradeNo']);
						}
						else{
						}
					}
					else if(typeof res['statusText']!=='undefined'){//等待逾時
						$('.readjkoscode #successsale').css({'display':'none'});
						//2022/10/19 API文件：人員面對顧客交易，一般建議若有異常，直接進入取消交易流程
						//$('.readjkoscode #checksale').prop('disabled',false);
						//$('.readjkoscode #checksale').css({'display':'block'});
						//$('.readjkoscode #closejkos').prop('disabled',true);
						//$('.readjkoscode .hintstring').html(res['statusText']);
						//$('.readjkoscode #checksale').trigger('click');

						$('.readjkoscode #cancelsale').prop('disabled',false);
						$('.readjkoscode #cancelsale').css({'display':'block'});
						$('.readjkoscode #closejkos').prop('disabled',true);
						$('.readjkoscode .payhintstring').html(res['statusText']);
						$('.readjkoscode #cancelsale').trigger('click');
					}
					else{
						$('.readjkoscode .payhintstring').html(res['StatusDesc']);
						$('.readjkoscode #closejkos').prop('disabled',false);
					}
					clearInterval(dotloading);
					$('.readjkoscode .payqrhint').html('');
				});
			}
			else if(money<=0){//提醒付款金額不大於0
				if($('.sysmeg #name1.syshint11').length>0){
					$('.sysmeg #name1.syshint11').css({'display':''});
				}
				else{
				}
				if($('.sysmeg #name2.syshint11').length>0){
					$('.sysmeg #name2.syshint11').css({'display':''});
				}
				else{
				}
				sysmeg.dialog('open');
			}
			else{
			}
		}
		else{
		}
	});
	$('.readjkoscode #successsale').click(function(){
		if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
			target='result';
		}
		else{
			target='editpay';
		}
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		var content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.readjkoscode #buttonhtml').html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' data-id='apipay' id='"+$('.readjkoscode input[name="saverowname"]').val()+"'>"+$('.readjkoscode input[name="money"]').val()+"<input type='hidden' name='initview' value='"+$('.readjkoscode input[name="money"]').val()+"'>";
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			var temp=roundfun((Number($('.readjkoscode input[name="money"]').val())*Number($('.readjkoscode input[name="price"]').val())),precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			var temp=ceilfun((Number($('.readjkoscode input[name="money"]').val())*Number($('.readjkoscode input[name="price"]').val())),precision);
		}
		else{//無條件捨去
			var temp=floorfun((Number($('.readjkoscode input[name="money"]').val())*Number($('.readjkoscode input[name="price"]').val())),precision);
		}
		content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$('.readjkoscode input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.readjkoscode input[name="type"]').val()+"'><input type='hidden' name='jkos' value='1'><input type='hidden' name='orderid' value='"+$('.readjkoscode input[name="orderid"]').val()+"'><input type='hidden' name='tradeno' value='"+$('.readjkoscode input[name="tradeno"]').val()+"'></span></div></div></div>";
		if(target=='result'){
			$('.result #paywindow #paycontent').append(content);
		}
		else{
			$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
		}
		if(target=='result'){
			closedisbut();

			computerchange();
		}
		else{
			editpaycomchange();
		}
		if($('.readjkoscode input[name="carrier"]').val()!=''){//2022/10/13 手機載具
			if(target=='result'){
				$('.result #viewwindow .sendviewwindow input[name="tempcontainer"]').val($('.readjkoscode input[name="carrier"]').val());
			}
			else{
				//2022/10/13 修改付款，只要會更動到發票的部分，全部不能使用
				//$('.editpay #viewwindow .sendviewwindow input[name="tempcontainer"]').val($('.readjkoscode input[name="carrier"]').val());
			}
		}
		else{
		}
		readjkoscode.dialog('close');
	});
	/*$('.readjkoscode #checksale').click(function(){//2022/10/19 API文件：人員面對顧客交易，一般建議若有異常，直接進入取消交易流程//2022/10/19 查詢付款狀態
		$('.readjkoscode .qrhint').html('檢查交易中<span id="dot">...</span>');
		$('.readjkoscode .hintstring').html('');
		$('.readjkoscode #successsale').css({'display':'block'});
		$('.readjkoscode #checksale').css({'display':'none'});
		//$('.readjkoscode #cancelsale').prop('disabled',true);
		var dotloading=setInterval(function(){
			if($('.readjkoscode .qrhint #dot').length>0){
				if($('.readjkoscode .qrhint #dot').html().length==3){
					$('.readjkoscode .qrhint #dot').html('.');
				}
				else if($('.readjkoscode .qrhint #dot').html().length==2){
					$('.readjkoscode .qrhint #dot').html('...');
				}
				else{
					$('.readjkoscode .qrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		//console.log($('.readjkoscode input[name="orderid"]').length);
		res=jkos_Inquiry($('.order#order .jkos #url').val(),$('.order#order .jkos #systemname').val(),$('.order#order .jkos #merchantkey').val(),$('.order#order .jkos #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),'P',$('.readjkoscode input[name="orderid"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='000'){//2022/4/28 成功交易
				$('.readjkoscode .hintstring').html(res['StatusDesc']);
				$('.readjkoscode #successsale').prop('disabled',false);
				if(typeof res['InvoiceVehicle']!=='undefined'&&res['InvoiceVehicle']!=''&&res['InvoiceVehicle']!=null){//2022/10/13 發票載具(依照文件來看，只有手機載具
					$('.readjkoscode input[name="carrier"]').val(res['InvoiceVehicle']);
				}
				else{
				}
				if(typeof res['TradeNo']!=='undefined'&&res['TradeNo']!=''&&res['TradeNo']!=null){//2022/10/13 街口支付端交易序號，後續退款需要使用
					$('.readjkoscode input[name="tradeno"]').val(res['TradeNo']);
				}
				else{
				}
			}
			else if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='916'){//2022/10/19 查無訂單(可能是尚未完成交易，必須走取消交易)
				$('.readjkoscode #successsale').css({'display':'none'});
				$('.readjkoscode #cancelsale').css({'display':'block'});
				$('.readjkoscode #cancelsale').prop('disabled',false);
				$('.readjkoscode .hintstring').html(res['StatusDesc']);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.readjkoscode #successsale').css({'display':'none'});
				$('.readjkoscode #cancelsale').css({'display':'block'});
				$('.readjkoscode #cancelsale').prop('disabled',false);
				$('.readjkoscode .hintstring').html(res['statusText']);
			}
			else{
				$('.readjkoscode .hintstring').html(res['StatusDesc']);
				$('.readjkoscode #successsale').css({'display':'none'});
				$('.readjkoscode #closejkos').css({'display':'block'});
				$('.readjkoscode #closejkos').prop('disabled',false);
			}
			clearInterval(dotloading);
			$('.readjkoscode .qrhint').html('');
		});
	});*/
	$('.readjkoscode #cancelsale').click(function(){//2022/10/19 取消付款，只有在付款/退款 等待逾時(15秒)>查詢狀態，之後才能查詢狀況；依照使用情況，之後可修改並取代查詢狀態的流程
		//$('.readjkoscode .cancelTitle').html('Cancel');
		$('.readjkoscode .cancelTitle').css({'display':'block'});
		$('.readjkoscode .cancelqrhint').html('取消交易中<span id="dot">...</span>');
		$('.readjkoscode .cancelqrhint').css({'display':'block'});
		$('.readjkoscode .cancelhintstring').html('');
		$('.readjkoscode .cancelhintstring').css({'display':'block'});
		$('.readjkoscode #cancelsale').prop('disabled',true);
		//$('.readjkoscode #closejkos').css({'display':'block'});
		var dotloading=setInterval(function(){
			if($('.readjkoscode .cancelqrhint #dot').length>0){
				if($('.readjkoscode .cancelqrhint #dot').html().length==3){
					$('.readjkoscode .cancelqrhint #dot').html('.');
				}
				else if($('.readjkoscode .cancelqrhint #dot').html().length==2){
					$('.readjkoscode .cancelqrhint #dot').html('...');
				}
				else{
					$('.readjkoscode .cancelqrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		//console.log($('.readjkoscode input[name="orderid"]').length);
		res=jkos_Cancel($('.order#order .jkos #url').val(),$('.order#order .jkos #systemname').val(),$('.order#order .jkos #merchantkey').val(),$('.order#order .jkos #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),$('.readjkoscode input[name="jkoscode"]').val(),$('.readjkoscode input[name="money"]').val(),$('.readjkoscode input[name="orderid"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='000'){//2022/4/28 成功交易
				$('.readjkoscode .cancelhintstring').html(res['StatusDesc']);
				$('.readjkoscode #closejkos').prop('disabled',false);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				//$('.readjkoscode #successsale').css({'display':'none'});
				//$('.readjkoscode #checksale').css({'display':'block'});
				$('.readjkoscode #cancelsale').prop('disabled',false);
				$('.readjkoscode .cancelhintstring').html(res['statusText']);
			}
			else{
				//$('.readjkoscode #successsale').css({'display':'block'});
				//$('.readjkoscode #cancelsale').css({'display':'none'});
				$('.readjkoscode .cancelhintstring').html(res['StatusDesc']);
				$('.readjkoscode #cancelsale').prop('disabled',false);
				$('.readjkoscode #closejkos').prop('disabled',true);
			}
			clearInterval(dotloading);
			$('.readjkoscode .cancelqrhint').html('');
		});
		//readjkoscode.dialog('close');
		//$('.result .jkos').prop('disabled',false);
	});
	$('.readjkoscode #closejkos').click(function(){//2022/10/19 關閉視窗，只有在付款/退款 等待逾時(15秒)>查詢狀態>取消付款/退款，最後才能關閉視窗
		readjkoscode.dialog('close');
		$('.result .jkos').prop('disabled',false);
	});
	$('.voidjkospay #successsale').click(function(){
		voidjkospay.dialog('close');
		//$('.result #viewwindow .sendviewwindow input[name="creditcard"]').val('');
		$('.result #paywindow .paywaybox .payway #name1 input[name="jkos"][value="1"]').parent('#name1').parent('div').parent('.payway').parent('.paywaybox').remove();

		if($('.result #paywindow .paywaybox').length==0){
			opendisbut();
		}
		else{
		}

		computerchange();
	});
	$('.voidjkospay #checksale').click(function(){//2022/10/20 查詢退款狀態
		//voidjkospay.dialog('close');
		//$('.result #viewwindow .sendviewwindow input[name="creditcard"]').val('');
		//$('.result #paywindow .paywaybox .payway #name1 input[name="jkos"][value="1"]').parent('#name1').parent('div').parent('.payway').parent('.paywaybox').remove();
		//computerchange();
		$('.voidjkospay .qrhint').html('檢查交易中<span id="dot">...</span>');
		$('.voidjkospay .hintstring').html('');
		$('.voidjkospay #successsale').css({'display':'block'});
		$('.voidjkospay #checksale').css({'display':'none'});
		$('.voidjkospay #checksale').prop('disabled',true);
		$('.voidjkospay #cancelsale').prop('disabled',true);
		var dotloading=setInterval(function(){
			if($('.voidjkospay .qrhint #dot').length>0){
				if($('.voidjkospay .qrhint #dot').html().length==3){
					$('.voidjkospay .qrhint #dot').html('.');
				}
				else if($('.voidjkospay .qrhint #dot').html().length==2){
					$('.voidjkospay .qrhint #dot').html('...');
				}
				else{
					$('.voidjkospay .qrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		res=jkos_Inquiry($('.order#order .jkos #url').val(),$('.order#order .jkos #systemname').val(),$('.order#order .jkos #merchantkey').val(),$('.order#order .jkos #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),'R',$('.voidjkospay input[name="orderid"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['StatusCode']!=='undefined'&&(res['StatusCode']=='000'||res['StatusCode']=='925')){//2022/5/9 code=925(交易重複退款、已在街口端退款)；因此做為成功交易//成功交易
				$('.voidjkospay .hintstring').html(res['StatusDesc']);
				$('.voidjkospay #successsale').prop('disabled',false);
			}
			//2022/10/20 退款查詢除了查到成功與重複退款，都只能終止流程或重新查詢
			/*else if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='916'){//2022/10/19 查無訂單(可能是尚未完成交易)
				$('.voidjkospay #successsale').css({'display':'none'});
				$('.voidjkospay #checksale').css({'display':'block'});
				$('.voidjkospay #checksale').prop('disabled',false);
				$('.voidjkospay #cancelsale').css({'display':'block'});
				$('.voidjkospay #cancelsale').prop('disabled',false);
				$('.voidjkospay .hintstring').html(res['StatusDesc']);
			}*/
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.voidjkospay #successsale').css({'display':'none'});
				$('.voidjkospay #checksale').css({'display':'block'});
				$('.voidjkospay #checksale').prop('disabled',false);
				$('.voidjkospay #cancelsale').css({'display':'block'});
				$('.voidjkospay #cancelsale').prop('disabled',false);
				$('.voidjkospay .hintstring').html(res['statusText']);
			}
			else{
				$('.voidjkospay .hintstring').html(res['StatusDesc']);
				$('.voidjkospay #successsale').css({'display':'none'});
				$('.voidjkospay #checksale').css({'display':'block'});
				$('.voidjkospay #checksale').prop('disabled',false);
				$('.voidjkospay #cancelsale').css({'display':'block'});
				$('.voidjkospay #cancelsale').prop('disabled',false);
			}
			clearInterval(dotloading);
			$('.voidjkospay .qrhint').html('');
		});
	});
	$('.voidjkospay #cancelsale').click(function(){
		voidjkospay.dialog('close');
		computerchange();
	});
	$('.voidsalewithjkospay #successsale').click(function(){//作廢帳單街口支付付款退款成功
		var type=$('.voidsalewithjkospay input[name="type"]').val();
		voidsalewithjkospay.dialog('close');
		switch(type){
			case 'editlist'://修改帳單
				//console.log('1');
				var voidbizdate=$('.salelist #date').html();
				var voidconsecnumber=$('.salelist #listno input[name="consecnumber"]').val();
				var nowbizdate=$('.salelist #date').html();
				var listtype='';
				var tabnum='';
				var consecnumber='';
				if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																},
																error:function(e){
																	//console.log(e);
																}
															});
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
													},
													error:function(e){
														//if(d.length>40||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														/*}
														else{
														}*/
														//console.log(e);
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(d.substr(0,7)=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'creditcard getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
										//console.log('e1');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
											//console.log('e2');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'void'://作廢帳單
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'creditcard deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							$('.salevoid #listno').html('');
							$('.salevoid #list #listcontent').html('');
							$('.salevoid #date').html('');
							$('.salevoid #credate').html('');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
						verpsw.dialog('close');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'voidbyinv'://依發票作廢帳單
				var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
					dataType:'html',
					success:function(d){
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													async:false,
													data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							verpsw.dialog('close');
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				salevoidbyinv.dialog('close');
				break;
			case 'viewvoid'://2021/9/14 暫結作廢
				var nowbizdate=$('.viewtemp #date').html();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/viewvoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						var tempres=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile=tempres[1];
						}
						else{
						}
						//console.log(d);
						if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
							if(tempres[0]=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	async:false,
																	data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															$('.viewtemp #salelist #salecontent .listitems').prop('id','');
															$('.viewtemp #listno').html('');
															$('.viewtemp #list #listcontent').html('');
															$('.viewtemp #date').html('');
															$('.viewtemp #credate').html('');
															$('.viewtemp #otherfun button#plus').prop('disabled',true);
															$('.viewtemp #otherfun button#openinv').prop('disabled',true);
															$('.viewtemp #viewvoid').prop('disabled',true);
															$('.viewtemp #fun button#forall').prop('disabled',true);
															$('.viewtemp #fun button#list').prop('disabled',true);
															$('.viewtemp #fun button#tag').prop('disabled',true);
															$('.viewtemp #fun button#kitchen').prop('disabled',true);
															$('.viewtemp #fun button#changecheck').prop('disabled',true);
															$('.viewtemp #fun button#editoutman').prop('disabled',true);
															$('.order#order #banner #detail #tw #view').trigger('click');
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
						}
						else{
							$('.viewtemp #salelist #salecontent .listitems').prop('id','');
							$('.viewtemp #listno').html('');
							$('.viewtemp #list #listcontent').html('');
							$('.viewtemp #date').html('');
							$('.viewtemp #credate').html('');
							$('.viewtemp #otherfun button#plus').prop('disabled',true);
							$('.viewtemp #otherfun button#openinv').prop('disabled',true);
							$('.viewtemp #viewvoid').prop('disabled',true);
							$('.viewtemp #fun button#forall').prop('disabled',true);
							$('.viewtemp #fun button#list').prop('disabled',true);
							$('.viewtemp #fun button#tag').prop('disabled',true);
							$('.viewtemp #fun button#kitchen').prop('disabled',true);
							$('.viewtemp #fun button#changecheck').prop('disabled',true);
							$('.viewtemp #fun button#editoutman').prop('disabled',true);
							$('.order#order #banner #detail #tw #view').trigger('click');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});									
				break;
			default:
				break;
		}
	});
	$('.voidsalewithjkospay #checksale').click(function(){//2022/10/20 查詢退款狀態
		//voidsalewithjkospay.dialog('close');
		$('.voidsalewithjkospay .qrhint').html('檢查交易中<span id="dot">...</span>');
		$('.voidsalewithjkospay .hintstring').html('');
		$('.voidsalewithjkospay #successsale').css({'display':'block'});
		$('.voidsalewithjkospay #checksale').css({'display':'none'});
		$('.voidsalewithjkospay #checksale').prop('disabled',true);
		$('.voidsalewithjkospay #cancelsale').prop('disabled',true);
		var dotloading=setInterval(function(){
			if($('.voidsalewithjkospay .qrhint #dot').length>0){
				if($('.voidsalewithjkospay .qrhint #dot').html().length==3){
					$('.voidsalewithjkospay .qrhint #dot').html('.');
				}
				else if($('.voidsalewithjkospay .qrhint #dot').html().length==2){
					$('.voidsalewithjkospay .qrhint #dot').html('...');
				}
				else{
					$('.voidsalewithjkospay .qrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		res=jkos_Inquiry($('.order#order .jkos #url').val(),$('.order#order .jkos #systemname').val(),$('.order#order .jkos #merchantkey').val(),$('.order#order .jkos #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),'R',$('.voidsalewithjkospay input[name="saleno"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['StatusCode']!=='undefined'&&(res['StatusCode']=='000'||res['StatusCode']=='925')){//2022/5/9 code=925(交易重複退款、已在街口端退款)；因此做為成功交易//成功交易
				$('.voidsalewithjkospay .hintstring').html(res['StatusDesc']);
				$('.voidsalewithjkospay #successsale').prop('disabled',false);
			}
			//2022/10/20 退款查詢除了查到成功與重複退款，都只能終止流程或重新查詢
			/*else if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='916'){//2022/10/19 查無訂單(可能是尚未完成交易)
				$('.voidsalewithjkospay #successsale').css({'display':'none'});
				$('.voidsalewithjkospay #checksale').css({'display':'block'});
				$('.voidsalewithjkospay #checksale').prop('disabled',false);
				$('.voidsalewithjkospay #cancelsale').css({'display':'block'});
				$('.voidsalewithjkospay #cancelsale').prop('disabled',false);
				$('.voidsalewithjkospay .hintstring').html(res['StatusDesc']);
			}*/
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.voidsalewithjkospay #successsale').css({'display':'none'});
				$('.voidsalewithjkospay #checksale').css({'display':'block'});
				$('.voidsalewithjkospay #checksale').prop('disabled',false);
				$('.voidsalewithjkospay #cancelsale').css({'display':'block'});
				$('.voidsalewithjkospay #cancelsale').prop('disabled',false);
				$('.voidsalewithjkospay .hintstring').html(res['statusText']);
			}
			else{
				$('.voidsalewithjkospay .hintstring').html(res['StatusDesc']);
				$('.voidsalewithjkospay #successsale').css({'display':'none'});
				$('.voidsalewithjkospay #checksale').css({'display':'block'});
				$('.voidsalewithjkospay #checksale').prop('disabled',false);
				$('.voidsalewithjkospay #cancelsale').css({'display':'block'});
				$('.voidsalewithjkospay #cancelsale').prop('disabled',false);
			}
			clearInterval(dotloading);
			$('.voidsalewithjkospay .qrhint').html('');
		});
	});
	$('.voidsalewithjkospay #cancelsale').click(function(){//作廢帳單街口支付付款退款失敗
		voidsalewithjkospay.dialog('close');
	});
	/*pxpayplus*/
	$('.result .pxpayplus').click(function(){
		//$('.result .pxpayplus').prop('disabled',true);
		if($('.result #paywindow #paycontent .payway span[data-id="apipay"]').length==0){//2022/10/28 加上全支付//2022/10/6 加上街口支付//2022/5/6 未使用api串接的付款方式(英特拉電子支付、聯合信用卡中心刷卡、直接linepay付款)才能使用該付款方式
			readpxpaypluscode.dialog('open');
		}
		else{
		}
	});
	$('.readpxpaypluscode input[name="pxpaypluscode"]').keydown(function(event){
		//console.log($('.readpxpaypluscode input[name="pxpaypluscode"]').val());
		if(event.which==13){
			$('.readpxpaypluscode input[name="pxpaypluscode"]').attr('type','hidden');
			if($('.result input[name="view"]').val()==''||$('.result input[name="view"]').val()=='0'){
				var money=$('.result #viewwindow #notyet').html();
			}
			else if(Number($('.result input[name="view"]').val())>Number($('.result #viewwindow #notyet').html())){
				var money=$('.result #viewwindow #notyet').html();
			}
			else{
				var money=$('.result input[name="view"]').val();
			}
			$('.readpxpaypluscode input[name="money"]').val(money);
			var datetime=new Date();
			var orderid=$('.order#order .companydata #story').val()+datetime.getFullYear()+('0'+(datetime.getMonth()+1)).substr(-2)+('0'+datetime.getDate()).substr(-2)+('0'+datetime.getHours()).substr(-2)+('0'+datetime.getMinutes()).substr(-2)+('0'+datetime.getSeconds()).substr(-2);
			$('.readpxpaypluscode input[name="orderid"]').val(orderid);
			if(money>0&&typeof pxpayplus_Payment!=="undefined"&&typeof pxpayplus_Payment==="function"){
				$('.readpxpaypluscode .payTitle').html('Payment');
				$('.readpxpaypluscode .payqrhint').html('交易中<span id="dot">...</span>');
				$('.readpxpaypluscode #closepxpayplus').prop('disabled',true);
				var dotloading=setInterval(function(){
					if($('.readpxpaypluscode .payqrhint #dot').length>0){
						if($('.readpxpaypluscode .payqrhint #dot').html().length==3){
							$('.readpxpaypluscode .payqrhint #dot').html('.');
						}
						else if($('.readpxpaypluscode .payqrhint #dot').html().length==2){
							$('.readpxpaypluscode .payqrhint #dot').html('...');
						}
						else{
							$('.readpxpaypluscode .payqrhint #dot').html('..');
						}
					}
					else{
					}
				},500);
				var res='';
				res=pxpayplus_Payment($('.order#order .pxpayplus #url').val(),$('.order#order .pxpayplus #merchantcode').val(),$('.order#order .pxpayplus #secrectkey').val(),$('.readpxpaypluscode input[name="pxpaypluscode"]').val(),$('.order#order .companydata #story').val(),$('.order#order .pxpayplus #pxstorecode').val(),$('.order#order .companydata #storyname').val(),orderid,money,$('.order#order .pxpayplus #item_json').val());
				res.done(function(res){
					//console.log(res['status_code']);
					if(typeof res['status_code']!=='undefined'&&res['status_code']=='0000'){//2022/10/28 成功交易
						$('.readpxpaypluscode .payhintstring').html(res['status_message']);
						$('.readpxpaypluscode #successsale').prop('disabled',false);
						if(typeof res['invo_carrier']!=='undefined'&&res['invo_carrier']!=''&&res['invo_carrier']!=null){//2022/10/28 發票載具(依照文件來看，只有手機載具
							$('.readpxpaypluscode input[name="carrier"]').val(res['invo_carrier']);
						}
						else{
						}
						if(typeof res['px_trade_no']!=='undefined'&&res['px_trade_no']!=''&&res['px_trade_no']!=null){//2022/10/28 全支付端交易序號，後續退款需要使用
							$('.readpxpaypluscode input[name="tradeno"]').val(res['px_trade_no']);
						}
						else{
						}
					}
					else if(typeof res['statusText']!=='undefined'){//等待逾時
						$('.readpxpaypluscode #successsale').css({'display':'none'});
						//2022/10/28 參照jkos流程，付款逾時，不查詢帳單，直接送付款沖銷
						//$('.readpxpaypluscode #checksale').prop('disabled',false);
						//$('.readpxpaypluscode #checksale').css({'display':'block'});
						//$('.readpxpaypluscode #closepxpayplus').prop('disabled',true);
						//$('.readpxpaypluscode .hintstring').html(res['statusText']);
						//$('.readpxpaypluscode #checksale').trigger('click');

						$('.readpxpaypluscode #cancelsale').prop('disabled',false);
						$('.readpxpaypluscode #cancelsale').css({'display':'block'});
						$('.readpxpaypluscode #closepxpayplus').prop('disabled',true);
						$('.readpxpaypluscode .payhintstring').html(res['statusText']);
						$('.readpxpaypluscode #cancelsale').trigger('click');
					}
					else{
						$('.readpxpaypluscode .payhintstring').html(res['status_message']);
						$('.readpxpaypluscode #closepxpayplus').prop('disabled',false);
					}
					clearInterval(dotloading);
					$('.readpxpaypluscode .payqrhint').html('');
				});
			}
			else if(money<=0){//提醒付款金額不大於0
				if($('.sysmeg #name1.syshint11').length>0){
					$('.sysmeg #name1.syshint11').css({'display':''});
				}
				else{
				}
				if($('.sysmeg #name2.syshint11').length>0){
					$('.sysmeg #name2.syshint11').css({'display':''});
				}
				else{
				}
				sysmeg.dialog('open');
			}
			else{
			}
		}
		else{
		}
	});
	$('.readpxpaypluscode #successsale').click(function(){
		if(typeof $('.paywindow input[name="target"]')=="undefined"||$('.paywindow input[name="target"]').val()==''||$('.paywindow input[name="target"]').val()=='result'){
			target='result';
		}
		else{
			target='editpay';
		}
		var precision=parseInt($('.order#order .initsetting #accuracy').val());//可由設定檔設定精準度(e.g.精準度小數點第二位 填2)
		var content="<div class='paywaybox' style='width:calc(100% - 20px);overflow:hidden;'><div style='width:20px;height:19px;float:left;'><input type='checkbox' name='checkbox'></div><div class='payway' style='overflow:hidden;'><div style='width:calc(50% - 10px);float:left;text-align:left;'><span id='name1'>"+$('.readpxpaypluscode #buttonhtml').html()+"</span></div><div style='width:calc(50% - 10px);float:left;text-align:right;'><span class='otherpay' data-id='apipay' id='"+$('.readpxpaypluscode input[name="saverowname"]').val()+"'>"+$('.readpxpaypluscode input[name="money"]').val()+"<input type='hidden' name='initview' value='"+$('.readpxpaypluscode input[name="money"]').val()+"'>";
		if($('.order#order .initsetting #accuracytype').val()=='1'){//四捨五入
			var temp=roundfun((Number($('.readpxpaypluscode input[name="money"]').val())*Number($('.readpxpaypluscode input[name="price"]').val())),precision);
		}
		else if($('.order#order .initsetting #accuracytype').val()=='2'){//無條件進位
			var temp=ceilfun((Number($('.readpxpaypluscode input[name="money"]').val())*Number($('.readpxpaypluscode input[name="price"]').val())),precision);
		}
		else{//無條件捨去
			var temp=floorfun((Number($('.readpxpaypluscode input[name="money"]').val())*Number($('.readpxpaypluscode input[name="price"]').val())),precision);
		}
		content=content+"<input type='hidden' name='viewmoney' value='"+temp+"'><input type='hidden' name='inv' value='"+$('.readpxpaypluscode input[name="inv"]').val()+"'><input type='hidden' name='type' value='"+$('.readpxpaypluscode input[name="type"]').val()+"'><input type='hidden' name='pxpayplus' value='1'><input type='hidden' name='orderid' value='"+$('.readpxpaypluscode input[name="orderid"]').val()+"'><input type='hidden' name='tradeno' value='"+$('.readpxpaypluscode input[name="tradeno"]').val()+"'></span></div></div></div>";
		if(target=='result'){
			$('.result #paywindow #paycontent').append(content);
		}
		else{
			$('.editpay #viewwindow #editpaywindow #paycontent').append(content);
		}
		if(target=='result'){
			closedisbut();

			computerchange();
		}
		else{
			editpaycomchange();
		}
		if($('.readpxpaypluscode input[name="carrier"]').val()!=''){//2022/10/13 手機載具
			if(target=='result'){
				$('.result #viewwindow .sendviewwindow input[name="tempcontainer"]').val($('.readpxpaypluscode input[name="carrier"]').val());
			}
			else{
				//2022/10/13 修改付款，只要會更動到發票的部分，全部不能使用
				//$('.editpay #viewwindow .sendviewwindow input[name="tempcontainer"]').val($('.readpxpaypluscode input[name="carrier"]').val());
			}
		}
		else{
		}
		readpxpaypluscode.dialog('close');
	});
	/*$('.readpxpaypluscode #checksale').click(function(){//2022/10/28 參照jkos流程，付款逾時，不查詢帳單，直接送付款沖銷(這區塊內容尚未修改成全支付版本，保持街口版本)//2022/10/19 查詢付款狀態
		$('.readpxpaypluscode .qrhint').html('檢查交易中<span id="dot">...</span>');
		$('.readpxpaypluscode .hintstring').html('');
		$('.readpxpaypluscode #successsale').css({'display':'block'});
		$('.readpxpaypluscode #checksale').css({'display':'none'});
		//$('.readpxpaypluscode #cancelsale').prop('disabled',true);
		var dotloading=setInterval(function(){
			if($('.readpxpaypluscode .qrhint #dot').length>0){
				if($('.readpxpaypluscode .qrhint #dot').html().length==3){
					$('.readpxpaypluscode .qrhint #dot').html('.');
				}
				else if($('.readpxpaypluscode .qrhint #dot').html().length==2){
					$('.readpxpaypluscode .qrhint #dot').html('...');
				}
				else{
					$('.readpxpaypluscode .qrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		//console.log($('.readpxpaypluscode input[name="orderid"]').length);
		res=pxpayplus_Inquiry($('.order#order .pxpayplus #url').val(),$('.order#order .pxpayplus #systemname').val(),$('.order#order .pxpayplus #merchantkey').val(),$('.order#order .pxpayplus #merchantid').val(),$('.order#order .companydata #story').val(),$('.order#order .companydata #storyname').val(),'P',$('.readpxpaypluscode input[name="orderid"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='000'){//2022/4/28 成功交易
				$('.readpxpaypluscode .hintstring').html(res['StatusDesc']);
				$('.readpxpaypluscode #successsale').prop('disabled',false);
				if(typeof res['InvoiceVehicle']!=='undefined'&&res['InvoiceVehicle']!=''&&res['InvoiceVehicle']!=null){//2022/10/13 發票載具(依照文件來看，只有手機載具
					$('.readpxpaypluscode input[name="carrier"]').val(res['InvoiceVehicle']);
				}
				else{
				}
				if(typeof res['TradeNo']!=='undefined'&&res['TradeNo']!=''&&res['TradeNo']!=null){//2022/10/13 街口支付端交易序號，後續退款需要使用
					$('.readpxpaypluscode input[name="tradeno"]').val(res['TradeNo']);
				}
				else{
				}
			}
			else if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='916'){//2022/10/19 查無訂單(可能是尚未完成交易，必須走取消交易)
				$('.readpxpaypluscode #successsale').css({'display':'none'});
				$('.readpxpaypluscode #cancelsale').css({'display':'block'});
				$('.readpxpaypluscode #cancelsale').prop('disabled',false);
				$('.readpxpaypluscode .hintstring').html(res['StatusDesc']);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.readpxpaypluscode #successsale').css({'display':'none'});
				$('.readpxpaypluscode #cancelsale').css({'display':'block'});
				$('.readpxpaypluscode #cancelsale').prop('disabled',false);
				$('.readpxpaypluscode .hintstring').html(res['statusText']);
			}
			else{
				$('.readpxpaypluscode .hintstring').html(res['StatusDesc']);
				$('.readpxpaypluscode #successsale').css({'display':'none'});
				$('.readpxpaypluscode #closepxpayplus').css({'display':'block'});
				$('.readpxpaypluscode #closepxpayplus').prop('disabled',false);
			}
			clearInterval(dotloading);
			$('.readpxpaypluscode .qrhint').html('');
		});
	});*/
	$('.readpxpaypluscode #cancelsale').click(function(){//2022/10/19 取消付款，只有在付款/退款 等待逾時(15秒)>查詢狀態，之後才能查詢狀況；依照使用情況，之後可修改並取代查詢狀態的流程
		//$('.readpxpaypluscode .cancelTitle').html('Cancel');
		$('.readpxpaypluscode .cancelTitle').css({'display':'block'});
		$('.readpxpaypluscode .cancelqrhint').html('取消交易中<span id="dot">...</span>');
		$('.readpxpaypluscode .cancelqrhint').css({'display':'block'});
		$('.readpxpaypluscode .cancelhintstring').html('');
		$('.readpxpaypluscode .cancelhintstring').css({'display':'block'});
		$('.readpxpaypluscode #cancelsale').prop('disabled',true);
		//$('.readpxpaypluscode #closepxpayplus').css({'display':'block'});
		var dotloading=setInterval(function(){
			if($('.readpxpaypluscode .cancelqrhint #dot').length>0){
				if($('.readpxpaypluscode .cancelqrhint #dot').html().length==3){
					$('.readpxpaypluscode .cancelqrhint #dot').html('.');
				}
				else if($('.readpxpaypluscode .cancelqrhint #dot').html().length==2){
					$('.readpxpaypluscode .cancelqrhint #dot').html('...');
				}
				else{
					$('.readpxpaypluscode .cancelqrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		//console.log($('.readpxpaypluscode input[name="orderid"]').length);
		res=pxpayplus_Reversal($('.order#order .pxpayplus #url').val(),$('.order#order .pxpayplus #merchantcode').val(),$('.order#order .pxpayplus #secrectkey').val(),$('.readpxpaypluscode input[name="pxpaypluscode"]').val(),$('.order#order .companydata #story').val(),$('.order#order .pxpayplus #pxstorecode').val(),$('.order#order .companydata #storyname').val(),$('.readpxpaypluscode input[name="orderid"]').val(),$('.readpxpaypluscode input[name="money"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['status_code']!=='undefined'&&res['status_code']=='0000'){//2022/10/28 成功交易
				$('.readpxpaypluscode .cancelhintstring').html(res['status_message']);
				$('.readpxpaypluscode #closepxpayplus').prop('disabled',false);
			}
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				//$('.readpxpaypluscode #successsale').css({'display':'none'});
				//$('.readpxpaypluscode #checksale').css({'display':'block'});
				$('.readpxpaypluscode #cancelsale').prop('disabled',false);
				$('.readpxpaypluscode .cancelhintstring').html(res['statusText']);
			}
			else{
				//$('.readpxpaypluscode #successsale').css({'display':'block'});
				//$('.readpxpaypluscode #cancelsale').css({'display':'none'});
				$('.readpxpaypluscode .cancelhintstring').html(res['status_message']);
				$('.readpxpaypluscode #cancelsale').prop('disabled',false);
				$('.readpxpaypluscode #closepxpayplus').prop('disabled',true);
			}
			clearInterval(dotloading);
			$('.readpxpaypluscode .cancelqrhint').html('');
		});
		//readpxpaypluscode.dialog('close');
		//$('.result .pxpayplus').prop('disabled',false);
	});
	$('.readpxpaypluscode #closepxpayplus').click(function(){//2022/10/19 關閉視窗，只有在付款/退款 等待逾時(15秒)>查詢狀態>取消付款/退款，最後才能關閉視窗
		readpxpaypluscode.dialog('close');
		$('.result .pxpayplus').prop('disabled',false);
	});
	$('.voidpxpaypluspay #successsale').click(function(){
		voidpxpaypluspay.dialog('close');
		//$('.result #viewwindow .sendviewwindow input[name="creditcard"]').val('');
		$('.result #paywindow .paywaybox .payway #name1 input[name="pxpayplus"][value="1"]').parent('#name1').parent('div').parent('.payway').parent('.paywaybox').remove();

		if($('.result #paywindow .paywaybox').length==0){
			opendisbut();
		}
		else{
		}

		computerchange();
	});
	$('.voidpxpaypluspay #checksale').click(function(){//2022/10/20 查詢退款狀態
		//voidpxpaypluspay.dialog('close');
		//$('.result #viewwindow .sendviewwindow input[name="creditcard"]').val('');
		//$('.result #paywindow .paywaybox .payway #name1 input[name="pxpayplus"][value="1"]').parent('#name1').parent('div').parent('.payway').parent('.paywaybox').remove();
		//computerchange();
		$('.voidpxpaypluspay .qrhint').html('檢查交易中<span id="dot">...</span>');
		$('.voidpxpaypluspay .hintstring').html('');
		$('.voidpxpaypluspay #successsale').css({'display':'block'});
		$('.voidpxpaypluspay #checksale').css({'display':'none'});
		$('.voidpxpaypluspay #checksale').prop('disabled',true);
		$('.voidpxpaypluspay #cancelsale').prop('disabled',true);
		var dotloading=setInterval(function(){
			if($('.voidpxpaypluspay .qrhint #dot').length>0){
				if($('.voidpxpaypluspay .qrhint #dot').html().length==3){
					$('.voidpxpaypluspay .qrhint #dot').html('.');
				}
				else if($('.voidpxpaypluspay .qrhint #dot').html().length==2){
					$('.voidpxpaypluspay .qrhint #dot').html('...');
				}
				else{
					$('.voidpxpaypluspay .qrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		res=pxpayplus_OrderStatus($('.order#order .pxpayplus #url').val(),$('.order#order .pxpayplus #merchantcode').val(),$('.order#order .pxpayplus #secrectkey').val(),$('.order#order .companydata #storyname').val(),'1',$('.voidpxpaypluspay input[name="orderid"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['status_code']!=='undefined'&&res['status_code']=='0000'){
				$('.voidpxpaypluspay .hintstring').html(res['status_message']);
				$('.voidpxpaypluspay #successsale').prop('disabled',false);
			}
			//2022/10/20 退款查詢除了查到成功與重複退款，都只能終止流程或重新查詢
			/*else if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='916'){//2022/10/19 查無訂單(可能是尚未完成交易)
				$('.voidpxpaypluspay #successsale').css({'display':'none'});
				$('.voidpxpaypluspay #checksale').css({'display':'block'});
				$('.voidpxpaypluspay #checksale').prop('disabled',false);
				$('.voidpxpaypluspay #cancelsale').css({'display':'block'});
				$('.voidpxpaypluspay #cancelsale').prop('disabled',false);
				$('.voidpxpaypluspay .hintstring').html(res['StatusDesc']);
			}*/
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.voidpxpaypluspay #successsale').css({'display':'none'});
				$('.voidpxpaypluspay #checksale').css({'display':'block'});
				$('.voidpxpaypluspay #checksale').prop('disabled',false);
				$('.voidpxpaypluspay #cancelsale').css({'display':'block'});
				$('.voidpxpaypluspay #cancelsale').prop('disabled',false);
				$('.voidpxpaypluspay .hintstring').html(res['statusText']);
			}
			else{
				$('.voidpxpaypluspay .hintstring').html(res['status_message']);
				$('.voidpxpaypluspay #successsale').css({'display':'none'});
				$('.voidpxpaypluspay #checksale').css({'display':'block'});
				$('.voidpxpaypluspay #checksale').prop('disabled',false);
				$('.voidpxpaypluspay #cancelsale').css({'display':'block'});
				$('.voidpxpaypluspay #cancelsale').prop('disabled',false);
			}
			clearInterval(dotloading);
			$('.voidpxpaypluspay .qrhint').html('');
		});
	});
	$('.voidpxpaypluspay #cancelsale').click(function(){
		voidpxpaypluspay.dialog('close');
		computerchange();
	});
	$('.voidsalewithpxpaypluspay #successsale').click(function(){//作廢帳單全支付付款退款成功
		var type=$('.voidsalewithpxpaypluspay input[name="type"]').val();
		voidsalewithpxpaypluspay.dialog('close');
		switch(type){
			case 'editlist'://修改帳單
				//console.log('1');
				var voidbizdate=$('.salelist #date').html();
				var voidconsecnumber=$('.salelist #listno input[name="consecnumber"]').val();
				var nowbizdate=$('.salelist #date').html();
				var listtype='';
				var tabnum='';
				var consecnumber='';
				if($.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否開立發票
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){
																	//console.log(d);
																},
																error:function(e){
																	//console.log(e);
																}
															});
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){
																//console.log(d);
															},
															error:function(e){
																//console.log(e);
															}
														});
													},
													error:function(e){
														//if(d.length>40||d.match('ERROR HINT: ')){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														/*}
														else{
														}*/
														//console.log(e);
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							if(d.substr(0,7)=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'creditcard getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #salelist #salecontent .listitems#focus div:eq(0)').html(),'invno':$.trim($('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														data:{'machinename':$('.salelist #listno input[name="machinename"]').val(),'bizdate':$('.salelist #date').html(),'number':$('.salelist #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
										//console.log('e1');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
					if($('.nidin #usenidin').length>0){
						nidin_void($('.salelist #date').html(),$('.salelist #listno input[name="consecnumber"]').val());
					}
					else{
					}
					$.ajax({//作廢帳單
						url:'./lib/js/salevoid.ajax.php',
						method:'post',
						data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salelist #listno input[name="memno"]').val(),'remarks':'editsale'},
						dataType:'html',
						success:function(d){
							if(d.length>20||d.match('ERROR HINT: ')){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									data:{'html':'creditcard salevoid.ajax.php '+d},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
							}
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salelist #date').html(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{//本地會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$.ajax({//利用暫結加點功能將產品撈出(資料從正式表格複製一份至暫存表格)
								url:'./lib/js/copysale.ajax.php',
								method:'post',
								data:{'bizdate':$('.salelist #date').html(),'createdatetime':$('.salelist #credate').val(),'consecnumber':$('.salelist #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
								dataType:'html',
								success:function(d){
									if(d.length>30||d.match('ERROR HINT: ')){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'creditcard copysale.ajax.php '+d},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
									}
									var t=d.split('-');
									//console.log(t);
									listtype=t[t.length-3];
									bizdate=t[t.length-2];
									consecnumber=t[t.length-1];
									//console.log(d);

									temporder(bizdate,consecnumber,$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),$('.order#order .companydata #company').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val());
									//location.href='./order.php?usercode='+$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val()+'&username='+$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()+'&listtype='+listtype+'&tabnum&bizdate='+bizdate+'&consecnumber='+consecnumber;
									verpsw.dialog('close');
									$('.salelist #editpay').prop('disabled',true);
									$('.salelist #reorder').prop('disabled',true);
									$('.salelist #reinv').prop('disabled',true);
									$('.salelist #rekvm').prop('disabled',true);
									$('.salelist #salelist #salecontent .listitems').prop('id','');
									$('.salelist #listno').html('');
									$('.salelist #list #listcontent').html('');
									$('.salelist #date').html('');
									$('.salelist #credate').html('');
									$('.salelist #fun button#forall').prop('disabled',true);
									$('.salelist #fun button#list').prop('disabled',true);
									$('.salelist #fun button#tag').prop('disabled',true);
									$('.salelist #fun button#kitchen').prop('disabled',true);
									$('.salelist #fun button#changecheck').prop('disabled',true);
									salelist.dialog('close');
									if($('.funbox').length>0&&funbox.dialog('isOpen')){
										funbox.dialog('close');
										inittable.dialog('close');
									}
									else{
											//console.log('e2');
									}
									if(!$('.order#order #billfun #billfun1button').prop('disabled')){
										$('.order#order #billfun #billfun1button').trigger('click');
									}
									else{
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'void'://作廢帳單
				var nowbizdate=$('.salevoid #date').html();
				var voidbizdate=$('.salevoid #date').html();
				var voidconsecnumber=$('.salevoid #listno input[name="consecnumber"]').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoid #date').html(),$('.salevoid #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'createdatetime':$('.salevoid #credate').val(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoid #listno input[name="memno"]').val()},
					dataType:'html',
					success:function(d){
						//console.log(d);
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'creditcard salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoid #date').html(),'consecnumber':$('.salevoid #listno input[name="consecnumber"]').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'invno':$.trim($('.salevoid #list input[name="invnumber"]').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													data:{'machinename':$('.salevoid #listno input[name="machinename"]').val(),'bizdate':$('.salevoid #date').html(),'number':$('.salevoid #list input[name="invnumber"]').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'creditcard deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							$('.salevoid #listno').html('');
							$('.salevoid #list #listcontent').html('');
							$('.salevoid #date').html('');
							$('.salevoid #credate').html('');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
						verpsw.dialog('close');
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				break;
			case 'voidbyinv'://依發票作廢帳單
				var nowbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidbizdate=$('.salevoidbyinv #checkcontent #bizdate').val();
				var voidconsecnumber=$('.salevoidbyinv #checkcontent #consecnumber').val();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_void($('.salevoidbyinv #checkcontent #bizdate').val(),$('.salevoidbyinv #checkcontent #consecnumber').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/salevoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'createdatetime':$('.salevoidbyinv #checkcontent #credate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'memno':$('.salevoidbyinv #checkcontent #memno').val()},
					dataType:'html',
					success:function(d){
						var temp=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								data:{'html':'salevoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if(temp[0]=='success'){
							if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
								var memtype='online';
							}
							else{
								var memtype='offline';
							}
							var memberapi='';
							$.ajax({
								url:'./lib/js/searchmember.pointmoney.ajax.php',
								method:'post',
								async:false,
								data:{'type':memtype,'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'machine':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'consecnumber':$('.salevoidbyinv #checkcontent #consecnumber').val()},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d[0].length==0){
									}
									else{
										if(typeof api_point_money_ourmember!=="undefined"&&typeof api_point_money_ourmember==="function"){//網路會員
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney'],0,0,d[0]['state'],d[0]['re1'],d[0]['re1point'],d[0]['re2'],d[0]['re2point']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'http://api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/change.memberdata.php(online error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'http://api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'type':'online','company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insertmemlist.ajax.php(online error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
										else{
											if(d[0]['memno']!=''){//2020/5/25 該筆帳單為會員銷售
												$.ajax({
													url:'../memberapi/point_money.ajax.php',
													method:'post',
													async:false,
													data:{'company':d[0]['company'],'story':d[0]['story'],'memno':d[0]['memno'],'paymoney':d[0]['paymoney'],'giftpoint':d[0]['giftpoint'],'memberpoint':d[0]['memberpoint'],'membermoney':d[0]['membermoney']},
													dataType:'json',
													timeout:5000,
													success:function(d){
														memberapi=d;
														//console.log(res);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e,t){
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/point_money.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
														if(t==="timeout"){
															memberapi=[{"state":"fail","message":"AJAX timeout"}];
														}
														else{
															memberapi=e;
														}
													}
												});
												//memberapi=api_point_money_ourmember(d[0]['company'],d[0]['story'],d[0]['memno'],d[0]['paymoney'],d[0]['giftpoint'],d[0]['memberpoint'],d[0]['membermoney']);
												if(memberapi[0]['state']=='success'){
													$.ajax({
														url:'../memberapi/change.memberdata.php',
														method:'post',
														async:false,
														data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'data':memberapi},
														dataType:'html',
														success:function(d){
															//console.log(d);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline success) '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														},
														error:function(e){
															//console.log(e);
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'../memberapi/change.memberdata.php(offline error) '+e},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
													});
												}
												else{
												}
												$.ajax({
													url:'../memberapi/insertmemlist.ajax.php',
													method:'post',
													async:false,
													data:{'company':$('.order#order .companydata #company').val(),'story':$('.order#order .companydata #story').val(),'settime':$('.order#order .companydata #settime').val(),'data':memberapi,'senddata':d},
													dataType:'html',
													success:function(d){
														//console.log(d);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline success) '+d},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													},
													error:function(e){
														//console.log(e);
														$.ajax({
															url:'./lib/js/print.php',
															method:'post',
															data:{'html':'../memberapi/insertmemlist.ajax.php(offline error) '+e},
															dataType:'html',
															success:function(d){/*console.log(d);*/},
															error:function(e){/*console.log(e);*/}
														});
													}
												});
											}
											else{
											}
										}
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							//console.log($('.salevoid #list #listcontent input[name="invnumber"]').val());
							$.ajax({
								url:'./lib/js/getinvname.ajax.php',
								method:'post',
								async:false,
								data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
								dataType:'json',
								success:function(d){
									//console.log(d);
									if(d=='dbempty'){
										$.ajax({
											url:'./lib/js/print.php',
											method:'post',
											data:{'html':'reinv getinvname.ajax.php dbempty'},
											dataType:'html',
											success:function(d){/*console.log(d);*/},
											error:function(e){/*console.log(e);*/}
										});
									}
									else{
										$.ajax({
											url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
											method:'post',
											async:false,
											data:{'invfile':d[1]},
											dataType:'html',
											success:function(d){
												//console.log(d);
												if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
													$.ajax({
														url:'./lib/js/reinv.ajax.php',
														method:'post',
														async:false,
														data:{'fileexists':d,'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'invno':$.trim($('.salevoidbyinv #checkcontent #invoicenumber').val())},
														dataType:'html',
														success:function(d){
															//console.log(d);
															if(d.length>20||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	data:{'html':'creditcard reinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
														},
														error:function(e){
															//console.log(e);
														}
													});
												}
												else{
												}
												$.ajax({
													url:'./lib/js/deleteinv.ajax.php',
													method:'post',
													async:false,
													data:{'machinename':$('.salevoidbyinv #checkcontent #machinename').val(),'bizdate':$('.salevoidbyinv #checkcontent #bizdate').val(),'number':$('.salevoidbyinv #checkcontent #invoicenumber').val()},
													dataType:'html',
													success:function(d){
														if(d.length>40||d.match('ERROR HINT: ')){
															$.ajax({
																url:'./lib/js/print.php',
																method:'post',
																data:{'html':'deleteinv.ajax.php '+d},
																dataType:'html',
																success:function(d){/*console.log(d);*/},
																error:function(e){/*console.log(e);*/}
															});
														}
														else{
														}
														//console.log(d);
														//2017/12/4var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
														//2017/12/4mywin.document.title='cashdrawer';
													},
													error:function(e){
														//console.log(e);
													}
												});
											},
											error:function(e){
												//console.log(e);
											}
										});
									}
								},
								error:function(e){
									//console.log(e);
								}
							});
							verpsw.dialog('close');
							$('.order#order #billfun #billfun2 #salevoid').trigger('click');
							if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
								var posdvrfile=temp[1];
							}
							else{
							}
						}
						else{
							//console.log(d);
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				/*集點樹收點流程*/
				if($('.order#order .initsetting #pointtree').length>0&&$('.order#order .initsetting #pointtree').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'start point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
					if(typeof api_void_pointtree!=="undefined"&&typeof api_void_pointtree==="function"){
						var voidres=api_void_pointtree(voidbizdate,voidconsecnumber);
						if(voidres==''){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'point-tree-void voidpoint 意外錯誤','file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else if(typeof voidres['data']!=="undefined"){//success
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'pass point-tree-void transfer -PHP_EOL-pos_token_tx_id:'+voidres['data']['pos_token_tx_id']+'-PHP_EOL-store_balance:'+voidres['data']['store_balance']+'-PHP_EOL-user_balance:'+voidres['data']['user_balance'],'file':'point-tree'},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
							var message=JSON.parse(voidres['responseText']);
							if(voidres['status']==='timeout'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer timeout','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else if(voidres['status']=='400'||voidres['status']=='406'){
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer error -PHP_EOL-status:'+voidres['status']+'-PHP_EOL-code:'+message['errors'][0]['code']+'-PHP_EOL-message:'+message['errors'][0]['message'],'file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
							else{
								$.ajax({
									url:'./lib/js/print.php',
									method:'post',
									async:false,
									data:{'html':'point-tree-void transfer 意外錯誤','file':'point-tree'},
									dataType:'html',
									success:function(d){/*console.log(d);*/},
									error:function(e){/*console.log(e);*/}
								});
							}
						}
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'api void pointtree is not function','file':'point-tree'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'end point-tree-void transfer','file':'point-tree'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				salevoidbyinv.dialog('close');
				break;
			case 'viewvoid'://2021/9/14 暫結作廢
				var nowbizdate=$('.viewtemp #date').html();
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					var posdvrfile='';
				}
				else{
				}
				if($('.nidin #usenidin').length>0){
					nidin_cancel($('.viewtemp #date').html(),$('.viewtemp #listno input[name="consecnumber"]').val());
				}
				else{
				}
				$.ajax({
					url:'./lib/js/viewvoid.ajax.php',
					method:'post',
					async:false,
					data:{'terminalnumber':$('.order#order .companydata #terminalnumber').val(),'bizdate':$('.viewtemp #date').html(),'consecnumber':$('.viewtemp #listno input[name="consecnumber"]').val(),'code':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'name':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val()},
					dataType:'html',
					success:function(d){
						var tempres=d.split('-');
						if(d.length>20||d.match('ERROR HINT: ')){
							$.ajax({
								url:'./lib/js/print.php',
								method:'post',
								async:false,
								data:{'html':'viewtemp-viewvoid viewvoid.ajax.php '+d},
								dataType:'html',
								success:function(d){/*console.log(d);*/},
								error:function(e){/*console.log(e);*/}
							});
						}
						else{
						}
						if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
							var posdvrfile=tempres[1];
						}
						else{
						}
						//console.log(d);
						if($.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()).length!=0){//檢查是否已開立發票
							if(tempres[0]=='success'){
								$.ajax({
									url:'./lib/js/getinvname.ajax.php',
									method:'post',
									async:false,
									data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
									dataType:'json',
									success:function(d){
										//console.log(d);
										if(d=='dbempty'){
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'reinv getinvname.ajax.php dbempty'},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
										else{
											$.ajax({
												url:'http://'+d[0]+'/demopos/lib/js/checkinvfile.ajax.php',
												method:'post',
												async:false,
												data:{'invfile':d[1]},
												dataType:'html',
												success:function(d){
													//console.log(d);
													if(d=='notexists'&&$('.order#order .initsetting #useinv').val()=='1'){//2020/9/14 不存在重送C0401 //2020/10/12/週一 使用電子發票
														$.ajax({
															url:'./lib/js/reinv.ajax.php',
															method:'post',
															async:false,
															data:{'fileexists':d,'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'invno':$.trim($('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html())},
															dataType:'html',
															success:function(d){
																//console.log(d);
																if(d.length>20||d.match('ERROR HINT: ')){
																	$.ajax({
																		url:'./lib/js/print.php',
																		method:'post',
																		data:{'html':'creditcard reinv.ajax.php '+d},
																		dataType:'html',
																		success:function(d){/*console.log(d);*/},
																		error:function(e){/*console.log(e);*/}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
													$.ajax({//作廢發票
														url:'./lib/js/deleteinv.ajax.php',
														method:'post',
														async:false,
														data:{'machinename':$('.viewtemp #listno input[name="machinename"]').val(),'bizdate':$('.viewtemp #date').html(),'number':$('.viewtemp #salelist #salecontent .listitems#focus div:eq(3)').html()},
														dataType:'html',
														success:function(d){
															if(d.length>40||d.match('ERROR HINT: ')){
																$.ajax({
																	url:'./lib/js/print.php',
																	method:'post',
																	async:false,
																	data:{'html':'viewtemp-viewvoid deleteinv.ajax.php '+d},
																	dataType:'html',
																	success:function(d){/*console.log(d);*/},
																	error:function(e){/*console.log(e);*/}
																});
															}
															else{
															}
															//console.log(d);
															$('.viewtemp #salelist #salecontent .listitems').prop('id','');
															$('.viewtemp #listno').html('');
															$('.viewtemp #list #listcontent').html('');
															$('.viewtemp #date').html('');
															$('.viewtemp #credate').html('');
															$('.viewtemp #otherfun button#plus').prop('disabled',true);
															$('.viewtemp #otherfun button#openinv').prop('disabled',true);
															$('.viewtemp #viewvoid').prop('disabled',true);
															$('.viewtemp #fun button#forall').prop('disabled',true);
															$('.viewtemp #fun button#list').prop('disabled',true);
															$('.viewtemp #fun button#tag').prop('disabled',true);
															$('.viewtemp #fun button#kitchen').prop('disabled',true);
															$('.viewtemp #fun button#changecheck').prop('disabled',true);
															$('.viewtemp #fun button#editoutman').prop('disabled',true);
															$('.order#order #banner #detail #tw #view').trigger('click');
															//2017/12/29var mywin=window.open('cashdrawer://reprint','','width=1px,height=1px');
															//2017/12/29mywin.document.title='cashdrawer';
														},
														error:function(e){
															//console.log(e);
														}
													});
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else{
								//console.log(d);
							}
						}
						else{
							$('.viewtemp #salelist #salecontent .listitems').prop('id','');
							$('.viewtemp #listno').html('');
							$('.viewtemp #list #listcontent').html('');
							$('.viewtemp #date').html('');
							$('.viewtemp #credate').html('');
							$('.viewtemp #otherfun button#plus').prop('disabled',true);
							$('.viewtemp #otherfun button#openinv').prop('disabled',true);
							$('.viewtemp #viewvoid').prop('disabled',true);
							$('.viewtemp #fun button#forall').prop('disabled',true);
							$('.viewtemp #fun button#list').prop('disabled',true);
							$('.viewtemp #fun button#tag').prop('disabled',true);
							$('.viewtemp #fun button#kitchen').prop('disabled',true);
							$('.viewtemp #fun button#changecheck').prop('disabled',true);
							$('.viewtemp #fun button#editoutman').prop('disabled',true);
							$('.order#order #banner #detail #tw #view').trigger('click');
						}
					},
					error:function(e){
						//console.log(e);
					}
				});
				/*錢都錄借接*/
				if($('.order#order .initsetting #posdvr').length>0&&$('.order#order .initsetting #posdvr').val()=='1'){
					/*start tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'start posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){console.log(e);}
					});
					if(typeof api_sendmessage_posdvr!=="undefined"&&typeof api_sendmessage_posdvr==="function"){
						var res=api_sendmessage_posdvr(posdvrfile);
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							data:{'html':'success '+posdvrfile,'file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					else{
						$.ajax({
							url:'./lib/js/print.php',
							method:'post',
							async:false,
							data:{'html':'error sendmessage is not function','file':'posdvr'},
							dataType:'html',
							success:function(d){/*console.log(d);*/},
							error:function(e){/*console.log(e);*/}
						});
					}
					/*end tag*/
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						async:false,
						data:{'html':'end posdvr-sendmessage','file':'posdvr'},
						dataType:'html',
						success:function(d){/*console.log(d);*/},
						error:function(e){/*console.log(e);*/}
					});
				}
				else{
				}
				$.ajax({
					url:'./lib/js/create.cmdtxt.php',
					method:'post',
					async: false,
					data:{'cmd':nowbizdate.substr(0,6)+'-change'},
					dataType:'html',
					success:function(d){
						//console.log(d);
					},
					error:function(e){
						//console.log(e);
					}
				});									
				break;
			default:
				break;
		}
	});
	$('.voidsalewithpxpaypluspay #checksale').click(function(){//2022/10/20 查詢退款狀態
		//voidsalewithpxpaypluspay.dialog('close');
		$('.voidsalewithpxpaypluspay .qrhint').html('檢查交易中<span id="dot">...</span>');
		$('.voidsalewithpxpaypluspay .hintstring').html('');
		$('.voidsalewithpxpaypluspay #successsale').css({'display':'block'});
		$('.voidsalewithpxpaypluspay #checksale').css({'display':'none'});
		$('.voidsalewithpxpaypluspay #checksale').prop('disabled',true);
		$('.voidsalewithpxpaypluspay #cancelsale').prop('disabled',true);
		var dotloading=setInterval(function(){
			if($('.voidsalewithpxpaypluspay .qrhint #dot').length>0){
				if($('.voidsalewithpxpaypluspay .qrhint #dot').html().length==3){
					$('.voidsalewithpxpaypluspay .qrhint #dot').html('.');
				}
				else if($('.voidsalewithpxpaypluspay .qrhint #dot').html().length==2){
					$('.voidsalewithpxpaypluspay .qrhint #dot').html('...');
				}
				else{
					$('.voidsalewithpxpaypluspay .qrhint #dot').html('..');
				}
			}
			else{
			}
		},500);
		var res='';
		res=pxpayplus_OrderStatus($('.order#order .pxpayplus #url').val(),$('.order#order .pxpayplus #merchantcode').val(),$('.order#order .pxpayplus #secrectkey').val(),$('.order#order .companydata #storyname').val(),'1',$('.voidsalewithpxpaypluspay input[name="orderid"]').val());
		res.done(function(res){
			//console.log(res['returnCode']);
			if(typeof res['status_code']!=='undefined'&&res['status_code']=='0000'){
				$('.voidsalewithpxpaypluspay .hintstring').html(res['status_message']);
				$('.voidsalewithpxpaypluspay #successsale').prop('disabled',false);
			}
			//2022/10/20 退款查詢除了查到成功與重複退款，都只能終止流程或重新查詢
			/*else if(typeof res['StatusCode']!=='undefined'&&res['StatusCode']=='916'){//2022/10/19 查無訂單(可能是尚未完成交易)
				$('.voidsalewithpxpaypluspay #successsale').css({'display':'none'});
				$('.voidsalewithpxpaypluspay #checksale').css({'display':'block'});
				$('.voidsalewithpxpaypluspay #checksale').prop('disabled',false);
				$('.voidsalewithpxpaypluspay #cancelsale').css({'display':'block'});
				$('.voidsalewithpxpaypluspay #cancelsale').prop('disabled',false);
				$('.voidsalewithpxpaypluspay .hintstring').html(res['StatusDesc']);
			}*/
			else if(typeof res['statusText']!=='undefined'){//等待逾時
				$('.voidsalewithpxpaypluspay #successsale').css({'display':'none'});
				$('.voidsalewithpxpaypluspay #checksale').css({'display':'block'});
				$('.voidsalewithpxpaypluspay #checksale').prop('disabled',false);
				$('.voidsalewithpxpaypluspay #cancelsale').css({'display':'block'});
				$('.voidsalewithpxpaypluspay #cancelsale').prop('disabled',false);
				$('.voidsalewithpxpaypluspay .hintstring').html(res['statusText']);
			}
			else{
				$('.voidsalewithpxpaypluspay .hintstring').html(res['status_message']);
				$('.voidsalewithpxpaypluspay #successsale').css({'display':'none'});
				$('.voidsalewithpxpaypluspay #checksale').css({'display':'block'});
				$('.voidsalewithpxpaypluspay #checksale').prop('disabled',false);
				$('.voidsalewithpxpaypluspay #cancelsale').css({'display':'block'});
				$('.voidsalewithpxpaypluspay #cancelsale').prop('disabled',false);
			}
			clearInterval(dotloading);
			$('.voidsalewithpxpaypluspay .qrhint').html('');
		});
	});
	$('.voidsalewithpxpaypluspay #cancelsale').click(function(){//作廢帳單全支付付款退款失敗
		voidsalewithpxpaypluspay.dialog('close');
	});
	$('.spend .loginubereats').click(function(){//2022/8/1 註冊UBEREATS
		window.open('https://login.uber.com/oauth/v2/authorize?response_type=code&client_id=V5hlPJ2hTgqu1sRjaN1f2lp-p4dSfSkF&scope=eats.pos_provisioning&redirect_uri=https://ordernow.tableplus.com.tw/ubereats/getusertoken.php');
	});
	yunlincoins=$('.yunlincoins').dialog({
		autoOpen:false,
		width:550,
		height:768,
		title:'轉換雲林幣',
		resizable:false,
		modal:true,
		draggable:false,
		open:function(){
			$('.yunlincoins input[name="beforemoney"]').val($('.memdata #money').html());
			$('.yunlincoins input[name="aftermoney"]').val($('.memdata #money').html());
			$.ajax({
				url:'./lib/api/yunlincoins/GetToken.php',
				method:'post',
				async:false,
				dataType:'json',
				success:function(d){
					console.log(d);
					d=JSON.parse(d);
					if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
						$('.yunlincoins input[name="yunlintoken"]').val(d['value']['access_token']);
						$.ajax({
							url:'./lib/api/yunlincoins/CheckPhone.php',
							method:'post',
							async:false,
							data:{'account':$('.memdata #tel').html(),'token':$('.yunlincoins input[name="yunlintoken"]').val()},
							dataType:'json',
							success:function(d){
								console.log(d);
								//d=JSON.parse(d);
								if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
									$('.yunlincoins input[name="yunlinbalance"]').val(d['value']['balance']);
								}
								else{
								}
							},
							error:function(e){
								console.log(e);
							}
						});
					}
					else{
						console.log('get token fail.');
					}
				},
				error:function(e){
					console.log(e);
				}
			});
		},
		close:function(){
			$('.yunlincoins .tranresult').css({'display':'none'});
			$('.yunlincoins input[name="aftermoney"]').val('0');
			$('.yunlincoins input[name="yunlinbalance"]').val('0');
			$('.yunlincoins input[name="beforemoney"]').val('0');
			$('.yunlincoins input[name="tranyunlincoins"]').val('0');
			$('.yunlincoins input[name="getmemmoney"]').val('0');
		}
	});
	$('.memdata #yunlincoins').click(function(){
		memdata.dialog('close');
		yunlincoins.dialog('open');
	});
	$('.yunlincoins #plus10').click(function(){
		if((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())+parseInt($('.yunlincoinssetting #coins').val()))<=parseInt($('.yunlincoins input[name="yunlinbalance"]').val())){
			$('.yunlincoins input[name="tranyunlincoins"]').val(parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())+parseInt($('.yunlincoinssetting #coins').val()));
		}
		else{
		}
		$('.yunlincoins input[name="getmemmoney"]').val((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val()));
		$('.yunlincoins input[name="aftermoney"]').val(parseInt($('.yunlincoins input[name="beforemoney"]').val())+((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val())));
	});
	$('.yunlincoins #plus50').click(function(){
		if((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())+(5*parseInt($('.yunlincoinssetting #coins').val())))<=parseInt($('.yunlincoins input[name="yunlinbalance"]').val())){
			$('.yunlincoins input[name="tranyunlincoins"]').val(parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())+(5*parseInt($('.yunlincoinssetting #coins').val())));
		}
		else{
		}
		$('.yunlincoins input[name="getmemmoney"]').val((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val()));
		$('.yunlincoins input[name="aftermoney"]').val(parseInt($('.yunlincoins input[name="beforemoney"]').val())+((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val())));
	});
	$('.yunlincoins #plus100').click(function(){
		if((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())+(10*parseInt($('.yunlincoinssetting #coins').val())))<=parseInt($('.yunlincoins input[name="yunlinbalance"]').val())){
			$('.yunlincoins input[name="tranyunlincoins"]').val(parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())+(10*parseInt($('.yunlincoinssetting #coins').val())));
		}
		else{
		}
		$('.yunlincoins input[name="getmemmoney"]').val((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val()));
		$('.yunlincoins input[name="aftermoney"]').val(parseInt($('.yunlincoins input[name="beforemoney"]').val())+((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val())));
	});
	$('.yunlincoins #plusall').click(function(){
		$('.yunlincoins input[name="tranyunlincoins"]').val(parseInt(parseInt($('.yunlincoins input[name="yunlinbalance"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #coins').val()));
		
		$('.yunlincoins input[name="getmemmoney"]').val((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val()));
		$('.yunlincoins input[name="aftermoney"]').val(parseInt($('.yunlincoins input[name="beforemoney"]').val())+((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val())));
	});
	$('.yunlincoins #clear').click(function(){
		$('.yunlincoins input[name="tranyunlincoins"]').val(0);
		
		$('.yunlincoins input[name="getmemmoney"]').val((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val()));
		$('.yunlincoins input[name="aftermoney"]').val(parseInt($('.yunlincoins input[name="beforemoney"]').val())+((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val())));
	});
	$('.yunlincoins .tranyunlin').click(function(){
		$.ajax({
			url:'./lib/js/checkopen.ajax.php',
			method:'post',
			async:false,
			data:{'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val()},
			dataType:'html',
			success:function(d){
				if(d.length>20||d.match('ERROR HINT: ')){
					$.ajax({
						url:'./lib/js/print.php',
						method:'post',
						data:{'html':'tranyunlin send checkopen.ajax.php '+d},
						dataType:'html',
						success:function(d){
							//console.log(d);
						},
						error:function(e){
							//console.log(e);
						}
					});
				}
				else{
				}
				if(d=='success'){
					var tranres=0;
					$.ajax({
						url:'./lib/api/yunlincoins/UseCoins.php',
						method:'post',
						async:false,
						data:{'token':$('.yunlincoins input[name="yunlintoken"]').val(),'account':$('.memdata #tel').html(),'consumeamount':parseInt($('.yunlincoins input[name="tranyunlincoins"]').val()),'consumeitems':'兌換儲值金','commodityholder':$('.order#order .companydata #story').val()},
						dataType:'json',
						success:function(d){
							//console.log(d);
							if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
								if($('.yunlincoins input[name="tranyunlincoins"]').val()>=0&&parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())<=parseInt($('.yunlincoins input[name="yunlinbalance"]').val())){
									$('.yunlincoins input[name="aftermoney"]').val(parseInt($('.yunlincoins input[name="beforemoney"]').val())+((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val())));
									$('.yunlincoins .tranresult').css({'display':'block'});
									tranres=1;
								}
								else{
									//console.log($('.yunlincoins input[name="tranyunlincoins"]').val());
								}
								$.ajax({
									url:'./lib/api/yunlincoins/CheckPhone.php',
									method:'post',
									async:false,
									data:{'token':$('.yunlincoins input[name="yunlintoken"]').val(),'account':$('.memdata #tel').html()},
									dataType:'json',
									success:function(d){
										//console.log(d);
										//d=JSON.parse(d);
										if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
											if(parseInt(d['value']['balance'])>0){//尚有餘額，顯示yunlincoins icon
												$('.yunlincoinsico').css({'display':'block'});
											}
											else{
												$('.yunlincoinsico').css({'display':'none'});
											}
										}
										else if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==false){//驗證失敗
											$.ajax({
												url:'./lib/api/yunlincoins/GetToken.php',
												method:'post',
												async:false,
												dataType:'json',
												success:function(d){
													//console.log(d);
													d=JSON.parse(d);
													if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
														$('.yunlincoins input[name="yunlintoken"]').val(d['value']['access_token']);
														$.ajax({
															url:'./lib/api/yunlincoins/CheckPhone.php',
															method:'post',
															async:false,
															data:{'account':$('.memdata #tel').html(),'token':$('.yunlincoins input[name="yunlintoken"]').val()},
															dataType:'json',
															success:function(d){
																//console.log(d);
																//d=JSON.parse(d);
																if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
																	if(parseInt(d['value']['balance'])>0){//尚有餘額，顯示yunlincoins icon
																		$('.yunlincoinsico').css({'display':'block'});
																	}
																	else{
																		$('.yunlincoinsico').css({'display':'none'});
																	}
																}
																else{
																	$('.yunlincoinsico').css({'display':'none'});
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
														//console.log('get token fail.');
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
							else if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==false){
								$.ajax({
									url:'./lib/api/yunlincoins/GetToken.php',
									method:'post',
									async:false,
									dataType:'json',
									success:function(d){
										//console.log(d);
										d=JSON.parse(d);
										if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
											$('.yunlincoins input[name="yunlintoken"]').val(d['value']['access_token']);
											$.ajax({
												url:'./lib/api/yunlincoins/UseCoins.php',
												method:'post',
												async:false,
												data:{'token':$('.yunlincoins input[name="yunlintoken"]').val(),'account':$('.memdata #tel').html(),'consumeamount':parseInt($('.yunlincoins input[name="tranyunlincoins"]').val()),'consumeitems':'兌換儲值金','commodityholder':$('.order#order .companydata #story').val()},
												dataType:'json',
												success:function(d){
													//console.log(d);
													//d=JSON.parse(d);
													if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
														if($('.yunlincoins input[name="tranyunlincoins"]').val()>=0&&parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())<=parseInt($('.yunlincoins input[name="yunlinbalance"]').val())){
															$('.yunlincoins input[name="aftermoney"]').val(parseInt($('.yunlincoins input[name="beforemoney"]').val())+((parseInt($('.yunlincoins input[name="tranyunlincoins"]').val())/parseInt($('.yunlincoinssetting #coins').val()))*parseInt($('.yunlincoinssetting #tran').val())));
															$('.yunlincoins .tranresult').css({'display':'block'});
															tranres=1;
														}
														else{
															//console.log($('.yunlincoins input[name="tranyunlincoins"]').val());
														}
														$.ajax({
															url:'./lib/api/yunlincoins/CheckPhone.php',
															method:'post',
															async:false,
															data:{'token':$('.yunlincoins input[name="yunlintoken"]').val(),'account':$('.memdata #tel').html()},
															dataType:'json',
															success:function(d){
																//console.log(d);
																//d=JSON.parse(d);
																if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
																	if(parseInt(d['value']['balance'])>0){//尚有餘額，顯示yunlincoins icon
																		$('.yunlincoinsico').css({'display':'block'});
																	}
																	else{
																		$('.yunlincoinsico').css({'display':'none'});
																	}
																}
																else if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==false){//驗證失敗
																	$.ajax({
																		url:'./lib/api/yunlincoins/GetToken.php',
																		method:'post',
																		async:false,
																		dataType:'json',
																		success:function(d){
																			//console.log(d);
																			d=JSON.parse(d);
																			if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
																				$('.yunlincoins input[name="yunlintoken"]').val(d['value']['access_token']);
																				$.ajax({
																					url:'./lib/api/yunlincoins/CheckPhone.php',
																					method:'post',
																					async:false,
																					data:{'account':$('.memdata #tel').html(),'token':$('.yunlincoins input[name="yunlintoken"]').val()},
																					dataType:'json',
																					success:function(d){
																						//console.log(d);
																						//d=JSON.parse(d);
																						if(d['valid']==true&&d['resultCode']=='0'&&d['value']['result']==true&&d['value']['resultCode']=='000'){
																							if(parseInt(d['value']['balance'])>0){//尚有餘額，顯示yunlincoins icon
																								$('.yunlincoinsico').css({'display':'block'});
																							}
																							else{
																								$('.yunlincoinsico').css({'display':'none'});
																							}
																						}
																						else{
																							$('.yunlincoinsico').css({'display':'none'});
																						}
																					},
																					error:function(e){
																						//console.log(e);
																					}
																				});
																			}
																			else{
																				//console.log('get token fail.');
																			}
																		},
																		error:function(e){
																			//console.log(e);
																		}
																	});
																}
																else{
																}
															},
															error:function(e){
																//console.log(e);
															}
														});
													}
													else{
													}
												},
												error:function(e){
													//console.log(e);
												}
											});
										}
										else{
											//console.log('get token fail.');
										}
									},
									error:function(e){
										//console.log(e);
									}
								});
							}
						},
						error:function(e){
							//console.log(e);
						}
					});

					if(tranres==1){//轉換成功，將儲值金寫進POS系統
						$.ajax({//寫入sales中，給交班表查詢使用
							url:'./lib/js/insert.paymoney.php',
							method:'post',
							async:false,
							data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'usercode':$('.order#order #tabs4 form[data-id="listform"] input[name="usercode"]').val(),'username':$('.order#order #tabs4 form[data-id="listform"] input[name="username"]').val(),'machinetype':$('.order#order #tabs4 form[data-id="listform"] input[name="machinetype"]').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':$('.yunlincoins input[name="tranyunlincoins"]').val(),'getmemmoney':$('.yunlincoins input[name="getmemmoney"]').val(),'moneytype':'yunlincoins'},
							dataType:'json',
							success:function(d){
								//console.log(d);
								if(typeof d['bizdate']!=='undefined'&&typeof d['zcounter']!=='undefined'&&typeof d['timepoint']!=='undefined'&&typeof d['settime']!=='undefined'){
									$.ajax({//寫入tableplus資料庫
										url:'http://api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php',
										method:'post',
										async:false,
										data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':$('.yunlincoins input[name="tranyunlincoins"]').val(),'getmemmoney':$('.yunlincoins input[name="getmemmoney"]').val(),'bizdate':d['bizdate'],'settime':d['settime'],'moneytype':'yunlincoins','yuncoinsremark':$('.order#order .companydata #story').val()},
										dataType:'json',
										success:function(d){
											//console.log(d);
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php(online success) '+JSON.stringify(d)},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
											$('.memdata #money').html(d[0]['money']);
											//console.log($('.memdata #money').html());
											$('.order#order #content #member #membutton #membermoney').val($('.paymembermoney .precompute').val());
											paymembermoney.dialog('close');
										},
										error:function(e){
											//console.log(e);
											$.ajax({
												url:'./lib/js/print.php',
												method:'post',
												data:{'html':'api.tableplus.com.tw/outposandorder/memberapi/insert.paymoney.php(online error) '+e},
												dataType:'html',
												success:function(d){/*console.log(d);*/},
												error:function(e){/*console.log(e);*/}
											});
										}
									});
								}
								else{
								}
								$.ajax({
									url:'./lib/js/membermoney.ticket.php',
									method:'post',
									async:false,
									data:{'company':$('.order#order .companydata #company').val(),'dep':$('.order#order .companydata #story').val(),'memno':$('#content #listtabbox #tabs4 form[data-id="listform"] input[name="memno"]').val(),'paymoney':$('.yunlincoins input[name="tranyunlincoins"]').val(),'moneytype':'yunlincoins'},
									dataType:'json',
									success:function(d){
										//console.log(d);
									},
									error:function(e){
										//console.log(e);
									}
								});
							},
							error:function(e){
								//console.log(e);
							}
						});
					}
					else{
					}
					yunlincoins.dialog('close');
				}
				else{
					//alertmessage('目前尚未開班，請確認是否開班或重啟系統。');
					$('.alertmessage #text').html('目前尚未開班，請確認是否開班或重啟系統。');
					alertmessage.dialog('open');
				}
			},
			error:function(e){
				//console.log(e);
			}
		});
	});
	$('.yunlincoins .cancel').click(function(){
		yunlincoins.dialog('close');
	});
});
<?php
include '../../../tool/dbTool.inc.php';
function quicksort($origArray,$type) {//快速排序//for最低價、最高價
	if (sizeof($origArray) == 1) { 
		return $origArray;
	}
	else if(sizeof($origArray) == 0){
		return 'null';
	}
	else {
		$left = array();
		$right = array();
		$newArray = array();
		$pivot = array_pop($origArray);
		$length = sizeof($origArray);
		for ($i = 0; $i < $length; $i++) {
			if (floatval($origArray[$i][$type]) <= floatval($pivot[$type])) {
				array_push($left,$origArray[$i]);
			} else {
				array_push($right,$origArray[$i]);
			}
		}
		if(sizeof($left)==0){
			if(sizeof($right)==0){
			}
			else{
				$tempright=quicksort($right,$type);
				$newArray=array_merge(array($pivot),$tempright);
			}
		}
		else{
			$templeft=quicksort($left,$type);
			$n=sizeof($templeft);
			$start=$n;
			$newArray=array_merge($templeft,array($pivot));
			if(sizeof($right)==0){
			}
			else{
				$tempright=quicksort($right,$type);
				$newArray=array_merge($newArray,$tempright);
			}
		}
		return $newArray;
	}
}
$conn=sqlconnect("../../../database","menu.db","","","","sqlite");
if(!isset($_POST['itemtype'])||strlen($_POST['itemtype'])==0){
	$sql='SELECT * FROM itemsdata WHERE inumber="'.$_POST['no'].'"';
}
else{
	$sql='SELECT * FROM itemsdata WHERE inumber="'.$_POST['no'].'" AND fronttype="'.$_POST['itemtype'].'"';
}
$data=sqlquery($conn,$sql,'sqlite');
sqlclose($conn,'sqlite');
if(!isset($_POST['company'])||strlen($_POST['company'])==0){
	$front=parse_ini_file('../../../database/front.ini',true);
	$itemname=parse_ini_file('../../../database/items.ini',true);
	$tastename=parse_ini_file('../../../database/taste.ini',true);
}
else{
	$front=parse_ini_file('../../../database/'.$_POST['company'].'-front.ini',true);
	$itemname=parse_ini_file('../../../database/'.$_POST['company'].'-menu.ini',true);
	$tastename=parse_ini_file('../../../database/'.$_POST['company'].'-taste.ini',true);
}
$initseeting=parse_ini_file('../../../database/initsetting.ini',true);
$public='';
for($i=0;$i<sizeof($tastename);$i++){
	if($tastename[$i]['public']=='1'&&$tastename[$i]['state']=='1'){
		if(strlen($public)==0){
			$public=$i;
		}
		else{
			$public=$public.','.$i;
		}
	}
	else{
	}
}
//echo $public;
$initsetting=parse_ini_file('../../../database/initsetting.ini',true);

for($i=0;$i<sizeof($data);$i++){
	$tasteno='';
	$name1='';
	$name2='';
	$money='';
	$group='';
	$background='';
	if(isset($itemname[$data[$i]['inumber']]['personcount'])){
		$data[$i]['personcount']=$itemname[$data[$i]['inumber']]['personcount'];
	}
	else{
		$data[$i]['personcount']='0';
	}
	if(isset($itemname[$data[$i]['inumber']]['charge'])){
		$data[$i]['charge']=$itemname[$data[$i]['inumber']]['charge'];
	}
	else{
		$data[$i]['charge']='1';
	}
	if(isset($itemname[$data[$i]['inumber']]['dis1'])){
		$data[$i]['dis1']=$itemname[$data[$i]['inumber']]['dis1'];
	}
	else{
		$data[$i]['dis1']='';
	}
	if(isset($itemname[$data[$i]['inumber']]['dis2'])){
		$data[$i]['dis2']=$itemname[$data[$i]['inumber']]['dis2'];
	}
	else{
		$data[$i]['dis2']='';
	}
	if(isset($itemname[$data[$i]['inumber']]['dis3'])){
		$data[$i]['dis3']=$itemname[$data[$i]['inumber']]['dis3'];
	}
	else{
		$data[$i]['dis3']='';
	}
	if(isset($itemname[$data[$i]['inumber']]['dis4'])){
		$data[$i]['dis4']=$itemname[$data[$i]['inumber']]['dis4'];
	}
	else{
		$data[$i]['dis4']='';
	}
	$data[$i]['name']=$itemname[$data[$i]['inumber']]['name1'];
	$data[$i]['name2']=$itemname[$data[$i]['inumber']]['name2'];
	if(isset($itemname[$data[$i]['inumber']]['openmoney'])){
		$data[$i]['openmoney']=$itemname[$data[$i]['inumber']]['openmoney'];
	}
	else{
		$data[$i]['openmoney']='0';
	}
	$data[$i]['mnumber']=$itemname[$data[$i]['inumber']]['mnumber'];
	for($j=1;$j<=6;$j++){
		$data[$i]['mname'.$j.'1']=$itemname[$data[$i]['inumber']]['mname'.$j.'1'];
		$data[$i]['mname'.$j.'2']=$itemname[$data[$i]['inumber']]['mname'.$j.'2'];
		$data[$i]['money'.$j]=$itemname[$data[$i]['inumber']]['money'.$j];
		if(isset($itemname[$data[$i]['inumber']]['getpointtype'.$j])){
			$data[$i]['getpointtype'.$j]=$itemname[$data[$i]['inumber']]['getpointtype'.$j];
		}
		else{
			$data[$i]['getpointtype'.$j]='1';
		}
		if(isset($itemname[$data[$i]['inumber']]['getpoint'.$j])){
			$data[$i]['getpoint'.$j]=$itemname[$data[$i]['inumber']]['getpoint'.$j];
		}
		else{
			$data[$i]['getpoint'.$j]='0';
		}
	}
	/*$data[$i]['mname11']=$itemname[$data[$i]['inumber']]['mname11'];
	$data[$i]['mname12']=$itemname[$data[$i]['inumber']]['mname12'];
	$data[$i]['money1']=$itemname[$data[$i]['inumber']]['money1'];
	$data[$i]['mname21']=$itemname[$data[$i]['inumber']]['mname21'];
	$data[$i]['mname22']=$itemname[$data[$i]['inumber']]['mname22'];
	$data[$i]['money2']=$itemname[$data[$i]['inumber']]['money2'];
	$data[$i]['mname31']=$itemname[$data[$i]['inumber']]['mname31'];
	$data[$i]['mname32']=$itemname[$data[$i]['inumber']]['mname32'];
	$data[$i]['money3']=$itemname[$data[$i]['inumber']]['money3'];
	$data[$i]['mname41']=$itemname[$data[$i]['inumber']]['mname41'];
	$data[$i]['mname42']=$itemname[$data[$i]['inumber']]['mname42'];
	$data[$i]['money4']=$itemname[$data[$i]['inumber']]['money4'];
	$data[$i]['mname51']=$itemname[$data[$i]['inumber']]['mname51'];
	$data[$i]['mname52']=$itemname[$data[$i]['inumber']]['mname52'];
	$data[$i]['money5']=$itemname[$data[$i]['inumber']]['money5'];
	$data[$i]['mname61']=$itemname[$data[$i]['inumber']]['mname61'];
	$data[$i]['mname62']=$itemname[$data[$i]['inumber']]['mname62'];
	$data[$i]['money6']=$itemname[$data[$i]['inumber']]['money6'];*/
	$data[$i]['dis']=0;
	if(strlen($data[$i]['taste'])>0){//具有專屬備註
		$tasteset=preg_split('/-/',$data[$i]['taste']);
		for($l=0;$l<sizeof($tasteset);$l++){
			$tastecont=preg_split('/;/',$tasteset[$l]);
			if(strlen($name1)==0){
				$tasteno=$tastecont[0].';';
				$name1=$tastecont[0].';';
				$name2=$tastecont[0].';';
				$money=$tastecont[0].';';
				$group=$tastecont[0].';';
				$background=$tastecont[0].';';
			}
			else{
				$tasteno=$tasteno.'-'.$tastecont[0].';';
				$name1=$name1.'-'.$tastecont[0].';';
				$name2=$name2.'-'.$tastecont[0].';';
				$money=$money.'*'.$tastecont[0].';';
				$group=$group.'-'.$tastecont[0].';';
				$background=$tastecont[0].'-'.';';
			}
			if(preg_match('/,/',$tastecont[1])){
				$temp1=preg_split('/,/',$tastecont[1]);
				$temp11=array();
				for($t=0;$t<sizeof($temp1);$t++){
					if(!isset($tastename[$temp1[$t]]['seq'])||$tastename[$temp1[$t]]['seq']==''){
						$tastename[$temp1[$t]]['seq']=1;
					}
					else{
					}
					array_push($temp11,array('index'=>$t,'no'=>$temp1[$t],'seq'=>$tastename[$temp1[$t]]['seq']));
				}
				//print_r( $temp11);
				$temp=quicksort($temp11,'seq');
			}
			else{
				$temp=array();
				array_push($temp,array('index'=>'0','no'=>$tastecont[1],'seq'=>$tastename[$tastecont[1]]['seq']));
			}
			if(preg_match('/,/',$public)){
				$ttemp2=preg_split('/,/',$public);
				$ttemp22=array();
				for($t=0;$t<sizeof($ttemp2);$t++){
					if(!isset($tastename[$ttemp2[$t]]['seq'])||$tastename[$ttemp2[$t]]['seq']==''){
						$tastename[$ttemp2[$t]]['seq']=1;
					}
					else{
					}
					array_push($ttemp22,array('index'=>$t,'no'=>$ttemp2[$t],'seq'=>$tastename[$ttemp2[$t]]['seq']));
				}
				$temp2=quicksort($ttemp22,'seq');
			}
			else if($public!=''){
				$temp2=array('no'=>$public);
			}
			else{
				$temp2=array();
			}
			if($initseeting['init']['publicseq']=='1'){
				$index=0;
				for($s=0;$s<sizeof($temp2);$s++){
					if(isset($temp2[$s]['no'])&&$tastename[$temp2[$s]['no']]['state']=='1'){
						if($tastename[$temp2[$s]['no']]['money']!=''){
						}
						else{
							$tastename[$temp2[$s]['no']]['money']='0';
						}
						if($index==0){
							$tasteno=$tasteno.$temp2[$s]['no'];
							$name1=$name1.$tastename[$temp2[$s]['no']]['name1'];
							$name2=$name2.$tastename[$temp2[$s]['no']]['name2'];
							$money=$money.$tastename[$temp2[$s]['no']]['money'];
							if(isset($tastename[$temp2[$s]['no']]['group'])){
								$group=$group.$tastename[$temp2[$s]['no']]['group'];
							}
							else{
								//$group=$group.$tastename[$temp2[$s]['no']]['group'];
							}
							$background=$background.$tastename[$temp2[$s]['no']]['background'];
						}
						else{
							$tasteno=$tasteno.','.$temp2[$s]['no'];
							$name1=$name1.','.$tastename[$temp2[$s]['no']]['name1'];
							$name2=$name2.','.$tastename[$temp2[$s]['no']]['name2'];
							$money=$money.','.$tastename[$temp2[$s]['no']]['money'];
							if(isset($tastename[$temp2[$s]['no']]['group'])){
								$group=$group.','.$tastename[$temp2[$s]['no']]['group'];
							}
							else{
								//$group=$group.','.$tastename[$temp2[$s]['no']]['group'];
							}
							$background=$background.','.$tastename[$temp2[$s]['no']]['background'];
						}
						$index++;
					}
					else{
					}
					
				}
				for($k=0;$k<sizeof($temp);$k++){
					if($tastename[$temp[$k]['no']]['state']=='1'){
						if($tastename[$temp[$k]['no']]['money']!=''){
						}
						else{
							$tastename[$temp[$k]['no']]['money']='0';
						}
						if($index==0){
							$tasteno=$tasteno.$temp[$k]['no'];
							$name1=$name1.$tastename[$temp[$k]['no']]['name1'];
							$name2=$name2.$tastename[$temp[$k]['no']]['name2'];
							$money=$money.$tastename[$temp[$k]['no']]['money'];
							if(isset($tastename[$temp[$k]['no']]['group'])){
								$group=$group.$tastename[$temp[$k]['no']]['group'];
							}
							else{
								//$group=$group.$tastename[$temp[$k]['no']]['group'];
							}
							$background=$background.$tastename[$temp[$k]['no']]['background'];
						}
						else{
							$tasteno=$tasteno.','.$temp[$k]['no'];
							$name1=$name1.','.$tastename[$temp[$k]['no']]['name1'];
							$name2=$name2.','.$tastename[$temp[$k]['no']]['name2'];
							$money=$money.','.$tastename[$temp[$k]['no']]['money'];
							if(isset($tastename[$temp[$k]['no']]['group'])){
								$group=$group.','.$tastename[$temp[$k]['no']]['group'];
							}
							else{
								//$group=$group.','.$tastename[$temp[$k]['no']]['group'];
							}
							$background=$background.','.$tastename[$temp[$k]['no']]['background'];
						}
						$index++;
					}
					else{
					}
				}
			}
			else{
				$index=0;
				for($k=0;$k<sizeof($temp);$k++){
					if($tastename[$temp[$k]['no']]['state']=='1'){
						if($tastename[$temp[$k]['no']]['money']!=''){
						}
						else{
							$tastename[$temp[$k]['no']]['money']='0';
						}
						if($index==0){
							$tasteno=$tasteno.$temp[$k]['no'];
							$name1=$name1.$tastename[$temp[$k]['no']]['name1'];
							$name2=$name2.$tastename[$temp[$k]['no']]['name2'];
							$money=$money.$tastename[$temp[$k]['no']]['money'];
							if(isset($tastename[$temp[$k]['no']]['group'])){
								$group=$group.$tastename[$temp[$k]['no']]['group'];
							}
							else{
								//$group=$group.','.$tastename[$temp[$k]['no']]['group'];
							}
							$background=$background.$tastename[$temp[$k]['no']]['background'];
						}
						else{
							$tasteno=$tasteno.','.$temp[$k]['no'];
							$name1=$name1.','.$tastename[$temp[$k]['no']]['name1'];
							$name2=$name2.','.$tastename[$temp[$k]['no']]['name2'];
							$money=$money.','.$tastename[$temp[$k]['no']]['money'];
							if(isset($tastename[$temp[$k]['no']]['group'])){
								$group=$group.','.$tastename[$temp[$k]['no']]['group'];
							}
							else{
								//$group=$group.','.$tastename[$temp[$k]['no']]['group'];
							}
							$background=$background.','.$tastename[$temp[$k]['no']]['background'];
						}
						$index++;
					}
					else{
					}
				}
				for($s=0;$s<sizeof($temp2);$s++){
					if(isset($temp2[$s]['no'])&&$tastename[$temp2[$s]['no']]['state']=='1'){
						if($tastename[$temp2[$s]['no']]['money']!=''){
						}
						else{
							$tastename[$temp2[$s]['no']]['money']='0';
						}
						if($index==0){
							$tasteno=$tasteno.$temp2[$s]['no'];
							$name1=$name1.$tastename[$temp2[$s]['no']]['name1'];
							$name2=$name2.$tastename[$temp2[$s]['no']]['name2'];
							$money=$money.$tastename[$temp2[$s]['no']]['money'];
							if(isset($tastename[$temp2[$s]['no']]['group'])){
								$group=$group.$tastename[$temp2[$s]['no']]['group'];
							}
							else{
								//$group=$group.','.$tastename[$temp2[$k]['no']]['group'];
							}
							$background=$background.$tastename[$temp2[$s]['no']]['background'];
						}
						else{
							$tasteno=$tasteno.','.$temp2[$s]['no'];
							$name1=$name1.','.$tastename[$temp2[$s]['no']]['name1'];
							$name2=$name2.','.$tastename[$temp2[$s]['no']]['name2'];
							$money=$money.','.$tastename[$temp2[$s]['no']]['money'];
							if(isset($tastename[$temp2[$s]['no']]['group'])){
								$group=$group.','.$tastename[$temp2[$s]['no']]['group'];
							}
							else{
								//$group=$group.','.$tastename[$temp[$s]['no']]['group'];
							}
							$background=$background.','.$tastename[$temp2[$s]['no']]['background'];
						}
						$index++;
					}
					else{
					}	
				}
			}
		}
	}
	else{
		$ttemp2=preg_split('/,/',$public);
		$ttemp22=array();
		for($t=0;$t<sizeof($ttemp2);$t++){
			if(!isset($tastename[$ttemp2[$t]]['seq'])||$tastename[$ttemp2[$t]]['seq']==''){
				$tastename[$ttemp2[$t]]['seq']=1;
			}
			else{
			}
			array_push($ttemp22,array('index'=>$t,'no'=>$ttemp2[$t],'seq'=>$tastename[$ttemp2[$t]]['seq']));
		}
		$temp2=quicksort($ttemp22,'seq');
		$name1='1;';
		$name2='1;';
		$money='1;';
		$group='1;';
		$background='1;';
		$index=0;
		for($s=0;$s<sizeof($temp2);$s++){
			if(isset($tastename[$temp2[$s]['no']]['name1'])){
				if($tastename[$temp2[$s]['no']]['state']=='1'){
					if($tastename[$temp2[$s]['no']]['money']!=''){
					}
					else{
						$tastename[$temp2[$s]['no']]['money']='0';
					}
					if($index==0){
						$tasteno=$tasteno.$temp2[$s]['no'];
						$name1=$name1.$tastename[$temp2[$s]['no']]['name1'];
						$name2=$name2.$tastename[$temp2[$s]['no']]['name2'];
						$money=$money.$tastename[$temp2[$s]['no']]['money'];
						if(isset($tastename[$temp2[$s]['no']]['group'])){
							$group=$group.$tastename[$temp2[$s]['no']]['group'];
						}
						else{
							//$group=$group.','.$tastename[$temp2[$s]['no']]['group'];
						}
						$background=$background.$tastename[$temp2[$s]['no']]['background'];
					}
					else{
						$tasteno=$tasteno.','.$temp2[$s]['no'];
						$name1=$name1.','.$tastename[$temp2[$s]['no']]['name1'];
						$name2=$name2.','.$tastename[$temp2[$s]['no']]['name2'];
						$money=$money.','.$tastename[$temp2[$s]['no']]['money'];
						if(isset($tastename[$temp2[$s]['no']]['group'])){
							$group=$group.','.$tastename[$temp2[$s]['no']]['group'];
						}
						else{
							//$group=$group.','.$tastename[$temp2[$s]['no']]['group'];
						}
						$background=$background.','.$tastename[$temp2[$s]['no']]['background'];
					}
					$index++;
				}
				else{
				}
			}
			else{
			}
		}
	}
	if(preg_match("/;/",$tasteno)){
	}
	else{
		$tasteno='1;'.$tasteno;
	}
	$data[$i]['taste']=$tasteno;
	$data[$i]['tastename1']=$name1;
	$data[$i]['tastename2']=$name2;
	$data[$i]['tastemoney']=$money;
	$data[$i]['tastegroup']=$group;
	$data[$i]['background']=$background;
	if(isset($itemname[$data[$i]['inumber']]['insaleinv'])){
		$data[$i]['insaleinv']=$itemname[$data[$i]['inumber']]['insaleinv'];
	}
	else{
		$data[$i]['insaleinv']="1";
	}
	if(isset($itemname[$data[$i]['inumber']]['itemdis'])){
		$data[$i]['itemdis']=$itemname[$data[$i]['inumber']]['itemdis'];
	}
	else{
		$data[$i]['itemdis']="1";
	}
	if(isset($itemname[$data[$i]['inumber']]['listdis'])){
		$data[$i]['listdis']=$itemname[$data[$i]['inumber']]['listdis'];
	}
	else{
		$data[$i]['listdis']="1";
	}
	if(isset($itemname[$data[$i]['inumber']]['bothdis'])){
		$data[$i]['bothdis']=$itemname[$data[$i]['inumber']]['bothdis'];
	}
	else{
		$data[$i]['bothdis']="1";
	}
	if(isset($itemname[$data[$i]['inumber']]['mempoint'])){
		$data[$i]['usemempoint']=$itemname[$data[$i]['inumber']]['mempoint'];
	}
	else{
		$data[$i]['usemempoint']="1";
	}
}
$itemname='';
$tastename='';
echo json_encode($data);
?>
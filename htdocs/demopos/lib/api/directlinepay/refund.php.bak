<?php
$initsetting=parse_ini_file('../../../../database/initsetting.ini',true);
$setup=parse_ini_file('../../../../database/setup.ini',true);
$tradecode=parse_ini_file('./tradecode.ini',true);
date_default_timezone_set($initsetting['init']['settime']);

$header=array(
	'Content-Type: application/json; charset=UTF-8',
	'X-LINE-ChannelId: '.$setup['directlinepay']['channelid'],
	'X-LINE-MerchantDeviceType: POS',
	'X-LINE-MerchantDeviceProfileId: POS',
	'X-LINE-ChannelSecret: '.$setup['directlinepay']['channelsecret']
);

//$PostData = json_encode( array(
//		"productName" =>"pos line pay",
//		"amount"=>$_POST['money'],
//		"currency"=>"TWD",
//		"orderId"=>$_POST['dep'].date('YmdHis'),
//		"oneTimeKey"=>$_POST['code']
//	)
//);

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $setup['directlinepay']['url'].'/orders/'.urlencode($_POST['orderid']).'/refund');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
curl_setopt($ch, CURLOPT_POST, 1);
// Edit: prior variable $postFields should be $postfields;
//curl_setopt($ch, CURLOPT_POSTFIELDS, $PostData);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0); // On dev server only!
curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
$Result = curl_exec($ch);
if(curl_errno($ch) !== 0) {
	print_r('cURL error when connecting to ' . $url . ': ' . curl_error($curl));
}
curl_close($ch);
$Response = json_decode($Result,1);

if(isset($Response['returnCode'])){
	if(isset($tradecode['code'][$Response['returnCode']])){
		$Response['returnMessageC']=$tradecode['code'][$Response['returnCode']];
	}
	else{
		$Response['returnMessageC']='例外狀況';
	}
}
else{
}
echo json_encode($Response);

?>